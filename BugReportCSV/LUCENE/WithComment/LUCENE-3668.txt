offsets issues with multiword synonyms
as reported on the list there are some strange offsets with FSTSynonyms in the case of multiword synonyms. as a workaround it was suggested to use the older synonym impl but it has bugs too just in a different way . here s 2 tests one for the old impl one for the new one In this case we have national hockey league nhl. desired behavior token posIncr startOffset endOffset national 1 0 8 nhl 0 0 22 hockey 1 9 15 league 1 16 22 current behavior FST impl token posIncr startOffset endOffset national 1 0 8 nhl 0 0 8 hockey 1 9 15 league 1 16 22 old impl token posIncr startOffset endOffset national 1 0 22 nhl 0 0 22 hockey 1 0 22 league 1 0 22 From the offsets perspective nhl is only getting the offsets of national endoffset 8 but it would be bettter if it got endoffset 22. Using the old impl imo is no workaround the offsets are crazy each individual word gets 0-22 . But i think we should just leave it be and try to improve the new one. Thank you for opening this issue Robert Using the old impl imo is no workaround the offsets are crazy each individual word gets 0-22 . Good point. Using old impl if I search for national the whole phrase of national hockey league is highlighted. But i think we should just leave it be and try to improve the new one. 1 Patch I think it s ready. I fixed the syn filter to set the start end offset only when the right-hand-side of the rule has a single token else it does what it did before inherit start end offset from the single input token the output is on top of . 1 I think this is the right solution. If you have a b - c d e or a b c - d e then what we are doing now seems good and well-defined i have no idea what else we could even do but with one output we know and the patch improves that case. Thanks Koji I m using solr 3.6 and with luceneMatchVersion 3.6 in my solrconfig.xml I m still seeing issues with highlighting. However using luceneMatchVersion 3.3 fixes my issue. Issue Details In my synonyms if I have nhl national hockey league If I index Australian nhl team great and search-use-case 1 search for hockey without quotes in my highlighted response snippets I get Australian nhl em team em great . search-use-case 2 search for league without quotes in my highlighted response snippets I get Australian nhl team em great em . Here is my feildType and field definitions fieldType name text general class solr.TextField positionIncrementGap 100 analyzer type index charFilter class solr.HTMLStripCharFilterFactory tokenizer class solr.StandardTokenizerFactory filter class solr.SynonymFilterFactory synonyms synonyms.txt ignoreCase true expand true filter class solr.StopFilterFactory ignoreCase true words stopwords.txt enablePositionIncrements true filter class solr.LowerCaseFilterFactory filter class solr.PorterStemFilterFactory analyzer analyzer type query tokenizer class solr.StandardTokenizerFactory filter class solr.SynonymFilterFactory synonyms synonyms.txt ignoreCase true expand false filter class solr.StopFilterFactory ignoreCase true words stopwords.txt enablePositionIncrements true filter class solr.LowerCaseFilterFactory filter class solr.PorterStemFilterFactory analyzer fieldType field name description type text synonym indexed true stored true termVectors true termPositions true termOffsets true omitNorms false I ve tried this with solr-4-beta and seeing the same problem. I ve tried normal al fastVectorHighlighter and got success in none of them. The code of SynonymFilter.java is exactly the same in lucene 3.6.1 4-alpha 4-beta and trunk. Should this be working Is there any special configuration to take into account I ve seen that not only offsets have been added since the patch but lengths too. Could this somehow affect We are also facing problems including SOLR-3390 Is using luceneMatchVersion LUCENE 33 luceneMatchVersion with Solr 3.6.1 an officially supported solution Is that good for a production system Doesn t work for me either in Solr4. Can we revisit this issue Perhaps this http nolanlawson.com 2012 10 31 better-synonym-handling-in-solr can give some insight help That writeup is a little off. Finally and most seriously the SynonymFilterFactory will simply not match multi-word synonyms in user queries if you do any kind of tokenization. This is because the tokenizer breaks up the input before the SynonymFilterFactory can transform it. Thats not correct. The bug is in QueryParser LUCENE-2605.
