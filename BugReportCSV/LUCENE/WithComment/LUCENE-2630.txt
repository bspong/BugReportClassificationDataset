make the build more friendly to apache harmony
as part of improved testing i thought it would be a good idea to make the build ant test more friendly to working under apache harmony. i m not suggesting we de-optimize code for sun jvms or anything crazy like that only use it as a tool. for example bugs in tests code for example i found a test that expected ArrayIOOBE when really the javadoc contract for the method is just IOOBE... it just happens to pass always on sun jvm because thats the implementation it always throws. better reproduction of bugs for example 2 months out of the year it seems TestQueryParser fails with thai locale in a difficult-to-reproduce way. but i always get similar failures like this with harmony for this test class. better stability and portability we should try if reasonable to avoid depending upon internal details. the same kinds of things that fail in harmony might suddenly fail in a future sun jdk. because its such a different impl it brings out a lot of interesting stuff. at the moment there are currently a lot of failures I think a lot might be caused by this http permalink.gmane.org gmane.comp.java.harmony.devel 39484 here s a patch that allows things to compile and tests to run removed the sunisms from the compile task so it works with harmony in the expected way -Dbuild.compiler extJavac simplified MockTokenizer.SIMPLE most tests use whitespace anyway and the humongous regexp was really unnecessary. fixed the IOOBE thing in CharacterUtils. there are more things that should be fixed but i d like to commit this so that its at least possible to compile and run test. fixed the IOOBE thing in CharacterUtils. Robert I wonder if we really still need CharacterUtils in 4.0 - we don t have to guarantee any bwcompat on the TokenFilter Tokenizer level and we should not have any problems with different lowercase methodes etc. Maybe we should move the codepoint aware reader code out to another class or clean that one up Robert I wonder if we really still need CharacterUtils in 4.0 - we don t have to guarantee any bwcompat on the TokenFilter Tokenizer level and we should not have any problems with different lowercase methodes etc. Maybe we should move the codepoint aware reader code out to another class or clean that one up I d rather discuss this dropping 2.x analyzer backwards compatibility Version on another jira issue to keep this one simple The harmony developers applied the UTF-8 fix HARMONY-6640 so we don t need to hack MockTokenizer anymore. i ve updated patch ant test-core -Dbuild.compiler extJavac almost passes. i ll iterate with some more test improvements now that we are going somewhere. Here s the patch for TestCharacterUtils. it should expect generic IIOBE according to the javadocs contract. I opened HARMONY-6648 for the non-bug difference. Here s the patch for TestCharacterUtils. looks good to me go commit here s a patch for the internationalization differences since harmony uses ICU. the collator gives different order for Locale.US though its wierd we test the order of non-US characters under US Locale its not defined and inherited from root locale I conditionalized this test as such the sort order of ¯ versus U depends on the version of the rules being used for the inherited root locale ¯ s order isnt specified in Locale.US since its not used in english. private boolean oStrokeFirst Collator.getInstance new Locale .compare ¯ U 0 the thai dictionary-based break iterator gives different results I used text that both impls segment the same way. happy to mark this one resolved harmony devs have quickly fixed issues we found. with r999725 of harmony all core contrib modules tests pass for both trunk and 3x on harmony with the exception of contrib remote due to rmic problems Bulk close for 3.1
