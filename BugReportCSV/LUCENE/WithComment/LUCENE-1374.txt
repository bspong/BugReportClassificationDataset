Merging of compressed string Fields may hit NPE
This bug was introduced with LUCENE-1219 only present on 2.4 . The bug happens when merging compressed string fields but only if bulk-merging code does not apply because the FieldInfos for the segment being merged are not congruent. This test shows the bug public void testMergeCompressedFields throws IOException File indexDir new File System.getProperty tempDir mergecompressedfields Directory dir FSDirectory.getDirectory indexDir try for int i 0 i 5 i Must make a new writer doc each time w different fields so bulk merge of stored fields cannot run IndexWriter w new IndexWriter dir new WhitespaceAnalyzer i 0 IndexWriter.MaxFieldLength.UNLIMITED w.setMergeFactor 5 w.setMergeScheduler new SerialMergeScheduler Document doc new Document doc.add new Field test1 this is some data that will be compressed this this this Field.Store.COMPRESS Field.Index.NO doc.add new Field test2 new byte 20 Field.Store.COMPRESS doc.add new Field field i random field Field.Store.NO Field.Index.TOKENIZED w.addDocument doc w.close byte cmp new byte 20 IndexReader r IndexReader.open dir for int i 0 i 5 i Document doc r.document i assertEquals this is some data that will be compressed this this this doc.getField test1 .stringValue byte b doc.getField test2 .binaryValue assertTrue Arrays.equals b cmp finally dir.close TestUtil.rmDir indexDir It s because in FieldsReader when we load a field for merge we create a FieldForMerge instance which subsequently does not return the right values for getBinary Value Length Offset . Attached patch that fixes AbstractField s getBinaryValue and getBinaryLength methods to fallback to fieldsData instanceof byte when appropriate. I plan to commit shortly. Committed revision 691617. ant test on 691617 for me fails on the following test testcase classname org.apache.lucene.index.TestIndexWriter name testMergeCompressedFields time 0.36 error message could not delete C lucene 691647 build test mergecompressedfields 5.cfs type java.io.IOException java.io.IOException could not delete C lucene 691647 build test mergecompressedfields 5.cfs at org.apache.lucene.util. TestUtil.rmDir TestUtil.java 37 at org.apache.lucene.index.TestIndexWriter.testMergeCompressedFields TestIndexWriter.java 4111 error testcase It might be one of those things that shows up only on Windows. In any case adding a call to IndexReader.close in testMergeCompressedFields seems to fix things up IndexReader r IndexReader.open dir for int i 0 i 5 i Document doc r.document i assertEquals this is some data that will be compressed this this this doc.getField test1 .stringValue byte b doc.getField test2 .binaryValue assertTrue Arrays.equals b cmp r.close New line finally dir.close TestUtil.rmDir indexDir I guess technically the r.close probably belongs in a finally block as well. Woops you re right I too see that failure to rmDir the directory only on Windows. I ll commit a fix. Thanks Chris 
