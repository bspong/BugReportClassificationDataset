Deadlock case in IndexWriter on exception just before flush
If a document hits a non-aborting exception eg something goes wrong in tokenStream.next and that document had triggered a flush due to RAM or doc count then DocumentsWriter will deadlock because that thread marks the flush as pending but fails to clear it on exception. I have a simple test case showing this and a fix fixing it. Attached patch. The fix is trivial. I will commit later today. As with LUCENE-1210 shouldn t the patch be committed in the 2.3 branch too as it affects 2.3.1 Other issues such as the speedups in LUCENE-1211 although useful can be left out as they are not bugs. But fix for deadlocks seem worthwhile for 2.3.x too. Agreed. I m thinking these issues should be ported to 2.3.2 LUCENE-1191 LUCENE-1197 LUCENE-1198 LUCENE-1199 LUCENE-1200 LUCENE-1208 this issue LUCENE-1210 We had seen this deadlock problem in our tests. I reran all tests with Lucene 2.3.1 LUCENE-1208 and didn t see the problem again so far targeted for 2.3.2 bug fix release
