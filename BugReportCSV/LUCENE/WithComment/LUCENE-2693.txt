Add delete term and query need to more precisely record the bytes used
DocumentsWriter s add delete query and add delete term add to the number of bytes used regardless of the query or term already existing in the respective map. Patch. The query value was changed to BufferedDeletes.Num instead of Integer to save a little on object pointer allocation. As a side note there are a number of unrelated generics warnings when compiling. moving out Jason are you going to fix it for 3.1 or shall I mark it 3.2 Do you mean post a patch for 3.1 The change is fairly simple can you simply add it and commit Yeah I can add it. I didn t realize you re waiting for someone to take on that issue . I reviewed the patch and it no longer applies to DocumentsWriter anymore since deletes happen inside SegmentDeletes. So delete-by-term am I right to say it s handled properly in SegmentDeletes.addTerm delete-by-query seems like SegmentDeletes.addQuery always increments bytesUsed whether the query was already in the map or not. I think that s wrong so I ll add a patch that fixes it for you to review. Patch against 3x though I believe it ll look the same against trunk. Fixed SegmentDeletes.addQuery and added a CHANGES entry. I d appreciate if someone can take a look before I commit. New patch looks good Shai We had already fixed the dup-Term case... Committed revision 1062824 3x . Committed revision 1062832 trunk . Thanks Jason Bulk close for 3.1
