Buffered deletes are not flushed by RAM or count
When a segment is flushed we will generally NOT flush the deletes ie we simply buffer up the pending delete terms queries and the only apply them if 1 a segment is going to be merged so we can remove the del docs in that segment or 2 the buffered deletes RAM exceeds 1 2 of IW s RAM limit when we are flushing a segment or 3 the buffered deletes count exceeds IWC s maxBufferedDeleteTerms. But the latter 2 triggers are currently broken on trunk I suspect but I m not sure when we landed DWPT we introduced this bug. Patch w 2 test cases showing the bug... they fail on trunk and pass on 3.x. here is a patch. The FlushPolicy only consulted the current global deletes buffer but didn t check the already frozen del packages. We also only checked if we need to apply the deletes during deleteQuery deleteTerm and not during update. Thanks Simon I found another case where the deletes weren t flushing at the right time and added a new test case passes on 3.x and fails on trunk but passes w this patch . I think it s ready to commit I think it s ready to commit 1 thanks for all the new testcases Thanks Simon 
