TestIndexWriter.testBackgroundOptimize fails with too many open files
Recreate with this line ant test -Dtestcase TestIndexWriter -Dtestmethod testBackgroundOptimize -Dtests.seed -3981504507637360146 51354004663342240 Might be related to LUCENE-2873 This is on Ubuntu btw. Run log NOTE reproduce with ant test -Dtestcase TestIndexWriter -Dtestmethod testBackgroundOptimize -Dtests.seed -3981504507637360146 51354004663342240 NOTE reproduce with ant test -Dtestcase TestIndexWriter -Dtestmethod testBackgroundOptimize -Dtests.seed -3981504507637360146 51354004663342240 The following exceptions were thrown by threads Thread Lucene Merge Thread 0 org.apache.lucene.index.MergePolicy MergeException java.io.FileNotFoundException tmp test4907593285402510583tmp 51 0.sd Too many open files at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException ConcurrentMergeScheduler.java 507 at org.apache.lucene.index.ConcurrentMergeScheduler MergeThread.run ConcurrentMergeScheduler.java 472 Caused by java.io.FileNotFoundException tmp test4907593285402510583tmp 51 0.sd Too many open files at java.io.RandomAccessFile.open Native Method at java.io.RandomAccessFile. init RandomAccessFile.java 233 at org.apache.lucene.store.SimpleFSDirectory SimpleFSIndexInput Descriptor. init SimpleFSDirectory.java 69 at org.apache.lucene.store.SimpleFSDirectory SimpleFSIndexInput. init SimpleFSDirectory.java 90 at org.apache.lucene.store.SimpleFSDirectory.openInput SimpleFSDirectory.java 56 at org.apache.lucene.store.FSDirectory.openInput FSDirectory.java 337 at org.apache.lucene.store.MockDirectoryWrapper.openInput MockDirectoryWrapper.java 402 at org.apache.lucene.index.codecs.mockrandom.MockRandomCodec.fieldsProducer MockRandomCodec.java 236 at org.apache.lucene.index.PerFieldCodecWrapper FieldsReader. init PerFieldCodecWrapper.java 113 at org.apache.lucene.index.PerFieldCodecWrapper.fieldsProducer PerFieldCodecWrapper.java 210 at org.apache.lucene.index.SegmentReader CoreReaders. init SegmentReader.java 131 at org.apache.lucene.index.SegmentReader.get SegmentReader.java 495 at org.apache.lucene.index.IndexWriter ReaderPool.get IndexWriter.java 635 at org.apache.lucene.index.IndexWriter.mergeMiddle IndexWriter.java 3260 at org.apache.lucene.index.IndexWriter.merge IndexWriter.java 2930 at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge ConcurrentMergeScheduler.java 379 at org.apache.lucene.index.ConcurrentMergeScheduler MergeThread.run ConcurrentMergeScheduler.java 447 NOTE test params are codec RandomCodecProvider field MockRandom locale nl NL timezone Turkey NOTE all tests run in this JVM TestIndexWriter NOTE Linux 2.6.32-31-generic i386 Sun Microsystems Inc. 1.6.0 20 32-bit cpus 1 threads 2 free 26480072 total 33468416 Does that repro line reproduce the failure for you Doron It s odd because that test doesn t make that many fields... oh I see it makes a 100 segment index. I ll drop that to 50... The nightly build also hits too-many-open-files every so often I suspect because our random-per-field-codec is making too many codecs... I wonder if we should throttle it Ie if it accumulates too many codecs to start sharing them b w fields I dropped it from 100 to 50 segs. Can you test if that works in your env Doron Yes thanks now it passes trunk - with this seed as well quite a few times without specifying a seed. I ll now verify on 3x. I fact in 3x this is not reproducible with same seed expected as Robert once explained and I was not able to reproduce it with no seed tried with -Dtest.iter 100 as well though I am not sure would a new seed be created in each iteration Need to verify this... Anyhow in 3x the test passes also after svn up with this fix. So I think this can be resolved... Fixed by Mike thanks Mike Thanks for raising it Doron Bulk closing for 3.2
