Support grouping by IndexDocValues
Although IDV is not yet finalized More particular the SortedSource . I think we already can discuss investigate implementing grouping by IDV. Attached initial IDV AbstractAllGroupsCollector implementation. hey martjin do yo have some benchmark results for IDV showing the impact I would guess that depending on the type ie. var vs. fixed size you could see some perf hits. We might need to round up the packedint sizes inside IDV for lookup perf and pay the prize for a slightly larger size on disk memory. Up until now I only checked the difference between BYTES VAR SORTED and BYTES FIXED SORTED. The search time and memory usage seem to be more or less the same. I executed all queries on 30M index and the performance with grouping by IDV is somewhere between 500 ms and 550 ms. The same test with grouping by indexed values have search times somewhere between 300 ms and 330 ms. We might need to round up the packedint sizes inside IDV for lookup perf and pay the prize for a slightly larger size on disk memory. I think we need this. Just like we have with FC getTermsIndex . A boolean option that either uses PackedInt or DirectInt. I think the 200 ms difference is b c IDV is using PackedInt and FC uses DirectInt. martjin here is a patch that forces the sorted variants to use fixed size packed ints. can you check if the perf changes Simon this looks great The performance is much better now. An average the search time for grouping by BYTES VAR SORTED is 329 ms and BYTES FIXED SORTED is 338 ms. The average search time for grouping by indexed values is 310 ms. So grouping by IDV is pretty close to grouping by indexed values Wow only a 9 performance penalty for not keeping the values in the JVM heap That s quite an achievement and almost hard to believe unless the base query were really expensive or something . Nice job Wow only a 9 performance penalty for not keeping the values in the JVM heap That s quite an achievement and almost hard to believe unless the base query were really expensive or something . Nice job wait this is in memory - martjin can you test with getDirectSource instead of getSource getDirectSource search times BYTES VAR SORTED 455 ms BYTES FIXED SORTED 713 ms I noticed that with BYTES VAR SORTED the memory usage varied a lot during the test execution from around 10MB to 320MB. The memory usage for BYTES FIXED SORTED is stable around 10MB. I ll try to use luceneutil and modify it to benchmark grouping by IDV so others can run performance tests as well. Minor update to IndexDocValuesAllGroupsCollector to use disk resident IDV. It s great that rounding up to 8 16 32 64 bit width resolved the performance problem I think we need to make this RAM vs CPU tradeoff settable by the app at indexing time I think we need to make this RAM vs CPU tradeoff settable by the app at indexing time I think we should do that. Maybe via IWC I noticed that with BYTES VAR SORTED the memory usage varied a lot during the test execution from around 10MB to 320MB. The memory usage for BYTES FIXED SORTED is stable around 10MB. yeah the VAR SORTED variant loads the ords in memory which is wrong though. However LUCENE-3507 is adressing this issue. one thing I noticed about the patch is that you consider 0 ords as null values which is not the case in IDV. All documents do have values there is nothing like missing values. VAR BYTES will return a 0-length byte and FIXED BYTES will return a fixed-length 0-byte array. Numeric variants default to 0 and 0.0 receptively. I think we need to make this RAM vs CPU tradeoff settable by the app at indexing time I think we should do that. Maybe via IWC That seems good I think it should default to rounding up Apps that want to tune RAM usage down can then change the default. That seems good I think it should default to rounding up Apps that want to tune RAM usage down can then change the default. 1 I will create an issue 1 I will create an issue FYI - LUCENE-3509 one thing I noticed about the patch is that you consider 0 ords as null values which is not the case in IDV. I changed that in the new patch. I also included IDV implementation for AbstractFirstPassGroupingCollector. I think it is time to include these collectors into the already existing tests. Besides that we need IDV implementations for AbstractSecondPassGroupingCollector and AbstractAllGroupHeadsCollector. After a svn update that includes changes for LUCENE-3507 the heap usage for grouping by BYTES VAR SORTED IDV and using disk resident values is much more stable It stays between 5MB and 16MB and the average search time is around 580ms. Updated patch to work with the trunk. Updated patch. Added idv implementation for second pass grouping collector. Also the tests have been changed to randomly select an idv based implementation when possible tests now choose randomly between term idv and function based implementations . Updated patch. Moved Simon s changes to force the use of the sorted variants to use fixed size packed ints to LUCENE-3509. I think this can be committed soon. The fixed size packed ints options for DV will be further improved in LUCENE-3509. Martjin the last patch looks ok to me. you should go ahead and commit this... I was planning on doing this. I m almost ready to commit it. I m only a bit stuck on documents that don t have a value for a group field. The random grouping tests also add documents with a null value for the group field and an empty string for the group field. This works fine with the term based implementations but not the DV based implementations random test fail . Should we not use null as group value if the dv based implementations are used during the test Updated patch. All tests pass now. Added dv based impl for AllGroupHeadCollector. I will commit this soon. Committed to trunk.
