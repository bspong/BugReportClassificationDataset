Passing a null fieldname to MemoryFields terms in MemoryIndex throws a NPE
I found this when querying a MemoryIndex using a RegexpQuery wrapped by a SpanMultiTermQueryWrapper. If the regexp doesn t match anything in the index it gets rewritten to an empty SpanOrQuery with a null field value which then triggers the NPE. Trivial fix - we just check if the passed in fieldname is null and if it is return null. Hmm I don t think the Fields.terms API should be expected to accept null eg I don t know if the other codecs will NPE . I d rather fix span queries to not pass the null field. Is this happening in SpanTermQuery.getSpans Here s a test case. The error is thrown in SpanQuery.createWeight when it s called on a bare SpanMultiTermQueryWrapper. It looks as though a simple workaround is to always wrap SpanMultiTermQueryWrapper in a SpanOrQuery. Maybe SpanOrQuery should not have a default constructor but should require a fieldname if no clauses are supplied Thanks for the test cases Alan I folded those into a patch added a few assert field null and then fixed SpanWeight to detect when its .getField is null and return a null scorer in that case. I d like to avoid the API break changing Span Query API to force up-front providing of the field if we can... Thanks Alan. I couldn t provoke an NPE on 3.x but I still fixed SpanWeight to not pass on a null field to IR.norms.
