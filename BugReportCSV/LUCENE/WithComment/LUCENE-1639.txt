intermittent failure in TestIndexWriter. testRandomIWReader
Rarely this test which was added with LUCENE-1516 fails in MockRAMDirectory.close because some files were not closed eg junit NOTE random seed of testcase testRandomIWReader was -5001333286299627079 junit junit Testcase testRandomIWReader org.apache.lucene.index.TestStressIndexing2 Caused an ERROR junit MockRAMDirectory cannot close there are still open files cq.tvx 3 cq.fdx 3 cq.tvf 3 cq.tvd 3 cq.fdt 3 junit java.lang.RuntimeException MockRAMDirectory cannot close there are still open files cq.tvx 3 cq.fdx 3 cq.tvf 3 cq.tvd 3 cq.fdt 3 junit at org.apache.lucene.store.MockRAMDirectory.close MockRAMDirectory.java 292 junit at org.apache.lucene.index.TestStressIndexing2.testRandomIWReader TestStressIndexing2.java 66 junit at org.apache.lucene.util.LuceneTestCase.runTest LuceneTestCase.java 88 OK I tracked this one down... in certain cases IndexWriter would 1 open a SegmentReader without doc stores when merging but doc stores not being merged 2 clone that SegmentReader to be readOnly merging requires point-in-time snapshot ie so deletions don t change during the merge and then 3 by the time the merge actually got started it became necessary to merge docStores because deletions snuck in before the cloning could finish so 4 we ask those clones to open the doc stores. SegmentReader and its clone then have separate doc store IndexInputs open and then when both are closed one set of doc stores fails to be closed. It was simple to fix when the clone wants to open doc stores we first as the original to do the open then carry over the cloned copies. I plan to commit shortly. Great work Mike I wonder if I was sometimes seeing this during development.
