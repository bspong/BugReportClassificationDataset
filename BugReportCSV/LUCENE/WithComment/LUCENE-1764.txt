SampleComparable doesn t work well in contrib remote tests
As discovered in LUCENE-1749 when using identical instances of a SortComparator you get multiple entries in the FieldCache. demonstrating this bug currently requires the patches in LUCENE-1749. See markmiller s comment here... https issues.apache.org jira browse LUCENE-1749 focusedCommentId 12735190 action 12735190 Note i set this as fix in 2.9 because it s not clear if this is a bug thta was newly introduced because of all the sorting changes in 2.9 in which case we should fix it before release or if it s always had this problem in which case we can punt on it if no one has a fix Bug was a bit strong I guess - resource hog trap - you can sidestep this if you implement hashcode equals on your SortComparator. We need a warning to do that I think. For the unit test that fails I ve changed the equals hashcode for the SortComparator to use Override public int hashCode return getClass .getName .hashCode Override public boolean equals Object other return this.hashCode other.hashCode We have always had the issue because the comparator has been part of the key and when you pass a SortField over the wire you get a new impl of the comparator factory field thats in it. I think this bug was there before. SortField has the problem that not only SortComparator also custom parsers that are not singletons serializable singletons using readResolve or do not have equals hashcode will create new cache entries each time e.g. this one new SortField field new FieldCache.LongParser ... creates a different parser instance each time and so a new cache entry is created even in non-remote usage . This is noted in the docs. updated title severity since there is no generic problem with SortComparators ... the issue is specifically with SampleCamparable. Committed revision 798726. hashcode equals changes along what miller described. We prob want a javadoc warning of some kind too though right Its not immediately obvious that when you switch to using remote you better have implemented some form of equals hashcode or you will have a memory leak. I think we need to add warnings - so reopening Not very happy with it but here is sort of a stub for the type of doc we need.
