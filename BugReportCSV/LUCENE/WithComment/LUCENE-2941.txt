custom sort broken if IS uses executorservice
attached is a testcase fails on both trunk and 3.x this works public void testSort throws Exception SortField sf new SortField field locale TopFieldDocs docs searcher.search new MatchAllDocsQuery null numDocs new Sort sf ... this doesn t if IS uses executorservice public void testSort2 throws Exception SortField sf new SortField field new FieldComparatorSource Override public FieldComparator newComparator String fieldname int numHits int sortPos boolean reversed throws IOException return new FieldComparator.StringComparatorLocale numHits fieldname locale TopFieldDocs docs searcher.search new MatchAllDocsQuery null numDocs new Sort sf The problem is inside the FieldDocSortedHitQueue... the only reason Locale sort works today is because it cheats and looks inside the SortField to see if it has a locale and does things with its collator. But if you code the same approach as a custom sort it won t work. How about something like this I just make a new TopFieldCollector to collect per-segment each of the subs. If we do this we should remove the FieldDocSortedHitQueue. I haven t checked whether Robert s test passes w this yet Patch seems to fix my issue in trunk the test attached to the issue is actually committed as contrib queries ...TestSlowCollationMethods you just gotta enable newSearcher to trigger the bug but the test attached to the issue works for branch 3x so we probably want something like that there along with any fix. New patch cuts over the new TestSlowCollationMethods to newSearcher which failed before but passes now and removes dead code. Bulk close for 3.1
