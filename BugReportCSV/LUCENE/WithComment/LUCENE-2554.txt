preflex codec doesn t order terms correctly
The surrogate dance in the preflex codec which must dynamically remap terms from UTF16 order to unicode code point order is buggy. To better test it I want to add a test-only codec preflexrw that is able to write indices in the pre-flex format. Then we should also fix tests to randomly pick codecs including preflexrw so we better test all of our codecs. Attached VERY rough patch. Mosts tests pass but at least 2 don t. I think the fixes to surrogates dance are close to correct. The new random test TestSurrogates is good at finding bugs there... The hack I have to forcefully use the test-only preflexrw codec needs to be made more generic so that we can randomly pick the default codec to use for each test. the perf issues here are really from our contrived tests... its good to use TestUtil.randomUnicodeString but it gives you the impression there is something wrong with this dance and there really isnt. I added TestUtil.randomRealisticUnicodeString in r966878 you can swap this into some of these slow tests and see its definitely the problem. Fixed the test failures Ð all tests should pass. Fixed a couple more issues found by intensive overnight random testing... cleaned up a few things. We still need a clean way to randomly swap in the preflexrw codec.... We still need a clean way to randomly swap in the preflexrw codec.... I don t think we should do this with RandomIndexWriter like we do now but pull this stuff out of there and move it to ant LuceneTestCase. I would prefer if we could supply a variable to ant e.g. -Dtest.codec and LuceneTestCase J4 would set the codec to this. We could allow for a value of random here also to do what RIW does today. I think this would make it easier to run the entire test suite with different codecs. Also some tests testCases might not be suitable for all codecs and so we need to add annotations or some way to special-case these tests. here is a patch of the merge to trunk. All tests pass. Committed revision 979453.
