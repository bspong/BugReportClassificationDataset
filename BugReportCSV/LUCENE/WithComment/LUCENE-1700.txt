LogMergePolicy.findMergesToExpungeDeletes need to get deletes from the SegmentReader
With LUCENE-1516 deletes are carried over in the SegmentReaders which means implementations of MergePolicy.findMergesToExpungeDeletes such as LogMergePolicy need to obtain deletion info from the SR instead of from the SegmentInfo which won t have the information . Taking a step back maybe we can solve the package protected SegmentInfo issue here by creating a new class with the necessary attributes Here s what LUCENE-1313 does SegmentReader sr writer.readerPool.getIfExists info if info.hasDeletions sr null sr.hasDeletions Because SegmentInfo is package protected it seems ok to access a package protected method or in this case variable in IndexWriter. Attached patch. I added a test case showing it then took that same approach from LUCENE-1313 and the test passes. I also found that with NRT because the deletions are applied before building the CFS after flushing we wind up holding open both the non-CFS and CFS files on creating the reader. So I changed deletions to flush after the CFS is built. I plan to commit in a day or two. Thanks Jason 
