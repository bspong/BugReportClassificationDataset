IW nrtIsCurrent retruns true if changes are in del queue but not in bufferedDeleteStream yet
spinnoff from SOLR-2861 - since the delete queue is not necessarily applied entirely on each request there is a chance that there are changes in the delete queue but not yet in buffered deletes. this can prevent NRT readers from reopen when they should... this shows the problematic code Index java org apache lucene index IndexWriter.java java org apache lucene index IndexWriter.java revision 1195214 java org apache lucene index IndexWriter.java working copy -4074 7 4074 7 synchronized boolean nrtIsCurrent SegmentInfos infos System.out.println IW.nrtIsCurrent infos.version segmentInfos.version docWriter.anyChanges bufferedDeletesStream.any ensureOpen - return infos.version segmentInfos.version docWriter.anyChanges bufferedDeletesStream.any return infos.version segmentInfos.version docWriter.anyChanges docWriter.deleteQueue.anyChanges Egads Nice catch Simon and Yonik. Sorry I didn t think realize that this change cutover to IR.openIfChanged could have been what lead to Solr s TestRTGet failures... I was wrong - docWriter.anyChanges takes that into account already. sorry for the noise I wasn t completely wrong here. The DWDQ anyChanges implementation actually has this particular issue. Patch follows... I added an isolated testcase which fails without this patch. I was able to reproduce SOLR-2861 with softCommits 101 fairly easy without this patch it fails but passes over 1k iterations for me so far. Seems like this is the issue Committed in revision 1196211
