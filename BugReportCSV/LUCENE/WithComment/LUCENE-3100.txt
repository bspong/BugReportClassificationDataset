IW.commit writes but fails to fsync the N.fnx file
In making a unit test for NRTCachingDir LUCENE-3092 I hit this surprising bug Because the new N.fnx file is written at the last minute along with the segments file it s not included in the sis.files that IW uses to figure out which files to sync. This bug means one could call IW.commit successfully return and then the machine could crash and when it comes back up your index could be corrupted. We should hopefully first fix TestCrash so that it hits this bug maybe it needs more better randomization then fix the bug.... man good catch Since the fnx file is considered to be a real relative to the segments file its not in the SIS files if you don t specify commmit true so it doesn t get synced with other files during IW prepareCommit. Phew sneaky I think we should sync that file upon successful write explicitly in SIS - possibly simple change but big bang ey here is a patch sync ing the file on successful write during prepareCommit Patch looks good Simon Committed in revision 1104090.
