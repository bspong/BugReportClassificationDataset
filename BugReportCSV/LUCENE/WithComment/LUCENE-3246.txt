Invert IR.getDelDocs - IR.getLiveDocs
Spinoff from LUCENE-1536 where we need to fix the low level filtering we do for deleted docs to match Filters ie a set bit means the doc is accepted so that filters can be pushed all the way down to the enums when possible appropriate. This change also inverts the meaning first arg to TermsEnum.docs AndPositions renames from skipDocs to liveDocs . Initial patch pulled out of LUCENE-1536 plus 1 renamed IR.getNotDeletedDocs to IR.getLiveDocs and 2 fixed IR to force subclasses to override this removing getDeletedDocs . I think this is close but the one thing remaining is to fix the IR impls to properly invert their del docs now they create a NotDocs wrapper around their current bitsets . Hi Mike some work for you I removed the nocommits in both contrib IndexSplitters. Now only NotBits usage in core is left over right Awesome thanks Uwe I ll work on SR cutting over to live docs on disk... Patch. I think it s ready Hi Mike As we have now both variants to read write BitVectors would it be not a good idea to automatically use the old encoding for liveDocs if more than 50 of all bits are unset This would save disk space if a segments has more deletetions than live docs. Not sure if this can easily be implemented and is worth the complexity that we already have because of both versions The patch looks fine As we have now both variants to read write BitVectors would it be not a good idea to automatically use the old encoding for liveDocs if more than 50 of all bits are unset That seems like a good idea Ie handle both sparse set and sparse unset compactly Though it should be unusual that you have so many deletes against a segment esp. because TMP now targets such segs more aggressively . We should do this under a new issue the old code also didn t handle the many deletions case sparsely either just the few deletions case . Next I ll work on LUCENE-1536... This commit changed the index format the .del but the change is fully back-compat even with trunk indices. I think the javadoc comments for TermsEnum.docs are now incorrect due to this commit. It says param liveDocs set bits are documents that should not be returned which looks backwards. maybe other places are wrong too I haven t checked I think the javadoc comments for TermsEnum.docs are now incorrect due to this commit. You re right I just committed a fix. Thanks Sean.
