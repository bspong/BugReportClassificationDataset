Automatic type conversion no longer works
String values are no longer converted to binary when required. Example Node n testRootNode.addNode testConvert nt file Node content n.addNode jcr content nt resource content.setProperty jcr lastModified Calendar.getInstance content.setProperty jcr mimeType text html content.setProperty jcr data Hello n.getSession .save This used to work in a previous 2.0 build but now throws javax.jcr.nodetype.ConstraintViolationException no matching property definition found for http www.jcp.org jcr 1.0 data at org.apache.jackrabbit.core.nodetype.EffectiveNodeType.getApplicablePropertyDef EffectiveNodeType.java 782 at org.apache.jackrabbit.core.NodeImpl.getApplicablePropertyDefinition NodeImpl.java 747 at org.apache.jackrabbit.core.ItemManager.getDefinition ItemManager.java 241 at org.apache.jackrabbit.core.ItemData.getDefinition ItemData.java 101 at org.apache.jackrabbit.core.ItemManager.canRead ItemManager.java 409 at org.apache.jackrabbit.core.ItemManager.getItemData ItemManager.java 383 at org.apache.jackrabbit.core.ItemManager.getItem ItemManager.java 316 at org.apache.jackrabbit.core.ItemManager.getItem ItemManager.java 595 at org.apache.jackrabbit.core.NodeImpl.removeChildProperty NodeImpl.java 554 at org.apache.jackrabbit.core.NodeImpl.removeChildProperty NodeImpl.java 534 at org.apache.jackrabbit.core.NodeImpl.setProperty NodeImpl.java 2303 at org.apache.jackrabbit.core.nodetype.ConvertDataTypeTest.testStringToBinary ConvertDataTypeTest.java 36 at sun.reflect.NativeMethodAccessorImpl.invoke0 Native Method This is probably a regression caused by JCR-2170.yes it is a regression of JCR-2170. other type conversions are probably affected as well.There should be a test case in the TCK but I m not sure where. Relevant section in the spec is at page 31 3.6.4 Property Type Conversion When the value of a property is read or written using a type different from that declared for the property the repository attempts a type conversion according to the following rules. Is there a lookup table that links the spec to the TCK tests and back I experienced the same issue. Proper workaround because setProperty String InputStream is deprecated in JCR 2.0 is     node.setProperty JcrConstants.JCR DATA             node.getSession .getValueFactory .createBinary new ByteArrayInputStream new byte      Grrr. ... workround ... that will work but you should also call Binary.dispose once you are done with the created Binary instance. Otherwise you depend on the GC and a well behaving implementation that will hopefully clean up resource held by the Binary e.g. temp file .- fixed automatic type conversion - cleaned up setProperty methods and removed duplicate code - added tests in core.NodeImplTest svn revision 820908 but you should also call Binary.dispose once you are done with the created Binary instance Argh.... who came up with that beast - 
