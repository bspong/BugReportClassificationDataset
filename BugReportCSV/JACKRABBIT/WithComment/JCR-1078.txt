ChangeLog serialization causes cache inconsistencies
The ordering of actions is taken into account when a ChangeLog is built through session manipulations see for instance ChangeLog.deleted ItemState state . When it is serialized in ClusterNode.write Record record ChangeLog changeLog EventStateCollection esc however this implicit ordering might be changed. As a consequence the deserialization in ClusterNode.consume Record record might produce a different ChangeLog with the effect that the local caches get out-of-sync with the persistent state of the repository. The issue should be reproducable as follows - Setup a clustered environment with two Jackrabbit instances say A and B. - On instance A add a property P with value x to some node and save the session. - On instance B read property P - it will have value x . - On instance A delete property P and then add it again with value y and save the session. - On instance B read property P - it will still have value x after the cluster sync...I can reproduce this problemI think that the following holds for a ChangeLog 1 state in addedStates no deleted state events after the added state event. 2 state in modifiedStated no added state event and no deleted state event after the modified state event 3 state in deletedStates no added state event earlier The serialization code should derive an ordering such that these properties hold.Swapping the order of the serialization to 1 serialize deletedStates 2 serialize modifiedStates 3 serialize addedStates in ClusterNode.write Record record ChangeLog changeLog EventStateCollection esc should work. Here s a patch for it. I tested it on the scenario from the description and it works there.Good observation Martijn. In fact putting the states in the following order back into the ChangeLog on deserialization should do the trick 1 deleted checks added and removed 2 modified checks added only 3 added Wow that was quick When comparing my change to yours the only difference found was the revision number on top. Applied the patch and verified that it solves the problem. Thanks for reporting and submitting a patch great job You re welcome. Thanks for responding so quickly on this issue Merged to the 1.3 branch in revision 577858.
