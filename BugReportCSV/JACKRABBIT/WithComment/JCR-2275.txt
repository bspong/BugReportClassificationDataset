some legal jcr names cause unneccessary server-roundtrips
assume the following legal qualified jcr names foo foo bar when items with such names are read from the spi layer they are first interpreted as expanded form names. a prefix lookup for namespace foo fails and the name is treated as qualified jcr name. depending on the spi implementation a server-roundtrip is required in order to determine that foo is not a registered namespace.a patch for o.a.jackrabbit.spi.commons.conversion NameParser that includes a simple static check of the name in order to avoid unneccessary server-roundtrips the following names are always considered being qualified jcr names since the would be illegal expanded form - foo empty local name is not allowed - foo bar leading space in local name is not allowed however the patch causes 2 failures in o.a.jackrabbit.spi.commons.conversion NameParser IMO the failing test cases are questionable and could be fixed.Instead of custom rules like this I d rather use the expanded form rule that the URI part always contains a colon. Thus the following test will always detect whether a name is in expanded form    name.startsWtih name.indexOf -1 The only problem is the internal namespace used with the rep prefix. For now we can treat that as a special case    name.startsWtih name.indexOf -1 name.startsWith internal I would also recommend that we migrate from internal to using a proper namespace URI like http jackrabbit.apache.org ns 2009 internal .I agree with jukka that we should only allow proper uris in expanded form. and yes we should probably change the internal namespace. Instead of custom rules like this I d rather use the expanded form rule that the URI part always contains a colon. Thus the following test will always detect whether a name is in expanded form name.startsWtih name.indexOf -1 The only problem is the internal namespace used with the rep prefix. For now we can treat that as a special case name.startsWtih name.indexOf -1 name.startsWith internal i was considering this as well but then it felt somehow strange to cover a special jackrabbit-core case in the generic spi-commons module... I would also recommend that we migrate from internal to using a proper namespace URI like http jackrabbit.apache.org ns 2009 internal . agreed 1 according to the spec the namespace has to be a proper uri as defined in setion 3 of rfc 3986 i.e. it always must contain a scheme part delimited by a colon. test cases will need to be adapted as well. Resolved as a part of JCR-2288 in revision 815745.
