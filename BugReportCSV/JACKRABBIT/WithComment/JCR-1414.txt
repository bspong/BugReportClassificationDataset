Data store garbage collection inUse not correctly synchronized
Access to the fields DbDataStore.inUse and FileDataStore.inUse is not synchronized. This is a problem when concurrently calling GarbageCollector.deleteUnused and accessing the data store ConcurrentModificationException is thrown .Committed in revision 631905. This is quite a large patch sorry To test it first configure the data store in the src test repository repository.xml for example DataStore class org.apache.jackrabbit.core.data.FileDataStore DataStore and then run the test case org.apache.jackrabbit.core.data.GCConcurrentTest with the system property jackrabbit.test.scale set to 100 or larger. By default this test case is very quick and will not find the problem.Does the above commit resolve this issue I merged it to the 1.4 branch in revision 633844.Yes the commit resolves the problem.Revision 633844 also fixed a bug in BundleDbPersistenceManager which caused data store garbage collection to delete almost all data when using a BundleDbPersistenceManager. See also JCR-2492.
