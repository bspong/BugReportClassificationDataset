Completeness Freshness of NamespaceRegistry and NodeTypeRegistry
We need to define the requirements on completeness and freshness of RepositoryService.getRegisteredNamespaces . Right now the optimistic assumption seems to be that an SPI provider is able to report all namespaces that can occur in a repository beforehand. Even if it can do that and I know of potential targets for SPI that simply can t this seems to be quite a waste of time if these namespace prefixes aren t actually used later on. Furthermore in SPI namespace prefixes aren t really relevant except to enable the transient layer to return meaningful prefixes instead of automatically generated ones. Therefore my propoal would be to 1 Clarify that the Map returned from getRegisteredNamespaces isn t required to be complete 2 Enhance JCR2SPI to auto-generate prefixes when it encounters namespaces not in the registry. I expect this to also affect RepositoryService. un registerNamespace ... but let s discuss the underlying issue first... JCR-482 is about the XML export assuming that the set of namespace prefixes is known when starting an XML export in fact it can change while the export is executed. RepositoryConfig.getRegisteredNamespaces there is not RepositoryConfig in the SPI and the one contained in jcr2spi doesn t have the mentioned method. you probably mean RepositoryService don you fix typo RepositoryService vs RepositoryConfig Namespace prefixes cannot be just generated because there is a notion of a repository wide namespace registry with a somewhat stable mapping between namespace URI and prefix. Initially a JCR session has to use that mapping unless the client decides to re-map the namespace locally in its session.I think that instead of or before auto-generating a prefix for an unknown namespace the jcr2spi should ask the backend for a prefix update. Here s a few different ways I can imagine we could achieve this arranged by network-efficiency 1 Allow the SPI to return the prefix as an optional part of a QName when using a namespace that the client has not yet seen 2 Make the client call RepositoryService.getRegisteredNamespaces SessionInfo with an added namespace argument so the backend can decide whether to return the entire registry or just a subset update containing the requested prefix 3 Add a RepositoryService.getNamespacePrefix SessionInto String method for the client to explicitly request the missing prefix 4 Make the client call RepositoryService.getRegisteredNamespaces SessionInfo to refresh the local copy of the registry I like 1 alot in fact I was going to suggest something like this myself... but 2 and 3 would work well for me as well. I d really like to avoid 4 . 1 Allow the SPI to return the prefix as an optional part of a QName when using a namespace that the client has not yet seen I m not sure I understand this correctly does that mean the QName class should provide a getPrefix which may or may not returns a prefix I would rather prefer 4 and say that this method must return at least the mapping of namespace uri to prefix mapping for QNames that have been used through this instance of RepositoryService since it was created. The jcr2spi would then just refresh it s namespace registry when it encounters an unknown namespace uri. I d like to avoid adding methods to the RepositoryService which overlap functionality that is already there One problem with approach 4 is that in some backend systems users can set arbitrary custom properties. That is there is no namespace registry at all and the set of namespaces used by properties can be really large. I think an SPI design that requires the remote server to return all of these mappings even if they may be not be used would be a bad idea. I would require that only those mappings must be available that went through the RepositoryService. Not all just the ones that are required to resolve QName and Path instances that were retrieved through the RepositoryService. The remote server could still have thousands of namespaces that are not known to the SPI because the SPI client never read QNames with such a namespace. me must return at least the mapping of namespace uri to prefix mapping for QNames that have been used through this instance of RepositoryService since it was created. 1 Clarify that the Map returned from getRegisteredNamespaces isn t required to be complete i m not totally happy with this. getRegisteredNamespaces should return the complete list available at the time. but as listed in TODO.txt issue 11 we didn t define up to now how a client gets informed or informes itself about namespace modifications. 2 Enhance JCR2SPI to auto-generate prefixes when it encounters namespaces not in the registry. hm... why shoud the jcr2spi autogenerate prefixes it must assert that a given namespace is part of the namespace registry and throw if it isn t. so we get back to the basic issue how we define the update of the NamespaceRegistry defined by jsr170 over the SPI. btw the same applies for the nodetypes. regards angelaOK. I have a prototype running which at least fixes the problem for me. Changes 1 NamespaceStorage add method getRegisteredNamespaces 2 add that to WorkspaceManager 3 use it in NamespaceRegistryImpl to get a new map when the local one is incomplete. What s currently missing in NamespaceRegistryImpl is a way to add the newly retrieved mapping to the local map so the refresh logic only needs to be applied once per new entry . If people think I m on the right track with this I will complete the fix and submit a patch. The optimizations we discussed can then be discussed separately. Proposed patch as discussed in previous comment. i committed the patch with some modifications as a short term solution. form my point of view the patch addresses the problem only partially before throwing NamespaceException upon getPrefix and getURI the current solution checks if the NamespaceRegistry is really up to date. however - NamespaceRegistry.getURIs and NamespaceRegistry.getPrefixes will not return all prefixes uris   registered on the server unless getPrefix or getURI has been called. - reregistering of a existing URI with a new prefix might not be detected - unregistering of an existing namespace will never result in an update of other NamespacRegistries   but cause failures later on when the API user relies on the NamespaceRegistry which is outdated. i d say that we need to come up with some notification approach maybe related to the CacheBehaviour recently introduced that addresses the problem. for the time being reloading the mappings defined on the server might be an acceptable workaround.adjusting subject. The same applies for the NodeTypeRegistry.JCR 2.0 will most likely declare the prefix mappings of a session stable i.e. changes in a session will not invalidate the prefix mappings in another session so the cache invalidation issue for namespaces may become a non-issue.based on jukkas comment i resolve this issue fixed. i will add a note to the Limitations.txt explaining the known issue.
