Support for transactions when using JCR over RMI.
At this time the sessions obtained from o.a.j.rmi.client.LocalAdapterFactory do not implement the methods for the XASession. Therefor the RMI access layer does not support a transactional session.I think the only thing that needed to be implemented is to extend both client and server side decorator stubs to implement the XAResource interface. The client when asked for the getXAResource can just return itself. In the implementation of the XAResource interface the client stub can just call the server side stub over RMI. The server side stub just forwards the call to the actual session. This works because the transaction IDs Xid are serializable and can be passed over RMI. The transactions themselves are managed at the client side. I will be providing a proposal patch for this shortly. Patch which was made from SVN revision 570736 of the jackrabbit source. This implements transactional based RMI support.I used the following project to test the transaction support in RMI. The test can be run seperately or as unit test though these client-server test do not lend themselves for unit test in general. A mock up test is useless in this case anyway. Looks nice thanks a lot The only concern I have is about the additional jackrabbit-core dependency. Perhaps we should move org.apache.jackrabbit.core.XASession to jackrabbit-api. I ll file a separate issue for that.Indeed the jackrabbit-core dependency is pretty ugly. There is no proper way other than to pull the XASession out of the core into the api. This would be a simple move operation and would cleanly fix it. It is a pitty that the XASession interface did not make it into the specification. I saw that in earlier draft there was a reference to this   http www.day.com maven jsr170 javadocs jcr-0.15 javax jcr xa XASession.html But it did not make it into the spec. It strikes me as an omission that the spec defines a level for transaction but not an interface to obtain a XAResource as is given by XASession . I filed a separate issue JCR-1097 for the XASession move and will propose a patch for that later today. I don t know the rationale for not including XASession in JCR 1.0. I ll raise the issue within the JSR 283 expert group.Now that JCR-1097 was resolved I took another look at the patch and committed a slightly modified version in revision 573739. Instead of putting all the XAResource methods in the RemoteXASession interface I added a separate RemoteXAResource interface and all the related machinery to keep things modular. It would be great if you could test this in practice as I didn t yet have time to set up the test code you sent. Doesn t quite work yet because SessionXAResource is not available remotely. Will provide easy and small fix in next attached patch.Minor patch to earlier changes as the ServerXAResource needs to be a remote object. Changes to test application to take into account that the XASession has been moved to JackRabbit API iso. core jar. I think that my minor patch from earlier today can be applied without modifications. I ve tested with the test application and then it seems to work fine. Ah obviously Thanks for the tip fixed in revision 574273. I made ServerXAResource extend UnicastRemoteObject directly instead of through ServerObject since it doesn t need to instantiated new adapters or throw RepositoryExceptions.Verified works. Thanks a bunch.
