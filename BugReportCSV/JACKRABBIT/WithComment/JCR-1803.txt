Node.restore throws java.lang.ClassCastException
I m trying to upgrade to 1.5 using existing 1.3.x repository. Restore of versionable node throws ClassCastException. Caused by java.lang.ClassCastException org.apache.jackrabbit.uuid.UUID at org.apache.jackrabbit.core.value.InternalValue.getString InternalValue.java 436 at org.apache.jackrabbit.core.version.InternalFrozenNodeImpl. init InternalFrozenNodeImpl.java 113 at org.apache.jackrabbit.core.version.AbstractVersionManager.createInternalVersionItem AbstractVersionManager.java 576 at org.apache.jackrabbit.core.version.VersionManagerImpl.getItem VersionManagerImpl.java 258 at org.apache.jackrabbit.core.version.InternalVersionImpl.getFrozenNode InternalVersionImpl.java 111 at org.apache.jackrabbit.core.version.VersionImpl.getFrozenNode VersionImpl.java 120 at org.apache.jackrabbit.core.NodeImpl.internalRestore NodeImpl.java 4180 at org.apache.jackrabbit.core.NodeImpl.internalRestore NodeImpl.java 4141 at org.apache.jackrabbit.core.NodeImpl.restore NodeImpl.java 3429 It seems that bug has been introduced already in 1.4 as part of JCR-926 InternalValue cleanup . Index C data jackrabbit jackrabbit-core src main java org apache jackrabbit core version InternalFrozenNodeImpl.java C data jackrabbit jackrabbit-core src main java org apache jackrabbit core version InternalFrozenNodeImpl.java revision 549117 C data jackrabbit jackrabbit-core src main java org apache jackrabbit core version InternalFrozenNodeImpl.java working copy -109 10 109 10              PropertyState prop props i              if prop.getName .equals QName.JCR FROZENUUID                   special property - frozenUUID UUID.fromString node.getPropertyValue QName.JCR FROZENUUID .internalValue .toString frozenUUID UUID.fromString node.getPropertyValue QName.JCR FROZENUUID .getString Probably one of the assumptions made was wrong - The type of QName.JCR FROZENUUID is STRING Object.toString was used before .Have you upgraded all the Jackrabbit jars in your classpath to 1.5 This looks more like a class version mismatch than a compatibility issue with repository content.I ve examined that all the libraries are ok. Problem seems to be related to old issue JCR-487 our version storage still contains frozen nodes with jcr frozenUuid field stored as REFERENCE instead of STRING. Method internalValue .toString works in both cases whilst getString on jcr frozenUUID fails for such nodes .Ah that would explain the issue. I ll look into this.I fixed it by simply reverting this single line. Doesn t like it but works . Alternative solution is to fix the whole existing version storage somehow on low level PM but it must be done differently depending on used persistence manager.I think it s better if we just explicitly handle both STRING and REFERENCE values here. I committed the fix to trunk in revision 704158. Instead of using the discouraged internalValue method I explicitly check the type of the value and react accordingly. Merged to the 1.5 branch in revision 704160.
