When adding a large 100MB binary to the DbDataStore it fails with an insufficient memory exception
Attached is a small test case. It fails during save . I think this is related to what I mentioned in http mail-archives.apache.org mod mbox jackrabbit-dev 200711.mbox 3c00fc01c832b9 f1f08730 7309240a goku 3e The full stacktrace is the following javax.jcr.RepositoryException unable to update item. failed to write property state cafebabe-cafe-babe-cafe-babecafebabe bin failed to write property state cafebabe-cafe-babe-cafe-babecafebabe bin at org.apache.jackrabbit.core.ItemImpl.save ItemImpl.java 1252 at org.apache.jackrabbit.core.SessionImpl.save SessionImpl.java 858 at org.apache.jackrabbit.core.data.BigBinaryTest.testBigBinary BigBinaryTest.java 16 at sun.reflect.NativeMethodAccessorImpl.invoke0 Native Method at sun.reflect.NativeMethodAccessorImpl.invoke NativeMethodAccessorImpl.java 39 at sun.reflect.DelegatingMethodAccessorImpl.invoke DelegatingMethodAccessorImpl.java 25 at java.lang.reflect.Method.invoke Method.java 585 at junit.framework.TestCase.runTest TestCase.java 154 at junit.framework.TestCase.runBare TestCase.java 127 at junit.framework.TestResult 1.protect TestResult.java 106 at junit.framework.TestResult.runProtected TestResult.java 124 at junit.framework.TestResult.run TestResult.java 109 at junit.framework.TestCase.run TestCase.java 118 at org.apache.jackrabbit.test.AbstractJCRTest.run AbstractJCRTest.java 404 at junit.framework.TestSuite.runTest TestSuite.java 208 at junit.framework.TestSuite.run TestSuite.java 203 at org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run JUnit3TestReference.java 128 at org.eclipse.jdt.internal.junit.runner.TestExecution.run TestExecution.java 38 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests RemoteTestRunner.java 460 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests RemoteTestRunner.java 673 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run RemoteTestRunner.java 386 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main RemoteTestRunner.java 196 Caused by org.apache.jackrabbit.core.state.ItemStateException failed to write property state cafebabe-cafe-babe-cafe-babecafebabe bin at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 487 at org.apache.jackrabbit.core.persistence.AbstractPersistenceManager.store AbstractPersistenceManager.java 75 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 282 at org.apache.jackrabbit.core.state.SharedItemStateManager Update.end SharedItemStateManager.java 687 at org.apache.jackrabbit.core.state.SharedItemStateManager.update SharedItemStateManager.java 856 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 324 at org.apache.jackrabbit.core.state.XAItemStateManager.update XAItemStateManager.java 313 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 300 at org.apache.jackrabbit.core.state.SessionItemStateManager.update SessionItemStateManager.java 306 at org.apache.jackrabbit.core.ItemImpl.save ItemImpl.java 1244 ... 21 more Caused by org.apache.jackrabbit.core.data.DataStoreException Can not read identifier a2ada2d96d0b05214288efa03be9005a5bb98c9b Memoria insuficiente. Utilice cursores del servidor para result sets grandes Java heap space. Tama–o de result set 104.857.723. Tama–o memoria total JVM 66.650.112. Memoria insuficiente. Utilice cursores del servidor para result sets grandes Java heap space. Tama–o de result set 104.857.723. Tama–o memoria total JVM 66.650.112. at org.apache.jackrabbit.core.data.db.DbDataStore.convert DbDataStore.java 438 at org.apache.jackrabbit.core.data.db.DbDataStore.getInputStream DbDataStore.java 481 at org.apache.jackrabbit.core.data.db.DbDataRecord.getStream DbDataRecord.java 61 at org.apache.jackrabbit.core.value.BLOBInDataStore.getStream BLOBInDataStore.java 93 at org.apache.jackrabbit.core.persistence.util.Serializer.serialize Serializer.java 198 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 476 ... 30 more Caused by com.microsoft.sqlserver.jdbc.SQLServerException Memoria insuficiente. Utilice cursores del servidor para result sets grandes Java heap space. Tama–o de result set 104.857.723. Tama–o memoria total JVM 66.650.112. at com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDriverError Unknown Source at com.microsoft.sqlserver.jdbc.DBComms.receive Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.doExecutePreparedStatement Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement PreparedStatementExecutionRequest.executeStatement Unknown Source at com.microsoft.sqlserver.jdbc.CancelableRequest.execute Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerConnection.executeRequest Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.execute Unknown Source at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmtInternal ConnectionRecoveryManager.java 362 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmtInternal ConnectionRecoveryManager.java 292 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmt ConnectionRecoveryManager.java 257 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmt ConnectionRecoveryManager.java 237 at org.apache.jackrabbit.core.data.db.DbDataStore.getInputStream DbDataStore.java 474 ... 34 more org.apache.jackrabbit.core.state.ItemStateException failed to write property state cafebabe-cafe-babe-cafe-babecafebabe bin at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 487 at org.apache.jackrabbit.core.persistence.AbstractPersistenceManager.store AbstractPersistenceManager.java 75 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 282 at org.apache.jackrabbit.core.state.SharedItemStateManager Update.end SharedItemStateManager.java 687 at org.apache.jackrabbit.core.state.SharedItemStateManager.update SharedItemStateManager.java 856 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 324 at org.apache.jackrabbit.core.state.XAItemStateManager.update XAItemStateManager.java 313 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 300 at org.apache.jackrabbit.core.state.SessionItemStateManager.update SessionItemStateManager.java 306 at org.apache.jackrabbit.core.ItemImpl.save ItemImpl.java 1244 at org.apache.jackrabbit.core.SessionImpl.save SessionImpl.java 858 at org.apache.jackrabbit.core.data.BigBinaryTest.testBigBinary BigBinaryTest.java 16 at sun.reflect.NativeMethodAccessorImpl.invoke0 Native Method at sun.reflect.NativeMethodAccessorImpl.invoke NativeMethodAccessorImpl.java 39 at sun.reflect.DelegatingMethodAccessorImpl.invoke DelegatingMethodAccessorImpl.java 25 at java.lang.reflect.Method.invoke Method.java 585 at junit.framework.TestCase.runTest TestCase.java 154 at junit.framework.TestCase.runBare TestCase.java 127 at junit.framework.TestResult 1.protect TestResult.java 106 at junit.framework.TestResult.runProtected TestResult.java 124 at junit.framework.TestResult.run TestResult.java 109 at junit.framework.TestCase.run TestCase.java 118 at org.apache.jackrabbit.test.AbstractJCRTest.run AbstractJCRTest.java 404 at junit.framework.TestSuite.runTest TestSuite.java 208 at junit.framework.TestSuite.run TestSuite.java 203 at org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run JUnit3TestReference.java 128 at org.eclipse.jdt.internal.junit.runner.TestExecution.run TestExecution.java 38 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests RemoteTestRunner.java 460 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests RemoteTestRunner.java 673 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run RemoteTestRunner.java 386 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main RemoteTestRunner.java 196 Caused by org.apache.jackrabbit.core.data.DataStoreException Can not read identifier a2ada2d96d0b05214288efa03be9005a5bb98c9b Memoria insuficiente. Utilice cursores del servidor para result sets grandes Java heap space. Tama–o de result set 104.857.723. Tama–o memoria total JVM 66.650.112. Memoria insuficiente. Utilice cursores del servidor para result sets grandes Java heap space. Tama–o de result set 104.857.723. Tama–o memoria total JVM 66.650.112. at org.apache.jackrabbit.core.data.db.DbDataStore.convert DbDataStore.java 438 at org.apache.jackrabbit.core.data.db.DbDataStore.getInputStream DbDataStore.java 481 at org.apache.jackrabbit.core.data.db.DbDataRecord.getStream DbDataRecord.java 61 at org.apache.jackrabbit.core.value.BLOBInDataStore.getStream BLOBInDataStore.java 93 at org.apache.jackrabbit.core.persistence.util.Serializer.serialize Serializer.java 198 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 476 ... 30 more Caused by com.microsoft.sqlserver.jdbc.SQLServerException Memoria insuficiente. Utilice cursores del servidor para result sets grandes Java heap space. Tama–o de result set 104.857.723. Tama–o memoria total JVM 66.650.112. at com.microsoft.sqlserver.jdbc.SQLServerException.makeFromDriverError Unknown Source at com.microsoft.sqlserver.jdbc.DBComms.receive Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.doExecutePreparedStatement Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement PreparedStatementExecutionRequest.executeStatement Unknown Source at com.microsoft.sqlserver.jdbc.CancelableRequest.execute Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerConnection.executeRequest Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.execute Unknown Source at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmtInternal ConnectionRecoveryManager.java 362 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmtInternal ConnectionRecoveryManager.java 292 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmt ConnectionRecoveryManager.java 257 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmt ConnectionRecoveryManager.java 237 at org.apache.jackrabbit.core.data.db.DbDataStore.getInputStream DbDataStore.java 474 ... 34 more Hi The problem is that the MS SQL Server JDBC driver tries to load the whole result set in memory by default including the BLOB . There is a solution - Use version 1.2 of the MS SQL Server JDBC driver - Apend responseBuffering adaptive to the database URL jdbc sqlserver localhost 4220 DatabaseName test responseBuffering adaptive - Don t append selectMethod cursor if you do it will run out of memory For more information see http blogs.msdn.com jdbcteam archive 2007 05 02 what-is-adaptive-response-buffering-and-why-should-i-use-it.aspx Download the 1.2 driver from here http msdn2.microsoft.com en-us data aa937724.aspx It looks like this solves the problem. The sample app I have used is public class BigBinaryTest extends JUnitTest ÊÊÊÊpublic void testBigBinary throws Throwable ÊÊÊÊÊÊÊÊtry ÊÊÊÊÊÊÊÊÊÊÊÊfinal Repository repository Repository new TransientRepository ÊÊÊÊÊÊÊÊÊÊÊÊSession session repository.login new SimpleCredentials ÊÊÊÊÊÊÊÊÊÊÊÊÊÊÊÊÊÊÊÊ username password .toCharArray ÊÊÊÊÊÊÊÊÊÊÊÊNode root session.getRootNode ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println setProperty... ÊÊÊÊÊÊÊÊÊÊÊÊroot.setProperty bin getStream ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println save... ÊÊÊÊÊÊÊÊÊÊÊÊsession.save ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println done... ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println getProperty... ÊÊÊÊÊÊÊÊÊÊÊÊProperty prop root.getProperty bin ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println getStream... ÊÊÊÊÊÊÊÊÊÊÊÊInputStream in prop.getStream ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println compareStreams... ÊÊÊÊÊÊÊÊÊÊÊÊRandomInputStream.compareStreams in getStream ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println close... ÊÊÊÊÊÊÊÊÊÊÊÊin.close ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println logout... ÊÊÊÊÊÊÊÊÊÊÊÊsession.logout ÊÊÊÊÊÊÊÊÊÊÊÊSystem.out.println done ÊÊÊÊÊÊÊÊ catch Throwable e ÊÊÊÊÊÊÊÊÊÊÊÊe.printStackTrace ÊÊÊÊÊÊÊÊÊÊÊÊthrow e ÊÊÊÊÊÊÊÊ ÊÊÊÊ ÊÊÊÊ ÊÊÊÊprivate InputStream getStream ÊÊÊÊÊÊÊÊint size 100 1024 1024 ÊÊÊÊÊÊÊÊreturn new RandomInputStream 0 size Integer.MAX VALUE ÊÊÊÊ I have added the following javadoc to the DbDataStore For Microsoft SQL Server 2005 there is a problem reading large BLOBs. You will need to use the JDBC driver version 1.2 or newer and append responseBuffering adaptive to the database URL. Don t append selectMethod cursor otherwise it will still run out of memory. Example database URL jdbc sqlserver localhost 4220 DatabaseName test responseBuffering adaptive Hi. I upgraded to version 1.2 of the driver and added responseBuffering adaptive to my URL but now I get the following error java.lang.OutOfMemoryError Java heap space at com.microsoft.sqlserver.jdbc.TDSPacket. init Unknown Source at com.microsoft.sqlserver.jdbc.TDSReader.readPacket Unknown Source at com.microsoft.sqlserver.jdbc.TDSReader.readPacket Unknown Source at com.microsoft.sqlserver.jdbc.TDSReader.readResponse Unknown Source at com.microsoft.sqlserver.jdbc.TDSCommand.detach Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerConnection.executeCommand Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerStatement.executeCommand Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerStatement.executeStatement Unknown Source at com.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.execute Unknown Source at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmtInternal ConnectionRecoveryManager.java 362 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmtInternal ConnectionRecoveryManager.java 292 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmt ConnectionRecoveryManager.java 257 at org.apache.jackrabbit.core.persistence.bundle.util.ConnectionRecoveryManager.executeStmt ConnectionRecoveryManager.java 237 at org.apache.jackrabbit.core.data.db.DbDataStore.getRecord DbDataStore.java 457 at org.apache.jackrabbit.core.value.BLOBInDataStore.getDataRecord BLOBInDataStore.java 129 at org.apache.jackrabbit.core.value.BLOBInDataStore.getLength BLOBInDataStore.java 85 at org.apache.jackrabbit.core.persistence.util.Serializer.serialize Serializer.java 201 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 476 at org.apache.jackrabbit.core.persistence.AbstractPersistenceManager.store AbstractPersistenceManager.java 75 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 282 at org.apache.jackrabbit.core.state.SharedItemStateManager Update.end SharedItemStateManager.java 695 at org.apache.jackrabbit.core.state.SharedItemStateManager.update SharedItemStateManager.java 864 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 324 at org.apache.jackrabbit.core.state.XAItemStateManager.update XAItemStateManager.java 313 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 300 at org.apache.jackrabbit.core.state.SessionItemStateManager.update SessionItemStateManager.java 306 at org.apache.jackrabbit.core.ItemImpl.save ItemImpl.java 1244 at org.apache.jackrabbit.core.SessionImpl.save SessionImpl.java 897 at org.apache.jackrabbit.core.data.BigBinaryTest.testBigBinary BigBinaryTest.java 17 at sun.reflect.NativeMethodAccessorImpl.invoke0 Native Method at sun.reflect.NativeMethodAccessorImpl.invoke NativeMethodAccessorImpl.java 39 at sun.reflect.DelegatingMethodAccessorImpl.invoke DelegatingMethodAccessorImpl.java 25 Note that I m using a database server not my local machine. Adding -Xms200m -Xmx200m seems to solve this problem.Hi I got this problem when using the old driver in this case the property is silently ignored. What version of MS SQL Server and JDBC driver do you use What is the exact database URL Maybe the wrong driver is in the classpath. Could you set the log level to info for org.apache.jackrabbit.core.persistence.bundle.util In this case the database and driver versions are logged see ConnectionRecoveryManager line 336 .From jcr.log main ConnectionRecoveryManager Database Microsoft SQL Server 9.00.1399 ConnectionRecoveryManager.java line 336 main ConnectionRecoveryManager Driver Microsoft SQL Server 2005 JDBC Driver 1.2.2828.100 ConnectionRecoveryManager.java line 337 main DbDataStore Using JDBC driver Microsoft SQL Server 2005 JDBC Driver 1.2.2828.100 DbDataStore.java line 485 My URL jdbc sqlserver et 1433 databaseName repotest responseBuffering adaptive Hi Esteban Could you please run this test and post the result My results are url jdbc sqlserver localhost 4220 DatabaseName test responseBuffering adaptive meta.url jdbc sqlserver localhost 4220 responseBuffering adaptive encrypt false ÊÊÊdatabaseName test selectMethod direct trustServerCertificate false ÊÊÊlastUpdateCount true name Microsoft SQL Server version 9.00.1399 driver name Microsoft SQL Server 2005 JDBC Driver driver version 1.2.2828.100 storing data... selecting data... length 104857600 expected 104857600 reading data... done Here are my results. url jdbc sqlserver et 1433 databaseName repotest responseBuffering adaptive meta.url jdbc sqlserver et 1433 responseBuffering adaptive encrypt false databaseName repotest selectMethod direct trustServerCertificate false lastUpdateCount true name Microsoft SQL Server version 9.00.1399 driver name Microsoft SQL Server 2005 JDBC Driver driver version 1.2.2828.100 storing data... selecting data... length 104857600 expected 104857600 reading data... done Hello Esteban So this test works for you as well. It is the same mechanism as the database data store uses... So maybe there are other components in the system that use a lot of memory Is it possible to find out what uses so much memory Usually I use the YourKit Java Profiler not sure if you know it and if you can use it in your environment. Regards ThomasHi Thomas. My guess is that there is some overhead somewhere but it s strange that using the same test we get different results. I m using the FGLS so I ll try with the default. I do know YJP but never used it before. Still I ll see if I can run it. Do you have any advice on how to profile Jackrabbit Regards.I m just reporting that I run BigBinaryTest with the default ISM locking and it failed. Back to profilers I have a license of JProfiler here so I ll see which one is easier. Still I think that adding some advice to the site wiki on how to profile Jackrabbit would be useful. Regards.
