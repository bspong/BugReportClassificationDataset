DocViewSaxEventGenerator may generate non-NS-wellformed XML
The XML serialization code relies on the fact that all required prefix-to-uri mappings are known beforehand actually when serializing the root node . So there s an assumption that the permanent namespace registry will never change during serialization which may be incorrect when another client adds namespace registrations while the XML export is in progress. To fix this addNamespacePrefixes should ensure that namespace declarations have been written for all prefixes used on the current node node name properties potentially going back to the namespace resolver when needed. Should there be consensus for that change I m happy to give it a try Good point. The spec requires the relevant mappings to be included in the top-most XML element but in this case concurrent introduction of new namespaces I think it s better to include extra namespaces as local xmlns settings than to skip the elements or to use unknown prefixes. I see two ways to fix this. One is the straightforward solution you mentioned of adding missing namespace mappings on the fly and the other would be to block all changes to the namespace registry while an XML export is in progress. Should there be consensus for that change I m happy to give it a try Please do patches are very much welcome - Proposed patch serializer remembers previously written namespace declarations and adds new ones when needed . Related to this ExportDocViewTest.compareNamespaces makes the assumption that all registered namespaces need to be serialized in the root element and refers to 6.4.2.1 as justification . However 6.4.2.1 only talks about the relevant declarations. In any case both the requirement in the spec and the test case should be relaxed to permit any serialization that produces a valid XML document it should be left to the implementation when and where to include namespace declarations as long as they the result document is namespace-wellformed. Patch applied revision 439854. Thanks 
