make NamespaceContext getPrefix java.lang.String iterative instead of recursive
Currently the method org.apache.jackrabbit.core.xml.NamespaceContext getPrefix java.lang.String uses recursion. For very large XML files 50 MB Magnolia website exports this causes a stack overflow. The method can easily be rewritten using iteration.patch to rewrite methodpatched classA patch and the new class are attached.I got the StackOverflowError too while trying to import large xml files with jackrabbit 1.4.5 java.lang.StackOverflowError at java.util.HashMap.get HashMap.java 305 at org.apache.jackrabbit.core.xml.NamespaceContext.getURI NamespaceContext.java 93 at org.apache.jackrabbit.core.xml.NamespaceContext.getURI NamespaceContext.java 97 at org.apache.jackrabbit.core.xml.NamespaceContext.getURI NamespaceContext.java 97 ... looks pretty much a bug than an improvement...In order to successfully import s large xml file I had to patch bot getPrefix and getURI using iteration as suggested by Philippe no other way to make jackrabbit handle it... Can I suggest to change this improvement to a bug Unable to import large xml files new patch covering both getUri and getPrefix . Note I tried creating a testcase to reproduce the issue but looks like there that the number of recursions allowed can be very different due to the environment or other factor. On a testcase I had to create an xml system with with about 5000 nested nodes while on a real case I saw it crashing after few hundreds of nested nodes. What on earth are you doing with 5000 levels of nested elements Even a few hundred nestings with two elements per every ten or so levels creates a document that won t fit any normal hard drives Since there s already a patch and apparently an existing use case I guess I should apply the fix but I would certainly not recommend dealing with so deep document structures. I just don t see how or where such a structure would make sense.Patch applied in revision 680135.thanks Jukka What on earth are you doing with 5000 levels of nested elements well as said that is what I got when trying to create a simple testcase in order to reproduce the problem but in a real case I can successfully reproduce it with a 100MB system view file with only just checked approximatively 30-40 levels of nesting... probably the problem is triggered by some other factors I couldn t reproduce in a test Are you sure the problem you were seeing was a stack overflow and not an out of memory condition Currently Jackrabbit keeps the entire import in memory in a format that s even more memory-intensive than DOM before persisting the changes.I am absolutely positive that it was a stack overflow - the exception was java.lang.StackOverflowError - there was a stack trace in the log that was more than a dozen screens recursively in org.apache.jackrabbit.core.xml.NamespaceContext.getURII also can confirm it definitively was a StackOverflow and that with the patch without changing any other setting I am able to successfully import the file. The stack overflows on NamespaceContext should really only be caused by excessively nested XML elements at least hundredths probably thousands of levels of nesting . If this happens on documents with less than 100 levels of nesting then I suspect that there s something else wrong with the code like the NamespaceContext stack not being correctly rewound. I tried reviewing the related code but couldn t find any obvious errors. Could you perhaps send me a troublesome XML document or come up with a cleaned up example that illustrates the problem It s not high priority as it seems like the issue is already solved by the patch but I d rather verify that we actually fixed the root cause instead of just working around it.Any chance we could get the patch in the 1.4 branch I attached a file that should produce a large stack in NamespaceContext.getUR. It might or might not cause a stack overflow on your system.Based on demand I merged this to the 1.4 branch in revision 682313. The fix will be included in jackrabbit-core 1.4.6. Thanks for the example XML file I tried importing it with jackrabbit-core 1.4.1 but the tallest NamespaceContext stack I saw was just 13 levels deep i.e. nowhere near to cause a stack overflow unless your application already is way too close to the stack limit.Thanks for the merge 
