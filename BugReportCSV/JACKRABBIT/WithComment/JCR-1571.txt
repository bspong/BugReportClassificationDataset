DavMethodBase getResponseException fails if the body is not valid XML
I have a set up that uses the JCR Webdav Server from a custom remote client. I ve noticed one thing anytime I request a node that doesn t exist the error that comes back from the server is as follows Fatal Error 1 941 The element type HR must be terminated by the matching end-tag HR . javax.jcr.RepositoryException The element type HR must be terminated by the matching end-tag HR . The element type HR must be terminated by the matching end-tag HR . Doesn t really make sense but that is OK I can handle that. My problem I have a partially populated repository that at the root has a few nodes like edu .... com ibm .. So I want to create a few nodes of type nt folder under com myCompany folder1 I have no problem creating them but since com already exists I end up with com 2 myCompany folder1. So I went ahead and used the parentNode.hasNode folderName method. This method returns true for the com portion but when I test for the myCompany folder which should return false I get the error response shown above from the server. The webdav request looks as follows PROPFIND jackrabbit server default jcr 3aroot com myCompany The snippet of code looks as follows   private Node createFolders Session session Node parentNode List String folders throws RepositoryException     Node folderNode null     for String folder folders if parentNode.hasNode folder folderNode parentNode.getNode folder else folderNode parentNode.addNode folder nt folder parentNode folderNode          session.save     return folderNode    julio could you attach the http-conversion that would make it easier for me to track the problem. thanks in advance angelaAngela attached are the excerpts of 2 PROPFIND http requests first one searching for the node com which it finds and the second one searching for the node com myCompany which will not find because it doesn t exist. Let me know if you need more information. juliohi julio first of all i don t think that the HR is sent by the JCR-server. i quickly tried it out having the attached test cases test 1 creating a myTest node - save - new session - parent.hasNode should return true test 2 same as 1 by trying parent.hasNode without the node being created before. both work for me as expected... did i misunderstand your test please let me know. test 1 log C-2- 022602 - PROPFIND mytest server default jcr 3aroot testroot myTest HTTP 1.1 C-2- 022671 - Depth 1 C-2- 022681 - Authorization Basic YWRtaW46YWRtaW4 C-2- 022720 - User-Agent Jakarta Commons-HttpClient 3.0 C-2- 022764 - Host localhost 5502 C-2- 022786 - Content-Length 599 C-2- 022807 - Content-Type text xml charset UTF-8 C-2- 022846 - C-2- 022848 - xml version 1.0 encoding UTF-8 C-2- 022887 - D propfind xmlns D DAV D prop dcr name xmlns dcr http www.day.com jcr webdav 1.0 dcr referen ces xmlns dcr http www.day.com jcr C-2- 023028 - webdav 1.0 dcr index xmlns dcr http www.day.com jcr webdav 1.0 dcr path xmlns dcr http www.d ay.com jcr webdav 1.0 dcr mixinnod C-2- 023169 - etypes xmlns dcr http www.day.com jcr webdav 1.0 dcr parent xmlns dcr http www.day.com jcr webd av 1.0 dcr primarynodetype xmlns d C-2- 023310 - cr http www.day.com jcr webdav 1.0 D resourcetype dcr uuid xmlns dcr http www.day.com jcr web dav 1.0 D prop D propfind S-2- 117910 - HTTP 1.1 207 Code 207 ... test 2 log C-0- 013648 - PROPFIND mytest server default jcr 3aroot testroot myTest HTTP 1.1 C-0- 013717 - Depth 1 C-0- 013727 - Authorization Basic YW5vbnltb3VzOg C-0- 013766 - User-Agent Jakarta Commons-HttpClient 3.0 C-0- 013810 - Host localhost 5502 C-0- 013832 - Content-Length 599 C-0- 013853 - Content-Type text xml charset UTF-8 C-0- 013892 - C-0- 013894 - xml version 1.0 encoding UTF-8 C-0- 013933 - D propfind xmlns D DAV D prop dcr name xmlns dcr http www.day.com jcr webdav 1.0 dcr referen ces xmlns dcr http www.day.com jcr C-0- 014074 - webdav 1.0 dcr index xmlns dcr http www.day.com jcr webdav 1.0 dcr path xmlns dcr http www.d ay.com jcr webdav 1.0 dcr mixinnod C-0- 014215 - etypes xmlns dcr http www.day.com jcr webdav 1.0 dcr parent xmlns dcr http www.day.com jcr webd av 1.0 dcr primarynodetype xmlns d C-0- 014356 - cr http www.day.com jcr webdav 1.0 D resourcetype dcr uuid xmlns dcr http www.day.com jcr web dav 1.0 D prop D propfind S-0- 077856 - HTTP 1.1 404 Not Found S-0- 077880 - Host localhost 4302 S-0- 077902 - Connection Close S-0- 077921 - Server Communique Servlet Engine 4.0.2 S-0- 077962 - Content-Type text html S-0- 077987 - Date Thu 08 May 2008 08 26 54 GMT S-0- 078024 - Transfer-Encoding chunked S-0- 078052 - S-0- 078054 - 65 S-0- 078058 - html head title S-0- 078079 - 404 S-0- 078084 - S-0- 078087 - Not Found S-0- 078098 - title head body h1 S-0- 078125 - Not Found S-0- 078136 - h1 S-0- 078143 - body html S-0- 078159 - S-0- 078161 - 0 S-0- 078164 - S-0-Finished 78166 bytes 3.0 kb s C-0-Finished 14493 bytes 0.0 kb s testcases my understanding of the problem description .What happens here is that the servlet container generates an error page for the 404 status and sends it out as text html. The client component seems to try to parse it as XML which of course fails. Angela Yes that is the process to reproduce the problem test on a node that doesn t yet exist -BTW I created my repository by using the Populate link in the default Jackrabbit deployment of the war file. I don t know if the comment from Julian Reschle is sufficient to isolate it. These are some notes on your log and mine - I do see HR tags in the response from the server - The version of the http client you are using is different from mine I m running 3.1 -although I don t think this is the problem - You are using a different version of the servlet container I am using Tomcat Let me know if you need more information from me. Thanks julio I created my repository by using the Populate link in the default Jackrabbit deployment of the war file. that s fine an probably does something similar as my manual test I don t know if the comment from Julian Reschle is sufficient to isolate it. i guess it is. These are some notes on your log and mine - I do see HR tags in the response from the server yes. but i m quite sure that they are not generated by the webdav servlet. - The version of the http client you are using is different from mine I m running 3.1 -although I don t think this is the problem nor do i. httpclient 3.0 is the version used with the spi2dav project. - You are using a different version of the servlet container I am usingTomcat yes. and i assume that it is tomcat that generates the html error page... and i assume that there is a way to turn that off as it should be possible to configure a custom error page. can you try that angela yes. and i assume that it is tomcat that generates the html error page... and i assume that there is a way to turn that off as it should be possible to configure a custom error page. can you try that Wait. It s perfectly ok for a server to send a text html response body with a 404 status. The client really needs to be able to deal with that if there is a simple way to disable the HTML which the servlet did not generate i don t want to spent a lot of time extracting the original response body created by the servlet. it s a sandbox project... talked to Angela on the phone summarizing - for a non-success code it s ok for the server to return text html - in Angela s case see trace this did not cause problems as the response body appears to be wellformed XML anyway although HTML - the code that handles responses and tries to extract error details should handle this case as non-fatal there s simply no information in addition to the HTTP status code available without having built julios case on my checkout i think the problem is caused by DavMethodBase getResponseException which did not handle exceptions upon parsing xml the response body. i created a patch for that and a dumb test. julio if you had time to try if that solves the problem it would be very helpful. thanks in advance angelaAngela I updated my entire sandbox tree and tried to rebuild jackrabbit-spi-spi2dav-1.5-SNAPSHOT.jar file but the build failed this time around had worked for me all the time before    c svn jackrabbit sandbox spi mvn install ERROR BUILD FAILURE INFO INFO Compilation failure C svn jackrabbit sandbox spi spi2dav src main java org apache jackrabbit sp i2dav RepositoryServiceImpl.java 190 7 org.apache.jackrabbit.spi2dav.RepositoryServiceImpl is not abstract and does not override abstract method exists org.apache.jackrabbit.spi.SessionInfo org.apache.jackrabbit.spi.ItemI d in org.apache.jackrabbit.spi.RepositoryService Angela I suppose this is the tree you wanted me to test I did see a few changes coming in on the main trunk but I haven t been building anything on the main trunk I just pick up the latest jar files released . Let me know. Thanks julio I updated my entire sandbox tree you have to update jackrabbit trunk as well. first we got rid of some unused repository-service methods second the fix for this issue affects the jackrabbit-webdav project and not the spi2dav sandbox project. angelaAngela I rebuilt jackrabbit-webdav from the main trunk refreshed today -1.5-SNAPSHOT.jar and deployed in my tomcat webapp lib directory for jackrabbit but unfortunately the behavior is still the same. This time I debugged the client further as I understood the comment about the XML response. The client as it stands right now org.apache.jackrabbit.webdav.client.methods.DaveMethodBase getResponseBodyA sDocument 118 still expects a response in XML format fails while trying to parse an HTML document -the HR tag is not terminated . This method is called on failure too by getResponseException . The server side with the new webdav jar file sends an HTML document with the 404 Not Found response. I captured the response again see is below. Please also note the Content-Type is html rather than xml. HTTP 1.1 404 Not Found Server Apache-Coyote 1.1 Content-Type text html charset utf-8 Content-Length 952 Date Tue 13 May 2008 18 08 40 GMT html head title Apache Tomcat 6.0.16 - Error report title style H1 font-family Tahoma Arial sans-serif color white background-color 525D76 fo nt-size 22px H2 font-family Tahoma Arial sans-serif color white background-color 525D76 fo nt-size 16px H3 font-family Tahoma Arial sans-serif color white background-color 525D76 fo nt-size 14px BODY font-family Tahoma Arial sans-serif color black background-color white B font-family Tahoma Arial sans-serif color white background-color 525D76 P font-family Tahoma Arial sans-serif background white color black font-size 12px A color black A.name color black HR color 525D76 style head body h1 HTTP Status 404 - h1 HR size 1 noshade noshade p b type b Status report p p b message b u u p p b description b u The requested resource is not available. u p HR size 1 noshade noshade h3 Apache Tomcat 6.0.16 h3 body html I just checked the svn log file for the jackrabbit-webdav directory and noticed that the last check-in was on March 5th. So I m guessing I m picking the wrong tree Thanks julio i didn t commit it yet but attached a patch. angelafix at revision 656685 installed tomcat and executed some basic tests where the response body is invalid xml it was a 500 response instead of 404 but parsing failed with the same message . i concluded that the fix works as expected Thank you Angela. The fix works. Thanks again for your great work. julio
