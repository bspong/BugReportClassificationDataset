DBDataStore doesn t support concurrent reads
My understanding is that setting parameter copyWhenReading to true should allow concurrent reads by spooling binary property to temporary file and free database resources connection immediately to make it available for other threads. After applying patch for JCR-1388 DBDataStore doesn t support concurrent reads anymore resultSet is kept open and db connection is blocked until the stream is read and closed. When copyWhenReading is set to true db connection should be released immediately this is the reason i guess why temporary file is used.Without setting copyWhenReading to true usage of DBDataStore is dangerous could be a bottleneck depending how long streams are kept open. If streams are not closed DBDataStore hangs locks.without doing major changes I suggest to change DBDataStore class as follow Index src main java org apache jackrabbit core data db DbDataStore.java src main java org apache jackrabbit core data db DbDataStore.java revision 706573 src main java org apache jackrabbit core data db DbDataStore.java working copy -519 6 519 9                  if copyWhenReading                      File temp moveToTempFile result                      result new TempFileInputStream temp DatabaseHelper.closeSilently rs putBack conn rs null                                 and DbResources.java close method to do not free db resources twice     public void close         if closed             closed true             if rs null               DatabaseHelper.closeSilently rs               try                 store.putBack conn                catch Exception e                 log.info Closing DbResources e                                           Is it ok Hi You are right this part of the code doesn t do any more what it s supposed to do. There is another problem it doesn t work if the stream is null. Also some of the DbResources methods are not not used and should be removed. I am currently working on another patch I will attach it in an hour or so to this bug. Thanks for finding this problem Regards ThomasHere is my first patch. I didn t test it yet I post it just so that others can have a look at it.Cannot see important 2 lines responsible for freeing resources in copyWhenReading block if copyWhenReading     File temp moveToTempFile result     result new TempFileInputStream temp    DatabaseHelper.closeSilently rs    putBack conn     dbResources new DbResources result I do not follow changes in DbInputStream class but I assume they are not so important.i would also prefer to use the closeSilently Method from the DatabaseHelper instead of ConnectionRecoveryManager so we can delete the Method in the ConnectionRecoveryManagerNew patch I still didn t test it however . DbResources should be renamed to DbResource I will do that later.Instead of tweaking the copyWhenReading workaround which disables one of the main benefits of the data store i.e. the ability to access a binary property without intermediate copies being created I d simply remove the maxConnections limit from the connection pool.Committed in revision 708598.
