XML serialization in JDK 1.4 broken mostly for WebDAV 
WebDAV uses XmlRequestEntity for serializing XML which in turn uses org.apache.jackrabbit.commons.xml.SerializingContentHandler to work around the JDK 1.4 problem serializing in absence of explicit namespace declarations . The following test fails under JDK 1.4 but passed with newer JDKs     public void testXmlSerialization throws ParserConfigurationException IOException SAXException                  DocumentBuilderFactory dbf DocumentBuilderFactory.newInstance         dbf.setNamespaceAware true         DocumentBuilder db dbf.newDocumentBuilder                  Document doc db.newDocument         doc.appendChild doc.createElementNS DAV propfind                  XmlRequestEntity xmlent new XmlRequestEntity doc         ByteArrayOutputStream bos new ByteArrayOutputStream         xmlent.writeRequest bos                  Document doc2 db.parse new ByteArrayInputStream bos.toByteArray         Element docelem doc2.getDocumentElement         assertEquals DAV docelem.getNamespaceURI      It appears that serializing a DOM will not cause startPrefixMapping to be called causing the JDK 1.4 workaround never to be invoked. Yep you re right. I have a draft patch that looks at the namespaces used in the element name and attributes passed to startElement and automatically calls startPrefixMapping for any namespaces that have not yet been declared. This workaround seems to work on 1.4 but I m getting increasingly worried about the extra stuff we re layering on XML serialization. On the other hand I guess it s still better than having the explicit Xerces dependency.Yes. As far as I can tell 1.4 is nearing end of life anyway see http java.sun.com j2se 1.4.2 gt . So maybe we should just park this one and see that we can accelerate getting rid of the requrement to support 1.4. Related to this the way SerializingContentHandler.getSerializer currently works seems to cause the probe happening upon each invocation which seems to be a very expensive thing to do. As the outcome of the probe only depends on the VM loaded classes maybe the result should be held in a static variable Updated the title and other settings to indicate that the root cause should be fixed in jackrabbit-jcr-commons. We only hit this issue in WebDAV since that s the only place where we serialize from DOM instead of directly calling the SAX methods. I d like to get this fixed for 1.5 as this issue breaks the webdav build in Java 1.4.Fixed in revision 720492.
