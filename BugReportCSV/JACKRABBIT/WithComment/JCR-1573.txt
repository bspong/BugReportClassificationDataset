Lucene Query Exception attempt to access a deleted document 
Hi I am getting an exception when trying to execute a query through the Spring JcrTemplate class....using the following code QueryManager qMgr session.getWorkspace .getQueryManager QueryResult result qMgr.createQuery xpathQuery Query.XPATH .execute The exception is thrown at the second line and is as follows DEBUG 0x9 at org.apache.lucene.search.IndexSearcher.search IndexSearcher.java 113 n DEBUG 0x9 at org.apache.lucene.search.Hits.getMoreDocs Hits.java 74 n DEBUG 0x9 at org.apache.lucene.search.Hits. lt init Hits.java 53 n DEBUG 0x9 at org.apache.lucene.search.Searcher.search Searcher.java 46 n DEBUG 0x9 at org.apache.lucene.search.Searcher.search Searcher.java 38 n DEBUG 0x9 at org.apache.jackrabbit.core.query.lucene.SearchIndex.executeQuery SearchIndex.java 660 n DEBUG 0x9 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.executeQuery QueryResultImpl.java 242 n DEBUG 0x9 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.getResults QueryResultImpl.java 290 n DEBUG 0x9 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl. lt init QueryResultImpl.java 192 n DEBUG 0x9 at org.apache.jackrabbit.core.query.lucene.QueryImpl.execute QueryImpl.java 138 n DEBUG 0x9 at org.apache.jackrabbit.core.query.QueryImpl.execute QueryImpl.java 176 n DEBUG 0x9 at com.intel.cds.cr.jcr.JcrManager 5.doInJcr JcrManager.java 363 n DEBUG 0x9 at org.springmodules.jcr.JcrTemplate.execute JcrTemplate.java 76 n DEBUG 0x9 at org.springmodules.jcr.JcrTemplate.execute JcrTemplate.java 108 n DEBUG 0x9 ... 19 more n DEBUG Exception detail soapenv Fault soapenv Body soapenv Envelope org.apache.axis2.AxisFault attempt to access a deleted document at org.apache.axis2.util.Utils.getInboundFaultFromMessageContext Utils.java 486 at org.apache.axis2.description.OutInAxisOperationClient.handleResponse OutInAxisOperation.java 343 at org.apache.axis2.description.OutInAxisOperationClient.send OutInAxisOperation.java 389 at org.apache.axis2.description.OutInAxisOperationClient.executeImpl OutInAxisOperation.java 211 at org.apache.axis2.client.OperationClient.execute OperationClient.java 163 My Jackrabbit Lucene configuration is as follows SearchIndex class org.apache.jackrabbit.core.query.lucene.SearchIndex          param name path value rep.home repository index                   param name useCompoundFile value false          param name mergeFactor value 5          param name cacheSize value 10000          param name respectDocumentOrder value false    SearchIndex Is this a configuration issue or a bug Thanks David.Can you please post the complete configuration and the workspace.xml of the workspace your are using What Lucene version are you using Hi Marcel I ve attached my Jackrabbit configuration file. My Lucene version is 2.2.0 and Jackrabbit core 1.4.2. Please let me know if you need any more information. Thanks David. The only thing I noticed while quickly looking through the repository.xml is the hardcoded url for the workspace persistence manager. The url should usually include the wsp.home or wsp.name parameter. Can you please check if the issue also occurs with a default configuration Thanks.The hardcoded url for the persistence manager points to a specific jdbc database location where all the content is stored i.e. param name url value jdbc postgresql localhost crs xml repo I will try the default configuration again but as I only increased some of the default values to improve the performance and scalability then I doubt that this is the problem. Thanks David.Hi Marcel I have used the default configuration but I am still getting this error. Here is a snippet of my jackrabbit debug logs when the error occurs. Does anything here seem strange to you DEBUG http-8080-1 org.springmodules.jcr.SessionFactoryUtils - Opening JCR Session DEBUG http-8080-1 org.apache.jackrabbit.core.state.MLRUItemStateCache - org.apache.jackrabbit.core.state.MLRUItemStateCache 1cdfd19 size 1 1864 4194304 DEBUG http-8080-1 org.apache.jackrabbit.core.state.MLRUItemStateCache - org.apache.jackrabbit.core.state.MLRUItemStateCache 1cdfd19 size 1 1864 4194304 DEBUG http-8080-1 org.apache.jackrabbit.core.state.MLRUItemStateCache - org.apache.jackrabbit.core.state.MLRUItemStateCache 18f7701 size 1 1264 4194304 DEBUG http-8080-1 org.apache.jackrabbit.core.state.MLRUItemStateCache - org.apache.jackrabbit.core.state.MLRUItemStateCache 18f7701 size 1 1264 4194304 DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - created item cafebabe-cafe-babe-cafe-babecafebabe DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - created item cafebabe-cafe-babe-cafe-babecafebabe DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - caching item cafebabe-cafe-babe-cafe-babecafebabe DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - caching item cafebabe-cafe-babe-cafe-babecafebabe DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.QueryImpl - Executing query Root node Select properties    PathQueryNode      LocationStepQueryNode NodeTest http release2.iclassproject.com task Descendants true Index NONE DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.QueryImpl - Executing query Root node Select properties    PathQueryNode      LocationStepQueryNode NodeTest http release2.iclassproject.com task Descendants true Index NONE DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.QueryResultImpl - getResults 2147483647 DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.QueryResultImpl - getResults 2147483647 DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.AbstractIndex - closing IndexWriter. DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.AbstractIndex - closing IndexWriter. DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.AbstractIndex - closing IndexWriter. DEBUG http-8080-1 org.apache.jackrabbit.core.query.lucene.AbstractIndex - closing IndexWriter. DEBUG http-8080-1 org.springmodules.jcr.SessionFactoryUtils - Closing JCR Session DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - invalidated item cafebabe-cafe-babe-cafe-babecafebabe DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - invalidated item cafebabe-cafe-babe-cafe-babecafebabe DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - removing item cafebabe-cafe-babe-cafe-babecafebabe from cache DEBUG http-8080-1 org.apache.jackrabbit.core.ItemManager - removing item cafebabe-cafe-babe-cafe-babecafebabe from cache ... DEBUG http-8080-1 org.apache.axis2.transport.http.AxisServlet - org.apache.axis2.AxisFault attempt to access a deleted document Also I think it might have something to do with my approach for updated entries. Here is my code from my update method Node root session.getRootNode Node node root.getNode parentNode uuid ownerId String ownerType node.getProperty CRSConstants.ownerTypeProperty .getString node.checkout NodeIterator iter node.getNodes remove existing child nodes before adding new node... is there a better to do this while iter.hasNext Node iter.next .remove try session.importXML parentNode uuid ownerId ip ImportUUIDBehavior.IMPORT UUID CREATE NEW catch IOException e logger.error Error thrown while importing xml e node.setProperty CRSConstants.ownerTypeProperty ownerType session.save node.checkin Any thoughts on this Thanks David.Hi I m experiencing the same issue with Jackrabbit 1.4. I call      QueryManager qm session.getWorkspace .getQueryManager      Query query qm.createQuery searchTerm Query.XPATH      QueryResult result query.execute And get the exception      java.lang.IllegalArgumentException attempt to access a deleted document      at org.apache.lucene.index.SegmentReader.document SegmentReader.java 331      at org.apache.lucene.index.FilterIndexReader.document FilterIndexReader.java 130      at org.apache.lucene.index.IndexReader.document IndexReader.java 437      at org.apache.jackrabbit.core.query.lucene.CachingIndexReader.getParent CachingIndexReader.java 107      at org.apache.jackrabbit.core.query.lucene.SharedIndexReader.getParent SharedIndexReader.java 78      at org.apache.jackrabbit.core.query.lucene.ReadOnlyIndexReader.getParent ReadOnlyIndexReader.java 141      at org.apache.jackrabbit.core.query.lucene.CachingMultiIndexReader.getParentDocId CachingMultiIndexReader.java 112      at org.apache.jackrabbit.core.query.lucene.SearchIndex CombinedIndexReader.getParent SearchIndex.java 1202      at org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer.isValid DescendantSelfAxisQuery.java 347      at org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer.next DescendantSelfAxisQuery.java 261      at org.apache.lucene.search.Scorer.score Scorer.java 48      at org.apache.jackrabbit.core.query.lucene.ChildAxisQuery ChildAxisScorer.calculateChildren ChildAxisQuery.java 317      at org.apache.jackrabbit.core.query.lucene.ChildAxisQuery ChildAxisScorer.next ChildAxisQuery.java 268      at org.apache.lucene.search.Scorer.score Scorer.java 48      at org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer.collectContextHits DescendantSelfAxisQuery.java 305      at org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer.next DescendantSelfAxisQuery.java 254      at org.apache.lucene.search.Scorer.score Scorer.java 48      at org.apache.lucene.search.IndexSearcher.search IndexSearcher.java 146      at org.apache.lucene.search.IndexSearcher.search IndexSearcher.java 113      at org.apache.lucene.search.Hits.getMoreDocs Hits.java 74      at org.apache.lucene.search.Hits. init Hits.java 53      at org.apache.lucene.search.Searcher.search Searcher.java 46      at org.apache.lucene.search.Searcher.search Searcher.java 38      at org.apache.jackrabbit.core.query.lucene.SearchIndex.executeQuery SearchIndex.java 660      at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.executeQuery QueryResultImpl.java 242      at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.getResults QueryResultImpl.java 290      at org.apache.jackrabbit.core.query.lucene.QueryResultImpl. init QueryResultImpl.java 192      at org.apache.jackrabbit.core.query.lucene.QueryImpl.execute QueryImpl.java 138      at org.apache.jackrabbit.core.query.QueryImpl.execute QueryImpl.java 176      at org.apache.jackrabbit.rmi.server.ServerQuery.execute ServerQuery.java 58      at sun.reflect.NativeMethodAccessorImpl.invoke0 Native Method      at sun.reflect.NativeMethodAccessorImpl.invoke NativeMethodAccessorImpl.java 39      at sun.reflect.DelegatingMethodAccessorImpl.invoke DelegatingMethodAccessorImpl.java 25      at java.lang.reflect.Method.invoke Method.java 585      at sun.rmi.server.UnicastServerRef.dispatch UnicastServerRef.java 294      at sun.rmi.transport.Transport 1.run Transport.java 153      at java.security.AccessController.doPrivileged Native Method      at sun.rmi.transport.Transport.serviceCall Transport.java 149      at sun.rmi.transport.tcp.TCPTransport.handleMessages TCPTransport.java 466      at sun.rmi.transport.tcp.TCPTransport ConnectionHandler.run TCPTransport.java 707      at java.lang.Thread.run Thread.java 595      at sun.rmi.transport.StreamRemoteCall.exceptionReceivedFromServer StreamRemoteCall.java 247      at sun.rmi.transport.StreamRemoteCall.executeCall StreamRemoteCall.java 223      at sun.rmi.server.UnicastRef.invoke UnicastRef.java 126      at org.apache.jackrabbit.rmi.server.ServerQuery Stub.execute Unknown Source      at org.apache.jackrabbit.rmi.client.ClientQuery.execute ClientQuery.java 63 This is a strange one because my system deletes documents that have expired on a regular basis and until recently this has not been a problem. I have recently updated to 1.4 from 1.3. but actually it s been working fine with 1.4 for some time now as well - this is the first time I ve experienced this problem. As far as I m aware I m using a completely standard workspace.xml i.e. no changes to persistence manager etc .David can you please check that you are using lucene 2.2.0 Jackrabbit currently does not work with lucene versions 2.3.xHi Marcel Yes I converted back to Lucene 2.2.0 and used the default Jackrabbit configurations. The problem still remained so I did some more testing. I discovered that the problem was occurring during my update process... here I would remove a particular node and then replace it with the updated version by importing the XML. It seems the lucene index did not pick up this remove import action and then when a query was performed it would try to retrieve the removed node... therefore throwing the exception. I resolved this by adding my this extra line after my update process node.update session.getWorkspace .getName This seemed to update the index and the exception has not re-occurred. I m guessing there probably is a better way to perform updates but it was not obvious to me from the documentation available. Anyway thanks for your help. Best regards David. node.update session.getWorkspace .getName if that node is in the workspace which is returned by session.getWorkspace .getName then this is actually a no-op. There must be something else you changed which made the indexing work again correctly. Are you sure that reverting back to Lucene 2.2 did not resolve the issue You probably also have to re-index your workspaces because Lucene is not able to read index files from a newer version.My initial thought was that it did not have a positive affect but perhaps you are right that this issue was resolved with the Lucene version change to 2.2.0. I ll let you know if I have any other similar problems. Many thanks David.Hello everyone i am having the same problem. The problem started showing up when I started to delete subnodes in a node that I wanted to update with new subnodes. Has anyone found a solution to this Do I have to update the lucene search index manually or something Wolfgang David while going though this issue again I noticed that the query configuration you posted might be incorrect. Can you please confirm that the XML fragment you posted is only for the repository wide index the one at the very end in repository.xml and not from a workspace.xml In a workspace.xml file a search index configuration should rather look like this          SearchIndex class org.apache.jackrabbit.core.query.lucene.SearchIndex              param name path value wsp.home index          SearchIndex yours had rep.home repository index for the path parameter. Wolfgang please check your repository.xml and workspace.xml files as well and make sure you are using Lucene 2.2 Thanks for your feedback.Hi everyone I m having the same problem while searching for nodes with xPath in my Junit4 test case. In this test I add some node to the repository-tree and then search with this xPath query           catalog books then after each test in After methods I provide to clean the repository tree and then saving session.          After public void tearDownTest try session.getRootNode .getNode catalog .remove session.save catch RepositoryException e e.printStackTrace The first time during creation of repository everything gones ok. But at the next run i get this exception java.lang.IllegalArgumentException attempt to access a deleted document at org.apache.lucene.index.SegmentReader.document SegmentReader.java 331 at org.apache.lucene.index.FilterIndexReader.document FilterIndexReader.java 130 at org.apache.jackrabbit.core.query.lucene.CachingIndexReader.getParent CachingIndexReader.java 107 at org.apache.jackrabbit.core.query.lucene.SharedIndexReader.getParent SharedIndexReader.java 78 at org.apache.jackrabbit.core.query.lucene.ReadOnlyIndexReader.getParent ReadOnlyIndexReader.java 141 at org.apache.jackrabbit.core.query.lucene.CachingMultiIndexReader.getParentDocId CachingMultiIndexReader.java 112 at org.apache.jackrabbit.core.query.lucene.SearchIndex CombinedIndexReader.getParent SearchIndex.java 1234 at org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer.isValid DescendantSelfAxisQuery.java 347 at org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer.next DescendantSelfAxisQuery.java 261 at org.apache.lucene.search.Scorer.score Scorer.java 48 at org.apache.jackrabbit.core.query.lucene.ChildAxisQuery ChildAxisScorer.calculateChildren ChildAxisQuery.java 317 at org.apache.jackrabbit.core.query.lucene.ChildAxisQuery ChildAxisScorer.next ChildAxisQuery.java 268 at org.apache.lucene.search.Scorer.score Scorer.java 48 at org.apache.lucene.search.IndexSearcher.search IndexSearcher.java 146 at org.apache.lucene.search.IndexSearcher.search IndexSearcher.java 113 at org.apache.lucene.search.Hits.getMoreDocs Hits.java 74 at org.apache.lucene.search.Hits. init Hits.java 53 at org.apache.lucene.search.Searcher.search Searcher.java 46 at org.apache.lucene.search.Searcher.search Searcher.java 38 at org.apache.jackrabbit.core.query.lucene.SearchIndex.executeQuery SearchIndex.java 692 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.executeQuery QueryResultImpl.java 242 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.getResults QueryResultImpl.java 290 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl. init QueryResultImpl.java 192 at org.apache.jackrabbit.core.query.lucene.QueryImpl.execute QueryImpl.java 138 at org.apache.jackrabbit.core.query.QueryImpl.execute QueryImpl.java 176 the strange thing is that if i change the xPath query from          catalog books into            catalog books element somePrimaryNodeType I don t get this exception anymore. Can anyone shed any light on this issue Can you please provide the complete test case or a description of how to reproduce the exception Thank you.The classes are TestClass        ContentRepository cr         BeforeClass        Initialize                  initialization of contentRepository class                cr new ContentRepository                ....                  Test        public void testGetNodes throws Exception                              String catalogBookPath session.getRootNode .getNode catalog .getNode book .getPath                 BookNode bookNode new BookNode                 bookNode.setName mybook                 cr.addNode catalogBookPath bookNode                 List BookNode createdNode cr.getNodes catalog books ..... exception                   After         public void tearDownTest                 try                         session.getRootNode .getNode catalog .remove                         session.save                                  catch RepositoryException e                         e.printStackTrace                           class ContentRepository ......         public void addNode string bookPath BookNode bookNode                 try                          Node parentNode session.getRootNode .getNode bookPath                          parentNode.addNode bookNode.getName bookNode.getNodeType                                  catch RepositoryException e                         e.printStackTrace                                    public List BookNode getNodes String queryXPath                         QueryManager queryManager session.getWorkspace .getQueryManager                         Query query queryManager.createQuery xPath Query.XPATH                         QueryResult result query.execute exception                         .......           ....... Hope is enough. Thank youFixed in revision 709207 The CombinedIndexReader in SearchIndex did not add the offset of the sub reader when resolving a ForeignSegmentDocId. Jukka can you please merge this fix into the 1.5 branch Thanks.Merged to the 1.5 branch in revision 713996.Merged changes into 1.4 branch in revision 748161
