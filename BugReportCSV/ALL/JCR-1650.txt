XPathQueryBuilder may not handle multiple jcr deref correctly
If you have the following tree inspired from DerefTest people     carl worksfor - company microsoft     frank worksfor - company microsoft company      microsoft eotm - carl The following queries will be translated to testroot people frank jcr deref worksfor jcr deref eotm Root node Select properties    PathQueryNode      LocationStepQueryNode NodeTest testroot Descendants false Index NONE      LocationStepQueryNode NodeTest people Descendants false Index NONE      LocationStepQueryNode NodeTest frank Descendants false Index NONE      DerefQueryNode NodeTest Descendants false Index NONE      DerefQueryNode NodeTest Descendants false Index NONE Matching carl node testroot people frank jcr deref worksfor jcr deref eotm jcr uuid Root node Select properties    PathQueryNode      LocationStepQueryNode NodeTest testroot Descendants false Index NONE      LocationStepQueryNode NodeTest people Descendants false Index NONE      LocationStepQueryNode NodeTest frank Descendants false Index NONE      LocationStepQueryNode NodeTest Descendants false Index NONE      DerefQueryNode NodeTest Descendants false Index NONE        RelationQueryNode Op NOT NULL Prop http www.jcp.org jcr 1.0 uuid Not matching carl node testroot people frank jcr deref worksfor jcr uuid jcr deref eotm jcr uuid Root node Select properties    PathQueryNode      LocationStepQueryNode NodeTest testroot Descendants false Index NONE      LocationStepQueryNode NodeTest people Descendants false Index NONE      LocationStepQueryNode NodeTest frank Descendants false Index NONE      DerefQueryNode NodeTest Descendants false Index NONE        RelationQueryNode Op NOT NULL Prop http www.jcp.org jcr 1.0 uuid      DerefQueryNode NodeTest Descendants false Index NONE        RelationQueryNode Op NOT NULL Prop http www.jcp.org jcr 1.0 uuid Matching carl node testroot people frank jcr deref worksfor jcr uuid jcr deref eotm Root node Select properties    PathQueryNode      LocationStepQueryNode NodeTest testroot Descendants false Index NONE      LocationStepQueryNode NodeTest people Descendants false Index NONE      LocationStepQueryNode NodeTest frank Descendants false Index NONE      DerefQueryNode NodeTest Descendants false Index NONE        RelationQueryNode Op NOT NULL Prop http www.jcp.org jcr 1.0 uuid      DerefQueryNode NodeTest Descendants false Index NONE Matching carl node This is because XPathQueryBuilder calls NAryQueryNode removeOperand QueryNode in order to replace current LocationStepQueryNode with a DerefQueryNode. NAryQueryNode removeOperand QueryNode uses internally a List and thus relies on Object equals Object for retrieving the object to remove. But the equals method is redefined for every QueryNode with a different semantic. Then the call to NAryQueryNode removeOperand QueryNode will not remove the wanted operand but the first operand returning true after calling equals in ArrayList remove Object .Patch for the 1.4 branch containing   additional tests for reproducing this bug in DerefTest test case.   a fix by rewriting NAryQueryNode removeOperand QueryNode without relying on Object equals Object but on reference comparison.Affects jackrabbit-core in 1.4.x and jackrabbit-spi-commons in trunk.Fixed in trunk at revision 668086 Thank you for providing a patch and the detailed analysis.I think this is the same bug as JCR-1075.I would like to have this fix backported to the 1.4 branch possibly in the next release 1.4.6 as the 1.5 is not planned to be released soon.Merged to the 1.4 branch in revision 700143. This fix will be included in jackrabbit-core 1.4.6.Thanks for the merge.
