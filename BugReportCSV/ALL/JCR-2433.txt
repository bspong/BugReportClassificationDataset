NPE when copying nodes with Workspace.copy 
I get a NullpointerException when using Workspace.copy java.lang.NullPointerException at org.apache.jackrabbit.core.BatchedItemOperations.copyNodeState BatchedItemOperations.java 1834 at org.apache.jackrabbit.core.BatchedItemOperations.copyNodeState BatchedItemOperations.java 1806 at org.apache.jackrabbit.core.BatchedItemOperations.copyNodeState BatchedItemOperations.java 1806 at org.apache.jackrabbit.core.BatchedItemOperations.copy BatchedItemOperations.java 423 at org.apache.jackrabbit.core.WorkspaceImpl.internalCopy WorkspaceImpl.java 444 at org.apache.jackrabbit.core.WorkspaceImpl.copy WorkspaceImpl.java 666 at xxx.MyClass.myMeth MyClass.java It seems that it happens not all the time. The error occurs since we use Jackrabbit 1.6.0. We do not get the error with previous versions. It seems that we only get the error when trying to copy nodes that were created with Jackrabbit 1.4 and copied with Jackrabbit 1.6.I also get the error when trying to copy nodes that were created with jackrabbit 1.5.0.the NPE is thrown here                 PropDefId defId srcChildState.getDefinitionId                 PropDef def ntReg.getPropDef defId if def.getDeclaringNodeType .equals NameConstants.MIX LOCKABLE did you change any node type declarations No I didn t change any node type declarations. I only upgraded my jackrabbit libs to 1.6.0 and thats it.When I switch back to jackrabbit 1.5.0 the error is gone.ok this is probably caused by a declaration change of the built-in node types in version 1.6. is there any chance you can find out the PropertyId of the property causing the exception i guess you d have to debug jackrabbit and place a NPE breakpoint.The PropertyId is 75a473e2-3ddf-459d-8460-f05b7ce864f3 http www.jcp.org jcr 1.0 isCheckedOut and the the PropDefId is 1284956073 do not know if this matters .I also get the following warning sometimes ItemManager - property at path to node jcr isCheckedOut has invalid definitionId 1284956073 thanks now i can see what s causing the problem. in version 1.6 the declarations of some built-in node types have changed actually the declarations have changed from JCR 1.0 to JCR 2.0 . i.e. jcr isCheckedOut used to be declared by mix versionable. in jackrabbit 1.6 it is declared by mix simpleVersionable and mix versionable now extends mix simpleVersionable. a quick fix for this issue would be to gracefully handle this incompatibility by guarding against NPE and trying to determine assign the correct definition during the copy operation. Are there any other incompatibilities in the 1.6.0 version Or should a migration from 1.5.0 to 1.6.0 be possible by exchanging the jackrabbit Jars only Set the fix version to 1.6.1.Postponing to a later 1.6.x release since we don t yet have a patch to fix this issue.That means Jackrabbit 1.6.x is incompatible with any previous versions. That should be mentioned in the ReadMe or somewhere else where the users can find it. Your data is corrupt after an upgrade to Jackrabbit 1.6.0 and that corruption can not be fixed. That is very critical for production environments. For us it means we can not use Jackrabbit 1.6.0 at all.Is there a way to manually fix the problem We have downgraded our repository to Jackrabbit 1.5 and are still unable to use the Workspace.copy function. Any ideas I committed a workaround to the NPE in revision 927393 and merged it to the 1.6 branch in revision 927395. This should solve at least the exact problem as reported though I m not sure if the confused node type information would cause other problems down the line.Resolving as fixed based on the above fix.I applied the fix by Jukka Zitting to version 1.6.1 recompiled and deployed to servers that are having this issue. I m still seeing the NPE even with the swapped equality test.The patch is not a fix of the bug. It just fixes the NPE but the problem relies on the changed notetype definitions which are incompatible with the previous ones. That means that jackrabbit 2.x and 1.6.x are incompatible with previous releases and that should be mentioned somewhere. However it seems that the patch does not fix all NPEs caused by the changed notetype definitions as Paul mentioned. Is there a way to manually fix the problem Paul can you post the exact stack trace you re getting Just for the record exporting and reimporting impacted nodes fixed the problem for us.If exporting and importing fixes the problem then that could be done by jackrabbit itself or not So maybe you could provide a fix for this issue that does this automatically Here is the stack trace I m getting note that it says line 1835 because I commented out the old line of code at line 1834 instead of replacing it . 2010-04-27 17 39 51 998 ERROR info.magnolia.module.exchangesimple.ReceiveFilter java.lang.NullPointerException         at org.apache.jackrabbit.core.BatchedItemOperations.copyNodeState BatchedItemOperations.java 1835         at org.apache.jackrabbit.core.BatchedItemOperations.copy BatchedItemOperations.java 423         at org.apache.jackrabbit.core.WorkspaceImpl.internalCopy WorkspaceImpl.java 444         at org.apache.jackrabbit.core.WorkspaceImpl.clone WorkspaceImpl.java 646         at info.magnolia.module.exchangetransactional.CopyUtil.clone CopyUtil.java 79         at info.magnolia.module.exchangetransactional.XAReceiveFilter.remove XAReceiveFilter.java 292         at info.magnolia.module.exchangetransactional.XAReceiveFilter.receive XAReceiveFilter.java 87         at info.magnolia.module.exchangesimple.ReceiveFilter.doFilter ReceiveFilter.java 123         at info.magnolia.module.exchangetransactional.XAReceiveFilter.doFilter XAReceiveFilter.java 60         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.security.BaseSecurityFilter.doFilter BaseSecurityFilter.java 61         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.security.LogoutFilter.doFilter LogoutFilter.java 89         at info.magnolia.cms.filters.OncePerRequestAbstractMgnlFilter.doFilter OncePerRequestAbstractMgnlFilter.java 62         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.security.auth.login.LoginFilter.doFilter LoginFilter.java 80         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.enterprise.registration.RegistrationFilter.doFilter RegistrationFilter.java 50         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 84         at info.magnolia.cms.filters.CosMultipartRequestFilter.doFilter CosMultipartRequestFilter.java 87         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.ContentTypeFilter.doFilter ContentTypeFilter.java 90         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.ContextFilter.doFilter ContextFilter.java 87         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.CompositeFilter.doFilter CompositeFilter.java 64         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlMainFilter.doFilter MgnlMainFilter.java 96         at info.magnolia.cms.filters.MgnlMainFilter.doFilter MgnlMainFilter.java 199         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter ApplicationFilterChain.java 215         at org.apache.catalina.core.ApplicationFilterChain.doFilter ApplicationFilterChain.java 188         at org.apache.catalina.core.StandardWrapperValve.invoke StandardWrapperValve.java 213         at org.apache.catalina.core.StandardContextValve.invoke StandardContextValve.java 172         at org.apache.catalina.core.StandardHostValve.invoke StandardHostValve.java 127         at org.apache.catalina.valves.ErrorReportValve.invoke ErrorReportValve.java 117         at org.apache.catalina.core.StandardEngineValve.invoke StandardEngineValve.java 108         at org.apache.catalina.connector.CoyoteAdapter.service CoyoteAdapter.java 174         at org.apache.coyote.http11.Http11AprProcessor.process Http11AprProcessor.java 835         at org.apache.coyote.http11.Http11AprProtocol Http11ConnectionHandler.process Http11AprProtocol.java 640         at org.apache.tomcat.util.net.AprEndpoint Worker.run AprEndpoint.java 1286         at java.lang.Thread.run Thread.java 636 I decided to modify the code to catch the exception and this is the exception that is thrown later on down the code 2010-04-27 18 07 17 419 ERROR info.magnolia.module.exchangesimple.ReceiveFilter java.lang.NullPointerException         at org.apache.jackrabbit.core.BatchedItemOperations.copyPropertyState BatchedItemOperations.java 1933         at org.apache.jackrabbit.core.BatchedItemOperations.copyNodeState BatchedItemOperations.java 1845         at org.apache.jackrabbit.core.BatchedItemOperations.copy BatchedItemOperations.java 423         at org.apache.jackrabbit.core.WorkspaceImpl.internalCopy WorkspaceImpl.java 444         at org.apache.jackrabbit.core.WorkspaceImpl.clone WorkspaceImpl.java 646         at info.magnolia.module.exchangetransactional.CopyUtil.clone CopyUtil.java 79         at info.magnolia.module.exchangetransactional.XAReceiveFilter.remove XAReceiveFilter.java 292 at info.magnolia.module.exchangetransactional.XAReceiveFilter.receive XAReceiveFilter.java 87         at info.magnolia.module.exchangesimple.ReceiveFilter.doFilter ReceiveFilter.java 123         at info.magnolia.module.exchangetransactional.XAReceiveFilter.doFilter XAReceiveFilter.java 60         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.security.BaseSecurityFilter.doFilter BaseSecurityFilter.java 61         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.security.LogoutFilter.doFilter LogoutFilter.java 89         at info.magnolia.cms.filters.OncePerRequestAbstractMgnlFilter.doFilter OncePerRequestAbstractMgnlFilter.java 62         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.security.auth.login.LoginFilter.doFilter LoginFilter.java 80         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.enterprise.registration.RegistrationFilter.doFilter RegistrationFilter.java 50         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82 at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 84         at info.magnolia.cms.filters.CosMultipartRequestFilter.doFilter CosMultipartRequestFilter.java 87         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.ContentTypeFilter.doFilter ContentTypeFilter.java 90         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.ContextFilter.doFilter ContextFilter.java 87         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlFilterChain.doFilter MgnlFilterChain.java 82         at info.magnolia.cms.filters.CompositeFilter.doFilter CompositeFilter.java 64         at info.magnolia.cms.filters.AbstractMgnlFilter.doFilter AbstractMgnlFilter.java 70         at info.magnolia.cms.filters.MgnlMainFilter.doFilter MgnlMainFilter.java 96         at info.magnolia.cms.filters.MgnlMainFilter.doFilter MgnlMainFilter.java 199         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter ApplicationFilterChain.java 215         at org.apache.catalina.core.ApplicationFilterChain.doFilter ApplicationFilterChain.java 188         at org.apache.catalina.core.StandardWrapperValve.invoke StandardWrapperValve.java 213         at org.apache.catalina.core.StandardContextValve.invoke StandardContextValve.java 172         at org.apache.catalina.core.StandardHostValve.invoke StandardHostValve.java 127         at org.apache.catalina.valves.ErrorReportValve.invoke ErrorReportValve.java 117         at org.apache.catalina.core.StandardEngineValve.invoke StandardEngineValve.java 108         at org.apache.catalina.connector.CoyoteAdapter.service CoyoteAdapter.java 174         at org.apache.coyote.http11.Http11AprProcessor.process Http11AprProcessor.java 835         at org.apache.coyote.http11.Http11AprProtocol Http11ConnectionHandler.process Http11AprProtocol.java 640         at org.apache.tomcat.util.net.AprEndpoint Worker.run AprEndpoint.java 1286         at java.lang.Thread.run Thread.java 636 Grégory and Sascha I too would be interested in doing an export and import of data using just JackRabbit if that is possible. Can somebody kindly point me to some instructions to do so Reopening. I m working on a backwards compatibility test for this and a solution that would automatically fix the node types broken by the upgrade.I now see revision 939290 have a test case that creates a repository with a versionable node in Jackrabbit 1.6 and then opens the repository in Jackrabbit 1.6 and copies the node. Unfortunately I m still unable to reproduce the original problem. After the repository upgrade the jcr isCheckedOut property is correctly reported as being declared by the mix simpleVersionable type. Any ideas on what I should do to reproduce this Let me know if I can be of any help. How we stumbled on this bug is we had started out with a clean repository created with Magnolia CMS 4.0.1. Some of the nodes may have been created using this version of the software. The CMS has since been upgraded to the following versions 95 certain of the accuracy here 4.0.2 4.1.1 4.1.2 4.3.1. There would have been nodes created with each version.Could you for example attach a system view export of the troublesome nodes and a copy of the custom nodetypes.xml file from within the repository directory You can blank out any sensitive data if needed. I m especially interested in the exact node type information of the troublesome nodes.See also JCR-2170 for related work. Perhaps we need to backport those changes to the 1.6 branch.I have now as of revision 943301 backported reimplemented most of the JCR-2170 changes in the 1.6 branch. These changes should also solve this issue. At least I was no longer able to reproduce the problem with the repository Paul sent me. Note that this revision includes a backward-compatible change in how item states are serialized which makes the repository unreadable by earlier Jackrabbit 1.6.x versions. I ll see if I can prevent this incompatibility as patch releases should be both backward- and forward-compatible with all releases from the same maintenance branch e.g. in addition to normal upgrades it should be OK to also switch back from 1.6.2 to 1.6.1 .I just wanted to say THANK YOU I will have a chance to look at this in more depth over the course of the next few days. But I didn t want to wait too long before saying thanks. I really personally appreciate how quickly you addressed this matter. I ll be in touch over the next couple of days. Regards -Paul Preventing the forwards-compatibility problem caused by the item definition identifiers no longer being serialized as a part of item states see JCR-2170 is somewhat complicated and would come with some performance overhead so I m resolving this as fixed as-is and adding a warning about this to the release notes. It would be great if someone other than me could also test the latest build from the 1.6 branch before we make the release. Nightly 1.6.2-SNAPSHOT builds are available from the snapshot repository at https repository.apache.org content groups snapshots-group .I have started testing on my end with the 1.6.2 snapshot from May 14. I am not done yet but so far so good. I replaced the 1.6.1 JARs that came with a CMS I was using with the snapshot versions and have yet to see the problems we had with the previous version. I will keep you posted about my progress but will probably keep testing in a development environment into the middle of next week before giving it the thumbs up.Excellent thanks Have you encountered any problems with this fix If not I m planning to finally cut the 1.6.2 release later this week.The original problem seems to be addressed which is good news. Another problem which might not be related to this one appears to have cropped up in its place however. Our CMS grinds to a halt and stops serving up requests. The problem seems to have started since I deployed the new JackRabbit JARs to the production servers. In the past couple of weeks our servers have only been able to run for a few days at most before one of them just stops serving requests Tomcat takes the request but never actually sends a response . Is there anything in those nightly 1.6.2-SNAPSHOTs that may have contributed to this problem There doesn t appear to be anything in the server logs that is helping me diagnose the problem. But when I go to shutdown Tomcat I get a bunch of messages like this in the catalina.out INFO Waiting for N instance s to be deallocated where N is some large number like 100. I was notified tonight that our website was down . We have a couple of servers and each Tomcat instance had stopped serving requests. So on each server I stopped Tomcat deleted all the JackRabbit indexes for each workspace associated with our CMS and restarted. Upon the restart on both servers I got a slew of these messages A property claimed to start before zero at -512 Resetting it to zero and hoping for the best However I restarted again and everything seems back to normal. Do you think this fix and the problem I m now seeing are related Or is it just some bad luck that the problem seems to have begun around the time that we found a fix here paul google is your friend... FWIW INFO Waiting for N instance s to be deallocated where N is some large number like 100. this is a tomcat specific message. i don t know whether it s actually caused by a jackrabbit problem in your case but google returns lots of hits e.g. http markmail.org message 6edcdicnknwdqjxc A property claimed to start before zero at -512 Resetting it to zero and hoping for the best http tinyurl.com 2w3n85f Thanks Stefan. Yes I ve Googled both of those error message before but I figured that it was worth mentioning both of them as they only appeared after the fixed JARs were in place. Unfortunately the tomcat deallocation problem is not one that seems to have one solution. In general the message appears to refer to servlets that are still running which would normally not be a JackRabbit induced problem. My question is would there be any code in the specific fix for this problem that might actually induce this sort of problem with TomCat I m trying to isolate all of the variables that changed over the past two weeks on the production servers to see which change may have brought about this problem. There weren t very many changes so this particular JAR deployment stands out as something I should look at.Hi I m currently on a holiday and will return to the office on the 6th of October. Your message was not forwarded and will be taken care of upon my return at the latest. In urgent cases please contact info magnolia-cms.com . Kind Regards Grégory Joseph Magnolia International Ltd. gregory.joseph magnolia-cms.com http www.magnolia-cms.com Magnolia® - Simple Enterprise Content Management 
