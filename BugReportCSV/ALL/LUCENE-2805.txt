SegmentInfos shouldn t blindly increment version on commit
SegmentInfos currently increments version on the assumption that there are always changes. But both DirReader and IW are more careful about tracking whether there are changes. DirReader has hasChanges and IW has changeCount. I think these classes should notify the SIS when there are in fact changes this will fix the case Simon hit on fixing LUCENE-2082 when the NRT reader thought there were changes but in fact there weren t because IW simply committed the exact SIS it already had. Duh make that LUCENE-2802. Attached first cut patch just moving the .version responsibility into DirReader IW. But I haven t verified if it fixes the case in LUCENE-2802. this should be fixed together with LUCENE-2802 here is a slightly updated patch that removes the blind increment from DefaultSegmentInfosWriter adds changed calles to contrib classes and adds a missing changed call to IW deleteAll test pass also for LUCENE-2802 Nice catches on all the other places Simon Patch looks good. Except I think we can now simplify IW.nrtIsCurrent to this synchronized boolean nrtIsCurrent SegmentInfos infos return segmentInfos.version infos.version docWriter.anyChanges Except I think we can now simplify IW.nrtIsCurrent to this Yay this make the nrtIsCurrent check simpler too. Lemme see if anything breaks I think that could cause a test to fail since we compared the seg infos though. next iteration - I simplified nrtIsCurrent which is nice and all tests pass. Yet I couldn t get any test failing with this version synchronized boolean nrtIsCurrent SegmentInfos infos return segmentInfos.version infos.version so I added another test that crashes immediately if we don t check the docWriter for changes. I also added a changes entry to runtime behavior section since the version number are different to previos versions. I also had to update an assert in TestIndexWriterReader testAddIndexes since we now don t increment the version on a commit if there are no changes but generation might have been changed though. I think we are good to go. Committed revision 1043148. I will backport later today here is a patch against 3.x. I needed to change an assert in the backwards tests so that is potentially a bw break and I am not 100 sure how we handle this right now. Is changing the bw test ok in this case If its really a bw break I guess we should also list it in the BW section in CHANGES.txt needed to change an assert in the backwards tests so that is potentially a bw break and I am not 100 sure how we handle this right now. Is changing the bw test ok in this case If its really a bw break I guess we should also list it in the BW section in CHANGES.txt It s fine to change the test Ð and the CHANGES entry already explains this Though maybe fix the CHANGES to explain that this now means some readers will in fact return true from isCurrent when then before incorrectly returned false . Backported in revision 1043406. Bulk close for 3.1
