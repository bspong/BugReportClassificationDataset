Add bundle support for PostgreSQL
The class DbNameIndex does not work with this RDBMS since the RETURN GENERATED KEYS JDBC feature is not implemented in current PostgreSQL drivers.This is the starting ddl I m using on my tests with PostgreSQL.Looks good. Any progress on the modifications required work around the RETURN GENERATED KEYS issue I have a solution tested extensively in our development environment so I m pretty sure it will work. The solution includes two new classes org.apache.jackrabbit.core.persistence.bundle.PostgreSQLPersistenceManager org.apache.jackrabbit.core.persistence.bundle.util.PostgreSQLNameIndex And the new ddl file to generate the schema. The work around to retrieve the generated key in postgres is implemented in PostgreSQLNameIndex. After doing the insert into schemaObjectPrefix NAMES table the generated key is retrieved doing a second query on the implicit sequence that assigns values to the primary key column. It s very similar to the NGKDbNameIndex class in that same package but the query is very specific to PostgreSQL and looks like this select currval schemaObjectPrefix NAMES ID SEQ This is the link to the PostgreSQL documentation on the currval function http www.postgresql.org docs 8.1 interactive functions-sequence.html I have tested it with a PostgreSQL 7.4 8.0 and 8.1. I am attaching these files here for you to test modify and hopefully integrate in the SVN repositories. As written before feel free to make any changes in these files.This is the new ddl for PostgreSQLExcellent thanks a lot I committed the files with minor changes in revision 541146. I don t have a PostgreSQL installation at hand right now so I couldn t test that it actually works but the code seems to do all the right things. Please test and reopen this issue if necessary.We have used that with Jackrabbit 1.3 and a PostgeSQL 8.2 and can confirm that it works using the PM for workspaces and versions. As Postgres 8.2 has useful new features we improved the implementation and schema for 8.2. It has another index and the new 8.2 RETURNING feature that allows to reduce the 2 statements going through the index to 1. The two changes are a different schema and a different PostgreSQLNameIndex class. The PostgreSQLPersistenceManager class needs no changes.The schema only working with postgres 8.2The slightly modifed PostgreSQLNameIndex class. Again only for 8.2 Note that the 8.2 in the previous file upload comment was meant to be 8.2 - Not to forget thanks to Hagen Overdick our PostgreSQL expert who did the work.
