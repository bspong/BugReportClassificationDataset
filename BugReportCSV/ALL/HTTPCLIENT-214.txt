HttpClient drops connection to the proxy when an invalid connection close directive is encountered in connection established response
One of our customer is using our application to connect to our servlet using https. We are using httpClient for http protocol handling. The customer has a IBM proxy see log file . The connect failed with a null pointer exception. The log seem to indicate that the proxy server is returning 200 for CONNECT but the proxy also sends a Connection close header. The httpClient closed the connection and then tried to create the SSL socket. If the proxy server is incorrect in sending 200 with Connection close then httpClient should throw exception for invalid state IllegalStateException . I will attach the log file.Created an attachment id 6471 log file Created an attachment id 6486 Patch take 1 Bin I see things a bit differently here. It is not HttpClient that fails to work with IBM Web Traffic Express Caching proxy on https rather it is IBM Web Traffic Express Caching proxy that fails to work properly. Sending connection close header along with connection established response appears ... well... odd to me. So the bug report should have gone to the IBM folks in the very first place. Nevertheless HttpClient has been tweaked to ignore inappropriate connection directives in order to make it more robust when dealing with non-compliant proxy servers. The patch attached will also make HttpClient report a waring when an invalid connection close directive is encountered in connection established response. OlegBin it seems that you are using an older version of HttpClient. I do not believe the latest version of HttpClient will exhibit this problem. Oleg I think the patch adds valuable feedback to the user but it does not appear to change the behavior of Connect. This is good as I think the current behavior is correct. MikeMike I stumbled upon this problem while doing Javadoc cleanups for the beta-1 release. At that point Bin apparently was still running an earlier nightly build. Oleg PS Patch committedMike and Oleg First as confirmation we are using an old version of the nightly build 0308 build modified by us . I am not sure if we can afford to upgrade in this case. To clarify the situation let me give a brief description of our application. Our application is actually a signed applet and the size of the applet is fairly large. So we actually have our customers installing all the jar files including httpClient on the client machine. The applet is used by several thousands customers worldwide. As result upgrading is a big deal not simply a technical decision . The applet is using http https to communicate with our web app server and httpClient is used for the http communication. Currently we released our product with the modified 0308 nightly build we could not make the latest nightly build work within our release schedule . After the release we made the attempt to find a way to work with latest build and with the great help from you guys we got there. But the new code is not in the release yet. Also our average users are not very comfortable with computers so it is rather difficult to make our users to test different scenarios. Now this bug is reported from the field and the customer is still using the old code. Now come back to the bug. If I read your comments correctly then 1. The bug was caused by the incorrect behavior of IBM proxy server 200 with connection close . 2. The latest nightly build or coming beta will handle the error better but it still would not work. For point 1 I agree with that assessment. For point 2 I would like to know what will be the expected behavior logging some warning or throwing exceptions . Given that I do not have the environment to reproduce the problem I may have to let our customers do the test. So I would need to know what to expect. Finally I know that the httpClient is close to beta 2 and this should not stop it. But I hope this can be addressed in some later version. Our customer have tried to use our application with browser connection one of the things applet can do it did navigate through the proxy server OK. I would think that httpClient can also work with the situation and find a way to work with this incorrect proxy server behavior may be ignoring the connection close when 200 is returned .Bin I apologize if mine of Mike s statements turned out to be confusing or contradictory. In fact since beta-1 HttpClient does ignore connection close header as well as all other headers when Connect method returns status code 200 and therefore should work with non-compliant proxy servers including IBM Web Traffic Express that one of your clients is using. I stumbled upon the problem pretty much by chance just a day before you filed the report. http cvs.apache.org viewcvs jakarta-commons httpclient src java org apache commons httpclient ConnectMethod.java.diff r1 1.14 r2 1.15 My latest patch merely added a warning for non-compliant behaviour. I hope that clarified things a bit. OlegOleg Thanks that is goog new for us. By the way when will the beta-1 be released. We are considering moving to the latest build but prefer to wait until beta-1 is released so we can stay on a more stable version. Bin ChenBin Beta-1 has been tagged in the CVS two days ago is officially out. Unfortunately Jeff Jandalf our release prime has been staying off-line for quite some time. We can t deploy the official build without him as only Jeff has necessary access permissions for the official Jakarta file repository web site. That should not stop you from obtaining the beta-1 release though. Just get it from the CVS by running the following command cvs -d pserver anoncvs cvs.apache.org home cvspublic co -r HTTPCLIENT 2 0 BETA1 jakarta-commons httpclient Cheers Oleg Bin The only way to fix the problem in your production environment will be to upgrade to beta-1. This should be an easy upgrade because your version 0308 is a post alpha-3 version. So the differences will be small the diff is huge though on the API level. You should at least give it a try.
