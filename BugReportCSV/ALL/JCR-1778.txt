BindableRepositoryFactory doesn t handle repository shutdown
The BindableRepositoryFactory class keeps a cached reference to a repository even after the repository has been shut down. This causes the following code snippet to fail with an IllegalStateException         Hashtable environment new Hashtable         environment.put                 Context.INITIAL CONTEXT FACTORY                 DummyInitialContextFactory.class.getName         environment.put Context.PROVIDER URL http jackrabbit.apache.org         Context context new InitialContext environment         JackrabbitRepository repository         String xml src test repository repository.xml         String dir target repository         String key repository          Create first repository         RegistryHelper.registerRepository context key xml dir true         repository JackrabbitRepository context.lookup key         repository.login .logout         repository.shutdown          Create second repository with the same configuration         RegistryHelper.registerRepository context key xml dir true         repository JackrabbitRepository context.lookup key         repository.login .logout throws an IllegalStateException         repository.shutdown Same goes if you replace repository.shutdown by a call to RegistryHelper.unregisterRepository which is even more worrying. The issue seems to be due to the static cache of BindableRepositoryFactory. I can reproduce this with 1.4.6 and 1.5.0 not with 1.4.5Seems to me as this is if only by accident related to JCR-1823 Seems to me as this is if only by accident related to JCR-1823 Yes now the test case throws a RepositoryException instead of an IllegalStateException. This is still incorrect.Patch do prevent invalid repository object to remain in the BindableRepositoryFactory s cacheThanks for the patch I committed a slightly modified version to Jackrabbit trunk in revision 933694 and merged the change to the 2.1 branch in revision 933697.
