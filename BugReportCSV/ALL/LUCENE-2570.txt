Some improvements to TestUtil and its usage
I ve started this issue because I ve noticed that TestUtil.getRandomMultiplier is called from many loops condition check sometimes hundreds and thousands of times. Each time it does Integer.parseInt after calling System.getProperty. This really can become a constant IMO either in LuceneTestCase J4 or TestUtil as it s not expected to change while tests are running ... I then reviewed the class and spotted some more things that I think can be fixed improved getTestCodec can become a constant as well arrayToString is marked deprecated. I ve checked an no one calls them so I ll delete them. This is a 4.0 code branch a test-only class. No need to deprecate anything. getTempDir calls new Random instead of newRandom in LuceneTestCaseJ4 which means that if something fails we won t know the random seed used ... In that regard we might want to output all the classes that obtained a static seed in reportAdditionalFailures instead of just the class that ran the test. rmDir String can be removed IMO and leave only rmDir File I suggest we include some recursion in rmDir File to handle the deletion of nested directories. Also it does not check whether the dir deletion itself succeeds but it does so for the files . This can bite us on Windows if some test did not close things properly. I ll work out a patch. In that regard we might want to output all the classes that obtained a static seed in reportAdditionalFailures instead of just the class that ran the test. I think that one might be confusing because one test class can t really affect another. I like all your other suggestions though I was thinking of the fix to getTempDir that I proposed. If TestUtil should obtain such static random then it 1 needs to extend LuceneTestCaseJ4 and 2 will affect all the classes that call this method. I m not sure I like having TestUtil extending LTCJ4 and not sure that particular random can affect any test failure ... so perhaps I ll leave that fix outside We can remove the whole class and move the code to LTC J4 Another option is if TestUtil has methods that need a random make it a required argument I don t think that removing the class is a good idea. Some methods like rmDir can exist on the base test classes however the class also contains large arrays blockStarts Ends and it will just clatter the base test class I think. What do you think Another option is if TestUtil has methods that need a random make it a required argument I had thought about it but that method is called from several places in the code and the randomness seems very insignificant. It just adds a random number to the directory name the caller requested. If it is in order to prevent collisions then the code isn t safe because there is a chance the same number will be generated twice ... Most of the patch is about replacing the calls to getRandomMultiplier w the static constant reference. All tests pass except the one that is fixed in LUCENE-2568 but not committed yet . Unless you have more comments I d like to commit this shortly. the only comment i have is exposing TEST CODEC as public... can it be private I don t think its very useful since it could be a value like random and is by default which isnt actually a valid codec its basically just internal to LuceneTestCase J4 I can make it private but then I ll need to repeat the declaration line in both LTC and LTCJ4. Currently LTC just references the one in LTCJ4. If that matters I can make it package-private package-private works... i just wanted to prevent confusion since i don t think its very useful outside of LuceneTestCase J4 ok will do and commit. Committed revision 979646 trunk . Committed revision 979720 3x . Bulk close for 3.1
