Non-versionable children of a versionable node should not be updated when a merge fails
The JCR specification JSR-170 includes a merge algorithm that is inconsistent with the functionality described elsewhere in the JCR specification. Specifically from JSR-170 section 8.2.10 Merge In either case regardless of whether bestEffort is true or false for each non-versionable node including both referenceable and non-referenceable if the merge result of its nearest versionable ancestor is update or if it has no versionable ancestor then it is updated to reflect the state of its corresponding node. Otherwise it is left unchanged. The algorithm presented in 8.2.10.1 of the specification goes against the above statement as it does not take into consideration the merge result of the nearest versionable ancestor. One solution would be to have the doLeave n call that dofail n v calls altered to only perform a merge on the versionable children rather than all of the children. The merging of all children versionable and non-versionable should only be done if the nearest parent is not in a failed merge state regardless of whether the failure occurred from the current merge operation or a previous merge operation. I will attach a patch file that makes what I think is the required change. Proposed fix for this issue. This is a diff from the trunk branch of jackrabbit 1.4-snapshot .The fix I supplied for this should actually only merge non-versionable children if the result of the merge is a fail or a leave not just if it is a failure. Otherwise non-versionable children will always be merged regardless of the merge status of the nearest versionable parent. I will update the attached diff with a different proposed fixed. More information on this issue can be found in JCR-1314. Updated patch.yes i think your latest patch is correct. thanks for finding this fixed as proposed.apparently some tests fail CRAPITest    testMergeNodeNonVersionableSubNodeUpdate  junit.framework.AssertionFailedError  junit.framework.AssertionFailedError        at junit.framework.Assert.fail Assert.java 47        at junit.framework.Assert.assertTrue Assert.java 20        at junit.framework.Assert.assertTrue Assert.java 27        at org.apache.jackrabbit.test.api.version.MergeNonVersionableSubNodeTest.testMergeNodeNonVersionableSubNodeUpdate MergeNonVersionableSubNodeTest.java 86 will investigate if tests are wrong or fix.fixed the failing tests which were wrong and partially commented out Merged to the 1.4 branch in revision 618599.
