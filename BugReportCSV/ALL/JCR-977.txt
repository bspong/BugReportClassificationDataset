jcr deref and parent axis in xpath predicates
Currently the jcr deref function is not allowed in a xpath query predicate. Example book holds a reference property on its author s authors have a name We want all books from a specific author jcr root element bookType jcr deref author authorType name King This fails with an InvalidQueryException currently not supported . The error is raised in the XPathQueryBuilder class in function private QueryNode createFunction SimpleNode node QueryNode queryNode in the block else if NameFormat.format JCR DEREF resolver .equals fName Problem is that with this query when evaluating the jcr deref function then in this method at this point queryNode.getType is 0 and tests raise the exception if queryNode.getType is neither QueryNode.TYPE LOCATION nor QueryNode.TYPE PATH. I think this is a useful place to put a deref function in a query as I don t know how we could test the referenced node properties another way. Frederic EsnaultHere s a first stab at this. Needs cleanup but the important part is it works. - Good work thanks a lot for the patch. I ve reviewed the patch an reworked it a bit. Streamlined some of the code and fixed a bug in LuceneQueryBuilder. Dan what do you think Also affect spi-commons.Thanks Marcel Looks good although I haven t had time to upgrade to the 2.x tree and really test it out. Are you going to put this into 2.x Are you going to put this into 2.x yes this will go into 2.0.0 Applied patch in revision 791737 Thanks again for your help.Fixed a bug in PredicateDerefQuery in revision 792162There are some issues with the changes related to XPath QueryFormat.Fixed in revision 792894Adjusted summary.
