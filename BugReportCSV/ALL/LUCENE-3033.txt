TestAddIndexes testAddIndexesWithThreads fails on Realtime
Selckin reported two failures on LUCENE-3023 which I can unfortunately not reproduce at all. here are the traces junit Testsuite org.apache.lucene.index.TestAddIndexes junit Testcase testAddIndexesWithThreads org.apache.lucene.index.TestAddIndexes FAILED junit expected 3160 but was 3060 junit junit.framework.AssertionFailedError expected 3160 but was 3060 junit at org.apache.lucene.index.TestAddIndexes.testAddIndexesWithThreads TestAddIndexes.java 783 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1226 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1154 junit junit junit Tests run 18 Failures 1 Errors 0 Time elapsed 14.272 sec junit junit Standard Error junit NOTE reproduce with ant test -Dtestcase TestAddIndexes -Dtestmethod testAddIndexesWithThreads -Dtests.seed 6128854208955988865 2552774338676281184 junit NOTE test params are codec PreFlex locale no NO NY timezone America Edmonton junit NOTE all tests run in this JVM junit TestToken TestDateTools Test2BTerms TestAddIndexes junit NOTE Linux 2.6.37-gentoo amd64 Sun Microsystems Inc. 1.6.0 24 64-bit cpus 8 threads 1 free 84731792 total 258080768 junit and junit Testsuite org.apache.lucene.index.TestAddIndexes junit Testcase testAddIndexesWithThreads org.apache.lucene.index.TestAddIndexes FAILED junit expected 3160 but was 3060 junit junit.framework.AssertionFailedError expected 3160 but was 3060 junit at org.apache.lucene.index.TestAddIndexes.testAddIndexesWithThreads TestAddIndexes.java 783 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1226 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1154 junit junit junit Tests run 18 Failures 1 Errors 0 Time elapsed 14.841 sec junit junit Standard Error junit NOTE reproduce with ant test -Dtestcase TestAddIndexes -Dtestmethod testAddIndexesWithThreads -Dtests.seed 4502815121171887759 -6764285049309266272 junit NOTE test params are codec PreFlex locale tr TR timezone Mexico BajaNorte junit NOTE all tests run in this JVM junit TestToken TestDateTools Test2BTerms TestAddIndexes junit NOTE Linux 2.6.37-gentoo amd64 Sun Microsystems Inc. 1.6.0 24 64-bit cpus 8 threads 1 free 163663416 total 243335168 junit After 900 runs I stepped into this error but only since I got an OOM during merge is it possible that such an error is not printed out due to not enough memory I think we hit an OOM during the handle method in CommitAndAddIndexes this could happen no If so I think this is a false positive.... I think I have found the root cause of this issue. There was a chance of missing a DWPT during a full flush commit when a full flush is started while we release a new DWPT into the pool. All subsequent documents added to this DWPT will never get flushed neither if I commit nor when I close the writer. This also explains the failures in LUCENE-3035. I committed a fix in Revision 1097156. I will resolve those issues since both haven t occurred anymore running them while 1 the entire night. fixed in Revision 1097156
