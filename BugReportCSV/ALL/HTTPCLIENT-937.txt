Make CacheEntry use an immutable object to represent cache content
Make CacheEntry use an immutable object to represent cache content similar to HttpEntityUnless someone else on the project has the intent of working on this we will most likely add it to our backlog here at Comcast. Thoughts It is all yours. OlegOk this work is now in progress here. Thanks DaveOleg Here is a patch that I believe accomplishes the desired effect. We are still carrying a byte privately inside the CacheEntry which makes for easy serialization. But now getBody returns an HttpEntity which uses the ByteArrayEntity implementation and is new for every call to getBody . Because the byte that gets passed into the CacheEntryGenerator is itself a local variable within a method of CachingHttpClient I do not believe there are any opportunities for external mutation of the content of that byte . However because someone could create a CacheEntry in some other piece of code and keep a reference to the byte that was used I am not sure this meets the Immutable requirement. All please feel free to comment and suggest alternatives. Thanks Dave MaysThanks but it s quite difficult to follow the patch as there are a lot of irrelevant changes - reordering of imports field renames etc. BTW we never use imports like import org.apache.http. Would it be possible to provide a minimal patch that includes only the essential differences Thanks Any renaming can be done later if necessary.No problem. Something weird happened when I updated from SVN I think because of all the shuffling of package names. This clearly had an impact on the level of confusion in this patch. DaveHere is a simpler patch. This does not include the necessary changes to the unit tests so the project will not compile fully with this. But if all you want to do is read the patch to get the gist of the changes I think this one is OK. I also included for completeness the patch for the tests. DaveThanks that s a lot better but there are still some spurious import changes. I ve now had a more detailed look at the proposed changes. I m not sure that using ByteArrayEntity helps - the class is not immutable as it exposes the byte array to subclasses. Furthermore its constructor does not copy the input array so the caller can change the array after construction. AFAICT this just moves the mutable items to a different class but perhaps I m missing something here. Sebastian The entity will be exposed to the consumer as immutable HttpEntity. The consumer would be able to muck around with the underlying byte array only having explicitly cast the entity to ByteArrayEntity. David We could take this one step further and let the HttpCache decide what kind of HttpEntity implementation to use as a cache entry. Ultimately I would like to make it possible to use FileEntity for storing cached content. However there is one important aspect to be taken into consideration. When backed by the file system a cache must be able to dispose of expired cache entries in such a way that no files would be left lying around or other system resources unreleased. The cache should also be able to keep track of references to cache entries to ensure they could be disposed of only when not referenced. OlegDavid Sebastian I committed the patch with some fairly minor changes. CacheEntry now uses an immutable HttpEntity to store cached content instead of a byte array. Please review. Next step should be persistent cache implementation that makes use of the file system to store cached entities. Oleg
