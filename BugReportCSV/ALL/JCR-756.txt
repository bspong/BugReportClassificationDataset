Concurrent add remove child node operations in a cluster may corrupt repository.
Concurrent add remove child node operations in a cluster may store an inconsistent list of child node entries i.e. an entry in the list may appear that has no associated node. This eventually results in an ItemNotFoundException the next time one of these bogus entries is accessed.Create.java Sample application that creates nodes and properties below the root node.Remove.java Sample application that deletes nodes below the root nodeSample repository.xml configuration that might be used for both create and remove sample application.Problem identified to be the following during an update 1 When a journal update is started the clustered instance syncs with journal contents. This     might change the SharedItemStateManager s states 2 Later on eventual non-conflicting changes are merged to the local states. 3 Finally the journal update is prepared. This might again trigger an external update from     the journal and change the shared states . However these changes are not merged to the     local states. 4 The local states are pushed blindly to the shared states potentially overwriting a previous     change. Fixed by locking the journal in 1 instead of 3 . This still allows non-conflicting merge but only once. An even better less blocking approach would iteratively merge the changes seen in external updates to the local states. Thanks a lot to Rafa Kwiecie for reporting this bug and providing the test classes. Fixed in revision 509624.Dominique can you isolate the fix for just this issue from the 509624 commit Otherwise I can t include this in the Jackrabbit 1.2.3 release as the 509624 change is IMHO too large for a patch release. Jukka sorry for not having answered to your question was quite busy the last few days I quickly took a look at the changes I had to make in order to have the Create Remove test scenario pass in my already refactored classes and those changes looked to complicated to be merged back to the 1.2 branch.No problem we ll just release the fix with 1.3. - 
