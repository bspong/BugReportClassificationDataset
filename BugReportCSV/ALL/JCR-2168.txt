Avoid premature publication of XAItemStateManager
The XAItemStateManager constructor calls the super constructor LocalItemStateManager which registers the instance as a listener with the SharedItemStateManager. The construction of the instance has not yet been finished but it is accessible from the SharedItemStateManager. This can result in strange exceptions like the following java.lang.NullPointerException         at org.apache.jackrabbit.core.state.XAItemStateManager.stateModified XAItemStateManager.java 580         at org.apache.jackrabbit.core.state.StateChangeDispatcher.notifyStateModified StateChangeDispatcher.java 111         at org.apache.jackrabbit.core.state.SharedItemStateManager.stateModified SharedItemStateManager.java 400         at org.apache.jackrabbit.core.virtual.AbstractVISProvider.stateModified AbstractVISProvider.java 445         at org.apache.jackrabbit.core.state.ItemState.notifyStateUpdated ItemState.java 244 The NPE is caused by the commitLogs field being null it has not yet been initialized to its final value .Here s a possible solution which uses factory methods instead of public ctors. 1 looks good.Marcel thanks again for having a look I ll commit the patch shortly.Committed patch in revision 789257. Merged to the 1.x branch in revision 791830.Merged to the 1.5 branch in revision 794287.
