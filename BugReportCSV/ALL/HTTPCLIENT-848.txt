HttpClient - Connections not released when SSL Tunneling fails.
Trying to use HTTPS and SSL tunneling fails as expected because the host is not accepted by the squid proxy so squid proxy return 403. The problem I am seeing is that when ever this happens the connections are not released to the pool. I traced the code and it appears that in HttpMethidDirector.java executeWithRetry when executeConnect return false and there is no retry the connections are not released. Is this expected Or am I doing something wrong.Are you sure your application always invokes HttpMethod releaseConnection when done with the request The best way to ensure the underlying connection gets released back to the pool is by calling this method from a finally block. Olegabsolutely. I do HttpMethod releaseConnection in the finally block. I debugged through the code before i opened this issue.Could you please attach a complete context wire log of a session exhibiting the problem Even if this is a genuine bug in HttpClient it is unlikely to get fixed as 3.x branch is effectively approaching end of life. Consider upgrading to HttpClient 4.0 OlegHi Oleg sorry for the delayed response. I just saw you resolved the issue. I tested the scenario with 4.0 and i dont see the problem. But I just want to prove that its a bug in 3.x version as I am not in a position to upgrade to 4.0 as its a beta. What information logs do you need. I have a test case which will reproduce this behavior. Thanks PraveenFeel free to re-open the issue and attach a wire context log which can be produced using thus guide 1 and the test case. Oleg 1 http hc.apache.org httpclient-3.x logging.htmlReopening I am going to attach the context wire logs and a simple test case.Attached the logs and the test case. This is the scenario. Make https get call using httpclient 3.1 to say https www.verisin.com Have a squid proxy and dont authorize https www.verisin.com in the acl list so squid will block this call. As expected httpClient makes a CONNECT with squid proxy to tunnel with the host. Squid responds back with 403. httpClient does not release connection to the pool so any subsequent calls for the same host will not get connection. MaxTotalConnections 4 DefaultMaxConnectionsPerHost 1 The expected behavior is that httpClient releases the connection to the pool for this specific host when CONNECT call fails. Also Pplease let me know if I doing something wrong. Thanks PraveenFixed in SVN trunk. Please re-test. OlegI verified the fix and it works fine. Thanks for your quick turn around. Do you want me to go ahead and close the issue Also when do you think this fix will be released Thanks Praveen Also when do you think this fix will be released Praveen It is very unlikely there will ever be another official release of the 3.x branch Oleg
