NPE in EventStateCollection
When removing a Version with a versionlabel and restoring an other Version from the same containing history within 1 transaction a NPE occured. When debugging I noticed the method createEventStates was entered with an UUID from a versionLabel. The ChangeLog.get id returned null. Caused by java.lang.NullPointerException at org.apache.jackrabbit.core.observation.EventStateCollection.getNodeType EventStateCollection.java 614 at org.apache.jackrabbit.core.observation.EventStateCollection.createEventStates EventStateCollection.java 381 at org.apache.jackrabbit.core.state.SharedItemStateManager Update.begin SharedItemStateManager.java 697 at org.apache.jackrabbit.core.state.SharedItemStateManager.beginUpdate SharedItemStateManager.java 1085 at org.apache.jackrabbit.core.state.XAItemStateManager.prepare XAItemStateManager.java 163 at org.apache.jackrabbit.core.version.XAVersionManager.prepare XAVersionManager.java 509 at org.apache.jackrabbit.core.TransactionContext.prepare TransactionContext.java 154 at org.apache.jackrabbit.core.XASessionImpl.prepare XASessionImpl.java 331 at org.springmodules.jcr.jackrabbit.support.JackRabbitUserTransaction.commit JackRabbitUserTransaction.java 100 at org.springmodules.jcr.jackrabbit.LocalTransactionManager.doCommit LocalTransactionManager.java 192 This seems like a more generic problem as we ve seen this problem also in a normal save call with Jackrabbit 1.4.x java.lang.NullPointerException at org.apache.jackrabbit.core.observation.EventStateCollection.getNodeType EventStateCollection.java 476 at org.apache.jackrabbit.core.observation.EventStateCollection.createEventStates EventStateCollection.java 179 at org.apache.jackrabbit.core.state.SharedItemStateManager Update.begin SharedItemStateManager.java 672 at org.apache.jackrabbit.core.state.SharedItemStateManager.beginUpdate SharedItemStateManager.java 843 at org.apache.jackrabbit.core.state.SharedItemStateManager.update SharedItemStateManager.java 873 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 334 at org.apache.jackrabbit.core.state.XAItemStateManager.update XAItemStateManager.java 337 at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 310 at org.apache.jackrabbit.core.state.SessionItemStateManager.update SessionItemStateManager.java 317 at org.apache.jackrabbit.core.ItemImpl.save ItemImpl.java 1251 As a first step I added r890401 a simple workaround that detects the case when the old parent of a moved node is no longer available and replaced the NPE with an error log message. Note that required REMOVE event is not fired in such cases so this is not a final solution to this problem. But at least the MOVED and ADDED events now get fired and no NPE is thrown.Resolving as fixed based on the above partial solution. If we need a more complete solution we can do that in a separate followup issue.
