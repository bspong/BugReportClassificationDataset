Query mergeBooleanQueries argument should be of type BooleanQuery instead of Query 
The method mergeBooleanQueries accepts Query and casts elements to BooleanQuery without checking. This will guarantee a ClassCastException if it is not a boolean query. We should enforce this by changing the signature. This won t really break back compat. as it only works with instances of BooleanQuery. Attached patch testcase. The patch passes all tests including test-tag. Patch looks good thanks Simon. Technically it s a break in jar drop-in ability back compat since the method signature has changed. However I think it s unlikely apps are using this rather expert API and we already don t have jar drop-in ability for 2.9 anyway and as you said if you attempt to pass a non-BooleanQuery you ll hit a cast exception anwyay. I plan to commit shortly. Thank Simon 
