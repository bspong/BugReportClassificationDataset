CacheEntryUpdater does not properly update cache entry resource
CacheEntryUpdater updateCacheEntry copies the old cache entry s resource though I believe it should only do so if the response is a 304. Otherwise it should take the response from the server to update the entry. This method gets called when validating a cache entry and the server returns a 200 or 304.This patch should be applied against TestCacheEntryUpdater and it exposes the mentioned bug. I have started to work on a fix but was hoping for some feedback on my approach. I am looking to move the logic of CacheEntryUpdater updateCacheEntry into BasicHttpCache this is the only place where it is used . The rest of CacheEntryUpdater s methods can remain as helper methods. I think this will simplify the logic and help prevent any code duplication. I believe it might make resolving HTTPCLIENT-1003 easier as well. Any thoughts Thanks MichajloThis patch fixes functionality so that a stale cache entry s resource is only copied into the new entry on 304 responses it is still valid and is replaced by all other responses. The following changes were made Ê- Move CacheEntryUpdater updateCacheEntry logic into BasicHttpCache updateCacheEntry if the response is not 304 then call BasicCacheEntry cacheAndReturnResponse Ê- Deleted CacheEntryUpdater tests testUpdateCacheEntryReturnsDifferentEntryInstance and testUpdatedEntryHasLatestRequestAndResponseDates - these are trivial and difficult to test with the rearranged code Ê- Added Via header to backendResponse in CachingHttpClient revalidation method Ê- Added tests to TestBasicHttpCache to check proper updating of response body This patch is submitted with the permission of my employer. Thanks MichajloPlease disregard the previous patch I am currently working on another version that should be a little more elegant and make HTTPCLIENT-1003 easier. Thanks MichajloThis patch provides a slightly cleaner fix. Ê- Only 304 responses go through updateCacheEntry and I have updated CacheEntryUpdater updateCacheEntry to reinforce this Ê- In CachingHttpClient revalidateCacheEntry non-304 responses go through handleBackendResponse to ensure cachability Ê- Updated unit tests to reflect this change I also fixed a random typo in CachedResponseSuitabilityChecker.java Please let me know if I have missed anything. This patch is submitted with the permission of my employer. Thanks MichajloPatch cache update fix2.patch checked in. Many thanks Michajlo Oleg
