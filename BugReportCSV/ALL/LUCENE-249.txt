Demo DeleteFiles doesn t delete files by their path names
It appears that delete term fails to delete the last document containing term which for a unique match means that you can t remove an individual document. Code attempting to remove document with specific path slightly modified version of demo code Directory directory FSDirectory.getDirectory index false IndexReader reader IndexReader.open directory Term term new Term path args 0 path passed via command line arg int deleted reader.delete term reader.close directory.close System.out.println deleted deleted documents containing term Executing this always returns deleted 0 documents containing path entered In IndexReader.java delete has public final int delete Term term throws IOException TermDocs docs termDocs term if docs null return 0 int n 0 try while docs.next delete docs.doc n finally docs.close return n It appears that docs.next always returns false when there is only one doc hence delete is never called and 0 is always returned. I assume that this also means that if there are multiple matches the last doc will not be deleted either but I have not tested that. I modified the code as follows boolean more true try docs.next while more delete docs.doc n more docs.next finally docs.close and then it worked as expected at least attempts to delete a single document from the index succeeded whereas previously they did not . I think that you somehow break corrupt the content of the path field either while adding it into your document or while providing it for delete so that the two terms are not equal. I am quite sure that Termdocs.next works as it should. This means that the doc numbers provided by a TermDocs is only valid if next returned true. However if you are convinced that there is a bug in TermDocs delete term please provide a self-contained test case. Created an attachment id 12282 Modification of IndexFiles.java to add single doc to index Created an attachment id 12283 Modification of DeleteFiles.java to delete a single doc from the index Created an attachment id 12284 Demos jar file which includes IndexFile and DeleteFile It is quite possible that there is a problem with how I am adding and then deleting a document from the index which is the source of the problem although what I am doing is only a small variation on the Demo code. I m not a Java programmer and have only just recently started playing with Lucene. I ve attached two class files which are small modifications to the IndexFiles.java and DeleteFiles.java files included in the lucene distro. I ve also included the jar file that includes them although I received an error when uploading and am not positive it got uploaded safely . I m afraid I don t have a publicly accessible server where you can see directly what I have but here s a complete rundown of what I did created and archive of plain text html documents in this case in the directory home acolliso archive ran java org.apache.lucene.demo.IndexFiles home acolliso archive This created an index of about 190 MB and searching on the index appears to work fine. then I ran the following java org.apache.lucene.demo.IndexFile home acolliso archive newdoc1.html adding home acolliso archive newdoc1.html 244 total milliseconds newdoc1.html is a small file with a few unique words in it so I know it will show up at the top of my search later on. Note that IndexFile does not run optimize. don t know if that has any consequences. java org.apache.lucene.demo.SearchFiles Query white dwarfs black holes Searching for white dwarfs black holes 2 total matching documents 0. home acolliso archive newdoc.html 1. home acolliso archive newdoc1.html java org.apache.lucene.demo.DeleteFile home acolliso archive newdoc1.html Path to delete home acolliso archive newdoc1.html Term path home acolliso archive newdoc1.html Got next doc ...false Term docs 164437 deleted 0 documents containing path home acolliso archive newdoc1.html The path seems to be o.k. but next returns false and the doc is not deleted as the following search confirms java org.apache.lucene.demo.SearchFiles Query white dwarfs black holes Searching for white dwarfs black holes 2 total matching documents 0. home acolliso archive newdoc.html 1. home acolliso archive newdoc1.html The I modified the delete code as noted in the original report and tried delete again java org.apache.lucene.demo.DeleteFile home acolliso archive newdoc1.html Path to delete home acolliso archive newdoc1.html Term path home acolliso archive newdoc1.html Got next doc ...false Term docs 164437 deleted 1 documents containing path home acolliso archive newdoc1.html And to see if the document really was deleted I did the search again java org.apache.lucene.demo.SearchFiles Query white dwarfs black holes Searching for white dwarfs black holes 1 total matching documents 0. home acolliso archive newdoc.html Which makes it seem that the doc was successfully deleted. If there is any other info I can provide that would help or could provide in a different format I m happy to provide it. Or if this really ought to go to the distro list instead I m happy to do that as well. Thanks The path field is tokenized so you cannot use a TermQuery with the path name to identify the document. I keep this bug open as the demo is misleading in this regard. Thatå«s it. Daniel is right. Maybe the Demo code should be changed and the path field should not be tokenized. 1. It doesn t make sense to have a tokenied path. It just confuses people. Want to change that Daniel The demo has been modified so that using it should be easier.
