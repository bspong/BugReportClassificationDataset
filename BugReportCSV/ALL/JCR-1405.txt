SPI Introduce NodeInfo.getChildInfos 
Improvement suggested by Marcel ChildInfo is basically a stripped down NodeInfo. With little effort it would even be possible to have NodeInfo extends ChildInfo. Not sure how useful that is but since we don t have that inheritance in code and at the same time nearly a 100 overlap it makes me suspicious. Here s another idea introduce a method ChildInfo NodeInfo.getChildInfos . The method either returns - all child infos which also gives the correct number of child nodes. this may also mean that an empty array is returned to indicate there are no child nodes. - null to indicate that there are lots of child nodes and the method RepositoryService.getChildInfos with the iterator should be used. I m in favor of Angela s suggestion. I would generalize the meaning of null returned by ChildInfo NodeInfo.getChildInfos to ask me later . That is whenever ChildInfo NodeInfo.getChildInfos returns null the spi implementation cannot or for some reason deliberately does not want to return the ChildInfos. The client would then have to collect the ChildInfos later by a call to RepositoryService.getChildInfos. Also I think the client should use the ChildInfos returned by NodeInfo.getChildInfos whenever possible. It should only call RepositoryService.getChildInfos when absolutely necessary. I m in favor of Angela s suggestion credit is due to marcel. and i would support the more general interpretation of the null return value suggested by michael. initial draft for NodeInfo.getChildInfos . differences compared to the initial suggestion 1 Don t let NodeInfo extend ChildInfo I looked at this as well. But the only overlapping method that could be removed from NodeInfo would be getIndex . After thinking about it again i came to the conclusion that ChildInfo actually has a different meaning that ItemInfo... and eventually it s name is wrong or there would have been much better ways to solve the issue that led to ChildInfo. Still what it actually is from my point of view is A relative of the NodeId. The problem with NodeId it may not reveal the name and the index of a Node and can therefore not be used for hierarchical purposes. 2 Return-Value Iterator. For consistency reasons i changed the return value from array to iterator. All of the following methods that could be compared to the new one - NodeInfo.getPropertyIds - RepositoryService.getChildInfos - RepositoryService.getItemInfos return an Iterator. While thinking about it i remembered that we once decided that we d rather user iterators for anything that most certainly will contain more than just a couple more or less limited amount of entries. I adjusted spi-commons spi2jcr and jcr2spi. It compiles tests passed but i didn t have time to really test it or write a reasonable test-case. i quickly had a look at the sandbox spi as well... there it only affected spi2dav and the modifications were really trivial . please comment angela   1 for using an iterator 1 for the patch. There is a typo in the comment Return the all code ChildInfo code .Hm no exceptions allowed none of the other methods allows exceptions......which I think is a problem as well. In this case the related method on RepositoryService does declare RepositoryException. So what am I supposed to do when internally an error occurs Julian wrote So what am I supposed to do when internally an error occurs I think you should not even create a NodeInfo in that case. IMO a NodeInfo should be self contained and shouldn t hold resources tied to the underlying repository. That s actually also a reason why I don t like changing the return values to an Iterator Whenever Iterators are returned it implies that an implementation is allowed or even encouraged to lazily retrieve the items. This lazy approach however has some issues. See also JSR 283 mailing list thread I whish there was .... . This new method is not intended to return large amounts of ChildInfos that are lazily instanciated and should therefore use an array. I think you should not even create a NodeInfo in that case. IMO a NodeInfo should be self contained and shouldn t hold resources tied to the underlying repository. I disagree with that. But anyway even if it did not an error could occur while building the list of children. I m really not sure why we re pretending that things always will work when they may not. There may be other problems like these where I currently have to throw unchecked exceptions will have to check for that. That s actually also a reason why I don t like changing the return values to an Iterator Whenever Iterators are returned it implies that an implementation is allowed or even encouraged to lazily retrieve the items. This lazy approach however has some issues. See also JSR 283 mailing list thread I whish there was .... . I think it s a feature to allow lazy construction we just need to make sure we handle all cases well.   This new method is not intended to return large amounts of ChildInfos that are lazily instanciated and should therefore use an array. Sounds kind of arbitrary to me. What is large And if my store doesn t know beforehand which one does do we really want the SPI impl to return null just for JCR2PI to asking for the same information again through a different method call julian if you cant determine the childinfos upon creating the nodeinfo you should as stated by the javadoc simply return null if you cant build the nodeinfo due to some exceptional situation you should throw upon getNodeInfo or getItemInfos respectively. the exception with repositoryservice getChildInfo means the same as the one defined with getNodeInfo or getItemInfos - the target node does not exist any more in the persistent state - the persistent layer cant be accessed or something similar. therefore i am with marcels explanation how nodeinfo should be created and work. in addition if you decide to do some lazy loading of the childinfos upon NodeInfo.getChildInfos or upon RepositoryService.getChildInfos the exception from my point of view is not raised upon building the iterator but upon retrieving the next element.... and there you wont be able to throw repository exception either. regarding large this is just one obvious example what could be a reason for the implementation NOT to reveal the child infos upon NodeInfo.getChildInfos. and the description mentions this as example. that it states if the impl is not willing. Not willing means that the SPI implementations decides upon internal rules whether the childinfos are included or not. examples the impl. decides - based on the internal structure of the persistent layer in general - based the cost of retrieving childinfos given the potential chance of never being asked for - based on the known characteristics of the target node e.g. we have folder and files and other nodes   and we assume that folders will be used for displaying the children so send it. for any other nodes we dont - based on the simple amount of child nodes if we know that dont calc if more than 14 - based on a implementation specific configuration   that could include nodetypes number of child nodes day time session.userId random... whatever   you feel would be appropriate reasonable or simply a good thing for your specific store. the last is pretty much what we discussed for the getItemInfos method for the batch read. we said that we cant add a config to the spi interfaces and want to leave that to the impl because we would not be able to find something that fits the needs for all potential implementations. if your store cant retrieve the child info you may - create your reposervice with a config and leave the decision to someone else - always calculate the child infos - never calculate the child infos - decide based on the characteristics of the requested node -... see above so. i am not in favor of adding exceptions to the new method... at least not for the reasons presented so far. angela what s the status here can should we extend the NodeInfo interface as suggested I m in favour of the patch as it is. That is add getChildInfos to NodeInfo with the following semantics If NodeInfo.getChildInfos returns null jcr2spi must call RepositoryService.getChildInfos to determine the children of the current node. Otherwise jcr2spi must not I can also live with should not call RepositoryService.getChildInfos . Separate calls to RepositoryService.getChildInfos result in additional round-trips in cases where the persistence layer returns the children infos along with a node.Patch updated to latest revisionI tested Angela s initial patch and updated it to the latest revision. The patch works well. In may case it helps to cut down the number of round-trips to the back-end store significantly In my test case including the ChildInfos within NodeInfo results in 4 calls to RepositoryService.getItemInfos and in no calls to RepositoryService.getChildInfos at all. Not including them results in the same 4 calls to RepositoryService.getItemInfos and additionally in 15 calls to RepositoryService.getChildInfos . Since the patch does not change existing semantics just return null for NodeInfo.getChildInfos but on the other hand has the potential to vastly increase performance in some common case I d very much like to see this patch applied.ok.... if nobody objects within the next couple of days i will apply michaels patch. angelaIf we have evidence that it actually helps in some cases .5. That being said I think it would be great if we would base these things on reliable test data that s why I started the jcr-benchmark project after all.
