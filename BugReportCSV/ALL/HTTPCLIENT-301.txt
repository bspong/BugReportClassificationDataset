Cookie rejected
Hello I m using HttpClient 1.0 rc2 to login in the SourceForge website and perform some operations but i m getting the following error Page 1 from https sourceforge.net account login.php 6 dÃ©c. 2003 23 45 27 org.apache.commons.httpclient.HttpMethodBase processResponseHeaders ATTENTION Cookie rejected username l6qpwtK5hpE 3D . Illegal domain attribute .sourceforge.net . Domain of origin sourceforge.net 6 dÃ©c. 2003 23 45 27 org.apache.commons.httpclient.HttpMethodBase readResponseBody The cookie returned by Sourceforge is rejected because the domain for the request was sourceforge.net and the domain for the cookie was .sourceforge.net I have tried to change the cookie policy to all available options but none work. CookiePolicy.setDefaultPolicy CookiePolicy.COMPATIBILITY What can i do Thanks LudovicThis patch solves the problem when using CookieSpecBase COMPATIBILITY diff -r1.20 CookieSpecBase.java 424a425 String cookieDomain cookie.getDomain 430c431 434 if host.endsWith cookie.getDomain add a dot on the domain to match host myhost.net with cookie domain .myhost.net String testHost . host if testHost.endsWith cookieDomain 432c436 Illegal domain attribute cookie.getDomain Illegal domain attribute cookieDomain 436c440 if host.equals cookie.getDomain if host.equals cookieDomain 438c442 Illegal domain attribute cookie.getDomain Illegal domain attribute cookieDomain Ludovic In my opinion the cookie is clearly wrong. Somehow I do not feel like patching HttpClient because of evey single broken cookie out there. Besides your patch seems to fail to take into consideration that cookie domain may be a just a simple host name localhost for instance . Of course I might have missed something after a just cursory examination but your patch does not seem right in that regard. I ll have a closer look at the issue on Monday but at the moment I lean towards not changing HttpClient 2.0 at all. In the next release we ll provide a plug-in mechanism for custom cookie specs which would enable you to accept any kind of broken cookie you please. Cookie spec plug-in mechanism is already implemented in CVS HEAD so feel free to take a look. Regards OlegOleg I understand your reluctance to apply the patch it can create more issues than good. I ve tried to use the HEAD release and the cookie plugin mecanism works well. It seems that you cannot use any other type than DEFAULT but that s just a small issue. Poka LudovicHello Ludovic HttpClient works correctly in this case. RFC 2965 defines in section 1 the comparison operations on hosts and domain names. The host sourceforge.net is not matched by the domain .sourceforge.net and therefore the cookie is rejected. The best fix would be to change your target URL to use a host within the domain .sourceforge.net like https www.sourceforge.net account login.php https login.sourceforge.net account login.php https whatever.sourceforge.net account login.php Sourceforge indeed has an inappropriate login link on their page but I cannot imagine they don t have a hostname that can be preprended. You should ask them to chance their default login link accordingly. regards   RolandHi Ludovic I agree with Roland. The problem really lies with sourceforge and most likely there is another login URL with an appropriate domain. As for custom cookie policies you should be able to register and use another cookie policy using something like CookiePolicy.registerCookieSpec mycookies someCookieSpec HttpMethod someMethod ... someMethod.getParams .setCookiePolicy mycookies Please let us know if this doesn t work properly. MikeFolks I think we all agree that the cookie is broken and the problem lies with sourceforge but the real trouble is that browsers as well as so called browsers developed by THAT very innovative company in particular seem to have no problem accepting such cookies. The question is if we should treat such cookies as valid ones when in browser compatibility mode OlegOleg I think we should make an attempt to be as forgiving as possible when in compatibility mode with the exception of places where there are security considerations. I ve been looking at the spec and the definition of the domain-match function is pretty vague. The general wisdom seems to indicate that domain.com should not match .domain.com but I think allowing it is pretty safe from a security standpoint. I ve also noticed that the current domain match implementation matches y.x.foo.com with .foo.com though this is explicitly disallowed in the RFC. We need to fix this one for sure. MikeHello Mike are you sure about the domain-matching thing Here s a snippet from RFC 2965 section 1 page 1 Note that domain-match is not a commutative operation a.b.c.com domain-matches .c.com but not the reverse. But here is something from section 3.2.2 page 5 Domain value OPTIONAL. The value of the Domain attribute specifies the domain for which the cookie is valid. If an explicitly specified value does not start with a dot the user agent supplies a leading dot. So it seems it is an HttpClient bug after all. We have to add the missing dot when cookies are parsed. cheers   Roland Please ignore my last comment about the cookie parsing. I mixed up the cookie domain and the host. The cookie is parsed correctly the problem lies with the hostname. However I do wonder whether there is some redirect involved. If sourceforge.net sends a redirect to www.sourceforge.net the redirect is chased by HttpClient and www.sourceforge.net sends a cookie for domain .sourceforge.net will that cookie be verified against host sourceforge.net or against host www.sourceforge.net I m just guessing here. I don t have a sourceforge account to verify the behaviour. I just find it hard to imagine that browsers actually accept a cookie outside of the host s domain. Browser makers have gotten a lot of public beating for security bugs lately and I d consider this to be one. I ve also noticed that the current domain match implementation matches y.x.foo.com with .foo.com though this is explicitly disallowed in the RFC. We need to fix this one for sure. Mike In RFC2109 cookie spec domain match is implemented correctly. However in browser compatibility mode I do not think we should change the way domains are matched as the RFC compliance was relaxed a year ago precisely in order to mimic the logic or lack thereof of mainstream browsers. Someone even took a look at Mozilla s source code to double-check on that. Roland I still must have a dormant Sourceforce account. I ll take a closer look at the Sourceforce login procedure and provide a patch for our browser compatibility cookie spec if required OlegOleg You are quite right. I missed the code in RFC2109. I look forward to seeing what happens with SF. MikeLudovic Would it be possible for you to post the code you are using to connect to sourceforge.net I am trying to reproduce the problem but cannot even get the site to send that damn cookie OlegThe code is here have a look to the login method in FileReleaseSystemBean. The trick is to hit Sourceforge first with a GET method then send the POST method with the login information. http cvs.sourceforge.net viewcvs.py maven-plugins maven-plugins sourceforge src main net sourceforge mavenplugins sourceforge FileReleaseSystemBean.java rev 1.1 view auto http cvs.sourceforge.net viewcvs.py maven-plugins maven-plugins sourceforge src main net sourceforge mavenplugins sourceforge WebBrowser.java rev 1.1 view autoOK. I got the cookie actually the trick was login parameter which I initially omitted. The HTTP get was not necessary . DEBUG wire - - HTTP 1.1 302 Found r n DEBUG wire - - Date Mon 15 Dec 2003 22 41 07 GMT r n DEBUG wire - - Server Apache 1.3.27 Unix PHP 4.3.2 mod ssl 2.8.12 OpenSSL 0.9.6b r n DEBUG wire - - X-Powered-By PHP 4.3.2 r n DEBUG wire - - X-Accelerated-By PHPA 1.3.3r2 r n DEBUG wire - - Expires Wed 11 Nov 1998 11 11 11 GMT r n DEBUG wire - - Cache-Control must-revalidate r n DEBUG wire - - Set-Cookie session ser xxxxxx path r n DEBUG wire - - Set-Cookie username xxxxx expires Mon 22-Dec-03 22 41 07 GMT path domain .sourceforge.net r n DEBUG wire - - Set-Cookie persist session g0K8qFjTnIg 3D expires Tue 14-Dec-04 22 41 07 GMT path r n DEBUG wire - - Location https sourceforge.net account redir.php stay in ssl 1 return to 2Fmy 2F r n DEBUG wire - - Connection close r n DEBUG wire - - Transfer-Encoding chunked r n DEBUG wire - - Content-Type text html r n Bottom-line the cookie clearly violates the RFC however Mozilla does not seem to care. Even though I do not quite like it I ll provide a patch for the browser compatibility spec. OlegCreated an attachment id 9599 Patch against 2.0 take 1 Patch committed to CVS HEAD and 2.0 Oleg
