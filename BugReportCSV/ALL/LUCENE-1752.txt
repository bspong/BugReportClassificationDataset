incorrect snippet returned with SpanScorer
This problem was reported by my customer. They are using Solr 1.3 and uni-gram but it can be reproduced with Lucene 2.9 and WhitespaceAnalyzer. Query f1 a b c d OR f2 a b c d AND f1 b c g OR f2 b c g The snippet we expected is x y z B a B B b B B c B B d B e f g B b B B c B B g B but we got x y z B a B b c B d B e f g B b B B c B B g B Program to reproduce the problem public class TestHighlighter static final String CONTENT x y z a b c d e f g b c g static final String PH1 a b c d static final String PH2 b c g static final String F1 f1 static final String F2 f2 static final String F1C F1 static final String F2C F2 static final String QUERY STRING F1C PH1 OR F2C PH1 AND F1C PH2 OR F2C PH2 static Analyzer analyzer new WhitespaceAnalyzer public static void main String args throws Exception QueryParser qp new QueryParser F1 analyzer Query query qp.parse QUERY STRING CachingTokenFilter stream new CachingTokenFilter analyzer.tokenStream F1 new StringReader CONTENT Scorer scorer new SpanScorer query F1 stream false Highlighter h new Highlighter scorer System.out.println query QUERY STRING System.out.println h.getBestFragment analyzer F1 CONTENT The patch looks good Thanks Mark. I think the customer will test the patch with their data on uni-gram environment on Monday. I ll report back. Thanks again. The patch was tested on their environment and the problem was solved. 1 for committing the patch. Thanks Mark. I d like set 2.9. With the patch highlighter works on our production environment perfectly. Thanks Koji - I had forgotten about this one. I ll commit it in a bit. Thanks Koji 
