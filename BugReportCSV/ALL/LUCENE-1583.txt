SpanOrQuery skipTo doesn t always move forwards
In SpanOrQuery the skipTo method is improperly implemented if the target doc is less than or equal to the current doc since skipTo may not be called for any of the clauses spans public boolean skipTo int target throws IOException if queue null return initSpanQueue target while queue.size 0 top .doc target if top .skipTo target queue.adjustTop else queue.pop return queue.size 0 This violates the correct behavior as described in the Spans interface documentation that skipTo should always move forwards in other words the correct implementation would be public boolean skipTo int target throws IOException if queue null return initSpanQueue target boolean skipCalled false while queue.size 0 top .doc target if top .skipTo target queue.adjustTop else queue.pop skipCalled true if skipCalled return queue.size 0 return next LUCENE-1327 was a similar issue. I havn t looked closely at it yet but tests appear to pass unknown if tests actually hit skipto on SpanOrQuery though I guess I ll do this one. You out there reading Paul Elschot This look right to you Any issues it might cause Else I guess I ll have to put on my thinking cap and figure it myself. Midnight here still reading The patch looks good. However it might be easier to understand by starting like this after the queue initialisation if next return false and leave the rest of the code as it is. I did not run any tests on this so a thinking cap might well save time. That change would always call next once before skipping though right And the way the patch is you would only call next if no skipping occurred I know its semantically the same and I guess the clarity is probably worth any probably extremely minor slowdown I m going to commit this soon. Adds a Unit test and Changes entry Thanks Moti 
