TestNRTThreads test failure
hit a fail in TestNRTThreads running tests over and over junit Testsuite org.apache.lucene.index.TestNRTThreads junit Testcase testNRTThreads org.apache.lucene.index.TestNRTThreads FAILED junit expected 8 but was 18 junit junit.framework.AssertionFailedError expected 8 but was 18 junit at org.apache.lucene.index.TestNRTThreads.testNRTThreads TestNRTThreads.java 515 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1362 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1280 junit junit junit Tests run 1 Failures 1 Errors 0 Time elapsed 19.812 sec junit junit Standard Output junit doc id 157 is supposed to be deleted but got docID 119 junit doc id 82 is supposed to be deleted but got docID 68 junit doc id 83 is supposed to be deleted but got docID 38 junit doc id 80 is supposed to be deleted but got docID 36 junit doc id 81 is supposed to be deleted but got docID 37 junit doc id 67 is supposed to be deleted but got docID 24 junit doc id 69 is supposed to be deleted but got docID 26 junit doc id 68 is supposed to be deleted but got docID 25 junit doc id 672 is supposed to be deleted but got docID 430 junit doc id 444 is supposed to be deleted but got docID 344 junit doc id 441 is supposed to be deleted but got docID 766 junit doc id 442 is supposed to be deleted but got docID 343 junit doc id 443 is supposed to be deleted but got docID 767 junit doc id 70 is supposed to be deleted but got docID 67 junit doc id 71 is supposed to be deleted but got docID 27 junit doc id 72 is supposed to be deleted but got docID 28 junit doc id 73 is supposed to be deleted but got docID 29 junit doc id 74 is supposed to be deleted but got docID 30 junit doc id 75 is supposed to be deleted but got docID 31 junit doc id 76 is supposed to be deleted but got docID 32 junit doc id 219 is supposed to be deleted but got docID 175 junit doc id 662 is supposed to be deleted but got docID 425 junit doc id 663 is supposed to be deleted but got docID 426 junit doc id 218 is supposed to be deleted but got docID 174 junit doc id 361 is supposed to be deleted but got docID 286 junit doc id 362 is supposed to be deleted but got docID 287 junit doc id 360 is supposed to be deleted but got docID 285 junit doc id 366 is supposed to be deleted but got docID 291 junit doc id 365 is supposed to be deleted but got docID 290 junit doc id 364 is supposed to be deleted but got docID 289 junit doc id 363 is supposed to be deleted but got docID 288 junit doc id 368 is supposed to be deleted but got docID 293 junit doc id 367 is supposed to be deleted but got docID 292 junit doc id 518 is supposed to be deleted but got docID 361 junit doc id 517 is supposed to be deleted but got docID 805 junit doc id 220 is supposed to be deleted but got docID 176 junit doc id 324 is supposed to be deleted but got docID 269 junit doc id 322 is supposed to be deleted but got docID 268 junit junit Standard Error junit NOTE reproduce with ant test -Dtestcase TestNRTThreads -Dtestmethod testNRTThreads -Dtests.seed 0 0 junit NOTE test params are codec RandomCodecProvider extra8 MockFixedIntBlock blockSize 1054 extra9 MockVariableIntBlock baseBlockSize 87 body MockSep extra0 MockVariableIntBlock baseBlockSize 87 packID Pulsing freqCutoff 16 extra1 MockRandom extra2 Standard extra3 SimpleText date MockVariableIntBlock baseBlockSize 87 extra4 MockSep extra5 Pulsing freqCutoff 16 extra6 MockFixedIntBlock blockSize 1054 extra7 MockVariableIntBlock baseBlockSize 87 docid MockVariableIntBlock baseBlockSize 87 title SimpleText titleTokenized Standard locale ar JO timezone Europe Oslo junit NOTE all tests run in this JVM junit TestSearchForDuplicates TestMockAnalyzer TestCheckIndex TestDoc TestFlex TestIndexReaderCloneNorms TestIndexWriterExceptions TestIndexWriterUnicode TestMultiLevelSkipList TestNRTThreads junit NOTE Mac OS X 10.6.7 x86 64 Apple Inc. 1.6.0 24 64-bit cpus 4 threads 1 free 41147720 total 85000192 junit junit TEST org.apache.lucene.index.TestNRTThreads FAILED on my machine this one is tough to reproduce. if I run the test by itself it seems to pass. however if my machine is busy e.g. running ant test-core -Dtests.seed 0 0 then it fails It s probably the new DWPT code. There was a specific issue to fix this problem LUCENE-2956. phew This seems like a delete issue. I only looked at the output robert posted so far but it seems that a FrozenDelPackage gets lost somewhere here.... I will look after buzzwords I can reproduce this easily and even if I set search threads to 0 and index threads to 1. I forced the IW to use OpenMode.CREATE and suddenly the tests are not failing anymore. It seems that the tempdir is not cleaned up since always the second test fails for me but never the first run. this is not a DWPT issue phew the test cleans itself up in afterClass so there is in fact an issue. taking a look at this I don t like the way TestUtil.getTempDir String desc was working before... it was basically desc LTC.random.nextInt xxx so if you wired the seed like I did and somehow stuff doesnt totally clean up then its easy to see how it could return an already-created dir. I changed this method to use TestUtil.createTempFile... I think this is much safer. robert can you still reproduce or can we close this issue here i could never really reproduce... but sometimes if i ran all tests with -Dtests.seed 0 0 it would happen. the reason this test is not reproducible is that this test uses n seconds as a limit. so whether it passes or fails depends upon what your computer is doing at the moment. I think we must change it to limit itself by number of docs instead. I think we must change it to limit itself by number of docs instead. I agree let s fix that. this was a temp file issue - fixed
