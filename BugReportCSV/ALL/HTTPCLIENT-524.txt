Provide feedback mechanism to CredentialsProvider
If the remote server is using BASIC or NT authentication and you pass in invalid credentials you get stuck in an infinite for loop repeatedly sending the same authentication request again and again to the server. The for loop is in the executeMethod method of the HttpMethodDirector class. Sample code import org.apache.commons.httpclient.Credentials import org.apache.commons.httpclient.NTCredentials import org.apache.commons.httpclient.UsernamePasswordCredentials import org.apache.commons.httpclient.HttpClient import org.apache.commons.httpclient.methods.GetMethod import org.apache.commons.httpclient.auth. import java.io.IOException import java.io.BufferedInputStream import java.io.ByteArrayOutputStream   Created by IntelliJ IDEA.   User dmartineau   Date Nov 8 2005   Time 1 43 21 PM   public class ShowProblem     private String location     private String user     private String pass     private String domain     public ShowProblem String location String user String pass String domain              this.location location         this.user user         this.pass pass         this.domain domain          public int getFile              int status 500         HttpClient client new HttpClient         client.getParams .setParameter             CredentialsProvider.PROVIDER new CProvider user pass domain         GetMethod httpget new GetMethod location         httpget.setDoAuthentication true         try                       execute the GET             status client.executeMethod httpget             if status 200                              BufferedInputStream bin new BufferedInputStream httpget.getResponseBodyAsStream                 ByteArrayOutputStream bos new ByteArrayOutputStream                 int bytesRead 0                 byte buff new byte 16384                 while bytesRead bin.read buff -1                     bos.write buff 0 bytesRead                                   display the results.                 System.out.println new String bos.toByteArray                               catch Throwable t                      t.printStackTrace                  finally                       release any connection resources used by the method             httpget.releaseConnection                  return status          public static void main String args              ShowProblem showProblem new ShowProblem args 0 args 1 args 2 args 3         int response showProblem.getFile                   class CProvider implements CredentialsProvider              private String user         private String password         private String domain         public CProvider String user String password String domain                      super             this.user user             this.password password             this.domain domain                  public Credentials getCredentials final AuthScheme authscheme final String host int port boolean proxy         throws CredentialsNotAvailableException                      if authscheme null                              return null                          try                              if authscheme instanceof NTLMScheme                                      return new NTCredentials user password host domain                                  else if authscheme instanceof RFC2617Scheme                                      return new UsernamePasswordCredentials user password                                  else                                      throw new CredentialsNotAvailableException Unsupported authentication scheme                         authscheme.getSchemeName                                           catch IOException e                              throw new CredentialsNotAvailableException e.getMessage e                            David Please see javadocs 1 HttpClient makes no provisions to check whether the same credentials have been tried already. It is a responsibility of the custom credentials provider to keep track of authentication attempts and to ensure that credentials known to be invalid are not retried. HttpClient will simply store the set of credentials returned by the custom credentials provider in the http state object and will attempt to use these credentials for all subsequent requests with the given authentication scope. 1 http jakarta.apache.org commons httpclient apidocs org apache commons httpclient auth CredentialsProvider.html It is a responsibility of the custom credentials provider to keep track of authentication attempts and to ensure that credentials known to be invalid are not retried. Will invalid credentials be indicated to the credentials provider The interface was introduced to implement user dialogs but it seems to be used for non-interactive credential stores on a regular basis. Of course we won t change the 3.0 API but we should keep that in mind for 4.0 or maybe even 3.1. Indicates that credentials have been rejected by a host or proxy. public void invalidCredentials AuthScheme String host int port                                boolean proxy Credentials cheers   RolandI ve since recoded by modifying my credentials provider and all is well. I added a boolean to check to see if the getCredentials method had been called already and if so return null which terminated the loop. If anything this revealed shortcomings with tomcat BASIC authentication since the endless loop repeatedly hammered my authenitication class on the web server- - but perhaps thats a limitation of the http protocol or something that would be intercepted by the firewall in production. The code sample I had initially used copied from was in fact the call-back code which got the credentials from the command-line I believe the sample code may be part of the distribution . Perhaps that code should be updated to show how to terminate after 3 unsuccessful logins. D. In reply to comment 2 It is a responsibility of the custom credentials provider to keep track of authentication attempts and to ensure that credentials known to be invalid are not retried. Will invalid credentials be indicated to the credentials provider The interface was introduced to implement user dialogs but it seems to be used for non-interactive credential stores on a regular basis. Of course we won t change the 3.0 API but we should keep that in mind for 4.0 or maybe even 3.1. Indicates that credentials have been rejected by a host or proxy. public void invalidCredentials AuthScheme String host int port boolean proxy Credentials cheers Roland Roland This issue highlights the problem that we kept on adding features to HttpClient at the expense of API quality. We need to take a hard look at the whole HttpState Credentials story in the course of 4.0 API redesign. OlegIt would be nice for instance to use the JAAS javax.security.auth.callback classes for this. Let the user register a CallbackHandler with HttpClient. HttpClient then sends Callbacks to the CallbackHandler if it needs something.The way HttpClient handles authentication has completely changed in the 4.0 codeline. 1 HttpState has been eliminated and its function has been replaced with CredentialsProvider interface. One can now easily plug in a custom implementation of that interface. 2 HttpClient now maintains an internal authentication state. I will retry the authentication process only if the credentials provider returns a different set of credentials in response to an authentication failure thus avoiding an infinite loop . 3 Credentials providers are no longer expected to provide interactivity with the user. This logic should be implemented outside of the request execution loop. See sample http svn.apache.org repos asf jakarta httpcomponents httpclient trunk module-client src examples org apache http examples client ClientInteractiveAuthentication.java Olegthe sample is now in http svn.apache.org repos asf httpcomponents httpclient trunk module-client src examples org apache http examples client ClientInteractiveAuthentication.java see also http issues.apache.org jira browse HTTPCLIENT-831
