BooleanScorer2 fails to update this.doc when its the top scorer
When BooleanScorer2 runs the top collection loop one of its score Collector methods it uses a local doc var ie public void score Collector collector throws IOException collector.setScorer this int doc while doc countingSumScorer.nextDoc NO MORE DOCS collector.collect doc The problem is if the child collector calls scorer.doc it will always get -1. Most Collectors don t actually call scorer.doc but one important one that does is ScoreCachingWrapperScorer as it uses the doc to know when to invalidate its cache. Since this always returns -1 the ScoreCachingWrapperScorer keeps returning score 0.0 to its caller thus messing up a SortField.SCORE comparator instance if it s included in the sort fields. Attached patch including Shalin s test case thanks which fails on trunk plus the fix that resolves it. I plan to commit shortly. Thanks Shalin good catch. I think this was before one of the issues forgot which where I added doc as a member to BS2.
