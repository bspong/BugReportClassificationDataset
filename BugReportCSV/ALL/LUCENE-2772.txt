Make SlowMultiReaderWrapper wrap always so close is safe
The overhead when wrapping an atomic reader using SlowMultiReaderWrapper is very low the work done in the static wrap method is much higher instantiate ArrayList recusively went through all subreaders just to check the number of readers than simply always wrapping. MultiFields already is optimized when called by one-segment or atomic readers so there is no overhead at all. So this patch removes the static wrap method and you simply wrap like a TokenFilter with ctor new SlowMultiReaderWrapper reader When this is done there is also no risk to close a SegmentReader which you should not do when wrap returns a single SegmentReader. This help in parent issue with cleaning up the case in close . The patch ašlso removes the now useless mainReader reader variables and simply closes the wrapper. Here the patch When SlowMultiReaderWrapper will in future clean up the cache on close the tests should not simply only close inner reader but instead close wrapper reader which only delegates currently . This is also the only correct usage for Decoration pattern see TokenFilter co. TestFilterIndexReader had a bug when the source index has more than one segment this is fixed now because we always wrap and wrapped reader delegates close. Looks great Uwe Committed revision 1037294
