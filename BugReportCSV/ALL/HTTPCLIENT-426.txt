httpclient doesn t read and parse response from certain types of proxy servers when POST method is used
It was determined that when sending post data to server via Squid proxy server of version 2.4.STABLE2 and Squid responds with 407 proxy authentication required response httpclient doesn t read this response in order to parse but rather fails with soket exception java.net.SocketException Software caused connection abort recv failed . This behaviour is reproduced with the latest nigtly build of httpclient version 3.0. from 9 of February 2005 as well as 3.0. RC1 2.0.2 and 2.0. This is the piece of code that sends post data using httpclient try HttpClientParams httpClientParams new HttpClientParams HttpClient client new HttpClient httpClientParams HostConfiguration hostconfig new HostConfiguration hostconfig.setProxy db00-devl.eps.agfa.be 3128 SQUID proxy server version 2.4.STABLE2 client.setHostConfiguration hostconfig PostMethod postMethod new PostMethod http brugge.eps.agfa.be portal03 servlet selectFiles postMethod.addParameter data some data int status client.executeMethod postMethod System.out.println status status if status HttpStatus.SC OK System.out.println Ok else if status HttpStatus.SC PROXY AUTHENTICATION REQUIRED System.out.println Proxy authentication required. catch Exception e System.out.println Socket exception. e.printStackTrace Look at debug log of the problem attachment to see all output from httpclient and mentioned piece of code. In problem request response interaction attacment it is possible to see interaction beetween httpclient and Squid proxy server httpclient sends initial request and headers then squid responds with proxy authentication required response and afterwards httpclient tries to send post data without reading the response but fails because connection is already closed. For more details look at ethereal problem attachment for all network traffic during running of mentioned piece of code Ethereal protocol analyzer can be used to open this file http www.ethereal.com . Most likely this particular version of Squid closes connection after it sends proxy athentication response back which causes httpclient to fail while sending post data. Let s have a look at what writeRequest ... method of HttpMethodBase class does 1 sends request line and headers to server 2 handles Expect 100-continue handshake if needed 3 sends post data to server. My question is should HTTPClient send initial request and headers before data even if it is not going to read a response from the server proxy server or this should be done only in case of Expect 100-continue handshake this seems the only case when HTTPClient is going to listen to server in-between of steps 1 and 3 My understanding is that the command          make sure the status line and headers have been sent         conn.flushRequestOutputStream          which actually splits sending of data in two parts are needed only for Expect 100-continue handshake case. Just by moving flush command to appropriate place inside Expect 100-continue handshake case .....                 try conn.flushRequestOutputStream moved                     conn.setSocketTimeout RESPONSE WAIT TIME MS ..... it is posible to solve described problem. I created PostMethodEx that overrides writeRequest ... method of HttpMethodBase look at PostMethodEx attachment and for all cases but the Expect 100-continue handshake it sends request line headers and post data to server at once. When mentioned piece of code with PostMethod changed to PostMethodEx is executed everyting works fine look at debug log of the fix fix request response interaction and ethereal fix all network trafic attachments. According to mentioned logs httpclient sends all post data at once and then reads and parses proxy authentication required response from squid and sets status code to 407. Correct.Created an attachment id 14223 debug log of the problem Created an attachment id 14224 problem request response interaction Created an attachment id 14225 ethereal problem ethereal log http www.ethereal.com Created an attachment id 14226 PostMethodEx Created an attachment id 14227 debug log of the fix Created an attachment id 14228 fix request response interaction Created an attachment id 14229 ethereal fix ethereal is required to view this file Created an attachment id 14230 ethereal fix ethereal is required to view this file Fair enough. A patch to follow shortly. OlegCreated an attachment id 14234 Patch take 1 Folks let me know what you think. If I hear no loud complaints I ll commit the patch in a few days. OlegThanx a lot PeterWhat is going to happen if the POST data exceeds the buffer size Will the socket be closed after the first buffer flush leading to a write error while the rest of the data is posted The patch is fine for the reported problem. I am just curious whether we may have hit a more fundamental problem. Of course we can always tell people to use expect-continue when posting large data. cheers   RolandWeird bug. It seems like fundamental functionality is broken. Is this not covered by any test case Cmon folks This issue has been beaten to death on more than one occasion. See HTTPCLIENT-123 OlegOkay Oleg but here it s the proxy not the final server. Anyway does this happen when using 100-continue handshake If the proxy correctly implements 100-continue handshake it should not happen OlegPatch committed. Many thanks Peter OlegYou Welcome Peter.
