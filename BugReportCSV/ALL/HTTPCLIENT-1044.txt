DefaultHttpRequestRetryHandler is not handling PUT as an idempotent method for retries though RFC2616 section 9.1.2 clearly defines it to be one.
See attached patch file for a fix Fix treats PUT requests as idempotent marking them to be retried when their enclosed HttpEntity is either null or repeatable. Here s the patchSteffen While PUT methods should be idempotent in real life often they are not. This change may potentially break existing applications in very nasty ways. My personal preference would be to not apply this change. OlegClosing as WONTFIX. I would like to keep the default implementation more idiot-proof. Applications whose PUT methods are known to be idempotent can still provide a custom implementation of HttpRequestRetryHandler to have PUT methods retried automatically. OlegHi Oleg Thanks for considering my patch and sorry for the long turn around in getting back to you. I think there is value in uniform application non-application of the RFC s rules here To demonstrate what I mean I believe I can make a statement equally valid to your first comment with respect to the GET method. While GET methods should be limited to actions of retrieval and be idempotent in real life often they are not. The current implementation may already be breaking existing applications in very nasty ways. Some common examples of GET method usage diverging from spec in this way html form submissions RPC based APIs over HTTP tracking pixel requests JSONP APIs hack for cross domain scripting limitations . I don t think the RFC s idempotence rules should be selectively respected on some HTTP methods and not on others without really good reasons . Do or do not as Yoda would say. - The current implementation retries GET HEAD DELETE OPTIONS and TRACE assuming idempotence. It is better to keep the default implementation more idiot-proof I agree with your assessment that assuming idempotence and unintentionally retrying non-idempotent requests can break applications in very nasty ways . The nastiest of these ways are in debugging what went wrong since a the failure modes that lead to retries are rarely replicated or tested by app developers and b many novice developers lack the insight to understand the value of idempotent implementations and to identify idempotence non-idempotence related bugs. Considering that automatic retries are optional as far as the RFC is concerned and considering the two points above I m on board with your assessment that the default behavior of the DefaultHttpRequestRetryHandler shouldn t be to retry PUT methods automatically. But I also think this reasoning should be taken one step further in the interest of uniformity and idiot-proofing the default behavior shouldn t be using RFC defined method idempotence to enable disable automatic retries on any of the HTTP methods. Still I think it would be great for the HttpClient libraries to provide an out of the box HttpRequestRetryHandler that uses the RFC2616 s rules for HTTP method idempotence to enable disable automatic retries. Sure it is true that I can use a custom implementation of HttpRequestRetryHandler. But the supported behavior I m asking for here isn t something crazy. It s something that should work in apps that respect the RFC2616 s rules for HTTP method idempotence and it is something that could be provided out of the box. I ve provided 2 new alternative patches to make changes in this direction please let me know if either one is acceptable. The changes in HTTPCLIENT-1044 planB.patch are 1. Defaulting to not retry GET HEAD DELETE OPTIONS and TRACE based on assumed idempotence. 2. Adding a check to prevent resending unrepeatable entities that have already been sent once. 3. Removing the requestSentRetryEnabled flag which seemed to be included for specifying entity repeatability and allowed both PUT and POST methods to be resent. 4. Adding a retryIdempotentMethods flag in place of the requestSentRetryEnabled flag. This flag allows GET HEAD PUT DELETE OPTIONS and TRACE methods to be resent. default value false The changes in HTTPCLIENT-1044 planC.patch are 1. Defaulting to not retry GET HEAD DELETE OPTIONS and TRACE based on assumed idempotence. 2. Adding a check to prevent resending unrepeatable entities that have already been sent once. 3. Adding a new DefaultIdempotentHttpRequestRetryHandler class which does allow GET HEAD PUT DELETE OPTIONS and TRACE methods to be resent. Cheers -Steffen 1 The check for the enclosing entity being repeatable is redundant and unnecessary. The responsibility to decide as to whether or not an entity is repeatable lies with the request director. 2 There are many ways people can do silly things. I am aware that some web applications can process GET requests in such a manner that effectively renders them non-idempotent. This is however fairly rare. Entity enclosing methods are more likely to cause issues when retried automatically. The default HttpRequestRetryHandler implementation represents a compromise between requirements of the HTTP spec and tolerance to common misbehaviours by real world applications. 3 I can live with plan C as long as the default HttpRequestRetryHandler implementation remains unchanged and the point 1 is taken into consideration. OlegCool I see now where the RequestDirector is doing that... I ve uploaded HTTPCLIENT-1044 planC v2.patch which implements your suggestions. Is this the best way for me to submit this change Thanks -SteffenYes it is. I ll commit the patch as soon as we have some kind of a release plan for 4.2 or 4.1.1 OlegGreat Thank you -SteffenSteffen I ended up committing a slightly different implementation conceptually similar to the one proposed by you. Please review http svn.apache.org repos asf httpcomponents httpclient trunk httpclient src main java org apache http impl client StandardHttpRequestRetryHandler.java shameless extortion Also feel free to contribute test cases OlegIt looks like the two implementations will produce identical behaviors. For the choice of class name I like your name StandardHttpRequestRetryHandler better. Also I think your choice of positively identifying the idempotent methods rather than checking for not-a-POST like I did makes the code much cleaner to read... almost self documenting - I m happy with your implementation. Thank you for spending time on this issue While your extortion does make me feel guilty and I know I would probably be a better programmer if I figured out how to integrate with the test framework I still don t see myself getting around to writing test cases for this anytime soon... Sorry about that it s a really busy quarter for me... Cheers and thanks again -Steffen
