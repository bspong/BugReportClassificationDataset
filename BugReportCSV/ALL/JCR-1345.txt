ClassCastException when updating properties using WebDAV
When issuing PROPPATCH commands a ClassCastException is raised. e.g. PROPPATCH jackrabbit-webapp-1.4 repository default test test file v.txt HTTP 1.1 Host localhost 9000 Connection TE TE trailers deflate gzip compress User-Agent UCI DAV Explorer 0.91 RPT-HTTPClient 0.3-3E Translate f Authorization Basic Y3Jvc3NqYTp0ZXN0 Accept-Encoding deflate gzip x-gzip compress x-compress Content-type text xml Content-length 170 A propertyupdate xmlns A DAV A set A prop A auto-version checkout-checkin A auto-version A prop A set A propertyupdate results in 24.01.2008 15 38 34 ERROR Webdav Servlet.service for servlet Webdav threw  exception StandardWrapperValve.java line 257 java.lang.ClassCastException org.apache.jackrabbit.webdav.property.DefaultDavPr operty         at org.apache.jackrabbit.webdav.simple.DavResourceImpl.alterProperties D avResourceImpl.java 456         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.doPropPatch AbstractWebdavServlet.java 457         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.execute Abs tractWebdavServlet.java 234         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.service Abs tractWebdavServlet.java 192         at javax.servlet.http.HttpServlet.service HttpServlet.java 803         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter Appl icationFilterChain.java 269         at org.apache.catalina.core.ApplicationFilterChain.doFilter ApplicationF ilterChain.java 188         at org.apache.catalina.core.StandardWrapperValve.invoke StandardWrapperV alve.java 210         at org.apache.catalina.core.StandardContextValve.invoke StandardContextV alve.java 174         at org.apache.catalina.core.StandardHostValve.invoke StandardHostValve.j ava 127         at org.apache.catalina.valves.ErrorReportValve.invoke ErrorReportValve.j ava 117         at org.apache.catalina.core.StandardEngineValve.invoke StandardEngineVal ve.java 108         at org.apache.catalina.connector.CoyoteAdapter.service CoyoteAdapter.jav a 151         at org.apache.coyote.http11.Http11Processor.process Http11Processor.java 870         at org.apache.coyote.http11.Http11BaseProtocol Http11ConnectionHandler.p rocessConnection Http11BaseProtocol.java 665         at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket PoolTcpEndpo int.java 528         at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt LeaderFol lowerWorkerThread.java 81         at org.apache.tomcat.util.threads.ThreadPool ControlRunnable.run ThreadP ool.java 685         at java.lang.Thread.run Thread.java 595 24.01.2008 15 38 34 ERROR Webdav Servlet.service for servlet Webdav threw  exception SLF4JLocationAwareLog.java line 174 java.lang.ClassCastException org.apache.jackrabbit.webdav.property.DefaultDavPr operty         at org.apache.jackrabbit.webdav.simple.DavResourceImpl.alterProperties D avResourceImpl.java 456         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.doPropPatch AbstractWebdavServlet.java 457         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.execute Abs tractWebdavServlet.java 234         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.service Abs tractWebdavServlet.java 192         at javax.servlet.http.HttpServlet.service HttpServlet.java 803         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter Appl icationFilterChain.java 269         at org.apache.catalina.core.ApplicationFilterChain.doFilter ApplicationF ilterChain.java 188         at org.apache.catalina.core.StandardWrapperValve.invoke StandardWrapperV alve.java 210         at org.apache.catalina.core.StandardContextValve.invoke StandardContextV alve.java 174         at org.apache.catalina.core.StandardHostValve.invoke StandardHostValve.j ava 127         at org.apache.catalina.valves.ErrorReportValve.invoke ErrorReportValve.j ava 117         at org.apache.catalina.core.StandardEngineValve.invoke StandardEngineVal ve.java 108         at org.apache.catalina.connector.CoyoteAdapter.service CoyoteAdapter.jav a 151         at org.apache.coyote.http11.Http11Processor.process Http11Processor.java 870         at org.apache.coyote.http11.Http11BaseProtocol Http11ConnectionHandler.p rocessConnection Http11BaseProtocol.java 665         at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket PoolTcpEndpo int.java 528         at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt LeaderFol lowerWorkerThread.java 81         at org.apache.tomcat.util.threads.ThreadPool ControlRunnable.run ThreadP ool.java 685         at java.lang.Thread.run Thread.java 595 24.01.2008 15 53 54 ERROR Webdav Servlet.service for servlet Webdav threw  exception StandardWrapperValve.java line 257 java.lang.ClassCastException org.apache.jackrabbit.webdav.property.DefaultDavPr operty         at org.apache.jackrabbit.webdav.simple.DavResourceImpl.alterProperties D avResourceImpl.java 456         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.doPropPatch AbstractWebdavServlet.java 457         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.execute Abs tractWebdavServlet.java 234         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.service Abs tractWebdavServlet.java 192         at javax.servlet.http.HttpServlet.service HttpServlet.java 803         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter Appl icationFilterChain.java 269         at org.apache.catalina.core.ApplicationFilterChain.doFilter ApplicationF ilterChain.java 188         at org.apache.catalina.core.StandardWrapperValve.invoke StandardWrapperV alve.java 210         at org.apache.catalina.core.StandardContextValve.invoke StandardContextV alve.java 174         at org.apache.catalina.core.StandardHostValve.invoke StandardHostValve.j ava 127         at org.apache.catalina.valves.ErrorReportValve.invoke ErrorReportValve.j ava 117         at org.apache.catalina.core.StandardEngineValve.invoke StandardEngineVal ve.java 108         at org.apache.catalina.connector.CoyoteAdapter.service CoyoteAdapter.jav a 151         at org.apache.coyote.http11.Http11Processor.process Http11Processor.java 870         at org.apache.coyote.http11.Http11BaseProtocol Http11ConnectionHandler.p rocessConnection Http11BaseProtocol.java 665         at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket PoolTcpEndpo int.java 528         at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt LeaderFol lowerWorkerThread.java 81         at org.apache.tomcat.util.threads.ThreadPool ControlRunnable.run ThreadP ool.java 685         at java.lang.Thread.run Thread.java 595 24.01.2008 15 53 54 ERROR Webdav Servlet.service for servlet Webdav threw  exception SLF4JLocationAwareLog.java line 174 java.lang.ClassCastException org.apache.jackrabbit.webdav.property.DefaultDavPr operty         at org.apache.jackrabbit.webdav.simple.DavResourceImpl.alterProperties D avResourceImpl.java 456         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.doPropPatch AbstractWebdavServlet.java 457         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.execute Abs tractWebdavServlet.java 234         at org.apache.jackrabbit.webdav.server.AbstractWebdavServlet.service Abs tractWebdavServlet.java 192         at javax.servlet.http.HttpServlet.service HttpServlet.java 803         at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter Appl icationFilterChain.java 269         at org.apache.catalina.core.ApplicationFilterChain.doFilter ApplicationF ilterChain.java 188         at org.apache.catalina.core.StandardWrapperValve.invoke StandardWrapperV alve.java 210         at org.apache.catalina.core.StandardContextValve.invoke StandardContextV alve.java 174         at org.apache.catalina.core.StandardHostValve.invoke StandardHostValve.j ava 127         at org.apache.catalina.valves.ErrorReportValve.invoke ErrorReportValve.j ava 117         at org.apache.catalina.core.StandardEngineValve.invoke StandardEngineVal ve.java 108         at org.apache.catalina.connector.CoyoteAdapter.service CoyoteAdapter.jav a 151         at org.apache.coyote.http11.Http11Processor.process Http11Processor.java 870         at org.apache.coyote.http11.Http11BaseProtocol Http11ConnectionHandler.p rocessConnection Http11BaseProtocol.java 665         at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket PoolTcpEndpo int.java 528         at org.apache.tomcat.util.net.LeaderFollowerWorkerThread.runIt LeaderFol lowerWorkerThread.java 81         at org.apache.tomcat.util.threads.ThreadPool ControlRunnable.run ThreadP ool.java 685         at java.lang.Thread.run Thread.java 595 Just spotted the bug. In DavResourceImpl statusCode error instanceof RepositoryException    new JcrDavException RepositoryException o .getErrorCode    DavServletResponse.SC INTERNAL SERVER ERROR should be statusCode error instanceof RepositoryException    new JcrDavException RepositoryException error .getErrorCode    DavServletResponse.SC INTERNAL SERVER ERROR Unfortunately I can t contribute from work but hopefully this will give you the chance to patch it quickly. Thanks Jimoh. thanks a lot i will fix it immediately. btw as far as i know the DAV auto-version property is present upon PROPFIND but obvious PROPPATCH on it should only be allowed if the new value can be properly handled. This is currently not the case. Therefore either PROPPATCH should disallow modifying the property OR the resources should properly behave to a other value. In any case the value of the DAV auto-version should be checked for validity. I will open another issue for that.applied fix with rev. 615194 i didn t run litmus and didn t perform any extensive tests but quickly modified props one valid and one that fails with DavExplorer. that seemed ok now. thanks again for finding the bug and the resolution . angela Thanks Angela I guess the reason there isn t a check for valid auto-version values is that auto-versioning isn t supported according to the comment in VersionControlledResourceImpl . I just drove myself mad trying to figure out why a PROPPATCH on auto-version wasn t reflected when I reloaded the resource in DAV Explorer..until I found that comment in VersionControlledResourceImpl.initProperties I might have a crack at implementing auto-versioning myself as I need a high-performance solution and making 3 calls to put a versioned resource every time will be too expensive.i created an issue for the DAV auto-versioning - JCR-1348 - see there for further comments.Merged to the 1.4 branch in revision 618604.
