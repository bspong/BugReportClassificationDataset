JavaCC grammar generation to maven.build.dir generated-src
Currently the JavaCC grammars in src grammar xpath sql are processed into Java source files in src java org apache jacrabbit core query xpath sql where we also have normal version controlled source files. This leads to the need to maintain special svn ignore properties and also the more general issue of mixing manually written and automatically generated source files. Because of this the maven clean command does not at the moment truly restore your source tree to a fresh checkout state. I m proposing as a wish you are free to disagree that the JavaCC grammars be generated into Java files within the Maven build directory. The attached patch modifies the javacc maven goals to generate files into maven.build.dir generated-src. The modified prepare-filesystem goal also adds the generated source path maven.build.dir generated-src main java into the maven compile set so that the generated sources are included in the normal builds. PS. There are a couple of JavaCC generated files that have been intentionally modified for Jackrabbit. The ant delete commands at the end of the jacrabbit generate- -parser goals specifically remove these generated files. It would however be nicer if custom modifications would not be needed.Attached the patch against latest maven.xml. PS. Note that this change may cause developers to modify the project path settings in their IDEs.Hi Jukka I agree with you that we should separate the source files into a version controlled tree and a generated source tree. You mentioned the path settings in IDEs does the maven idea goal respect the additional path entry or do you have to manually add the generated source directory to the source paths I believe that the IDE integration tools only look at the build sourceDirectory element of project.xml. As Maven does not allow more than one source directory they do have a good point for this I unfortunately don t think that the configuration can be automated. The generated sources are added to the internal Maven source path by the maven addPath element in maven.xml of the attached patch. I don t know of any automated way to make the path externally visible. the maven eclipse plugin DOES add addiction paths for generated files but only if you are using maven in order to generate java source files. Actually during jackrabbit build javacc is called using an ant task and not using the standar maven javacc plugin http maven.apache.org reference plugins javacc index.html I suppose also the IDEA plugin should support generate sources dir if the maven javacc plugin is used. Fabrizio Giustina wrote the maven eclipse plugin DOES add addiction paths for generated files but only if you are using maven in order to generate java source files. Oh nice Thanks for the information When I created the attached patch I first tried using the Maven JavaCC plugin. I ran into a problem with how to handle the XSLT-generated XPath grammar files and decided to just skip the plugin. Might it be feasible to try again now that there s a clear added benefit in using the Maven plugin I guess another problem is that jackrabbit uses two grammar files and it seems that the maven javacc plugin is only able to handle one grammar file per project using properties. Also checked with the maven idea plugin and it appears that the plugin is currently not able to handle multiple source directories. See http jira.codehaus.org browse MPIDEA-16.How about this - Keep custom maven scripts to generate the parsers. Unless we find a way how to specify two grammar files for jackrabbit If you are still watching this issue fabrizio do you know if this is possible - Apply the patch provided by Jukka and make sure that all the properties that are set by the maven javacc plugin are also set by our own jelly script in maven.xml. This should ensure that the eclipse project files are generated correctly. - I ll try to clean up the sources that we can get rid of the ant delete calls for the duplicate classes. Keep custom maven scripts to generate the parsers. Unless we find a way how to specify two grammar files for jackrabbit If you are still watching this issue fabrizio do you know if this is possible Mh at the moment the javacc maven plugin doesn t support more than one grammar file so there is no a clean-maven-way to do it. Anyway I think that you could get rid of ant with a little hack in maven.xml since the problem is that the maven.javacc.javacc.grammar and maven.javacc.jjtree.grammar can hold a single value you can simply change the property on the fly in maven.xml and repeat the javacc goal twice... not really clean but it should work You should add an enhancement request to the maven javacc jira at http jira.codehaus.org browse MPJAVACC. A better solution would be adding the multiple file support to the plugin directly and submit a patch the maven javacc plugin is just a jelly file which calls ant just like the custom maven.xml in jackrabbit so it should not be so difficult I had a look at the Maven Eclipse plugin sources and it seems that the plugin will add all subdirectories of maven.gen.src to an Eclipse project. Thus adding the following line to project.properties makes the generated source directories automatically available in Eclipse     maven.gen.src maven.build.dir generated-src This seems to work fine with maven eclipse but does not work with the Eclipse Mevenide plugin nor does it seem to work with the Maven IDEA plugin. This issue seems to boil down to a source tree clarity vs. IDE convenience question. I d vote for the former but I m a maven eclipse user so the change has little drawbacks for me. - Attached an updated patch that uses the hack proposed by Fabrizio. The new patch also adds the maven.gen.src variable to project.properties so that the Maven Eclipse plugin can automatically locate the generated sources. The concept of generated sources doesn t seem to be very well handled by Maven. The JavaCC plugin uses a hardcoded generated-src main path the Eclipse plugin uses the maven.gen.src variable and both Mevenide and the IDEA plugin seem to be going for their own solutions. For background please see the following http jira.codehaus.org browse MPECLIPSE-5 http mail-archives.apache.org mod mbox maven-dev 200407.mbox 3cPKENIMMEAHDAHILNLIJPMELAEMAB.epugh upstate.com 3e http jira.codehaus.org browse MEVENIDE-181 http jira.codehaus.org browse MPIDEA-10Applied the second patch and removed the svn ignore from sql and xpath packages. Thanks Jukka and Fabrizio for your help. The sources are now much cleaner and well separated. Notes to all other devs and users of jackrabbit - After updating you need to remove the now obsolete source files those not under version control in package o.a.j.c.query.sql and o.a.j.c.query.xpath. - If you use IntelliJ you need to manually add a second source path to the jackrabbit module target generated-src main java - The eclipse .classpath file is generated correctly by the maven plugin. Fixed in revision 170000
