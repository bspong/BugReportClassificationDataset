SystemSessions created for GarbageCollector are not logged out of
I have a simple garbage collection task that runs periodically. After upgrading to 1.5.5 it started logging a warning shortly after each run 2009-05-09 03 44 45 480 WARN org.apache.jackrabbit.core.SessionImpl - Unclosed session detected. The session was opened here java.lang.Exception Stack Trace at org.apache.jackrabbit.core.SessionImpl. init SessionImpl.java 239 at org.apache.jackrabbit.core.SystemSession. init SystemSession.java 76 at org.apache.jackrabbit.core.SystemSession.create SystemSession.java 64 at org.apache.jackrabbit.core.SessionImpl.createDataStoreGarbageCollector SessionImpl.java 649 So it s not my session but an internally created SystemSession. Code I m using             getTemplate .execute new JcrCallback                              public Object doInJcr Session session                     throws IOException RepositoryException                     SessionImpl sessionImpl SessionImpl session                     GarbageCollector gc sessionImpl.createDataStoreGarbageCollector                     gc.scan                     gc.stopScan                     gc.deleteUnused                     return null                               true The attached patch for GarbageCollector logs out of the internal SystemSession objects when the user session has logged out which resolves this for me locally. Committed in revision 773555 trunk Thanks a lot for the patch You re welcome... unfortunately the previous patch was not quite right. The GarbageCollector needs to keep a reference to the session listener or it may be garbage collected the session only holds weak references to its listeners . I observed this actually occurring in testing on the latest build. Patch against latest build on top of previous patch . Stores the session listener in a field of GarbageCollector so that it is not collected. Also moves the closing of the system sessions from loggedOut to loggingOut it seems more appropriate that the lifetime of those system sessions be bounded by the parent session. Hm the GarbageCollector object could be garbage collected before the session is closed. That means keeping a hard reference from the GarbageCollector to the listener wouldn t help right It looks like we need a new method GarbageCollector.close and a finalize method in case people forgot to call close .Ignore the 2nd patch I ve attached a 3rd that incorporates close finalize as suggested.Thanks a lot for the patch Committed in revision 779084 trunk Merged to the 1.5 branch in revision 794213.
