after enabling access manager I can t createNode and setProperty without a node.save in the middle
I added my own access manager. after that I can t get the following code working Node n createNewNode parentNode n.setProperty parentNode.save It seems that setProperty will invoke access control check but since the new node is not in the repository yet my access manager implementation won t be able to grant permission. I also tried to use hierachyManager to get the path of the new node it also returned null. i am unfortunately unable to reproduce the issue you re describing. here s what i did trying to reproduce it i added the following lines at the beginning of the SimpleAccessManager isGranted ItemId int method        try            String path PathFormat.format hierMgr.getPath id nsResolver            System.out.println checking permission on path         catch RepositoryException re            re.printStackTrace System.out         catch NameException ne             erm         when i run the following code            Node foo root.addNode foo            foo.setProperty bar blah blah            root.save i get the following console output checking permission on checking permission on foo bar checking permission on foo jcr primaryType so everything seems to be working as expected. note that i used the hierarchy manager passed in the AMContext object on init for resolving the paths. feel free to reopen this issue if you don t agree. however you should provide detailed instructions how to reproduce it ideally by providing a simple test case.Hi Stefan I have composed a test case and hopefully it will be helpful. But conceptually if one session has node and property set before commit the other session should not see it or am I wrong my implemenation of access manager is using another session compared to the test code step to reproduce 1. copy the file to a directory 2. copy required jar files to lib directory 3. compile the code and run JackrabbitTest Let me know how it goes. Thanks. Xiaohua please try the provided test code.i ran your test code against svn trunk . here s the console output freshDB true checking permission on checking permission on checking permission on newNode jcr primaryType checking permission on newNode ext name checking permission on newNode jcr uuid so everything seems to be working as expected.... please note that the access manager will be invoked before the changes are actually committed i.e. new nodes and properties are not yet visible to other sessions.reopening as i am now able to reproduce the issuethis issue is resolved as a side-effect of JCR-689 svn r518986 . prior to r518986 the access manager was invoked to check permission on non-existing items which lead to ItemNotFoundException when trying to resolving the path of the specified item id.the issue has been fixed as a side-effect of fixing JCR-689.
