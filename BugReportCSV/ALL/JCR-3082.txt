occasional index out of bounds exception while running UserManagerImplTest.testFindAuthorizableByRelativePath
Stack trace java.lang.ArrayIndexOutOfBoundsException 8 at org.apache.jackrabbit.core.query.lucene.MultiScorer.score MultiScorer.java 89 at org.apache.lucene.search.ConjunctionScorer.score ConjunctionScorer.java 133 at org.apache.lucene.search.BooleanScorer2 2.score BooleanScorer2.java 182 at org.apache.lucene.search.BooleanScorer2.score BooleanScorer2.java 303 at org.apache.jackrabbit.core.query.lucene.LuceneQueryHits.nextScoreNode LuceneQueryHits.java 68 at org.apache.jackrabbit.core.query.lucene.QueryHitsAdapter.nextScoreNodes QueryHitsAdapter.java 54 at org.apache.jackrabbit.core.query.lucene.FilterMultiColumnQueryHits.nextScoreNodes FilterMultiColumnQueryHits.java 63 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.collectScoreNodes QueryResultImpl.java 328 at org.apache.jackrabbit.core.query.lucene.QueryResultImpl.getResults QueryResultImpl.java 291 at org.apache.jackrabbit.core.query.lucene.SingleColumnQueryResult. init SingleColumnQueryResult.java 66 at org.apache.jackrabbit.core.query.lucene.QueryImpl.execute QueryImpl.java 134 at org.apache.jackrabbit.core.query.QueryImpl 1.perform QueryImpl.java 130 at org.apache.jackrabbit.core.query.QueryImpl 1.perform QueryImpl.java 1 at org.apache.jackrabbit.core.session.SessionState.perform SessionState.java 200 at org.apache.jackrabbit.core.query.QueryImpl.execute QueryImpl.java 126 at org.apache.jackrabbit.core.security.user.IndexNodeResolver.findNodes IndexNodeResolver.java 109 at org.apache.jackrabbit.core.security.user.UserManagerImpl.findAuthorizables UserManagerImpl.java 498 at org.apache.jackrabbit.core.security.user.UserManagerImpl.findAuthorizables UserManagerImpl.java 462 at org.apache.jackrabbit.core.security.user.UserManagerImplTest.testFindAuthorizableByRelativePath UserManagerImplTest.java 560 at sun.reflect.NativeMethodAccessorImpl.invoke0 Native Method at sun.reflect.NativeMethodAccessorImpl.invoke Unknown Source at sun.reflect.DelegatingMethodAccessorImpl.invoke Unknown Source at java.lang.reflect.Method.invoke Unknown Source at junit.framework.TestCase.runTest TestCase.java 154 at junit.framework.TestCase.runBare TestCase.java 127 at junit.framework.TestResult 1.protect TestResult.java 106 at junit.framework.TestResult.runProtected TestResult.java 124 at junit.framework.TestResult.run TestResult.java 109 at junit.framework.TestCase.run TestCase.java 118 at org.apache.jackrabbit.test.AbstractJCRTest.run AbstractJCRTest.java 456 at junit.framework.TestSuite.runTest TestSuite.java 208 at junit.framework.TestSuite.run TestSuite.java 203 at org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run JUnit3TestReference.java 130 at org.eclipse.jdt.internal.junit.runner.TestExecution.run TestExecution.java 38 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests RemoteTestRunner.java 467 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests RemoteTestRunner.java 683 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run RemoteTestRunner.java 390 at org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main RemoteTestRunner.java 197 This seems to be caused by      Override     public int nextDoc throws IOException         while currentDoc NO MORE DOCS             if scorers currentScorer .nextDoc NO MORE DOCS                 currentDoc scorers currentScorer .docID starts currentScorer                 return currentDoc              else if currentScorer scorers.length                  advance to next scorer              else                  no more scorers                 currentDoc NO MORE DOCS                               return currentDoc      which allows currentScorer to go beyond scorers.length and      Override     public float score throws IOException         return scorers currentScorer .score      which assumes it is in-range. Not sure whether the caller is supposed to call score when the object is in this state. Changing it to      Override     public int nextDoc throws IOException         while currentDoc NO MORE DOCS             if scorers currentScorer .nextDoc NO MORE DOCS                 currentDoc scorers currentScorer .docID starts currentScorer                 return currentDoc              else if currentScorer 1 scorers.length                  advance to next scorer                currentScorer 1              else                  no more scorers                 currentDoc NO MORE DOCS                               return currentDoc      fixes the runtime exception but I m not totally sure about the correctness.More observations - the problem doesn t seem to occur when the test case is run in isolation but running all tests in the class usually triggers it - the behavior of the scorer seems to be per spec the question is why score is called when the object is in the invalid stateThis makes it easier to reproduce the problem but it still doesn t occur on every run     public void testRepeat throws NotExecutableException RepositoryException         for int i 0 i 100 i             testFindAuthorizableByRelativePath           Added lots of debug code... Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 constructed from org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer 18c5cb7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 89f27f nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 89f27f nextDoc exit 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 89f27f score entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 89f27f nextDoc entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 89f27f nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f nextDoc exit 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f score entry 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f nextDoc entry 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f nextDoc exit 1641 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f score entry 1641 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f nextDoc entry 1641 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1e09a0f nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 advance entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer a28410 advance exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b2da5 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 51adbe constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 659f5d constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 51adbe nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 51adbe nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 659f5d nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 659f5d nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1c1d37f constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 245893 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1c1d37f nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1c1d37f nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 245893 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 245893 nextDoc exit 881 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 332954 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e constructed from org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer aa7d00 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b2da5 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b2da5 nextDoc exit 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b2da5 score entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b2da5 nextDoc entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b2da5 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 332954 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 332954 nextDoc exit 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 332954 score entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 332954 nextDoc entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 332954 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e advance entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer de552e advance exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer f4b252 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e74cf6 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 16dd606 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e74cf6 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e74cf6 nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 16dd606 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 16dd606 nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1fe3302 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1c6d395 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1fe3302 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1fe3302 nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1c6d395 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1c6d395 nextDoc exit 881 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 6d0e60 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 constructed from org.apache.jackrabbit.core.query.lucene.DescendantSelfAxisQuery DescendantSelfAxisScorer 98c0fc Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer f4b252 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer f4b252 nextDoc exit 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer f4b252 score entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer f4b252 nextDoc entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer f4b252 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 6d0e60 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 6d0e60 nextDoc exit 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 6d0e60 score entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 6d0e60 nextDoc entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 6d0e60 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 advance entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1caca13 advance exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e4563a constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer d9048d constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b9d2c0 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer d9048d nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer d9048d nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b9d2c0 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1b9d2c0 nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer bb4a7f constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 17e174 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer bb4a7f nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer bb4a7f nextDoc exit 880 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 17e174 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 17e174 nextDoc exit 881 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1d2aa9f constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 constructed 7 8 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1d2aa9f nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1d2aa9f nextDoc exit 0 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc exit 1630 5 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc exit 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e4563a nextDoc entry -1 0 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e4563a nextDoc exit 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e4563a score entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e4563a nextDoc entry 878 1 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer e4563a nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc entry 1630 5 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc exit 1632 5 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e constructed from org.apache.lucene.search.BooleanScorer2 d6524f Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1d2aa9f score entry 1632 5 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 score entry 1632 5 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 score entry 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc entry 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc exit 1641 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc entry 1632 5 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc exit 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc entry 1641 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc entry 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc exit 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1d2aa9f score entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 score entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 score entry 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score got IOOBE Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e advance entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e advance exit So what happens is that LuceneQueryHits uses a BooleanScorer which uses two instances of MultiScorer. It calls nextDoc Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc entry 1641 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 nextDoc exit 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc entry 1640 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 nextDoc exit 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e nextDoc exit and one of the two MultiScorers says NO MORE DOCS. However it then calls score on both of them Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score entry Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1d2aa9f score entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer 1bfd296 score entry 1642 6 Thread main 5 main org.apache.jackrabbit.core.query.lucene.MultiScorer a5eaf4 score entry 2147483647 7 Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score got IOOBE Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e score exit Thread main 5 main org.apache.jackrabbit.core.query.lucene.LuceneQueryHits TracingScorer 1a6639e advance entry Dunno whether that s a Lucene or Jackrabbit problem. Making MultiScorer.score more tolerant would fix the problem but that seems like a hack to me.It would appear that the DescendantSelfAxisScorer does not respect the DocIdSetIterator API on the advance method. The BooleanScorer2 has 2 scorers a DescendantSelfAxisScorer and a MultiScorer. When the MultiScorer is finished the BooleanScorer2 will call advance on the DescendantSelfAxisScorer with a Integer.MAX VALUE. Because the DescendantSelfAxisScorer does not respect the api instead of exausting the scorer it only calls subScorer.nextDoc once thus reverting the current docId to a smaller value instead of NO MORE DOCS. This propagates through all the embedded scorers acting like there are more docs in the current query when in fact there are no more. I m attaching a patch for this specific advance Integer.MAX VALUE on the DescendantSelfAxisScorer that apparently fixes the problem. The DescendantSelfAxisScorer still does not comply with the api and it would be interesting to look at the other existing implementations in JR to check for compliance. At the very least we should enable this optimization for the case where it is called with NO MORE DOCS to shortcut to the end of the stream. The analysis sounds right to me and I haven t been able to repro the problem so far with the patch applied.fixed in revision 1179129. I ve created JCR-3091 to track the scorer advance changes.
