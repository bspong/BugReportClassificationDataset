wrong exception from NativeFSLockFactory LIA2 test case 
As part of integrating Lucene In Action 2 test cases LUCENE-2661 I found one of the test cases fail the test is pretty simple and passes on 3.0. The exception you get instead LockReleaseFailedException is pretty confusing and I think we should fix it. for trunk just change the test to use MockAnalyzer instead of simple... i made the patch from 3x. May there be a randomization issue. If both index writers use a different LockFacory it can easy fail So at least for one test run the LockFactory should be identical else the locking can produce wrong failures messages as SimpleFSLock and NativeFSLock can interact very limited but there are only some security checks so locking will fail if you mix the implementations. The test isnt random. it uses FSDirectory.open Sorry you are right. The exception throws is clearly wrong Maybe its related to Shai s changes in NativeFSLockFactory which is the default I think it is the recent changes to NativeFSLockFactory... IW tries to first clear the lock if create true and that attempt is causing the exception. Really this is a holdover from SimpleFSLockFactory which can leave orphan d locks... so maybe somehow we shouldn t do this for other lock factories I think we should remove the call inside IW to dir.clearLock This is a holdover from when SimpleFSLockFactory was the default. And I think it s devious dangerous w that lock factory since that lock factory lets you simply erase the lock out from under another open IW. Ie that call masks bugs. All tests pass when I remove it and the LIA lock test also passes. Bulk close for 3.1
