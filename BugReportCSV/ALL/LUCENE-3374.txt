move nrtcachingdir to core in 4.0
in 4.0 with the IOContext changes this implementation is clean and I think we should move it to core and use it in our tests etc. 1 1 Are tests OK w randomly using NRTCachingDir Might find some interesting bugs... I ran them once and they passed I ran them again and got a fail junit Testsuite org.apache.lucene.index.TestCrash junit Testcase testWriterAfterCrash org.apache.lucene.index.TestCrash FAILED junit null junit junit.framework.AssertionFailedError junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1535 junit at org.apache.lucene.util.LuceneTestCase LuceneTestCaseRunner.runChild LuceneTestCase.java 1437 junit at org.apache.lucene.store.NRTCachingDirectory.deleteFile NRTCachingDirectory.java 158 junit at org.apache.lucene.store.MockDirectoryWrapper.deleteFile MockDirectoryWrapper.java 336 junit at org.apache.lucene.store.MockDirectoryWrapper.deleteFile MockDirectoryWrapper.java 294 junit at org.apache.lucene.index.IndexFileDeleter.deleteFile IndexFileDeleter.java 572 junit at org.apache.lucene.index.IndexFileDeleter. init IndexFileDeleter.java 273 junit at org.apache.lucene.index.IndexWriter. init IndexWriter.java 906 junit at org.apache.lucene.index.TestCrash.initIndex TestCrash.java 39 junit at org.apache.lucene.index.TestCrash.testWriterAfterCrash TestCrash.java 85 junit junit junit Tests run 7 Failures 1 Errors 0 Time elapsed 6.618 sec junit junit Standard Error junit NOTE reproduce with ant test -Dtestcase TestCrash -Dtestmethod testWriterAfterCrash -Dtests.seed 3196b05b20cf6a20 6f1b3eaa7f0f71ee 557c08ae3c634d12 junit NOTE test params are codec RandomCodecProvider id MockVariableIntBlock baseBlockSize 68 content Pulsing freqCutoff 16 locale de CH timezone Asia Jakarta junit NOTE all tests run in this JVM junit TestAssertions TestCharTermAttributeImpl TestAtomicUpdate TestByteSlices TestCodecs TestCrash junit NOTE Linux 2.6.38-10-generic amd64 Sun Microsystems Inc. 1.6.0 24 64-bit cpus 8 threads 1 free 248890808 total 349569024 junit junit TEST org.apache.lucene.index.TestCrash FAILED So I cannot commit this patch just yet I ll look into this fail later this evening. updated patch I fixed TestCrash because this crazy test does evil things that violate the assert the assert itself looks good and I think we want it enabled . So I added expert maybeWrap booleans so that crazy tests like this can intentionally not use NRTCachingDir. But there are more problems in other tests FNFEs . I wired the boolean with a nocommit to true in the patch so that these occur every time. might be a real bug in here... patch fixing the fails. This directory was seriously screwed if you use compound file format. There s one fail left in TestFSDir havent looked yet might be a false one. But we should backport this compound file stuff to 3.x ... maybe make a standalone test for it there. ok all tests pass. The last bugs were stupid see my comments in the patch but these are also bugs in FileSwitchDirectory. I m gonna open a separate issue to turn on FileSwitchDirectory in tests and lets fix this stuff there too. I assume the bugs in FileSwitchDirectory are the same NotExists Exceptions thrown We should maybe also add FileSwitchDirectory to the list of random directories. It could create two random directories using LTC.newDirectory false 2 times with a suffix on the dir name like .1 and .2 and combine them with a FileSwitchDirectory. The Set String of extensions could be a random list of extensions from the IndexFileNames collection. Oh see LUCENE-3380 o I don t want to mix fixing these bugs with moving to core. I m going to create a separate issue for the bugs. The whole compound file stuff seems unfixable so I m gonna just fix it like we have it here. i turned on this directory in tests but we should check out TestDoc and TestCrash.
