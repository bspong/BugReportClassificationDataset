DisjunctionSumScorer gives slightly float iotas different scores when you .nextDoc vs .advance
Spinoff from LUCENE-1536. I dug into why we hit a score diff when using luceneutil to benchmark the patch. At first I thought it was BS1 BS2 difference but because of a bug in the patch it was still using BS2 but should be BS1 Ð Robert s last patch fixes that. But it s actually a diff in BS2 itself whether you next or advance through the docs. It s because DisjunctionSumScorer when summing the float scores for a given doc that matches multiple sub-scorers might sum in a different order when you had .nextDoc d to that doc than when you had .advance d to it. This in turn is because the PQ used by that scorer ScorerDocQueue makes no effort to break ties. So when the top N scorers are on the same doc the PQ doesn t care what order they are in. Fixing ScorerDocQueue to break ties will likely be a non-trivial perf hit though so I m not sure whether we should do anything here... Failing test case showing the bug. I think we have to fix it get the correctness and then worry about performance later. giving a document a different score no matter how little it will affect ranking just because you next ed versus advance d it is bad news. not a real fix but maybe this solves it for practical purposes patch with a bugfix to the test in case it gets slowmultireaderwrapper Bulk close after release of 3.5
