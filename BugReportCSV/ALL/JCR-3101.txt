recovery tool does not recover when version history can be instantiated but root version can not
JCR-2551 introduced a recovery mode which tries to instantiate the version history and if this fails disconnects the VH version history and makes the node unversioned. However it appears it can happen that the persistence is damaged such as getting the VH does indeed work but subsequent operations fail due to other problems. One problem that has been seen is a missing frozenNode property of the root version or a missing frozenNode itself . As a quick fix we may want to change the checker so that it actually also tries to get the rootVersion and it s frozenNode. Long term depending on how frequent this problem is we may have to think about a less drastic recovery than disconnecting the VH.This implements the additional checks getting the root version plus the root version s frozen node.Looks good. As you mentioned a more fine-grained recovery would be nice but for now simply disconnecting a node from a broken version history seems good enough. Another potentially useful future improvement would be to check not just the root version but also all other versions in the history.Indeed I wasn t sure about how aggressive my checks should be. If you think we should be checking indeed all versions I can add that.patch updated to check all versions but not the consistency of relations between them minimally modified patch applied to trunk r1180922 r1181024 in 2.2 r1180922 in trunk
