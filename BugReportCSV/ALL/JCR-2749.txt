Closing a session twice shouldn t write a warning in the log
When closing a session twice the following warning is written to the log file as of JCR-2741 This session has already been closed. See the chained exception for a trace of where the session was closed. I think the second close should simply be ignored without warning. A duplicate close call is always a sign of an error somewhere so I d rather not just silently ignore that situation. If the warning log is troublesome we can downgrade it to a debug message.The warning with stack trace is even logged if the session is only closed once as in TransientRepository rep new TransientRepository Session s rep.login new SimpleCredentials new char 0 s.logout I double Jukka s point here. However I agree that the message is not helpful in the logs to the end user that is . The message is merely some developer s aid. I d make it a debug message in the field. For unit tests and integration test s however I d make it a failure i.e throw an AssertionError . For TransientRepository this seems to be a separate issue to. AFAIK TransientRepository keeps track of its sessions and closes them automatically. So in your example the session is really closed twice which is indeed wrong.If we do really want a warning in the log which I think is not necessary I think debug is enough then we need both places where the session was closed. Just one stack trace is not enough. I think throwing an AssertionError while testing is OK but how Do we have a mechanism maybe a system property to distinguish between test and runtime Proposed patchI don t think the problem only occurs with TransientRepository. It occurred with a repository implementation that extends RepositoryImpl.If the warnings are caused by the automatic shutdown procedures of TransientRepository or other repository implementations then we should fix those errors instead of hiding the issue by lowering the log level. I m OK to also including the stack trace of the second close in the log even though Logback already gives us that as a configuration option.I m generally fine with lowering to debug level. However I fear this will also hide potential problems during development instead on forcing us to fix them. This is why I proposed to throw an AssertionError in dev mode. I think we have a system property for integration testing already which could be used here. Jukka The main problem is fixed in revision 997244 - if you want to further improve things please go ahead.I looked deeper into this and it looks like the warning from new TransientRepository .login .logout does not come from this logout call but actually from the fact that the repository is attempting to repeatedly close the system session This is because of the hacks used in access control and data store garbage collection code where the system session of a workspace is marked as a normal active session to prevent the workspace janitor from disposing a workspace. During shutdown this makes the repository treat the system session as an unclosed user session which then gets automatically closed before the repository later on correctly attempts to close the system session. The system session should only ever get closed in the WorkspaceInfo.doDispose method. Assuming we fix the above problem is there still a need to keep the log level at debug As shown by this case the warnings do help us spot real problems.Thanks a lot Jukka great that you found the root cause Assuming we fix the above problem is there still a need to keep the log level at debug For me personally it s not that important. My fear is the log file will be less relevant if it contains stack traces of things that are viewed as unproblematic by many most developers such as closing a resource twice . So I vote to keep it at debug level. But I agree with Michael while running unit tests it should throw an AssertionError. Therefore it would have broke the build.I d like to keep it on warn because that s exactly what it is. nothing s broken it still works but something is wrong anyway. if you are not interested in these kind of messages you can simply ignore warnings and only look at error messages. enabling assertions is done with a jvm option -ea and is usually done when running tests.In revision 997496 I fixed the problem with duplicate closing of the system session. In revision 997518 I turned the log level back to warnings as I believe the above fix addresses the most prominent case of duplicate closing. The log messages now also come with additional instructions on what to look for in order to fix the problems. I agree about the concern over the relevancy of log messages but I d only lower the log level if there remain other prominent cases where a more proper fix is too expensive. Re assertions IMO assertions are best used as logic guards for code that you control entirely - loop and class invariants etc. In this case we re mostly guarding against bad behavior by client code and thus I think that logging warnings or in more extreme cases throwing exceptions are more appropriate solutions than assertions. Thanks for fixing the root cause of the problem a Is it illegal according to the spec to call close multiple times I think it isn t but I might be wrong. b The AssertionError was supposed to be thrown calling close multiple times while running Jackrabbit test cases only this is detected using a system property . Personally I actually didn t think about using the assert keyword because of a . Instead I would use if runningJackrabbitTestCases throw new AssertionError ... . That means a client would never get this exception but the exception would be thrown when running Jackrabbit test cases no matter if -ea is used or not. Regarding b this is exactly what I had in mind originally. Now that log levels are back to warn I think I can live with the current solution also.a It s not illegal but doing so is practically always a sign of some resource management error. Thus I think a warning is in place just like when we log a warning when a client forgets to close a session see JCR-1216 . b Since a duplicate logout is not strictly speaking illegal see a an assertion is IMHO the wrong thing to use. Generally speaking nothing that a JCR client can produce by invoking standard JCR methods should ever be able to trigger an assertion. StackOverflow summarizes this nicely Use assertions for internal logic checks within your code and normal exceptions for error conditions outside your immediate code s control. http stackoverflow.com questions 1276308 exception-vs-assertion Also I d rather avoid extra behaviour that s only activated during test runs I know we have some of them in the codebase since such code erodes the purpose of testing by making the test system behave differently than a production system. If we want a way for the test suite to check against these situations we should either make it scan the log file for logged warnings or add a more generic mechanism by which a client application can specify custom handling of problems like this.Resolving as fixed since the new TransientRepository .login .logout sequence no longer logs a warning.
