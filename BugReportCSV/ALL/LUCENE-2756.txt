MultiSearcher.rewrite incorrectly rewrites queries
This was reported on the userlist in the context of range queries. Its also easy to make our existing tests fail with my patch on LUCENE-2751 ant test-core -Dtestcase TestBoolean2 -Dtestmethod testRandomQueries -Dtests.seed 7679849347282878725 -903778383189134045 The fundamental problem is that MultiSearcher first rewrites against individual subs then uses Query.combine which simply OR s these sub-clauses. This is incorrect for expanded MUST NOT queries e.g. from wildcard as it violates demorgan s law. attached is a simple test it adds a single document foo bar to one index and another document foo baz to another. if you do the query foo -ba the multisearcher rewrites this to field foo -field baz field foo -field bar This causes both documents to match the query when really neither should. instead the query should be field foo -field baz -field bar if you run the test with -Dtests.verbose true you can see the rewritten form. the reason this only appeared with a certain document count for the issue on the user s list is because they were using CONSTANT SCORE AUTO and with that document count it was deciding to use a constant-score boolean rewrite method. MultiSearcher is now deprecated removed. Bulk close for 3.1
