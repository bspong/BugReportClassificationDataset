ERROR 40XD0 Container has been closed exception with Derby DB
This seems very similar to JCR-1039 only I am getting it on 1.4 using the regular DatabasePersistenceManager. Was the fix for JCR-1039 in 1.3.3 merged to 1.4.x Here is the relevant part of the exception INFO jvm 1 2008 04 10 14 00 37 Caused by javax.jcr.RepositoryException failed to retrieve item state of item fb648866-a236-42aa-8039-df68f26dd2ad http www.jcp.org jcr 1.0 data failed to read property state fb648866-a236-42aa-8039-df68f26dd2ad http www.jcp.org jcr 1.0 data failed to read property state fb648866-a236-42aa-8039-df68f26dd2ad http www.jcp.org jcr 1.0 data INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.ItemManager.createItemInstance ItemManager.java 570 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.ItemManager.getItem ItemManager.java 395 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.NodeImpl.getProperty NodeImpl.java 2553 INFO jvm 1 2008 04 10 14 00 37 at org.artifactory.jcr.JcrFile.getStream JcrFile.java 133 INFO jvm 1 2008 04 10 14 00 37 ... 55 more INFO jvm 1 2008 04 10 14 00 37 Caused by org.apache.jackrabbit.core.state.ItemStateException failed to read property state fb648866-a236-42aa-8039-df68f26dd2ad http www.jcp.org jcr 1.0 data INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.load DatabasePersistenceManager.java 406 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.SharedItemStateManager.loadItemState SharedItemStateManager.java 1161 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.SharedItemStateManager.getNonVirtualItemState SharedItemStateManager.java 1086 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.SharedItemStateManager.getItemState SharedItemStateManager.java 248 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.LocalItemStateManager.getPropertyState LocalItemStateManager.java 118 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.LocalItemStateManager.getItemState LocalItemStateManager.java 150 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.XAItemStateManager.getItemState XAItemStateManager.java 226 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.state.SessionItemStateManager.getItemState SessionItemStateManager.java 175 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.ItemManager.createItemInstance ItemManager.java 564 INFO jvm 1 2008 04 10 14 00 37 ... 58 more INFO jvm 1 2008 04 10 14 00 37 Caused by javax.jcr.RepositoryException Error creating temporary file ERROR 40XD0 Container has been closed. ERROR 40XD0 Container has been closed. INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.value.BLOBInTempFile. init BLOBInTempFile.java 69 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.value.BLOBInTempFile.getInstance BLOBInTempFile.java 103 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.value.InternalValue.getBLOBFileValue InternalValue.java 630 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.value.InternalValue.create InternalValue.java 265 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.persistence.util.Serializer.deserialize Serializer.java 296 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.load DatabasePersistenceManager.java 397 INFO jvm 1 2008 04 10 14 00 37 ... 66 more INFO jvm 1 2008 04 10 14 00 37 Caused by java.io.IOException ERROR 40XD0 Container has been closed. INFO jvm 1 2008 04 10 14 00 37 at org.apache.derby.impl.store.raw.data.OverflowInputStream.fillByteHolder Unknown Source INFO jvm 1 2008 04 10 14 00 37 at org.apache.derby.impl.store.raw.data.BufferedByteHolderInputStream.read Unknown Source INFO jvm 1 2008 04 10 14 00 37 at java.io.DataInputStream.read DataInputStream.java 132 INFO jvm 1 2008 04 10 14 00 37 at java.io.FilterInputStream.read FilterInputStream.java 116 INFO jvm 1 2008 04 10 14 00 37 at java.io.FilterInputStream.read FilterInputStream.java 116 INFO jvm 1 2008 04 10 14 00 37 at java.io.SequenceInputStream.read SequenceInputStream.java 191 INFO jvm 1 2008 04 10 14 00 37 at java.io.InputStream.read InputStream.java 85 INFO jvm 1 2008 04 10 14 00 37 at org.apache.jackrabbit.core.value.BLOBInTempFile. init BLOBInTempFile.java 61 INFO jvm 1 2008 04 10 14 00 37 ... 71 moreJCR-1039 fixed the issue for the BundleDbPersistenceManager only. AFAIK the derby issue ERROR 40XD0 occurs when while consuming an InputStream from a ResultSet another stmt is executed on the same connection. futthrermore the data read must exceed a certain size. i guess this could happen when using DatabasePersistenceManager with externalBlobs false. could you please post your PersistenceManager configuration Your assumption about externalBlobs is right          PersistenceManager class org.apache.jackrabbit.core.persistence.db.DerbyPersistenceManager              param name url value jdbc derby wsp.home db create true              param name url value jdbc derby rep.home db create true              param name schemaObjectPrefix value wsp.name              param name externalBLOBs value false              param name schema value jcr derby          PersistenceManager fixed in r 647147. thanks for reporting this issue Thank you for resolving it so quickly Perhaps we were glad too soon I patched 1.4.2-core as the only real change is internal logic in DatabasePersistenceManager and this class is similar in 1.5 and 1.4.2 also had to change the POM to include the commons-io dependency but that s basic . After doing that I am getting the following read exceptions such as 2008-04-13 00 03 27 857 ERROR persistence.db.DatabasePersistenceManager - failed to read property state b69dcff2-6b33-4cde-8b4e-37916aee698b http www.jcp.org jcr 1.0 data javax.jcr.RepositoryException Error creating file ERROR 40XD0 Container has been closed. ERROR 40XD0 Container has been closed.         at org.apache.jackrabbit.core.value.InternalValue.create InternalValue.java 270         at org.apache.jackrabbit.core.persistence.util.Serializer.deserialize Serializer.java 296         at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.load DatabasePersistenceManager.java 407         at org.apache.jackrabbit.core.state.SharedItemStateManager.loadItemState SharedItemStateManager.java 1177         at org.apache.jackrabbit.core.state.SharedItemStateManager.getNonVirtualItemState SharedItemStateManager.java 1102         at org.apache.jackrabbit.core.state.SharedItemStateManager.getItemState SharedItemStateManager.java 249         at org.apache.jackrabbit.core.state.LocalItemStateManager.getPropertyState LocalItemStateManager.java 118         at org.apache.jackrabbit.core.state.LocalItemStateManager.getItemState LocalItemStateManager.java 150         at org.apache.jackrabbit.core.state.XAItemStateManager.getItemState XAItemStateManager.java 226         at org.apache.jackrabbit.core.state.SessionItemStateManager.getItemState SessionItemStateManager.java 186         at org.apache.jackrabbit.core.ItemManager.createItemInstance ItemManager.java 564         at org.apache.jackrabbit.core.ItemManager.getItem ItemManager.java 395         at org.apache.jackrabbit.core.NodeImpl.getProperty NodeImpl.java 2548         ...          clipped         ...         at org.quartz.simpl.SimpleThreadPool WorkerThread.run SimpleThreadPool.java 529 Caused by java.io.IOException ERROR 40XD0 Container has been closed.         at org.apache.derby.impl.store.raw.data.OverflowInputStream.fillByteHolder Unknown Source         at org.apache.derby.impl.store.raw.data.BufferedByteHolderInputStream.read Unknown Source         at java.io.DataInputStream.read DataInputStream.java 134         at java.io.FilterInputStream.read FilterInputStream.java 111         at java.io.FilterInputStream.read FilterInputStream.java 111         at java.io.FilterInputStream.read FilterInputStream.java 90         at org.apache.jackrabbit.core.value.BLOBValue. init BLOBValue.java 108         at org.apache.jackrabbit.core.value.InternalValue.create InternalValue.java 268         ... 32 more Moreover I now started to receive write exceptions as well such as 2008-04-13 00 02 00 066 ERROR persistence.db.DatabasePersistenceManager - failed to write property state 57c5083e-7ff2-4b5f-86c0-bad6bd56475c http www.jcp.org jcr 1.0 data java.io.IOException ERROR 40XD0 Container has been closed.         at org.apache.derby.impl.store.raw.data.OverflowInputStream.fillByteHolder Unknown Source         at org.apache.derby.impl.store.raw.data.BufferedByteHolderInputStream.read Unknown Source         at java.io.DataInputStream.read DataInputStream.java 134         at java.io.FilterInputStream.read FilterInputStream.java 111         at java.io.FilterInputStream.read FilterInputStream.java 111         at java.io.FilterInputStream.read FilterInputStream.java 90         at org.apache.jackrabbit.core.value.BLOBValue. init BLOBValue.java 108         at org.apache.jackrabbit.core.value.InternalValue.create InternalValue.java 268         at org.apache.jackrabbit.core.persistence.util.Serializer.serialize Serializer.java 223         at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 486         at org.apache.jackrabbit.core.persistence.AbstractPersistenceManager.store AbstractPersistenceManager.java 75         at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store DatabasePersistenceManager.java 283         at org.apache.jackrabbit.core.state.SharedItemStateManager Update.end SharedItemStateManager.java 704         at org.apache.jackrabbit.core.state.SharedItemStateManager.update SharedItemStateManager.java 873         at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 324         at org.apache.jackrabbit.core.state.XAItemStateManager.update XAItemStateManager.java 313         at org.apache.jackrabbit.core.state.LocalItemStateManager.update LocalItemStateManager.java 300         at org.apache.jackrabbit.core.state.SessionItemStateManager.update SessionItemStateManager.java 317         at org.apache.jackrabbit.core.ItemImpl.save ItemImpl.java 1250         at org.apache.jackrabbit.core.SessionImpl.save SessionImpl.java 897         ...          clipped         ...         at java.lang.Thread.run Thread.java 595 Unfortunately one of my biggest users is currently crashing on this bug.Attaching my patched DatabasePersistenceManager based on http svn.apache.org repos asf jackrabbit tags jackrabbit-core-1.4.2 src main java org apache jackrabbit core persistence db DatabasePersistenceManager.java 647406 i tried to reproduce the issue on trunk but was unable to do so. could you please create attach a simple test case which can be used to reproduce the issue what derby version are you using are you using any jackrabbit extensions customizations thanks stefanThe Derby version is 10.3.1.4. Not using any extensions customizations except for the patched DB PM. Currently I do not have a reproducible test case but the same exceptions have been reported by 2 independent users running with the patch. I will attempt to create a test case for this however. I might just switch to using the new DS with a Bundle PM in order to overcome this since it is a show stopper for me.i noticed that you re using a newer derby version 10.3.1.4 jackrabbit currently uses 10.2.1.6. i tried to reproduce the issue using the same newer derby version... unfortunately i am still unable to reproduce it. could you please provide more information on when the issue occurs e.g. what s the size of the binary causing the issue Any updates on this Looks like we re missing a reproducible test case of the followup issues. I suggest we re-resolve this as Fixed for 1.5 based on the fix in revision 647147 and open separate issues for the other problems once we have a test case for them.Resolved as Fixed.
