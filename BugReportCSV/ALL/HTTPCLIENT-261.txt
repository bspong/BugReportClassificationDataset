infinite loop on 302 redirect with different host in Location header
Using the CVS version - 2.1 rc I think. Trying to get the url contents for a url with followRedirects specified and StrictMode off and I get a 302 redirect to a different url with a different host in the Location header causes it to go into an infinite loop mercifully aborting at 100 redirects . An example offending url http www.snowcrest.net mice mice.htm The problem lies in HttpMethodBase.java version 1.177 at line 1225. It does the following         if getRequestHeader host null             LOG.debug                  Request to add Host header ignored header already added             return          and there is already the Host header from the previous url request so it endlessly loops until it aborts at the max redirects default is 100 I guess . I commented this out and it worked fine.2.0 rc 2 actuallyHi Brent I tried doing a GET on http www.snowcrest.net mice mice.htm using the latest from CVS HTTPCLIENT 2 0 BRANCH 2.0 pre-rc2 and CVS HEAD 2.1 pre-alpha and got expected behavior. The 2.0 code did not handle the redirect as it is to another host see http jakarta.apache.org commons httpclient redirects.html . The 2.1 code handled the redirect correctly. Please verify which version of HttpClient you are using. If the problem persists please post sample code and a wire log http jakarta.apache.org commons httpclient logging.html . MikeCreated an attachment id 8035 test client java app demonstrating infinite loop Created an attachment id 8036 infinte loop wire log from the test app In the wire log it says 2.1m1 for the version - I just grabbed the latest from CVS and tried it and it still does the infinite loop.Hi Brent Your example code looks quite like the code I tried. Just to be sure though I tried yours. My results were the same. All seems to work for me. Please see my wire log attached below. From looking for your wire log it seems strange that the server is redirecting to the same page that is being requested. Are you accessing the internet directly or do you have you have a proxy Anyone else have some ideas MikeCreated an attachment id 8044 successful wire log Hi Mike Your log still contains the same problem as mine HttpMethodBase - -Request to add Host header ignored header already added I m using WinProxy and I can t bypass it and I don t have an environment setup on the firewall box to test it. Is there a problem doing what I suggested in my initial report - commenting out the getRequestHeader....return If I comment that out it works as it should. BrentHi Mike Should also add that in your log as well it does not actually switch hosts as it should because of that getResponseHeader....return. Notice that Host request header is the same www.snowcrest.net and it should have switched to users.snowcrest.net BrentHi Brent Sorry for being a little dense. You are quite right. I will post a patch test in a few minutes. Thanks MikeCreated an attachment id 8046 fix patch Attached is a fix for this plus a test case. I will apply the patch to HEAD tomorrow unless there are objections. Thank you for your patience Brent. MikePatch applied.
