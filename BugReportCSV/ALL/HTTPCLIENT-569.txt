HttpState.clearCookies should be synchronized
The HttpState class has a clearCookies method that is not synchronized but should be considering it modifies an ArrayList which is unsynchronized . All other methods which modify or read from the ArrayList are synchronized except the clearCookies method. I stumbled upon this fact because a webapp I am working on that uses HttpClient threw an IllegalArgumentException indicating that one of the cookies in the array returned from HttpState.getCookies was null which shouldn t be possible. Upon further inspection and testing the only possible option is that the threadsafety hole left by the unsynchronized clearCookies method caused the issue.Created an attachment id 17681 Test case source code The attached source code is what I used to confirm that there could be a problem with the clearCookies method. Every time I run it I get a null Cookie after just a second or two. Sure it s contrived but it is more of a proof of concept than anything.This is clearly a bug. However it seems awkward to me why you wanted to clear cookies from a different thread in the middle of other requests executing. Even if there is now no exception thrown anymore HttpClient s behaviour is certainly not deterministic in that case.Created an attachment id 17685 Patch against 3.0 branch and trunk Patch away Odi OlegPatch committed. In reply to comment 2 This is clearly a bug. However it seems awkward to me why you wanted to clear cookies from a different thread in the middle of other requests executing. Even if there is now no exception thrown anymore HttpClient s behaviour is certainly not deterministic in that case. Agreed. When I saw someone else s code using the same HttpState object across multiple threads I immediately changed the code to use only one HttpState per thread. Yes their code was not written with threadsafety in mind but fortunately I was able to find that person s problem AND this bug and be part of the solution for both.
