org.apache.http.impl.client.cache.memcached.MemcachedHttpCacheStorage should verify class of returned object before casting
org.apache.http.impl.client.cache.memcached.MemcachedHttpCacheStorage Original in getEntry function   byte data byte client.get url Should be   Object obj client.get url   if null obj objinstanceof byte     return null      byte data byte obj Original in updateEntry function   byte oldBytes v null byte v.getValue null Should be   byte oldBytes v null v.getValue instanceof byte byte v.getValue null    There is possibility of getting a Class Cast Exception. Here is a patch for the issue. I also fixed some code indentation for more readability. RajikaLooks like the patch fixes the problems in updateEntry but fails to fix the same problem in getEntry.One thing I do not quite understand. Why would there be anything other than byte array in the memcache In case someone was silly enough to have stuck some arbitrary object in the memcache used by HttpClientCache throwing ClassCastException seems perfectly reasonable. OlegCould be that somebody is using the cache for other purposes as well and just happens to set an object with a URL as a key that conflicts with an object that is set by MemcachedHttpCacheStorage.   this could and also probably should be mitigated by allowing the client of MemcachedHttpCacheStorage to set a client-defined prefix String that will be prefixed to all keys thus avoiding potential collisions. In my case it is that we are using jmemcacheddaemon for local testing purposes and unfortunately jmemcacheddaemon has a known bug where cache misses return an empty string instead of a null object. This causes MemcachedHttpCacheStorage to throw a ClassCastException instead of just returning null because String cannot be cast to byte . Could be that somebody is using the cache for other purposes as well and just happens to set an object with a URL as a key that conflicts with an object that is set by MemcachedHttpCacheStorage Could be that somebody is using computer to hammer nails. We can t stop people from doing silly stuff. this could and also probably should be mitigated by allowing the client of MemcachedHttpCacheStorage to set a client-defined prefix String that will be prefixed to all keys thus avoiding potential collisions. This is actually a very reasonable suggestion. Probably what we need is a generic strategy that can be used to generate a unique cache key from a request url. This would also take care of HTTPCLIENT-1153. In my case it is that we are using jmemcacheddaemon for local testing purposes and unfortunately jmemcacheddaemon has a known bug where cache misses return an empty string instead of a null object. OK. But I do not think that polluting a general purpose library with a hack clearly specific to your local environment is the right thing to do. Simply implement a custom HttpCacheStorage which is aware of the empty string semantics. Oleg In my case it is that we are using jmemcacheddaemon for local testing purposes and unfortunately jmemcacheddaemon has a known bug where cache misses return an empty string instead of a null object. OK. But I do not think that polluting a general purpose library with a hack clearly specific to your local environment is the right thing to do. Simply implement a custom HttpCacheStorage which is aware of the empty string semantics. Fair enough. But as a general principle if memcached ever retrieves an object that isn t the expected type it should count as a cache-miss. It certainly shouldn t throw a ClassCastException. Just miss and move on. I actually had already extended MemcachedHttpCacheStorage to make it aware of the empty-string problem and also to hash URLs using SHA-512 and to allow a custom prefix on the keys. So I m good. I just opened these bugs so you could be aware and make changes if you want. I m actually going to reopen this as I think it s a pretty small change that adds to the robustness of the library and I ll work on integrating and committing it . Upon encountering something weird coming back out of memcached I think logging a warning and then acting as if it were a cache miss is good and prudent behavior. Clinton I ve been thinking about adding an optional string-prefix configuration option to the memcached storage as well would you mind opening that as a separate improvement request Yup I ll do that right away. Rajika just checked your patch in along with the addition of a WARN-level log message if we encounter memcached giving us something other than a byte back. Will work on porting this to the 4.1.x branch next.Checked into trunk and backported to 4.1.x. Clinton - can you review and close this issue if you re satisfied Checked the diff. It looks like the issue is only half-fixed. The fix has been applied to the updateEntry function but not to the getEntry function. Thanks. Clinton - good catch will fix forthwith. Clinton - added the same checking to the getEntry side and refactored the commonality out. This is checked into trunk now. Verified as fixed in trunk.Ok also backported to 4.1.x.
