Explicit VirtualHosts Can Cause Issues On Redirects
If you set an explicit virtual host then a getmethod may get stuck in a redirect loop up to maxRedirects . e.g. execute a get on www.google.com with a www.google.com virtualhost . That redirects to www.google.co.nz at least if you come from an NZ IP . The current httpclient behavior is to then connect to www.google.co.nz but pass through with the request Host www.google.com . Google will then reply with another www.google.co.nz redirect and the loop continues. There are probably a few ways to work around this. It seems reasonable to drop an explicity set virtual host in the event a redirect redirects to a different uri authority. The following patch works for me diff -Naur .. .. t2 commons-httpclient src java org apache commons httpclient HttpMethodDirector.java src java org apache commons httpclient HttpMethodDirector.java .. .. t2 commons-httpclient src java org apache commons httpclient HttpMethodDirector.java 2005-12-22 01 06 55.000000000 1300 src java org apache commons httpclient HttpMethodDirector.java 2005-12-22 19 09 51.000000000 1300 -605 6 605 27 Ê redirectUri new URI currentUri redirectUri Ê Ê do scenario we re trying to avoid virtual host is set e.g. google.com a request to that server responds with a redirect to google.co.nz we issue a request to google.co.nz with a virtual host request of google.com This code will remove any set virtual host if the redirect is to a different domain if redirectUri.isRelativeURI break String vhost hostConfiguration.getParams .getVirtualHost if vhost null break if redirectUri.getAuthority currentUri.getAuthority hostConfiguration.getParams .setVirtualHost null while false Please provide a test case or a wire log to demonstrate the problem OlegRequest to http google.com input output GET HTTP 1.1 User-Agent Jakarta Commons-HttpClient 3.0 Host google.com HTTP 1.1 301 Moved Permanently Location http www.google.com Set-Cookie PREF ID 1f19f8bb9ac951a9 TM 1135227992 LM 1135227992 S Ly6FRGzsKeYnIlWw expires Sun 17-Jan-2038 19 14 07 GMT path domain .google.com Content-Type text html Server GWS 2.1 Content-Length 222 Date Thu 22 Dec 2005 05 06 32 GMT HTML HEAD meta http-equiv content-type content text html charset us-ascii TITLE 301 Moved TITLE HEAD BODY H1 301 Moved H1 The document has moved A HREF http www.google.com here A . BODY HTML Redirect attempt to www.google.com note the code is still passing google.com as the Host GET HTTP 1.1 User-Agent Jakarta Commons-HttpClient 3.0 Host google.com HTTP 1.1 301 Moved Permanently Location http www.google.com Set-Cookie PREF ID 74be7d5195fba646 TM 1135227996 LM 1135227996 S b8jDlWu8OEBw6erI expires Sun 17-Jan-2038 19 14 07 GMT path domain .google.com Content-Type text html Server GWS 2.1 Content-Length 222 Date Thu 22 Dec 2005 05 06 36 GMT HTML HEAD meta http-equiv content-type content text html charset us-ascii TITLE 301 Moved TITLE HEAD BODY H1 301 Moved H1 The document has moved A HREF http www.google.com here A . BODY HTML And so it will continue. Google will adamantly redirect you to www.google.com httpclient will adamantly request the google.com host. Peter Could you please attach the test code as well OlegCreated an attachment id 17260 test code note the attached foo.java file will reproduce the problem. As an aside it causes complaints about cookies WARNING Cookie rejected Version 0 REF ID 907888a1032f157b TM 1135256845 LM 1135256845 S gSqOk4-s42mhCarE Path Domain .google.com . Illegal domain attribute .google.com . Domain of origin google.com . Is httpclient sending back cookies that were sent to it After a redirect If so then I m not sure how you d handle things if the domain changes. e.g. a cookie set on google.com should probably not be passed onto example.com after a redirect. But what about a redirect to subdir.google.com In this case I think there may be something worth investigating in the cookiespec classes. In reply to comment 5 note the attached foo.java file will reproduce the problem. I suspect this problem again boils down to which host HttpClient interprets as a target host and a virtual one given the ambiguous configuration. I ll run a few tests at home this evening to investigate further As an aside it causes complaints about cookies WARNING Cookie rejected Version 0 REF ID 907888a1032f157b TM 1135256845 LM 1135256845 S gSqOk4-s42mhCarE Path Domain .google.com . Illegal domain attribute .google.com . Domain of origin google.com . This is yet another issue that has been beaten to death on numerous occasions. Per RFC 2109 policy the .google.com domain attribute is not valid for the target host google.com . Use a more lenient browser compatibility policy instead OlegThe problem is because httpclient is using the explicity set virtualhost. My initial post has code which resolves the problem in case you missed that.Created an attachment id 17267 Patch take 1 The patch takes care of the problem. I ll hack up a test case sometime this weekend unless someone else beats me to it read volunteers welcome OlegCreated an attachment id 17286 Patch take 1 test case Please review Oleglooks okYep fine with me. MikePatch checked in Oleg
