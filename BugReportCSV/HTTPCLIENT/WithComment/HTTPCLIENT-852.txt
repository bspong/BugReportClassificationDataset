CircularRedirectException encountered when using a proxy but not when reaching the target directly
A CircularRedirectException is encountered when using a proxy tinyproxy on a remote machine whereas everything is fine when using no proxy. The target is a URL such as http www.seoconsultants.com w3c status-codes 301.asp which has a 301 redirection. The issue can be fixed by using ALLOW CIRCULAR REDIRECTS set to true client params but I can t consider this a real fix. Here is a snippet of code that exemplifies the problem use your own proxy String proxyHost xyz.webfactional.com int proxyPort 7295 DefaultHttpClient httpclient new DefaultHttpClient without a proxy it s OK httpclient.getParams .setParameter ConnRoutePNames.DEFAULT PROXY         new HttpHost proxyHost proxyPort http HttpParams params httpclient.getParams HttpClientParams.setRedirecting params true HttpProtocolParams.setUserAgent params          Mozilla 5.0 Macintosh U Intel Mac OS X 10.5 en-US rv 1.9.0.10 Gecko 2009042315 Firefox 3.0.10 OK this fixes the problem but at what cost other problems httpclient.getParams .setParameter ClientPNames.ALLOW CIRCULAR REDIRECTS true String url http www.seoconsultants.com w3c status-codes 301.asp HttpUriRequest request HttpResponse response request new HttpGet url System.out.println request request.getRequestLine response httpclient.execute request System.out.println status response.getStatusLine System.out.println headers Arrays.asList response.getAllHeaders I ve already opened an issue HTTPCLIENT-852 sorry if that was inappropriate. Charles That was perfectly appropriate. I join with this message 3 logs that show what happens without proxy with the proxy and with the proxy and the option ALLOW CIRCULAR REDIRECTS. Could you please attach those logs to this report OlegHere are the logs. Didn t see the possibility to attach files at first . I ve only edited the logs to hide my real proxy host.I don t know if it has something to do with the issue but there s something strange that appears in the log when using the proxy java 2009 05 28 19 57 13 507 CEST DEBUG RequestAddCookies - Cookie version 0 name ASPSESSIONIDCSARBQBA value JPLPAMKCADCFBCNFOJBFJPMP domain www.seoconsultants.com path expiry null match www.seoconsultants.com 7295 7295 is the proxyPort and shouldn t have anything to do with the target host in the example www.seoconsultants.com .I examined the logs and that is what I have found so far The bug in HttpClient is triggered only when the redirect needs to be retried for some reason for instance due to an I O error. There appears to be a bug Tinyproxy s connection management code causing a perfectly re-usable HTTP 1.1 connection to be dropped without proper notification of the client. The proxy should have sent the Connection close if it was not going to re-use HTTP 1.1connection . HttpClient assumes that the connection is still good executes the redirect on the same connection which fails because the connection has been closed on the proxy side. The second retry fails because HttpClient mistakenly assumes the URI has already been visited. While Tinyproxy s behavior is clearly broken HttpClient should also be able to deal with failed redirects and retry those correctly. The fix for this issue however will require quite a bit of refactoring in the DefaultRequestDirector and DefaultRedirectHandler and may take a few days to complete. Oleg java 2009 05 28 19 57 13 507 CEST DEBUG RequestAddCookies - Cookie version 0 name ASPSESSIONIDCSARBQBA value JPLPAMKCADCFBCNFOJBFJPMP domain www.seoconsultants.com path expiry null match www.seoconsultants.com 7295 7295 is the proxyPort and shouldn t have anything to do with the target host in the example www.seoconsultants.com . Charles Please raise a separate JIRA for this issue. OlegThanks for your feedback. I appreciate the good work put in this library and will do everything I can to help improve it.Charles I found a bug in the DefaultHttpRequestDirector that caused that issue. Fortunately the fix was fairly minor in scope. No refactoring was necessary. Could you please re-test your application with the latest code snapshot and confirm the issue has been resolved You can find compiled snapshots here https repository.apache.org content repositories snapshots org apache httpcomponents httpclient 4.0-beta3-SNAPSHOT OlegOK seems fixed that s great 
