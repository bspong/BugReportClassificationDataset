DefaultClientRequestDirector doesn t release connections back to ClientConnectionManager on exceptions
See HTTPCLIENT-747 for more info. Basically the deal is that an entry is always allocated but currently it s only released if execute .. completes normally.The attached patch fixes the problem and adds two tests that used to fail but pass now . It s going to conflict slightly with the patch from HTTPCLIENT-734 because both are adding the new file TestDefaultClientRequestDirector but the merge conflict is easily resolved. Previously the connection would only be released during the next garbage collection which might never happen and could prevent subsequent requests from being tried if they were waiting on an available slot. Good catch Sam Unfortunately one of the new test cases fails for me. Ubuntu Linux 7.10 Java 1.5.0.11 single-core Intel Centrino Tests run 323 Failures 1 Errors 0 Skipped 0 Time elapsed 7.899 sec FAILURE testAbortInAllocate org.apache.http.impl.client.TestDefaultClientRequestDirector Time elapsed 1.019 sec FAILURE junit.framework.AssertionFailedError should have finished get request at junit.framework.Assert.fail Assert.java 47 at junit.framework.Assert.assertTrue Assert.java 20 at org.apache.http.impl.client.TestDefaultClientRequestDirector.testAbortInAllocate TestDefaultClientRequestDirector.java 110 OlegSorry that particular test case needs the patch from HTTPCLIENT-734. I was able to separate the patches for the non-test code but since both tests went into the same test class which is a new class I had to lump them together into the patch.Sorry. I missed that. Shall I just remove the test case for the time being and commit the patch OlegYa that s probably the best course for right now. I ll put some more thought into the aborting testcase patch.Patch checked in Many thanks Sam Oleg
