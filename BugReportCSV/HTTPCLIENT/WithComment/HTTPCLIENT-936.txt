NullPointerException in NegotiateScheme
- server is configured to allow client to authenticate with kerberos with principal foobar - client using httpclient with a registered authscheme SPNEGO set as a NegotiateSchemeFactory - when the client authenticate with the correct principal foobar it works - when the client authenticate with the wrong principal fooba it fails with a NPE below. Exception in thread main java.lang.NullPointerException at org.apache.commons.codec.binary.Base64.encodeBase64 Base64.java 233 at org.apache.commons.codec.binary.Base64.encode Base64.java 521 at org.apache.http.impl.auth.NegotiateScheme.authenticate NegotiateScheme.java 240 at org.apache.http.client.protocol.RequestTargetAuthentication.process RequestTargetAuthentication.java 99 at org.apache.http.protocol.ImmutableHttpProcessor.process ImmutableHttpProcessor.java 108 at org.apache.http.protocol.HttpRequestExecutor.preProcess HttpRequestExecutor.java 167 at org.apache.http.impl.client.DefaultRequestDirector.execute DefaultRequestDirector.java 460 at org.apache.http.impl.client.AbstractHttpClient.execute AbstractHttpClient.java 689 at org.apache.http.impl.client.AbstractHttpClient.execute AbstractHttpClient.java 624 at org.apache.http.impl.client.AbstractHttpClient.execute AbstractHttpClient.java 602 Try this patch out. You will need to upgrade to the latest code snapshot from SVN trunk. OlegHi I have an infinite loop now. start The client sends its token to the server Server replies with a WWW-Authenticate Negotiate sometoken Client gets a new token from the kdc It also gets a new token from the kdc for accessing the krbtgt don t know why goto startFrancois Could you please generate a wire context log of the HTTP session and attach it to this issue http hc.apache.org httpcomponents-client logging.html I also have to say I probably will not be able to do much about this problem as I cannot reproduce it locally. Please do consider investing some effort into fixing the bug in your environment and contributing the fix back to the community. OlegFirst patch to apply. Included - fix for API change in apache-commons negotiate was not working with commons 1.4 - add a way to inject a custom GSSManager for unit tests I cannot reproduce it locally now you can this one depends on the first patch patchCommonsApi waiting for your commentsFantastic Works or rather does not work like a charm I love test cases Working on a fix OlegFrancois This patch fixes the problem for me. Both test cases pass now. Please try it out. If I hear no complaints I ll commit the patch and close the issue in a day or two. Olegworks like a charm Patch checked in Oleg
