Deadlock with MultiThreadedHttpConnectionManager
I m getting a dealock with the MultiThreadedHttpConnectionManager. Usually it works fine but when a web page is redirected it blocks. Ludovic. ERROR Redirect to http sourceforge.net Full thread dump Java HotSpot TM Client VM 1.4.2 03-b02 mixed mode MultiThreadedHttpConnectionManager cleanup daemon prio 5 tid 0x02d566f0 nid 0xe14 in Object.wait 2e9f000..2e9fd8c         at java.lang.Object.wait Native Method         - waiting on 0x10513be8 a java.lang.ref.ReferenceQueue Lock         at java.lang.ref.ReferenceQueue.remove Unknown Source         - locked 0x10513be8 a java.lang.ref.ReferenceQueue Lock         at java.lang.ref.ReferenceQueue.remove Unknown Source         at org.apache.commons.httpclient.MultiThreadedHttpConnectionManager ReferenceQueueThread.run MultiThreadedHttpConnectionManager.java 805 Signal Dispatcher daemon prio 10 tid 0x0003da00 nid 0xd44 waiting on condition 0..0 Finalizer daemon prio 9 tid 0x009bca30 nid 0xce8 in Object.wait 2b5f000..2b5fd8c         at java.lang.Object.wait Native Method         - waiting on 0x10504b80 a java.lang.ref.ReferenceQueue Lock         at java.lang.ref.ReferenceQueue.remove Unknown Source         - locked 0x10504b80 a java.lang.ref.ReferenceQueue Lock         at java.lang.ref.ReferenceQueue.remove Unknown Source         at java.lang.ref.Finalizer FinalizerThread.run Unknown Source Reference Handler daemon prio 10 tid 0x009bb600 nid 0xfa4 in Object.wait 2b1f000..2b1fd8c         at java.lang.Object.wait Native Method         - waiting on 0x10504be8 a java.lang.ref.Reference Lock         at java.lang.Object.wait Unknown Source         at java.lang.ref.Reference ReferenceHandler.run Unknown Source         - locked 0x10504be8 a java.lang.ref.Reference Lock main prio 5 tid 0x00035e28 nid 0xf68 in Object.wait 7f000..7fc3c         at java.lang.Object.wait Native Method         - waiting on 0x105170e8 a org.apache.commons.httpclient.MultiThreadedHttpConnectionManager ConnectionPool         at org.apache.commons.httpclient.MultiThreadedHttpConnectionManager.doGetConnection MultiThreadedHttpConnectionManager.java 388         - locked 0x105170e8 a org.apache.commons.httpclient.MultiThreadedHttpConnectionManager ConnectionPool         at org.apache.commons.httpclient.MultiThreadedHttpConnectionManager.getConnection MultiThreadedHttpConnectionManager.java 296         at org.apache.commons.httpclient.HttpClient.executeMethod HttpClient.java 645         at org.apache.commons.httpclient.HttpClient.executeMethod HttpClient.java 529         at net.sourceforge.cvsgrab.WebBrowser.executeMethod WebBrowser.java 201         at net.sourceforge.cvsgrab.WebBrowser.getResponse WebBrowser.java 257         at net.sourceforge.cvsgrab.WebBrowser.getDocument WebBrowser.java 295         at net.sourceforge.cvsgrab.CvsWebInterface.loadDocument CvsWebInterface.java 111         at net.sourceforge.cvsgrab.CvsWebInterface.getDocumentForDetect CvsWebInterface.java 216         at net.sourceforge.cvsgrab.CvsWebInterface.findInterface CvsWebInterface.java 86         at net.sourceforge.cvsgrab.CVSGrab.detectWebInterface CVSGrab.java 688         at net.sourceforge.cvsgrab.CVSGrab.grabCVSRepository CVSGrab.java 616         at net.sourceforge.cvsgrab.CVSGrab.run CVSGrab.java 317         at net.sourceforge.cvsgrab.CVSGrab.main CVSGrab.java 206 VM Thread prio 5 tid 0x009f76d0 nid 0x550 runnable VM Periodic Task Thread prio 10 tid 0x009f8208 nid 0x560 waiting on condition Suspend Checker Thread prio 10 tid 0x009bed88 nid 0xe84 runnableDeadlocks I ve seen with MultiThreadedHttpConnectionManager are always due to a client that is not properly calling releaseConnection on the requests. A few things to try - raise or lower the number of connections that it manages and your deadlock will occur in a different place. That might tell you whether and where you are leaking connections. Was this working with a previous release rc2 for example and is only now broken Can you describe provide the code you re using to invoke HttpClient Created an attachment id 10676 Source code I m trying to read the following page http cvs.sourceforge.net viewcvs.py mevenide I m attaching the code of the class that is reading the web pages it is quite stand-alone i ll try to provide a test case later. And yes it was working previously with the 2.0 rc2 release. This is the trace returned by HttpClient apparently this DEBUG Unable to get a connection waiting... hostConfig HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 explains why it blocks now the question is why is it unable to open a connection There can be up to 3 simultaneous connections in my application but this problem occurs at the start of the application when pages are read sequentially on the same thread. TRACE enter GetMethod String TRACE enter HttpClient.executeMethod HttpMethod TRACE enter HttpClient.executeMethod HostConfiguration HttpMethod HttpState TRACE enter HttpConnectionManager.getConnection HostConfiguration long DEBUG HttpConnectionManager.getConnection config HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 timeout 0 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Getting free connection hostConfig HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 DEBUG HttpConnection.setSoTimeout 0 DEBUG Connection is stale closing... TRACE enter HttpConnection.close TRACE enter HttpConnection.closeSockedAndStreams TRACE enter HttpConnection.open TRACE enter HttpMethodBase.execute HttpState HttpConnection DEBUG Execute loop try 1 TRACE enter HttpMethodBase.processRequest HttpState HttpConnection TRACE Attempt number 1 to process request TRACE enter HttpMethodBase.writeRequest HttpState HttpConnection TRACE enter HttpMethodBase.writeRequestLine HttpState HttpConnection TRACE enter HttpMethodBase.generateRequestLine HttpConnection String String String String DEBUG GET viewcvs.py mevenide HTTP 1.1 r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpMethodBase.writeRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addUserAgentRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addHostRequestHeader HttpState HttpConnection DEBUG Adding Host request header TRACE enter HttpMethodBase.addCookieRequestHeader HttpState HttpConnection TRACE enter HttpState.getCookies TRACE enter CookieSpecBase.match String int String boolean Cookie TRACE enter HttpMethodBase.addAuthorizationRequestHeader HttpState HttpConnection TRACE enter HttpMethodBase.addProxyAuthorizationRequestHeader HttpState HttpConnection TRACE enter HttpMethodBase.addProxyConnectionHeader HttpState HttpConnection TRACE enter HttpMethodBase.addContentLengthRequestHeader HttpState HttpConnection DEBUG User-Agent Mozilla 4.0 compatible MSIE 6.0b Windows 98 r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int DEBUG Cache-Control no-cache r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int DEBUG Host cvs.sourceforge.net r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpConnection.writeLine TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpConnection.flushRequestOutputStream DEBUG r n TRACE enter HttpConnection.flushRequestOutputStream TRACE enter HttpMethodBase.readResponse HttpState HttpConnection TRACE enter HttpMethodBase.readStatusLine HttpState HttpConnection TRACE enter HttpConnection.readLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine DEBUG HTTP 1.1 200 OK r n TRACE enter HttpMethodBase.readResponseHeaders HttpState HttpConnection TRACE enter HttpConnection.getResponseInputStream TRACE enter HeaderParser.parseHeaders HttpConnection HeaderGroup TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine DEBUG Date Fri 05 Mar 2004 15 22 14 GMT r n DEBUG Server Apache 2.0.40 Red Hat Linux r n DEBUG Content-Type text html charset ISO-8859-1 r n DEBUG Connection close r n DEBUG Transfer-Encoding chunked r n TRACE enter HttpMethodBase.processResponseHeaders HttpState HttpConnection TRACE enter GetMethod.readResponseBody HttpState HttpConnection TRACE enter HttpMethodBase.readResponseBody HttpState HttpConnection TRACE enter HttpMethodBase.readResponseBody HttpState HttpConnection TRACE enter HttpConnection.getResponseInputStream TRACE enter HeaderElement.parse String TRACE enter HeaderElement.parsePair char int int DEBUG HttpConnection.getSoTimeout TRACE enter HttpConnection.isResponseAvailable int TRACE enter GetMethod String TRACE enter HttpClient.executeMethod HttpMethod TRACE enter HttpClient.executeMethod HostConfiguration HttpMethod HttpState TRACE enter HttpConnectionManager.getConnection HostConfiguration long DEBUG HttpConnectionManager.getConnection config HostConfiguration timeout 0 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Allocating new connection hostConfig HostConfiguration TRACE enter GetMethod String TRACE enter HttpClient.executeMethod HttpMethod TRACE enter HttpClient.executeMethod HostConfiguration HttpMethod HttpState TRACE enter HttpConnectionManager.getConnection HostConfiguration long DEBUG HttpConnectionManager.getConnection config HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 timeout 0 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Allocating new connection hostConfig HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 DEBUG HttpConnection.setSoTimeout 0 TRACE enter HttpConnection.open TRACE enter HttpMethodBase.execute HttpState HttpConnection DEBUG Execute loop try 1 TRACE enter HttpMethodBase.processRequest HttpState HttpConnection TRACE Attempt number 1 to process request TRACE enter HttpMethodBase.writeRequest HttpState HttpConnection TRACE enter HttpMethodBase.writeRequestLine HttpState HttpConnection TRACE enter HttpMethodBase.generateRequestLine HttpConnection String String String String DEBUG GET viewcvs.py mevenide HTTP 1.1 r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpMethodBase.writeRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addUserAgentRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addHostRequestHeader HttpState HttpConnection DEBUG Adding Host request header TRACE enter HttpMethodBase.addCookieRequestHeader HttpState HttpConnection TRACE enter HttpState.getCookies TRACE enter CookieSpecBase.match String int String boolean Cookie TRACE enter HttpMethodBase.addAuthorizationRequestHeader HttpState HttpConnection TRACE enter HttpMethodBase.addProxyAuthorizationRequestHeader HttpState HttpConnection TRACE enter HttpMethodBase.addProxyConnectionHeader HttpState HttpConnection TRACE enter HttpMethodBase.addContentLengthRequestHeader HttpState HttpConnection DEBUG User-Agent Mozilla 4.0 compatible MSIE 6.0b Windows 98 r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int DEBUG Cache-Control no-cache r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int DEBUG Host cvs.sourceforge.net r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpConnection.writeLine TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpConnection.flushRequestOutputStream DEBUG r n TRACE enter HttpConnection.flushRequestOutputStream TRACE enter HttpMethodBase.readResponse HttpState HttpConnection TRACE enter HttpMethodBase.readStatusLine HttpState HttpConnection TRACE enter HttpConnection.readLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine DEBUG HTTP 1.1 200 OK r n TRACE enter HttpMethodBase.readResponseHeaders HttpState HttpConnection TRACE enter HttpConnection.getResponseInputStream TRACE enter HeaderParser.parseHeaders HttpConnection HeaderGroup TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine DEBUG Date Fri 05 Mar 2004 15 22 41 GMT r n DEBUG Connection reclaimed by garbage collector hostConfig HostConfiguration host sourceforge.net protocol http 80 port 80 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Notifying no-one there are no waiting threads DEBUG Connection reclaimed by garbage collector hostConfig HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Notifying no-one there are no waiting threads DEBUG Server Apache 2.0.40 Red Hat Linux r n DEBUG Connection close r n DEBUG Transfer-Encoding chunked r n DEBUG Content-Type text html charset ISO-8859-1 r n TRACE enter HttpMethodBase.processResponseHeaders HttpState HttpConnection TRACE enter GetMethod.readResponseBody HttpState HttpConnection TRACE enter HttpMethodBase.readResponseBody HttpState HttpConnection TRACE enter HttpMethodBase.readResponseBody HttpState HttpConnection TRACE enter HttpConnection.getResponseInputStream TRACE enter HeaderElement.parse String TRACE enter HeaderElement.parsePair char int int DEBUG HttpConnection.getSoTimeout TRACE enter HttpConnection.isResponseAvailable int TRACE enter GetMethod String TRACE enter HttpClient.executeMethod HttpMethod TRACE enter HttpClient.executeMethod HostConfiguration HttpMethod HttpState TRACE enter HttpConnectionManager.getConnection HostConfiguration long DEBUG HttpConnectionManager.getConnection config HostConfiguration timeout 0 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Allocating new connection hostConfig HostConfiguration TRACE enter GetMethod String TRACE enter HttpClient.executeMethod HttpMethod TRACE enter HttpClient.executeMethod HostConfiguration HttpMethod HttpState TRACE enter HttpConnectionManager.getConnection HostConfiguration long DEBUG HttpConnectionManager.getConnection config HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 timeout 0 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Allocating new connection hostConfig HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 DEBUG HttpConnection.setSoTimeout 0 TRACE enter HttpConnection.open TRACE enter HttpMethodBase.execute HttpState HttpConnection DEBUG Execute loop try 1 TRACE enter HttpMethodBase.processRequest HttpState HttpConnection TRACE Attempt number 1 to process request TRACE enter HttpMethodBase.writeRequest HttpState HttpConnection TRACE enter HttpMethodBase.writeRequestLine HttpState HttpConnection TRACE enter HttpMethodBase.generateRequestLine HttpConnection String String String String DEBUG GET viewcvs.py mevenide HTTP 1.1 r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpMethodBase.writeRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addUserAgentRequestHeaders HttpState HttpConnection TRACE enter HttpMethodBase.addHostRequestHeader HttpState HttpConnection DEBUG Adding Host request header TRACE enter HttpMethodBase.addCookieRequestHeader HttpState HttpConnection TRACE enter HttpState.getCookies TRACE enter CookieSpecBase.match String int String boolean Cookie TRACE enter HttpMethodBase.addAuthorizationRequestHeader HttpState HttpConnection TRACE enter HttpMethodBase.addProxyAuthorizationRequestHeader HttpState HttpConnection TRACE enter HttpMethodBase.addProxyConnectionHeader HttpState HttpConnection TRACE enter HttpMethodBase.addContentLengthRequestHeader HttpState HttpConnection DEBUG User-Agent Mozilla 4.0 compatible MSIE 6.0b Windows 98 r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int DEBUG Cache-Control no-cache r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int DEBUG Host cvs.sourceforge.net r n TRACE enter HttpConnection.print String TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpConnection.writeLine TRACE enter HttpConnection.write byte TRACE enter HttpConnection.write byte int int TRACE enter HttpConnection.flushRequestOutputStream DEBUG r n TRACE enter HttpConnection.flushRequestOutputStream TRACE enter HttpMethodBase.readResponse HttpState HttpConnection TRACE enter HttpMethodBase.readStatusLine HttpState HttpConnection TRACE enter HttpConnection.readLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine DEBUG HTTP 1.1 200 OK r n TRACE enter HttpMethodBase.readResponseHeaders HttpState HttpConnection TRACE enter HttpConnection.getResponseInputStream TRACE enter HeaderParser.parseHeaders HttpConnection HeaderGroup TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine TRACE enter HttpParser.readLine TRACE enter HttpParser.readRawLine DEBUG Date Fri 05 Mar 2004 15 22 14 GMT r n DEBUG Server Apache 2.0.40 Red Hat Linux r n DEBUG Content-Type text html charset ISO-8859-1 r n DEBUG Connection close r n DEBUG Transfer-Encoding chunked r n TRACE enter HttpMethodBase.processResponseHeaders HttpState HttpConnection TRACE enter GetMethod.readResponseBody HttpState HttpConnection TRACE enter HttpMethodBase.readResponseBody HttpState HttpConnection TRACE enter HttpMethodBase.readResponseBody HttpState HttpConnection TRACE enter HttpConnection.getResponseInputStream TRACE enter HeaderElement.parse String TRACE enter HeaderElement.parsePair char int int DEBUG HttpConnection.getSoTimeout TRACE enter HttpConnection.isResponseAvailable int TRACE enter GetMethod String TRACE enter HttpClient.executeMethod HttpMethod TRACE enter HttpClient.executeMethod HostConfiguration HttpMethod HttpState TRACE enter HttpConnectionManager.getConnection HostConfiguration long DEBUG HttpConnectionManager.getConnection config HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 timeout 0 TRACE enter HttpConnectionManager.ConnectionPool.getHostPool HostConfiguration DEBUG Unable to get a connection waiting... hostConfig HostConfiguration host cvs.sourceforge.net protocol http 80 port 80 Claude The log that you posted suggests this There are some calls to HttpConnectionManager.getConnection but none to HttpConnectionManager.releaseConnection It s weird. One would think your code should call releaseConnection but obviously doesn t. Maybe you should restructure your code such that the HttpMethod is release by the same method that allocated it and do this in a finally block. That will make it easier to spot the mistake.You were right there was a silent exception that caused releaseConnection to be skipped. Thanks for your help Ludovic
