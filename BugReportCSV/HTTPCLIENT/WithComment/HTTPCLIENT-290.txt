MS Proxy with NTLM authentication set up does not work
When I try to go via a MS Proxy which is set up with NTLM authentication I always get a 407 error no matter which credentials used.Alfonso Please provide wire debug log of the session that exhibits the problem. OlegCreated an attachment id 8884 Debug log of the problem with the original rc2 sources If I make the following change in HttpMethodBase at line 2449 instead of              status 304 NOT MODIFIED put this              status 304 status 407 NOT MODIFIED I get the page correctly. I ve created another attachment to show that. It shows that the credentials I m using are correct not that this should be the best method to solve the problem. Created an attachment id 8886 Results after changing HttpMethodBase 2449 Alfonso I pinpointed the bug. Fix will follow soon. OlegAlfonso Unfortunately I am unable to generate a proper patch at the moment I am at the client s site and they have CVS port blocked by the corporate firewall . Basically the problem boils down to HttpClient or me if you please forgetting to reset the force-close connection flag. This additional line in HttpMethodBase responseBodyConsumed should take care of the problem. I ll submit a proper patch later today.     protected void responseBodyConsumed          make sure this is the initial invocation of the notification          ignore subsequent ones.         responseStream null         if responseConnection null             responseConnection.setLastResponseInputStream null             if shouldCloseConnection responseConnection                 responseConnection.close                                        this.connectionCloseForced false                  doneWithConnection true         if inExecute             ensureConnectionRelease               OlegCreated an attachment id 8890 Patch take 1 The patch should take of the problem. Test cases included. OlegOleg Wow . Thanks. Applied the patch. It now works as expected without needing my additional modifications. Should I close the bug or is that something left for you Alfonso First of all thanks for tracking down this bug and helping us to fix it. I ll commit the patch shortly and close the bug report. If you are familiar with CVS it would be great if you could check out the latest code from CVS HEAD and 2.0 branches once the patch is checked it and re-test it. OlegPatch applied to both HEAD 2.0 branch. OlegHello this is Alfonso again. Excuse me for the delay in testing. I ve downloaded the 2.0 rc 2 dated Oct 13 and tried my app. The library fails to authenticate properly. What is the procedure now. Â¿ Should this bug be reopen or a new one created I don t remember some of this but as I need this feature working can you tell me what was wrong with my initial sugested correction Alfonso You will need to build HttpClient from the source directly or use the latest nightly build although this is the 2.1 build not 2.0 so it may not work for you found here http cvs.apache.org builds jakarta-commons nightly commons-httpclient HttpClient 2.0rc3 has not yet been built so you cannot test that yet.... If you need help getting the source from CVS and building it check out the CVS clients at http www.wincvs.org and for Jakarta CVS access look at the information at http jakarta.apache.org site cvsindex.html. You should continue to use this bug report to track this issue.
