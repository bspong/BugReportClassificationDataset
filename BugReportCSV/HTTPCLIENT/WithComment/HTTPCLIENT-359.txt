StringRequestEntity.getContentLength wrong for multibyte chars
When setting up a PostMethod containing a StringRequestEntity with umlauts and charset UTF-8 the content-length header is wrong. It should be the number of bytes but is the number of chars by now. e.g. Content-Type text xml charset UTF-8 body Ã Ã¶Ã Ã Ã Ã Ã Bug-location org.apache.commons.httpclient.methods.StringRequestEntity Workaround      FIXME This is a workaround for httpClient 3.0alpha1 bug      concerning content-length and multi-byte chars     if method instanceof EntityEnclosingMethod         EntityEnclosingMethod eeMethod EntityEnclosingMethod method         final String charset eeMethod.getRequestCharSet         ByteArrayOutputStream baos new ByteArrayOutputStream         eeMethod.getRequestEntity .writeRequest baos         ByteArrayInputStream bais           new ByteArrayInputStream baos.toByteArray          better use InputStreamRequestEntity but you get the picture         eeMethod.setRequestBody bais          httpClient.executeMethod method P.S. eclipse debugger gave me this stacktrace to see the bug at work Thread HttpClient-Client-Server-0 Suspended StringRequestEntity.getContentLength line 140 PostMethod EntityEnclosingMethod .getRequestContentLength line 322 PostMethod EntityEnclosingMethod .addContentLengthRequestHeader HttpState HttpConnection line 392 PostMethod EntityEnclosingMethod .addRequestHeaders HttpState HttpConnection line 360 PostMethod HttpMethodBase .writeRequestHeaders HttpState HttpConnection line 1977 PostMethod HttpMethodBase .writeRequest HttpState HttpConnection line 1865 PostMethod HttpMethodBase .execute HttpState HttpConnection line 975 HttpMethodDirector.executeWithRetry HttpMethod line 368 HttpMethodDirector.executeMethod HttpMethod line 164 HttpClient.executeMethod HostConfiguration HttpMethod HttpState line 437 HttpClient.executeMethod HttpMethod line 324 HttpClientThread.run line 96 Created an attachment id 12016 Patch This should take care of the problem OlegHi Oleg Looks pretty good to me. My only suggestion would be to log the UnsupportedEncodingExceptions. Though they are probably not common we definitely want to know when they occur. MikeUnsupportedEncodingException logs added. I have applied the patch without any further review as the fix was pretty straight-forward Oleg
