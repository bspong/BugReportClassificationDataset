 PATCH FilePart fails to send data on second call to send
When using a FilePart with the MultipartPostMethod and a server that requires authentication the first call to FilePart.send sends the data correctly and HttpClient receives an unauthorized response from the server. If HttpClient is set to automatically handle authentication attempts it then attempts to send the FilePart again at which time the InputStream FilePart reads from is empty so it doesn t send any data. Due to this the data actually sent by HttpClient doesn t match the content length specified so the server continues to wait for the data and doesn t respond leaving HttpClient to timeout while waiting for a response. This occurs with the latest source from CVS as of 16 October 2002.Created an attachment id 3482 Patch to add buffering to FilePart. The attached patch adds a buffer to FilePart which stores the file data so it can be resent allowing FilePart to work correctly with authenticated servers.I understand the issue the patch is trying to address but this is not the right way to do it. The problem is that the entire file is being buffered in memory. That s fine if the file is small and there s only one but if you re trying to upload multiple large files this will just run the system out of memory.Agreed that buffering in memory isn t desirable however if only an InputStream is given there isn t a lot of choice. This new patch provides the option to turn buffering on and off and does not buffer in RAM if a java.io.File is provided it creates a new FileInputStream each time instead . While it is possible to take an InputStream and buffer the data to a file this seems somewhat redundant when a File can be taken as a parameter anyway and it is a part designed for file uploading. I have enabled buffering by default as without it HttpClient will hang if authentication or a redirect is required and default settings should avoid that.Created an attachment id 3494 New patch disregard the previous patch. Another possibility would be to use mark reset if it s available on the supplied InputStream. That would be kinda nice.Excellent idea. I ve implemented that so please ignore the current patch. It s getting too complex for me to be confident without specific test cases though. I ll look into those when I get a chance.Created an attachment id 3495 Latest patch ignore previous ones. No test cases yet. HttpClient test cases won t run for me at all and I don t have time to struggle with it just yet. I ve uploaded the patch in case anyone has the inspiration to write tests before I get around to it otherwise I ll follow up during the week sometime.Created an attachment id 3624 Patch to add tests for parts to TestNoHost. Created an attachment id 3625 Tests for resending part data. These two patches add test cases for this fix. It would be good to get this fix committed. There s still more test cases that need to be written for MultipartPostMethod but these are the only ones relevant to this bug.Patches 3495 3624 3625 committed.Adrian it appears that this bug is fixed. Can it be closed Yes I believe this bug should have been closed quite some time ago.Currently in REMIND state need to close.
