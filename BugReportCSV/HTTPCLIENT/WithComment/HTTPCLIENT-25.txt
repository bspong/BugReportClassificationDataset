 httpclient Incorrect credentials loop infinitely
If incorrect credentials are assigned to the request HttpClient will loop forever. It should only try once and fail with an HttpException if a request with credentials set fails. In org.apache.commons.httpclient.HttpMethodBase.execute a check is needed to track if credentials have been sent before.I m not sure when or how this is fixed but it appears to be working well. I tried it with both setting the default credentials as a startSession argument and by adding particular credentials for a specific authentication realm with setCredentials . In HttpMethodBase.execute the following code checks to see if an authentication was done on the path type realm realm string. If it has then it breaks out and returns from execute. If it has not been tried it sets the authentication and trys again. code                     if realms.contains pathAndCreds                         if log.isInfoEnabled                             log.info Already tried to authenticate to wwwauth.getValue but still receiving HttpStatus.SC UNAUTHORIZED .                                                  break                      else                         realms.add pathAndCreds                      code That being said the code above is in a for loop with some complicated code in it. It does have some good error checking code in there for infinite re-direction and such but I have not attempted to test all the possibilities. Perhaps the reporter of this bug could re-test and provide a more detailed test scenario if it still occurs.Sorry for the delay but I am again looking into this as I am trying to use the newest version of HttpClient and am having the same problem as before. I am trying this with yesterday s source code 9 9 02 . Looking at the code it does not match the previous explanation perhaps it s been changed again . At line 701 in HttpMethodBase.execute code   case HttpStatus.SC UNAUTHORIZED   case HttpStatus.SC PROXY AUTHENTICATION REQUIRED       log.debug Authorization required       if doAuthentication process authentication response            if the authentication is successful return the statusCode            otherwise drop through the switch and try again.           if processAuthenticationResponse state conn               return statusCode                   else let the client handle the authenticaiton           return statusCode              break code The comment indicates that the code will retry if the authentication attempt fails. This would make sense if an end user was being prompted for new credentials but this is not the case for me. It will try the same credentials over and over up to maxForwards 100 . Let me know if you need more details. Best regards Paul.I m adding my new email address to the CC list as I m not sure the old one will continue to work. I m also switching the version to Nightly Builds .WFM with current codeThis bug is fixed... sorry I didn t mark this as verified earlier.I encounter the same problem with 3.0 RC 3.Please provide a wirelog a test case or at least a code snippet to demonstrate the problemI use httpclient through htmlunit to call a page needing Basic authorization using a wrong credential. The htmlunit code is quite simple  final WebClient webClient new WebClient  final DefaultCredentialsProvider cp new DefaultCredentialsProvider  cp.addCredentials toto tototo  webClient.setCredentialsProvider cp  webClient.getPage new URL http localhost 8080 jn public xml2 toto basically it just sets the provided credential provider as parameter of the HttpClient  client.getParams .setParameter CredentialsProvider.PROVIDER getWebClient .getCredentialsProvider The wirelog looks like DEBUG 10 03 59 371 httpclient.wire.header - GET jn public xml2 toto HTTP 1.1 r n DEBUG 10 03 59 372 httpclient.wire.header - User-Agent Mozilla 4.0 compatible MSIE 6.0b Windows 98 r n DEBUG 10 03 59 372 httpclient.wire.header - Authorization Basic dG90bzp0b3RvdG8 r n DEBUG 10 03 59 372 httpclient.wire.header - Host localhost 8080 r n DEBUG 10 03 59 372 httpclient.wire.header - r n DEBUG 10 03 59 385 httpclient.wire.header - HTTP 1.1 401 Unauthorized r n DEBUG 10 03 59 385 httpclient.wire.header - Server Apache-Coyote 1.1 r n DEBUG 10 03 59 385 httpclient.wire.header - Pragma No-cache r n DEBUG 10 03 59 385 httpclient.wire.header - Cache-Control no-cache r n DEBUG 10 03 59 385 httpclient.wire.header - Expires Thu 01 Jan 1970 01 00 00 CET r n DEBUG 10 03 59 385 httpclient.wire.header - WWW-Authenticate Basic realm Jugendnetz restricted area r n DEBUG 10 03 59 385 httpclient.wire.header - Content-Type text html charset utf-8 r n DEBUG 10 03 59 385 httpclient.wire.header - Content-Length 952 r n DEBUG 10 03 59 385 httpclient.wire.header - Date Wed 10 Aug 2005 08 03 58 GMT r n DEBUG 10 03 59 388 httpclient.wire.header - GET jn public xml2 toto HTTP 1.1 r n DEBUG 10 03 59 389 httpclient.wire.header - User-Agent Mozilla 4.0 compatible MSIE 6.0b Windows 98 r n DEBUG 10 03 59 389 httpclient.wire.header - Authorization Basic dG90bzp0b3RvdG8 r n DEBUG 10 03 59 389 httpclient.wire.header - Host localhost 8080 r n DEBUG 10 03 59 389 httpclient.wire.header - r n DEBUG 10 03 59 393 httpclient.wire.header - HTTP 1.1 401 Unauthorized r n DEBUG 10 03 59 393 httpclient.wire.header - Server Apache-Coyote 1.1 r n DEBUG 10 03 59 393 httpclient.wire.header - Pragma No-cache r n DEBUG 10 03 59 393 httpclient.wire.header - Cache-Control no-cache r n DEBUG 10 03 59 393 httpclient.wire.header - Expires Thu 01 Jan 1970 01 00 00 CET r n DEBUG 10 03 59 393 httpclient.wire.header - WWW-Authenticate Basic realm Jugendnetz restricted area r n DEBUG 10 03 59 394 httpclient.wire.header - Content-Type text html charset utf-8 r n DEBUG 10 03 59 394 httpclient.wire.header - Content-Length 952 r n DEBUG 10 03 59 394 httpclient.wire.header - Date Wed 10 Aug 2005 08 03 58 GMT r n DEBUG 10 03 59 396 httpclient.wire.header - GET jn public xml2 toto HTTP 1.1 r n DEBUG 10 03 59 397 httpclient.wire.header - User-Agent Mozilla 4.0 compatible MSIE 6.0b Windows 98 r n DEBUG 10 03 59 397 httpclient.wire.header - Authorization Basic dG90bzp0b3RvdG8 r n DEBUG 10 03 59 397 httpclient.wire.header - Host localhost 8080 r n DEBUG 10 03 59 397 httpclient.wire.header - r n etc... allways the same thing again and again . If you prefer I can extract the problem from htmlunit and provide sample code using only httpclient. I don t know how to provide a unit test for this how should the server part be simulated Looking at the code it seems to me that in org.apache.commons.httpclient.HttpMethodDirector line 90 for v1.34 is incorrect and should allow only 1 retry when credential has been provided  if processAuthenticationResponse method    LOG.debug Retry authentication    retry true   Marc Please refer to this discussion thread for detailed explanations http www.mail-archive.com commons-user 40jakarta.apache.org msg12368.html OlegIn this case it would be helpfull to have CredentialsProvider.getCredentials ... provide information to know if it is a retry or not or even better the number of failed retry . In reply to comment 10 In this case it would be helpfull to have CredentialsProvider.getCredentials ... provide information to know if it is a retry or not or even better the number of failed retry . Marc Custom credentials providers are meant to maintain a map of credentials and return null if credentials have already been tried for the given auth scope OlegThis means that a CredentialProvider is only asked once for an auth scope when the returned credential works. Is that correct Does the HttpClient cache the valid returned credentials In reply to comment 12 This means that a CredentialProvider is only asked once for an auth scope when the returned credential works. Is that correct Does the HttpClient cache the valid returned credentials Yes it does. That s what HttpState is for OlegThanks. I can make the fix in htmlunit without impact on the API.
