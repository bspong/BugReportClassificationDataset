Redirect and Kerberos authentication in conflict
We are using the HttpClient to connect to a Website that uses Kerberos-Authentication. Beware this trigger word Kerberos I think this is not the problem but please read on. Here is the sequence of events Client GET Server Unauthorized. Client GET and includes authentication. Server 302 to something on the same host this shows that in principle authentication works Client GET something does not include authentication Server Unauthorized Client quits with 401-Unauthorized. I would have expected one of the following instead 1 Client immediately sends authorization information with the redirected GET something 2 Client re-requests the something with authorization after 401-Unauthorized. We could get around the problem by setting the ConnectionReuseStrategy to a constant false. It would be great if someone could tell me if HttpClient works as expected or whether there is a bug or misconfiguration lurking. Thanks Harald. Could you please attach a complete wire context log of the session 1 Oleg 1 http hc.apache.org httpcomponents-client-ga logging.htmlThe file logFrom401Example.txt contains the logs you requested. The same session can be found logged with wireshark in wiresharkFrom401.txt. Further the examples.txt contains the relevant code snippets we use. One triggers the 401. In the meantime we found one more workaround. Both workarounds are shown in exmples.txt. One uses NoReuseStrategy and the other explicitly sets the port 80 and protocol http. Harald.Harald Would it be a big deal for you attach wire context logs generated with this works and this also works examples OlegHello Oleg no big deal except I have to relay this to my colleagues tomorrow. But we will get you the logs. Harald. Here come the logs pertaining to the this works and this also works code snippets in the examples.txt attachments. Harald.Harald Many thanks for the logs. It may take a while before I get around to looking at them though. I am in the process of rewriting the auth framework in HttpClient for the 4.2 release 1 . I will eventually look at your case and will try to make sure that the Kerberos authentication gets re-tried correctly on redirects. Please just bear with me. Oleg 1 https issues.apache.org jira browse HTTPCLIENT-1107Harald One thing I do not understand. Why does HttpClient need to re-authenticate on redirect in the first place This makes no sense as the connection has been already authenticated and HttpClient re-uses the same connection for redirected request. Am I missing something OlegWell I am not the expert on kerberos and HTTP and all that but from the groud up HTTP is stateless. Consequently the client must in every request send authenticating information of some kind or will get a 401. When the client succeeds with authentication it gets a redirect. Then it sends a new GET to the redirect address but as we see from the logs it does not send any authorization information. The header   Authorization Negotiate YIIK7gYGK... is not send but I would expect this to be the case. Whether the same authentication string is allowed for the now different URL is beyond my knowledge. Harald. Well there are authentication schemes in existence that authenticate connections not requests for instance NTLM. Truth to be told I know next to nothing about kerberos but I always assumed kerberos was used to authenticate connections like NTLM not individual requests. Can you try the following bit of code and let me know if that makes any difference DefaultHttpClient httpclient new DefaultHttpClient AuthSchemeFactory asf new AuthSchemeFactory     public AuthScheme newInstance HttpParams params         return new NegotiateScheme              Override             public boolean isConnectionBased                 return false                            httpclient.getAuthSchemes .register AuthPolicy.SPNEGO asf OlegHi Oleg we tried the code below and it threw an exception as shown in the attachment. Harald.     DefaultHttpClient client new DefaultHttpClient          UsernamePasswordCredentials creds new UsernamePasswordCredentials username password     client.getCredentialsProvider .setCredentials new AuthScope AuthScope.ANY HOST AuthScope.ANY PORT AuthScope.ANY REALM AuthPolicy.SPNEGO creds          AuthSchemeFactory asf new AuthSchemeFactory       public AuthScheme newInstance HttpParams params           return new NegotiateScheme                Override               public boolean isConnectionBased                   return false                                       client.getAuthSchemes .register AuthPolicy.SPNEGO asf      HttpGet httphead new HttpGet http moss-test        HttpResponse response client.execute httphead throws an IllegalStateException see logs Harald Could you please apply this patch HTTPCLIENT-1129-fix-take1.patch to a snapshot of either SVN trunk or 4.1.2 tag and try one more time OlegHi Oleg we tried the same example code as last time. Something changes as you can see from log-with-fix-take1.txt but still is not working. From the logs I see that now the authentication is send alongside the redirected URL but we still get Unauthorized. As mentioned I am not the kerberos expert and don t know whether a new URL would require fresh different authentication information. I wonder if not reusing the connection is possibly the only correct way to do this. Harald. All right. No luck. Please bear with me though. I am working on a different take to solve the problem. OlegHarald Could you please pull the latest snapshot r1181082 off SVN trunk and give it a try OlegHello Oleg this is straight from my bash history svn export -r 1181082 https svn.apache.org repos asf httpcomponents httpclient trunk httpclient-1181082 cd httpclient-1181082 mvn package This fails in a test Failed tests testAuthSchemeAlreadySet org.apache.http.client.protocol.TestRequestAuthCache expected not same I will try and see how I get around the tests and straight to a jar but I don t know maven at all so if you could tell me this might speed up things. Harald. Just get HEAD of the trunk. OlegHi Oleg I checked out and got svn version 1178262 built client and core and we ran the test. Attachment log-r1178262.txt contains the output. Still not working. Harald I found a bug that caused incorrect handling of the auth state on redirects and also added more debug logs. Could you please get the latest SVN snapshot and try one more time OlegI cannot do much without additional feedback and have to assume the issue has been resolved. Oleg
