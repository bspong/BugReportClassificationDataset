DefaultHttpRequestRetryHandler retryRequest should not retry aborted requests
DefaultHttpRequestRetryHandler retryRequest incorrectly retries aborted requests I have seen the following log messages in JMeter org.apache.http.impl.client.DefaultHttpClient I O exception java.net.SocketException caught when processing request socket closed org.apache.http.impl.client.DefaultHttpClient Retrying request and org.apache.http.impl.client.DefaultHttpClient I O exception java.net.BindException caught when connecting to the target host Address already in use connect org.apache.http.impl.client.DefaultHttpClient Retrying connect The abort method sets the isAborted flag but the retry handler does not check it.A patch and testcase for this issue. The test may have unused imports my env. is still not configured Thanks Patch applied with minor adjustments to remove unused imports in test codeJust discovered that the code does not work if the request is a RequestWrapper because those always return false for isAborted The test cases don t detect this because the mock objects return what is expected by the code this is not necessarily what happens in reality. There should also be some test cases that exercise a real request using a separate thread for the request and the abort.There should also be a test case to ensure that connect is not retried following an abortWill be hard to assert this since AbstractHttpClient does not expose the DefaultRequestDirector it uses which has a reference to the retried execution count.Added request retry test in httpcomponents httpclient trunk httpclient src test java org apache http impl client TestAbortHandling.java r1176137 . Still need to add test for connection abort. Testing with JMeter shows that when an aborted request fails in the connect phase the request is not present in the context. Further if the request is added to the context under a new key for debug purposes the aborted flag is not set. The combination BindException Address already in use connect is the exception generated or at least the commonest .I ve also seen I O exception java.io.IOException caught when connecting to the target host Request aborted Retrying connectTwo test methods that currently fail one for a conection timeout and one for a request aborted before sending it to the server. Didn t had time yet to trace the faults but hopefully they will provide some hints.patch for DefaultHttpRetryHandler should not retry requests for java.net.SocketException Network is unreachable connectThis patch appears to resolve the missing request from the context when the request is aborted. Will require a more experienced person in HC to review it. Moved all test cases for abort handling to TestAbortHandling AbstractPoolEntry now throws InterruptedIOException instead of plain IOException Applied a variation of the patch contributed by Alin Merged fixes to 4.1.x branch Oleg
