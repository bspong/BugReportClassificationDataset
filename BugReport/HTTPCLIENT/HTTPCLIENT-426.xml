<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:17:20 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-426/HTTPCLIENT-426.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-426] httpclient doesn&apos;t read and parse response from certain types of proxy servers when POST method is used</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-426</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>It was determined that when sending post data to server via Squid proxy server&lt;br/&gt;
of version 2.4.STABLE2 and Squid responds &lt;br/&gt;
with &amp;quot;407 proxy authentication required&amp;quot; response, httpclient doesn&amp;#39;t read this&lt;br/&gt;
response in order to parse, but rather&lt;br/&gt;
fails with soket exception &amp;quot;java.net.SocketException: Software caused connection&lt;br/&gt;
abort: recv failed&amp;quot;.&lt;br/&gt;
&lt;br/&gt;
This behaviour is reproduced with the latest nigtly build of httpclient version&lt;br/&gt;
3.0. (from 9 of February 2005) as&lt;br/&gt;
well as 3.0. RC1, 2.0.2 and 2.0.&lt;br/&gt;
&lt;br/&gt;
This is the piece of code that sends post data using httpclient:&lt;br/&gt;
&lt;br/&gt;
try&lt;br/&gt;
{&lt;br/&gt;
	HttpClientParams httpClientParams = new HttpClientParams();&lt;br/&gt;
	HttpClient client = new HttpClient(httpClientParams);&lt;br/&gt;
&lt;br/&gt;
	HostConfiguration hostconfig = new HostConfiguration();&lt;br/&gt;
	hostconfig.setProxy(&amp;quot;db00-devl.eps.agfa.be&amp;quot;, 3128); // SQUID proxy server&lt;br/&gt;
version 2.4.STABLE2&lt;br/&gt;
	client.setHostConfiguration(hostconfig);&lt;br/&gt;
	PostMethod postMethod = new&lt;br/&gt;
PostMethod(&amp;quot;&lt;a href=&quot;http://brugge.eps.agfa.be/portal03/servlet/selectFiles&quot;&gt;http://brugge.eps.agfa.be/portal03/servlet/selectFiles&lt;/a&gt;&amp;quot;);&lt;br/&gt;
&lt;br/&gt;
	postMethod.addParameter(&amp;quot;data&amp;quot;, &amp;quot;some data&amp;quot;);&lt;br/&gt;
	int status = client.executeMethod(postMethod);&lt;br/&gt;
	System.out.println(&amp;quot;status = &amp;quot; + status);&lt;br/&gt;
	if (status == HttpStatus.SC_OK)&lt;br/&gt;
		System.out.println(&amp;quot;Ok&amp;quot;);&lt;br/&gt;
	else if (status == HttpStatus.SC_PROXY_AUTHENTICATION_REQUIRED)&lt;br/&gt;
		System.out.println(&amp;quot;Proxy authentication required.&amp;quot;);&lt;br/&gt;
}&lt;br/&gt;
catch (Exception e)&lt;br/&gt;
{&lt;br/&gt;
	System.out.println(&amp;quot;Socket exception.&amp;quot;);&lt;br/&gt;
	e.printStackTrace();&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
Look at &amp;quot;debug log of the problem&amp;quot; attachment to see all output from httpclient&lt;br/&gt;
and mentioned piece of code.&lt;br/&gt;
In &amp;quot;problem_request_response_interaction&amp;quot; attacment it is possible to see&lt;br/&gt;
interaction beetween httpclient and Squid proxy server: httpclient sends initial&lt;br/&gt;
request and headers, then squid responds with &amp;quot;proxy authentication required&amp;quot;&lt;br/&gt;
response and afterwards httpclient tries to send post data(without reading the&lt;br/&gt;
response) but fails because connection is already closed.&lt;br/&gt;
&lt;br/&gt;
For more details look at &amp;quot;ethereal_problem&amp;quot; attachment for all network traffic&lt;br/&gt;
during running of mentioned piece of code:&lt;br/&gt;
Ethereal protocol analyzer can be used to open this file(&lt;a href=&quot;http://www.ethereal.com/&quot;&gt;http://www.ethereal.com/&lt;/a&gt;).&lt;br/&gt;
&lt;br/&gt;
Most likely this particular version of Squid closes connection after it sends&lt;br/&gt;
proxy athentication response back,&lt;br/&gt;
which causes httpclient to fail while sending post data.&lt;br/&gt;
&lt;br/&gt;
Let&amp;#39;s have a look at what writeRequest(...) method of HttpMethodBase class does:&lt;br/&gt;
&lt;br/&gt;
1) sends request line and headers to server,&lt;br/&gt;
2) handles &amp;#39;Expect: 100-continue&amp;#39; handshake if needed,&lt;br/&gt;
3) sends post data to server.&lt;br/&gt;
&lt;br/&gt;
My question is should HTTPClient send initial request and headers before data&lt;br/&gt;
even if it is not going to read &lt;br/&gt;
a response from the server(proxy server), or this should be done only in case of&lt;br/&gt;
&amp;#39;Expect: 100-continue&amp;#39; handshake &lt;br/&gt;
(this seems the only case when HTTPClient is going to listen to server&lt;br/&gt;
in-between of steps 1 and 3)?&lt;br/&gt;
&lt;br/&gt;
My understanding is that the command&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// make sure the status line and headers have been sent&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;conn.flushRequestOutputStream();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
which actually splits sending of data in two parts are needed only for &amp;#39;Expect:&lt;br/&gt;
100-continue&amp;#39; handshake case.&lt;br/&gt;
Just by moving &amp;quot;flush&amp;quot; command to appropriate place inside &amp;#39;Expect:&lt;br/&gt;
100-continue&amp;#39; handshake case:&lt;br/&gt;
		.....&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
	            conn.flushRequestOutputStream(); // moved&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;conn.setSocketTimeout(RESPONSE_WAIT_TIME_MS);&lt;br/&gt;
		.....&lt;br/&gt;
it is posible to solve described problem.&lt;br/&gt;
&lt;br/&gt;
I created PostMethodEx that overrides writeRequest(...) method of&lt;br/&gt;
HttpMethodBase(look at &amp;quot;PostMethodEx&amp;quot; attachment) &lt;br/&gt;
and for all cases but the &amp;#39;Expect: 100-continue&amp;#39; handshake it sends request&lt;br/&gt;
line, headers and post data to server &lt;br/&gt;
at once.&lt;br/&gt;
&lt;br/&gt;
When mentioned piece of code(with PostMethod changed to PostMethodEx) is&lt;br/&gt;
executed everyting works fine:&lt;br/&gt;
look at &amp;quot;debug log of the fix&amp;quot;, &amp;quot;fix_request_response_interaction&amp;quot; and&lt;br/&gt;
&amp;quot;ethereal_fix&amp;quot;(all network trafic) &lt;br/&gt;
attachments.&lt;br/&gt;
&lt;br/&gt;
According to mentioned logs httpclient sends all post data at once and then&lt;br/&gt;
reads and parses &amp;quot;proxy authentication required&amp;quot; &lt;br/&gt;
response from squid and sets status code to 407. Correct.</description>
                <environment>Operating System: Windows XP&lt;br/&gt;
Platform: PC</environment>
            <key id="12333985">HTTPCLIENT-426</key>
            <summary>httpclient doesn&apos;t read and parse response from certain types of proxy servers when POST method is used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="peter.tolmachov@agfa.com">peter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Feb 2005 00:56:50 +0000</created>
                <updated>Wed, 16 Feb 2011 20:43:52 +0000</updated>
                    <resolved>Sun, 22 Apr 2007 08:10:57 +0100</resolved>
                            <version>Snapshot</version>
                                <fixVersion>3.0 Final</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12382132" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 00:58:50 +0000"  >Created an attachment (id=14223)&lt;br/&gt;
debug log of the problem&lt;br/&gt;
</comment>
                    <comment id="12382133" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 00:59:41 +0000"  >Created an attachment (id=14224)&lt;br/&gt;
problem_request_response_interaction&lt;br/&gt;
</comment>
                    <comment id="12382134" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:03:15 +0000"  >Created an attachment (id=14225)&lt;br/&gt;
ethereal_problem	    ethereal log (&lt;a href=&quot;http://www.ethereal.com/&quot;&gt;http://www.ethereal.com/&lt;/a&gt;)&lt;br/&gt;
</comment>
                    <comment id="12382135" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:05:12 +0000"  >Created an attachment (id=14226)&lt;br/&gt;
PostMethodEx&lt;br/&gt;
</comment>
                    <comment id="12382136" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:05:37 +0000"  >Created an attachment (id=14227)&lt;br/&gt;
debug log of the fix&lt;br/&gt;
</comment>
                    <comment id="12382137" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:06:29 +0000"  >Created an attachment (id=14228)&lt;br/&gt;
fix_request_response_interaction&lt;br/&gt;
</comment>
                    <comment id="12382138" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:07:57 +0000"  >Created an attachment (id=14229)&lt;br/&gt;
ethereal_fix (ethereal is required to view this file)&lt;br/&gt;
</comment>
                    <comment id="12382139" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:10:47 +0000"  >Created an attachment (id=14230)&lt;br/&gt;
ethereal_fix (ethereal	is required to view this file)&lt;br/&gt;
</comment>
                    <comment id="12382140" author="olegk" created="Thu, 10 Feb 2005 05:34:45 +0000"  >Fair enough. A patch to follow shortly.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12382141" author="olegk" created="Thu, 10 Feb 2005 05:36:55 +0000"  >Created an attachment (id=14234)&lt;br/&gt;
Patch (take 1)&lt;br/&gt;
&lt;br/&gt;
Folks, let me know what you think. If I hear no loud complaints, I&amp;#39;ll commit&lt;br/&gt;
the patch in a few days.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12382142" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 16:37:07 +0000"  >Thanx a lot!&lt;br/&gt;
&lt;br/&gt;
Peter</comment>
                    <comment id="12382143" author="rolweber@de.ibm.com" created="Thu, 10 Feb 2005 18:25:24 +0000"  >What is going to happen if the POST data exceeds the buffer size?&lt;br/&gt;
Will the socket be closed after the first buffer flush, leading to&lt;br/&gt;
a write error while the rest of the data is posted?&lt;br/&gt;
&lt;br/&gt;
The patch is fine for the reported problem. I am just curious whether&lt;br/&gt;
we may have hit a more fundamental problem. Of course we can always&lt;br/&gt;
tell people to use expect-continue when posting large data.&lt;br/&gt;
&lt;br/&gt;
cheers,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Roland</comment>
                    <comment id="12382144" author="oglueck" created="Thu, 10 Feb 2005 18:28:38 +0000"  >Weird bug. It seems like fundamental functionality is broken. Is this not&lt;br/&gt;
covered by any test case?</comment>
                    <comment id="12382145" author="olegk" created="Thu, 10 Feb 2005 18:36:52 +0000"  >Cmon, folks&lt;br/&gt;
This issue has been beaten to death on more than one occasion. See &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-123&quot; title=&quot;MultipartPostMethod does not check for error messages&quot;&gt;&lt;strike&gt;HTTPCLIENT-123&lt;/strike&gt;&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12382146" author="oglueck" created="Thu, 10 Feb 2005 18:41:12 +0000"  >Okay Oleg, but here it&amp;#39;s the proxy, not the final server. Anyway, does this&lt;br/&gt;
happen when using 100-continue handshake?</comment>
                    <comment id="12382147" author="olegk" created="Thu, 10 Feb 2005 18:45:05 +0000"  >If the proxy correctly implements &amp;#39;100-continue handshake&amp;#39; it should not happen&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12382148" author="olegk" created="Mon, 14 Feb 2005 02:27:01 +0000"  >Patch committed. Many thanks, Peter&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12382149" author="peter.tolmachov@agfa.com" created="Mon, 14 Feb 2005 16:33:14 +0000"  >You Welcome!&lt;br/&gt;
&lt;br/&gt;
Peter.</comment>
                </comments>
                    <attachments>
                    <attachment id="12327199" name="ASF.LICENSE.NOT.GRANTED--bufferflush.patch" size="1788" author="olegk" created="Thu, 10 Feb 2005 05:36:55 +0000" />
                    <attachment id="12327195" name="ASF.LICENSE.NOT.GRANTED--debug log of the fix.TXT" size="6104" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:05:37 +0000" />
                    <attachment id="12327191" name="ASF.LICENSE.NOT.GRANTED--debug log of the problem.txt" size="5795" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 00:58:50 +0000" />
                    <attachment id="12327198" name="ASF.LICENSE.NOT.GRANTED--ethereal_fix.out" size="43771" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:10:47 +0000" />
                    <attachment id="12327197" name="ASF.LICENSE.NOT.GRANTED--ethereal_fix.out" size="43771" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:07:57 +0000" />
                    <attachment id="12327193" name="ASF.LICENSE.NOT.GRANTED--ethereal_problem.out" size="21145" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:03:15 +0000" />
                    <attachment id="12327196" name="ASF.LICENSE.NOT.GRANTED--fix_request_response_interaction.TXT" size="1780" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:06:29 +0000" />
                    <attachment id="12327194" name="ASF.LICENSE.NOT.GRANTED--PostMethodEx.java" size="5420" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 01:05:12 +0000" />
                    <attachment id="12327192" name="ASF.LICENSE.NOT.GRANTED--problem_request_response_interaction.TXT" size="1780" author="peter.tolmachov@agfa.com" created="Thu, 10 Feb 2005 00:59:41 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>9.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                <customfieldname>Bugzilla Id</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>33468</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 10 Feb 2005 05:34:45 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133473</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>47222</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>