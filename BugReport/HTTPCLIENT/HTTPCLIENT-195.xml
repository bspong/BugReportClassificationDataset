<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:14:37 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-195/HTTPCLIENT-195.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-195] NTLM authentication failed due to closing of connection</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-195</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>Description:&lt;br/&gt;
&lt;br/&gt;
When dealing with a NTLM proxy server that sends response back with lines:&lt;br/&gt;
&lt;br/&gt;
14:51:27:750 &amp;lt;&amp;lt; HTTP/1.0 407 Proxy Authentication Required&lt;br/&gt;
14:51:27:796 &amp;lt;&amp;lt; Date: Mon, 14 Apr 2003 19:52:43GMT[\r][\n]&lt;br/&gt;
14:51:27:796 &amp;lt;&amp;lt; Content-Length: 257[\r][\n]&lt;br/&gt;
14:51:27:796 &amp;lt;&amp;lt; Content-Type: text/html[\r][\n]&lt;br/&gt;
14:51:27:796 &amp;lt;&amp;lt; Server: NetCache appliance (NetApp/5.3.1R1)[\r][\n]&lt;br/&gt;
14:51:27:796 &amp;lt;&amp;lt; Connection: keep-alive[\r][\n]&lt;br/&gt;
14:51:27:796 &amp;lt;&amp;lt; Proxy-Authenticate: NTLM &lt;br/&gt;
TlRMTVNTUAACAAAABgAGACgAAAAGggEAtOoNy4M0g0EAAAAAAAAAAEdMT0JBTA==[\r][\n]&lt;br/&gt;
&lt;br/&gt;
The httpClient code is using the &amp;quot;HTTP/1.0&amp;quot; as clue for closing the connection &lt;br/&gt;
and ignored the &amp;quot;Connection: keep-alive&amp;quot;.  That caused the NTLM authentication &lt;br/&gt;
to fail as the NTLM requires the response to the challenge to be sent back on &lt;br/&gt;
the same connection.&lt;br/&gt;
&lt;br/&gt;
Proposed Fix:&lt;br/&gt;
&lt;br/&gt;
Our fix is to add a flag inProxyAuthenticationRetry (in HttpMethodBase) to &lt;br/&gt;
indicate that the method is doing proxy authentication retry.  When the flag is &lt;br/&gt;
true, in &amp;quot;HttpMethodBase.shouldCloseConnection&amp;quot;, check the &amp;quot;Connection: keep-&lt;br/&gt;
alive&amp;quot; before determining to close the connection.</description>
                <environment>Operating System: other&lt;br/&gt;
Platform: PC</environment>
            <key id="12333754">HTTPCLIENT-195</key>
            <summary>NTLM authentication failed due to closing of connection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="bin.chen@sabre-holdings.com">Bin Chen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Apr 2003 03:31:33 +0100</created>
                <updated>Wed, 16 Feb 2011 20:44:38 +0000</updated>
                    <resolved>Sun, 22 Apr 2007 08:10:20 +0100</resolved>
                            <version>2.0 Alpha 3</version>
                                <fixVersion>2.0 Beta 1</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12380210" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:32:46 +0100"  >Created an attachment (id=5956)&lt;br/&gt;
wire log for failed connections.&lt;br/&gt;
</comment>
                    <comment id="12380211" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:33:25 +0100"  >Created an attachment (id=5957)&lt;br/&gt;
wire log after the fix.&lt;br/&gt;
</comment>
                    <comment id="12380212" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:38:19 +0100"  >Created an attachment (id=5958)&lt;br/&gt;
initialize inProxyAuthenticationRetry in HttpMethodBase.execute&lt;br/&gt;
</comment>
                    <comment id="12380213" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:39:22 +0100"  >Created an attachment (id=5959)&lt;br/&gt;
Set inProxyAuthenticationRetry to true in HttpMethodBase.processAuthenticationResponse&lt;br/&gt;
</comment>
                    <comment id="12380214" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:41:08 +0100"  >Created an attachment (id=5960)&lt;br/&gt;
check &amp;quot;keep-alive&amp;quot; connection header before closing connection&lt;br/&gt;
</comment>
                    <comment id="12380215" author="olegk" created="Wed, 23 Apr 2003 05:08:13 +0100"  >Bin, what version of HttpClient are you using? The wire log does not seem to&lt;br/&gt;
have been produced with a recent nightly build. HttpClient is a rapidly evolving&lt;br/&gt;
library and we simply can&amp;#39;t support anything else but the CVS HEAD. So, please&lt;br/&gt;
make sure that you can reproduce the alleged bug with the most recent CVS snapshot.&lt;br/&gt;
&lt;br/&gt;
And, please, please, please submit patches in diff format&lt;br/&gt;
&lt;br/&gt;
Oleg </comment>
                    <comment id="12380216" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 05:28:19 +0100"  >The version of httpClient was taken from a nightly build (0307).  We are in a &lt;br/&gt;
release schedule so we can not keep moving to the latest nightly build.  We did &lt;br/&gt;
try the 0410 build and it di not work at all.  We just finished fixing the &lt;br/&gt;
problems in the (0307) version so we can do our release with it.  I am just &lt;br/&gt;
coming back to submit the bugs and hopefully get them fix for the 2.0 final &lt;br/&gt;
release.  Depend on how much time I have, I may or may not be able to reproduce &lt;br/&gt;
the same problems in latest build.  I will try my best.  I am also trying to &lt;br/&gt;
get CVS setup so I can do a proper diff for patches.&lt;br/&gt;
&lt;br/&gt;
Part of the difficulty in reporducing the problem is to find a NTLM proxy &lt;br/&gt;
server that send the response like that (HTTP/1.0 and keep-alive).  </comment>
                    <comment id="12380217" author="becke@u.washington.edu" created="Wed, 23 Apr 2003 09:30:29 +0100"  >This problem brings up a number of questions.  The first being: should we allow persistent &lt;br/&gt;
connections with HTTP 1.0?  From looking at RFC 2068 and 1945 the answer seems to be maybe.  &lt;br/&gt;
If the host responds with &amp;quot;keep-alive&amp;quot; I think we should.  In the case of a proxied connection &lt;br/&gt;
things are a little more hazy.  It seems like we should not use Connection headers in this case, but &lt;br/&gt;
should still honor them.  I am not sure though.&lt;br/&gt;
&lt;br/&gt;
Either way I think we should accept &amp;quot;keep-alive&amp;quot; headers in the case of HTTP 1.0 and I will attach a &lt;br/&gt;
patch for this in a minute.&lt;br/&gt;
&lt;br/&gt;
On the proxy front I think we need a little more discussion.  In the particular case of an NTLM &lt;br/&gt;
proxy I completely defer to Adrian.  I fortunately have no idea how NTLM works :)  &lt;br/&gt;
&lt;br/&gt;
Does NTLM plus an HTTP 1.0 proxy ever work?  In a browser?  If so there must be some way to &lt;br/&gt;
make it work for us.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380218" author="becke@u.washington.edu" created="Wed, 23 Apr 2003 09:31:13 +0100"  >Created an attachment (id=5967)&lt;br/&gt;
shouldCloseConnection() patch&lt;br/&gt;
</comment>
                    <comment id="12380219" author="olegk" created="Fri, 25 Apr 2003 17:09:50 +0100"  >Mike, I think it makes sense to commit the keep-alive patch. The NTLM proxy&lt;br/&gt;
issue should be addressed separately, I suppose, along with the related &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-200&quot; title=&quot;NTLM proxy authentication for https failed&quot;&gt;&lt;strike&gt;HTTPCLIENT-200&lt;/strike&gt;&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380220" author="adrian@ephox.com" created="Fri, 25 Apr 2003 18:56:37 +0100"  >Sorry, I missed this one in the recent flurry of NTLM related problems.  NTLM will work with any&lt;br/&gt;
setup which has:&lt;br/&gt;
&lt;br/&gt;
1. Only one step of the process using NTLM authentication (ie: can&amp;#39;t authenticate to a proxy and&lt;br/&gt;
the webserver using NTLM)&lt;br/&gt;
&lt;br/&gt;
2. Persistent connections.  NTLM authentications the connection not the request.&lt;br/&gt;
&lt;br/&gt;
So if it is appropriate for a HTTP 1.0 proxy to support keep-alive then doing so would allow&lt;br/&gt;
NTLM to work.</comment>
                    <comment id="12380221" author="olegk" created="Sat, 26 Apr 2003 02:15:26 +0100"  >Bin, we believe that the bug has been fixed. Please re-test your application&lt;br/&gt;
with the most recent CVS snapshot. If the problem persists, just reopen the bug&lt;br/&gt;
report&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380222" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 04:22:17 +0100"  >The patch did not work.  I will attach latest log.</comment>
                    <comment id="12380223" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 04:23:04 +0100"  >Created an attachment (id=6019)&lt;br/&gt;
trace/debug/wire log&lt;br/&gt;
</comment>
                    <comment id="12380224" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 05:50:20 +0100"  >I added a debug line and it shows that the connectHeader is null.  But the wire &lt;br/&gt;
log (see previous attachement) clearly shows the header being there.&lt;br/&gt;
&lt;br/&gt;
--- tip/HttpMethodBase.java	2003-04-25 13:45:16.000000000 -0500&lt;br/&gt;
+++ HttpMethodBase.java	2003-04-25 16:16:26.000000000 -0500&lt;br/&gt;
@@ -873,6 +873,7 @@&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} else {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;connectionHeader = getResponseHeader(&amp;quot;proxy-connection&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
+        LOG.debug (&amp;quot;connectionHeader = &amp;quot; + connectionHeader);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (connectionHeader != null) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (connectionHeader.getValue().equalsIgnoreCase(&amp;quot;close&amp;quot;)) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (LOG.isDebugEnabled()) {&lt;br/&gt;
</comment>
                    <comment id="12380225" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 05:57:40 +0100"  >Created an attachment (id=6020)&lt;br/&gt;
Log shows connectionHeader is null&lt;br/&gt;
</comment>
                    <comment id="12380226" author="olegk" created="Sat, 26 Apr 2003 06:00:48 +0100"  >Excuse me, Bin, but see it for yourself:&lt;br/&gt;
&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;HTTP/1.0 407 Proxy Authentication Required[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;Date: Fri, 25 Apr 2003 19:24:23GMT[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;Content-Length: 257[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;Content-Type: text/html[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;Server: NetCache appliance (NetApp/5.3.1R1)[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;Proxy-Authenticate: NTLM[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;&amp;lt; &amp;quot;Proxy-Authenticate: Basic realm=&amp;quot;proxy server&lt;br/&gt;
sghdqpx03.global.ad.sabre.com&amp;quot;[\r][\n]&amp;quot;&lt;br/&gt;
&amp;lt;...&amp;gt;&lt;br/&gt;
&lt;br/&gt;
The response does not contain &amp;quot;Proxy-connection: keep-alive&amp;quot; header and is of&lt;br/&gt;
version HTTP/1.0. No wonder that HttpClient drops the connection. &lt;br/&gt;
&lt;br/&gt;
I can only suggest one of the following approaches:&lt;br/&gt;
&lt;br/&gt;
1. Report the problem to the Net Appliance folks&lt;br/&gt;
2. Use basic authentication (if permittable by the security guidelines of your&lt;br/&gt;
company)&lt;br/&gt;
3. Hack in that &amp;#39;inProxyAuthenticationRetry&amp;#39; flag back again.&lt;br/&gt;
&lt;br/&gt;
If you decide to pursue the third option, I doubt that we would accept this&lt;br/&gt;
patch into HttpClient code trunk. I am going to setup squid proxy with NTLM&lt;br/&gt;
authentication next week and run a few tests. If squid also omits the keep-alive&lt;br/&gt;
header, we&amp;#39;ll have to consider the work-around you proposed. Otherwise, you&amp;#39;ll&lt;br/&gt;
have to live with a fork of your own.&lt;br/&gt;
&lt;br/&gt;
I leave the bug open until tested against &amp;#39;squid&amp;#39; proxy. If &amp;#39;squid&amp;#39; does not&lt;br/&gt;
exhibit the same behavior with regard to the keep-alive header, the bug will be&lt;br/&gt;
marked as invalid  &lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380227" author="olegk" created="Sat, 26 Apr 2003 06:04:40 +0100"  >*** &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-200&quot; title=&quot;NTLM proxy authentication for https failed&quot;&gt;&lt;strike&gt;HTTPCLIENT-200&lt;/strike&gt;&lt;/a&gt; has been marked as a duplicate of this bug. ***</comment>
                    <comment id="12380228" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 06:11:45 +0100"  >Created an attachment (id=6021)&lt;br/&gt;
Another log showing all the headers&lt;br/&gt;
</comment>
                    <comment id="12380229" author="olegk" created="Sat, 26 Apr 2003 06:15:21 +0100"  >OK, I see what is going on here. The proxy responds with &amp;#39;connection:&lt;br/&gt;
keep-alive&amp;#39; header whereas HttpClient expects &amp;#39;proxy-connection: keep-alive&amp;#39;.&lt;br/&gt;
Even though it does not seem to be a very compliant behaviour it can still be&lt;br/&gt;
easily mended. I&amp;#39;ll tweak shouldCloseConnection method a bit. But probably not&lt;br/&gt;
today. It&amp;#39;s kind of late here&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380230" author="olegk" created="Sat, 26 Apr 2003 18:31:54 +0100"  >Fix applied. Please test against the most recent CVS snapshot&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380231" author="fg.java@free.fr" created="Sat, 26 Apr 2003 18:55:43 +0100"  >I&amp;#39;ve tested against the most recent CVS snapshot, but I still have connection&lt;br/&gt;
problem when I try to use a NTLM Proxy (Squid)...&lt;br/&gt;
I think that the client must notify to the proxy that it must keep the connexion&lt;br/&gt;
alive : if you add the request header &amp;quot;Proxy-Connection: Keep-Alive&amp;quot; to the&lt;br/&gt;
method before execute it : it works!&lt;br/&gt;
I don&amp;#39;t know if we must do this for all NTLM proxies or just for Squid...&lt;br/&gt;
&lt;br/&gt;
Fabien</comment>
                    <comment id="12380232" author="olegk" created="Sat, 26 Apr 2003 19:08:24 +0100"  >Fabien,&lt;br/&gt;
&lt;br/&gt;
Wire log would really help. &lt;br/&gt;
&lt;br/&gt;
The problem appears to be squid specific. I am afraid I&amp;#39;ll have to set up squid&lt;br/&gt;
proxy with NTLM authentication at work next week and run a few tests.&lt;br/&gt;
&lt;br/&gt;
So, stay tuned&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380233" author="olegk" created="Mon, 28 Apr 2003 04:09:24 +0100"  >Ok. I think I found the trouble-maker. HttpClient downgrades HTTP protocol&lt;br/&gt;
version to 1.0 in when sending requests via a HTTP/1.0 proxy server. No wonder&lt;br/&gt;
the proxy does not keep the connection alive.&lt;br/&gt;
&lt;br/&gt;
04:24:256[DEBUG] HttpMethod - -Execute loop try 1&lt;br/&gt;
...&lt;br/&gt;
04:24:287[DEBUG] wire - -&amp;gt;&amp;gt; &amp;quot;GET &lt;a href=&quot;http://www.google.fr/&quot;&gt;http://www.google.fr/&lt;/a&gt; HTTP/1.1[\r][\n]&amp;quot;&lt;br/&gt;
...&lt;br/&gt;
04:24:474[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;HTTP/1.0 407 Proxy Authentication Required[\r][\n]&amp;quot;&lt;br/&gt;
...&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Server: squid/2.5.STABLE1-20030121[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Mime-Version: 1.0[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Date: Sat, 26 Apr 2003 11:04:24 GMT[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Content-Type: text/html[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Content-Length: 1289[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Expires: Sat, 26 Apr 2003 11:04:24 GMT[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0[\r][\n]&amp;quot;&lt;br/&gt;
04:24:537[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Proxy-Authenticate: NTLM[\r][\n]&amp;quot;&lt;br/&gt;
04:24:553[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;X-Cache: MISS from roland[\r][\n]&amp;quot;&lt;br/&gt;
04:24:553[DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;Proxy-Connection: close[\r][\n]&amp;quot;&lt;br/&gt;
...&lt;br/&gt;
04:24:803[DEBUG] HttpMethod - -Execute loop try 2&lt;br/&gt;
...&lt;br/&gt;
04:24:818[DEBUG] wire - -&amp;gt;&amp;gt; &amp;quot;GET &lt;a href=&quot;http://www.google.fr/&quot;&gt;http://www.google.fr/&lt;/a&gt; HTTP/1.0[\r][\n]&amp;quot;&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
The question is whether this kind of behavior is wrong or not? Shall 407&lt;br/&gt;
response be treated specially when deciding whether HTTP protocol is to be&lt;br/&gt;
downgraded? Any opinions?&lt;br/&gt;
&lt;br/&gt;
Oleg&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
</comment>
                    <comment id="12380234" author="olegk" created="Mon, 28 Apr 2003 06:18:38 +0100"  >Created an attachment (id=6041)&lt;br/&gt;
HttpMethodBase#readStatusLine&lt;br/&gt;
</comment>
                    <comment id="12380235" author="olegk" created="Mon, 28 Apr 2003 06:21:28 +0100"  >Folks, what do you think about the patch I just attached? I think HTTP version&lt;br/&gt;
of the proxy server should not be taken into consideration by the HttpClient,&lt;br/&gt;
regardless of how we decide to fix the NTLM authetication problem&lt;br/&gt;
&lt;br/&gt;
Oleg </comment>
                    <comment id="12380236" author="becke@u.washington.edu" created="Mon, 28 Apr 2003 08:28:59 +0100"  >This patch justs ignore http version when using a proxy?  It seems like this might fix things for this &lt;br/&gt;
case, but I&amp;#39;m not sure it&amp;#39;s a universal solution.  How will this effect other proxies?&lt;br/&gt;
&lt;br/&gt;
I think Adrian&amp;#39;s idea of always sending keep-alive with NTLM is good, but I would take it even &lt;br/&gt;
futher.  Why not always send keep-alive.  It seems like we might as well always ask for a persistent &lt;br/&gt;
connection.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380237" author="olegk" created="Mon, 28 Apr 2003 19:27:13 +0100"  >Mike,&lt;br/&gt;
&lt;br/&gt;
I respectfully disagree. I believe the proposed solution is more general than&lt;br/&gt;
that discovered by Fabian. Persistent connections with HTTP/1.0 is a dirty and&lt;br/&gt;
an error prone business. The HTTP spec is horribly vague on this issue and we&lt;br/&gt;
should be careful about including &amp;#39;Keep-Alive&amp;#39; token with each and every&lt;br/&gt;
request. I find it extremely confusing. However, as far as proxies are&lt;br/&gt;
concerned, the spec is quite plain. Here&amp;#39;s the exact wording of the RFC 2068&lt;br/&gt;
(more up-to-date RFC 2616 simply refers to this chapter of the RFC 2068):&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
19.7.1 Compatibility with HTTP/1.0 Persistent Connections&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;A client MUST NOT send the Keep-Alive connection token to a proxy&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;server as HTTP/1.0 proxy servers do not obey the rules of HTTP/1.1&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;for parsing the Connection header field.&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
However, since the spec does not mention &amp;#39;proxy-connection&amp;#39; directive at all, I&lt;br/&gt;
suppose we may be a bit more liberal. I believe it should be safe to include&lt;br/&gt;
this header with HTTP/1.0 when communicating via a proxy.&lt;br/&gt;
&lt;br/&gt;
To reiterate my main point here: HttpClient should not take into consideration&lt;br/&gt;
the version of the proxy server, as the proxy server is supposed to be&lt;br/&gt;
absolutely transparent (at least in theory) to the client. If the proxy has an&lt;br/&gt;
issue with a higher version of the HTTP protocol, I believe, it is supposed to&lt;br/&gt;
respond with 501 (NOT IMPLEMENTED) or 505 (WRONG HTTP VERSION). Otherwise, we&lt;br/&gt;
can assume that the proxy is at least aware of the HTTP version in question. &lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
This said, we may still employ &amp;#39;proxy-connection&amp;#39; directive to add an extra&lt;br/&gt;
level of support for some proxies like squid.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ll attach another patch within a few hours and be waiting for additional feedback&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380238" author="olegk" created="Mon, 28 Apr 2003 20:27:18 +0100"  >Created an attachment (id=6045)&lt;br/&gt;
patch (take 1)&lt;br/&gt;
</comment>
                    <comment id="12380239" author="becke@u.washington.edu" created="Mon, 28 Apr 2003 20:54:57 +0100"  >Oleg,&lt;br/&gt;
&lt;br/&gt;
I hear what you are saying.  I agree that &amp;quot;Connection: keep-alive&amp;quot; is not good for proxies, but I &lt;br/&gt;
think &amp;quot;Proxy-connection&amp;quot; is totally safe.  It is quite strange that Proxy-connection is not &lt;br/&gt;
mentioned &lt;br/&gt;
at all in RFC 2616, but that all proxies seem to use it.  From looking at a few newsgroup posts it &lt;br/&gt;
seems that Netscape added proxy-connection support some time ago and it just caught on.&lt;br/&gt;
&lt;br/&gt;
The main reason I suggested adding a &amp;quot;keep-alive&amp;quot; is that it seems this is what all browsers &lt;br/&gt;
(that I &lt;br/&gt;
tried) do.&lt;br/&gt;
&lt;br/&gt;
For now, I would be happy always adding a Proxy-connection keep-alive when communicating &lt;br/&gt;
with &lt;br/&gt;
proxies.  I think we should also investigate connection keep-alive for non-proxied requests.&lt;br/&gt;
&lt;br/&gt;
Are there any side effects of ignoring HTTP version?&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380240" author="olegk" created="Mon, 28 Apr 2003 23:27:52 +0100"  >Clearly, there are side effects. For instance, &amp;#39;expect: 100-continue&amp;#39; handshake&lt;br/&gt;
simply does not work with squid. &lt;br/&gt;
&lt;br/&gt;
The problem is that the only way of knowing what kind of proxy we are dealing&lt;br/&gt;
with is to receive 407 status code. In all other cases HttpClient will happily&lt;br/&gt;
send HTTP/1.1 requests even though the proxy may be compliant with HTTP/1.0 spec&lt;br/&gt;
only. I strongly believe that HttpClient should behave consistently regardless&lt;br/&gt;
of whether proxy authentication is used or not, whether preemptive&lt;br/&gt;
authentication is enabled or not. There should be no code modality. It is by far&lt;br/&gt;
a greater evil, imho&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380241" author="olegk" created="Tue, 29 Apr 2003 03:30:45 +0100"  >Created an attachment (id=6057)&lt;br/&gt;
Patch (take 2)&lt;br/&gt;
</comment>
                    <comment id="12380242" author="becke@u.washington.edu" created="Tue, 29 Apr 2003 04:10:54 +0100"  >Looks good to me.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380243" author="olegk" created="Tue, 29 Apr 2003 04:49:50 +0100"  >Patch applied.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380244" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 00:22:17 +0100"  >New problem:&lt;br/&gt;
&lt;br/&gt;
My NTLM proxy does not like using the same connection between first &amp;quot;CONNECT&amp;quot; &lt;br/&gt;
and the subsequent &amp;quot;CONNECT&amp;quot; with type-1 message.  The issue was created in &lt;br/&gt;
v1.140.  Below is part of the diff between v1.140 and v1.139 that caused &lt;br/&gt;
problem.  I tried to change it back to the way in v1.139, it worked.  I will &lt;br/&gt;
attach logs for both working and non-working tries.&lt;br/&gt;
&lt;br/&gt;
diff -u -r1.139 -r1.140&lt;br/&gt;
...&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (httpVersion.equals(&amp;quot;HTTP/1.0&amp;quot;)) {&lt;br/&gt;
-            http11 = false;&lt;br/&gt;
+            if (!proxied) {&lt;br/&gt;
+                http11 = false;&lt;br/&gt;
+            }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} else if (httpVersion.equals(&amp;quot;HTTP/1.1&amp;quot;)) {&lt;br/&gt;
</comment>
                    <comment id="12380245" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 00:23:23 +0100"  >Created an attachment (id=6129)&lt;br/&gt;
Failed log.  connection NOT closed&lt;br/&gt;
</comment>
                    <comment id="12380246" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 00:24:28 +0100"  >Created an attachment (id=6130)&lt;br/&gt;
success log.  connection CLOSED.&lt;br/&gt;
</comment>
                    <comment id="12380247" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 00:38:50 +0100"  >Highlight the difference of two logs:&lt;br/&gt;
&lt;br/&gt;
In the failed run, due to the check isProxied, the HTTP/1.0 is ignored and the &lt;br/&gt;
connection ie kept open (The proxy server later will fail the authentication &lt;br/&gt;
attempt).  In the success run (restored 1.139 logic), the connection is closed.&lt;br/&gt;
&lt;br/&gt;
Failed run:&lt;br/&gt;
&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;                        &amp;quot;&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [DEBUG] HttpMethod - -Resorting to protocol &lt;br/&gt;
versiondefault close connection policy&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [DEBUG] HttpMethod - -Should NOT close connection, &lt;br/&gt;
using HTTP/1.1.&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [DEBUG] HttpMethod - -Execute loop try 2&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [TRACE] HttpMethod - -enter &lt;br/&gt;
HttpMethodBase.processRequest(HttpState, HttpConnection)&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [TRACE] HttpMethod - -Attempt number 1 to process &lt;br/&gt;
request&lt;br/&gt;
2003/05/01 09:24:14:546 CDT [TRACE] HttpMethod - -enter &lt;br/&gt;
HttpMethodBase.writeRequest(HttpState, HttpConnection)&lt;br/&gt;
&lt;br/&gt;
Success run:&lt;br/&gt;
&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [DEBUG] wire - -&amp;lt;&amp;lt; &amp;quot;                        &amp;quot;&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [DEBUG] HttpMethod - -Resorting to protocol &lt;br/&gt;
versiondefault close connection policy&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [DEBUG] HttpMethod - -Should close connection, &lt;br/&gt;
using HTTP/1.0.&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [TRACE] HttpConnection - -enter HttpConnection.close&lt;br/&gt;
()&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [TRACE] HttpConnection - -enter &lt;br/&gt;
HttpConnection.closeSockedAndStreams()&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [DEBUG] HttpMethod - -Execute loop try 2&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [TRACE] HttpMethod - -enter &lt;br/&gt;
HttpMethodBase.processRequest(HttpState, HttpConnection)&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [TRACE] HttpMethod - -Attempt number 1 to process &lt;br/&gt;
request&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [DEBUG] HttpMethod - -Opening the connection.&lt;br/&gt;
2003/05/01 10:47:26:578 CDT [TRACE] HttpConnection - -enter HttpConnection.open&lt;br/&gt;
()&lt;br/&gt;
2003/05/01 10:47:26:593 CDT [TRACE] HttpMethod - -enter &lt;br/&gt;
HttpMethodBase.writeRequest(HttpState, HttpConnection)&lt;br/&gt;
</comment>
                    <comment id="12380248" author="olegk" created="Fri, 2 May 2003 01:06:01 +0100"  >OK. My fault. Patch will follow in a minute.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380249" author="olegk" created="Fri, 2 May 2003 01:24:30 +0100"  >Created an attachment (id=6131)&lt;br/&gt;
Corrective patch (take 1)&lt;br/&gt;
</comment>
                    <comment id="12380250" author="olegk" created="Fri, 2 May 2003 01:26:35 +0100"  >Bin, could you please apply the patch and let me know if it fixes the problem?&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380251" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 01:38:45 +0100"  >Oleg,&lt;br/&gt;
&lt;br/&gt;
It did not work and I will attach the log.</comment>
                    <comment id="12380252" author="olegk" created="Fri, 2 May 2003 03:12:15 +0100"  >I have to admit my good intentions turned out to be causing more harm than good.&lt;br/&gt;
I&amp;#39;ll just remove offending code.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380253" author="olegk" created="Fri, 2 May 2003 03:18:35 +0100"  >Offending code removed. That should fix the problem.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                </comments>
                    <attachments>
                    <attachment id="12326813" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_execute.java" size="2954" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:38:19 +0100" />
                    <attachment id="12326814" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_processAuthenticationResponse.java" size="3332" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:39:22 +0100" />
                    <attachment id="12326815" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_shouldCloseConnection.java" size="1796" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:41:08 +0100" />
                    <attachment id="12326816" name="ASF.LICENSE.NOT.GRANTED--keepAlive.patch" size="2524" author="becke@u.washington.edu" created="Wed, 23 Apr 2003 09:31:13 +0100" />
                    <attachment id="12326825" name="ASF.LICENSE.NOT.GRANTED--non-transp-proxy.patch" size="1344" author="olegk" created="Fri, 2 May 2003 01:24:30 +0100" />
                    <attachment id="12326812" name="ASF.LICENSE.NOT.GRANTED--ntlm13.wire" size="8706" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:33:25 +0100" />
                    <attachment id="12326823" name="ASF.LICENSE.NOT.GRANTED--ntlm2.http" size="88266" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 00:23:23 +0100" />
                    <attachment id="12326824" name="ASF.LICENSE.NOT.GRANTED--ntlm3.http" size="190573" author="bin.chen@sabre-holdings.com" created="Fri, 2 May 2003 00:24:28 +0100" />
                    <attachment id="12326811" name="ASF.LICENSE.NOT.GRANTED--ntlm6.wire" size="6216" author="bin.chen@sabre-holdings.com" created="Wed, 23 Apr 2003 03:32:46 +0100" />
                    <attachment id="12326822" name="ASF.LICENSE.NOT.GRANTED--proxy.patch" size="3350" author="olegk" created="Tue, 29 Apr 2003 03:30:45 +0100" />
                    <attachment id="12326821" name="ASF.LICENSE.NOT.GRANTED--proxy.patch" size="1477" author="olegk" created="Mon, 28 Apr 2003 20:27:18 +0100" />
                    <attachment id="12326820" name="ASF.LICENSE.NOT.GRANTED--proxy.patch" size="1216" author="olegk" created="Mon, 28 Apr 2003 06:18:38 +0100" />
                    <attachment id="12326818" name="ASF.LICENSE.NOT.GRANTED--test10.http" size="43146" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 05:57:40 +0100" />
                    <attachment id="12326819" name="ASF.LICENSE.NOT.GRANTED--test11.http" size="48427" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 06:11:45 +0100" />
                    <attachment id="12326817" name="ASF.LICENSE.NOT.GRANTED--test9.http" size="42846" author="bin.chen@sabre-holdings.com" created="Sat, 26 Apr 2003 04:23:04 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>15.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                <customfieldname>Bugzilla Id</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>19226</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 23 Apr 2003 04:08:13 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133249</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189249</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>