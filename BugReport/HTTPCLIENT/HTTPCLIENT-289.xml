<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:15:40 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-289/HTTPCLIENT-289.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-289] MultiThreadedHttpConnectionManager daemon Thread never GC&apos;d</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-289</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>One of my colleagues was invoking HttpClient by way of a loop something like this:&lt;br/&gt;
&lt;br/&gt;
for (int i = 0; i &amp;lt; 300; i++) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;GetMethod method = new&lt;br/&gt;
GetMethod(&amp;quot;&lt;a href=&quot;http://cvs.apache.org/viewcvs/jakarta-commons/httpclient/&quot;&gt;http://cvs.apache.org/viewcvs/jakarta-commons/httpclient/&lt;/a&gt;&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;HttpClient httpClient = new HttpClient(new&lt;br/&gt;
MultiThreadedHttpConnectionManager());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;httpClient.executeMethod(method);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;byte[] bytes = method.getResponseBody();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} finally {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// always release the connection after we&amp;#39;re done&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;method.releaseConnection();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
He&amp;#39;s in the process of revising his code so that he doesn&amp;#39;t do this loop, which&lt;br/&gt;
other developers might point out as a non-optimal use, but along the way, he&lt;br/&gt;
discovered that the daemon thread that the MultiThreadedHttpConnectionManager&lt;br/&gt;
makes does not get garbage collected.  Of course, the connection manager itself&lt;br/&gt;
is also never gc&amp;#39;d.  While I think we can avoid this problem in our code, in the&lt;br/&gt;
more general case, clients may not actually be able to control the number of&lt;br/&gt;
MultiThreadedConnectionManagers they create, which could eventually cause&lt;br/&gt;
problems.  This makes me think the problem is deserving of a patch.&lt;br/&gt;
&lt;br/&gt;
We found this problem with 2.0rc2, although presumably it also exists with the&lt;br/&gt;
CVS HEAD.&lt;br/&gt;
&lt;br/&gt;
Patch to follow.</description>
                <environment>Operating System: other&lt;br/&gt;
Platform: Other</environment>
            <key id="12333848">HTTPCLIENT-289</key>
            <summary>MultiThreadedHttpConnectionManager daemon Thread never GC&apos;d</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="eric@tibco.com">Eric Johnson</reporter>
                        <labels>
                    </labels>
                <created>Sat, 1 Nov 2003 07:26:24 +0000</created>
                <updated>Wed, 16 Feb 2011 20:44:59 +0000</updated>
                    <resolved>Sun, 22 Apr 2007 08:10:35 +0100</resolved>
                            <version>2.0 Milestone 2</version>
                                <fixVersion>2.0 Final</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12381092" author="eric@tibco.com" created="Sat, 1 Nov 2003 07:28:17 +0000"  >Created an attachment (id=8862)&lt;br/&gt;
test case and code change.&lt;br/&gt;
</comment>
                    <comment id="12381093" author="eric@tibco.com" created="Sat, 1 Nov 2003 07:34:05 +0000"  >I&amp;#39;m not entirely satisfied with my previous patch, as it _should_ be possible&lt;br/&gt;
for the ReferenceQueueThread to detect that it is no longer needed, and exit on&lt;br/&gt;
its own.  It strikes me that that approach would actually require two rounds of&lt;br/&gt;
gc to actually collect the thread - one to indicate to the ReferenceQueueThread&lt;br/&gt;
that the manager had been gc&amp;#39;d, and one to gc the thread itself.  Absent that&lt;br/&gt;
kind of logic, I&amp;#39;ve put an explicit &amp;quot;shutdown&amp;quot; call on the connection manager.&lt;br/&gt;
&lt;br/&gt;
You can see the bug in action if you comment out the line in&lt;br/&gt;
TestHttpConnectionManager.testDroppedThread() that reads: &amp;quot;mthcm.shutdown();&amp;quot;,&lt;br/&gt;
then run the test cases.&lt;br/&gt;
</comment>
                    <comment id="12381094" author="becke@u.washington.edu" created="Sun, 2 Nov 2003 07:00:00 +0000"  >Created an attachment (id=8870)&lt;br/&gt;
Patch 2&lt;br/&gt;
</comment>
                    <comment id="12381095" author="becke@u.washington.edu" created="Sun, 2 Nov 2003 07:02:34 +0000"  >Attached above is a different take on this problem.  Instead of worrying about manually killing the &lt;br/&gt;
reference thread, I just made it so there is only one thread.  Please try it out and let me know what &lt;br/&gt;
you think.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12381096" author="eric@tibco.com" created="Mon, 3 Nov 2003 07:34:50 +0000"  >Mike,&lt;br/&gt;
&lt;br/&gt;
Alas, due to craziness in my schedule, I&amp;#39;ll not have a chance to look at this&lt;br/&gt;
more closely until late Monday or Tuesday at the earliest.  One suggestion,&lt;br/&gt;
though, is that I&amp;#39;d like to see a test case.  The test case could wrap each of&lt;br/&gt;
the connection manager, and possibly the HostConfiguration with a WeakReference,&lt;br/&gt;
and then after forcing a gc, make sure that the references are null.  That the&lt;br/&gt;
MultiThreadedHttpConnectionManager was never garbage collected was our first&lt;br/&gt;
indication that something was awry....&lt;br/&gt;
&lt;br/&gt;
My patch that put a name on the ReferenceQueueThread.  I did that so that it is&lt;br/&gt;
easier to identify (and, for the most part, ignore) in a debugger.  I&amp;#39;m hoping&lt;br/&gt;
any change to fix this bug will include that.&lt;br/&gt;
&lt;br/&gt;
I like the idea of a single monitor thread!  Thanks for looking at this.</comment>
                    <comment id="12381097" author="becke@u.washington.edu" created="Tue, 4 Nov 2003 21:33:25 +0000"  >Created an attachment (id=8910)&lt;br/&gt;
Patch 3&lt;br/&gt;
</comment>
                    <comment id="12381098" author="becke@u.washington.edu" created="Tue, 4 Nov 2003 21:34:30 +0000"  >Hi Eric,&lt;br/&gt;
&lt;br/&gt;
Excellent suggestions.  This latest patch adds a thread name and a test.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12381099" author="eric@tibco.com" created="Wed, 5 Nov 2003 00:40:57 +0000"  >I inspected the code carefully, and didn&amp;#39;t see any issues, so I&amp;#39;m happy with the&lt;br/&gt;
second patch that Mike submitted.  Hopefully neither of us missed anything!&lt;br/&gt;
&lt;br/&gt;
On a slightly unrelated note, it occurs to me that the logic of&lt;br/&gt;
MultiThreadedHttpConnectionManager.removeReferenceToConnection() would be a lot&lt;br/&gt;
simpler if the HttpConnection could optionally provide a weak reference to&lt;br/&gt;
itself, so that the &amp;quot;remove&amp;quot; process was a simple get on the weakref to the&lt;br/&gt;
connection.  Mind you, if clients are using &amp;quot;releaseConnection&amp;quot; properly, the&lt;br/&gt;
performance difference would be miniscule, but might matter slightly more with&lt;br/&gt;
many instances of the connection manager.  Too many ideas, too little time....&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Whatever - I don&amp;#39;t know as the above change is useful, it was just a thought&lt;br/&gt;
that occurred to me.</comment>
                    <comment id="12381100" author="becke@u.washington.edu" created="Tue, 11 Nov 2003 11:18:06 +0000"  >Created an attachment (id=9047)&lt;br/&gt;
Patch 4&lt;br/&gt;
</comment>
                    <comment id="12381101" author="becke@u.washington.edu" created="Tue, 11 Nov 2003 11:19:56 +0000"  >Hi Eric,&lt;br/&gt;
&lt;br/&gt;
Yes, I agree that it could be a potential performance problem.  Here is another attempt at this one.  &lt;br/&gt;
Please let me know what you think.&lt;br/&gt;
&lt;br/&gt;
Thanks,&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12381102" author="eric@tibco.com" created="Tue, 11 Nov 2003 22:52:16 +0000"  >Cool.</comment>
                    <comment id="12381103" author="becke@u.washington.edu" created="Wed, 12 Nov 2003 08:27:07 +0000"  >Any more thoughts on this one, or should I apply?&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12381104" author="becke@u.washington.edu" created="Tue, 18 Nov 2003 09:42:17 +0000"  >If there are no more comments on this one I&amp;#39;ll apply it in the morning.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12381105" author="becke@u.washington.edu" created="Wed, 19 Nov 2003 08:43:35 +0000"  >Patch applied to 2.0 and HEAD.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                </comments>
                    <attachments>
                    <attachment id="12326986" name="ASF.LICENSE.NOT.GRANTED--gc-connection.patch" size="5608" author="eric@tibco.com" created="Sat, 1 Nov 2003 07:28:17 +0000" />
                    <attachment id="12326989" name="ASF.LICENSE.NOT.GRANTED--thread.patch" size="15754" author="becke@u.washington.edu" created="Tue, 11 Nov 2003 11:18:06 +0000" />
                    <attachment id="12326988" name="ASF.LICENSE.NOT.GRANTED--thread.patch" size="14134" author="becke@u.washington.edu" created="Tue, 4 Nov 2003 21:33:25 +0000" />
                    <attachment id="12326987" name="ASF.LICENSE.NOT.GRANTED--thread.patch" size="10324" author="becke@u.washington.edu" created="Sun, 2 Nov 2003 07:00:00 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                <customfieldname>Bugzilla Id</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24309</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 2 Nov 2003 07:00:00 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133340</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189033</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>