<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:12:48 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-1087/HTTPCLIENT-1087.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-1087] Proxy authentication error: Unexpected state: MSG_TYPE3_GENERATED when using NTLM authentication</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-1087</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>Trying to connect to a website that requires basic authentication through a proxy that requires NTLM authentication.&lt;br/&gt;
&lt;br/&gt;
Proxy authentication fails with &amp;quot;Proxy authentication error: Unexpected state: MSG_TYPE3_GENERATED&amp;quot;.&lt;br/&gt;
&lt;br/&gt;
Full wire log attached.  Code to replicate problem follows:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;private void execute() throws HttpException, IOException {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;	&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;	URL targetUrl = new URL(TARGET_URL);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;	&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;DefaultHttpClient httpclient = new DefaultHttpClient();&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;HttpHost targetHost = new HttpHost(targetUrl.getHost()); &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;HttpHost proxyHost = new HttpHost(PROXY_HOST, PROXY_PORT); &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;httpclient.getParams().setParameter(ConnRoutePNames.DEFAULT_PROXY, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;		proxyHost);&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;CredentialsProvider credProvider = httpclient.getCredentialsProvider();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Credentials proxyCredentials = new NTCredentials(PROXY_USER, &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;		PROXY_PASSWORD, PROXY_MACHINE, PROXY_DOMAIN);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;AuthScope proxyAuthScope = new AuthScope(proxyHost.getHostName(),&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;		proxyHost.getPort());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;credProvider.setCredentials(proxyAuthScope, proxyCredentials);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Credentials targetCredentials = new UsernamePasswordCredentials(&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;		TARGET_USER, TARGET_PASSWORD);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;AuthScope targetAuthScope = new AuthScope(targetHost.getHostName(),&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;		targetHost.getPort());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;credProvider.setCredentials(targetAuthScope, targetCredentials);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;HttpGet httpget = new HttpGet(targetUrl.getPath());&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;HttpResponse response = httpclient.execute(targetHost, httpget);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;response = &amp;quot; + response);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
</description>
                <environment>Client app running Java 6 on a Win 7 X64 box, proxy Squid 2.7 running on a Win7 machine.</environment>
            <key id="12507133">HTTPCLIENT-1087</key>
            <summary>Proxy authentication error: Unexpected state: MSG_TYPE3_GENERATED when using NTLM authentication</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="fallingrock">David Gibbs</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 May 2011 15:30:34 +0100</created>
                <updated>Sat, 23 Jul 2011 10:58:08 +0100</updated>
                    <resolved>Tue, 17 May 2011 14:08:06 +0100</resolved>
                            <version>4.1.1</version>
                                <fixVersion>4.1.2</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13033068" author="olegk" created="Fri, 13 May 2011 16:05:24 +0100"  >Could you please apply this patch to the latest snapshot of HttpClient off SVN trunk and re-test your application?&lt;br/&gt;
&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/repos/asf/httpcomponents/httpclient/trunk/&quot;&gt;http://svn.apache.org/repos/asf/httpcomponents/httpclient/trunk/&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
Oleg </comment>
                    <comment id="13033101" author="fallingrock" created="Fri, 13 May 2011 17:04:07 +0100"  >Wire log after patch.</comment>
                    <comment id="13033102" author="fallingrock" created="Fri, 13 May 2011 17:04:20 +0100"  >Grabbed the trunk source, applied the patch (manually), and re-tested.&lt;br/&gt;
&lt;br/&gt;
The modified code seemed to go into a loop.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ve attached a new wire log.</comment>
                    <comment id="13033248" author="olegk" created="Fri, 13 May 2011 20:53:07 +0100"  >David,&lt;br/&gt;
&lt;br/&gt;
Could you please try a slightly different take and let me know the result?&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="13033255" author="fallingrock" created="Fri, 13 May 2011 21:13:56 +0100"  >Oleg: This seems to work much better ... it appears to work fine in my test harness.  I&amp;#39;ll try it in my real application.</comment>
                    <comment id="13033334" author="fallingrock" created="Fri, 13 May 2011 23:01:22 +0100"  >Looks good ... even patched into 4.1.1.&lt;br/&gt;
&lt;br/&gt;
Any idea when 4.1.2 is going to be released?</comment>
                    <comment id="13033338" author="olegk" created="Fri, 13 May 2011 23:11:20 +0100"  >Sometime in June or July would be my guess.&lt;br/&gt;
&lt;br/&gt;
Oleg   </comment>
                    <comment id="13034743" author="olegk" created="Tue, 17 May 2011 14:08:06 +0100"  >David&lt;br/&gt;
&lt;br/&gt;
I ended up committing a slightly different patch to both trunk and 4.1.x. Could you please re-test your application with the latest SVN snapshot and confirm the fix still works?&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="13034753" author="fallingrock" created="Tue, 17 May 2011 14:23:20 +0100"  >Seems to work OK, thanks.</comment>
                </comments>
                    <attachments>
                    <attachment id="12479112" name="HTTPCLIENT-1087.patch" size="1208" author="olegk" created="Fri, 13 May 2011 16:05:24 +0100" />
                    <attachment id="12479161" name="HTTPCLIENT-1087-take2.patch" size="1043" author="olegk" created="Fri, 13 May 2011 20:53:07 +0100" />
                    <attachment id="12479134" name="wire-debug-1.log" size="78590" author="fallingrock" created="Fri, 13 May 2011 17:04:07 +0100" />
                    <attachment id="12479107" name="wire-debug.log" size="22924" author="fallingrock" created="Fri, 13 May 2011 15:31:28 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 13 May 2011 15:05:24 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>67134</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>46993</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>