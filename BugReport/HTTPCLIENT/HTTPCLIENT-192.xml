<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:14:34 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-192/HTTPCLIENT-192.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-192] Duplicate request headers when connect through proxies</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-192</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>When negotiating proxy servers or during write-failure retries, the httpClient &lt;br/&gt;
adds duplicate request headers to each retry.  The result is that each header &lt;br/&gt;
is duplicated multiple times (number of retries).  This only impact the headers &lt;br/&gt;
that allow multiple values (the others were prevented byt the code).  In  &lt;br/&gt;
Particular, it affects &amp;quot;cookie&amp;quot; header.  It happens more often when going &lt;br/&gt;
through proxy server with tunnelling connections (https), but also happens on &lt;br/&gt;
http on NTLM proxy server (need multiple round trips to get authenticated).&lt;br/&gt;
&lt;br/&gt;
Steps to Reproduce:&lt;br/&gt;
Setup a client application to go to a website that requires going through a &lt;br/&gt;
proxy server that supports tunnelling for https connections and authenticate &lt;br/&gt;
users (Basic and/or NTLM).  The website also need to support keep-alive and &lt;br/&gt;
support https. Initilize the HttpState with a cookie. Turn httpClient &lt;br/&gt;
logging &amp;quot;wire, debug and trace&amp;quot; logging on.  Set the proxy credential with &lt;br/&gt;
valid user id and password.&lt;br/&gt;
&lt;br/&gt;
Then run the application against any url on the website.&lt;br/&gt;
&lt;br/&gt;
Test Results and fixes:&lt;br/&gt;
1. When connect to https through a (Netscape/Basic auth) proxy that does &lt;br/&gt;
the &amp;quot;tunnelling&amp;quot;, the initial &amp;quot;CONNECT&amp;quot; adds the cookie header once.  The proxy &lt;br/&gt;
returns the 407.  Then the code will use the proxy credential to do &lt;br/&gt;
the &amp;quot;CONNECT&amp;quot; again.  After successful connection (200), the code will do the &lt;br/&gt;
proper &amp;quot;POST&amp;quot;.  The httpClient code adds the same cookie one more time in here.&lt;br/&gt;
&lt;br/&gt;
This case was caused by the wrapper class ConnectMethod using the wrapped &lt;br/&gt;
method &amp;quot;addRequestHeaders&amp;quot; to build headers for the &amp;quot;CONENCT&amp;quot;.  It can be fixed &lt;br/&gt;
by having the ConnectMethod only adds headers it needs (&amp;quot;addHostRequestHeader&amp;quot; &lt;br/&gt;
and &amp;quot;addProxyAuthorizationRequestHeader&amp;quot;).&lt;br/&gt;
&lt;br/&gt;
2. When connect to http through proxy.  The client first sends a &amp;quot;POST&amp;quot; without &lt;br/&gt;
proxy credentials, and gets a 407 back.  The cookie header is added before that &lt;br/&gt;
happens.  Then (loop in the HttpMethodBase.execute) the client will retry &lt;br/&gt;
the &amp;quot;POST&amp;quot; with the credentials (the logic require to have a response header to &lt;br/&gt;
submit credentials).  In the retry, the cookie is added again &lt;br/&gt;
(addRequestHeaders is called inside the writeRequest).&lt;br/&gt;
&lt;br/&gt;
3. When using kee-alive with no-proxy on http, if the connection times out, the &lt;br/&gt;
next call of the method will get a socket error on write.  The retry loop in &lt;br/&gt;
the processRequest method will retry the request again.  It will add the cookie &lt;br/&gt;
again.  To deal with both case 2 and 3, the addRequestHeadres call need to be &lt;br/&gt;
moved up to the beginning of the HttpMethodBase.execute.  We tested this &lt;br/&gt;
approach and it worked for us.&lt;br/&gt;
&lt;br/&gt;
4. When negotiating NTLM proxy for https, multiple round trips are needed to &lt;br/&gt;
get user authenticated.  The same ConnectMethod instance is used.  So the &lt;br/&gt;
adding of the proxy authenticate headers need to be done with the ConnectMethod &lt;br/&gt;
instance (vs. the wrapped method for Host header).  Otherwise, the &lt;br/&gt;
Authenticator class would not be able to find the information for &lt;br/&gt;
authenticating user.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
I will send in our suggested fixes later.&lt;br/&gt;
&lt;br/&gt;
Build: This is based on 0307 nightly build.  We run into some other problems &lt;br/&gt;
when trying the 0410 nightly build.</description>
                <environment>Operating System: other&lt;br/&gt;
Platform: PC</environment>
            <key id="12333751">HTTPCLIENT-192</key>
            <summary>Duplicate request headers when connect through proxies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="bin.chen@sabre-holdings.com">Bin Chen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Apr 2003 05:28:23 +0100</created>
                <updated>Wed, 16 Feb 2011 20:44:48 +0000</updated>
                    <resolved>Sun, 22 Apr 2007 08:10:19 +0100</resolved>
                            <version>2.0 Beta 2</version>
                                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12380180" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 05:52:02 +0100"  >Created an attachment (id=5931)&lt;br/&gt;
Fix in ConnectMethod&lt;br/&gt;
</comment>
                    <comment id="12380181" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 05:58:02 +0100"  >Correction:&lt;br/&gt;
&lt;br/&gt;
Our fix actually moved addRequestHeaders to the top of the loop of &lt;br/&gt;
processRequest method in HttpMethodBase.  The change in execute method is &lt;br/&gt;
related to a different problem.</comment>
                    <comment id="12380182" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 21:58:35 +0100"  >Created an attachment (id=5947)&lt;br/&gt;
addRequestHeaders in HttpMethodBase.processRequest&lt;br/&gt;
</comment>
                    <comment id="12380183" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:00:45 +0100"  >Created an attachment (id=5948)&lt;br/&gt;
Remove addRequestHeaders from HttpMethodBase.writeRequestHeaders&lt;br/&gt;
</comment>
                    <comment id="12380184" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:22:22 +0100"  >Proposed fix for duplicate cookies during NTLM proxy negotiation:&lt;br/&gt;
&lt;br/&gt;
Our fix is to use a state flag in HttpMethodBase: inProxyAuthenticationRetry.  &lt;br/&gt;
The flag will default to false at start of execute.  It is to be set to true &lt;br/&gt;
when retrying with credentials.  When the flag is true, only proxy &lt;br/&gt;
authentication headers are added in the addRequestheaders method. We also used &lt;br/&gt;
the same flag for another bug fix related to NTLM authentication (will be &lt;br/&gt;
reported later).</comment>
                    <comment id="12380185" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:27:34 +0100"  >Created an attachment (id=5949)&lt;br/&gt;
Check inProxyAuthenticationRetry in addRequestHeaders&lt;br/&gt;
</comment>
                    <comment id="12380186" author="olegk" created="Tue, 22 Apr 2003 22:29:23 +0100"  >I did not yet have time to carefully read through the description of the &lt;br/&gt;
problem. I&amp;#39;ll get back to as soon as I have done so. Meanwhile, could you &lt;br/&gt;
please produce the wire log of the HTTP communication that demonstrates the &lt;br/&gt;
problem? Another kind request is to submit patches in diff format&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380187" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:29:49 +0100"  >Created an attachment (id=5950)&lt;br/&gt;
Set inProxyAuthenticationRetry to true in HttpMethodBase.processAuthenticationResponse&lt;br/&gt;
</comment>
                    <comment id="12380188" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:32:27 +0100"  >Created an attachment (id=5951)&lt;br/&gt;
initialize inProxyAuthenticationRetry in HttpMethodBase.execute&lt;br/&gt;
</comment>
                    <comment id="12380189" author="olegk" created="Tue, 22 Apr 2003 23:37:18 +0100"  >Created an attachment (id=5955)&lt;br/&gt;
Patch (take 1)&lt;br/&gt;
</comment>
                    <comment id="12380190" author="olegk" created="Tue, 22 Apr 2003 23:43:33 +0100"  >The duplicate cookie bug has been fixed just a short while ago. Authentication &lt;br/&gt;
headers, however, were apparently overlooked. Many thanks for pointing it out. &lt;br/&gt;
The patch should address the problem&lt;br/&gt;
&lt;br/&gt;
Oleg&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12380191" author="olegk" created="Wed, 23 Apr 2003 01:29:52 +0100"  >Patch applied. Please re-test your application against the most recent CVS&lt;br/&gt;
snapshot. If the patch does not fix the problem for you, just reopen the case.&lt;br/&gt;
Wire log will be highly appreciated&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380192" author="bin.chen@sabre-holdings.com" created="Tue, 29 Apr 2003 00:36:50 +0100"  >New Problem:&lt;br/&gt;
&lt;br/&gt;
While the fix did solve the duplicate cookie problem, it created another one.  &lt;br/&gt;
It accidentally remvoed the cookie header application has added through &lt;br/&gt;
PostMethod.addRequestHeader call.  Our application need to add cookie in some &lt;br/&gt;
case and we have been using addRequestHeader to do it.  </comment>
                    <comment id="12380193" author="olegk" created="Tue, 29 Apr 2003 00:41:44 +0100"  >Just add your cookie to the HttpState instance associated with your HttpClient&lt;br/&gt;
instance. That&amp;#39;s it&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12380194" author="bin.chen@sabre-holdings.com" created="Tue, 29 Apr 2003 00:42:30 +0100"  >Created an attachment (id=6054)&lt;br/&gt;
Log file indicating that the cookie header added by app was not sent.&lt;br/&gt;
</comment>
                </comments>
                    <attachments>
                    <attachment id="12326808" name="ASF.LICENSE.NOT.GRANTED--applet2.http" size="58672" author="bin.chen@sabre-holdings.com" created="Tue, 29 Apr 2003 00:42:30 +0100" />
                    <attachment id="12326801" name="ASF.LICENSE.NOT.GRANTED--ConnectMethod_writeRequestHeaders.java" size="1630" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 05:52:02 +0100" />
                    <attachment id="12326807" name="ASF.LICENSE.NOT.GRANTED--headers.patch" size="2295" author="olegk" created="Tue, 22 Apr 2003 23:37:18 +0100" />
                    <attachment id="12326804" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_addRequestHeaders.java" size="776" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:27:34 +0100" />
                    <attachment id="12326806" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_execute.java" size="2954" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:32:27 +0100" />
                    <attachment id="12326805" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_processAuthenticationResponse.java" size="3332" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:29:49 +0100" />
                    <attachment id="12326802" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_processRequest.java" size="2380" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 21:58:35 +0100" />
                    <attachment id="12326803" name="ASF.LICENSE.NOT.GRANTED--HttpMethodBase_writeRequestHeaders.java" size="617" author="bin.chen@sabre-holdings.com" created="Tue, 22 Apr 2003 22:00:45 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>8.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                <customfieldname>Bugzilla Id</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>19201</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 22 Apr 2003 21:29:23 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133246</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>188772</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>