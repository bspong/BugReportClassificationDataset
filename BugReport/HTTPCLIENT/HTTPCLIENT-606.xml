<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:19:06 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-606/HTTPCLIENT-606.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-606] HttpMethodDirector fails when redirecting to a encoded URL location</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-606</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>When HttpMethodDirector handles the case of redirecting the incoming connection to the location specified in the header of the http caller method, if this location has any &amp;quot;special&amp;quot; charset encoding (extended charsets like ISO 8859-1,etc.) the redirection fails this way:&lt;br/&gt;
&lt;br/&gt;
dd-MMM-YYYY hh:mm:ss org.apache.commons.httpclient.HttpMethodDirector processRedirectResponse&lt;br/&gt;
WARNING: Redirected location &amp;#39;&lt;a href=&quot;http://www.anyCharsetEncodedUrl.ko&amp;#39;&quot;&gt;http://www.anyCharsetEncodedUrl.ko&amp;amp;#39;&lt;/a&gt; is malformed&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
You can test it using this class:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
public class SimpleHttpTestNotWorking {&lt;br/&gt;
&lt;br/&gt;
	public static int urlStatus(String pUrl) throws org.apache.commons.httpclient.HttpException,java.io.IOException{&lt;br/&gt;
		org.apache.commons.httpclient.HttpClient client = new org.apache.commons.httpclient.HttpClient();&lt;br/&gt;
		org.apache.commons.httpclient.HttpMethod method = new org.apache.commons.httpclient.methods.GetMethod(pUrl);&lt;br/&gt;
		return client.executeMethod(method);&lt;br/&gt;
	}&lt;br/&gt;
		&lt;br/&gt;
	public static void main(String[] args) {&lt;br/&gt;
		try{&lt;br/&gt;
			String url = &amp;quot;&lt;a href=&quot;http://www.dipualba.es/municipios/F%E9rez&quot;&gt;http://www.dipualba.es/municipios/F%E9rez&lt;/a&gt;&amp;quot;; //known problematic URL&lt;br/&gt;
			System.out.println(&amp;quot;Return code for [&amp;quot;+url+&amp;quot;]: &amp;quot;+SimpleHttpTestWorking.urlStatus(url));&lt;br/&gt;
		}catch(Exception e){&lt;br/&gt;
			e.printStackTrace();&lt;br/&gt;
		}&lt;br/&gt;
	}&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
What I&amp;#39;ve done to solve it for my particular case has been:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
1) In the requester side, I&amp;#39;ve modified the calling:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
public class SimpleHttpTestWorking {&lt;br/&gt;
&lt;br/&gt;
	public static int urlStatus(String pUrl) throws org.apache.commons.httpclient.HttpException,java.io.IOException{&lt;br/&gt;
		org.apache.commons.httpclient.HttpClient client = new org.apache.commons.httpclient.HttpClient();&lt;br/&gt;
		org.apache.commons.httpclient.HttpMethod method;&lt;br/&gt;
	    String encoding = (String)client.getParams().getParameter(&amp;quot;http.protocol.content-charset&amp;quot;);&lt;br/&gt;
	    client.getParams().setParameter(&amp;quot;http.protocol.element-charset&amp;quot;, encoding);&lt;br/&gt;
	    try{&lt;br/&gt;
	    	method = new org.apache.commons.httpclient.methods.GetMethod(pUrl);&lt;br/&gt;
	    }catch(IllegalArgumentException iae){&lt;br/&gt;
		    try{&lt;br/&gt;
		    	org.apache.commons.httpclient.URI uri = new org.apache.commons.httpclient.URI(pUrl,true);&lt;br/&gt;
		    	method = new org.apache.commons.httpclient.methods.GetMethod(uri.getURI());&lt;br/&gt;
		    }catch(org.apache.commons.httpclient.URIException ue){&lt;br/&gt;
		    	org.apache.commons.httpclient.URI uri = new org.apache.commons.httpclient.URI(pUrl,false,encoding);&lt;br/&gt;
			    method = new org.apache.commons.httpclient.methods.GetMethod(uri.getEscapedURI());&lt;br/&gt;
		    }		    	&lt;br/&gt;
	    }		&lt;br/&gt;
		return client.executeMethod(method);&lt;br/&gt;
	}&lt;br/&gt;
			&lt;br/&gt;
	public static void main(String[] args) {&lt;br/&gt;
		try{&lt;br/&gt;
			String url = &amp;quot;&lt;a href=&quot;http://www.dipualba.es/municipios/F&amp;#xE9;rez&quot;&gt;http://www.dipualba.es/municipios/F&amp;amp;#xE9;rez&lt;/a&gt;&amp;quot;; //the same problematic URL&lt;br/&gt;
			System.out.println(&amp;quot;Return code for [&amp;quot;+url+&amp;quot;]: &amp;quot;+SimpleHttpTestWorking.urlStatus(url));&lt;br/&gt;
		}catch(Exception e){&lt;br/&gt;
			e.printStackTrace();&lt;br/&gt;
		}&lt;br/&gt;
	}&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
2) In org.apache.commons.httpclient.HttpMethodDirector.processRedirectResponse(HttpMethod method) , I&amp;#39;ve replaced&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
redirectUri = new URI(location, true);&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
for the following code:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
/*&lt;br/&gt;
&amp;nbsp;* [2006-11-14] &lt;br/&gt;
&amp;nbsp;* Handles redirections to encoded URI locations &lt;br/&gt;
&amp;nbsp;* (only if URI and Connection encoding charset has been properly setted)&lt;br/&gt;
&amp;nbsp;* */ &lt;br/&gt;
try{&lt;br/&gt;
	redirectUri = new URI(location, true);&lt;br/&gt;
}catch(URIException ue){&lt;br/&gt;
	Object encoding = this.conn.getParams().getParameter(&amp;quot;http.protocol.element-charset&amp;quot;);&lt;br/&gt;
	if(encoding != null){&lt;br/&gt;
		redirectUri = new URI(location, false, (String)encoding);&lt;br/&gt;
	}else{&lt;br/&gt;
		throw ue;&lt;br/&gt;
	}&lt;br/&gt;
}&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Hope it helps!</description>
                <environment>Windows XP , JDK 1.5.0_09, Intel plattform</environment>
            <key id="12355734">HTTPCLIENT-606</key>
            <summary>HttpMethodDirector fails when redirecting to a encoded URL location</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="samu">samuel sanchez</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Nov 2006 15:20:02 +0000</created>
                <updated>Sun, 22 Apr 2007 08:11:22 +0100</updated>
                    <resolved>Fri, 8 Dec 2006 11:35:49 +0000</resolved>
                            <version>3.0.1</version>
                                <fixVersion>3.1 RC1</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>1</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12450061" author="samu" created="Wed, 15 Nov 2006 15:23:18 +0000"  >modified class HttpMethodDirector</comment>
                    <comment id="12450341" author="olegk" created="Thu, 16 Nov 2006 10:27:52 +0000"  >Samuel,&lt;br/&gt;
&lt;br/&gt;
Could you please create a patch in diff -u format against SVN trunk&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12450359" author="samu" created="Thu, 16 Nov 2006 11:46:57 +0000"  >Patch applied over /jakarta/commons/proper/httpclient/trunk/src/java/org/apache/commons/httpclient/HttpMethodDirector.java , revision Revision 413281.</comment>
                    <comment id="12451012" author="olegk" created="Sat, 18 Nov 2006 13:18:52 +0000"  >Samuel,&lt;br/&gt;
&lt;br/&gt;
Here is a slightly different take at fixing the problem. Please review and comment&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12451249" author="oglueck" created="Mon, 20 Nov 2006 08:12:57 +0000"  >Oleg, I think your version does the right thing. IMHO redirect URLs must be URL encoded in any case. So no point in first trying with the wrong one and on exception trying the right charset, as in Samuel&amp;#39;s patch.</comment>
                    <comment id="12451260" author="samu" created="Mon, 20 Nov 2006 08:56:39 +0000"  >Oleg,&lt;br/&gt;
&lt;br/&gt;
the patch that you suggest is not working for me, both for the escaped problematic URL that i&amp;#39;ve tried (&lt;a href=&quot;http://www.dipualba.es/municipios/F%E9rez&quot;&gt;http://www.dipualba.es/municipios/F%E9rez&lt;/a&gt;) and for it&amp;#39;s parsed version of the same URL using ISO-8859-1 charset encoding.&lt;br/&gt;
&lt;br/&gt;
Samuel.&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12451269" author="olegk" created="Mon, 20 Nov 2006 10:01:14 +0000"  >OK. I see the problem with the patch. The HTTP element charset defaults to US-ASCII, whereas the default URI charset should be UTF-8.&lt;br/&gt;
&lt;br/&gt;
I see no way around adding a new HTTP parameter specifically for the URI charset.&lt;br/&gt;
&lt;br/&gt;
New patch attached. Please review.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12451277" author="oglueck" created="Mon, 20 Nov 2006 10:48:40 +0000"  >Looks correct.</comment>
                    <comment id="12451962" author="samu" created="Wed, 22 Nov 2006 15:19:00 +0000"  >Hi Oleg,&lt;br/&gt;
&lt;br/&gt;
It&amp;#39;s still not working for me.&lt;br/&gt;
&lt;br/&gt;
The problem is in the class HttpMethodDirector, and is not when building the URI in a specific charset, but when reading the attribute &amp;#39;location&amp;#39; used to build that URI:&lt;br/&gt;
&lt;br/&gt;
Header locationHeader = method.getResponseHeader(&amp;quot;location&amp;quot;);&lt;br/&gt;
String location = locationHeader.getValue();&lt;br/&gt;
&lt;br/&gt;
The attribute &amp;#39;responseHeaders&amp;#39; of the method &amp;#39;method&amp;#39; contains the location where to redirect, but it looks like it has not been properly parsed.&lt;br/&gt;
&lt;br/&gt;
The first &amp;#39;try-catch&amp;#39; block in my original patch was for handling both escaped and non.escaped &amp;#39;location&amp;#39; values.</comment>
                    <comment id="12451978" author="oglueck" created="Wed, 22 Nov 2006 16:09:18 +0000"  >Samuel,&lt;br/&gt;
&lt;br/&gt;
This server is misbehaving. It returns non-ASCII characters in a HTTP header, which is a gross violation of the spec:&lt;br/&gt;
&lt;br/&gt;
2006/11/22 17:08:26:625 CET [DEBUG] header - -&amp;lt;&amp;lt; &amp;quot;Location: &lt;a href=&quot;http://www.dipualba.es/municipios/F?rez/&quot;&gt;http://www.dipualba.es/municipios/F?rez/&lt;/a&gt;[\r][\n]&amp;quot;&lt;br/&gt;
&lt;br/&gt;
The server must URL-encode the URL (in UTF-8) correctly. There is nothing we can do.</comment>
                    <comment id="12452565" author="ori_regev" created="Sat, 25 Nov 2006 08:57:31 +0000"  >Hi,&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m encountering the same problem (version 3.0.1) when trying to load the following URL with HTTPClient:&lt;br/&gt;
&lt;br/&gt;
&lt;a href=&quot;http://www.comedycentral.com/sitewide/droplets/podRedirect.jhtml/redirect.m4v?feed=ComedyCentralStandUpPodcastForResearch&amp;file=http://a1926.g.akamai.net/downloadstor.download.akamai.com/10768/comedy/podcasts/standup/133_standup.m4v&quot;&gt;http://www.comedycentral.com/sitewide/droplets/podRedirect.jhtml/redirect.m4v?feed=ComedyCentralStandUpPodcastForResearch&amp;amp;file=http://a1926.g.akamai.net/downloadstor.download.akamai.com/10768/comedy/podcasts/standup/133_standup.m4v&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
(This is an enclosure URL from the RSS feed at: &lt;a href=&quot;http://feeds.feedburner.com/comedycentral/standup,&quot;&gt;http://feeds.feedburner.com/comedycentral/standup,&lt;/a&gt; I&amp;#39;ve noticed that other feeds from FeedBurner misbehave in the same way. Please note that Firefox and IE manage to redirect despite this encoding problem)&lt;br/&gt;
&lt;br/&gt;
thanks,&lt;br/&gt;
Ori</comment>
                    <comment id="12455555" author="olegk" created="Tue, 5 Dec 2006 09:19:48 +0000"  >If I hear no complaints I&amp;#39;ll check in the fix (httpmethoddir.patch).&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12456784" author="olegk" created="Fri, 8 Dec 2006 11:35:49 +0000"  >Patch checked in&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                </comments>
                    <attachments>
                    <attachment id="12345340" name="httpmethoddir.patch" size="4572" author="olegk" created="Mon, 20 Nov 2006 10:01:14 +0000" />
                    <attachment id="12345117" name="patch.txt" size="1077" author="samu" created="Thu, 16 Nov 2006 11:46:57 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 16 Nov 2006 10:27:52 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133646</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>47902</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>