<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:14:23 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-178/HTTPCLIENT-178.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-178] MultiThreadedHttpConnectionManager never reclaims unused connectons</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-178</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>There is no limit on the number of connections that will get created by the&lt;br/&gt;
MultiThreadedHttpConnectionManager.  Unused connections are never destroyed.</description>
                <environment>Operating System: other&lt;br/&gt;
Platform: Other</environment>
            <key id="12333737">HTTPCLIENT-178</key>
            <summary>MultiThreadedHttpConnectionManager never reclaims unused connectons</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="becke@u.washington.edu">Michael Becke</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Apr 2003 13:29:50 +0100</created>
                <updated>Wed, 16 Feb 2011 20:44:44 +0000</updated>
                    <resolved>Sun, 22 Apr 2007 08:10:18 +0100</resolved>
                            <version>2.0 Alpha 3</version>
                                <fixVersion>2.0 Beta 1</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12380079" author="becke@u.washington.edu" created="Wed, 2 Apr 2003 13:31:23 +0100"  >Created an attachment (id=5595)&lt;br/&gt;
Fix take 1&lt;br/&gt;
</comment>
                    <comment id="12380080" author="becke@u.washington.edu" created="Wed, 2 Apr 2003 13:47:22 +0100"  >Attached is another take on adding support for a maximum number of connections&lt;br/&gt;
to the MultiThreadedHttpConnectionManager.  This code is based upon the patch&lt;br/&gt;
submitted by Carl Dunham.  Here are some key points:&lt;br/&gt;
&lt;br/&gt;
- the connection timeout is no longer implemented using a separate thread. &lt;br/&gt;
instead, threads use Object.wait() and keep track of the amount of wait time.&lt;br/&gt;
- unused connections are reclaimed in a LRU-like manner&lt;br/&gt;
- an attempt is made to give connections to threads that can reuse them&lt;br/&gt;
directly.  for example, if two threads are waiting for a connection, the&lt;br/&gt;
connection will be given first to the thread using the same host as the connection.&lt;br/&gt;
- all connection access is still locked by a single monitor.  I had hoped to&lt;br/&gt;
make things a little more modular but after quite a bit of experimenting I&lt;br/&gt;
discovered this was much harder that I had anticipated.&lt;br/&gt;
&lt;br/&gt;
To anyone who is interested in this functionality, please take a good look at&lt;br/&gt;
this patch.  I suspect there are a few things that I am missing.  Any real-world&lt;br/&gt;
testing would be great.&lt;br/&gt;
&lt;br/&gt;
Thanks,&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380081" author="httpc@carldunham.com" created="Wed, 9 Apr 2003 01:46:00 +0100"  >Created an attachment (id=5710)&lt;br/&gt;
Sample program and data&lt;br/&gt;
</comment>
                    <comment id="12380082" author="httpc@carldunham.com" created="Wed, 9 Apr 2003 01:46:33 +0100"  >This definitely works much better, however now it seems that treads go off to nana land and &lt;br/&gt;
stop taking work. The connections that they were working eventually go away, so the system &lt;br/&gt;
does not get overwhelmed like it use to, but it doesn&amp;#39;t do the work it is supposed to either. &lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
I am still trying to track down exactly what is going on here, as it is inconsistent. Sometimes &lt;br/&gt;
one or two threads will keep trucking along, sometimes they will all freeze up fairly soon. &lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
I have attached a test program that I posted to the list awhile ago, but should probably be &lt;br/&gt;
here. It may be that there is just some sloppy coding on my part, or I&amp;#39;m missing some &lt;br/&gt;
important point about detecting server-dropped connections or something.... </comment>
                    <comment id="12380083" author="becke@u.washington.edu" created="Wed, 9 Apr 2003 11:01:09 +0100"  >Created an attachment (id=5718)&lt;br/&gt;
Modified SimpleDownloader&lt;br/&gt;
</comment>
                    <comment id="12380084" author="becke@u.washington.edu" created="Wed, 9 Apr 2003 11:21:00 +0100"  >Hi Carl,&lt;br/&gt;
&lt;br/&gt;
I have attached a modified version of SimpleDownloader.  In this version I have&lt;br/&gt;
changed the following:&lt;br/&gt;
&lt;br/&gt;
- GetMethod creation has been changed so that it is not immediately recycled&lt;br/&gt;
after creation&lt;br/&gt;
- all of the hosts are now just accessed once&lt;br/&gt;
- the threads now each print to their own log file&lt;br/&gt;
- the HttpClient read timeout is now being set to 5000ms using&lt;br/&gt;
HttpClient.setTimeout()&lt;br/&gt;
&lt;br/&gt;
These changes seem to have fixed quite a few problems.  I was able to run&lt;br/&gt;
through all of the &amp;quot;non_working_urls&amp;quot; successfully.  The &amp;quot;nana threads&amp;quot; were&lt;br/&gt;
being caused by some servers that never respond to requests and also do not&lt;br/&gt;
close connections.  This was &amp;quot;fixed&amp;quot; by setting the read timeout.  &lt;br/&gt;
&lt;br/&gt;
There are still a few things to look at.  First, there are a number of &amp;quot;host&lt;br/&gt;
connection pool not found for: ... &amp;quot; errors.  Also the hosts that cause the read&lt;br/&gt;
timeouts are valid hosts but for some reason they do not respond to HttpClient.&lt;br/&gt;
&lt;br/&gt;
Thoughts?&lt;br/&gt;
&lt;br/&gt;
Mike </comment>
                    <comment id="12380085" author="httpc@carldunham.com" created="Wed, 9 Apr 2003 14:16:23 +0100"  >Hi, Mike. &lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
Well, the problem is that deleteLeastUsedConnection() is closing the connection and &lt;br/&gt;
decrementing the counters, doing what it should be doing, except now this connection is &lt;br/&gt;
unreferenced, and subject to garbage collection. When the GC kicks in, the referenceQueue is &lt;br/&gt;
run, and the counters decremented again. Somehow we have to make sure it that it only &lt;br/&gt;
happens once. It pretty much has to happen in deleteLeastUsedConnection() so that &lt;br/&gt;
createConnection call can proceed, so that means clearing the reference. Unfortunately, we &lt;br/&gt;
can only get the reference from the queue, and trying to save it somewhere else could get &lt;br/&gt;
painful. Perhaps you have an idea of how to untie this little knot... &lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
Also, I think this *might* explain why I still see hundreds of connection in netstat, if for some &lt;br/&gt;
reason the real socket isn&amp;#39;t going away until the Java socket is GCd. Dunno. Brain hurts right &lt;br/&gt;
now.... &lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
Carl </comment>
                    <comment id="12380086" author="becke@u.washington.edu" created="Wed, 9 Apr 2003 20:54:58 +0100"  >Carl,&lt;br/&gt;
&lt;br/&gt;
Good catch.  You are quite right.  I remember thinking about that when working&lt;br/&gt;
on this originally, but I completely forgot about it.  I will try to fix this&lt;br/&gt;
tonight.  Since WeakReference does not override hashCode() and equals() the only&lt;br/&gt;
way to fix this is to iterate over the reference Map.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m not sure if there are actually as many connections open as suggested by&lt;br/&gt;
netstat.  With the current setup only 20 connections are ever open at once.  I&lt;br/&gt;
think what may be happening is that SimpleDownloader opens so many connections&lt;br/&gt;
so quickly that it opens(closes) connection faster than netstat can report them.&lt;br/&gt;
&amp;nbsp;So netstat is showing all of the connections that are opened, but it doesn&amp;#39;t&lt;br/&gt;
necessarily mean that they are still open.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380087" author="becke@u.washington.edu" created="Thu, 10 Apr 2003 10:44:27 +0100"  >Created an attachment (id=5757)&lt;br/&gt;
fix take 2&lt;br/&gt;
</comment>
                    <comment id="12380088" author="becke@u.washington.edu" created="Thu, 10 Apr 2003 10:45:41 +0100"  >This patch should take care of the GC problem.  Please give it a try when you&lt;br/&gt;
have a chance.&lt;br/&gt;
&lt;br/&gt;
Thanks,&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380089" author="httpc@carldunham.com" created="Fri, 11 Apr 2003 01:29:35 +0100"  >Mike, &lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
It&amp;#39;s working like a champ now. Thanks! &lt;br/&gt;
&amp;nbsp;</comment>
                    <comment id="12380090" author="becke@u.washington.edu" created="Sun, 13 Apr 2003 01:59:21 +0100"  >Are there any more comments from others?  Oleg, Jeff?  I will commit this one&lt;br/&gt;
tonight if I do not hear any complaints.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                    <comment id="12380091" author="becke@u.washington.edu" created="Sun, 13 Apr 2003 11:55:52 +0100"  >The patch has been applied.  Many thanks to Carl for submitting the original&lt;br/&gt;
patch and for the thorough testing.&lt;br/&gt;
&lt;br/&gt;
Mike</comment>
                </comments>
                    <attachments>
                    <attachment id="12326779" name="ASF.LICENSE.NOT.GRANTED--connectionManager.patch" size="36557" author="becke@u.washington.edu" created="Thu, 10 Apr 2003 10:44:27 +0100" />
                    <attachment id="12326776" name="ASF.LICENSE.NOT.GRANTED--connectionManager.patch" size="33784" author="becke@u.washington.edu" created="Wed, 2 Apr 2003 13:31:23 +0100" />
                    <attachment id="12326777" name="ASF.LICENSE.NOT.GRANTED--sample-code-data.tgz" size="20164" author="httpc@carldunham.com" created="Wed, 9 Apr 2003 01:46:00 +0100" />
                    <attachment id="12326778" name="ASF.LICENSE.NOT.GRANTED--SimpleDownloader.java" size="11942" author="becke@u.washington.edu" created="Wed, 9 Apr 2003 11:01:09 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                <customfieldname>Bugzilla Id</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>18596</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 9 Apr 2003 00:46:00 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133232</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189287</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>