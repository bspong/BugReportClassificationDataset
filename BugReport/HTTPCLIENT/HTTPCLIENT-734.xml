<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:20:28 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-734/HTTPCLIENT-734.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-734] request.abort() should interrupt thread waiting for a connection</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-734</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>Calls to HttpRequestBase.abort() will not unblock a thread that is still waiting for a connection and therefore has no ConnectionReleaseTrigger yet.&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12387218">HTTPCLIENT-734</key>
            <summary>request.abort() should interrupt thread waiting for a connection</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="rolandw">Roland Weber</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 Jan 2008 08:23:00 +0000</created>
                <updated>Tue, 25 Jan 2011 10:58:47 +0000</updated>
                    <resolved>Wed, 19 Mar 2008 19:38:35 +0000</resolved>
                            <version>4.0 Alpha 2</version>
                                <fixVersion>4.0 Beta 1</fixVersion>
                                <component>HttpClient</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12562846" author="olegk" created="Sat, 26 Jan 2008 11:30:08 +0000"  >My bad. I guess this patch should address the problem.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12562904" author="rolandw" created="Sat, 26 Jan 2008 18:52:07 +0000"  >Hi Oleg,&lt;br/&gt;
&lt;br/&gt;
that takes care of opening the connection. But it does not address the interval that a thread spends in allocateConnection(). If we want to address that, we&amp;#39;ll have to store a thread in the AbortableHttpRequest and interrupt the thread if there is no ConnectionReleaseTrigger. I&amp;#39;m not sure whether that is what we want, but it seems to be a sensible behavior from a user perspective.&lt;br/&gt;
&lt;br/&gt;
Please go ahead and commit the patch, it already improves the behavior.&lt;br/&gt;
&lt;br/&gt;
cheers,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Roland&lt;br/&gt;
</comment>
                    <comment id="12562970" author="rolandw" created="Sun, 27 Jan 2008 08:46:37 +0000"  >This is getting nastier the more I think about it. If abort() is called while waiting for a connection, the thread should be unblocked and an InterruptedException is thrown. If abort is called after the ConnectionReleaseTrigger (CRT) becomes available, the connection is released and the next IO operation will throw an IOException. So far, so good.&lt;br/&gt;
If abort() is called just after the connection is obtained and before the CRT has been set, things get tricky. The thread will be interrupted, but since it is not blocked it will not get an InterruptedException. We have to check and reset the interrupt status, release the connection and throw an InterruptedException. The latter two may happen in reverse order, if the connection is released in a finally{} block.&lt;br/&gt;
We&amp;#39;ll need some synchonization and maybe a volatile declaration in HttpRequestBase, plus code for checking the interrupt status in ClientRequestDirector (CRD).&lt;br/&gt;
&lt;br/&gt;
The alternative would be that applications have to do both, call abort() and interrupt the thread to make sure it isn&amp;#39;t waiting for a connection. Ensuring proper connection release in the application would become really challenging if we require that.&lt;br/&gt;
&lt;br/&gt;
cheers,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Roland&lt;br/&gt;
</comment>
                    <comment id="12579516" author="sberlin" created="Mon, 17 Mar 2008 17:13:12 +0000"  >Attached is a patch + testcase (that previously failed, but now passes) for this.  Basically the idea is that DefaultClientRequestDirector installs its own ConnectionReleaseTrigger and then sets further triggers through that.  Its trigger will interrupt the thread if no trigger has been set by the time abort is called, and if a delegate trigger is set after abort was called, it immediately throws an IOX &amp;amp; clears the interrupted status.</comment>
                    <comment id="12579632" author="olegk" created="Mon, 17 Mar 2008 22:02:11 +0000"  >Sam,&lt;br/&gt;
&lt;br/&gt;
This is a tricky one. &lt;br/&gt;
&lt;br/&gt;
I kind of dislike the idea of having to interrupt the thread in order to unblock the connection manager. Besides, not all connection manager implementation would necessarily block on connection allocation.  So, I am thinking if a better solution could be to return an optional handle object, which could be used to unblock the connection manager without interrupting the thread. &lt;br/&gt;
&lt;br/&gt;
Does this make any sense to you? If not, i&amp;#39;ll commit your patch as is&lt;br/&gt;
&lt;br/&gt;
Oleg   </comment>
                    <comment id="12579637" author="sberlin" created="Mon, 17 Mar 2008 22:07:16 +0000"  >That makes sense -- I agree that interrupting is a bad practice.  I&amp;#39;ll take another stab at it tomorrow... (or feel free to do it in the meantime).</comment>
                    <comment id="12579958" author="sberlin" created="Tue, 18 Mar 2008 17:57:03 +0000"  >This patch takes a different approach than the prior one.  Instead of requiring the user of the ClientConnectionManager to assume that it blocks, an AbortableHttpRequest is now passed into getConnection.  The ClientConnectionManager must set a ConnectionReleaseTrigger on the request to support aborting it.&lt;br/&gt;
&lt;br/&gt;
The patch is a little more intrusive than the prior one (in that it touches more classes and changes some method signatures), but it could be worth it.&lt;br/&gt;
&lt;br/&gt;
There&amp;#39;s some more tests in TestTSCCMNoServer to make sure that ThreadSafeClientConnectionManager is doing the right thing.&lt;br/&gt;
&lt;br/&gt;
(Included in this patch is the small changes &amp;amp; tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-759&quot; title=&quot;DefaultClientRequestDirector doesn&amp;#39;t release connections back to ClientConnectionManager on exceptions&quot;&gt;&lt;strike&gt;HTTPCLIENT-759&lt;/strike&gt;&lt;/a&gt;, because it&amp;#39;s hard to separate the environments.)</comment>
                    <comment id="12580042" author="olegk" created="Tue, 18 Mar 2008 19:56:54 +0000"  >Sam,&lt;br/&gt;
I&amp;#39;ll review the patch in the coming days&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12580084" author="sberlin" created="Tue, 18 Mar 2008 21:09:14 +0000"  >Here&amp;#39;s the exact same patch, just diffed against the most recent head (to avoid the conflicts from &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-759&quot; title=&quot;DefaultClientRequestDirector doesn&amp;#39;t release connections back to ClientConnectionManager on exceptions&quot;&gt;&lt;strike&gt;HTTPCLIENT-759&lt;/strike&gt;&lt;/a&gt;&amp;#39;s patch adding the same test file).</comment>
                    <comment id="12580299" author="olegk" created="Wed, 19 Mar 2008 10:19:31 +0000"  >Hi Sam&lt;br/&gt;
&lt;br/&gt;
This looks much better. However, I do not quite like the fact that the proposed changes introduce a dependency between client protocol layer and the connection management layer&lt;br/&gt;
&lt;br/&gt;
I personally think it would be cleaner to give he control over the connection allocation back t to the client request director. Instead of connection manager injecting some code into the AbortableHttpRequest, how about the connection manager returning a handle object representing a pending request for a connection and letting the request director handle it? The request director in its turn could inject the handle object into the AbortableHttpRequest&lt;br/&gt;
&lt;br/&gt;
public interface ClientConnectionManager {&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ClientConnectionRequest requestConnection(HttpRoute route,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;long timeout,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;TimeUnit tunit)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throws ConnectionPoolTimeoutException, InterruptedException;&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
public interface ClientConnectionRequest {&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ManagedClientConnection getConnection() &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;		throws InterruptedException;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;void abort();&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;boolean isCompleted();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;boolean isTimedOut();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;boolean isAborted();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
Does this make any sense to you?&lt;br/&gt;
&lt;br/&gt;
Anyways, let tackle problem in small incremental steps. First thing that we need, no matter what approach, we take is ability to abort WaitingThread. Then, we can think of a way to propagate access to that method to the AbortableHttpRequest.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12580449" author="sberlin" created="Wed, 19 Mar 2008 17:02:10 +0000"  >Ya, it makes sense.  I took a swipe at using the ClientConnectionRequest approach, and this is the result.  IMO it&amp;#39;s much cleaner than the prior one (which used AbortableHttpRequest) -- less method signatures changed and the code is simpler to understand.  It still is more complex than the very first approach, just due to the nature of having to touch more classes...  but it works very well.&lt;br/&gt;
&lt;br/&gt;
Sorry also for throwing all these patches out so fast -- we&amp;#39;re finalizing remaining bugs with LimeWire, and since we&amp;#39;re using httpclient-4.0 now, we need to make sure it&amp;#39;s doing what we expect.  (Don&amp;#39;t worry, there&amp;#39;s lots of other things to work on too, just not as time-critical.)</comment>
                    <comment id="12580512" author="olegk" created="Wed, 19 Mar 2008 19:38:35 +0000"  >Patch checked in pretty much as is (barring the tabs, which I had to replace with spaces). Many thanks, Sam. I still would like to do some minor API refinements but otherwise look good. Great job! &lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12580518" author="sberlin" created="Wed, 19 Mar 2008 19:53:18 +0000"  >Thanks for checking it in &amp;amp; fixing the tabs.  Any chance you could post a new snapshot to people.apache.org?  ... Makes maven dependencies much much easier. :)</comment>
                    <comment id="12580539" author="olegk" created="Wed, 19 Mar 2008 20:23:26 +0000"  >Done.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12387063">HTTPCLIENT-731</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12378253" name="changes.txt" size="40823" author="sberlin" created="Wed, 19 Mar 2008 17:02:10 +0000" />
                    <attachment id="12378173" name="changes.txt" size="48033" author="sberlin" created="Tue, 18 Mar 2008 21:09:14 +0000" />
                    <attachment id="12378144" name="changes.txt" size="51927" author="sberlin" created="Tue, 18 Mar 2008 17:57:03 +0000" />
                    <attachment id="12378045" name="changes.txt" size="11274" author="sberlin" created="Mon, 17 Mar 2008 17:13:12 +0000" />
                    <attachment id="12374119" name="connabort.patch" size="1447" author="olegk" created="Sat, 26 Jan 2008 11:30:07 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 26 Jan 2008 11:30:08 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133772</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>47447</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>