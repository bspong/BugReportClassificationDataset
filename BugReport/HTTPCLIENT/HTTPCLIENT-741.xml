<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Mon Jul 08 06:20:35 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/HTTPCLIENT-741/HTTPCLIENT-741.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[HTTPCLIENT-741] AbstractClientConnAdapter prone to concurrency issues</title>
                <link>https://issues.apache.org/jira/browse/HTTPCLIENT-741</link>
                <project id="12310360" key="HTTPCLIENT">HttpComponents HttpClient</project>
                        <description>AbstractClientConnAdapter is currently prone to all sorts of concurrency issues. (1) Access to internal state is not properry synchronized making the class prone  to race conditions. Presently none of the instance variables is even declared volatile. (2) AbstractClientConnAdapter treats aborted connection as one in an illegal state, which is not quite right.&lt;br/&gt;
&lt;br/&gt;
Oleg</description>
                <environment></environment>
            <key id="12387709">HTTPCLIENT-741</key>
            <summary>AbstractClientConnAdapter prone to concurrency issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="olegk">Oleg Kalnichevski</reporter>
                        <labels>
                    </labels>
                <created>Sat, 2 Feb 2008 15:38:59 +0000</created>
                <updated>Tue, 25 Jan 2011 10:58:49 +0000</updated>
                    <resolved>Fri, 8 Feb 2008 16:45:31 +0000</resolved>
                            <version>4.0 Alpha 2</version>
                                <fixVersion>4.0 Alpha 3</fixVersion>
                                <component>HttpConn</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12565078" author="olegk" created="Sat, 2 Feb 2008 15:45:01 +0000"  >Another major problem is that AbstractClientConnAdapter attempts to release the connection upon invocation of the abort method, which essentially requires the connection manager (or at least its releaseConnection method) to be threading safe. We should not make such assumption. &lt;br/&gt;
&lt;br/&gt;
Roland&lt;br/&gt;
&lt;br/&gt;
I am going to go ahead and commit fixes for the above problems, given the fact you may be off-line in the coming days / weeks. Please review the changes when you happen to have a chance. If you find anything disagreeable, please let me know.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12565084" author="sberlin" created="Sat, 2 Feb 2008 16:58:33 +0000"  >We have a whole slew of stack traces that might be caused by the concurrency issues.  Would it be helpful to post them, or wait till some of them are fixed and try again?</comment>
                    <comment id="12565092" author="olegk" created="Sat, 2 Feb 2008 17:42:57 +0000"  >AbstractClientConnAdapter#abortConnection() no longer releases the wrapped connection back to the connection manager. The wrapped connection gets shut down, but remains attached to the adapter. The connection is expected to be released back to the connection manager by the request execution thread. &lt;br/&gt;
&lt;br/&gt;
Roland,&lt;br/&gt;
&lt;br/&gt;
Please review and approve the changes when you happen to have a chance.&lt;br/&gt;
&lt;br/&gt;
Sam,&lt;br/&gt;
&lt;br/&gt;
I believe the issue has been resolved. Could you please re-test your code against the latest SVN snapshot and confirm the problem is gone? If the problem still persists, please do post stack traces, the more the better.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12565154" author="rolandw" created="Sun, 3 Feb 2008 08:32:52 +0000"  >My mistake. When I created the adapter, I considered it a single-threading class because it is handed only to the thread that allocates the connection. Should have thought about multithreading when writing the abort stuff. I&amp;#39;ll look at the code when I find the time. On the conceptual level, the changes are good.&lt;br/&gt;
&lt;br/&gt;
cheers,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Roland&lt;br/&gt;
</comment>
                    <comment id="12566740" author="rolandw" created="Thu, 7 Feb 2008 18:51:12 +0000"  >I&amp;#39;m fine with the changes.&lt;br/&gt;
&lt;br/&gt;
Sam, if you get around to retesting with trunk and your problems are gone, please mark this issue as resolved or close it.&lt;br/&gt;
&lt;br/&gt;
thanks,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;Roland&lt;br/&gt;
</comment>
                    <comment id="12566843" author="sberlin" created="Thu, 7 Feb 2008 23:22:33 +0000"  >Sure thing -- we&amp;#39;ve updated our code to be using trunk internally &amp;amp; will likely release another beta sometime next week.  I&amp;#39;ll be sure to update this issue with the results.  Thanks!</comment>
                    <comment id="12567088" author="olegk" created="Fri, 8 Feb 2008 16:45:31 +0000"  >Closing as fixed for now. Sam, please re-open it if you manage to reproduce the problem in LimeWire.&lt;br/&gt;
&lt;br/&gt;
Oleg&lt;br/&gt;
&amp;nbsp;</comment>
                    <comment id="12568418" author="sberlin" created="Wed, 13 Feb 2008 03:22:05 +0000"  >I don&amp;#39;t seem to have the ability to re-open, so am just commenting with the updates.  We released a new beta today, and 99% of the concurrency problems seem to be fixed.  Here&amp;#39;s three stack traces that are left:&lt;br/&gt;
&lt;br/&gt;
--&lt;br/&gt;
java.lang.IllegalStateException: Connection is not open&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.SocketHttpClientConnection.assertOpen(SocketHttpClientConnection.java:75)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.AbstractHttpClientConnection.isStale(AbstractHttpClientConnection.java:197)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.conn.AbstractClientConnAdapter.isStale(AbstractClientConnAdapter.java:172)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.DefaultClientRequestDirector.execute(DefaultClientRequestDirector.java:318)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:500)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:455)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:421)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.performRequest(DefaultHttpExecutor.java:97)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.access$000(DefaultHttpExecutor.java:26)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor$MultiRequestor.run(DefaultHttpExecutor.java:139)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1006)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:549)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
---&lt;br/&gt;
&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.DefaultClientRequestDirector.updateAuthState(DefaultClientRequestDirector.java:996)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.DefaultClientRequestDirector.handleResponse(DefaultClientRequestDirector.java:885)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.DefaultClientRequestDirector.execute(DefaultClientRequestDirector.java:386)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:500)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:455)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:421)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.performRequest(DefaultHttpExecutor.java:97)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.access$000(DefaultHttpExecutor.java:26)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor$MultiRequestor.run(DefaultHttpExecutor.java:139)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1006)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:549)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
---&lt;br/&gt;
&lt;br/&gt;
java.lang.IllegalStateException: No entry created for this pool. HttpRoute[{}-&amp;gt;&lt;a href=&quot;http://74.160.66.42:14561&quot;&gt;http://74.160.66.42:14561&lt;/a&gt;]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.conn.tsccm.RouteSpecificPool.freeEntry(RouteSpecificPool.java:137)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.conn.tsccm.ConnPoolByRoute.freeEntry(ConnPoolByRoute.java:337)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.conn.tsccm.ThreadSafeClientConnManager.releaseConnection(ThreadSafeClientConnManager.java:230)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.DefaultClientRequestDirector.execute(DefaultClientRequestDirector.java:427)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:500)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:455)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:421)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.performRequest(DefaultHttpExecutor.java:97)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.access$000(DefaultHttpExecutor.java:26)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor$MultiRequestor.run(DefaultHttpExecutor.java:139)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1006)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:549)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.lang.Thread.run(Thread.java:613)&lt;br/&gt;
---&lt;br/&gt;
&lt;br/&gt;
DefaultHttpExecutor$MultiRequestor basically is just a Runnable / Cancellable [exposes a cancel() method] that can be cancelled from any thread.  cancel just calls abort() on the current AbortableHttpRequest, but is called on a thread other than the one that&amp;#39;s doing the client.execute(request).&lt;br/&gt;
&lt;br/&gt;
The last one is the most common exception, and seems to happen with some regularity.  The other two we&amp;#39;ve only seen once, so may just be a memory quirk (we&amp;#39;ve seen some crazy bugs, including recursive NPEs while constructing an NPE.)</comment>
                    <comment id="12568590" author="olegk" created="Wed, 13 Feb 2008 15:41:28 +0000"  >I think I have fixed the first and the second cases in the SVN trunk.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12584243" author="tjulien" created="Tue, 1 Apr 2008 19:37:23 +0100"  >(working with Sam)&lt;br/&gt;
Yes, we no longer see the first two, I think. Still seeing the third, as well as one I&amp;#39;ve inserted below. I&amp;#39;ve done some digging and I have a patch I&amp;#39;ll attach. Basically, in the recent concurrency fixes a change was made to AbstractClientConnAdapter - its state is now marked as volatile. I think the volatile marking needs to also be done in its subclasses, and classes used in the subclasses:&lt;br/&gt;
&lt;br/&gt;
1) AbstractPooledConnAdapter&lt;br/&gt;
2) AbstractPoolEntry&lt;br/&gt;
&lt;br/&gt;
java.lang.IllegalStateException: Connection already open.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.conn.AbstractPoolEntry.open(AbstractPoolEntry.java:131)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.conn.AbstractPooledConnAdapter.open(AbstractPooledConnAdapter.java:119)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.DefaultClientRequestDirector.execute(DefaultClientRequestDirector.java:314)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:500)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:455)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:421)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.performRequest(DefaultHttpExecutor.java:97)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor.access$000(DefaultHttpExecutor.java:26)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at com.limegroup.gnutella.http.DefaultHttpExecutor$MultiRequestor.run(DefaultHttpExecutor.java:135)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1006)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.limewire.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:549)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at java.lang.Thread.run(Unknown Source)</comment>
                    <comment id="12584272" author="olegk" created="Tue, 1 Apr 2008 20:39:07 +0100"  >Patch checked in. Many thanks, Tim. How reproducible is  &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-747&quot; title=&quot;No entry created for this pool.&quot;&gt;&lt;strike&gt;HTTPCLIENT-747&lt;/strike&gt;&lt;/a&gt;? Any change it could be reproduced with a test case?&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                    <comment id="12584277" author="tjulien" created="Tue, 1 Apr 2008 20:59:56 +0100"  >Do you mean &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-747&quot; title=&quot;No entry created for this pool.&quot;&gt;&lt;strike&gt;HTTPCLIENT-747&lt;/strike&gt;&lt;/a&gt; or this issue, HTTPCLIET-741?  You&amp;#39;re interested in tests for the patch I just submitted?</comment>
                    <comment id="12584282" author="olegk" created="Tue, 1 Apr 2008 21:18:06 +0100"  >I actually mean &lt;a href=&quot;https://issues.apache.org/jira/browse/HTTPCLIENT-747&quot; title=&quot;No entry created for this pool.&quot;&gt;&lt;strike&gt;HTTPCLIENT-747&lt;/strike&gt;&lt;/a&gt;, which is basically a separate JIRA for the &amp;#39;java.lang.IllegalStateException: No entry created for this pool&amp;#39; issue.&lt;br/&gt;
&lt;br/&gt;
Oleg</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10020">
                <name>Cloners</name>
                                <outwardlinks description="is cloned as">
                            <issuelink>
            <issuekey id="12395160">HTTPCLIENT-769</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12388515">HTTPCLIENT-747</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12379047" name="additional_concurrency_fixes.patch" size="1775" author="tjulien" created="Tue, 1 Apr 2008 19:38:38 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 2 Feb 2008 16:58:33 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>133779</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>47441</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>