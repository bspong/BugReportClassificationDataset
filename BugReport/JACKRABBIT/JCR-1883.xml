<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:35:36 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1883/JCR-1883.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1883] Moved node disappears</title>
                <link>https://issues.apache.org/jira/browse/JCR-1883</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>Moving a node and then refreshing it can make it disappear.&lt;br/&gt;
&lt;br/&gt;
deleteDirectory(new File(&amp;quot;repository&amp;quot;));&lt;br/&gt;
Repository rep = new TransientRepository();&lt;br/&gt;
Session session = rep.login(new SimpleCredentials(&amp;quot;&amp;quot;, new char[0]));&lt;br/&gt;
Node root = session.getRootNode();&lt;br/&gt;
Node a = root.addNode(&amp;quot;a&amp;quot;);&lt;br/&gt;
Node b = a.addNode(&amp;quot;b&amp;quot;);&lt;br/&gt;
session.save();&lt;br/&gt;
session.move(&amp;quot;/a/b&amp;quot;, &amp;quot;/b&amp;quot;);&lt;br/&gt;
b.refresh(false);&lt;br/&gt;
// session.save(); // no effect&lt;br/&gt;
for (NodeIterator it = root.getNodes(); it.hasNext();) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Node n = it.nextNode();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(n.getName());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;for (NodeIterator it2 = n.getNodes(); it2.hasNext();) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;  &amp;quot; + it2.nextNode().getName());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
In the trunk, the node &amp;#39;b&amp;#39; is not listed after the refresh (not under the root page, and not under a). The output is:&lt;br/&gt;
jcr:system&lt;br/&gt;
&amp;nbsp;&amp;nbsp;jcr:versionStorage&lt;br/&gt;
&amp;nbsp;&amp;nbsp;jcr:nodeTypes&lt;br/&gt;
a&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Jackrabbit 1.4.x throws an exception:&lt;br/&gt;
&lt;br/&gt;
jcr:system&lt;br/&gt;
&amp;nbsp;&amp;nbsp;jcr:versionStorage&lt;br/&gt;
&amp;nbsp;&amp;nbsp;jcr:nodeTypes&lt;br/&gt;
a&lt;br/&gt;
Exception in thread &amp;quot;main&amp;quot; javax.jcr.RepositoryException: failed to resolve name of acee31c4-c33b-4ed4-b1b5-39db6f17fb09&lt;br/&gt;
	at org.apache.jackrabbit.core.HierarchyManagerImpl.getName(HierarchyManagerImpl.java:451)&lt;br/&gt;
	at org.apache.jackrabbit.core.CachingHierarchyManager.getName(CachingHierarchyManager.java:287)&lt;br/&gt;
	at org.apache.jackrabbit.core.NodeImpl.getName(NodeImpl.java:1931)&lt;br/&gt;
	at org.apache.jackrabbit.core.fuzz.TestMoveRemoveRefresh.test(TestMoveRemoveRefresh.java:33)&lt;br/&gt;
	at org.apache.jackrabbit.core.fuzz.TestMoveRemoveRefresh.main(TestMoveRemoveRefresh.java:15)&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
void deleteDirectory(File file) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (file.isDirectory()) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;File[] list = file.listFiles();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;for(int i=0; i&amp;lt;list.length; i++) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;deleteDirectory(list[i]);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;file.delete();&lt;br/&gt;
}&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12409397">JCR-1883</key>
            <summary>Moved node disappears</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="tmueller">Thomas Mueller</assignee>
                                <reporter username="tmueller">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Nov 2008 15:19:11 +0000</created>
                <updated>Thu, 13 Aug 2009 16:03:43 +0100</updated>
                    <resolved>Wed, 10 Dec 2008 14:22:28 +0000</resolved>
                            <version>1.5</version>
                                <fixVersion>1.6</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12654836" author="tmueller" created="Tue, 9 Dec 2008 15:42:27 +0000"  >There are multiple solutions to the problem. &lt;br/&gt;
&lt;br/&gt;
One is, refresh will undo the move operation. But that would also change the old parent node, which may not be expected.&lt;br/&gt;
&lt;br/&gt;
Another solution is to reject refreshing this node. This is what I have implemented. Here is a proposed patch. I also want to add a test case for this issue.&lt;br/&gt;
&lt;br/&gt;
Index: src/main/java/org/apache/jackrabbit/core/ItemImpl.java&lt;br/&gt;
===================================================================&lt;br/&gt;
--- src/main/java/org/apache/jackrabbit/core/ItemImpl.java	(revision 722453)&lt;br/&gt;
+++ src/main/java/org/apache/jackrabbit/core/ItemImpl.java	(working copy)&lt;br/&gt;
@@ -1171,10 +1171,19 @@&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;switch (transientState.getStatus()) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;case ItemState.STATUS_STALE_MODIFIED:&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;case ItemState.STATUS_STALE_DESTROYED:&lt;br/&gt;
-                case ItemState.STATUS_EXISTING_MODIFIED:&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// add this item&amp;#39;s state to the list&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;list.add(transientState);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;break;&lt;br/&gt;
+                    &lt;br/&gt;
+                case ItemState.STATUS_EXISTING_MODIFIED:&lt;br/&gt;
+                    if (!transientState.getParentId().equals(&lt;br/&gt;
+                            transientState.getOverlayedState().getParentId())) {&lt;br/&gt;
+                        throw new RepositoryException(&lt;br/&gt;
+                                &amp;quot;Cannot refresh a moved item: &amp;quot; + this + &lt;br/&gt;
+                                &amp;quot; - possible solution: refresh the parent&amp;quot;);&lt;br/&gt;
+                    }&lt;br/&gt;
+                    list.add(transientState);&lt;br/&gt;
+                    break;&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;case ItemState.STATUS_NEW:&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throw new RepositoryException(</comment>
                    <comment id="12655221" author="tmueller" created="Wed, 10 Dec 2008 14:22:28 +0000"  >Fixed in revision 725292. The unit tests succeed, but I&amp;#39;m not sure if we should backport this fix yet - it may have some unwanted side effects.</comment>
                    <comment id="12657428" author="jukkaz" created="Wed, 17 Dec 2008 15:32:16 +0000"  >OK, marking this for 1.6.0. If there&amp;#39;s end user demand for a fix in 1.5.x then we can reconsider merging the fix to the 1.5 branch.</comment>
                </comments>
                    <attachments>
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>0.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 17 Dec 2008 15:32:16 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78397</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>252611</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>