<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:56:50 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-905/JCR-905.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-905] Clustering: race condition may cause duplicate entries in search index</title>
                <link>https://issues.apache.org/jira/browse/JCR-905</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>There seems to be a race condition that may cause duplicate search index entries. It is reproducible as follows (Jackrabbit 1.3):&lt;br/&gt;
1) Start clusternode 1 that just adds a single node of node type clustering:test.&lt;br/&gt;
2) Shutdown clusternode 1.&lt;br/&gt;
3) Start clusternode 2 with an empty search index.&lt;br/&gt;
4) Execute the query  //element(*, clustering:test).&lt;br/&gt;
4) Print the result of the query (UUIDs of nodes in the result set).&lt;br/&gt;
&lt;br/&gt;
When I just run clusternode 2, then there is one node in the resultset, as expected. However, when I debug clusternode 2 and have a breakpoint (i.e., a pause of a few seconds at line 306 of RepositoryImpl.java - just before the clusternode is started), then the resultset contains two results, both with the same UUID.&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12368914">JCR-905</key>
            <summary>Clustering: race condition may cause duplicate entries in search index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="martijnh">Martijn Hendriks</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 May 2007 10:42:29 +0100</created>
                <updated>Thu, 2 May 2013 03:29:09 +0100</updated>
                    <resolved>Tue, 18 Sep 2007 11:04:43 +0100</resolved>
                            <version>1.2.1</version>
                <version>1.2.2</version>
                <version>1.2.3</version>
                <version>1.3</version>
                <version>1.3.1</version>
                                <fixVersion>1.3.3</fixVersion>
                                <component>clustering</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12494507" author="martijnh" created="Wed, 9 May 2007 15:42:00 +0100"  >I think that the issue is caused by the fact that a Document for the node is created in two different indices as a result of the pause in scenario 2. Consider the attached log snippets. log1.txt shows scenario 1: everything is written to the volatile index. log2.txt shows what happens after a pause of a few seconds: the volatile index with the entry for node A (that has been generated by the index initialization) is written to disk, after which another Document containing node A is added to a new volatile index (as a result of an event that is generated by the cluster synchronization).&lt;br/&gt;
&lt;br/&gt;
(Please note that I added a custom debug statement to MultiIndex$AddNode).</comment>
                    <comment id="12498238" author="martijnh" created="Wed, 23 May 2007 14:56:57 +0100"  >We&amp;#39;ve found a one-line fix for this issue. The problem is that when the search index receives an event to add a node to the index, it does not take consider the persistent indices. The one-line fix is to first remove the node from the multi-index before adding it again: see attached patch.&lt;br/&gt;
</comment>
                    <comment id="12511114" author="jukkaz" created="Mon, 9 Jul 2007 14:20:38 +0100"  >Dominique/Marcel, do you see any potential regressions with this patch? I&amp;#39;m not confident enough to apply it in 1.3.1, but it sounds like it definitely should go in trunk before 1.4.</comment>
                    <comment id="12511401" author="mreutegg" created="Tue, 10 Jul 2007 12:56:53 +0100"  >This patch adds considerable overhead to the index process because for each added node the index has to first check if the node already exists. In lucene terms this means that lots of index readers and index writers are created and destroyed in a short period of time. The current code relies on the fact that the events passed to the query handler reflect a correct state change on the workspace. E.g. if an event says that a node is added, the index assumes that the node does not exist in the index.&lt;br/&gt;
&lt;br/&gt;
I see two ways to fix this issue:&lt;br/&gt;
&lt;br/&gt;
- The query handler does not automatically re-index the workspace, but rather re-plays the cluster-journal to get a valid index.&lt;br/&gt;
- The query handler needs to associate a journal revision with the current index state. When journal events are processed the query handler will ignore events from the &amp;#39;past&amp;#39;.&lt;br/&gt;
&lt;br/&gt;
I prefer option 2.</comment>
                    <comment id="12511697" author="martijnh" created="Wed, 11 Jul 2007 10:10:36 +0100"  >I already suspected that the proposed patch would give a significant overhead... Option 2 sounds elegant, but bootstrapping it looks non-trivial to me since the repository and the global revision can change during the re-indexing.</comment>
                    <comment id="12526402" author="mreutegg" created="Tue, 11 Sep 2007 11:10:25 +0100"  >Here&amp;#39;s an alternative patch, which handles the possible duplicates earlier in the index process, where it is also possible to detect an external update. This avoids the overhead for Jackrabbit instance, which does not operate in a cluster.&lt;br/&gt;
&lt;br/&gt;
Can someone with a cluster installation please test the patch and give feedback. I&amp;#39;ll then commit the patch if it fixes the issue.</comment>
                    <comment id="12528043" author="martijnh" created="Mon, 17 Sep 2007 13:38:25 +0100"  >I just tested Marcel&amp;#39;s patch and it works fine. It&amp;#39;s good to eliminate the overhead for non-clustered installations!&lt;br/&gt;
&lt;br/&gt;
Best wishes,&lt;br/&gt;
&lt;br/&gt;
Martijn</comment>
                    <comment id="12528336" author="mreutegg" created="Tue, 18 Sep 2007 11:04:43 +0100"  >Applied patch in revision: 576813&lt;br/&gt;
&lt;br/&gt;
Thank you all for testing.</comment>
                    <comment id="12529168" author="jukkaz" created="Thu, 20 Sep 2007 18:51:48 +0100"  >Merged to the 1.3 branch in revision 577835.</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10001">
                <name>dependent</name>
                                                <inwardlinks description="is depended upon by">
                            <issuelink>
            <issuekey id="12376794">JCR-1087</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12357997" name="JCR-905.patch" size="858" author="martijnh" created="Wed, 23 May 2007 14:56:57 +0100" />
                    <attachment id="12356976" name="log1.txt" size="1372" author="martijnh" created="Wed, 9 May 2007 15:42:00 +0100" />
                    <attachment id="12356977" name="log2.txt" size="1550" author="martijnh" created="Wed, 9 May 2007 15:42:00 +0100" />
                    <attachment id="12365544" name="SearchManager.patch" size="787" author="mreutegg" created="Tue, 11 Sep 2007 11:10:25 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 9 Jul 2007 13:20:38 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>41959</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>190608</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>