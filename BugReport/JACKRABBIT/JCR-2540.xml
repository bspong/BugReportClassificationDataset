<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:44:03 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-2540/JCR-2540.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-2540] spi2dav : move/reorder not properly handled by observation</title>
                <link>https://issues.apache.org/jira/browse/JCR-2540</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>all TCK tests including move or reorder fail in the setup jcr2spi - spi2dav(ex) - jcr-server.</description>
                <environment></environment>
            <key id="12458103">JCR-2540</key>
            <summary>spi2dav : move/reorder not properly handled by observation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="reschke">Julian Reschke</assignee>
                                <reporter username="anchela">angela</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Mar 2010 10:21:22 +0000</created>
                <updated>Tue, 6 Dec 2011 14:47:12 +0000</updated>
                    <resolved>Tue, 22 Nov 2011 15:22:59 +0000</resolved>
                            <version>2.0</version>
                                <fixVersion>2.3.4</fixVersion>
                                <component>jackrabbit-jcr-server</component>
                <component>jackrabbit-spi2dav</component>
                <component>JCR 2.0</component>
                <component>observation</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13144176" author="reschke" created="Fri, 4 Nov 2011 17:13:14 +0000"  >The remaining issue is caused by NODE_REMOVE events not having an identifier.&lt;br/&gt;
&lt;br/&gt;
Identifiers are currently generated by the URIResolver, based on the URI of the node reported in the event. The URI resolver then does a PROPFIND, asking for the UUID, the local name (unescaped), and the index, from which a local identifier is built.&lt;br/&gt;
&lt;br/&gt;
This, of course, doesn&amp;#39;t work for nodes that were just deleted (unless the information happens to be cached).&lt;br/&gt;
&lt;br/&gt;
As a matter of fact, the events returned by the server *do* contain the server&amp;#39;s identifier for that event. Unfortunately, these identifiers are no quite the same as those needed in spi2dav, which only uses UUID-style identifiers for referenceable nodes, while jackrabbit-core uses them throughout.&lt;br/&gt;
&lt;br/&gt;
The obvious fix would be to augment the event information sent by the server with more information, so that the subsequent PROPFIND is never needed.&lt;br/&gt;
&lt;br/&gt;
Putting this on hold while looking at the other observation related tickets...</comment>
                    <comment id="13152067" author="reschke" created="Thu, 17 Nov 2011 14:18:06 +0000"  >Updated summary now that the changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2542&quot; title=&quot;spi2dav: EventFilters not respected&quot;&gt;&lt;strike&gt;JCR-2542&lt;/strike&gt;&lt;/a&gt; provide us with node type information:&lt;br/&gt;
&lt;br/&gt;
We can now inspect the event and find out whether the node was referenceable, and if it was, compute the local node id from the remote id; this will remove the needed for any subsequent PROPFINDing&lt;br/&gt;
&lt;br/&gt;
I believe this would also clear the remaining failure in the GetIdentifierTest.&lt;br/&gt;
&lt;br/&gt;
What&amp;#39;s not so nice is that this *only* works for referenceable nodes. For non.referenceable nodes, we&amp;#39;d need the nodeId of the parent (which may be unknown if it&amp;#39;s removed as well).&lt;br/&gt;
&lt;br/&gt;
We *might* have the parentId though if the associated event was received as well, and we have been able to compute *that* nodeId.&lt;br/&gt;
&lt;br/&gt;
Rephrasing all of this...: -)&lt;br/&gt;
&lt;br/&gt;
- problem can be fixed for removal of referenceable nodes&lt;br/&gt;
- for other nodes we need the parentId, which might be cached (*)&lt;br/&gt;
&lt;br/&gt;
(*) Doing two passes through an event bundle might help in case the events arrive in the &amp;quot;wrong&amp;quot; order&lt;br/&gt;
&lt;br/&gt;
However, if all else fails, we only have a few choices:&lt;br/&gt;
&lt;br/&gt;
(1) Drop the event&lt;br/&gt;
(2a) Keep the event, and return null identifier (this is what happens now)&lt;br/&gt;
(2b) ..., and compute the identifier based on the relative path to the closest ancestor nodeId we know; if an intermediate node *was* refererenceable, this would be an incorrect identifier&lt;br/&gt;
&lt;br/&gt;
Feedback appreciated, Julian&lt;br/&gt;
</comment>
                    <comment id="13152127" author="reschke" created="Thu, 17 Nov 2011 16:35:41 +0000"  >Actually me recollection was wrong; the node removal test does not use a referenceable node.</comment>
                    <comment id="13152179" author="reschke" created="Thu, 17 Nov 2011 18:12:17 +0000"  >Correction: the node type information is for the associated parent node; so this doesn&amp;#39;t help in fixing out whether the node itself was referenceable.</comment>
                    <comment id="13154327" author="reschke" created="Mon, 21 Nov 2011 18:07:51 +0000"  >Summarizing the remaining open issue:&lt;br/&gt;
&lt;br/&gt;
We fail to compute an identifier for NODE_REMOVE events because computing the local identifier currently requires a lookup (PROPFIND) of the remote resource&amp;#39;s properties (UUID, name, index). We *do* have the remote resource&amp;#39;s identifier (as part of the event), but it&amp;#39;s not necessarily the same locally, because the way identifiers are assigned is not the same (jackrabbit-core has uuids for all nodes, spi2dav only for referenceable nodes).&lt;br/&gt;
&lt;br/&gt;
Things we can do to improve things:&lt;br/&gt;
&lt;br/&gt;
(1) Make sure that the URIResolver cache is populated with mappings for all nodes the client is touching (right now this is not the case).&lt;br/&gt;
&lt;br/&gt;
(2) When not able to lookup the remote resource, compute an identifier solely based on the remote resource&amp;#39;s href; that&amp;#39;s not necessarily the one the client might have seen before, but it might be better than &amp;quot;null&amp;quot;. Also note that if we do (1), we may already have the identifier. For nodes created by other sessions I think it&amp;#39;s acceptable that the identifiers returned with REMOVAL events are slightly off (there are also RepositoryDescriptors reporting identifier stability we could tune).&lt;br/&gt;
&lt;br/&gt;
(3) Avoid doing the remote PROPFIND when it was a REMOVE event. If we ever get a 207, it&amp;#39;ll be for a different resource anyway.&lt;br/&gt;
&lt;br/&gt;
Feedback appreciated...&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="13155032" author="mreutegg" created="Tue, 22 Nov 2011 11:31:06 +0000"  >I think, I would do it on a best effort basis and build a path based identifier for the event in case the URI cannot be translated into a UUID based identifier.&lt;br/&gt;
&lt;br/&gt;
See proposed patch.</comment>
                    <comment id="13155134" author="reschke" created="Tue, 22 Nov 2011 13:49:28 +0000"  >Yes, that works for me.&lt;br/&gt;
&lt;br/&gt;
Proposal:&lt;br/&gt;
&lt;br/&gt;
- document the remaining non-conformance somewhere (where? JIRA todo?)&lt;br/&gt;
&lt;br/&gt;
- clean up the code a bit (I&amp;#39;d like to avoid the PROPFIND that we know will cause a 404)</comment>
                    <comment id="13155202" author="reschke" created="Tue, 22 Nov 2011 15:22:59 +0000"  >Fixed in trunk with r1205029.&lt;br/&gt;
&lt;br/&gt;
&amp;quot;Fixed&amp;quot; means here: test case passes. We are still not fully compliant here; will fix a separate issue as TODO.</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12532348">JCR-3153</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12504726" name="JCR-2540.patch" size="1342" author="mreutegg" created="Tue, 22 Nov 2011 11:31:05 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 4 Nov 2011 17:13:14 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>36377</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>191576</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>