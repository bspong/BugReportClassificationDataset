<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:30:51 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1138/JCR-1138.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1138] Data store garbage collection</title>
                <link>https://issues.apache.org/jira/browse/JCR-1138</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>Currently the data store garbage collection needs to be run manually. It should be simpler to use (maybe tool based), or automatic.</description>
                <environment></environment>
            <key id="12378411">JCR-1138</key>
            <summary>Data store garbage collection</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="tmueller">Thomas Mueller</assignee>
                                <reporter username="tmueller">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Sep 2007 09:53:09 +0100</created>
                <updated>Tue, 15 Jan 2008 23:26:56 +0000</updated>
                    <resolved>Mon, 17 Dec 2007 14:34:16 +0000</resolved>
                                            <fixVersion>1.4</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12528000" author="tmueller" created="Mon, 17 Sep 2007 10:01:42 +0100"  >Revision 576314: added a test case and fixed a bug: The garbage collecter deleted too many files when not closing the repository first</comment>
                    <comment id="12528377" author="tmueller" created="Tue, 18 Sep 2007 14:05:50 +0100"  >To better support garbage collection for the data store, I suggest to add a new method to AbstractBundlePersistenceManager:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/**&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* Get all node ids. &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* A typical application will call this method multiple times, where &amp;#39;after&amp;#39;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* is the last row read. The maxCount parameter defines the maximum number of &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* node ids returned, 0 meaning no limit. The order of the node ids is specific for the &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* given persistent manager. Items that are added concurrently may not be included.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @param after the lower limit, or null for no limit.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @param maxCount the maximum number of node ids to return, or 0 for no limit.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @return an iterator of all bundles.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @throws ItemStateException if an error while loading occurs.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;*/&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public abstract NodeIdIterator getAllNodeIds(NodeId after, int maxCount)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throws ItemStateException;&lt;br/&gt;
&lt;br/&gt;
Only for the Bundle PersistenceManagers, because those persistence managers are the most important ones (in my view).&lt;br/&gt;
&lt;br/&gt;
This method is then called from the garbage collection process (or from a background thread from time to time, with a low maxCount and with enough sleep time in between). After all nodes are processed, the objects in the data store that were never scanned are deleted. This mechanism is better than the current mechanism as it can be restarted: only the last visited node needs to be persisted. It is also more efficient as the persistence manager can return the data in the order it is stored (which is easy for BundleFsPersistenceManager).&lt;br/&gt;
&lt;br/&gt;
What do you think, is this approach OK? &lt;br/&gt;
Thomas</comment>
                    <comment id="12528380" author="mreutegg" created="Tue, 18 Sep 2007 14:22:46 +0100"  >&amp;gt; The order of the node ids is specific for the given persistent manager.&lt;br/&gt;
&lt;br/&gt;
Doesn&amp;#39;t this mean that an implementation has to retain the order of the bundles it stores? E.g. for a very simple in memory PM you would have to use a LinkedHashMap, because a HashMap doesn&amp;#39;t work.</comment>
                    <comment id="12528385" author="tmueller" created="Tue, 18 Sep 2007 14:49:26 +0100"  >It does not need to be the insertion order, it can be any order. For BundleFsPersistenceManager the easiest approach would be sort by UUID. For BundleDbPersistenceManager it could be UUID as well, or anything where an index exists. For an in-memory persistence manager HashMap would not always work because the table could be resized. LinkedHashMap would work but not efficiently (you can&amp;#39;t get an iterator starting from a certain point). SortedMap would be better (using the tailMap method). &lt;br/&gt;
</comment>
                    <comment id="12528753" author="tmueller" created="Wed, 19 Sep 2007 14:09:08 +0100"  >Revision 577297: Add AbstractBundlePersistenceManager.getAllNodeIds</comment>
                    <comment id="12529319" author="martijnh" created="Fri, 21 Sep 2007 08:02:54 +0100"  >I used the MSSQL bundle PM for the unit tests, and found that the test added last wednesday fails for this PM. For the default derby PM it does not fail. &lt;br/&gt;
&lt;br/&gt;
testGetAllNodeIds(org.apache.jackrabbit.core.data.PersistenceManagerIteratorTest)  Time elapsed: 0.25 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!&lt;br/&gt;
junit.framework.AssertionFailedError: expected:&amp;lt;-1&amp;gt; but was:&amp;lt;1&amp;gt;&lt;br/&gt;
	at junit.framework.Assert.fail(Assert.java:47)&lt;br/&gt;
	at junit.framework.Assert.failNotEquals(Assert.java:282)&lt;br/&gt;
	at junit.framework.Assert.assertEquals(Assert.java:64)&lt;br/&gt;
	at junit.framework.Assert.assertEquals(Assert.java:201)&lt;br/&gt;
	at junit.framework.Assert.assertEquals(Assert.java:207)&lt;br/&gt;
	at org.apache.jackrabbit.core.data.PersistenceManagerIteratorTest.testGetAllNodeIds(PersistenceManagerIteratorTest.java:81)&lt;br/&gt;
	at org.apache.jackrabbit.core.data.PersistenceManagerIteratorTest.testGetAllNodeIds(PersistenceManagerIteratorTest.java:81)&lt;br/&gt;
</comment>
                    <comment id="12529321" author="tmueller" created="Fri, 21 Sep 2007 08:13:25 +0100"  >Thanks for reporting this! Silly me, I did not follow my own definition of next():&lt;br/&gt;
&amp;quot;The order of the node ids is specific for the given persistent manager.&amp;quot;&lt;br/&gt;
So I can&amp;#39;t just assert ascending order of UUIDs...&lt;br/&gt;
Still strange that it seems to work with other databases. I will test that.</comment>
                    <comment id="12529332" author="tmueller" created="Fri, 21 Sep 2007 08:58:57 +0100"  >Hi Martijn,&lt;br/&gt;
If you still have the jcr.log file (usually this is append-only), could you open it and find the place where the test faild with MS SQL Server? The test writes debug info, and I like to check if it really orders the other way. With Derby, I get:&lt;br/&gt;
&lt;br/&gt;
...&lt;br/&gt;
&amp;nbsp;f8425869-0c8f-4e1a-a3e3-d0631d895e34&lt;br/&gt;
&amp;nbsp;f8c06d0c-2233-4e65-bbe3-d5352df9eb93&lt;br/&gt;
&amp;nbsp;072a60c1-0f11-4b96-9dbc-bbe393611869&lt;br/&gt;
&amp;nbsp;16dba3fe-5521-449f-8f35-a4011e5bf3a6&lt;br/&gt;
&amp;nbsp;2093e0c0-d0e8-4282-a0d1-955739278bb8&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
I guess MS SQL Server orders like this:&lt;br/&gt;
&amp;nbsp;072a60c1-0f11-4b96-9dbc-bbe393611869&lt;br/&gt;
&amp;nbsp;16dba3fe-5521-449f-8f35-a4011e5bf3a6&lt;br/&gt;
&amp;nbsp;2093e0c0-d0e8-4282-a0d1-955739278bb8&lt;br/&gt;
...&lt;br/&gt;
&amp;nbsp;f8425869-0c8f-4e1a-a3e3-d0631d895e34&lt;br/&gt;
&amp;nbsp;f8c06d0c-2233-4e65-bbe3-d5352df9eb93&lt;br/&gt;
&lt;br/&gt;
Thanks!&lt;br/&gt;
Thomas</comment>
                    <comment id="12533687" author="tmueller" created="Wed, 10 Oct 2007 10:54:08 +0100"  >Revision 583413: The garbage collection deleted transient objects if the call sequence was:&lt;br/&gt;
&lt;br/&gt;
Session 1: add a blob (still in transient space)&lt;br/&gt;
Session 2: start garbage collection&lt;br/&gt;
Session 2: garbage collection completed, delete unused objects&lt;br/&gt;
Session 1: store the changes&lt;br/&gt;
&lt;br/&gt;
This change adds a WeakReference map to make sure transient objects are not deleted.&lt;br/&gt;
A test case is included.&lt;br/&gt;
</comment>
                    <comment id="12535639" author="prios" created="Wed, 17 Oct 2007 18:45:13 +0100"  >Shouldn&amp;#39;t transient objects be removed from the WeakReference map when they are persisted ?&lt;br/&gt;
Could this responsibility be added to the AbstractBundlePersistenceManager and called from the store(ChangeLog) method ?&lt;br/&gt;
</comment>
                    <comment id="12535652" author="tmueller" created="Wed, 17 Oct 2007 18:54:37 +0100"  >Transient objects are actually removed: when garbage collected.&lt;br/&gt;
That&amp;#39;s why a WeakReference map is used and not a regular map.&lt;br/&gt;
There is no need to write code to remove them.&lt;br/&gt;
Or is there a problem with this approach?</comment>
                    <comment id="12535670" author="prios" created="Wed, 17 Oct 2007 19:40:59 +0100"  >&amp;gt;Or is there a problem with this approach?&lt;br/&gt;
No, everything works fine !</comment>
                    <comment id="12552397" author="jukkaz" created="Mon, 17 Dec 2007 13:01:54 +0000"  >What&amp;#39;s the status of this issue, i.e. any chance of resolving this soon?</comment>
                    <comment id="12552399" author="tmueller" created="Mon, 17 Dec 2007 13:06:35 +0000"  >I will check in my changes today. In my view this item is then resolved.</comment>
                    <comment id="12552425" author="tmueller" created="Mon, 17 Dec 2007 14:32:27 +0000"  >With revision 604872, the code to run the data store garbage collection is:&lt;br/&gt;
&lt;br/&gt;
GarbageCollector gc = ((SessionImpl)session).createDataStoreGarbageCollector();&lt;br/&gt;
gc.scan();&lt;br/&gt;
gc.stopScan();&lt;br/&gt;
gc.deleteUnused();&lt;br/&gt;
&lt;br/&gt;
The garbage collector will iterate over all nodes in the repository and update the last modified date. If all persistence managers implement the IterablePersistenceManager interface, this mechanism will be used; if not, the garbage collector will scan the repository using the JCR API starting from the root node.&lt;br/&gt;
</comment>
                    <comment id="12552426" author="tmueller" created="Mon, 17 Dec 2007 14:34:16 +0000"  >Implemented in revision 604881</comment>
                </comments>
                    <attachments>
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>0.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 18 Sep 2007 13:22:46 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>142535</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189636</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>