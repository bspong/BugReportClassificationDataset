<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:47:54 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-721/JCR-721.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-721] Duplicate key in DatabasePersistenceManager</title>
                <link>https://issues.apache.org/jira/browse/JCR-721</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>Hi,&lt;br/&gt;
&lt;br/&gt;
I ran into the exception pasted below. We had 2 threads that both were saving. Maybe it is a race condition?  &lt;br/&gt;
&lt;br/&gt;
Regards,&lt;br/&gt;
&lt;br/&gt;
Martijn Hendriks&lt;br/&gt;
&amp;lt;GX&amp;gt; creative online development B.V.&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
t: 024 - 3888 261&lt;br/&gt;
f: 024 - 3888 621&lt;br/&gt;
e: &lt;a href=&apos;mailto:martijnh@gx.nl&apos;&gt;martijnh@gx.nl&lt;/a&gt;&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
Wijchenseweg 111&lt;br/&gt;
6538 SW Nijmegen&lt;br/&gt;
&lt;a href=&quot;http://www.gx.nl/&quot;&gt;http://www.gx.nl/&lt;/a&gt; &lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Jan 26, 2007 2:23:36 PM org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager store&lt;br/&gt;
SEVERE: failed to write property state: e3847bad-f1ee-4adb-a109-e134900935b7/{&lt;a href=&quot;http://gx.nl&quot;&gt;http://gx.nl&lt;/a&gt;}edit_language&lt;br/&gt;
ERROR 23505: The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or unique in dex identified by &amp;#39;DEFAULT_PROP_IDX&amp;#39; defined on &amp;#39;DEFAULT_PROP&amp;#39;.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.iapi.error.StandardException.newException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.IndexChanger.insertAndCheckDups(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.IndexChanger.doInsert(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.IndexChanger.insert(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.IndexSetChanger.insert(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.RowChangerImpl.insertRow(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.InsertResultSet.normalInsertCore(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.execute.InsertResultSet.open(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.sql.GenericPreparedStatement.execute(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.EmbedStatement.executeStatement(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.EmbedPreparedStatement.executeStatement(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.EmbedPreparedStatement.execute(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.executeStmt(DatabasePersistenceManager.java:835)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store(DatabasePersistenceManager.java:466)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.persistence.AbstractPersistenceManager.store(AbstractPersistenceManager.java:75)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.persistence.db.DatabasePersistenceManager.store(DatabasePersistenceManager.java:274)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.state.SharedItemStateManager$Update.end(SharedItemStateManager.java:675)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.state.SharedItemStateManager.update(SharedItemStateManager.java:808)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.state.LocalItemStateManager.update(LocalItemStateManager.java:326)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.state.XAItemStateManager.update(XAItemStateManager.java:313)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.state.LocalItemStateManager.update(LocalItemStateManager.java:302)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.state.SessionItemStateManager.update(SessionItemStateManager.java:295)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.ItemImpl.save(ItemImpl.java:1210)&lt;br/&gt;
</description>
                <environment>JackRabbit 1.2.1 using the default Derby repository.xml.</environment>
            <key id="12361439">JCR-721</key>
            <summary>Duplicate key in DatabasePersistenceManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="stefan@jira">Stefan Guggisberg</assignee>
                                <reporter username="martijnh">Martijn Hendriks</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Jan 2007 09:16:54 +0000</created>
                <updated>Tue, 20 Feb 2007 13:04:45 +0000</updated>
                    <resolved>Fri, 16 Feb 2007 15:16:20 +0000</resolved>
                            <version>1.2.1</version>
                                <fixVersion>1.2.2</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12468969" author="jukkaz" created="Wed, 31 Jan 2007 10:32:05 +0000"  >You&amp;#39;re right, this seems like a concurrency issue.</comment>
                    <comment id="12473102" author="martijnh" created="Wed, 14 Feb 2007 14:11:43 +0000"  >I think that I&amp;#39;ve traced a possible source of this error. It seems that the problem is at least present when two threads try to add the same property to a node. &lt;br/&gt;
&lt;br/&gt;
For the reproduction of the issue I will attach a test class. Using this test class and a debugger, the issue can be reproduced (In Jackrabbit 1.2.1) as follows:&lt;br/&gt;
1) set a breakpoint in the SharedItemStateManager in the Update.begin() method, for instance, line 522.&lt;br/&gt;
2) start the test and resume it once so that the two threads from the test class are suspended.&lt;br/&gt;
3) resume one of the test threads (it will finish)&lt;br/&gt;
4) set a breakpoint in DatabasePersistenceManager.store @ line 274 (&amp;quot;super.store(changelog)&amp;quot;);&lt;br/&gt;
5) resume the remaining thread: it will break in the DbPM.&lt;br/&gt;
6) stepping over the statement gives the exception (the itemstate has already been added by the other thread).&lt;br/&gt;
7) stepping further it can be seen that the method store will never return, which is imho a big issue...&lt;br/&gt;
&lt;br/&gt;
So I guess that the problem is that if the ChangeLog objects that are given to the SISM Update objects are non-disjoint, then persistence of one of them will fail because the DbPM.store method will never return (because the super.store operation always fails).&lt;br/&gt;
&lt;br/&gt;
It seems that this issue can be resolved by replacing &amp;quot;while(true)&amp;quot; by &amp;quot;while(trials&amp;gt;0)&amp;quot;. This, however, triggers a RepositoryException. Wouldn&amp;#39;t it be nice to have a more specific exception, such as a ConcurrentModificationException?&lt;br/&gt;
&lt;br/&gt;
Martijn&lt;br/&gt;
</comment>
                    <comment id="12473721" author="stefan@jira" created="Fri, 16 Feb 2007 15:16:20 +0000"  >martijn, thanks for the excellent and spot-on issue ananlysis, great job!&lt;br/&gt;
&lt;br/&gt;
i fixed the issue, i.e. endless loop in DatabasePersistenceManager.store(ChangeLog), as suggested in svn r508429.&lt;br/&gt;
&lt;br/&gt;
i agree that it would be nice if a more descriptive exception would be thrown (e.g. StaleItemStateException). unfortunately this would require a seperate select stmt for every property insert and therefore negatively affect performance. i don&amp;#39;t think it&amp;#39;s worth it. &lt;br/&gt;
&lt;br/&gt;
</comment>
                </comments>
                    <attachments>
                    <attachment id="12351141" name="Jcr721Test.java" size="2280" author="martijnh" created="Wed, 14 Feb 2007 14:13:38 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 31 Jan 2007 10:32:05 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>80502</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>191366</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>