<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:59:32 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-2674/JCR-2674.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-2674] FileDataStore ignores return code from setLastModified</title>
                <link>https://issues.apache.org/jira/browse/JCR-2674</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>Garbage collection depends on the file modification date being successfully updated when records are &amp;quot;touched&amp;quot; during the mark phase. The result of a silent failure is the catastrophic loss of the file in the sweep phase.&lt;br/&gt;
&lt;br/&gt;
FileDataStore.getRecordIfStored does not, however, check the return code from setLastModified.&lt;br/&gt;
&lt;br/&gt;
I believe I was bitten by this when my dev deployment ran out of disk space. A substantial portion of my datastore was deleted, and the best explanation I can come up with is that the setLastModified calls started (silently) failing, leading to massive overkill in the sweep.&lt;br/&gt;
&lt;br/&gt;
There is also a call to setLastModified in FileDataStore.addRecord which is not strictly correct in the face of GC (i.e. it needs the resolution offset, and also must succeed if the file is writable or risk incorrect collection).&lt;br/&gt;
&lt;br/&gt;
Patch to follow.</description>
                <environment>Solaris/ZFS/JDK1.6.0_20</environment>
            <key id="12469275">JCR-2674</key>
            <summary>FileDataStore ignores return code from setLastModified</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="tmueller">Thomas Mueller</assignee>
                                <reporter username="pkd">Peter Dettman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Jul 2010 19:27:03 +0100</created>
                <updated>Fri, 23 Sep 2011 15:22:58 +0100</updated>
                    <resolved>Thu, 15 Jul 2010 11:16:46 +0100</resolved>
                            <version>2.1</version>
                                <fixVersion>2.2</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12888494" author="pkd" created="Wed, 14 Jul 2010 20:09:12 +0100"  >Patch modifies FileDataStore to check the return value from setLastModified as appropriate (raises an exception if it failed), and makes sure ACCESS_TIME_RESOLUTION is used in addRecord.&lt;br/&gt;
&lt;br/&gt;
Also modifies GarbageCollector to check for -1 return value from Property.getLength since exceptions don&amp;#39;t necessarily propagate.&lt;br/&gt;
</comment>
                    <comment id="12888769" author="tmueller" created="Thu, 15 Jul 2010 11:14:00 +0100"  >Thanks a lot for the patch! It is now committed (in the trunk only so far). I made an additional change in addRecord: currently it&amp;#39;s &amp;quot;if (file.lastModified() &amp;lt; now)&amp;quot; - I will change that to &amp;quot;if (file.lastModified() &amp;lt; now + ACCESS_TIME_RESOLUTION)&amp;quot;.&lt;br/&gt;
&lt;br/&gt;
Again about addRecord: your code only throws an exception if file.canWrite() returns true - is that for read-only file systems / access rights? Or does it have a different reason?&lt;br/&gt;
&lt;br/&gt;
&amp;gt; check for -1 return value from Property.getLength&lt;br/&gt;
&lt;br/&gt;
You mean the exception from FileDataStore.getRecordIfStored() is swallowed? That&amp;#39;s wouldn&amp;#39;t be nice. Anyway, your change is OK.</comment>
                    <comment id="12888777" author="pkd" created="Thu, 15 Jul 2010 12:11:27 +0100"  >1. My feeling is that &amp;quot;if (file.lastModified() &amp;lt; now + ACCESS_TIME_RESOLUTION)&amp;quot; is not necessary, since the lastModified value will already be truncated to the system resolution, but I do not think it is harmful.&lt;br/&gt;
&lt;br/&gt;
2. I chose to throw exception only if file.canWrite, because I was trying to minimise the impact of the change. It&amp;#39;s not clear to me whether setLastModified might work when !file.canWrite. However, it certainly must work (because of GC) if file.canWrite. I would consider moving the canWrite test outside of the setLastModified call, similar to getRecordIfStored, it just wasn&amp;#39;t necessary to fix the immediate problem.&lt;br/&gt;
&lt;br/&gt;
3. Well, not swallowed exactly, but caught and converted to failure return code (-1) e.g. see BLOBInDataStore.getSize. In any case, the javadoc for Property.getLength/getLengths documents -1 as a possible &amp;quot;failure&amp;quot; return code, so it had to be tested. I think if Property.getLength/getLengths throws an exception, that is already correctly handled.&lt;br/&gt;
&lt;br/&gt;
Thanks for the quick response.&lt;br/&gt;
&lt;br/&gt;
</comment>
                </comments>
                    <attachments>
                    <attachment id="12449478" name="JCR-2674.patch" size="3223" author="pkd" created="Wed, 14 Jul 2010 20:09:12 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 15 Jul 2010 10:14:00 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>59592</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189844</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>