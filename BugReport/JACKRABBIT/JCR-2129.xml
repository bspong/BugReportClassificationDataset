<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:44:27 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-2129/JCR-2129.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-2129] Prevent data inconsistencies due to incorrect or missed merges in the ItemStateManagers</title>
                <link>https://issues.apache.org/jira/browse/JCR-2129</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>There are two places where transient state changes are merged with persisted state: (i) in the SessionISM.stateModified call back method (typically called by a saving thread after it&amp;#39;s changes have been saved) and (ii) in the SharedISM.Update.begin method. Sometimes the merge strategy fails in the sense that corrupt data is written to database. &lt;br/&gt;
&lt;br/&gt;
How to reproduce:&lt;br/&gt;
The attached test program contains steps to reproduce the issue. The testInconsistency1 method concurrently adds a node D to a node A and moves child node B of A to another place. This sometimes results in a situation in which node A still has a child reference to node B whereas B has another parent. In this situation, Jackrabbit cannot be started anymore if the search index is missing: &lt;br/&gt;
&lt;br/&gt;
Jun 8, 2009 2:16:23 PM org.apache.jackrabbit.core.query.OnWorkspaceInconsistency$1 handleMissingChildNode&lt;br/&gt;
SEVERE: Node /A (a7a29e8c-8d13-4fbd-b0ca-4f93f9c0ef42) has missing child &amp;#39;B&amp;#39; (80aa13c5-1db6-4f62-b576-5e7f626d90c1)&lt;br/&gt;
Jun 8, 2009 2:16:23 PM org.apache.jackrabbit.core.RepositoryImpl initStartupWorkspaces&lt;br/&gt;
SEVERE: Failed to initialize workspace &amp;#39;wm9&amp;#39;&lt;br/&gt;
&lt;br/&gt;
The testInconsistency2 method concurrently adds a reference property to a node B (the threads do exactly the same). This sometimes results in a situation in which the referenced node can never be removed anymore because there is a &amp;quot;ghost&amp;quot; reference to it which cannot be removed. (It gives a ReferentialIntegrityException).&lt;br/&gt;
&lt;br/&gt;
Jun 8, 2009 2:19:51 PM org.apache.jackrabbit.core.state.MLRUItemStateCache cache&lt;br/&gt;
WARNING: overwriting cached entry bc28ff87-216d-4ccd-bd73-03e7499ab54e/{}ref to B&lt;br/&gt;
Exception in thread &amp;quot;main&amp;quot; javax.jcr.ReferentialIntegrityException: 9f025634-d3e1-448e-904c-1c285f6b1bf6: the node cannot be removed because it is still being referenced.&lt;br/&gt;
&lt;br/&gt;
It seems the first problem (the parent-child relation) is caused by an incorrect merge in the NodeStateMerger class. The second problem might also be caused by an incorrect or missed merge, but I am not sure whether that&amp;#39;s the real problem.&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12427284">JCR-2129</key>
            <summary>Prevent data inconsistencies due to incorrect or missed merges in the ItemStateManagers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="martijnh">Martijn Hendriks</reporter>
                        <labels>
                    </labels>
                <created>Sat, 6 Jun 2009 19:52:19 +0100</created>
                <updated>Wed, 26 May 2010 11:27:42 +0100</updated>
                    <resolved>Mon, 29 Jun 2009 11:30:03 +0100</resolved>
                            <version>core 1.4.5</version>
                                <fixVersion>core 1.4.12</fixVersion>
                <fixVersion>1.5.7</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12717637" author="martijnh" created="Tue, 9 Jun 2009 11:29:15 +0100"  >Attached a patch which contains two single threaded JUnit testcases for the mentioned problems.</comment>
                    <comment id="12718356" author="martijnh" created="Thu, 11 Jun 2009 09:49:58 +0100"  >Created a separate issue for the references issue because it seems unrelated to the parent-child thing: &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2138&quot; title=&quot;Prevent persistence of faulty back-references&quot;&gt;&lt;strike&gt;JCR-2138&lt;/strike&gt;&lt;/a&gt;.</comment>
                    <comment id="12718417" author="martijnh" created="Thu, 11 Jun 2009 12:49:44 +0100"  >Attached a testcase + patch.&lt;br/&gt;
&lt;br/&gt;
The problem seems to be that the NodeStateMerger cannot distinguish externally added child nodes from locally moved child nodes (both show up in the getRemovedChildNodeEntries result).</comment>
                    <comment id="12724053" author="mreutegg" created="Thu, 25 Jun 2009 12:44:52 +0100"  >I&amp;#39;d like to extend the test cases to cover more cases including any combination of add/remove node by one session and move node to/from by another session.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ll post an updated patch when it is ready....  </comment>
                    <comment id="12724498" author="mreutegg" created="Fri, 26 Jun 2009 13:14:02 +0100"  >Attached is an extended version of Martijns initial patch. It contains more test cases covering various combinations of modifications as well as previously untested modifications.&lt;br/&gt;
&lt;br/&gt;
I also extended the NodeStateMerger.MergeContext with an additional method that allows the merge to distinguish between an externally added/removed node and a locally moved node.&lt;br/&gt;
&lt;br/&gt;
Martijn, can you please test the patch and report back if it works for you? thanks.</comment>
                    <comment id="12725102" author="martijnh" created="Mon, 29 Jun 2009 10:51:02 +0100"  >Marcel, thanks for extending the test cases and creating a new patch, which works fine for me! I see that you improved the merging strategy which is nicer than throwing an ItemStateException.</comment>
                    <comment id="12725111" author="mreutegg" created="Mon, 29 Jun 2009 11:30:03 +0100"  >Thank you for the feedback.&lt;br/&gt;
&lt;br/&gt;
Committed my version of the patch in revision: 789279</comment>
                    <comment id="12728115" author="jukkaz" created="Tue, 7 Jul 2009 15:09:29 +0100"  >Merged to the 1.x branch in revision 791842.</comment>
                    <comment id="12731486" author="jukkaz" created="Wed, 15 Jul 2009 15:51:12 +0100"  >Merged to the 1.5 branch in revision 794292.</comment>
                    <comment id="12871615" author="jukkaz" created="Wed, 26 May 2010 11:27:42 +0100"  >Merged to the 1.4 branch in revision 948381.</comment>
                </comments>
                    <attachments>
                    <attachment id="12410068" name="InconsistencyTest.java" size="7071" author="martijnh" created="Sat, 6 Jun 2009 19:54:18 +0100" />
                    <attachment id="12411913" name="JCR-2129.patch" size="32958" author="mreutegg" created="Fri, 26 Jun 2009 13:14:02 +0100" />
                    <attachment id="12410383" name="JCR-2129.patch" size="3377" author="martijnh" created="Thu, 11 Jun 2009 12:49:44 +0100" />
                    <attachment id="12410213" name="JCR-2129-testcase.patch" size="9085" author="martijnh" created="Tue, 9 Jun 2009 11:30:10 +0100" />
                    <attachment id="12410069" name="repository.xml" size="5192" author="martijnh" created="Sat, 6 Jun 2009 19:54:18 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 25 Jun 2009 11:44:52 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78328</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189867</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>