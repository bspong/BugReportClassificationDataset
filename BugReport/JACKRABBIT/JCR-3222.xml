<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:34:08 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-3222/JCR-3222.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-3222] Allow servlet filters to specify custom session providers</title>
                <link>https://issues.apache.org/jira/browse/JCR-3222</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>In order to integrate the Jackrabbit davex server functionality with their custom authentication logic, the Sling project currently needs to embed and subclass the davex servlet classes. It would be cleaner if such tight coupling wasn&amp;#39;t needed.&lt;br/&gt;
&lt;br/&gt;
One way to achieve something like that would be to allow external components to provide a custom SessionProvider instance as an extra request attribute. This way for example a servlet filter that implements such custom authentication logic could easily make its functionality available to the standard davex servlet in Jackrabbit.</description>
                <environment></environment>
            <key id="12539940">JCR-3222</key>
            <summary>Allow servlet filters to specify custom session providers</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="jukkaz">Jukka Zitting</assignee>
                                <reporter username="jukkaz">Jukka Zitting</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jan 2012 18:03:00 +0000</created>
                <updated>Sun, 27 May 2012 11:04:05 +0100</updated>
                    <resolved>Fri, 27 Jan 2012 19:11:37 +0000</resolved>
                                            <fixVersion>2.4</fixVersion>
                                <component>jackrabbit-jcr-server</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13194041" author="jukkaz" created="Thu, 26 Jan 2012 18:16:42 +0000"  >Proposed patch.</comment>
                    <comment id="13194074" author="fmeschbe" created="Thu, 26 Jan 2012 18:53:39 +0000"  >Unfortunately this is a compiled library and I cannot see, what&amp;#39;s changed ....&lt;br/&gt;
&lt;br/&gt;
But then, somehow this feels like official Reflection Programming ....&lt;br/&gt;
&lt;br/&gt;
How about using OSGi services ?&lt;br/&gt;
&lt;br/&gt;
(0) The DavexServletService is already registered as a Servlet service for Whiteboard Http Service registration&lt;br/&gt;
(1) We could add a contextId configuration which could be configured to refer to a HttpContext service used by the Whiteboard registration&lt;br/&gt;
(2) Support a SessionProvider service providing pluggability&lt;br/&gt;
&lt;br/&gt;
Sling (or other OSGi based use cases) could then just provide the missing pieces.&lt;br/&gt;
&lt;br/&gt;
Will provide a proposed patch.</comment>
                    <comment id="13194095" author="fmeschbe" created="Thu, 26 Jan 2012 19:13:35 +0000"  >Proposed patch enhancing DavexServletService</comment>
                    <comment id="13194180" author="jukkaz" created="Thu, 26 Jan 2012 21:10:01 +0000"  >I considered the OSGi whiteboard pattern for this, but it doesn&amp;#39;t work for the Sling davex bundle. The Sling authentication code needs to be able to take over the entire processing of a request instead of just servicing a getSession() call. Thus a Sling component that interacts with the default Jackrabbit davex servlet in any case needs to be set up as a servlet filter (or a subclass like it currently is). Therefore passing the appropriate SessionProvider as a request attribute is IMHO a much more straightforward solution. And it works nicely also in non-OSGi deployments.</comment>
                    <comment id="13194507" author="fmeschbe" created="Fri, 27 Jan 2012 06:09:31 +0000"  >&amp;gt; The Sling authentication code needs to be able to take over the entire processing of a request instead of just servicing a getSession() call. &lt;br/&gt;
&lt;br/&gt;
This is wrong.&lt;br/&gt;
&lt;br/&gt;
The DavexServletService is registered as a servlet service and gets processing the request from the service call. A service in OSGi registered along with an Osgi HttpContext object which has a handleSecurity method, which handles authentication before the servlet is even called. By having a contextId service property a whiteboard servlet service can refer to a whiteboard HttpContext service which implements that method accordingly.&lt;br/&gt;
&lt;br/&gt;
Thus my patch allows to plug a HttpContext service which we in Sling can provide to call the Sling authentication processing. This then makes the ResourceResolver and hence the Session available to the servlet.&lt;br/&gt;
&lt;br/&gt;
Inside the servlet, the patch implements the getSessionProvider method to return a proxy SessionProvider which either provides a registered SessionProvider service or returns the default from the parent class. Sling will den provide a SessionProvider service which knows about the Sling authentication and can extract the session from the ResourceResolver.&lt;br/&gt;
&lt;br/&gt;
Existing uses of the JcrRemotingServlet need not be changed as does the JcrRemotingServlet. Everything is done in the DavexServletService with proper OSGi oriented actions -- except for the ResourceResolver defined as a request attribute, which we already have.</comment>
                    <comment id="13194663" author="jukkaz" created="Fri, 27 Jan 2012 12:52:22 +0000"  >&amp;gt; This is wrong. &lt;br/&gt;
&lt;br/&gt;
That&amp;#39;s what the HttpContext.handleSecurity() method does, right? It&amp;#39;s needs to be able to take over the entire processing of a request.&lt;br/&gt;
&lt;br/&gt;
&amp;gt; By having a contextId service property a whiteboard servlet service can refer to a whiteboard&lt;br/&gt;
&amp;gt; HttpContext service which implements that method accordingly.&lt;br/&gt;
&lt;br/&gt;
You need some code to actually implement the HttpContext interface. That code could simply do request.setAttribute(SessionProvider.class.getName(), customSessionProvider) in the handleSecurity() method, right? I don&amp;#39;t see why the SessionProvider instance would need to be an OSGi service in this case.&lt;br/&gt;
&lt;br/&gt;
Of course, if there is a case why some component would want to implement the SessionProvider interface without the ability to terminate request processing or to send a custom HTTP response, then I could see why accessing SessionProviders as OSGi services would be useful. In such a case though, we should support potentially more than just a single SessionProvider service and make sure that the releaseSession() calls get routed to the correct provider (which your current patch doesn&amp;#39;t guarantee).&lt;br/&gt;
</comment>
                    <comment id="13194699" author="fmeschbe" created="Fri, 27 Jan 2012 13:26:16 +0000"  >&amp;gt; That&amp;#39;s what the HttpContext.handleSecurity() method does, right? It&amp;#39;s needs to be able to take over the entire processing of a request. &lt;br/&gt;
&lt;br/&gt;
No, this is called by the Http Service before calling the servlet. The handleSecurity method either returns true in which case the servlet is called or false in which case the request is terminated and the servlet is not called.&lt;br/&gt;
&lt;br/&gt;
The handleSecurity method must set up to three request attributes which are used to implement HttpServletRequest methods (getRemoteUser, getAuthType, getUserPrincipal). In addition the Sling implementation could provide the ResourceResolver (what we do in the Sling DavEx bundle.&lt;br/&gt;
&lt;br/&gt;
The handleSecurity method could of course set the SessionProvider, too. But I don&amp;#39;t like this -- special case handling affecting all but used by one only.&lt;br/&gt;
&lt;br/&gt;
In addtion: unless you will be implementing a special proxy SessionProvider looking for the actual provider on each request, the getSessionProvider() method is AFAICT only called once no matter how many different SessionProviders are found in the request attributes... The SessionProvider is not something request specific but something setup specific. Hence a service and not request attribute.</comment>
                    <comment id="13194939" author="jukkaz" created="Fri, 27 Jan 2012 17:35:04 +0000"  >&amp;gt; But I don&amp;#39;t like this -- special case handling affecting all but used by one only.&lt;br/&gt;
&lt;br/&gt;
You don&amp;#39;t have the same concern about injecting the ResourceResolver instance as a request attribute? Just like the OSGi service space, the attributes support in servlet requests (or servlet context, etc.) is a whiteboard shared by multiple providers and consumers. Why would adding a properly namespaced attribute affect anyone but the consumer of that attribute?&lt;br/&gt;
&lt;br/&gt;
Additionally, the AuthHttpContext class in the Sling davex bundle is already designed specifically for the needs of the davex servlet (it needs to interpret the workspace part of the URL). So I don&amp;#39;t see how this would affect anyone but the davex servlet.&lt;br/&gt;
&lt;br/&gt;
Anyway, I guess we should simply allow both approaches and let downstream users decide which mechanism they want to use.&lt;br/&gt;
&lt;br/&gt;
PS. Sorry about uploading the wrong file above... :-) I&amp;#39;ve uploaded the actual patch.</comment>
                    <comment id="13195028" author="jukkaz" created="Fri, 27 Jan 2012 19:11:38 +0000"  >OK, I&amp;#39;ve now combined the two approaches. Revision 1236819 is my original patch and revision 1236821 a modified version of Felix&amp;#39; patch with support for potentially more than just a single external SessionProvider service. Note that the request attribute mechanism works for all webdav servlets, while the OSGi service mechanism only works for the davex servlet (since it&amp;#39;s the only servlet configured as an OSGi service).&lt;br/&gt;
&lt;br/&gt;
Additionally in revision 1236820 I moved some extra SessionProviderImpl code (added in &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2539&quot; title=&quot;spi2dav: Observation&amp;#39;s user data not property handled&quot;&gt;&lt;strike&gt;JCR-2539&lt;/strike&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2542&quot; title=&quot;spi2dav: EventFilters not respected&quot;&gt;&lt;strike&gt;JCR-2542&lt;/strike&gt;&lt;/a&gt;) to the JCRWebdavServlet class where it belongs better. That clears up the SessionProvider API contract and avoids breaking functionality when using custom SessionProvider implementations.&lt;br/&gt;
&lt;br/&gt;
Merged to the 2.4 branch in revision 1236837.&lt;br/&gt;
</comment>
                </comments>
                    <attachments>
                    <attachment id="12512198" name="0001-JCR-3222-Allow-servlet-filters-to-specify-custom-ses.patch" size="7085" author="jukkaz" created="Fri, 27 Jan 2012 17:35:04 +0000" />
                    <attachment id="12512015" name="jackrabbit-jcr-server-2.6-SNAPSHOT.jar" size="329554" author="jukkaz" created="Thu, 26 Jan 2012 18:16:42 +0000" />
                    <attachment id="12512021" name="JCR-3222-fmeschbe.patch" size="3773" author="fmeschbe" created="Thu, 26 Jan 2012 19:13:35 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 26 Jan 2012 18:53:39 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>225444</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>250168</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>