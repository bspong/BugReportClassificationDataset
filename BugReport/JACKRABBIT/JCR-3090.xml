<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:29:14 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-3090/JCR-3090.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-3090] setFetchSize() fails in getAllNodeIds()</title>
                <link>https://issues.apache.org/jira/browse/JCR-3090</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>I get the following exception from the PersistenceManagerIteratorTest on Windows:&lt;br/&gt;
&lt;br/&gt;
org.apache.jackrabbit.core.state.ItemStateException: getAllNodeIds failed.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.persistence.pool.BundleDbPersistenceManager.getAllNodeIds(BundleDbPersistenceManager.java:1043)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.data.PersistenceManagerIteratorTest.testGetAllNodeIds(PersistenceManagerIteratorTest.java:106)&lt;br/&gt;
Caused by: java.sql.SQLException: Invalid parameter value &amp;#39;10&amp;#39;000&amp;#39; for Statement.setFetchSize(int rows).&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.SQLExceptionFactory40.getSQLException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.Util.newEmbedSQLException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.Util.generateCsSQLException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.EmbedConnection.newSQLException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.ConnectionChild.newSQLException(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.derby.impl.jdbc.EmbedStatement.setFetchSize(Unknown Source)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.commons.dbcp.DelegatingStatement.setFetchSize(DelegatingStatement.java:279)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.commons.dbcp.DelegatingStatement.setFetchSize(DelegatingStatement.java:279)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.util.db.ConnectionHelper.reallyExec(ConnectionHelper.java:372)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.util.db.ConnectionHelper$3.call(ConnectionHelper.java:353)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.util.db.ConnectionHelper$3.call(ConnectionHelper.java:349)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.util.db.ConnectionHelper$RetryManager.doTry(ConnectionHelper.java:472)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.util.db.ConnectionHelper.exec(ConnectionHelper.java:349)&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;at org.apache.jackrabbit.core.persistence.pool.BundleDbPersistenceManager.getAllNodeIds(BundleDbPersistenceManager.java:1020)&lt;br/&gt;
&lt;br/&gt;
It&amp;#39;s caused by the following code in ConnectionHelper when 0 &amp;lt; maxRows &amp;lt; 10000:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;stmt.setMaxRows(maxRows);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;stmt.setFetchSize(10000);&lt;br/&gt;
&lt;br/&gt;
A simple fix would be:&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;stmt.setMaxRows(maxRows);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;stmt.setFetchSize(Math.min(10000, maxRows));&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12525496">JCR-3090</key>
            <summary>setFetchSize() fails in getAllNodeIds()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="jukkaz">Jukka Zitting</assignee>
                                <reporter username="jukkaz">Jukka Zitting</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Oct 2011 21:53:40 +0100</created>
                <updated>Tue, 15 Nov 2011 13:24:22 +0000</updated>
                    <resolved>Sun, 2 Oct 2011 22:01:03 +0100</resolved>
                                            <fixVersion>2.2.10</fixVersion>
                <fixVersion>2.3.1</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13119066" author="jukkaz" created="Sun, 2 Oct 2011 22:01:04 +0100"  >Fixed in revision 1178251.</comment>
                    <comment id="13119963" author="dfghi" created="Tue, 4 Oct 2011 09:38:41 +0100"  >It seems that every call to the &amp;quot;reallyExec&amp;quot; method have a 0 as the value passed for maxRows. This means that the setFetchSize hint is always disable, and I think this will re-open &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2832&quot; title=&quot;Crash when adding node to cluster with big journal on PSQL DB&quot;&gt;&lt;strike&gt;JCR-2832&lt;/strike&gt;&lt;/a&gt;.&lt;br/&gt;
</comment>
                    <comment id="13120363" author="jukkaz" created="Tue, 4 Oct 2011 19:31:21 +0100"  >Good catch about the maxRows == 0 case. I fixed that in revision 1178892.</comment>
                    <comment id="13120485" author="dfghi" created="Tue, 4 Oct 2011 22:22:49 +0100"  >I&amp;#39;m sorry, I wasn&amp;#39;t clear. I was not asking for further patch. Please take a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2892&quot; title=&quot;Large fetch sizes have potentially deleterious effects on VM memory requirements when using Oracle&quot;&gt;&lt;strike&gt;JCR-2892&lt;/strike&gt;&lt;/a&gt;.&lt;br/&gt;
Long story short, both this issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2892&quot; title=&quot;Large fetch sizes have potentially deleterious effects on VM memory requirements when using Oracle&quot;&gt;&lt;strike&gt;JCR-2892&lt;/strike&gt;&lt;/a&gt; (and I suppose a few more) are caused by the explicit value of fetchSize, introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2832&quot; title=&quot;Crash when adding node to cluster with big journal on PSQL DB&quot;&gt;&lt;strike&gt;JCR-2832&lt;/strike&gt;&lt;/a&gt; for a postgreSql problem. If you don&amp;#39;t set that value at all, the driver will choose the best default and both this issue and &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2892&quot; title=&quot;Large fetch sizes have potentially deleterious effects on VM memory requirements when using Oracle&quot;&gt;&lt;strike&gt;JCR-2892&lt;/strike&gt;&lt;/a&gt; would be immediately solved, but the value was arbitrarily forced to that 10000, which may be good for postgresql but not for other databases.&lt;br/&gt;
Possible final solutions are either to make the fetchSize configurable as a parameter in the xml, or to have a few ConnectionHelpers that sets the fetchSize depending on the db (or better, setting it for postgresql and not for any other db), or to try a smaller value (10?) that should be good (although non optimal) for all the databases.</comment>
                    <comment id="13150473" author="jukkaz" created="Tue, 15 Nov 2011 13:24:22 +0000"  >Merged to the 2.2 branch in revision 1202178.</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12492613">JCR-2832</issuekey>
        </issuelink>
                    </outwardlinks>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12498698">JCR-2892</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>0.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 4 Oct 2011 08:38:41 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>43464</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>250233</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>