<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:48:29 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-3205/JCR-3205.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-3205] Missing support for lock timeout and ownerHint in jcr-server</title>
                <link>https://issues.apache.org/jira/browse/JCR-3205</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>trying to set the lock timeout when creating a lock seems not to work over the davex transport. the timeout is always 2147483.&lt;br/&gt;
&lt;br/&gt;
this was my test code:&lt;br/&gt;
&lt;br/&gt;
import javax.jcr.*;&lt;br/&gt;
import javax.jcr.lock.*;&lt;br/&gt;
&lt;br/&gt;
import org.apache.jackrabbit.jcr2spi.RepositoryImpl;&lt;br/&gt;
import org.apache.jackrabbit.jcr2spi.config.RepositoryConfig;&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
String url = &amp;quot;&lt;a href=&quot;http://localhost:8080/server/&quot;&gt;http://localhost:8080/server/&lt;/a&gt;&amp;quot;;&lt;br/&gt;
String workspace = &amp;quot;tests&amp;quot;;&lt;br/&gt;
&lt;br/&gt;
RepositoryConfig config = new RepositoryConfigImplTest(repoUrl);&lt;br/&gt;
Repository repo = RepositoryImpl.create(config);&lt;br/&gt;
&lt;br/&gt;
Credentials sc = new SimpleCredentials(&amp;quot;admin&amp;quot;,&amp;quot;admin&amp;quot;.toCharArray());&lt;br/&gt;
Session s = repo.login(sc,workspace);&lt;br/&gt;
&lt;br/&gt;
Node t;&lt;br/&gt;
if (s.getRootNode().hasNode(&amp;quot;test&amp;quot;)) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;t = s.getRootNode().getNode(&amp;quot;test&amp;quot;);&lt;br/&gt;
} else {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;t = s.getRootNode().addNode(&amp;quot;test&amp;quot;, &amp;quot;nt:unstructured&amp;quot;);&lt;br/&gt;
}&lt;br/&gt;
t.addMixin(&amp;quot;mix:lockable&amp;quot;);&lt;br/&gt;
s.save();&lt;br/&gt;
LockManager m = s.getWorkspace().getLockManager();&lt;br/&gt;
Lock l = m.lock(t.getPath(), false, true, 10, &amp;quot;me&amp;quot;);&lt;br/&gt;
System.out.println(l.getSecondsRemaining());&lt;br/&gt;
&lt;br/&gt;
and the output is 2147483&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
the relevant communication fragment is below, i attach the full trace in case i miss something.&lt;br/&gt;
&lt;br/&gt;
LOCK /server/tests/jcr%3aroot/test HTTP/1.1&lt;br/&gt;
Timeout: Second-10&lt;br/&gt;
Depth: 0&lt;br/&gt;
Link: &amp;lt;urn:uuid0c740bb9-042a-4ef2-b019-1a6c52784c29&amp;gt;; rel=&amp;quot;&lt;a href=&quot;http://www.day.com/jcr/webdav/1.0/session-id&quot;&gt;http://www.day.com/jcr/webdav/1.0/session-id&lt;/a&gt;&amp;quot;&lt;br/&gt;
Authorization: Basic YWRtaW46YWRtaW4=&lt;br/&gt;
User-Agent: Jakarta Commons-HttpClient/3.0&lt;br/&gt;
Host: localhost:8080&lt;br/&gt;
Content-Length: 254&lt;br/&gt;
Content-Type: text/xml; charset=UTF-8&lt;br/&gt;
&lt;br/&gt;
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot; standalone=&amp;quot;no&amp;quot;?&amp;gt;&amp;lt;D:lockinfo xmlns:D=&amp;quot;DAV:&amp;quot;&amp;gt;&amp;lt;D:lockscope&amp;gt;&amp;lt;dcr:exclusive-session-scoped xmlns:dcr=&amp;quot;&lt;a href=&quot;http://www.day.com/jcr/webdav/1.0&quot;&gt;http://www.day.com/jcr/webdav/1.0&lt;/a&gt;&amp;quot;/&amp;gt;&amp;lt;/D:lockscope&amp;gt;&amp;lt;D:locktype&amp;gt;&amp;lt;D:write/&amp;gt;&amp;lt;/D:locktype&amp;gt;&amp;lt;D:owner&amp;gt;me&amp;lt;/D:owner&amp;gt;&amp;lt;/D:lockinfo&amp;gt;&lt;br/&gt;
&lt;br/&gt;
HTTP/1.1 200 OK&lt;br/&gt;
Content-Type: text/xml; charset=utf-8&lt;br/&gt;
Content-Length: 450&lt;br/&gt;
Lock-Token: &amp;lt;aa724c28-3c24-41e8-a3b4-9fc129adf732&amp;gt;&lt;br/&gt;
Server: Jetty(6.1.x)&lt;br/&gt;
&lt;br/&gt;
&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot; standalone=&amp;quot;no&amp;quot;?&amp;gt;&amp;lt;D:prop xmlns:D=&amp;quot;DAV:&amp;quot;&amp;gt;&amp;lt;D:lockdiscovery&amp;gt;&amp;lt;D:activelock&amp;gt;&amp;lt;D:lockscope&amp;gt;&amp;lt;dcr:exclusive-session-scoped xmlns:dcr=&amp;quot;&lt;a href=&quot;http://www.day.com/jcr/webdav/1.0&quot;&gt;http://www.day.com/jcr/webdav/1.0&lt;/a&gt;&amp;quot;/&amp;gt;&amp;lt;/D:lockscope&amp;gt;&amp;lt;D:locktype&amp;gt;&amp;lt;D:write/&amp;gt;&amp;lt;/D:locktype&amp;gt;&amp;lt;D:depth&amp;gt;0&amp;lt;/D:depth&amp;gt;&amp;lt;D:timeout&amp;gt;Second-2147483&amp;lt;/D:timeout&amp;gt;&amp;lt;D:owner&amp;gt;admin&amp;lt;/D:owner&amp;gt;&amp;lt;D:locktoken&amp;gt;&amp;lt;D:href&amp;gt;aa724c28-3c24-41e8-a3b4-9fc129adf732&amp;lt;/D:href&amp;gt;&amp;lt;/D:locktoken&amp;gt;&amp;lt;/D:activelock&amp;gt;&amp;lt;/D:lockdiscovery&amp;gt;&amp;lt;/D:prop&amp;gt;&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
by the way: if i do not explicitly logout before the program exits, the lock is also not released even though it is session based. should the session not trigger a logout on destruction?</description>
                <environment></environment>
            <key id="12538163">JCR-3205</key>
            <summary>Missing support for lock timeout and ownerHint in jcr-server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="anchela">angela</assignee>
                                <reporter username="dbu">David Buchmann</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jan 2012 08:23:09 +0000</created>
                <updated>Fri, 20 Jan 2012 14:34:02 +0000</updated>
                    <resolved>Thu, 12 Jan 2012 18:37:57 +0000</resolved>
                            <version>2.3.6</version>
                                <fixVersion>2.3.7</fixVersion>
                                <component>jackrabbit-jcr-server</component>
                <component>locks</component>
                        <due></due>
                    <votes>1</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13184813" author="dbu" created="Thu, 12 Jan 2012 08:24:05 +0000"  >full dump of the tcp communication between client and server for the sample code, done with wireshark and formatted a little bit for readability.</comment>
                    <comment id="13184842" author="reschke" created="Thu, 12 Jan 2012 09:38:20 +0000"  >The LOCK response indicates that the timeout value wasn&amp;#39;t used; will investigate...</comment>
                    <comment id="13185081" author="anchela" created="Thu, 12 Jan 2012 17:20:22 +0000"  >adjusted the component to jackrabbit-jcr-server. as far as i know the jsr 283 lock features&lt;br/&gt;
are implemented in jcr2spi and the various spi-implementations. however, they are missing&lt;br/&gt;
in the jcr-server (JcrActiveLock and DefaultItemCollection).&lt;br/&gt;
&lt;br/&gt;
will take a look at it.</comment>
                    <comment id="13185132" author="anchela" created="Thu, 12 Jan 2012 18:37:58 +0000"  >modified the DefaultItemCollection to use LockManager#lock instead of &lt;br/&gt;
Node#lock and adjusted the webdav active-lock object accordingly.&lt;br/&gt;
&lt;br/&gt;
since both features are defined to be optional by the jcr specification automated&lt;br/&gt;
testing would require quite some changes in the tck and the jcr2spi tests.&lt;br/&gt;
i did some quick verifications stepping into the OpenScopedLockTest and the&lt;br/&gt;
server was responding as expected with the fixes in place.&lt;br/&gt;
&lt;br/&gt;
david, thanks for reporting this issue.</comment>
                    <comment id="13187869" author="jukkaz" created="Tue, 17 Jan 2012 18:39:23 +0000"  >Merged to the 2.4 branch in revision 1232530.</comment>
                    <comment id="13189812" author="dbu" created="Fri, 20 Jan 2012 13:53:39 +0000"  >thanks, the timeout is now taken into account by the server and works fine!&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
what still confuses me is the reply by the server for infinite timeout (before and after this fix):&lt;br/&gt;
&lt;br/&gt;
&amp;lt;D:timeout&amp;gt;Second-2147483&amp;lt;/D:timeout&amp;gt;&lt;br/&gt;
&lt;br/&gt;
this number is&lt;br/&gt;
2^21+50331&lt;br/&gt;
&lt;br/&gt;
which seems pretty random to me. coincidally, this number is exactly 2^31 - 1  (2147483647) without the last 3 digits. can it be that there are some weird string operations happening on server side?</comment>
                    <comment id="13189822" author="reschke" created="Fri, 20 Jan 2012 14:22:37 +0000"  >Looks like a problem mapping Long.MAX_LONG to Infinite. Could you please open a separate ticket?</comment>
                </comments>
                    <attachments>
                    <attachment id="12510322" name="tcpdump.log" size="124194" author="dbu" created="Thu, 12 Jan 2012 08:24:05 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 12 Jan 2012 09:38:20 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>223670</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>250174</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>