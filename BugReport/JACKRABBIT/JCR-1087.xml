<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:46:18 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1087/JCR-1087.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1087] Maintain the cluster revision table</title>
                <link>https://issues.apache.org/jira/browse/JCR-1087</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>The revision table in which cluster nodes write their changes can potentially become very large. If all cluster nodes are up to date to a certain revision number, then it seems unnecessary to keep the revisions with a lower number.</description>
                <environment>A clustered Jackrabbit</environment>
            <key id="12376794">JCR-1087</key>
            <summary>Maintain the cluster revision table</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="martijnh">Martijn Hendriks</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Aug 2007 11:41:58 +0100</created>
                <updated>Thu, 2 May 2013 03:29:09 +0100</updated>
                    <resolved>Mon, 18 Feb 2008 12:28:12 +0000</resolved>
                                            <fixVersion>1.5</fixVersion>
                                <component>clustering</component>
                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12522469" author="martijnh" created="Fri, 24 Aug 2007 11:48:45 +0100"  >I&amp;#39;m linking this issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-905&quot; title=&quot;Clustering: race condition may cause duplicate entries in search index&quot;&gt;&lt;strike&gt;JCR-905&lt;/strike&gt;&lt;/a&gt; because the solution of that issue has an impact on whether or not all revisions should be kept.</comment>
                    <comment id="12535551" author="martijnh" created="Wed, 17 Oct 2007 14:39:35 +0100"  >When the cluster revision table becomes too large a cluster node without search index and local revision number cannot be started due to memory problems (see attached stacktrace).</comment>
                    <comment id="12536504" author="martijnh" created="Sun, 21 Oct 2007 14:06:27 +0100"  >The resolution of &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-905&quot; title=&quot;Clustering: race condition may cause duplicate entries in search index&quot;&gt;&lt;strike&gt;JCR-905&lt;/strike&gt;&lt;/a&gt; allows us to remove all unnecessary revision data. I.e., the minimum of all local revisions of the clusternodes gives an upperbound on the revisions that can safely be removed from the database.&lt;br/&gt;
&lt;br/&gt;
A solution for this issue would be to add a periodic task that removes all unnecessary revisions:&lt;br/&gt;
- All clusternodes should add their local revision to the database.&lt;br/&gt;
- Add a configuration option in the repository.xml to let one of the clusternodes execute the cleanup task (i.e., period and offset such as &amp;quot;every night at 00:00 hours&amp;quot;).</comment>
                    <comment id="12537940" author="martijnh" created="Fri, 26 Oct 2007 13:27:23 +0100"  >Attached is a patch for this issue. When a DatabaseJournal is used, the local revisions are also stored in the database instead of on the local file system. This information can then be used for periodic clean-ups of the JOURNAL table which may become very large. Note that this only works if all JR information except for the search index is stored in the database. The clean-up thread is disabled by default.&lt;br/&gt;
&lt;br/&gt;
Please comment. Thanks!</comment>
                    <comment id="12540178" author="dpfister" created="Mon, 5 Nov 2007 10:49:26 +0000"  >Hi Martijn,&lt;br/&gt;
&lt;br/&gt;
your patch looks good to me, so please go ahead and submit it. One nice thing that might be required for people already owning a database journal: is there a way to easily detect whether the LOCAL_REVISIONS table is missing and to tell the user to upgrade their schema?&lt;br/&gt;
&lt;br/&gt;
Cheers&lt;br/&gt;
Dominique</comment>
                    <comment id="12540994" author="martijnh" created="Thu, 8 Nov 2007 07:50:19 +0000"  >Hi Dominique,&lt;br/&gt;
&lt;br/&gt;
Good point! When this patch is applied to a Jackrabbit installation that already uses the clustering feature it will break if the LOCAL_REVISIONS table is not added manually. I&amp;#39;ll look into this.&lt;br/&gt;
&lt;br/&gt;
Martijn</comment>
                    <comment id="12565314" author="martijnh" created="Mon, 4 Feb 2008 12:05:20 +0000"  >Hi all,&lt;br/&gt;
&lt;br/&gt;
Unfortunately I&amp;#39;ve been inactive for a while but now i&amp;#39;ve more time to work on Jackrabbit  which is good :). I created a second patch for this issue which also addresses the upgrade scenario that Dominique mentioned:&lt;br/&gt;
- Added the LOCAL_REVISIONS table to the create scripts (*.ddl)&lt;br/&gt;
- Added InstanceRevision interface&lt;br/&gt;
- The InstanceRevision is now retrieved through the Journal instance&lt;br/&gt;
- Added logic to the DatabaseJournal to (i) migrate to a db based InstanceRevision,&lt;br/&gt;
&amp;nbsp;&amp;nbsp;and (ii) start a janitor thread for cleaning up old cluster revision entries&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ve tested the patch only on MSSQL, MySQL and Oracle, because I don&amp;#39;t have access to the other databases.&lt;br/&gt;
&lt;br/&gt;
I don&amp;#39;t really like the solution for the upgrade scenario (a ddl is scanned for the line that creates the LOCAL_REVISIONS table), but I like the alternative of having twice as many .ddl files even less. But maybe there&amp;#39;s a third way...?&lt;br/&gt;
&lt;br/&gt;
Best regards, Martijn</comment>
                    <comment id="12569875" author="martijnh" created="Mon, 18 Feb 2008 12:28:12 +0000"  >Committed in revision 628697.&lt;br/&gt;
&lt;br/&gt;
The instance revision on the local file system is automatically migrated to the database (to the LOCAL_REVISIONS) table. The clean-up thread is not started by default.&lt;br/&gt;
&lt;br/&gt;
Known caveats of the current solution:&lt;br/&gt;
- The user must make sure that all cluster nodes have written their local revision to the database before the clean-up thread runs for the first time because otherwise cluster nodes might miss updates (because they have been purged) and their local caches and search-indexes get out of sync.&lt;br/&gt;
- If a cluster node is removed permanently from the cluster, then its entry in the LOCAL_REVISIONS table should be removed manually. Otherwise, the clean-up thread will not be effective.&lt;br/&gt;
</comment>
                    <comment id="12770556" author="tmueller" created="Tue, 27 Oct 2009 16:34:14 +0000"  >I couldn&amp;#39;t find any documentation for this feature at: &lt;a href=&quot;http://wiki.apache.org/jackrabbit/Clustering&quot;&gt;http://wiki.apache.org/jackrabbit/Clustering&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
Is there any documentation? So far I only added a link to here (Removing Old Revisions)</comment>
                    <comment id="12770827" author="martijnh" created="Wed, 28 Oct 2009 08:29:34 +0000"  >I&amp;#39;m afraid there&amp;#39;s no documentation yet. I&amp;#39;ll try to add it soon.</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10001">
                <name>dependent</name>
                                <outwardlinks description="depends upon">
                            <issuelink>
            <issuekey id="12368914">JCR-905</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12367873" name="cluster-trace.txt" size="2263" author="martijnh" created="Wed, 17 Oct 2007 14:39:35 +0100" />
                    <attachment id="12368483" name="JCR-1087.patch" size="26655" author="martijnh" created="Fri, 26 Oct 2007 13:27:23 +0100" />
                    <attachment id="12374665" name="JCR-1087-v2.patch" size="37719" author="martijnh" created="Mon, 4 Feb 2008 12:05:20 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 5 Nov 2007 10:49:26 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>42976</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>279725</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>