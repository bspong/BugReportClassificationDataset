<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:43:41 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-989/JCR-989.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-989] Modify LazyQueryResultImpl to allow resultFetchSize to be set programmatically</title>
                <link>https://issues.apache.org/jira/browse/JCR-989</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>In our application we have a search which only shows part of a query result. We always know which part of the result needs to be shown. This means we know in advance how many results need to be fetched. I would like to be able to programmatically set resultFetchSize to minimize the number of loaded lucene docs and therefore improve the performance.&lt;br/&gt;
I know it is already possible to the set the resultFetchSize via the index configuration, but this number is fixed and doesn&amp;#39;t work well in environments where you use paging for your results because if you set this number too low the query will be executed multiple times and if you set it too high too many lucene docs are loaded.</description>
                <environment></environment>
            <key id="12372505">JCR-989</key>
            <summary>Modify LazyQueryResultImpl to allow resultFetchSize to be set programmatically</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="ckiehl">Christoph Kiehl</assignee>
                                <reporter username="ckiehl">Christoph Kiehl</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jun 2007 14:46:12 +0100</created>
                <updated>Tue, 15 Jan 2008 23:26:46 +0000</updated>
                    <resolved>Tue, 7 Aug 2007 23:44:24 +0100</resolved>
                                            <fixVersion>1.4</fixVersion>
                                <component>jackrabbit-core</component>
                <component>query</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12508551" author="ckiehl" created="Wed, 27 Jun 2007 15:03:18 +0100"  >This patch modifies LazyQueryResultImpl to provide a setter-method for resultFetchSize. I also fixed the class which is used for the Logger and optimized LazyScoreNodeIterator.skip() to only fetch more results if necessary.</comment>
                    <comment id="12508867" author="ckiehl" created="Thu, 28 Jun 2007 17:37:41 +0100"  >This patch modifies the previous patch to fix a small bug which caused LazyQueryResultImpl.getResults(int) to be called on each successive call to LazyQueryResultImpl.getNodeIterator()</comment>
                    <comment id="12509104" author="mreutegg" created="Fri, 29 Jun 2007 14:16:18 +0100"  >Thank you for the patch.&lt;br/&gt;
&lt;br/&gt;
Wouldn&amp;#39;t it be more intuitive to set the resultFetchSize on the Query instance instead of the QueryResult? With your current patch one will call:&lt;br/&gt;
&lt;br/&gt;
QueryManager qm = ...&lt;br/&gt;
Query q = qm.createQuery(myQuery, Query.XPath);&lt;br/&gt;
QueryResult result = q.execute();&lt;br/&gt;
((LazyQueryResultImpl) result).setResultFetchSize(10);&lt;br/&gt;
NodeIterator nodes = result.getNodes();&lt;br/&gt;
...&lt;br/&gt;
&lt;br/&gt;
I think the following is more intuitive:&lt;br/&gt;
&lt;br/&gt;
QueryManager qm = ...&lt;br/&gt;
Query q = qm.createQuery(myQuery, Query.XPath);&lt;br/&gt;
((QueryImpl) query).setResultFetchSize(10);&lt;br/&gt;
QueryResult result = q.execute();&lt;br/&gt;
NodeIterator nodes = result.getNodes();&lt;br/&gt;
...</comment>
                    <comment id="12509106" author="ckiehl" created="Fri, 29 Jun 2007 14:24:21 +0100"  >QueryImpl is located in org.apache.jackrabbit.core.query and is not lucene specific but resultFetchSize is lucene specific. This is why I chose to provide the setResultFetchSize()-method on a lucene specific class. I think it would be better to have a QueryImpl.setMaxResultSize() instead which could be used by any search engine implementation. In the case of the lucene implementation we could guest resultFetchSize from maxResultSize. Or do you think we should provide a setResultFetchSize() method regardless of how the search engine is implemented?</comment>
                    <comment id="12509110" author="mreutegg" created="Fri, 29 Jun 2007 14:55:57 +0100"  >&amp;gt; QueryImpl is located in org.apache.jackrabbit.core.query and is not lucene specific.&lt;br/&gt;
&lt;br/&gt;
You are right. I forgot about that.&lt;br/&gt;
&lt;br/&gt;
How about a generic method like QueryImpl.setOption(String name, String value)?&lt;br/&gt;
&lt;br/&gt;
The method would then fill a map with the name/value pairs and pass the map to the implementation (lucene) specific query handler in method QueryHandler.createExecutableQuery(...)</comment>
                    <comment id="12509209" author="ckiehl" created="Fri, 29 Jun 2007 22:40:39 +0100"  >To be honest I don&amp;#39;t like this generic setOption() method. Methods like that tend to transport some configuration options that are not obvious to the user but I have to confess that ((LazyQueryResultImpl) result).setResultFetchSize(10) isn&amp;#39;t that obvious either ;)&lt;br/&gt;
&lt;br/&gt;
If we provide such a  setOption() method I would at least like to provide some constants like &lt;br/&gt;
&lt;br/&gt;
QueryImpl.setOption(LazyQueryResultImpl.RESULT_PREFETCH_SIZE, 123)&lt;br/&gt;
&lt;br/&gt;
which doesn&amp;#39;t really make things better. I think the main problem is that resultPrefetchSize is not only lucene specific but also specific to LazyQueryResultImpl.&lt;br/&gt;
&lt;br/&gt;
I just got another idea. What do you think of some Timer that checks LazyScoreNodeIterator for activeness and closes the reader if there hasn&amp;#39;t been any activity on the iterator for the last say 1 or 2 seconds? If the Iterator is used again the query can still be executed again and the current mechanism could be used. I think in most cases you iterate through the results quite quickly so the reader will only be closed when you are finished. This would eleminate the need to set resultPrefetchSize and would give better performance to most users without configuring anything while taking up a bit more resources.</comment>
                    <comment id="12510673" author="mreutegg" created="Fri, 6 Jul 2007 13:46:50 +0100"  >I completely agree with you that both our suggestions are quite ugly ;)&lt;br/&gt;
&lt;br/&gt;
Here&amp;#39;s another idea, we could already anticipate what JSR 283 will most probably specify on the Query interface. See: &lt;a href=&quot;https://jsr-283.dev.java.net/issues/show_bug.cgi?id=214&quot;&gt;https://jsr-283.dev.java.net/issues/show_bug.cgi?id=214&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
Would that work for you?</comment>
                    <comment id="12510752" author="ckiehl" created="Fri, 6 Jul 2007 18:50:12 +0100"  >+1&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ll try to provide a patch the next days.</comment>
                    <comment id="12517680" author="ckiehl" created="Sat, 4 Aug 2007 02:18:26 +0100"  >I finally made it. Took me a bit more than a few days however ;)&lt;br/&gt;
&lt;br/&gt;
I decided to create a new interface JackrabbitQuery in jackrabbit-api which includes the two methods setOffset() and setLimit() which will probably be part of JCR 2.0. This way you don&amp;#39;t have to cast your Query instance to QueryImpl but rather JackrabbitQuery. This hopefully makes it more accessible to users and looks less like a hack. &lt;br/&gt;
&lt;br/&gt;
((QueryImpl) query).setLimit(123)&lt;br/&gt;
&lt;br/&gt;
vs&lt;br/&gt;
&lt;br/&gt;
((JackrabbitQuery) query).setLimit(123)&lt;br/&gt;
&lt;br/&gt;
This opens the possibility to provide an RMI implementation to support those two methods over RMI as well.&lt;br/&gt;
&lt;br/&gt;
Everything else was quite straight forward. There are two patches: one for jackrabbit-api containing the interface and one for jackrabbit-core containing the actual code changes. WDYT?</comment>
                    <comment id="12517698" author="fmeschbe" created="Sat, 4 Aug 2007 12:35:26 +0100"  >+1&lt;br/&gt;
&lt;br/&gt;
I like the addition to jackrabbit-api. Any other solution would prevent usefullness in environments where access to jackrabbit-core is not possible, such as in a web application running in a different class loader than the repository.</comment>
                    <comment id="12518273" author="ckiehl" created="Tue, 7 Aug 2007 23:44:24 +0100"  >committed in revision 563688</comment>
                    <comment id="12518354" author="jukkaz" created="Wed, 8 Aug 2007 08:03:17 +0100"  >Nice work!&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m not 100% sure if we should place JCR 2.0 extensions in jackrabbit-api, after all they are still subject to change and it might well be that the interfaces will change before JCR 2.0 is final. Putting the extensions in jackrabbit-api implies that we are ready to offer backwards compatibility to these new methods even if JCR 2.0 decides to drop them or implement them in some other way. More on dev@ in a  moment...</comment>
                    <comment id="12519617" author="mreutegg" created="Tue, 14 Aug 2007 09:09:02 +0100"  >I&amp;#39;d like to second Jukkas&amp;#39; opinion. We should not introduce new methods in the jackrabbit API for enhancements we expect to be available in JCR 2.0.</comment>
                    <comment id="12519626" author="ckiehl" created="Tue, 14 Aug 2007 09:31:19 +0100"  >Okay. What to do now? Based on the discussion on the dev list (&lt;a href=&quot;http://www.nabble.com/JCR-2.0-extensions-tf4235046.html#a12049594&quot;&gt;http://www.nabble.com/JCR-2.0-extensions-tf4235046.html#a12049594&lt;/a&gt;) it seems like everyone agrees that we should start to make the jsr283 api available in Jackrabbit (e.g. in the org.apache.jackrabbit.jsr283 package). Should I remove the JackrabbitQuery interface? But I think we should the push the effort make the jsr283 api availble.</comment>
                    <comment id="12519668" author="mreutegg" created="Tue, 14 Aug 2007 14:07:15 +0100"  >For the time being I suggest we remove the JackrabbitQuery interface and require a client to cast to the implementation class QueryImpl. When we introduce the jsr283 component we can still change introduce the interface again or even wait until the official jcr-2.0.jar is available.</comment>
                </comments>
                    <attachments>
                    <attachment id="12363157" name="jackrabbit-api.patch" size="987" author="ckiehl" created="Sat, 4 Aug 2007 02:18:26 +0100" />
                    <attachment id="12363158" name="jackrabbit-core.patch" size="11541" author="ckiehl" created="Sat, 4 Aug 2007 02:18:26 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 29 Jun 2007 13:16:18 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>142469</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>279638</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>