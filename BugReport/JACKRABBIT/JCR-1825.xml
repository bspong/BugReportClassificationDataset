<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:30:57 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1825/JCR-1825.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1825] DBDataStore doesn&apos;t support concurrent reads</title>
                <link>https://issues.apache.org/jira/browse/JCR-1825</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>My understanding is that setting parameter copyWhenReading to true should allow concurrent reads by spooling binary property to temporary file and free database resources (connection) immediately to make it available for other threads.&lt;br/&gt;
&lt;br/&gt;
After applying patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-1388&quot; title=&quot;Jackrabbit does not allow concurrent reads to the data store if copyWhenReading=false&quot;&gt;&lt;strike&gt;JCR-1388&lt;/strike&gt;&lt;/a&gt;, DBDataStore doesn&amp;#39;t support concurrent reads anymore, resultSet is kept open and db connection is blocked until the stream is read and closed. When copyWhenReading is set to true db connection should be released immediately, this is the reason i guess why temporary file is used.</description>
                <environment></environment>
            <key id="12406914">JCR-1825</key>
            <summary>DBDataStore doesn&apos;t support concurrent reads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="ppakulski">Przemo Pakulski</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Oct 2008 11:08:51 +0100</created>
                <updated>Mon, 8 Dec 2008 11:09:43 +0000</updated>
                    <resolved>Tue, 28 Oct 2008 15:44:04 +0000</resolved>
                            <version>1.5</version>
                                <fixVersion>1.5</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12641336" author="ppakulski" created="Tue, 21 Oct 2008 11:23:59 +0100"  >Without setting copyWhenReading  to true usage of DBDataStore is dangerous, could be a bottleneck depending how long streams are kept open.&lt;br/&gt;
If streams are not closed DBDataStore hangs/locks.</comment>
                    <comment id="12641343" author="ppakulski" created="Tue, 21 Oct 2008 11:42:34 +0100"  >without doing major changes I suggest to change DBDataStore class as follow :&lt;br/&gt;
&lt;br/&gt;
Index: src/main/java/org/apache/jackrabbit/core/data/db/DbDataStore.java&lt;br/&gt;
===================================================================&lt;br/&gt;
--- src/main/java/org/apache/jackrabbit/core/data/db/DbDataStore.java	(revision 706573)&lt;br/&gt;
+++ src/main/java/org/apache/jackrabbit/core/data/db/DbDataStore.java	(working copy)&lt;br/&gt;
@@ -519,6 +519,9 @@&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (copyWhenReading) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;File temp = moveToTempFile(result);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;result = new TempFileInputStream(temp);&lt;br/&gt;
+                    DatabaseHelper.closeSilently(rs);&lt;br/&gt;
+                    putBack(conn);&lt;br/&gt;
+                    rs = null;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
and DbResources.java close method to do not free db resources twice :&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public void close() {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (!closed) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;closed = true;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (rs!=null) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;DatabaseHelper.closeSilently(rs);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;store.putBack(conn);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} catch (Exception e) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;log.info(&amp;quot;Closing DbResources: &amp;quot;, e);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
Is it ok ?</comment>
                    <comment id="12641362" author="tmueller" created="Tue, 21 Oct 2008 12:59:01 +0100"  >Hi,&lt;br/&gt;
&lt;br/&gt;
You are right, this part of the code doesn&amp;#39;t do any more what it&amp;#39;s supposed to do. There is another problem: it doesn&amp;#39;t work if the stream is null. Also some of the DbResources methods are not not used and should be removed.&lt;br/&gt;
&lt;br/&gt;
I am currently working on another patch, I will attach it in an hour or so to this bug.&lt;br/&gt;
&lt;br/&gt;
Thanks for finding this problem!&lt;br/&gt;
&lt;br/&gt;
Regards,&lt;br/&gt;
Thomas</comment>
                    <comment id="12641370" author="tmueller" created="Tue, 21 Oct 2008 14:00:12 +0100"  >Here is my first patch. I didn&amp;#39;t test it yet; I post it just so that others can have a look at it.</comment>
                    <comment id="12641372" author="ppakulski" created="Tue, 21 Oct 2008 14:12:56 +0100"  >Cannot see important 2 lines responsible for freeing resources in &amp;#39;copyWhenReading&amp;#39; block&lt;br/&gt;
&lt;br/&gt;
if (copyWhenReading) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;File temp = moveToTempFile(result);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;result = new TempFileInputStream(temp);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;+ DatabaseHelper.closeSilently(rs);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;+ putBack(conn); &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;dbResources = new DbResources(result);&lt;br/&gt;
}&lt;br/&gt;
&lt;br/&gt;
I do not follow changes in DbInputStream class, but I assume they are not so important.</comment>
                    <comment id="12641374" author="c_koell" created="Tue, 21 Oct 2008 14:23:42 +0100"  >i would also prefer to use the closeSilently Method from the DatabaseHelper instead of ConnectionRecoveryManager&lt;br/&gt;
so we can delete the Method in the ConnectionRecoveryManager</comment>
                    <comment id="12641394" author="tmueller" created="Tue, 21 Oct 2008 15:42:22 +0100"  >New patch (I still didn&amp;#39;t test it however).&lt;br/&gt;
&amp;#39;DbResources&amp;#39; should be renamed to &amp;#39;DbResource&amp;#39;, I will do that later.</comment>
                    <comment id="12643222" author="jukkaz" created="Tue, 28 Oct 2008 14:24:43 +0000"  >Instead of tweaking the copyWhenReading workaround (which disables one of the main benefits of the data store, i.e. the ability to access a binary property without intermediate copies being created), I&amp;#39;d simply remove the maxConnections limit from the connection pool.</comment>
                    <comment id="12643235" author="tmueller" created="Tue, 28 Oct 2008 15:44:04 +0000"  >Committed in revision 708598.</comment>
                </comments>
                    <attachments>
                    <attachment id="12392577" name="patch2.txt" size="8086" author="tmueller" created="Tue, 21 Oct 2008 15:42:22 +0100" />
                    <attachment id="12392571" name="patch.txt" size="5893" author="tmueller" created="Tue, 21 Oct 2008 14:00:12 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 21 Oct 2008 11:59:01 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78414</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>192355</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>