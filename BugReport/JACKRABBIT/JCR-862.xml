<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:53:55 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-862/JCR-862.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-862] unsynchronized access on &apos;itemCache&apos; map in ItemManager </title>
                <link>https://issues.apache.org/jira/browse/JCR-862</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>the access &amp;#39;itemCache&amp;#39; map in ItemManager is mostly synchronized by not via the ItemStateListener methods:&lt;br/&gt;
[...]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public void stateCreated(ItemState created) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ItemImpl item = retrieveItem(created.getId());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (item != null) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;item.stateCreated(created);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
[...]&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;private ItemImpl retrieveItem(ItemId id) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return (ItemImpl) itemCache.get(id);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
[...]&lt;br/&gt;
&lt;br/&gt;
this can result in a corruption of a map (eg subsequent accesses may result in a endless loop).</description>
                <environment></environment>
            <key id="12367932">JCR-862</key>
            <summary>unsynchronized access on &apos;itemCache&apos; map in ItemManager </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="stefan@jira">Stefan Guggisberg</assignee>
                                <reporter username="tripod">Tobias Bocanegra</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Apr 2007 14:29:02 +0100</created>
                <updated>Mon, 8 Oct 2007 11:47:22 +0100</updated>
                    <resolved>Tue, 8 May 2007 23:45:29 +0100</resolved>
                            <version>1.2.1</version>
                <version>1.2.2</version>
                <version>1.2.3</version>
                <version>1.3</version>
                <version>1.3.1</version>
                                <fixVersion>1.3.3</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12491980" author="stefan@jira" created="Thu, 26 Apr 2007 13:13:47 +0100"  >fixed in svn r532720</comment>
                    <comment id="12492069" author="tripod" created="Thu, 26 Apr 2007 17:52:41 +0100"  >there are still some potential unsynchronized accesses:&lt;br/&gt;
&lt;br/&gt;
- itemExists(Path) calls evictItem()&lt;br/&gt;
- itemExists(ItemId) calls evictItem()&lt;br/&gt;
- dispose() does a cache.clear()&lt;br/&gt;
- dump() accesses the cache as well</comment>
                    <comment id="12492288" author="stefan@jira" created="Fri, 27 Apr 2007 14:34:47 +0100"  >fixed in svn r533091</comment>
                    <comment id="12493609" author="mreutegg" created="Fri, 4 May 2007 09:18:58 +0100"  >The fix introduces a deadlock between a reader and a writer session. See attached stacktrace.</comment>
                    <comment id="12493610" author="mreutegg" created="Fri, 4 May 2007 09:21:38 +0100"  >The deadlock can be reproduced by running ConcurrentReadWriteTest.&lt;br/&gt;
&lt;br/&gt;
The reading session must not lock the ItemManager while it retrieves an ItemState.</comment>
                    <comment id="12493620" author="mreutegg" created="Fri, 4 May 2007 09:46:05 +0100"  >I suggest we use the Map itself as a monitor to synchronize access to the cache. The ItemManager instance (this) is already used as a monitor to synchronize access from multiple threads using the same session. I would rather get rid of those, but that&amp;#39;s a different story.</comment>
                    <comment id="12494010" author="stefan@jira" created="Mon, 7 May 2007 11:18:36 +0100"  >fixed by applying patch (svn r35830).&lt;br/&gt;
&lt;br/&gt;
thanks!</comment>
                    <comment id="12494219" author="tripod" created="Tue, 8 May 2007 10:10:02 +0100"  >This fix can cause deadlocks:&lt;br/&gt;
&lt;br/&gt;
Thread 1: getNode() -&amp;gt; lock itemmanager -&amp;gt; read lock on shared-ism&lt;br/&gt;
Thread 2: save() -&amp;gt; write lock on shared-ism -&amp;gt; update() -&amp;gt; notifies all localisms -&amp;gt; notifies all itemmanagers -&amp;gt; lock on itemmanager&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12494228" author="mreutegg" created="Tue, 8 May 2007 10:44:19 +0100"  >Are you sure, this is exactly what shouldn&amp;#39;t happen anymore because we moved the synchronization from the ItemManager instance to the cache map. E.g.:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;/**&lt;br/&gt;
@@ -622,11 +628,13 @@&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;*&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @param id id of the item to remove from the cache&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;*/&lt;br/&gt;
-    private synchronized void evictItem(ItemId id) {&lt;br/&gt;
+    private void evictItem(ItemId id) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (log.isDebugEnabled()) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;log.debug(&amp;quot;removing item &amp;quot; + id + &amp;quot; from cache&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
-        itemCache.remove(id);&lt;br/&gt;
+        synchronized (itemCache) {&lt;br/&gt;
+            itemCache.remove(id);&lt;br/&gt;
+        }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Do you have a thread dump that shows the deadlock?</comment>
                    <comment id="12494413" author="tripod" created="Tue, 8 May 2007 23:45:29 +0100"  >oops. you&amp;#39;re right. i didn&amp;#39;t see your fix.</comment>
                    <comment id="12529093" author="jukkaz" created="Thu, 20 Sep 2007 13:11:31 +0100"  >Merged to the 1.3 branch in revision 577711.</comment>
                    <comment id="12529166" author="jukkaz" created="Thu, 20 Sep 2007 18:43:55 +0100"  >Additional merges in revisions 577729 and 577831.</comment>
                </comments>
                    <attachments>
                    <attachment id="12356759" name="ItemManager.patch" size="3797" author="mreutegg" created="Fri, 4 May 2007 09:46:05 +0100" />
                    <attachment id="12356753" name="stacktrace.txt" size="5406" author="mreutegg" created="Fri, 4 May 2007 09:21:38 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 26 Apr 2007 12:13:47 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78744</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>190002</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>