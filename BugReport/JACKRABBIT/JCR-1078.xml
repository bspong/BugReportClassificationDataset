<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:46:30 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1078/JCR-1078.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1078] ChangeLog serialization causes cache inconsistencies</title>
                <link>https://issues.apache.org/jira/browse/JCR-1078</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>The ordering of actions is taken into account when a ChangeLog is built through session manipulations (see, for instance,  ChangeLog.deleted(ItemState state)). When it is serialized in ClusterNode.write(Record record, ChangeLog changeLog, EventStateCollection esc), however, this implicit ordering might be changed. As a consequence,  the deserialization in ClusterNode.consume(Record record) might produce a different ChangeLog with the effect that the local caches get out-of-sync with the persistent state of the repository.&lt;br/&gt;
&lt;br/&gt;
The issue should be reproducable as follows:&lt;br/&gt;
- Setup a clustered environment with two Jackrabbit instances, say A and B.&lt;br/&gt;
- On instance A add a property &amp;quot;P&amp;quot; with value &amp;quot;x&amp;quot; to some node and save the session.&lt;br/&gt;
- On instance B read property &amp;quot;P&amp;quot; -&amp;gt; it will have value &amp;quot;x&amp;quot;.&lt;br/&gt;
- On instance A delete property P and then add it again with value &amp;quot;y&amp;quot; and save the session.&lt;br/&gt;
- On instance B read property &amp;quot;P&amp;quot; -&amp;gt; it will still have value &amp;quot;x&amp;quot; after the cluster sync...</description>
                <environment>Clustered Jackrabbit 1.3</environment>
            <key id="12376680">JCR-1078</key>
            <summary>ChangeLog serialization causes cache inconsistencies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="dpfister">Dominique Pfister</assignee>
                                <reporter username="martijnh">Martijn Hendriks</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Aug 2007 09:00:00 +0100</created>
                <updated>Mon, 8 Oct 2007 11:47:25 +0100</updated>
                    <resolved>Thu, 23 Aug 2007 10:34:54 +0100</resolved>
                            <version>1.2.1</version>
                <version>1.2.2</version>
                <version>1.2.3</version>
                <version>1.3</version>
                <version>1.3.1</version>
                                <fixVersion>1.3.3</fixVersion>
                                <component>clustering</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12522058" author="tmueller" created="Thu, 23 Aug 2007 09:16:53 +0100"  >I can reproduce this problem</comment>
                    <comment id="12522061" author="martijnh" created="Thu, 23 Aug 2007 09:32:27 +0100"  >I think that the following holds for a ChangeLog:&lt;br/&gt;
&lt;br/&gt;
1) state \in addedStates =&amp;gt; no deleted(state) events after the added(state) event.&lt;br/&gt;
2) state \in modifiedStated =&amp;gt; no added(state) event and no deleted(state) event after the modified(state) event&lt;br/&gt;
3) state \in deletedStates =&amp;gt; no added(state) event earlier&lt;br/&gt;
&lt;br/&gt;
The serialization code should derive an ordering such that these properties hold.</comment>
                    <comment id="12522074" author="martijnh" created="Thu, 23 Aug 2007 10:16:57 +0100"  >Swapping the order of the serialization to:&lt;br/&gt;
1) serialize deletedStates&lt;br/&gt;
2) serialize modifiedStates&lt;br/&gt;
3) serialize addedStates&lt;br/&gt;
in ClusterNode.write(Record record, ChangeLog changeLog, EventStateCollection esc) should work. Here&amp;#39;s a patch for it. I tested it on the scenario from the description and it works there.</comment>
                    <comment id="12522076" author="dpfister" created="Thu, 23 Aug 2007 10:23:30 +0100"  >Good observation, Martijn. In fact, putting the states in the following order back into the ChangeLog on deserialization should do the trick:&lt;br/&gt;
&lt;br/&gt;
1) deleted (checks added and removed)&lt;br/&gt;
2) modified (checks added only)&lt;br/&gt;
3) added&lt;br/&gt;
</comment>
                    <comment id="12522079" author="dpfister" created="Thu, 23 Aug 2007 10:34:54 +0100"  >Wow, that was quick! When comparing my change to yours, the only difference found was the revision number on top. Applied the patch and verified that it solves the problem.&lt;br/&gt;
&lt;br/&gt;
Thanks for reporting and submitting a patch, great job!</comment>
                    <comment id="12522086" author="martijnh" created="Thu, 23 Aug 2007 11:03:15 +0100"  >You&amp;#39;re welcome. Thanks for responding so quickly on this issue!</comment>
                    <comment id="12529195" author="jukkaz" created="Thu, 20 Sep 2007 19:36:14 +0100"  >Merged to the 1.3 branch in revision 577858.</comment>
                </comments>
                    <attachments>
                    <attachment id="12364401" name="JCR-1078.patch" size="2172" author="martijnh" created="Thu, 23 Aug 2007 10:16:57 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 23 Aug 2007 08:16:53 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78674</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>252748</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>