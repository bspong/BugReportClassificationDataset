<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:42:32 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1605/JCR-1605.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1605] RepositoryLock does not work on NFS sometimes</title>
                <link>https://issues.apache.org/jira/browse/JCR-1605</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>The RepositoryLock mechanism currently used in Jackrabbit uses FileLock. This doesn&amp;#39;t work on some NFS file system. It looks like only NFS version 4 and newer supports locking. Older implementations may throw a IOException &amp;quot;No locks available&amp;quot;, which means the NFS does not support byte-range locking.&lt;br/&gt;
&lt;br/&gt;
I propose to add a second locking mechanism, and add a configuration option to use it. For example: &amp;lt;FileLocking class=&amp;quot;acme&amp;quot; /&amp;gt;. This second locking mechanism is a cooperative locking protocol that uses a background (watchdog) thread and only uses regular file operations.&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12396112">JCR-1605</key>
            <summary>RepositoryLock does not work on NFS sometimes</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="tmueller">Thomas Mueller</assignee>
                                <reporter username="tmueller">Thomas Mueller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 May 2008 16:38:34 +0100</created>
                <updated>Thu, 13 Aug 2009 16:03:39 +0100</updated>
                    <resolved>Mon, 16 Feb 2009 16:43:33 +0000</resolved>
                                            <fixVersion>1.6</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12597165" author="reschke" created="Thu, 15 May 2008 16:47:26 +0100"  >Does this need to be configurable? Wouldn&amp;#39;t it be sufficient to catch the Exception and then fall back to the new approach?&lt;br/&gt;
</comment>
                    <comment id="12597450" author="tmueller" created="Fri, 16 May 2008 13:41:31 +0100"  >&amp;gt; Does this need to be configurable? &lt;br/&gt;
&lt;br/&gt;
Yes, unless we only want to support the new mechanism.&lt;br/&gt;
&lt;br/&gt;
&amp;gt; Wouldn&amp;#39;t it be sufficient to catch the Exception and then fall back to the new approach?&lt;br/&gt;
&lt;br/&gt;
No. The file system may not always throw an exception. The message &amp;quot;No locks available&amp;quot; sounds like there is a number of locks, and if more locks are used this exception occurs. This would mean that sometimes the new algorithm is used and sometimes the old. This wouldn&amp;#39;t work correctly.&lt;br/&gt;
&lt;br/&gt;
The new mechanism I have in mind is a cooperative algorithm. This algorithm is already in use in the H2 database. It goes like this:&lt;br/&gt;
&lt;br/&gt;
*  When the lock file does not exist, it is created (using the atomic operation File.createNewFile). Then, the process waits a little bit (20ms) and checks the file again. If the file was changed during this time, the operation is aborted. This protects against a race condition when a process deletes the lock file just after one create it, and a third process creates the file again. It does not occur if there are only two writers.&lt;br/&gt;
&lt;br/&gt;
* If the file can be created, a random number is inserted. Afterwards, a watchdog thread is started that checks regularly (every second once by default) if the file was deleted or modified by another (challenger) thread / process. Whenever that occurs, the file is overwritten with the old data. The watchdog thread runs with high priority so that a change to the lock file does not get through undetected even if the system is very busy. However, the watchdog thread does use very little resources (CPU time), because it waits most of the time. Also, the watchdog only reads from the hard disk and does not write to it.&lt;br/&gt;
&lt;br/&gt;
* If the lock file exists, and it was modified in the 20 ms, the process waits for some time (up to 10 times). If it was still changed, an exception is thrown (&amp;quot;locked&amp;quot;). This is done to eliminate race conditions with many concurrent writers. Afterwards, the file is overwritten with a new version (challenge). After that, the thread waits for 2 seconds. If there is a watchdog thread protecting the file, he will overwrite the change and this process will fail to lock. However, if there is no watchdog thread, the lock file will still be as written by this thread. In this case, the file is deleted and atomically created again. The watchdog thread is started in this case and the file is locked. &lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12597907" author="alexander.klimetschek" created="Mon, 19 May 2008 10:59:39 +0100"  >&amp;gt; The message &amp;quot;No locks available&amp;quot; sounds like there is a number of locks, and if more locks are used this exception occurs.&lt;br/&gt;
&lt;br/&gt;
No, this error message meant that the file system does not provide the file locking feature at all. An NFS 2 or 3 was used which don&amp;#39;t have the feature at all. Only NFS 4 allows locking. But it&amp;#39;s not recommended to rely on it.&lt;br/&gt;
&lt;br/&gt;
Anyway, I would also be against an automatic mix of lock algorithms. For example, current file locking might work perfectly on the NFS server, since it accesses the local file system directly, which will most probably provide file locking. Another jackrabbit running as an NFS (2/3) client, accessing the same repository directory, would get an exception &amp;quot;No locks available&amp;quot;. If it would continue with another algorithm, it will not see the repository as locked and start it.</comment>
                    <comment id="12599299" author="tmueller" created="Fri, 23 May 2008 08:54:38 +0100"  >A configurable lock mechanism will also help support a &amp;#39;file system less&amp;#39; repository (where no files are stored at all). Use cases: database-based repository; in-memory repository (for example for testing)</comment>
                    <comment id="12672274" author="tmueller" created="Tue, 10 Feb 2009 14:29:03 +0000"  >Two weeks ago, we ran out of disk space on an NFS 4 system. After rebooting, we could not start the repository because NFS wrongly reported the .lock file is locked. We had to manually delete .lock file. </comment>
                    <comment id="12672618" author="tmueller" created="Wed, 11 Feb 2009 13:01:09 +0000"  >With this patch, the repository lock mechanism can be configured in the repository.xml.&lt;br/&gt;
&lt;br/&gt;
The repository-1.5.dtd is changed.&lt;br/&gt;
&lt;br/&gt;
Also included is a cooperative mechanism that doesn&amp;#39;t use file locking. Instead, it used a background thread (watchdog thread).&lt;br/&gt;
&lt;br/&gt;
If nobody disagrees, I will commit this patch in a few days.</comment>
                    <comment id="12672619" author="jukkaz" created="Wed, 11 Feb 2009 13:09:45 +0000"  >&amp;gt; The repository-1.5.dtd is changed.&lt;br/&gt;
&lt;br/&gt;
That would then need to be repository-1.6.dtd.</comment>
                    <comment id="12672633" author="tmueller" created="Wed, 11 Feb 2009 13:50:00 +0000"  >&amp;gt; That would then need to be repository-1.6.dtd. &lt;br/&gt;
&lt;br/&gt;
Sorry... sure, I will create a new file repository-1.6.dtd. repository-1.5.dtd will not change.</comment>
                    <comment id="12673930" author="tmueller" created="Mon, 16 Feb 2009 16:43:33 +0000"  >Committed in revision 744956 (including the new repository-1.6.dtd)</comment>
                    <comment id="12674593" author="tmueller" created="Wed, 18 Feb 2009 12:45:31 +0000"  >Committed in revision 745500 (repository-1.6.dtd changes)</comment>
                    <comment id="12694421" author="jukkaz" created="Wed, 1 Apr 2009 09:25:02 +0100"  >Classifying this as a new feature.</comment>
                </comments>
                    <attachments>
                    <attachment id="12400015" name="repositoryLockMechanism.patch" size="27244" author="tmueller" created="Wed, 11 Feb 2009 13:01:09 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 15 May 2008 15:47:26 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>142764</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>231756</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>