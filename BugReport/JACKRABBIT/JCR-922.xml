<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:54:22 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-922/JCR-922.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-922] jcr mapping layer (OCM) should expose lock owner</title>
                <link>https://issues.apache.org/jira/browse/JCR-922</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>jcr mapping layer &amp;#39;s  persistencemanager.java  does not expose an API for returning lockowner. Ideally   , the following method &lt;br/&gt;
&lt;br/&gt;
public String lock(final String absPath, final boolean isDeep, final boolean isSessionScoped) &lt;br/&gt;
&lt;br/&gt;
should return a hashmap/String array containing locktoken as well as lockowner. &lt;br/&gt;
&lt;br/&gt;
I tried having lockowner as a field in my java object and mapping it to jcr:lockOwner , so that I can just use getLockOwner() . But the problem is this property gets introduced in the node only if  the node is locked. So, when I try to insert a node , before I can even lock it , the insertion fails since there is no property like jcr:lockOwner   till then . &lt;br/&gt;
&lt;br/&gt;
So, I feel there is need for the above API. It is ok to have it exposed via separate call in order to maintain backward compatability&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12369361">JCR-922</key>
            <summary>jcr mapping layer (OCM) should expose lock owner</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="clombart">Christophe Lombart</assignee>
                                <reporter username="ruchi">ruchi goel</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 May 2007 09:32:15 +0100</created>
                <updated>Tue, 15 Jan 2008 23:26:39 +0000</updated>
                    <resolved>Thu, 28 Jun 2007 20:34:14 +0100</resolved>
                                            <fixVersion>1.4</fixVersion>
                                <component>jackrabbit-ocm</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12495901" author="clombart" created="Tue, 15 May 2007 10:00:30 +0100"  >Just 2 comments : &lt;br/&gt;
&lt;br/&gt;
1/ Concerning the method lock, it should be better to return an object instead of an hashmap. This object could be similar to the Lock object defined in the JCR spec but this is tedious to create a wrapper class for this kind of JCR object. We have exaclty the same kind of issues with the versionning support. &lt;br/&gt;
&lt;br/&gt;
2/ Supporting the mix:lockable node type :  I understand your issue. The ocm framework has to have a better secondary node type support in term of field definition. I think we have to list the different use cases before taking a decision. &lt;br/&gt;
</comment>
                    <comment id="12495964" author="ruchi" created="Tue, 15 May 2007 12:35:12 +0100"  >I have a use case to implement where I am locking the checked out nodes and unlocking them after checkin. The latter half cannot be implemented without this feature. So, what is the best and quickest way to resolve this ?</comment>
                    <comment id="12495992" author="clombart" created="Tue, 15 May 2007 14:36:34 +0100"  >For the the first issue (see my previous comment) : it is quite easy to implement it with a class instead of an hashmap.&lt;br/&gt;
For second one, I have no solution until now. Let me think about that but I cannot work on it now. Any kind of proposal is welcome. </comment>
                    <comment id="12496202" author="ruchi" created="Wed, 16 May 2007 07:09:21 +0100"  >If we go by your first comment ,We need the following :&lt;br/&gt;
1. Wrapper class for Lock.&lt;br/&gt;
2. The method lock() should return object  of the wrapper class which can be used by caller to obtain lockowner. &lt;br/&gt;
&lt;br/&gt;
Does it not break backward compatability ? I mean the same method now returning a different object type ? Is that acceptable ?</comment>
                    <comment id="12498148" author="clombart" created="Wed, 23 May 2007 09:26:03 +0100"  >For the second problem, maybe 3 possibilities : &lt;br/&gt;
&lt;br/&gt;
1/ Don&amp;#39;t add the Lock info (lockowner, ...)  in the pojo. This solution requires a new  method in the persistence managers (eg. PersistenceManager.getLock(path)).  This method returns the Wrapper Lock object.  &lt;br/&gt;
&lt;br/&gt;
2/ JCR mixin node types can be added and removed at any time. That&amp;#39;s the case for the mix:lockable. Each field-descriptor, bean-descriptor and collection-descriptor element can have a  new attribute which specify the associated mixin node type reference. If the mixin node type is not yet assigned to the node, the mapping can be ignored for that attribute. &lt;br/&gt;
&lt;br/&gt;
&amp;lt;class-descriptor className=&amp;quot;....&amp;quot; &amp;gt;&lt;br/&gt;
	&amp;lt;field-descriptor fieldName=&amp;quot;path&amp;quot; path=&amp;quot;true&amp;quot; /&amp;gt;&lt;br/&gt;
	&amp;lt;field-descriptor fieldName=&amp;quot;title&amp;quot; jcrName=&amp;quot;graffito:title&amp;quot;/&amp;gt;&lt;br/&gt;
	&amp;lt;field-descriptor fieldName=&amp;quot;lockOwner&amp;quot; jcrName=&amp;quot;jcr:lockOwner&amp;quot;   mixintype=&amp;quot;mix:lockable/&amp;gt;&lt;br/&gt;
&amp;lt;/class-descriptor&amp;gt;&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&lt;br/&gt;
3/ Add a collection or a map in the pojo which will contain all available mixin type properties. It should be possible to create a new collection converter specific to mixin type property management. &lt;br/&gt;
&lt;br/&gt;
In your specific case the first solution is interesting. What is the interest to add lock info in the data value object ? &lt;br/&gt;
Other solutions are more interesting for a generic support of mixin node types. I will create a new JIRA issue for this kind of support. &lt;br/&gt;
&lt;br/&gt;
What do you think about that ? Maybe another solution ? </comment>
                    <comment id="12498172" author="ruchi" created="Wed, 23 May 2007 10:43:13 +0100"  >Answering your question &lt;br/&gt;
&amp;lt;What is the interest to add lock info in the data value object ? &amp;gt;&lt;br/&gt;
&lt;br/&gt;
I am designing the checkin/checkout in the following way:&lt;br/&gt;
&lt;br/&gt;
User A checks out node X.&lt;br/&gt;
User A locks node X. &lt;br/&gt;
&lt;br/&gt;
User B cannot update node X since it is locked by User A. &lt;br/&gt;
User B can read the node X. &lt;br/&gt;
&lt;br/&gt;
User A  unlocks node X&lt;br/&gt;
User A checks in the node X. &lt;br/&gt;
&lt;br/&gt;
User B checks out node X &lt;br/&gt;
User B locks node X. &lt;br/&gt;
&lt;br/&gt;
Basically, a mutually exclusive lock for a checked  out node. &lt;br/&gt;
&lt;br/&gt;
In my pojo , I have the following method  which allows checkin only if the lockowner is the one who is trying to checkin&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;public void checkin(String path)throws CMSException {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pm = getPersistenceManager();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try{&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if ((pm.isLocked(path))){&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;String lockOwner = getLockOwner(); //get lockowner          &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (lockOwner.equals(session.getUserID())){&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;String lockToken = doc.getLockToken();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pm.checkin(path);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pm.unlock(path,lockToken); //this call is already adding lock token in the session if that lock token is not present.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}                            &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}catch(Exception e){&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throw new CMSException(e.getMessage(),e.getCause());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
May be in the above method , I can try  checkin() without checking for the node state (locked or unlocked), since now you have the check of checking in by the lockowner , already incorporated in CheckIfNodeIsLocked . This might just work . &lt;br/&gt;
In  case lockowner is checking in , this succeeds  else throws exception.&lt;br/&gt;
&lt;br/&gt;
For a better  understanding , see the following code for checkout.&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;public void checkout(String path)throws CMSException {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pm = getPersistenceManager();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try{&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pm.checkout(path);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (!(pm.isLocked(path))){&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;String lockToken = pm.lock(path,true,false);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Document doc = this.getDocument(path);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;doc.setToken(lockToken);     //currently using property checkedOutBy for persisting lockToken, can be changed later &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;doc.save();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}catch(LockedException le){&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;Error: &amp;quot; + le.getLockedNodePath() + &amp;quot; is locked by &amp;quot; + le.getLockOwner());  &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}catch(Exception e){&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throw new CMSException(e.getMessage(),e.getCause());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12501390" author="clombart" created="Mon, 4 Jun 2007 23:04:05 +0100"  >Can you check the code ? &lt;br/&gt;
I made the following modifications : &lt;br/&gt;
1/ Review the method lock. Now, it returns a Lock object. &lt;br/&gt;
2/ I added new unit tests. See the class PersistenceManagerLockTest. the test called &amp;quot;testLockWithNodeType&amp;quot; uses an object containing the attribute lockowner. This attribute is null when the object is not locked and not null when it is locked. &lt;br/&gt;
&lt;br/&gt;
Let me know if it match to your needs. Feel free to comment this issue. &lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12501584" author="ruchi" created="Tue, 5 Jun 2007 16:08:34 +0100"  >This looks good. I think this meets all requirements. But I am not still able to build the new jcr-mapping jar . Still getting the same errors. &lt;br/&gt;
&lt;br/&gt;
Can you please comment on my last mail  with subject :&lt;br/&gt;
&lt;br/&gt;
error compiling jcr-mapping in Jackrabbit source tree</comment>
                    <comment id="12505444" author="clombart" created="Sat, 16 Jun 2007 09:13:16 +0100"  >Ruchi, &lt;br/&gt;
&lt;br/&gt;
Can you tell me if it is ok for you ?&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m still thinking on a better mix node type support but I think the mix:lockable is well supported and the persistence method now returns a lock object. &lt;br/&gt;
&lt;br/&gt;
Thanks</comment>
                </comments>
                    <attachments>
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>0.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 15 May 2007 09:00:30 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>142430</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>190595</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>