<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 06:02:11 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1092/JCR-1092.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1092] Bundle persistence managers node id key store/load is not symertric on MySql causing NoSuchItemState Exceptions </title>
                <link>https://issues.apache.org/jira/browse/JCR-1092</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>It looks like the binary values read back from MySql where the UUID contains 0&amp;#39;s is not the same as that generated from the UUID getRawBytes() call. As result, you can store a node with the UUID that has 0&amp;#39;s but its never found when read back. This therefore causes corruption in random places when certain UUIDs are generated.&lt;br/&gt;
&lt;br/&gt;
Test Case: &lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ve attached 2 files. One causes node corruption when imported, the other does not.&lt;br/&gt;
The only difference is that I removed any 0 values from the problem UUID in the file that causes corruption.&lt;br/&gt;
&lt;br/&gt;
As Stefan pointed out, I had manipulated the test case to use standard nt types when in fact I should have provided the following info (sorry Stefan) e.g. the test folder types are referencable hence the jcr:uuid allocation&lt;br/&gt;
&lt;br/&gt;
[acme:Folder] &amp;gt; nt:folder, mix:referenceable&lt;br/&gt;
&lt;br/&gt;
If I import causes_corruption.xml and then attempt to &amp;quot;ls&amp;quot; AclObjectIdentities then loadBundle() returns null for the UUID &lt;br/&gt;
&lt;br/&gt;
a55f3f6b-a909-4e8d-b65a-93002ced0920 which in bytes is [-91, 95, 63, 107, -87, 9, 78, -115, -74, 90, -109, 0, 44, -19, 9, 32]&lt;br/&gt;
&lt;br/&gt;
If I import works.xml then &amp;quot;ls&amp;quot; works fine for the same node as I&amp;#39;ve manually changed the UUID to replace 0s with 1s in the last section.&lt;br/&gt;
&lt;br/&gt;
a55f3f6b-a909-4e8d-b65a-93112ced1921 [-91, 95, 63, 107, -87, 9, 78, -115, -74, 90, -109, 17, 44, -19, 25, 33]&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Testing shows this issue highlights a problem with the Bundle persistence manager and MySqls method of handling BINARY columns.&lt;br/&gt;
The solution looks to be to replace BINARY(16) with VARBINARY(16). Quoting from &lt;a href=&quot;http://dev.mysql.com/doc/refman/5.0/en/binary-varbinary.html&quot;&gt;http://dev.mysql.com/doc/refman/5.0/en/binary-varbinary.html&lt;/a&gt;...&lt;br/&gt;
&amp;quot;If the value retrieved must be the same as the value specified for storage with no padding, it might be preferable to use VARBINARY or one of the BLOB data types instead.&amp;quot;&lt;br/&gt;
A review of our logs shows that all of the corruption we&amp;#39;ve seen has related to nodes with UUIDs including 0&amp;#39;s.&lt;br/&gt;
&lt;br/&gt;
* Shall I log a JIRA ticket for this?&lt;br/&gt;
* Anyone see any issues with this fix?&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
In the following example you can see I&amp;#39;m showing all bundles in the &amp;quot;test1&amp;quot; workspace.&lt;br/&gt;
&lt;br/&gt;
mysql&amp;gt; select hex(node_id) from test1_bundle;&lt;br/&gt;
+----------------------------------+&lt;br/&gt;
| hex(node_id)                     |&lt;br/&gt;
+----------------------------------+&lt;br/&gt;
| 28126C3E36A0471D9CDC5AC423BAC9C5 |&lt;br/&gt;
| A55F3F6BA9094E8DB65A93002CED0920 |&lt;br/&gt;
| CAFEBABECAFEBABECAFEBABECAFEBABE |&lt;br/&gt;
| D638EACCDEB641FD8868804C8ECEFFFD |&lt;br/&gt;
| DEADBEEFCAFEBABECAFEBABECAFEBABE |&lt;br/&gt;
+----------------------------------+&lt;br/&gt;
5 rows in set (0.00 sec)&lt;br/&gt;
&lt;br/&gt;
...but a select using the same UUID hex value returns no rows.&lt;br/&gt;
&lt;br/&gt;
mysql&amp;gt;  select node_id from test1_bundle where &lt;br/&gt;
mysql&amp;gt; unhex(&amp;#39;A55F3F6BA9094E8DB65A93002CED0920&amp;#39;) = node_id;&lt;br/&gt;
Empty set (0.00 sec)&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ve then created a new &amp;quot;test3&amp;quot; workspace which I modified to use varbinary instead of binary with:&lt;br/&gt;
&lt;br/&gt;
alter table test3_bundle modify NODE_ID varbinary(16); alter table test3_refs modify NODE_ID varbinary(16);&lt;br/&gt;
&lt;br/&gt;
My import test case now no longer fails and the following query proves that query operations, after a store, return rows as expected.&lt;br/&gt;
&lt;br/&gt;
mysql&amp;gt;  select node_id from test3_bundle where &lt;br/&gt;
mysql&amp;gt; unhex(&amp;#39;A55F3F6BA9094E8DB65A93002CED0920&amp;#39;) = node_id;&lt;br/&gt;
+------------------+&lt;br/&gt;
| node_id          |&lt;br/&gt;
+--------&amp;#xB6;Z ,&amp;#xED;--  |&lt;br/&gt;
+------------------+&lt;br/&gt;
1 row in set (0.00 sec)&lt;br/&gt;
&lt;br/&gt;
mysql&amp;gt; desc test3_bundle;&lt;br/&gt;
ERROR 2006 (HY000): MySQL server has gone away No connection. Trying to reconnect...&lt;br/&gt;
Connection id:    7116&lt;br/&gt;
Current database: mmptest&lt;br/&gt;
&lt;br/&gt;
+-------------+---------------+------+-----+---------+-------+&lt;br/&gt;
| Field       | Type          | Null | Key | Default | Extra |&lt;br/&gt;
+-------------+---------------+------+-----+---------+-------+&lt;br/&gt;
| NODE_ID     | varbinary(16) | YES  | UNI | NULL    |       |&lt;br/&gt;
| BUNDLE_DATA | longblob      | NO   |     |         |       |&lt;br/&gt;
+-------------+---------------+------+-----+---------+-------+&lt;br/&gt;
2 rows in set (0.00 sec)&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
mysql&amp;gt;  alter table test3_bundle modify NODE_ID varbinary(16);&lt;br/&gt;
Query OK, 2 rows affected (0.00 sec)&lt;br/&gt;
Records: 2  Duplicates: 0  Warnings: 0&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment>Mysql 5.0.45 / mysql-connector-java-5.0.6-bin.jar / Sun JDK 1.5 / Redhat Enterprise Linux  4</environment>
            <key id="12376946">JCR-1092</key>
            <summary>Bundle persistence managers node id key store/load is not symertric on MySql causing NoSuchItemState Exceptions </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="sbarriba">Shaun Barriball</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Aug 2007 18:59:51 +0100</created>
                <updated>Mon, 8 Oct 2007 11:47:26 +0100</updated>
                    <resolved>Wed, 29 Aug 2007 17:29:40 +0100</resolved>
                            <version>1.3</version>
                <version>1.3.1</version>
                                <fixVersion>1.3.3</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12523071" author="sbarriba" created="Mon, 27 Aug 2007 19:02:25 +0100"  >The candidate fix is to move from binary(16) to varbinary(16) within jackrabbit-core\src\main\java\org\apache\jackrabbit\core\persistence\bundle\mysql.ddl.</comment>
                    <comment id="12523620" author="stefan@jira" created="Wed, 29 Aug 2007 17:04:46 +0100"  >changed summary since the issue is not specific to mysql 5.</comment>
                    <comment id="12523622" author="stefan@jira" created="Wed, 29 Aug 2007 17:22:50 +0100"  >i was able to reproduce the issue on mysql 4.1 (windows) and mysql 5.0 (redhat) using connector/j 5.0 and connector/j 3.0.&lt;br/&gt;
&lt;br/&gt;
on mysql 4.1 i was able to reproduce the issue using just the mysql console:&lt;br/&gt;
&lt;br/&gt;
create table t1 (id int, data binary(4));&lt;br/&gt;
insert into t1 select 1, unhex(&amp;quot;61626320&amp;quot;);&lt;br/&gt;
&lt;br/&gt;
select bit_length(data) from t1;&lt;br/&gt;
=&amp;gt; 24 (instead of 32)&lt;br/&gt;
&lt;br/&gt;
select * from t1 where data = unhex(&amp;quot;61626320&amp;quot;);&lt;br/&gt;
=&amp;gt; 0 hits&lt;br/&gt;
&lt;br/&gt;
select * from t1 where data = unhex(&amp;quot;616263&amp;quot;);&lt;br/&gt;
=&amp;gt; 1 hit&lt;br/&gt;
&lt;br/&gt;
mysql 4 uses 0x20 (space) for padding. the trailing 0x20 in the value stored is mistaken for a padding. &lt;br/&gt;
&lt;br/&gt;
mysql 5 uses 0x00 for padding. however, storing values with trailing 0x20 (space) bytes through jdbc cause the same problem. i guess that in this case the jdbc driver is to be blamed.&lt;br/&gt;
&lt;br/&gt;
i agree with shaun that changing from binary(16) to varbinary(16) is the best solution.</comment>
                    <comment id="12523624" author="stefan@jira" created="Wed, 29 Aug 2007 17:29:40 +0100"  >fixed as suggested by shaun in svn rev. 570856&lt;br/&gt;
&lt;br/&gt;
shaun, thanks for your doggedness ;) and your excellent bug report!</comment>
                    <comment id="12529172" author="jukkaz" created="Thu, 20 Sep 2007 18:56:34 +0100"  >Merged to the 1.3 branch in revision 577839.</comment>
                </comments>
                    <attachments>
                    <attachment id="12364627" name="causes_corruption.xml" size="1643" author="sbarriba" created="Mon, 27 Aug 2007 19:01:00 +0100" />
                    <attachment id="12364628" name="works.xml" size="1645" author="sbarriba" created="Mon, 27 Aug 2007 19:01:14 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 29 Aug 2007 16:04:46 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78666</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>192713</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>