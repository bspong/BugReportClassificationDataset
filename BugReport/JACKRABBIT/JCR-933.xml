<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 06:00:58 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-933/JCR-933.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-933] RepositoryImpl.acquireRepositoryLock() fails to detect that the file lock is already held by the current process</title>
                <link>https://issues.apache.org/jira/browse/JCR-933</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>with java 1.4 and 1.5 on a *nix-based platform it is possible to (concurrently) instantiate &lt;br/&gt;
more than one repository instance in the same jvm based on same/identical configurations.&lt;br/&gt;
&lt;br/&gt;
this is a critical issue since it might lead to data corruption.&lt;br/&gt;
&lt;br/&gt;
the issue only exists with java versions prior to 1.6 and *nix-based platforms (only verified&lt;br/&gt;
on mac os-x 10.4).&lt;br/&gt;
&lt;br/&gt;
note that the issue does not exist when the file lock is held by another jvm.&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;code snippet to reproduce the issue:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Repository rep1 = new TransientRepository();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Session s1 = rep1.login(new SimpleCredentials(&amp;quot;johndoe&amp;quot;, &amp;quot;&amp;quot;.toCharArray()));&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Repository rep2 = new TransientRepository();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Session s2 = rep2.login(new SimpleCredentials(&amp;quot;johndoe&amp;quot;, &amp;quot;&amp;quot;.toCharArray()));&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
the root problem is the incorrect behavior of java.nio.channels.FileChannel#tryLock()&lt;br/&gt;
which is demonstrated by the following code snippet:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;FileLock fl1 = new FileOutputStream(&amp;quot;foo&amp;quot;).getChannel().tryLock();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;1st lock: &amp;quot; + fl1);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;FileLock fl2 = new FileOutputStream(&amp;quot;foo&amp;quot;).getChannel().tryLock();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;System.out.println(&amp;quot;2nd lock: &amp;quot; + fl2);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} catch (Throwable t) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;t.printStackTrace();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment>java 1.4 &amp;amp; 1.5 on *nix-based platforms.&lt;br/&gt;
&lt;br/&gt;
(verfied with java 1.4 on mac os-x 10.4.9) </environment>
            <key id="12369690">JCR-933</key>
            <summary>RepositoryImpl.acquireRepositoryLock() fails to detect that the file lock is already held by the current process</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="stefan@jira">Stefan Guggisberg</assignee>
                                <reporter username="stefan@jira">Stefan Guggisberg</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 May 2007 16:50:52 +0100</created>
                <updated>Mon, 6 Aug 2007 07:45:58 +0100</updated>
                    <resolved>Fri, 25 May 2007 14:52:52 +0100</resolved>
                            <version>1.1</version>
                <version>1.1.1</version>
                <version>1.2.1</version>
                <version>1.2.2</version>
                <version>1.2.3</version>
                <version>1.3</version>
                                <fixVersion>1.3.1</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12498184" author="stefan@jira" created="Wed, 23 May 2007 12:00:27 +0100"  >attached patch with suggested fix:&lt;br/&gt;
&lt;br/&gt;
the canonicalized path of the repository home dir is stored&lt;br/&gt;
in a system property and checked on repository instance&lt;br/&gt;
startup. the only caveat of this approach is that system property&lt;br/&gt;
access is subject to security manager check, i.e. &lt;br/&gt;
if a security manager is installed jackrabbit needs to be&lt;br/&gt;
granted system property write access.&lt;br/&gt;
&lt;br/&gt;
comments welcome.&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12498459" author="jukkaz" created="Thu, 24 May 2007 03:43:58 +0100"  >Clever! Using a synchronized interned system property feels icky, but it actually achieves the required functionality.&lt;br/&gt;
&lt;br/&gt;
The repository lock mechanism has accumulated a lot of collective knowledge and already contains &amp;gt; 50 LOC, so I guess it would make sense to refactor it into a separate helper class. Especially given the already large size of the RepositoryImpl class. The attached patch (RepositoryLock.patch) contains Stefan&amp;#39;s suggested fix and refactors all the repository lock code into a separate o.a.j.core.util.RepositoryLock class. I also added a bunch of javadocs and tests.&lt;br/&gt;
&lt;br/&gt;
The RepositoryLock class should be mostly equivalent to the current code + Stefan&amp;#39;s fix. I made the following functional changes to streamline the code:&lt;br/&gt;
&lt;br/&gt;
* Removed the extra call to File.createNewFile() since creating the RandomAccessFile instance with mode &amp;quot;rw&amp;quot; will automatically create the file&lt;br/&gt;
* Canonicalized the path names once at the beginning&lt;br/&gt;
* Renamed and reorganized variables to make the code appear more like a generic directory locking tool</comment>
                    <comment id="12499084" author="stefan@jira" created="Fri, 25 May 2007 14:52:52 +0100"  >fixed in svn r541651 by applying jukka&amp;#39;s patch </comment>
                    <comment id="12501383" author="jukkaz" created="Mon, 4 Jun 2007 22:49:53 +0100"  >Merged to the 1.3 branch in revision 544288.</comment>
                </comments>
                    <attachments>
                    <attachment id="12357972" name="jcr-933.patch" size="2803" author="stefan@jira" created="Wed, 23 May 2007 12:00:24 +0100" />
                    <attachment id="12358054" name="RepositoryLock.patch" size="18679" author="jukkaz" created="Thu, 24 May 2007 03:43:58 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 24 May 2007 02:43:58 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78722</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189836</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>