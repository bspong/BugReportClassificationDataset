<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 06:02:59 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1645/JCR-1645.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1645] Add support for Map of referenced beans</title>
                <link>https://issues.apache.org/jira/browse/JCR-1645</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>OCM should support the mapping of maps of referenced beans.&lt;br/&gt;
&lt;br/&gt;
@Collection(collectionConverter= BeanReferenceCollectionConverterImpl.class)&lt;br/&gt;
private java.util.Map&amp;lt;String, ReferencedBean&amp;gt; aMap;&lt;br/&gt;
&lt;br/&gt;
BeanReferenceCollectionConverterImpl (mainly the method doGetCollection) needs to be updated to support the interface ManageableMap interface.&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12397811">JCR-1645</key>
            <summary>Add support for Map of referenced beans</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="clombart">Christophe Lombart</assignee>
                                <reporter username="vgiguere">Vincent Gigu&#232;re</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Jun 2008 16:05:56 +0100</created>
                <updated>Mon, 8 Dec 2008 11:09:39 +0000</updated>
                    <resolved>Mon, 22 Sep 2008 20:30:00 +0100</resolved>
                                            <fixVersion>1.5</fixVersion>
                                <component>jackrabbit-ocm</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12604024" author="vgiguere" created="Tue, 10 Jun 2008 21:29:59 +0100"  >Hi, &lt;br/&gt;
&lt;br/&gt;
I have coded a new class called: BeanReferenceMapConverterImpl which allows for the conversion of java.util.Map of beans stored as references.&lt;br/&gt;
&lt;br/&gt;
It pretty much works the same way as the converter for collections of references with the following distinction:&lt;br/&gt;
&lt;br/&gt;
Since the key to the map can NOT be stored on the referenced node (because it is potentially referenced multiple time), &lt;br/&gt;
The key needs to be part of the relation stored on the collection node.&lt;br/&gt;
&lt;br/&gt;
I chose the following approach: &lt;br/&gt;
I encode both the key and the uuid of the referenced bean in a Value of PropertyType (PropertyType.REFERENCE)&lt;br/&gt;
When reloading nodes, both the uuid and the keys are decoded and the map is reconstituted in the ManageableMapImpl.&lt;br/&gt;
&lt;br/&gt;
I do not have credentials to submit code, so, I will attach it to this issue.&lt;br/&gt;
&lt;br/&gt;
There is a unit test that validates the following: &lt;br/&gt;
- Map of referenced nodes are persisted and reloaded properly&lt;br/&gt;
- Map can persist and restore same node reference under various keys&lt;br/&gt;
- Multiple nodes can reference the same reference node with different keys&lt;br/&gt;
- Converter removes deleted nodes when updating&lt;br/&gt;
- Converter adds new nodes wen updating&lt;br/&gt;
- Converter can simultaneously remove and add new references&lt;br/&gt;
&lt;br/&gt;
IMPORTANT:&lt;br/&gt;
For the unit test to work, you need to modify the test model : &lt;br/&gt;
&lt;br/&gt;
org.apache.jackrabbit.ocm.testmodel.collection.Main must now have: &lt;br/&gt;
&lt;br/&gt;
@Collection(collectionConverter = BeanReferenceMapConverterImpl.class)&lt;br/&gt;
private Map&amp;lt;String, A&amp;gt; referenceMap = new HashMap&amp;lt;String, A&amp;gt;();&lt;br/&gt;
with getter and setter...&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
NOTE: Make sure that you import org.apache.jackrabbit.ocm.testmodel.uuid.A (not the other A that does not contain a uuid)&lt;br/&gt;
&lt;br/&gt;
Regards,&lt;br/&gt;
&lt;br/&gt;
Vincent Gigu&amp;#xE8;re</comment>
                    <comment id="12604025" author="vgiguere" created="Tue, 10 Jun 2008 21:31:25 +0100"  >Unit test for the BeanReferenceMapConverterImpl class</comment>
                    <comment id="12604026" author="vgiguere" created="Tue, 10 Jun 2008 21:31:56 +0100"  >Unit test for the MapReferenceValueEncoder</comment>
                    <comment id="12604027" author="vgiguere" created="Tue, 10 Jun 2008 21:32:39 +0100"  >Mapper for Maps of References</comment>
                    <comment id="12604028" author="vgiguere" created="Tue, 10 Jun 2008 21:33:09 +0100"  >Map key - uuid encoder...</comment>
                    <comment id="12633054" author="clombart" created="Sun, 21 Sep 2008 09:26:39 +0100"  >I am working now on this issue but I got small compile errors. I will fix them.&lt;br/&gt;
It should be nice to send us a patch instead of new or modified java classes. By this way, we can add new features quickly.  Thanks &lt;br/&gt;
</comment>
                    <comment id="12633442" author="clombart" created="Mon, 22 Sep 2008 20:30:00 +0100"  >The patch has been applied. The unit tests are working. I modified  the test content class &amp;quot;Main&amp;quot; otherwise it doesn&amp;#39;t compile.&lt;br/&gt;
Let me know if something is wrong. Thanks </comment>
                    <comment id="12633745" author="vgiguere" created="Tue, 23 Sep 2008 15:24:27 +0100"  >Hi, &lt;br/&gt;
&lt;br/&gt;
Everything seems to be fine.&lt;br/&gt;
&lt;br/&gt;
However, I was wondering if you would have a better idea on how to implement the BeanReferenceMapConverter. I find that my solution is a bit of a hack.&lt;br/&gt;
&lt;br/&gt;
When persisting a map of reference, we must save the key in the map and the UUID of the referenced node. But, since there are no implementation of javax.jcr.Value that offer the possibility to store 2 strings (the key and the UUID), I was left with encoding the 2 inside a String:&lt;br/&gt;
&lt;br/&gt;
value=&amp;quot;MAPKEY:*keyInTheMapMAPVALUE:adjklq3e-rcq45f-4g3579-4fsd-345fsd&amp;quot;&lt;br/&gt;
&lt;br/&gt;
Is there a better way of storing 2 strings as a value in the node?&lt;br/&gt;
If no, are you comfortable with this approach?&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12633751" author="clombart" created="Tue, 23 Sep 2008 15:40:54 +0100"  >I&amp;#39;m agree with you but I don&amp;#39;t see another solution based on a multi value property. &lt;br/&gt;
Another solution is to use  subnodes instead of a multivalue prop. Those subnodes can match to each element in the map. in each subnode, we can have a prop for the key (or use the subnode name)  and another property for the reference value&lt;br/&gt;
&lt;br/&gt;
It is also a bit of hack due to the fact that is not possible to store a map of prop in a JCR node. &lt;br/&gt;
</comment>
                </comments>
                    <attachments>
                    <attachment id="12383782" name="BeanReferenceMapConverterImpl.java" size="9352" author="vgiguere" created="Tue, 10 Jun 2008 21:32:39 +0100" />
                    <attachment id="12383780" name="BeanReferenceMapConverterImplTest.java" size="18405" author="vgiguere" created="Tue, 10 Jun 2008 21:31:25 +0100" />
                    <attachment id="12383783" name="MapReferenceValueEncoder.java" size="908" author="vgiguere" created="Tue, 10 Jun 2008 21:33:09 +0100" />
                    <attachment id="12383781" name="MapReferenceValueEncoderTest.java" size="1358" author="vgiguere" created="Tue, 10 Jun 2008 21:31:56 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 21 Sep 2008 08:26:39 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>142781</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>190737</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>