<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:55:06 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1440/JCR-1440.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1440] NPE Thrown when two Cluster Nodes are hitting the same underlying database.</title>
                <link>https://issues.apache.org/jira/browse/JCR-1440</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>I&amp;#39;ve created a test that creates two repositories with clustering enabled that are backed by the same database.  Using the following workflow causes a NullPointerException to be thrown.&lt;br/&gt;
&lt;br/&gt;
The workflow I&amp;#39;m using is:&lt;br/&gt;
The root node is versioned.&lt;br/&gt;
ClusterNode1 creates a versioned child node named &amp;quot;foo&amp;quot;.&lt;br/&gt;
The test waits to make sure the syncDelay has passed so ClusterNode2 will notice the newly created node.&lt;br/&gt;
ClusterNode2 retrieves the &amp;quot;foo&amp;quot; child node and removes it.&lt;br/&gt;
The test waits for the change ClusterNode1 to sync with that change.&lt;br/&gt;
ClusterNode1 tries to create another new node however a NullPointerException is thrown when the it tries to checkout the rootNode.&lt;br/&gt;
&lt;br/&gt;
java.lang.NullPointerException: null values not allowed&lt;br/&gt;
	at org.apache.commons.collections.map.AbstractReferenceMap.put(AbstractReferenceMap.java:251)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.VersionManagerImpl.getItem(VersionManagerImpl.java:280)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.XAVersionManager.getItem(XAVersionManager.java:334)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.AbstractVersionManager.getVersion(AbstractVersionManager.java:87)&lt;br/&gt;
	at org.apache.jackrabbit.core.NodeImpl.getBaseVersion(NodeImpl.java:3198)&lt;br/&gt;
	at org.apache.jackrabbit.core.NodeImpl.checkout(NodeImpl.java:2991)&lt;br/&gt;
	at com.cerner.system.configuration.repository.jcr.SimpleJackrabbitConflictTest.testNullPointerExceptionThrown(SimpleJackrabbitConflictTest.java:96)</description>
                <environment>Vista JDK 1.5.0_12.  Using Derby and Derby Client 10.1.2.1</environment>
            <key id="12389880">JCR-1440</key>
            <summary>NPE Thrown when two Cluster Nodes are hitting the same underlying database.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="jukkaz">Jukka Zitting</assignee>
                                <reporter username="mkwhitacre">Micah Whitacre</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Feb 2008 14:47:22 +0000</created>
                <updated>Fri, 23 Sep 2011 15:22:59 +0100</updated>
                    <resolved>Fri, 24 Sep 2010 15:42:57 +0100</resolved>
                            <version>1.4</version>
                <version>core 1.4.1</version>
                                <fixVersion>2.2</fixVersion>
                                <component>clustering</component>
                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>6</votes>
                        <watches>4</watches>
                                                    <comments>
                    <comment id="12573769" author="mkwhitacre" created="Fri, 29 Feb 2008 14:48:36 +0000"  >The test I used to create this exception and the two repository configuration files I used to configure the two nodes.</comment>
                    <comment id="12575280" author="dpfister" created="Wed, 5 Mar 2008 09:24:02 +0000"  >Clustering in jackrabbit requires persistence managers that connect to a shared datasource. I noticed that the persistence managers in your repository.xml use the embedded Derby JDBC driver, which will not work in a clustered setup. Did you try switching to Derby in standalone mode?</comment>
                    <comment id="12575431" author="mkwhitacre" created="Wed, 5 Mar 2008 17:46:20 +0000"  >I changed PMs and the Clustering to use the org.apache.derby.jdbc.Driver30 and I still get the same exception.&lt;br/&gt;
&lt;br/&gt;
You mentioned that the PMs needed to use a shared datasource.  What additional configuration is needed for me to be able to do that?  Do I need to configure a DataSource[1] at the top of the &amp;lt;Repository&amp;gt; configuration?  I&amp;#39;ve been using the Clustering[2] wiki page as my guide and it doesn&amp;#39;t show any special configuration for using the OraclePersistenceManager.  I&amp;#39;m actually seeing this issue when hitting an Oracle database.  I just used an embedded derby database for this example/tests.  &lt;br/&gt;
&lt;br/&gt;
[1] - &lt;a href=&quot;http://wiki.apache.org/jackrabbit/DataStore&quot;&gt;http://wiki.apache.org/jackrabbit/DataStore&lt;/a&gt;&lt;br/&gt;
[2] - &lt;a href=&quot;http://wiki.apache.org/jackrabbit/Clustering&quot;&gt;http://wiki.apache.org/jackrabbit/Clustering&lt;/a&gt;</comment>
                    <comment id="12577990" author="mkwhitacre" created="Wed, 12 Mar 2008 19:32:10 +0000"  >I&amp;#39;ve played around with my configuration a bit more and am still not able to get rid of the NPE.  In this attachment I modified the repository1.xml file to use the bundle.PersistenceManager and configured a DbDataStore.  For the testing purposes repository2.xml is an exact duplicate of the attachment (with a different cluster id).&lt;br/&gt;
&lt;br/&gt;
This change in configuration does not fix the NPE.  This still seems like an Jackrabbit issue instead of an error in my configuration.  </comment>
                    <comment id="12578003" author="mkwhitacre" created="Wed, 12 Mar 2008 19:59:51 +0000"  >I have been playing around with the test a bit and have found that if I don&amp;#39;t wait for the clusters to synchronize after deleting the node &amp;quot;foo&amp;quot; that I will get the following stack trace when trying to check out the root node of he first session again.&lt;br/&gt;
&lt;br/&gt;
Not completely related to this bug but thought I&amp;#39;d post what I was finding.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
javax.jcr.InvalidItemStateException: cafebabe-cafe-babe-cafe-babecafebabe/{&lt;a href=&quot;http://www.jcp.org/jcr/1.0&quot;&gt;http://www.jcp.org/jcr/1.0&lt;/a&gt;}isCheckedOut has been modified externally&lt;br/&gt;
	at org.apache.jackrabbit.core.ItemImpl.save(ItemImpl.java:1248)&lt;br/&gt;
	at org.apache.jackrabbit.core.SessionImpl.save(SessionImpl.java:896)&lt;br/&gt;
	at org.apache.jackrabbit.core.NodeImpl.checkout(NodeImpl.java:3001)&lt;br/&gt;
	at com.cerner.system.configuration.repository.jcr.SimpleJackrabbitConflictTest.testNullPointerExceptionThrown(SimpleJackrabbitConflictTest.java:99)&lt;br/&gt;
	</comment>
                    <comment id="12582054" author="mkwhitacre" created="Tue, 25 Mar 2008 20:48:58 +0000"  >I&amp;#39;m still trying to find a workaround or solution to this issue.  Looking at the code the issues comes from the fact that the map, versionItems, of VersionManagerImpl class is never updated/syncrhonized between the two cluster nodes.  The only time this method is changed is on calls to itemsUpdated(Collection) which is never called during the synchronization process.  So that map becomes stale pretty quickly when multiple nodes are interacting with it.</comment>
                    <comment id="12582058" author="mkwhitacre" created="Tue, 25 Mar 2008 21:10:31 +0000"  >It should also be noted that this is not purely related to removing nodes.  I&amp;#39;ve changed the test around so the two nodes are adding independent child nodes to the root and it causes the same NPE exception to be thrown when trying to find the item at the item for the given id.</comment>
                    <comment id="12585176" author="rbrush" created="Thu, 3 Apr 2008 17:40:50 +0100"  >I ran into this issue in a similar situation.  Debugging in jackrabbit-core-1.4.2, I found that the InternalVersionHistoryImpl contains caches that were not aware of this update made by another node in the cluster.  It&amp;#39;s not clear to me how these caches are (or should be) synchronized, but I was able to work around the problem by adding the following logic to InternalVersionHistoryImpl#getVersion(NodeId):&lt;br/&gt;
&lt;br/&gt;
* Run the existing logic to find the version in cache. &lt;br/&gt;
* If the cached version is found, return it.&lt;br/&gt;
* If it is not found, invoke InternalVersionHistoryImpl#reload() to ensure newer changes to the repository are visible to the cache&lt;br/&gt;
* Attempt to get the item from cache again now that we&amp;#39;ve loaded the latest state&lt;br/&gt;
&lt;br/&gt;
I don&amp;#39;t know if this is an appropriate fix, or if there is some other workaround we might use.  However, this might shed some light on what is happening here.  I imagine the reload() operation can be expensive, but it shouldn&amp;#39;t be called during a normal flow.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m also trying to better understand the threading model in Jackrabbit to ensure this mutation doesn&amp;#39;t cause any race condition.&lt;br/&gt;
</comment>
                    <comment id="12598468" author="mkwhitacre" created="Tue, 20 May 2008 22:09:58 +0100"  >Ryan&amp;#39;s patch fixes the issue I was seeing.  I agree it isn&amp;#39;t necessarily the most elegant solution.  Can someone review his patch and commit it to trunk or perhaps propose a better solution?  Thanks.</comment>
                    <comment id="12632268" author="mkwhitacre" created="Thu, 18 Sep 2008 17:05:13 +0100"  >While coding against the 1.5-SNAPSHOT I started seeing a different exception being logged[1].  The attachment includes the same test that was previously attached (but modified to run on linux) and it will reliably produce the stack trace.  The two repository.xml files were updated to support the newer security configuration needed as well.  I have not tried applying Ryan&amp;#39;s patch yet to see if it fixes this issue.&lt;br/&gt;
&lt;br/&gt;
Could someone look at/comment on the patch?  It would be nice if this fix could make it into an upcoming release like 1.4.6 but if not maybe the 1.5.  Thanks.&lt;br/&gt;
&lt;br/&gt;
[1]&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.jackrabbit.core.version.AbstractVersionManager.calculateCheckinVersionName(AbstractVersionManager.java:458)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.AbstractVersionManager.checkin(AbstractVersionManager.java:392)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.VersionManagerImpl$2.run(VersionManagerImpl.java:280)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.VersionManagerImpl$DynamicESCFactory.doSourced(VersionManagerImpl.java:563)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.VersionManagerImpl.checkin(VersionManagerImpl.java:276)&lt;br/&gt;
	at org.apache.jackrabbit.core.version.XAVersionManager.checkin(XAVersionManager.java:155)&lt;br/&gt;
	at org.apache.jackrabbit.core.NodeImpl.checkin(NodeImpl.java:3309)&lt;br/&gt;
	at com.cerner.system.configuration.repository.jcr.SimpleJackrabbitConflictTest.testNullPointerExceptionThrown(SimpleJackrabbitConflictTest.java:105)</comment>
                    <comment id="12632294" author="mkwhitacre" created="Thu, 18 Sep 2008 17:58:49 +0100"  >I applied Ryan&amp;#39;s patch to trunk and it fixed the NPE being thrown.</comment>
                    <comment id="12727557" author="mkwhitacre" created="Mon, 6 Jul 2009 15:53:12 +0100"  >What can someone do to help this issue be resolved?  A patch and junit have been supplied a long time ago.  What else is needed for this to be resolved for one of the official releases?</comment>
                    <comment id="12835807" author="jukkaz" created="Fri, 19 Feb 2010 16:35:57 +0000"  >I&amp;#39;m sorry about the long inaction on this issue.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;ve now committed Ryan&amp;#39;s patch, as it seems to solve the immediate issue. The solution however seems a bit hacky and reminds me of the double-checked locking antipattern. It would be better if the caches were loaded only on-demand and correctly invalidated on cluster changes. Or perhaps we could drop the version history caches entirely, as the underlying item state managers should already take care of the performance impact.</comment>
                    <comment id="12841903" author="jukkaz" created="Fri, 5 Mar 2010 16:04:55 +0000"  >In revision 919461 I added automatic invalidation of the internal version history caches based on related update events from other cluster nodes. This still needs some testing, but ideally I&amp;#39;d like to get rid of the previous double-load solution.</comment>
                    <comment id="12914489" author="jukkaz" created="Fri, 24 Sep 2010 15:42:57 +0100"  >Resolving as fixed as the reported problem no longer occurs. We can improve the design later on in followup issues.</comment>
                </comments>
                    <attachments>
                    <attachment id="12390387" name="jackrabbit-1.5-JCR-1440.tar.gz" size="2185" author="mkwhitacre" created="Thu, 18 Sep 2008 17:05:13 +0100" />
                    <attachment id="12379280" name="jcr-1440-workaround.patch" size="2087" author="rbrush" created="Thu, 3 Apr 2008 17:40:50 +0100" />
                    <attachment id="12377722" name="repository1.xml" size="3306" author="mkwhitacre" created="Wed, 12 Mar 2008 19:32:10 +0000" />
                    <attachment id="12377725" name="SimpleJackrabbitConflictTest.java" size="4478" author="mkwhitacre" created="Wed, 12 Mar 2008 19:59:51 +0000" />
                    <attachment id="12376831" name="SimpleJackRabbitTest.zip" size="2916" author="mkwhitacre" created="Fri, 29 Feb 2008 14:48:36 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 5 Mar 2008 09:24:02 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>59585</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>189974</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>