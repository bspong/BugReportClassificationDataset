<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:29:29 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-2378/JCR-2378.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-2378] Avoid exceptions thrown in finalize handler of RepositoryImpl constructor</title>
                <link>https://issues.apache.org/jira/browse/JCR-2378</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>If an exception happens during initialization of the repository, it might be overlayed by an exception thrown in the finalize handler of the RepositoryImpl constructor (see line 382 ff in [1]). The latter exception wins and the original exception is lost (if you don&amp;#39;t have a log). This makes it hard to figure out the real problem.&lt;br/&gt;
&lt;br/&gt;
This problem is actually a bit self-enforcing: if something goes wrong during startup, the code in the shutdown() method that is called is actually very prone to fail as it might not expect such a broken-startup state. In my case the overlaying NPE happened in ObservationManagerImpl.getRegisteredEventListeners, where this.dispatcher was unexpectedly null [2].&lt;br/&gt;
&lt;br/&gt;
I think both places should be fixed (NPE guard in ObservationManagerImpl constructor for &amp;quot;dispatcher&amp;quot;) and a try/catch block in the finalizer, just logging the exception:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} finally {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (!succeeded) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// repository startup failed, clean up...&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;shutdown();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} catch (Throwable t) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// shutdown() likely to fail now, as startup was broken...&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;log.error(&amp;quot;In addition to startup fail, another problem occurred while shutting down the repository again.&amp;quot;, e);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
[1] &lt;a href=&quot;http://svn.apache.org/viewvc/jackrabbit/trunk/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/RepositoryImpl.java?view=markup&quot;&gt;http://svn.apache.org/viewvc/jackrabbit/trunk/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/RepositoryImpl.java?view=markup&lt;/a&gt;&lt;br/&gt;
&lt;br/&gt;
[2] Overlaying exception&amp;#39;s stacktrace:&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.jackrabbit.core.observation.ObservationManagerImpl.getRegisteredEventListeners(ObservationManagerImpl.java:143)&lt;br/&gt;
	at org.apache.jackrabbit.core.SessionImpl.removeRegisteredEventListeners(SessionImpl.java:1190)&lt;br/&gt;
	at org.apache.jackrabbit.core.SessionImpl.logout(SessionImpl.java:1215)&lt;br/&gt;
	at org.apache.jackrabbit.core.RepositoryImpl$WorkspaceInfo.doDispose(RepositoryImpl.java:2153)&lt;br/&gt;
	at com.day.crx.core.CRXRepositoryImpl$CRXWorkspaceInfo.doDispose(CRXRepositoryImpl.java:1095)&lt;br/&gt;
	at org.apache.jackrabbit.core.RepositoryImpl$WorkspaceInfo.dispose(RepositoryImpl.java:2108)&lt;br/&gt;
	at org.apache.jackrabbit.core.RepositoryImpl.doShutdown(RepositoryImpl.java:1146)&lt;br/&gt;
	at com.day.crx.core.CRXRepositoryImpl.doShutdown(CRXRepositoryImpl.java:845)&lt;br/&gt;
	at org.apache.jackrabbit.core.RepositoryImpl.shutdown(RepositoryImpl.java:1098)&lt;br/&gt;
	at org.apache.jackrabbit.core.RepositoryImpl.&amp;lt;init&amp;gt;(RepositoryImpl.java:387)&lt;br/&gt;
	at com.day.crx.core.CRXRepositoryImpl.&amp;lt;init&amp;gt;(CRXRepositoryImpl.java:201)&lt;br/&gt;
	at com.day.crx.core.CRXRepositoryImpl.create(CRXRepositoryImpl.java:190)&lt;br/&gt;
	... 28 more&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12439665">JCR-2378</key>
            <summary>Avoid exceptions thrown in finalize handler of RepositoryImpl constructor</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="alexander.klimetschek">Alexander Klimetschek</assignee>
                                <reporter username="alexander.klimetschek">Alexander Klimetschek</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Nov 2009 14:25:49 +0000</created>
                <updated>Mon, 11 Jan 2010 14:16:28 +0000</updated>
                    <resolved>Mon, 2 Nov 2009 16:02:31 +0000</resolved>
                            <version>2.0-alpha11</version>
                                <fixVersion>2.0-beta3</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12772537" author="alexander.klimetschek" created="Mon, 2 Nov 2009 15:26:16 +0000"  >Patch that both fixes the NPE in ObservationManagerImpl (throws early now) and adds the try/catch to the finalizer.</comment>
                    <comment id="12772538" author="alexander.klimetschek" created="Mon, 2 Nov 2009 15:27:11 +0000"  >Patch available.</comment>
                    <comment id="12772539" author="jukkaz" created="Mon, 2 Nov 2009 15:34:36 +0000"  >+0 I would prefer to see a solution to the root cause (shutdown not working properly when repository startup fails) instead of a workaround, but until such a solution is available I think doing something like this is a good alternative.</comment>
                    <comment id="12772546" author="alexander.klimetschek" created="Mon, 2 Nov 2009 15:57:19 +0000"  >&amp;gt;  I would prefer to see a solution to the root cause&lt;br/&gt;
&lt;br/&gt;
Yes, but I think there is too much involved to capture all possible problems (easily). Therefore I think this is just good defensive programming. I&amp;#39;ll change the wording and add &amp;quot;unexpected&amp;quot; rather than &amp;quot;likely to fail&amp;quot;.&lt;br/&gt;
&lt;br/&gt;
Also created a separate issue for the NPE: &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2380&quot; title=&quot;NPE in ObservationManagerImpl.getRegisteredEventListeners() during shutdown after broken startup&quot;&gt;&lt;strike&gt;JCR-2380&lt;/strike&gt;&lt;/a&gt;</comment>
                    <comment id="12772547" author="alexander.klimetschek" created="Mon, 2 Nov 2009 16:02:31 +0000"  >Added the finalizer change in revision 831932.</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12439676">JCR-2380</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12423824" name="JCR-2378.patch" size="2409" author="alexander.klimetschek" created="Mon, 2 Nov 2009 15:26:16 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 2 Nov 2009 15:34:36 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>143130</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>280133</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>