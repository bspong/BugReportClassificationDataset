<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 06:02:25 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1821/JCR-1821.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1821] jcr2spi: Item.isSame may return wrong result if any ancestor is invalidated</title>
                <link>https://issues.apache.org/jira/browse/JCR-1821</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>julian detected an issue with jcr2spi that was previously shadowed due to heavy reloading of items upon save.&lt;br/&gt;
with the most recent changes however reloading of items is postponed until the next access. this will cause the following test to fail:&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Node n = testRootNode.addNode(&amp;quot;aFile&amp;quot;, &amp;quot;nt:file&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;n = n.addNode(&amp;quot;jcr:content&amp;quot;, &amp;quot;nt:resource&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;n.setProperty(&amp;quot;jcr:lastModified&amp;quot;, Calendar.getInstance());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;n.setProperty(&amp;quot;jcr:mimeType&amp;quot;, &amp;quot;text/plain&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Property jcrData = n.setProperty(&amp;quot;jcr:data&amp;quot;, &amp;quot;abc&amp;quot;, PropertyType.BINARY);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;testRootNode.save();&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// access same property through different session&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Session otherSession = helper.getReadOnlySession();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Property otherProperty = (Property) otherSession.getItem(jcrData.getPath());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;assertTrue(jcrData.isSame(otherProperty));&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;} finally {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;otherSession.logout();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;br/&gt;
&lt;br/&gt;
while &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;assertTrue(n.isSame(otherSession.getItem(n.getPath()));&lt;br/&gt;
&lt;br/&gt;
would be successful.&lt;br/&gt;
&lt;br/&gt;
the reason: the jcrData property is not reloaded and it&amp;#39;s parent is still _invalidated_. consequently the property isn&amp;#39;t aware of it&amp;#39;s id having changed due to the fact that nt:resource is a node type extending from mix:referenceable.&lt;br/&gt;
&lt;br/&gt;
possible fixes:&lt;br/&gt;
&lt;br/&gt;
1) mark all items _invalid_ after save &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;instead of setting status non-protected/autocreated properties to EXISTING.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;gt; forcing jcrData to be reloaded before isSame can be called.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;gt; drawback: much more round trip(s) to the server just to make sure the id is up to date.&lt;br/&gt;
&lt;br/&gt;
2) change Item#isSame to make sure the workspaceId is up to date (walking up the&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;hierarchy and force reloading of the first invalidated ancestor).&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;gt; drawback: if referenceable nodes are rare or missing at all, this causes some&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;extra round trips.&lt;br/&gt;
&amp;nbsp;&lt;br/&gt;
3) change Item.isSame to compare the &amp;#39;workspacePath&amp;#39; instead of the &amp;#39;workspaceId&amp;#39;.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;-&amp;gt; drawback: upon persisted move of a referenceable node Item#isSame will return false&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
after taking a closer look at the code and at some additional tests i would opt for 2).&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12406786">JCR-1821</key>
            <summary>jcr2spi: Item.isSame may return wrong result if any ancestor is invalidated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="anchela">angela</assignee>
                                <reporter username="anchela">angela</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Oct 2008 10:19:26 +0100</created>
                <updated>Mon, 8 Dec 2008 11:09:43 +0000</updated>
                    <resolved>Mon, 20 Oct 2008 14:17:06 +0100</resolved>
                                            <fixVersion>1.5</fixVersion>
                                <component>jackrabbit-jcr2spi</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12640957" author="reschke" created="Mon, 20 Oct 2008 10:34:35 +0100"  >For completeness (not sure whether this is possible and worth the effort):&lt;br/&gt;
&lt;br/&gt;
4) change RepositoryService.submit(batch) to return sufficient information so that JCR2SPI can update things like UUIDs and autocreated properties.&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12640964" author="anchela" created="Mon, 20 Oct 2008 10:49:53 +0100"  >from my point of view it would be worth evaluating 4) and check it&amp;#39;s feasibility but not as part of this issue since it affects the SPI interfaces and would cause additional changes in jcr2spi.</comment>
                    <comment id="12640971" author="reschke" created="Mon, 20 Oct 2008 11:12:49 +0100"  >Agreed. It&amp;#39;s a good idea to have a short-term fix, and then discuss extending the SPI design separately.&lt;br/&gt;
</comment>
                </comments>
                    <attachments>
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>0.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 20 Oct 2008 09:34:35 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78416</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>192363</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>