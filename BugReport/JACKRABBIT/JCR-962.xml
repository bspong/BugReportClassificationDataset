<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:35:39 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-962/JCR-962.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-962] Deadlocks in ConcurrentVersioningWithTransactionsTest</title>
                <link>https://issues.apache.org/jira/browse/JCR-962</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>Patch follows for a ConcurrentVersioningWithTransactionsTest, based on the existing ConcurrentVersioningTest but using transactions around the versioning operations.&lt;br/&gt;
&lt;br/&gt;
On my macbook, running the test with CONCURRENCY = 100 and NUM_OPERATIONS = 100 causes a deadlock after a few seconds, thread dumps follow.&lt;br/&gt;
&lt;br/&gt;
Note that I had to ignore StaleItemStateException (which is probably justified, due to not locking stuff IIUC) to let the threads run long enough to show the problem.&lt;br/&gt;
&lt;br/&gt;
Running the test a few times showed the same locking pattern several times: some threads are locked at line 87 (session.save(), no transaction) while others are at line 93 (transaction.commit()), in testConcurrentCheckinInTransaction():&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;80    public void testConcurrentCheckinInTransaction() throws RepositoryException {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;81      runTask(new Task() {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;82        public void execute(Session session, Node test) throws RepositoryException {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;83          int i = 0;&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;84          try {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;85            Node n = test.addNode(&amp;quot;test&amp;quot;);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;86            n.addMixin(mixVersionable);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;87            session.save();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;88            for (i = 0; i &amp;lt; NUM_OPERATIONS / CONCURRENCY; i++) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;89              final UserTransaction utx = new UserTransactionImpl(test.getSession());&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;90              utx.begin();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;91              n.checkout();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;92              n.checkin();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;93              utx.commit();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;94            }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;95            n.checkout();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;96          } catch (Exception e) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;97            final String threadName = Thread.currentThread().getName();&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;98            final Throwable deepCause = getLevel2Cause(e);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;99            if(deepCause!=null &amp;amp;&amp;amp; deepCause instanceof StaleItemStateException) {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;100              // ignore &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;101            } else {&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;102              throw new RepositoryException(threadName + &amp;quot;, i=&amp;quot; + i + &amp;quot;:&amp;quot; + e.getClass().getName(), e);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;103            }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;104          }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;105        }&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;106      }, CONCURRENCY);&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;107    }</description>
                <environment></environment>
            <key id="12370904">JCR-962</key>
            <summary>Deadlocks in ConcurrentVersioningWithTransactionsTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="bdelacretaz">Bertrand Delacretaz</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Jun 2007 11:19:54 +0100</created>
                <updated>Mon, 8 Oct 2007 11:47:23 +0100</updated>
                    <resolved>Fri, 29 Jun 2007 13:57:04 +0100</resolved>
                                            <fixVersion>1.3.3</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>1</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12501513" author="bdelacretaz" created="Tue, 5 Jun 2007 11:21:40 +0100"  >ConcurrentVersioningWithTransactionsTest patch, must be enabled in org.apache.jackrabbit.core.TestAll</comment>
                    <comment id="12501514" author="bdelacretaz" created="Tue, 5 Jun 2007 11:22:46 +0100"  >Deadlocked threads dump with 10 concurrent tasks</comment>
                    <comment id="12501515" author="bdelacretaz" created="Tue, 5 Jun 2007 11:23:45 +0100"  >Deadlocked threads dump with 100 concurrent tasks</comment>
                    <comment id="12502746" author="mreutegg" created="Fri, 8 Jun 2007 11:30:37 +0100"  >Attached the stacktraces of the two relevant threads from 10-threads-dump.txt, which are in a deadlocked state.</comment>
                    <comment id="12508104" author="mreutegg" created="Tue, 26 Jun 2007 09:20:08 +0100"  >Added Bertrands&amp;#39; test case and created a new test suite, which contains all long running tests related to multi-threading: MultiThreadingTests. The suite will not run with the regression test while building jackrabbit-core but can easily be started in an IDE.</comment>
                    <comment id="12508109" author="mreutegg" created="Tue, 26 Jun 2007 09:43:51 +0100"  >This patch replaces the internal XAResources on the XAWorkspace with two similar ones on the XAVersionManager. The idea is to lock the version manager early in the prepare phase and release the lock at the end of the transaction. When changes on the workspace are committed the version manager is already locked and stays locked until the version changes are committed.&lt;br/&gt;
&lt;br/&gt;
If there are no version items in the transaction the write lock on the version manager is not acquired to allow concurrency between multiple sessions operating on different workspaces.&lt;br/&gt;
&lt;br/&gt;
With this patch the sequence for locking workspace and version store is:&lt;br/&gt;
1) version store&lt;br/&gt;
2) workspace&lt;br/&gt;
&lt;br/&gt;
The rest of the jackrabbit core should be reviewed and changed accordingly.</comment>
                    <comment id="12509094" author="mreutegg" created="Fri, 29 Jun 2007 13:57:04 +0100"  >Assuming lazy consensus I committed the patch in revision: 551877</comment>
                    <comment id="12531734" author="jukkaz" created="Tue, 2 Oct 2007 11:01:50 +0100"  >Merged to the 1.3 branch in revision 581177.</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="28325">JCR-18</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12358941" name="100-threads-dump.txt" size="165618" author="bdelacretaz" created="Tue, 5 Jun 2007 11:23:45 +0100" />
                    <attachment id="12358940" name="10-threads-dump.txt" size="27876" author="bdelacretaz" created="Tue, 5 Jun 2007 11:22:45 +0100" />
                    <attachment id="12359267" name="deadlocked-threads.txt" size="6197" author="mreutegg" created="Fri, 8 Jun 2007 11:30:37 +0100" />
                    <attachment id="12358939" name="JCR-962-ConcurrentVersioningWithTransactionsTest.patch" size="7147" author="bdelacretaz" created="Tue, 5 Jun 2007 11:21:40 +0100" />
                    <attachment id="12360553" name="JCR-962-fix.patch" size="9792" author="mreutegg" created="Tue, 26 Jun 2007 09:43:51 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 8 Jun 2007 10:30:37 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>42036</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>190042</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>