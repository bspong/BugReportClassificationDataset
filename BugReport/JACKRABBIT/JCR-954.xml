<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:43:03 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-954/JCR-954.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-954] Allow to disable referential integrity checking for workspace</title>
                <link>https://issues.apache.org/jira/browse/JCR-954</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>Some operations like clone, remove operating on huge subtree of nodes requires a lot of memory. To copy, clone, remove subtree all nodes are loaded into transient spaces. It allows such operations to be transactional, from other side it requires a lot of heap size and this memory size is directly dependent on the size of subtree (number of nodes). In result of this in some cases it is impossible to make such operations in one step. In our environment sometimes 1 GB of java heap is not enough to succesfully clone subtree  from one workspace to another.&lt;br/&gt;
&lt;br/&gt;
You can always clone (copy, remove) tree in chunks, but if you have references between subtrees such approach fails. Possibilty of temporary disabling referential integrity checking for experienced JCR user could be very usefull then.&lt;br/&gt;
&lt;br/&gt;
Another use case is to allow to clone selected subtrees of the whole structure between worskpaces. In our application we need to clone only some selected subtrees from one workspace to another. But we can not do that because of existing references. We need to clone the whol estructure first, then remove all unwanted nodes, which is really time expensive and memory consuming.&lt;br/&gt;
</description>
                <environment></environment>
            <key id="12370557">JCR-954</key>
            <summary>Allow to disable referential integrity checking for workspace</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="jukkaz">Jukka Zitting</assignee>
                                <reporter username="ppakulski">Przemo Pakulski</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 May 2007 21:36:22 +0100</created>
                <updated>Mon, 8 Dec 2008 11:09:32 +0000</updated>
                    <resolved>Sun, 2 Mar 2008 11:24:01 +0000</resolved>
                                            <fixVersion>1.3.4</fixVersion>
                <fixVersion>1.5</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12500233" author="ppakulski" created="Wed, 30 May 2007 21:45:45 +0100"  >Attached patch containing simple solution in SharedItemStateManager class.&lt;br/&gt;
You can disable/enable referential integrity checking by simply setting flag on workspace :&lt;br/&gt;
&lt;br/&gt;
((JackrabbitWorkspace)workspace.setReferentialIntegrityChecking(false);&lt;br/&gt;
&lt;br/&gt;
((JackrabbitWorkspace)workspace.setReferentialIntegrityChecking(true);</comment>
                    <comment id="12500331" author="stefan@jira" created="Thu, 31 May 2007 10:35:32 +0100"  >-1 for the suggested feature since it might lead to inconsistent data.&lt;br/&gt;
&lt;br/&gt;
references are a core feature of jsr-170 which imo must not be compromised through public api methods.</comment>
                    <comment id="12500338" author="jukkaz" created="Thu, 31 May 2007 10:51:49 +0100"  >Disabling the checks seems to be the only way for now to really achieve the use cases in question, so I wouldn&amp;#39;t just deny this change. However, could we end up with some real internal issues for example if the NodeReferences structures inside a persistence store become incorrect?&lt;br/&gt;
&lt;br/&gt;
I wouldn&amp;#39;t worry too much about inconsistencies visible to the client application(s) if they were knowingly injected by a client, but it is a problem if such inconsistencies would destabilize the repository itself.&lt;br/&gt;
</comment>
                    <comment id="12500341" author="fmeschbe" created="Thu, 31 May 2007 11:02:08 +0100"  >-1 for this change.&lt;br/&gt;
&lt;br/&gt;
I second the opinion by Stefan, that this would be a very bad idea.&lt;br/&gt;
&lt;br/&gt;
In fact the real issue is the transient items space which is growing due to the &amp;quot;big transaction&amp;quot;. This is a big issue of the internal implementation of the item managers and cannot be solved by just switching off integrity checking. Consider a big subtree of items (1 mio items, eg.), which you might want to delete. Just switching off integrity checks does not help here.</comment>
                    <comment id="12500342" author="stefan@jira" created="Thu, 31 May 2007 11:06:12 +0100"  >the suggested solution is imo a hack to enable a workaround for the real issue at hand, i.e. in-memory changelog &amp;amp; transient changes&lt;br/&gt;
&lt;br/&gt;
we should address the real issue instead. </comment>
                    <comment id="12500343" author="jukkaz" created="Thu, 31 May 2007 11:12:45 +0100"  >&amp;gt; we should address the real issue instead.&lt;br/&gt;
&lt;br/&gt;
Do we have a plan or even a vague idea of how and when we are going to solve that? In fact I do have some ideas in NGP for solving that, but they are way off in the future.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m all for going for the root cause, but who will do it?</comment>
                    <comment id="12500355" author="ppakulski" created="Thu, 31 May 2007 12:44:33 +0100"  >I can agree that such feature is rather workaround, but this solution is quick and really works. As I wrote it will be not recommended to use it, it is only for experience JCR users which will be aware of any possible drawbacks.&lt;br/&gt;
&lt;br/&gt;
From other point of view using any relational database you can also temporarly disable constraint checking to speedup some bulk operations, then enable it again. And in some cases it is very helpfull.&lt;br/&gt;
&lt;br/&gt;
&amp;gt;references are a core feature of jsr-170 which imo must not be compromised through public api methods.&lt;br/&gt;
&lt;br/&gt;
I dot&amp;#39;t need it exposed through public API. What I need is to have some methods which I can call on any component (could be RepositoryImpl, or WorkspaceImpl).&lt;br/&gt;
&lt;br/&gt;
For now we have implemented this by extending SISM class and overriding some methods. But then our code is depenedent on Jackrabbit, and could stop work with newest versions.&lt;br/&gt;
&lt;br/&gt;
&amp;gt;Consider a big subtree of items (1 mio items, eg.), which you might want to delete. Just switching off integrity checks does not help here&lt;br/&gt;
&lt;br/&gt;
I think it helps, because you can remove tree in steps without worrying about references.&lt;br/&gt;
&lt;br/&gt;
&amp;gt;we should address the real issue instead.&lt;br/&gt;
&lt;br/&gt;
I really agree with you, but changing this could mean redesigning of jackrabbit core and it does not look that it could happen in the near future.&lt;br/&gt;
&lt;br/&gt;
Stefan, Felix, could you recommend any other feasible solution for my use cases?</comment>
                    <comment id="12553802" author="jukkaz" created="Thu, 20 Dec 2007 22:30:15 +0000"  >Dropping from 1.4. I think we definitely should support Przemo&amp;#39;s use case, but with two -1s on table we either need more discussion or an alternative proposal for implementing this.</comment>
                    <comment id="12572697" author="ppakulski" created="Tue, 26 Feb 2008 22:26:41 +0000"  >Without such option it is not possible to clone, import neither remove relatively big subtrees of nodes at all.&lt;br/&gt;
I really need such functionality, but nobody even tried to address the real issue since 9 months already.</comment>
                    <comment id="12572699" author="ppakulski" created="Tue, 26 Feb 2008 22:28:47 +0000"  >Simpler version of patch attached :&lt;br/&gt;
- no public api method,&lt;br/&gt;
- no changes in functionality (integrity checking enabled by default),&lt;br/&gt;
- just single flag with the setter in SharedItemStateManager class which allow to control this behaviour programatically by experienced developers.</comment>
                    <comment id="12572837" author="jukkaz" created="Wed, 27 Feb 2008 09:09:46 +0000"  >Agreed with Przemo. There&amp;#39;s a real itch here and the proposed fix won&amp;#39;t harm anyone, so unless someone comes up with another way to fix this we should not stand in the way.&lt;br/&gt;
&lt;br/&gt;
About the fix, how would you enable the no-referential-checks mode in practice? Should we add some route up to the RepositoryImpl or WorkspaceImpl level, or should the checkReferences flag perhaps be static?</comment>
                    <comment id="12572888" author="ppakulski" created="Wed, 27 Feb 2008 12:10:11 +0000"  >I first proposed patch I&amp;#39;ve added the following method to RepositoryImpl class :&lt;br/&gt;
&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* Enables/disables referential integrity check for workspace.&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* &lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @param workspaceName&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @param checkIntegrityEnabled&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;* @throws RepositoryException&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;*/&lt;br/&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;public void setCheckIntegrityEnabled(String workspaceName, boolean checkIntegrityEnabled) throws RepositoryException;&lt;br/&gt;
&lt;br/&gt;
To keep the patch simple, I created own wrapper for RepositorImpl class and moved this method to custom RepositoryImpl implementation, so I&amp;#39;m able to enable/disable referential integrity checking for any workspace programatically. </comment>
                    <comment id="12573220" author="jukkaz" created="Thu, 28 Feb 2008 10:40:43 +0000"  >I&amp;#39;d be OK to include the setCheckIntegrityEnabled method in RepositoryImpl. It&amp;#39;s one less customization needed on your side and other people might also find it useful (I know I would every now and then).</comment>
                    <comment id="12573225" author="stefan@jira" created="Thu, 28 Feb 2008 11:05:58 +0000"  >i&amp;#39;d prefer to not publicly expose this method. doing so would IMO mean compromising a core feature of JSR-170.</comment>
                    <comment id="12573231" author="jukkaz" created="Thu, 28 Feb 2008 11:18:16 +0000"  >How about including the method in a custom RepositoryImpl subclass included in o.a.j.core? This way nobody would be affected by default, but if you really needed this feature you could instantiate and use that subclass instead of the normal RepositoryImpl.</comment>
                    <comment id="12573682" author="stefan@jira" created="Fri, 29 Feb 2008 11:10:14 +0000"  >&amp;gt;  How about including the method in a custom RepositoryImpl subclass included in o.a.j.core? This way nobody would be affected by default, but if you really needed this feature you could instantiate and use that subclass instead of the normal RepositoryImpl.&lt;br/&gt;
&lt;br/&gt;
-0&lt;br/&gt;
&lt;br/&gt;
IMO that would be still too easy and tempting to use. people might start using this &amp;#39;feature&amp;#39; because they expect better performance. &lt;br/&gt;
however, unless they know exactly what they&amp;#39;re doing, they risk corrupting the repository. personally i&amp;#39;d prefer to expose this &lt;br/&gt;
functionality to subclasses but people would have to write their own in order to enable it.&lt;br/&gt;
</comment>
                    <comment id="12573735" author="jukkaz" created="Fri, 29 Feb 2008 13:35:05 +0000"  >Would it be OK to have a protected method for this in RepositoryImpl? That would still require a subclass, but would minimize the amount of coupling that such a subclass needs with Jackrabbit internals.</comment>
                    <comment id="12573738" author="stefan@jira" created="Fri, 29 Feb 2008 13:40:30 +0000"  >&amp;gt; Would it be OK to have a protected method for this in RepositoryImpl? That would still require a subclass, but would minimize the amount of coupling that such a subclass needs with Jackrabbit internals.&lt;br/&gt;
&lt;br/&gt;
+1, that would be fine with me. thanks!</comment>
                    <comment id="12573752" author="ppakulski" created="Fri, 29 Feb 2008 14:09:54 +0000"  >+1, that will ensure that all internal classes (including SISM) and methods will be acessible in future relases</comment>
                    <comment id="12573760" author="ppakulski" created="Fri, 29 Feb 2008 14:19:19 +0000"  >Could we also include patch in 1.4 maintenance branch ?</comment>
                    <comment id="12574205" author="jukkaz" created="Sun, 2 Mar 2008 11:24:01 +0000"  >Committed the SISM changes and the proposed protected RepositoryImpl method to trunk in revision 632738. Merged the changes to the 1.3 branch in revision 632739.&lt;br/&gt;
&lt;br/&gt;
I&amp;#39;m reluctant to push this to the 1.4 branch at the moment as we&amp;#39;re still making &amp;quot;pure&amp;quot; patch releases from there. Perhaps once 1.5 is out we can do a more relaxed 1.4.x release like we are currently doing with 1.3.4.</comment>
                </comments>
                    <attachments>
                    <attachment id="12358574" name="JCR-954-patch.txt" size="12939" author="ppakulski" created="Wed, 30 May 2007 21:45:45 +0100" />
                    <attachment id="12376560" name="JCR-954-simple.diff" size="1880" author="ppakulski" created="Tue, 26 Feb 2008 22:28:47 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 31 May 2007 09:35:32 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>142446</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>279660</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>