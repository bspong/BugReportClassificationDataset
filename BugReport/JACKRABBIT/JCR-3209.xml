<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:57:04 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-3209/JCR-3209.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-3209] lock token validity</title>
                <link>https://issues.apache.org/jira/browse/JCR-3209</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>There are several minor issues in the mapping between JCR lock tokens and WebDAV lock tokens:&lt;br/&gt;
&lt;br/&gt;
1) WebDAV lock tokens are supposed to use URI syntax (such as opaquelocktoken: or urn:uuid:)&lt;br/&gt;
&lt;br/&gt;
2) The server currently computes lock tokens for session-scoped locks based on the node id; these are not valid JCR lock tokens though and cause exceptions when they are re-added when they appear in a Lock-Token header or an If header. This will likely cause requests to fail that use both types of locks (yes, maybe academic but should be fixed anyway)&lt;br/&gt;
&lt;br/&gt;
Proposal:&lt;br/&gt;
&lt;br/&gt;
a) Map lock tokens to oqaquelocktoken URIs, using a constant UUID plus a postfix encoding the original lock token&lt;br/&gt;
b) Use a syntax that allows to distinguish between tokens for open-scoped locks or session-scoped locks, so that we do not try to add the latter type to the Session (alternatively, handle exceptions doing so gracefully)</description>
                <environment></environment>
            <key id="12538516">JCR-3209</key>
            <summary>lock token validity</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="reschke">Julian Reschke</assignee>
                                <reporter username="reschke">Julian Reschke</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Jan 2012 13:56:26 +0000</created>
                <updated>Fri, 3 Aug 2012 09:31:20 +0100</updated>
                    <resolved>Thu, 19 Jan 2012 19:14:34 +0000</resolved>
                                            <fixVersion>2.5</fixVersion>
                                <component>jackrabbit-jcr-server</component>
                <component>jackrabbit-spi2dav</component>
                <component>locks</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13187690" author="anchela" created="Tue, 17 Jan 2012 13:59:01 +0000"  >isn&amp;#39;t 1) already covered by &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-1352&quot; title=&quot;illegal format for WebDAV lock tokens&quot;&gt;&lt;strike&gt;JCR-1352&lt;/strike&gt;&lt;/a&gt;?&lt;br/&gt;
&lt;br/&gt;
regarding 2) &lt;br/&gt;
&lt;br/&gt;
&amp;gt; The server currently computes lock tokens for session-scoped locks based on the node id; these are not valid JCR lock tokens though &lt;br/&gt;
&lt;br/&gt;
this change was introduce since as of jcr 2.0 session scoped locks don&amp;#39;t expose the token any more.&lt;br/&gt;
if you have a proposal for another type of token that&amp;#39;s fine.&lt;br/&gt;
&lt;br/&gt;
&amp;gt; and cause exceptions when they are re-added when they appear in a Lock-Token header or an If header. &lt;br/&gt;
&lt;br/&gt;
as far as i know this just causes a ugly warning in the log file (written by jackrabbit-core), since adding the token to &lt;br/&gt;
session fails, which in this case was useless any way as they are session scoped. but if i remember correctly it otherwise &lt;br/&gt;
used to work (see also &lt;a href=&quot;https://issues.apache.org/jira/browse/JCR-2990&quot; title=&quot;Jcr-Server: Token exposed for Session-Scoped Locks results in &amp;quot;Bad lock token&amp;quot; Exception when being reapplied.&quot;&gt;&lt;strike&gt;JCR-2990&lt;/strike&gt;&lt;/a&gt;... which i resolved wontfix due to lack of priority)&lt;br/&gt;
&lt;br/&gt;
&amp;gt; This will likely cause requests to fail that use both types of locks (yes, maybe academic but should be fixed anyway) &lt;br/&gt;
&lt;br/&gt;
can&amp;#39;t follow you here.&lt;br/&gt;
&lt;br/&gt;
but anyway: it was definitely favorable if we can distinguish the two types of locks based on the token and&lt;br/&gt;
could therefore omit adding it to the session/lockmanager. </comment>
                    <comment id="13187704" author="reschke" created="Tue, 17 Jan 2012 14:15:57 +0000"  >Angela, sorry for missing the two older JIRA issues :-) Will clean this up.&lt;br/&gt;
&lt;br/&gt;
Regarding:&lt;br/&gt;
&lt;br/&gt;
&amp;quot;&amp;gt; This will likely cause requests to fail that use both types of locks (yes, maybe academic but should be fixed anyway)&lt;br/&gt;
&lt;br/&gt;
can&amp;#39;t follow you here. &amp;quot;&lt;br/&gt;
&lt;br/&gt;
My reading of the code is that a RuntimeException is thrown and thus the request will not continue to run as it should (but I&amp;#39;ll check that).</comment>
                    <comment id="13187713" author="reschke" created="Tue, 17 Jan 2012 14:27:11 +0000"  >Angela: indeed, the IllegalArgumentException is transformed into a LockException and then catched, logged, and ignored by o.a.j.c.SessionImpl,addLockToken(). Sorry for the confusion.</comment>
                    <comment id="13187719" author="anchela" created="Tue, 17 Jan 2012 14:32:46 +0000"  >no problem... i just happened to take a look at that the session-scoped locks some time ago&lt;br/&gt;
and found myself struggling with the log-output, that turned out to be irrelevant for the&lt;br/&gt;
problem i was trying to solve.</comment>
                    <comment id="13188441" author="reschke" created="Wed, 18 Jan 2012 13:39:22 +0000"  >Proposed patch; implements mapping of JCR lock tokens to valid DAV lock token URIs, isolates mapping in a single place.</comment>
                    <comment id="13188442" author="reschke" created="Wed, 18 Jan 2012 13:40:12 +0000"  >Observation: it appears that we never need the actual JCR lock token of a *session* scoped lock. That makes sense as we are keeping the JCR session around, right? </comment>
                    <comment id="13193038" author="jukkaz" created="Wed, 25 Jan 2012 13:40:44 +0000"  >Do we want to include this already in 2.4? Seems like a relatively low-risk change so we could still backport this before the 2.4.0 release gets cut.</comment>
                    <comment id="13193048" author="reschke" created="Wed, 25 Jan 2012 13:55:52 +0000"  >it&amp;#39;s both low-risk and low-prio, so it might be something that can wait...</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310010">
                <name>Incorporates</name>
                                <outwardlinks description="incorporates">
                            <issuelink>
            <issuekey id="12387550">JCR-1352</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12510440">JCR-2990</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12510979" name="JCR-3209.diff" size="11197" author="reschke" created="Wed, 18 Jan 2012 13:39:22 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 17 Jan 2012 13:59:01 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>224021</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>280348</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>