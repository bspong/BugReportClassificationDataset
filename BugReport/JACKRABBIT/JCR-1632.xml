<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Sat Jul 27 05:53:37 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/JCR-1632/JCR-1632.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[JCR-1632] Mixin type loss</title>
                <link>https://issues.apache.org/jira/browse/JCR-1632</link>
                <project id="10591" key="JCR">Jackrabbit Content Repository</project>
                        <description>When using a bundle persistence manager, the mixin type information may be corrupted in the lucene index, causing queries like &amp;#39;//element(*, my:mixin)&amp;#39; to fail.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
The problem is that the &amp;#39;jcr:mixinTypes&amp;#39; may be stored in the bundle. Here is how this could happen :&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
First step: Create a node and add a mixin &amp;#39;A&amp;#39;.&lt;br/&gt;
&lt;br/&gt;
Everything&amp;#39;s fine. The query &amp;#39;//element(*, &amp;#39;A&amp;#39;)&amp;#39; works.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Second step : Select the node and add a second mixin &amp;#39;B&amp;#39;.&lt;br/&gt;
&lt;br/&gt;
When the second mixin is added, the AbstractBundlePersistenceManager#load(PropertyId) is called to get the current mixins for the node. This method will store the PropertyState for &amp;#39;jcr:mixinTypes&amp;#39; in the bundle (containing only the mixin &amp;#39;A&amp;#39;). Then the NodeImpl#setMixinTypesProperty() will set the PropertyState for &amp;#39;jcr:mixinTypes&amp;#39; in the node state (containing the mixins &amp;#39;A&amp;#39; and &amp;#39;B&amp;#39;).&lt;br/&gt;
When the session is saved, the ChangeLog in AbstractBundlePersistenceManager#store() contains a modification for the &amp;#39;jcr:mixinTypes&amp;#39; but it&amp;#39;s being ignored, leaving the bundle with only mixin &amp;#39;A&amp;#39;. The NodeIndexer looks into the node state to get the mixin types and indexes the node correctly. The queries &amp;#39;//element(*, &amp;#39;A&amp;#39;)&amp;#39; and &amp;#39;//element(*, &amp;#39;B&amp;#39;)&amp;#39; work.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
Thrid step : Select the node and update a property. &lt;br/&gt;
&lt;br/&gt;
When the session is saved, the NodeIndexer asks again for the &amp;#39;jcr:mixinTypes&amp;#39; property, by calling the AbstractBundlePersistenceManager#load(PropertyId) to load it. The bundle contains this property and returns only mixin &amp;#39;A&amp;#39; (as it was stored in the second step), causing the index to use only mixin &amp;#39;A&amp;#39;. The query &amp;#39;//element(*, &amp;#39;A&amp;#39;)&amp;#39; still works but &amp;#39;//element(*, &amp;#39;B&amp;#39;) doesn&amp;#39;t work anymore.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
A simple solution to this would be to not store the PropertyState for the &amp;#39;jcr:mixinTypes&amp;#39; (and &amp;#39;jcr:uuid&amp;#39; and &amp;#39;jcr:primaryType&amp;#39;, as the class description states) in the bundle when the PropertyState is loaded. It would fix the issue but not the contents on existing repositories. One way to allow the repositories to fix themselves is to not read or write these 3 properties in the BundleBinding#readBundle and BundleBinding#writeBundle methods, but I&amp;#39;m not sure wether or not it would have a performance impact.&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</description>
                <environment>Linux 64-Bit (openSUSE 10.3) using Java 1.5.0_12 64-Bit&lt;br/&gt;
</environment>
            <key id="12397156">JCR-1632</key>
            <summary>Mixin type loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="hint">Frederic Laugier</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 May 2008 10:51:49 +0100</created>
                <updated>Tue, 6 Jan 2009 15:57:19 +0000</updated>
                    <resolved>Thu, 24 Jul 2008 13:33:10 +0100</resolved>
                            <version>1.4</version>
                <version>1.5</version>
                                <fixVersion>core 1.4.6</fixVersion>
                                <component>jackrabbit-core</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12601060" author="hint" created="Fri, 30 May 2008 10:54:45 +0100"  >A test suite that shows the issue</comment>
                    <comment id="12601071" author="hint" created="Fri, 30 May 2008 11:23:24 +0100"  >A patch to not store the PropertyState in the bundle for the 1.4 branch</comment>
                    <comment id="12616464" author="stefan@jira" created="Thu, 24 Jul 2008 13:33:10 +0100"  >fixed in svn r 679389&lt;br/&gt;
&lt;br/&gt;
&lt;br/&gt;
</comment>
                    <comment id="12616484" author="gjoseph" created="Thu, 24 Jul 2008 15:15:06 +0100"  >Any chance this could be backported to 1.4 ? </comment>
                    <comment id="12616491" author="jukkaz" created="Thu, 24 Jul 2008 15:37:28 +0100"  >No problem. Merged to the 1.4 branch in revision 679425. Would you like us to make an official jackrabbit-core 1.4.6 release with this fix?</comment>
                    <comment id="12616533" author="gjoseph" created="Thu, 24 Jul 2008 17:54:33 +0100"  >wow that&amp;#39;d be awesome :)</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310000">
                <name>Duplicate</name>
                                                <inwardlinks description="is duplicated by">
                            <issuelink>
            <issuekey id="12400872">JCR-1690</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12383089" name="asf-jackrabbit-tests_src.zip" size="6921" author="hint" created="Fri, 30 May 2008 10:54:45 +0100" />
                    <attachment id="12383091" name="patch_14" size="668" author="hint" created="Fri, 30 May 2008 11:23:24 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 24 Jul 2008 12:33:10 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>78480</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>190727</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>