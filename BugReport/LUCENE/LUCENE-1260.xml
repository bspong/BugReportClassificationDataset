<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:02:35 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1260/LUCENE-1260.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1260] Norm codec strategy in Similarity</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1260</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;The static span and resolution of the 8 bit norms codec might not fit with all applications. &lt;/p&gt;

&lt;p&gt;My use case requires that 100f-250f is discretized in 60 bags instead of the default.. 10?&lt;/p&gt;</description>
                <environment></environment>
            <key id="12393345">LUCENE-1260</key>
            <summary>Norm codec strategy in Similarity</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="karl.wettin">Karl Wettin</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Apr 2008 21:14:49 +0100</created>
                <updated>Wed, 30 Mar 2011 16:49:54 +0100</updated>
                    <resolved>Thu, 13 Jan 2011 12:00:23 +0000</resolved>
                            <version>2.3.1</version>
                                <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>7</votes>
                        <watches>2</watches>
                                                    <comments>
                    <comment id="12586520" author="karl.wettin" created="Mon, 7 Apr 2008 21:20:08 +0100"  >
&lt;ul&gt;
	&lt;li&gt;Simlarity#getNormCodec()&lt;/li&gt;
	&lt;li&gt;Simlarity#setNormCodec(NormCodec)&lt;/li&gt;
	&lt;li&gt;Similarity$NormCodec&lt;/li&gt;
	&lt;li&gt;Similarity$DefaultNormCodec&lt;/li&gt;
	&lt;li&gt;Similarity$SimpleNormCodec (binsearches over a sorted float[])&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also depricated Similarity#getNormsTable() and replaced the only use I could find of it - in TermScorer. Could not spont any problems with performance or anything with that.&lt;/p&gt;</comment>
                    <comment id="12586588" author="karl.wettin" created="Tue, 8 Apr 2008 00:00:57 +0100"  >&lt;p&gt;I suppose it would be possible to implement a NormCodec that would listen to encodeNorm(float) while one is creating a subset of the index in order to find all norm resolution sweetspots for that corpus using some appropriate algorithm. Mean shift?.&lt;/p&gt;

&lt;p&gt;Perhaps it even would be possible to compress it down to n bags from the start and then allow for it to grow in case new documents with other norm requirements are added to the store.&lt;/p&gt;

&lt;p&gt;I haven&apos;t thought too much about it yet, but it seems to me that norm codec has more to do with the physical store (Directory) than Similarity and should perhaps be moved there instead? I have no idea how, but I also want to move it to the instance scope so I can have multiple indices with unique norm span/resolutions created from the same classloader.&lt;/p&gt;</comment>
                    <comment id="12586954" author="hossman" created="Tue, 8 Apr 2008 21:45:21 +0100"  >&lt;blockquote&gt;&lt;p&gt;I haven&apos;t thought too much about it yet, but it seems to me that norm codec has more to do with the physical store (Directory) than Similarity and should perhaps be moved there instead?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As long as the norm remains a fixed size (1 byte) then it doesn&apos;t really matter whether it&apos;s tied to Similarity&apos;s or the store itself &amp;#8211; it would be nice if the Index could tell you which normDecoder to use, but it&apos;s not any more unreasonable to expect the application to keep track of this (if it&apos;s not the default encoding) since applications already have to keep track of things like which Analyzer is &quot;compatible&quot; with querying this index.&lt;/p&gt;

&lt;p&gt;If we want norms to be more flexible, so tat apps can pick not only the encoding but also the size... then things get more interesting, but it&apos;s still feasible to say &quot;if you customize this, you have to make your reading apps and your writing apps smart enough to know about your customization.&quot;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I also want to move it to the instance scope so I can have multiple indices with unique norm span/resolutions created from the same classloader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, it&apos;s a good goal.&lt;/p&gt;</comment>
                    <comment id="12587290" author="karl.wettin" created="Wed, 9 Apr 2008 19:24:29 +0100"  >&lt;blockquote&gt;
&lt;p&gt;As long as the norm remains a fixed size (1 byte) then it doesn&apos;t really matter whether it&apos;s tied to Similarity&apos;s or the store itself - it would be nice if the Index could tell you which normDecoder to use, but it&apos;s not any more unreasonable to expect the application to keep track of this (if it&apos;s not the default encoding) since applications already have to keep track of things like which Analyzer is &quot;compatible&quot; with querying this index.&lt;/p&gt;

&lt;p&gt;If we want norms to be more flexible, so tat apps can pick not only the encoding but also the size... then things get more interesting, but it&apos;s still feasible to say &quot;if you customize this, you have to make your reading apps and your writing apps smart enough to know about your customization.&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I like the idea of an index that is completely self aware of norm encoding, what payloads mean, et c. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I also want to move it to the instance scope so I can have multiple indices with unique norm span/resolutions created from the same classloader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My use case is really about document boost and not normalization. &lt;/p&gt;

&lt;p&gt;So another solution to this is to introduce a (variable bit sized?) document boost file and completely separate it from the norms instead of as now where  normalization and document boost is baked up as the same thing. I think there would be no need to touch the norms encoding then, that the default resolution is good enough for /normalization/. It would fix several caveats with norms as I see it. &lt;/p&gt;
</comment>
                    <comment id="12587435" author="hossman" created="Thu, 10 Apr 2008 01:15:00 +0100"  >&lt;blockquote&gt;&lt;p&gt;My use case is really about document boost and not normalization.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;So another solution to this is to introduce a (variable bit sized?) document boost file and completely separate it from the norms instead...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;1) &quot;norms&quot; is a vague term.  currently &quot;lengthNorm&quot; is folded in with &quot;field boosts&quot; and &quot;doc boosts&quot; to form a generic &quot;fieldNorm&quot; ... I assumed you were interested in a more general way to improve the resolution of &quot;fieldNorm&quot;&lt;/p&gt;

&lt;p&gt;2) your description of general purpose variable sized document boosting sounds exactly like &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1231&quot; title=&quot;Column-stride fields (aka per-document Payloads)&quot;&gt;&lt;del&gt;LUCENE-1231&lt;/del&gt;&lt;/a&gt; ... in the long run utilities using &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1231&quot; title=&quot;Column-stride fields (aka per-document Payloads)&quot;&gt;&lt;del&gt;LUCENE-1231&lt;/del&gt;&lt;/a&gt; (or something like it) to replace &quot;field boosts&quot; and &quot;length norms&quot; might make the most sense as a way to eliminate the current static Norm encoding and put more flexibility in the hands of users&lt;/p&gt;</comment>
                    <comment id="12587445" author="karl.wettin" created="Thu, 10 Apr 2008 02:03:17 +0100"  >&lt;blockquote&gt;
&lt;p&gt;1) &quot;norms&quot; is a vague term. currently &quot;lengthNorm&quot; is folded in with &quot;field boosts&quot; and &quot;doc boosts&quot; to form a generic &quot;fieldNorm&quot; ... I assumed you were interested in a more general way to improve the resolution of &quot;fieldNorm&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I still am but mainly because it is the simplest and only way to get better document boost resolution at the moment.&lt;/p&gt;

</comment>
                    <comment id="12587446" author="karl.wettin" created="Thu, 10 Apr 2008 02:03:27 +0100"  >&lt;p&gt;I notice there is a tyop in the patch. And there is no test case for SimpleNormCodec. I&apos;ll come up with that too.&lt;/p&gt;</comment>
                    <comment id="12587953" author="karl.wettin" created="Fri, 11 Apr 2008 14:01:56 +0100"  >&lt;p&gt;Fixed some typos and added some tests. Perhaps it needs new javadocs too?&lt;/p&gt;</comment>
                    <comment id="12587954" author="karl.wettin" created="Fri, 11 Apr 2008 14:03:30 +0100"  >&lt;p&gt;This is a retroactive ASL blessing of the patch posted 11/Apr/08 06:01 AM&lt;/p&gt;</comment>
                    <comment id="12592200" author="karl.wettin" created="Fri, 25 Apr 2008 00:32:12 +0100"  >&lt;p&gt;New patch additionally includes:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Lots of javadocs with warnings&lt;/li&gt;
	&lt;li&gt;Similarity#readNormCodec(Directory):NodeCodec&lt;/li&gt;
	&lt;li&gt;Similarity#writeNormCodec(Directory, NodeCode)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12592203" author="karl.wettin" created="Fri, 25 Apr 2008 00:38:42 +0100"  >&lt;p&gt;I think I&apos;ve takes this as far as it can without refactoring it out of the static scope.&lt;/p&gt;</comment>
                    <comment id="12625157" author="karl.wettin" created="Sun, 24 Aug 2008 13:20:02 +0100"  >&lt;p&gt;I&apos;d like to see this committed in 2.4, but I don&apos;t have core access.&lt;/p&gt;</comment>
                    <comment id="12625170" author="yseeley@gmail.com" created="Sun, 24 Aug 2008 15:45:11 +0100"  >&lt;p&gt;This solves a particular usecase nicely, but is it really generic enough and durable enough to put in core?&lt;br/&gt;
This essentially adds a new file into the index, but it&apos;s not really part of the index.  It wouldn&apos;t work with any possible upcoming similarity-per-field to give different NormCodecs per field, and it requires the user to handle their own management of the file (using lucene addIndexes to copy from one place to another won&apos;t grab this file, etc).&lt;/p&gt;</comment>
                    <comment id="12625223" author="karl.wettin" created="Sun, 24 Aug 2008 22:09:48 +0100"  >&lt;p&gt;The file is just something secondary I added on &quot;request&quot;, personally I use a hardcoded codec. All it does is to allow a simple way in to change the current static norm translation table.&lt;/p&gt;</comment>
                    <comment id="12706604" author="johkin" created="Wed, 6 May 2009 22:43:10 +0100"  >&lt;p&gt;Wouldn&apos;t the simplest solution be to refactor out the static methods, replace them with instance methods and remove the getNormDecoder method? This would enable a pluggable behavior without introducing a new Codec.&lt;br/&gt;
Would cause minor changes to 11 classes in the core, and would also clean up the code from static stuff.&lt;/p&gt;

&lt;p&gt;As described in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1261&quot; title=&quot;Impossible to use custom norm encoding/decoding&quot;&gt;&lt;del&gt;LUCENE-1261&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="12715492" author="karl.wettin" created="Tue, 2 Jun 2009 12:39:41 +0100"  >&lt;blockquote&gt;&lt;p&gt;Wouldn&apos;t the simplest solution be to refactor out the static methods, replace them with instance methods and remove the getNormDecoder method? This would enable a pluggable behavior without introducing a new Codec.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hi Johan,&lt;/p&gt;

&lt;p&gt;feel free to post a patch!&lt;/p&gt;
</comment>
                    <comment id="12722374" author="johkin" created="Sun, 21 Jun 2009 16:48:44 +0100"  >&lt;p&gt;Removed &apos;static&apos; keyword to enable a pluggable behavior for encoding/decoding norms. Our business-case for this is to fix scoring when using NGrams. If a word is split into three parts, the norm for these parts would then become ~0.3125 (don&apos;t remember exactly) in the current implementation. A search for the exact same word would then generate a score of less than 1.0. With a pluggable norm-calculation, we could use a norm-table with values 0-100 and get a better scoring.&lt;/p&gt;

&lt;p&gt;Minor changes in 11 core-classes and some tests. Also minor changes in analyzers, instantiated, memory and miscellaneous.&lt;/p&gt;</comment>
                    <comment id="12722575" author="karl.wettin" created="Mon, 22 Jun 2009 13:15:06 +0100"  >&lt;p&gt;Hi Johan,&lt;/p&gt;

&lt;p&gt;didn&apos;t try it out yet but the patch looks nice and clean. +1 from me. Let&apos;s try to convince some of the old -1:ers. &lt;/p&gt;

&lt;p&gt;YONIK? See, it&apos;s not just me. ; )&lt;/p&gt;

&lt;p&gt;I do however still think it&apos;s nice with the serializable codec interface as in the previous patches in order for all applications to use the index as intended (Luke and what not). 256 bytes stored to a file and by default backed by a binary search or so unless there is a registred codec that handles it algorithmic. I&apos;ll copy and paste that in as an alternative suggestion ASAP.&lt;/p&gt;

&lt;p&gt;(I think the next move should be to allow for per field variable norms resolution, but that is a whole new issue.)&lt;/p&gt;</comment>
                    <comment id="12775046" author="mikemccand" created="Mon, 9 Nov 2009 18:10:11 +0000"  >&lt;p&gt;Has anyone tested performance of this last patch?  One thing that concerns me is this change to TermScorer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; norms == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? raw : raw * SIM_NORM_DECODER[norms[doc] &amp;amp; 0xFF]; &lt;span class=&quot;code-comment&quot;&gt;// normalize &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; field
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; norms == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? raw : raw * getSimilarity().decodeNorm(norms[doc]); &lt;span class=&quot;code-comment&quot;&gt;// normalize &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; field&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;though it could easily be in practice that it doesn&apos;t matter.&lt;/p&gt;</comment>
                    <comment id="12775048" author="mikemccand" created="Mon, 9 Nov 2009 18:13:06 +0000"  >&lt;p&gt;I think this is a reasonable change, but we probably should wait for 3.1 as long as 3.0 comes out soonish.&lt;/p&gt;</comment>
                    <comment id="12775310" author="johkin" created="Tue, 10 Nov 2009 05:59:56 +0000"  >&lt;p&gt;Regarding the performance of the TermScorer, there could be two things to handle to ensure that the Jvm will inline the code: &lt;br/&gt;
1. In the Scorer base-class, make the field &apos;similarity&apos; final. (Shouldn&apos;t be any problem since it&apos;s imutable?)&lt;br/&gt;
2. In the Similarity, make the internal decoder array final. That&apos;s really up to the implementor, but the default implementations should perhaps use a final field. Also add a note in the javadoc of this?&lt;br/&gt;
Would you like me to create another patch with the above changes? Maybe there could other optimizations, haven&apos;t really looked at optimizing the code yet.&lt;/p&gt;</comment>
                    <comment id="12775357" author="mikemccand" created="Tue, 10 Nov 2009 09:45:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Would you like me to create another patch with the above changes?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, please &amp;#8211; then I&apos;ll run some basic perf tests. Thanks!&lt;/p&gt;</comment>
                    <comment id="12776678" author="johkin" created="Wed, 11 Nov 2009 21:43:06 +0000"  >&lt;p&gt;Added &apos;final&apos; modifier to the Similarity field where it was used.&lt;/p&gt;

&lt;p&gt;The norm-array in Similarity was already made &apos;final&apos;, so there&apos;s no change there. I think there could be further refactoring of the use of the Similarity instance, but that is perhaps out of the scope for this issue. I hope this will pass the performance-tests!&lt;/p&gt;</comment>
                    <comment id="12776781" author="mikemccand" created="Thu, 12 Nov 2009 01:24:04 +0000"  >&lt;p&gt;Performance looks good &amp;#8211; I tested with query &quot;1&quot; on a 5M doc wikipedia index and any difference appears to be in the noise.&lt;/p&gt;

&lt;p&gt;But, the current patch breaks back-compat (eg &lt;tt&gt;ant test-tag -Dtestcase=TestNorms&lt;/tt&gt; fails) &amp;#8211; I think we have to put back the static methods (mark them deprecated), and then find new names for the instance methods?&lt;/p&gt;</comment>
                    <comment id="12776878" author="johkin" created="Thu, 12 Nov 2009 07:06:35 +0000"  >&lt;p&gt;Haven&apos;t really thought about the back-compat question yet, but that&apos;s of course an important aspect. When is the 3.0 release planned? I noticed that there were a couple of issues still open, and that release will already break the compatibility...&lt;br/&gt;
Maybe this kind of change should be tested for a couple of weeks before bringing it to a release, if the 3.0 is impending.&lt;/p&gt;

&lt;p&gt;Would you like me to continue working with this, or do you already have suggestions for new names of the instance methods?&lt;/p&gt;</comment>
                    <comment id="12776879" author="thetaphi" created="Thu, 12 Nov 2009 07:11:45 +0000"  >&lt;p&gt;The 3.0 release will &lt;b&gt;not&lt;/b&gt; break backwards compatibility for users that upgraded to 2.9.1 and got rid of deprecation warnings. 3.0 release cicle will start at the weekend, most issues are organizational ones, the rest is finished soon.&lt;/p&gt;

&lt;p&gt;I tend to add the deprecated static method and leave this as 3.1.&lt;/p&gt;</comment>
                    <comment id="12776931" author="mikemccand" created="Thu, 12 Nov 2009 09:53:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;Would you like me to continue working with this, or do you already have suggestions for new names of the instance methods?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, please, could you turnaround a new patch?&lt;/p&gt;

&lt;p&gt;Hmm, naming is always the hardest part.... maybe decodeNormValue/encodeNormValue?  normToByte/byteToNorm?  getEncodedNorm/getDecodedNorm?  Something else?&lt;/p&gt;</comment>
                    <comment id="12778824" author="mikemccand" created="Tue, 17 Nov 2009 11:14:53 +0000"  >&lt;p&gt;Johan are you working up a new patch here?  (to fix the back compat issue)&lt;/p&gt;</comment>
                    <comment id="12778843" author="johkin" created="Tue, 17 Nov 2009 12:31:29 +0000"  >&lt;p&gt;I haven&apos;t had time so far to create a new patch, and I will be away for the next couple of days. Feel free to modify my patch if you like to finish up this issue. &apos;decodeNormValue&apos; sounds fine by me!&lt;br/&gt;
Otherwise I hope I can come up with a patch by the end of the week (probably late, sunday).&lt;/p&gt;</comment>
                    <comment id="12781192" author="johkin" created="Sun, 22 Nov 2009 19:14:13 +0000"  >&lt;p&gt;I&apos;ve added the old static methods again, but made them deprecated.&lt;/p&gt;

&lt;p&gt;In contrib/misc there is still a reference to the static encodeNorm method, maybe that should be replaced with Similarity.getDefaultSimilarity().encodeNormValue(f)? This call to the static method is only done if no similarity is passed to the FieldNormModifier.&lt;/p&gt;

&lt;p&gt;I added a short javadoc description to the static methods, not sure if that is enough? (I guess they will be removed, so the relevant javadoc is probably in the instance methods?)&lt;/p&gt;</comment>
                    <comment id="12781224" author="mikemccand" created="Sun, 22 Nov 2009 21:41:02 +0000"  >&lt;p&gt;Patch looks good!  Thanks Johan.  I&apos;ll commit in a day or two...&lt;/p&gt;</comment>
                    <comment id="12782147" author="mikemccand" created="Tue, 24 Nov 2009 20:27:10 +0000"  >&lt;p&gt;Thanks Johan!&lt;/p&gt;</comment>
                    <comment id="12978632" author="rcmuir" created="Fri, 7 Jan 2011 04:54:46 +0000"  >&lt;p&gt;I think there are serious traps here, that if you supply Similarity to IWConfig etc rather than&lt;br/&gt;
 setting the global static Similarity.setDefault, your code will have no effect.&lt;/p&gt;

&lt;p&gt;The biggest offendor can be seen in the patch:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      final float norm = docState.similarity.computeNorm(fieldInfo.name, fieldState);
-      norms[upto] = Similarity.encodeNorm(norm);
+      norms[upto] = Similarity.getDefault().encodeNormValue(norm);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;shouldnt that simply call docState.similarity.encodeNormValue?&lt;/p&gt;

&lt;p&gt;There are other problems with decode too.&lt;br/&gt;
I think we need to review all places where we use the static Similarity.getDefault() carefully.&lt;/p&gt;
</comment>
                    <comment id="12979157" author="rcmuir" created="Sat, 8 Jan 2011 17:20:52 +0000"  >&lt;p&gt;Here&apos;s a patch for the general case, and it also adds a warning&lt;br/&gt;
that you should set your similarity with Similarity.setDefault, especially if you omit norms.&lt;/p&gt;

&lt;p&gt;We can backport this to 3.x&lt;/p&gt;

&lt;p&gt;The other cases involve fake norms, which I think we should completely remove in trunk&lt;br/&gt;
with &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2846&quot; title=&quot;omitTF is viral, but omitNorms is anti-viral.&quot;&gt;&lt;del&gt;LUCENE-2846&lt;/del&gt;&lt;/a&gt;, then there is no longer an issue and we can remove the warning in trunk.&lt;/p&gt;</comment>
                    <comment id="12979160" author="thetaphi" created="Sat, 8 Jan 2011 17:31:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;Here&apos;s a patch for the general case, and it also adds a warning that you should set your similarity with Similarity.setDefault, especially if you omit norms. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is there no way to remove this stupid static default and deprecate Similarity.(g|s)etDefault()? Can we not use the Similarity from IndexWriter for the case of NormsWriter?&lt;/p&gt;</comment>
                    <comment id="12979164" author="rcmuir" created="Sat, 8 Jan 2011 17:47:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is there no way to remove this stupid static default and deprecate Similarity.(g|s)etDefault()? Can we not use the Similarity from IndexWriter for the case of NormsWriter?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this is totally what we should try to do in trunk, especially after &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2846&quot; title=&quot;omitTF is viral, but omitNorms is anti-viral.&quot;&gt;&lt;del&gt;LUCENE-2846&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In this case, i want to fix the issue in a backwards-compatible way for lucene 3.x&lt;br/&gt;
The warning is a little crazy I know, really people shouldnt rely upon their encoder being used for &lt;b&gt;fake norms&lt;/b&gt;.&lt;br/&gt;
But i think its fair to document the corner case, just because its not really fixable easily in 3.x&lt;/p&gt;

&lt;p&gt;For trunk, here is what i suggest:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2846&quot; title=&quot;omitTF is viral, but omitNorms is anti-viral.&quot;&gt;&lt;del&gt;LUCENE-2846&lt;/del&gt;&lt;/a&gt;: remove all uses of fake norms. We never fill fake norms anymore at all, once we fix this issue. If you have a non-atomic reader with two segments, and one has no norms, then the whole norms[] should be null. this is consistent with omitTF. So, for example MultiNorms would never create fake&lt;br/&gt;
norms.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2854&quot; title=&quot;Deprecate SimilarityDelegator and Similarity.lengthNorm&quot;&gt;&lt;del&gt;LUCENE-2854&lt;/del&gt;&lt;/a&gt;: Mike is working on some issues i think where BooleanQuery uses this static or some other silliness with Similarity, i think we can clean that up there.&lt;/li&gt;
	&lt;li&gt;finally at this point, I would like to remove Similarity.getDefault/setDefault alltogether. I would prefer instead that IndexSearcher has a single &apos;DefaultSimilarity&apos; that is the default value if you don&apos;t provide one, and likewise with IndexWriterConfig.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12979295" author="simonw" created="Sun, 9 Jan 2011 11:14:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;For trunk, here is what i suggest:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I didn&apos;t follow the entire thread here but is it worth all the effort what robert is suggesting or should we simply land docvalues branch and make norms a DocValues field? The infrastructure is already there, its integrated into codec and gives users the freedom to use any Type they want. &lt;/p&gt;</comment>
                    <comment id="12979303" author="rcmuir" created="Sun, 9 Jan 2011 11:39:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;I didn&apos;t follow the entire thread here but is it worth all the effort what robert is suggesting or should we simply land docvalues branch and make norms a DocValues field? The infrastructure is already there, its integrated into codec and gives users the freedom to use any Type they want.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Simon, the the problem is encode/decode is in Similarity (instead of somewhere else).&lt;/p&gt;

&lt;p&gt;So, you would have the same problem with DocValues!&lt;/p&gt;</comment>
                    <comment id="12979317" author="simonw" created="Sun, 9 Jan 2011 13:04:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;So, you would have the same problem with DocValues!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;hmm, not sure if I understand this correctly. how values are encoded / decoded depends on the DocValues implementation which can be customized since it is exposed via codec. That means that users of the API always operate on float and the encoding and decoding happens inside codec and per field. So encode/decode in Sim would be obsolet, right?&lt;/p&gt;</comment>
                    <comment id="12979319" author="rcmuir" created="Sun, 9 Jan 2011 13:20:08 +0000"  >&lt;blockquote&gt;
&lt;p&gt;hmm, not sure if I understand this correctly. how values are encoded / decoded depends on the DocValues implementation which can be customized since it is exposed via codec. That means that users of the API always operate on float and the encoding and decoding happens inside codec and per field. So encode/decode in Sim would be obsolet, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;the issues remaining here involve mostly &quot;fake norms&quot;, for the omitNorms case (also &quot;empty norms&quot; I think).&lt;br/&gt;
So, the stuff I listed must be fixed regardless, to clean up the fake norms case, it does not matter if &quot;real norms&quot; are encoded with CSF or not.&lt;/p&gt;

&lt;p&gt;Doing things like cleaning up how we deal with fake norms, and removing Similarity.get/setDefault is completely unrelated to DocValues... its just stuff we must fix.&lt;/p&gt;

&lt;p&gt;As long as we have these statics like Similarity.get/setDefault, its not even useful to think about things like flexible scoring or per-field SImilarity...!&lt;/p&gt;</comment>
                    <comment id="12979326" author="mikemccand" created="Sun, 9 Jan 2011 13:42:49 +0000"  >&lt;p&gt;I think we need to stop faking norms, independent of whether/when we cutover to CSF to store norms / index stats?&lt;/p&gt;

&lt;p&gt;Ie the two issues are orthogonal (and both are important!).&lt;/p&gt;</comment>
                    <comment id="12979328" author="yseeley@gmail.com" created="Sun, 9 Jan 2011 13:56:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we need to stop faking norms, independent of whether/when we cutover to CSF to store norms / index stats? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, it was only intended to be a short-term thing for back compat (see way back to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-448&quot; title=&quot;optional norms&quot;&gt;&lt;del&gt;LUCENE-448&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                    <comment id="12981226" author="rcmuir" created="Thu, 13 Jan 2011 12:00:23 +0000"  >&lt;p&gt;(Updating fix-version correctly, also).&lt;/p&gt;

&lt;p&gt;I think its safe to mark this resolved... the issues are totally cleared up in 4.0, &lt;br/&gt;
and only some (documented) corner cases in 3.x where we still use the default sim.&lt;/p&gt;</comment>
                    <comment id="13013294" author="gsingers" created="Wed, 30 Mar 2011 16:49:54 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12424654" name="Lucene-1260-1.patch" size="25636" author="johkin" created="Wed, 11 Nov 2009 21:43:06 +0000" />
                    <attachment id="12425766" name="Lucene-1260-2.patch" size="30421" author="johkin" created="Sun, 22 Nov 2009 19:14:13 +0000" />
                    <attachment id="12467796" name="LUCENE-1260_defaultsim.patch" size="4557" author="rcmuir" created="Sat, 8 Jan 2011 17:20:51 +0000" />
                    <attachment id="12411342" name="Lucene-1260.patch" size="22947" author="johkin" created="Sun, 21 Jun 2009 16:48:44 +0100" />
                    <attachment id="12380883" name="LUCENE-1260.txt" size="23342" author="karl.wettin" created="Fri, 25 Apr 2008 00:32:12 +0100" />
                    <attachment id="12379921" name="LUCENE-1260.txt" size="11878" author="karl.wettin" created="Fri, 11 Apr 2008 14:01:56 +0100" />
                    <attachment id="12379595" name="LUCENE-1260.txt" size="4832" author="karl.wettin" created="Mon, 7 Apr 2008 21:20:08 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>7.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 8 Apr 2008 20:45:21 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12488</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26468</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>