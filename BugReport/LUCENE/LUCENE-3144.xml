<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:21 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3144/LUCENE-3144.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3144] FreqProxTermsWriter leaks file handles if exceptions are thrown during flush()</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3144</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;FreqProxTermsWriter leaks open file handles if exceptions are thrown during flush. Code needs to be protected by try-finally clauses.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12508312">LUCENE-3144</key>
            <summary>FreqProxTermsWriter leaks file handles if exceptions are thrown during flush()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 May 2011 14:29:46 +0100</created>
                <updated>Fri, 3 Jun 2011 17:37:20 +0100</updated>
                    <resolved>Wed, 25 May 2011 19:18:27 +0100</resolved>
                                            <fixVersion>3.2</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13039136" author="shaie" created="Wed, 25 May 2011 15:06:21 +0100"  >&lt;p&gt;Patch against 3x, adds safeMaybe() versions to MockIOWrapper which closes the underlying IO on exception.&lt;/p&gt;

&lt;p&gt;However, TestIndexWriterExceptions.testDocumentsWriterAbort still leaves open file handles. On Windows, I put a break point in several places throughout the test, and even after IW.close() is called, I still see that .tii, .tis and .frq are being kept by the Java process.&lt;/p&gt;

&lt;p&gt;Is it a bug that we don&apos;t close them (in actual code, not test)? They have no references in MockDirWrapper ...&lt;/p&gt;</comment>
                    <comment id="13039158" author="shaie" created="Wed, 25 May 2011 16:24:59 +0100"  >&lt;p&gt;Turns out this is not a problem w/ MockDirWrapper and MockIOWrapper, but w/ FreqProxTermsWriter &amp;#8211; it didn&apos;t call its consumers&apos; .finish() in a finally clause, causing leaked file handles.&lt;/p&gt;

&lt;p&gt;The changes I&apos;ve done to MockIOWrapper cannot sustain, because if I keep them, then I hit an IOException from RandomAccessFile on &quot;handle is invalid&quot;, which is b/c I close the stream in MockIOWrapper, and now FreqProx (after the fix) tries to close() it too, on the go seeking to some location and writing something.&lt;/p&gt;

&lt;p&gt;Therefore, I think this is the only fix that&apos;s required for this issue (the FreqProxTermsWriter). If so, I will also rename it and add a CHANGES entry.&lt;/p&gt;</comment>
                    <comment id="13039169" author="mikemccand" created="Wed, 25 May 2011 16:50:57 +0100"  >&lt;p&gt;Looks great Shai!  Nice catch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13039176" author="rcmuir" created="Wed, 25 May 2011 16:58:08 +0100"  >&lt;p&gt;Thanks for tracking this one down Shai!&lt;/p&gt;

&lt;p&gt;After fixing this, is it then possible to fail lucene tests if we cannot delete the directory, or are there still issues with special tests?&lt;/p&gt;</comment>
                    <comment id="13039236" author="shaie" created="Wed, 25 May 2011 18:49:13 +0100"  >&lt;p&gt;I think that it will be good to fail the test if we fail to delete directories. Only problem is that on Linux it won&apos;t fail, which means we won&apos;t see build failures. I wonder if MockDirWrapper can catch that for us though ...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (noDeleteOpenFile &amp;amp;&amp;amp; openFiles.size() &amp;gt; 0) {
      &lt;span class=&quot;code-comment&quot;&gt;// print the first one as its very verbose otherwise
&lt;/span&gt;      Exception cause = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
      Iterator&amp;lt;Exception&amp;gt; stacktraces = openFileHandles.values().iterator();
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (stacktraces.hasNext())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I debug-traced the failures, I noticed that I never went inside the &apos;if&apos; even though noDeleteOpenFile was true. I&apos;m pretty sure that openFileHandles is not empty, b/c only MockIO/IIWrappers removes themselves from it. We should at least be able to report those handles that were open but never closed.&lt;/p&gt;

&lt;p&gt;I will commit this fix to 3x. I saw same file exists in trunk, so I&apos;ll fix it there too and try to catch any other failures.&lt;/p&gt;</comment>
                    <comment id="13039241" author="shaie" created="Wed, 25 May 2011 18:53:20 +0100"  >&lt;p&gt;Changed issue title and description.&lt;/p&gt;</comment>
                    <comment id="13039256" author="shaie" created="Wed, 25 May 2011 19:10:12 +0100"  >&lt;p&gt;I see that MockDirWrapper.createOutput does not add the IndexOutput to openFiles, only to openFileHandles, while openInput adds the IndexInput to both. Then MockIndexInput removes itself from the Map. Is it a bug?&lt;/p&gt;

&lt;p&gt;As a side note, and maybe a separate issue, I think we should improve the way MockII/IO interact w/ MockDirWrapper. Currently they access the maps directly, and I prefer them to be accessed via methods. That way we can better track what&apos;s going on on failures.&lt;/p&gt;</comment>
                    <comment id="13039260" author="shaie" created="Wed, 25 May 2011 19:18:27 +0100"  >&lt;p&gt;Resolving this issue. We can track the MockDir stuff separately.&lt;/p&gt;

&lt;p&gt;Committed revision 1127614 (3x).&lt;br/&gt;
Committed revision 1127615 (trunk).&lt;/p&gt;

&lt;p&gt;Thanks Mike and Robert for the review !&lt;/p&gt;</comment>
                    <comment id="13043529" author="rcmuir" created="Fri, 3 Jun 2011 17:37:20 +0100"  >&lt;p&gt;Bulk closing for 3.2&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12480421" name="LUCENE-3144.patch" size="13845" author="shaie" created="Wed, 25 May 2011 16:24:59 +0100" />
                    <attachment id="12480415" name="LUCENE-3144.patch" size="5604" author="shaie" created="Wed, 25 May 2011 15:06:21 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 25 May 2011 15:50:57 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2121</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24552</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>