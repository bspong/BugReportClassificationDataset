<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:10:31 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3627/LUCENE-3627.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3627] CorruptIndexException on indexing after a failure occurs after segments file creation but before any bytes are written</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3627</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;FSDirectory.createOutput(..) uses a RandomAccessFile to do its work.  On my system the default FSDirectory.open(..) creates an NIOFSDirectory.  If createOutput is called on a segments_* file and a crash occurs between RandomAccessFile creation (file system shows a segments_* file exists but has zero bytes) but before any bytes are written to the file, subsequent IndexWriters cannot proceed.  The difficulty is that it does not know how to clear the empty segments_* file.  None of the file deletions will happen on such a segment file because the opening bytes cannot not be read to determine format and version.&lt;/p&gt;

&lt;p&gt;An initial proposed patch file is attached below.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;lucene-3.5.0, src download from GA release lucene.apache.org.&lt;br/&gt;
Mac OS X 10.6.5, running tests in Eclipse Build id: 20100218-1602, &lt;br/&gt;
java version &quot;1.6.0_24&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_24-b07-334-10M3326)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 19.1-b02-334, mixed mode)&lt;/p&gt;</environment>
            <key id="12534241">LUCENE-3627</key>
            <summary>CorruptIndexException on indexing after a failure occurs after segments file creation but before any bytes are written</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="ken.mccracken">Ken McCracken</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Dec 2011 20:16:11 +0000</created>
                <updated>Fri, 10 May 2013 11:43:24 +0100</updated>
                    <resolved>Thu, 8 Dec 2011 20:26:34 +0000</resolved>
                            <version>3.5</version>
                                <fixVersion>3.6</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>2</votes>
                        <watches>1</watches>
                          <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                    <timeestimate seconds="172800">48h</timeestimate>
                                  <comments>
                    <comment id="13164670" author="ken.mccracken" created="Wed, 7 Dec 2011 20:18:02 +0000"  >&lt;p&gt;Drop this file in src/test/org/apache/lucene/store for the lucene 3.5.0 source release, and run your unit tests with junit4.&lt;/p&gt;</comment>
                    <comment id="13164816" author="ken.mccracken" created="Wed, 7 Dec 2011 23:07:35 +0000"  >&lt;p&gt;I have been reviewing &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3255&quot; class=&quot;external-link&quot;&gt;https://issues.apache.org/jira/browse/LUCENE-3255&lt;/a&gt; which seems related in that the error is encountered on the same section of SegmentInfos.java.&lt;br/&gt;
One way to fix this might be to change SegmentInfos.java as follows where int format = input.readInt(); to&lt;/p&gt;

&lt;p&gt;        int format;&lt;br/&gt;
        try &lt;/p&gt;
{
            format = input.readInt();
        }
&lt;p&gt; catch (IOException ioe) {&lt;br/&gt;
            if (input.length() == 0) {&lt;br/&gt;
                try &lt;/p&gt;
{
                    input.close();
                }
&lt;p&gt; finally &lt;/p&gt;
{
                    directory.deleteFile(segmentFileName);
                }
&lt;p&gt;                return;&lt;br/&gt;
            }&lt;br/&gt;
            throw ioe;&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;however, there are unit tests that seem to verify that no file deletions are happening at this low a level.  &lt;/p&gt;</comment>
                    <comment id="13164837" author="ken.mccracken" created="Wed, 7 Dec 2011 23:35:44 +0000"  >&lt;p&gt;Initial proposed patch.  I&apos;m not sure if this is the correct place and scope.  But it does fix my test case.&lt;br/&gt;
The test case and the proposed code change are attached.&lt;/p&gt;

&lt;p&gt;aaa:lucene kmccrack$ svn info&lt;br/&gt;
Path: .&lt;br/&gt;
URL: &lt;a href=&quot;http://svn.apache.org/repos/asf/lucene/dev/branches/lucene_solr_3_5/lucene&quot; class=&quot;external-link&quot;&gt;http://svn.apache.org/repos/asf/lucene/dev/branches/lucene_solr_3_5/lucene&lt;/a&gt;&lt;br/&gt;
Repository Root: &lt;a href=&quot;http://svn.apache.org/repos/asf&quot; class=&quot;external-link&quot;&gt;http://svn.apache.org/repos/asf&lt;/a&gt;&lt;br/&gt;
Repository UUID: 13f79535-47bb-0310-9956-ffa450edef68&lt;br/&gt;
Revision: 1211687&lt;br/&gt;
Node Kind: directory&lt;br/&gt;
Schedule: normal&lt;br/&gt;
Last Changed Author: sarowe&lt;br/&gt;
Last Changed Rev: 1207561&lt;br/&gt;
Last Changed Date: 2011-11-28 15:11:35 -0500 (Mon, 28 Nov 2011)&lt;/p&gt;</comment>
                    <comment id="13165167" author="mikemccand" created="Thu, 8 Dec 2011 11:47:06 +0000"  >
&lt;p&gt;Thanks Ken!&lt;/p&gt;

&lt;p&gt;I attached a new patch, whittling back the test a bit (while still&lt;br/&gt;
showing the bug), fixing whitespace, etc.&lt;/p&gt;

&lt;p&gt;I also removed the @author tags (we don&apos;t attach names to the source&lt;br/&gt;
code...).&lt;/p&gt;

&lt;p&gt;I fixed the bug in two places.  First, when writing the segments file,&lt;br/&gt;
I moved the createOutput in SegmentInfos.java inside the try/finally&lt;br/&gt;
that deletes the file if an exception occurs.  This way we shouldn&apos;t&lt;br/&gt;
create 0-byte segments_N anymore.&lt;/p&gt;

&lt;p&gt;Second, in IndexFileDeleter I ignore a given segments_N if it&apos;s 0&lt;br/&gt;
bytes; I don&apos;t delete the file at that point because IFD&apos;s normal&lt;br/&gt;
ref-counting will eventually remove it.&lt;/p&gt;</comment>
                    <comment id="13165170" author="shaie" created="Thu, 8 Dec 2011 11:57:13 +0000"  >&lt;p&gt;Nice catch Ken !&lt;/p&gt;

&lt;p&gt;Patch looks good to me. Perhaps replace the msg &quot;code will not get here&quot; with &quot;should have hit CrashException&quot;? Otherwise, +1 to commit.&lt;/p&gt;</comment>
                    <comment id="13165228" author="shanedetsch" created="Thu, 8 Dec 2011 14:43:30 +0000"  >&lt;p&gt;Would you ever have the case there only one &quot;segements_N&quot; file is corrupt &apos;i.e. 0 size&apos;? If so how would another &quot;segments_N&quot; file be regenerated?  Does this 0-sized &quot;segments_N&quot; file always happen on a newly generated &quot;segmetns_N&quot; and &quot;segments_N-1&quot; still exist and is considered active?  After deletion of the 0-sized &quot;segments_N&quot; file is there a process to make sure that the currently active &quot;segmetns_N&quot; (not the 0-sized one) accurately represents the segments in the index?&lt;/p&gt;</comment>
                    <comment id="13165461" author="mikemccand" created="Thu, 8 Dec 2011 19:25:39 +0000"  >
&lt;blockquote&gt;&lt;p&gt;Would you ever have the case there only one &quot;segements_N&quot; file is corrupt &apos;i.e. 0 size&apos;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, unless something terrible is going on, such as your IO system&lt;br/&gt;
disregards fsync, you have hardware problems, or something external is&lt;br/&gt;
mucking with the index files.&lt;/p&gt;

&lt;p&gt;When Lucene commits it writes the next segments_N, fsyncs it (and all&lt;br/&gt;
index file it references) and then removes old commits; so the old&lt;br/&gt;
commits are not removed until the new one is on durable storage.&lt;/p&gt;

&lt;p&gt;I think the conditions for this bug to occur are very rare, ie, lucene&lt;br/&gt;
tried to commit, hit a transient IO problem in creating the file (so&lt;br/&gt;
that a 0 byte file is created), your app caught this and called&lt;br/&gt;
IW.close, this time the transient IO problem is gone and the close&lt;br/&gt;
succeeds in writing another segments_N file.  At that point you&apos;d hit&lt;br/&gt;
this bug when you next tried to open an IndexWriter on the index.&lt;/p&gt;

&lt;p&gt;The more common failure would be if the segments_N fails to write (0&lt;br/&gt;
byte file) and then when you close the IW it also fails, ie, because&lt;br/&gt;
something suddenly is wrong w/ your IO system.  In this case your&lt;br/&gt;
&quot;latest&quot; segments_N is unreadable, and Lucene handles that fine (falls&lt;br/&gt;
back to segments_(N-1), which should be ok because it was fsync&apos;d).&lt;/p&gt;</comment>
                    <comment id="13165487" author="ken.mccracken" created="Thu, 8 Dec 2011 19:54:06 +0000"  >&lt;p&gt;Thank you Mike for cleaning my suggestions up.  I am validating and reviewing currently...&lt;/p&gt;

&lt;p&gt;What is the svn revision branch this patch would get checked in to?&lt;/p&gt;</comment>
                    <comment id="13165522" author="mikemccand" created="Thu, 8 Dec 2011 20:27:59 +0000"  >&lt;p&gt;Thanks Ken!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What is the svn revision branch this patch would get checked in to?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oh, I checked into 3.x (to be 3.6.0) and trunk... if you select the &quot;All&quot; tab here, under Activity, you can see the full SVN paths...&lt;/p&gt;</comment>
                    <comment id="13165560" author="ken.mccracken" created="Thu, 8 Dec 2011 21:08:22 +0000"  >&lt;p&gt;@Mike:  My initial validation confirms your suggested patch works for me.  Thank you.&lt;/p&gt;</comment>
                    <comment id="13166432" author="mikemccand" created="Fri, 9 Dec 2011 18:47:56 +0000"  >&lt;p&gt;Awesome, thanks Ken!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12506539" name="LUCENE-3627_initial_proposal.txt" size="13988" author="ken.mccracken" created="Wed, 7 Dec 2011 23:35:44 +0000" />
                    <attachment id="12506600" name="LUCENE-3627.patch" size="10512" author="mikemccand" created="Thu, 8 Dec 2011 11:47:06 +0000" />
                    <attachment id="12506505" name="TestCrashCausesCorruptIndex.java" size="11235" author="ken.mccracken" created="Wed, 7 Dec 2011 20:18:02 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 8 Dec 2011 11:47:06 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>219964</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24071</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>