<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 12:57:51 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1449/LUCENE-1449.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1449] IndexDeletionPolicy.delete behaves incorrectly when deleting latest generation </title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1449</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;I have been looking to provide the ability to rollback committed transactions and encountered some issues.&lt;br/&gt;
I appreciate IndexDeletionPolicy&apos;s main motivation is to handle cleaning away OLD commit points but it does not explicitly state that it can or cannot be used to clean NEW commit points.&lt;/p&gt;

&lt;p&gt;If this is not supported then the documentation should ideally state this. If the intention is to support this behaviour then read on .......&lt;/p&gt;

&lt;p&gt;There seem to be 2 issues so far:&lt;br/&gt;
1) The first attempt to call IndexCommit.delete on the latest commit point fails to remove any contents. The subsequent call succeeds however&lt;br/&gt;
2) Deleting the latest commit point fails to update the segments.gen file to point to segments_N-1. New IndexReaders that are opened are then misdirected to open segments_N which has been deleted&lt;/p&gt;

&lt;p&gt;Junit test to follow...&lt;/p&gt;
</description>
                <environment></environment>
            <key id="12408247">LUCENE-1449</key>
            <summary>IndexDeletionPolicy.delete behaves incorrectly when deleting latest generation </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="markh">Mark Harwood</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Nov 2008 14:51:45 +0000</created>
                <updated>Fri, 25 Sep 2009 17:23:13 +0100</updated>
                    <resolved>Tue, 11 Nov 2008 22:42:34 +0000</resolved>
                            <version>2.9</version>
                                <fixVersion>2.9</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12646561" author="markh" created="Tue, 11 Nov 2008 14:53:13 +0000"  >&lt;p&gt;Junit test&lt;/p&gt;</comment>
                    <comment id="12646582" author="mikemccand" created="Tue, 11 Nov 2008 16:13:21 +0000"  >&lt;p&gt;Sneaky!&lt;/p&gt;

&lt;p&gt;There is indeed a bug here, but once we fix it, you won&apos;t be able to&lt;br/&gt;
do rollback by opening the latest commit point.&lt;/p&gt;

&lt;p&gt;But, &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1411&quot; title=&quot;Enable IndexWriter to open an arbitrary commit point&quot;&gt;&lt;del&gt;LUCENE-1411&lt;/del&gt;&lt;/a&gt; (recently committed to 2.9) will work: it lets you&lt;br/&gt;
open IndexWriter on an arbitrary commit point.&lt;/p&gt;

&lt;p&gt;Your deletion policy then gets to decide what to do with the now&lt;br/&gt;
future commit points (ie, you can keep them around), and when you next&lt;br/&gt;
commit, it&apos;s written to the segments_N after all future commit points.&lt;br/&gt;
Ie, it&apos;s like using svn to revert a bunch of changes: the changes&lt;br/&gt;
still live in prior commit points; it&apos;s just that your next commit has&lt;br/&gt;
removed those changes.&lt;/p&gt;

&lt;p&gt;Conceptually, when IndexWriter opens and loads a commit point, either&lt;br/&gt;
one you explicitly specified, or, the most recent one by default, it&lt;br/&gt;
holds open a private in-memory-only commit point which you can&apos;t&lt;br/&gt;
delete.  You can delete the commit points on disk, but the one in&lt;br/&gt;
memory is private to IndexWriter and moves forward as segments are&lt;br/&gt;
flushed, merged, etc.  When IndexWriter commits, it makes a new&lt;br/&gt;
on-disk commit point that&apos;s a copy of the in-memory one.&lt;/p&gt;

&lt;p&gt;This bug is happening because when IndexWriter commits (during close),&lt;br/&gt;
it thinks there are no pending changes and so does nothing.  But,&lt;br/&gt;
there was a change (you removed the last commit point), and so I think&lt;br/&gt;
we should mark doing so as a real change.  What this will mean is&lt;br/&gt;
IndexWriter will simply write the next segments_N file which is a copy&lt;br/&gt;
of the one you had just deleted.&lt;/p&gt;</comment>
                    <comment id="12646614" author="markh" created="Tue, 11 Nov 2008 18:11:29 +0000"  >&lt;p&gt;Thanks for the pointers, Mike.&lt;/p&gt;

&lt;p&gt;This new test now passes having made a few changes.&lt;/p&gt;</comment>
                    <comment id="12646675" author="mikemccand" created="Tue, 11 Nov 2008 21:45:20 +0000"  >&lt;p&gt;Excellent!&lt;/p&gt;

&lt;p&gt;I modified your test &amp;#8211; cleaned up whitespace, removed the @author tag, and put back a modified failing test case from your original (to show the bug that we still need to fix).&lt;/p&gt;

&lt;p&gt;Next I&apos;ll work on fixing the bug so that test case passes.&lt;/p&gt;</comment>
                    <comment id="12646690" author="mikemccand" created="Tue, 11 Nov 2008 22:10:59 +0000"  >&lt;p&gt;OK I attached a new patch, this time including the simple fix, which is for IndexWriter to mark itself as having pending changes whenever the head commit point gets deleted by the deletion policy on init.&lt;/p&gt;

&lt;p&gt;I will commit shortly.&lt;/p&gt;</comment>
                    <comment id="12646707" author="mikemccand" created="Tue, 11 Nov 2008 22:42:34 +0000"  >&lt;p&gt;Committed revision 713206.&lt;/p&gt;

&lt;p&gt;Thanks Mark!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12393735" name="LUCENE-1449.patch" size="9806" author="mikemccand" created="Tue, 11 Nov 2008 22:10:58 +0000" />
                    <attachment id="12393732" name="LUCENE-1449.patch" size="8197" author="mikemccand" created="Tue, 11 Nov 2008 21:45:20 +0000" />
                    <attachment id="12393717" name="TestTransactionRollbackCapability2.java" size="6700" author="markh" created="Tue, 11 Nov 2008 18:11:29 +0000" />
                    <attachment id="12393706" name="TestTransactionRollbackCapability.java" size="8136" author="markh" created="Tue, 11 Nov 2008 14:53:13 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 11 Nov 2008 16:13:21 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12302</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26278</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>