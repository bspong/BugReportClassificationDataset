<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:32:10 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3412/LUCENE-3412.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3412] SloppyPhraseScorer returns non-deterministic results for queries with many repeats</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3412</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Proximity queries with many repeats (four or more, based on my testing) return non-deterministic results. I run the same query multiple times with the same data set and get different results.&lt;/p&gt;

&lt;p&gt;So far I&apos;ve reproduced this with Solr 1.4.1, 3.1, 3.2, 3.3, and latest 4.0 trunk.&lt;/p&gt;

&lt;p&gt;Steps to reproduce (using the Solr example):&lt;br/&gt;
1) In solrconfig.xml, set queryResultCache size to 0.&lt;br/&gt;
2) Add some documents with text &quot;dog dog dog&quot; and &quot;dog dog dog dog&quot;. &lt;a href=&quot;http://localhost:8983/solr/update?stream.body=%3Cadd%3E%3Cdoc%3E%3Cfield%20name=%22id%22%3E1%3C/field%3E%3Cfield%20name=%22text%22%3Edog%20dog%20dog%3C/field%3E%3C/doc%3E%3Cdoc%3E%3Cfield%20name=%22id%22%3E2%3C/field%3E%3Cfield%20name=%22text%22%3Edog%20dog%20dog%20dog%3C/field%3E%3C/doc%3E%3C/add%3E&amp;amp;commit=true&quot; class=&quot;external-link&quot;&gt;http://localhost:8983/solr/update?stream.body=%3Cadd%3E%3Cdoc%3E%3Cfield%20name=%22id%22%3E1%3C/field%3E%3Cfield%20name=%22text%22%3Edog%20dog%20dog%3C/field%3E%3C/doc%3E%3Cdoc%3E%3Cfield%20name=%22id%22%3E2%3C/field%3E%3Cfield%20name=%22text%22%3Edog%20dog%20dog%20dog%3C/field%3E%3C/doc%3E%3C/add%3E&amp;amp;commit=true&lt;/a&gt;&lt;br/&gt;
3) Do a &quot;dog dog dog dog&quot;~1 query. &lt;a href=&quot;http://localhost:8983/solr/select?q=%22dog%20dog%20dog%20dog%22~1&quot; class=&quot;external-link&quot;&gt;http://localhost:8983/solr/select?q=%22dog%20dog%20dog%20dog%22~1&lt;/a&gt;&lt;br/&gt;
4) Repeat step 3 many times.&lt;/p&gt;

&lt;p&gt;Expected results: The document with id 2 should be returned.&lt;/p&gt;

&lt;p&gt;Actual results: The document with id 2 is always returned. The document with id 1 is sometimes returned.&lt;/p&gt;

&lt;p&gt;Different proximity values show the same bug - &quot;dog dog dog dog&quot;~5, &quot;dog dog dog dog&quot;~100, etc show the same behavior.&lt;/p&gt;

&lt;p&gt;So far I&apos;ve traced it down to the &quot;repeats&quot; array in SloppyPhraseScorer.initPhrasePositions() - depending on the order of the elements in this array, the document may or may not match. I think the HashSet may be to blame, but I&apos;m not sure - that at least seems to be where the non-determinism is coming from.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12521230">LUCENE-3412</key>
            <summary>SloppyPhraseScorer returns non-deterministic results for queries with many repeats</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="michaelryan">Michael Ryan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Sep 2011 22:09:03 +0100</created>
                <updated>Sun, 27 Nov 2011 12:29:32 +0000</updated>
                    <resolved>Thu, 8 Sep 2011 09:23:53 +0100</resolved>
                            <version>3.1</version>
                <version>3.2</version>
                <version>3.3</version>
                <version>4.0-ALPHA</version>
                                <fixVersion>3.5</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13096308" author="rcmuir" created="Fri, 2 Sep 2011 22:20:28 +0100"  >&lt;p&gt;This issue could also be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3215&quot; title=&quot;SloppyPhraseScorer sometimes computes Infinite freq&quot;&gt;&lt;del&gt;LUCENE-3215&lt;/del&gt;&lt;/a&gt;: in some cases with repeats, sloppy phrasescorer returns scores of Infinity... what scores are you getting?&lt;/p&gt;

&lt;p&gt;However, I don&apos;t think its a duplicate issue, with &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3215&quot; title=&quot;SloppyPhraseScorer sometimes computes Infinite freq&quot;&gt;&lt;del&gt;LUCENE-3215&lt;/del&gt;&lt;/a&gt; the issue is when you have sloppyphrasequery + repeats + positionIncrements &amp;gt; 1 (e.g. stopwords and enablePositionIncrements=true, the default)&lt;/p&gt;</comment>
                    <comment id="13096344" author="michaelryan" created="Fri, 2 Sep 2011 22:46:08 +0100"  >&lt;p&gt;Here&apos;s the debugQuery output from when it matched both docs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;lst name=&quot;explain&quot;&amp;gt;&amp;lt;str name=&quot;2&quot;&amp;gt;
1.1890696 = (MATCH) weight(text:&quot;dog dog dog dog&quot;~1 in 1) [DefaultSimilarity], result of:
  1.1890696 = score(doc=1,freq=1.0 = phraseFreq=1.0
), product of:
    0.99999994 = queryWeight, product of:
      2.3781395 = idf(), sum of:
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
      0.42049676 = queryNorm
    1.1890697 = fieldWeight in 1, product of:
      1.0 = tf(freq=1.0), with freq of:
        1.0 = phraseFreq=1.0
      2.3781395 = idf(), sum of:
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
      0.5 = fieldNorm(doc=1)
&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;1&quot;&amp;gt;
0.8407992 = (MATCH) weight(text:&quot;dog dog dog dog&quot;~1 in 0) [DefaultSimilarity], result of:
  0.8407992 = score(doc=0,freq=0.5 = phraseFreq=0.5
), product of:
    0.99999994 = queryWeight, product of:
      2.3781395 = idf(), sum of:
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
      0.42049676 = queryNorm
    0.8407993 = fieldWeight in 0, product of:
      0.70710677 = tf(freq=0.5), with freq of:
        0.5 = phraseFreq=0.5
      2.3781395 = idf(), sum of:
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
      0.5 = fieldNorm(doc=0)
&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sometimes when it matches both docs I&apos;ll get &quot;no matching term&quot; for the second one:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;lst name=&quot;explain&quot;&amp;gt;&amp;lt;str name=&quot;2&quot;&amp;gt;
1.1890696 = (MATCH) weight(text:&quot;dog dog dog dog&quot;~1 in 1) [DefaultSimilarity], result of:
  1.1890696 = score(doc=1,freq=1.0 = phraseFreq=1.0
), product of:
    0.99999994 = queryWeight, product of:
      2.3781395 = idf(), sum of:
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
      0.42049676 = queryNorm
    1.1890697 = fieldWeight in 1, product of:
      1.0 = tf(freq=1.0), with freq of:
        1.0 = phraseFreq=1.0
      2.3781395 = idf(), sum of:
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
        0.5945349 = idf(docFreq=2, maxDocs=2)
      0.5 = fieldNorm(doc=1)
&amp;lt;/str&amp;gt;&amp;lt;str name=&quot;1&quot;&amp;gt;
0.0 = (NON-MATCH) no matching term
&amp;lt;/str&amp;gt;&amp;lt;/lst&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13097779" author="doronc" created="Tue, 6 Sep 2011 08:44:00 +0100"  >&lt;p&gt;I am able to see this inconsistent behavior!&lt;/p&gt;

&lt;p&gt;Attached patch contains a test that fails on this. The test currently prints the trial number, and the first loop always pass in all 30 trials (expected) while the second loop always fail (for me) but is inconsistent about when it fails. Sometimes, it fails on the first iteration. Some other times it fails on the 3rd, 9th, etc.&lt;/p&gt;

&lt;p&gt;Quite peculiar... investigating...&lt;/p&gt;</comment>
                    <comment id="13098869" author="doronc" created="Wed, 7 Sep 2011 13:03:29 +0100"  >&lt;p&gt;Attached patch with fix to this bug.&lt;/p&gt;

&lt;p&gt;The fix is rather simple, - just process PP&apos;s in offset order. That is, when avoiding conflicts (a conflict means: more than a single query PP is landing on the same doc TP), make sure to handle PPs in a specific order: from first in query to last in query. &lt;/p&gt;

&lt;p&gt;This is crucial because the check for conflicts returns the PP with greater offset, and that one is advanced.&lt;/p&gt;

&lt;p&gt;It was pretty quick to fix this, but took longer to justify the fix.&lt;/p&gt;

&lt;p&gt;I added some explanations in the code so that next time justification would be faster &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and also renamed termPositionsDiffer() to termPositionsConflict() which more accurately describes the logic of that method.&lt;/p&gt;

&lt;p&gt;now need to see if this fix is also related to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3215&quot; title=&quot;SloppyPhraseScorer sometimes computes Infinite freq&quot;&gt;&lt;del&gt;LUCENE-3215&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="13099627" author="michaelryan" created="Wed, 7 Sep 2011 23:43:31 +0100"  >&lt;p&gt;Thanks, Doron. I&apos;ve tried applying your patch to Solr 3.2 and it is working well so far.&lt;/p&gt;</comment>
                    <comment id="13100098" author="doronc" created="Thu, 8 Sep 2011 07:11:00 +0100"  >&lt;p&gt;Thanks Michael for verifying this, I&apos;ll go ahead and commit.&lt;/p&gt;</comment>
                    <comment id="13100152" author="doronc" created="Thu, 8 Sep 2011 09:23:53 +0100"  >&lt;p&gt;Fix committed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;r1166541 - trunk&lt;/li&gt;
	&lt;li&gt;r1166563 - 3x&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(fix not included in 3.4 RC, therefore marked as 3.5 above)&lt;/p&gt;</comment>
                    <comment id="13157791" author="thetaphi" created="Sun, 27 Nov 2011 12:29:32 +0000"  >&lt;p&gt;Bulk close after release of 3.5&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12493306" name="LUCENE-3412.patch" size="7299" author="doronc" created="Wed, 7 Sep 2011 13:03:29 +0100" />
                    <attachment id="12493123" name="LUCENE-3412.patch" size="1851" author="doronc" created="Tue, 6 Sep 2011 08:44:00 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 2 Sep 2011 21:20:28 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2699</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24284</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>