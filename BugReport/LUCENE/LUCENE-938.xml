<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:24:54 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-938/LUCENE-938.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-938] I/O exceptions can cause loss of buffered deletes</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-938</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Some I/O exceptions that result in segmentInfos rollback operations can cause buffered deletes that existed before the rollback creation point to be incorrectly lost when the IOException triggers a rollback.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12372167">LUCENE-938</key>
            <summary>I/O exceptions can cause loss of buffered deletes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="steven_parkes">Steven Parkes</assignee>
                                <reporter username="steven_parkes">Steven Parkes</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Jun 2007 22:45:15 +0100</created>
                <updated>Fri, 25 Jan 2008 03:23:58 +0000</updated>
                    <resolved>Fri, 13 Jul 2007 15:24:07 +0100</resolved>
                                            <fixVersion>2.3</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12507043" author="steven_parkes" created="Thu, 21 Jun 2007 22:51:02 +0100"  >&lt;p&gt;Patch that fixes the two relevant rollback mechanisms in IndexWriter: the rollback support in mergeSegments around maybeApplyDeletes and the rollback support in  the *Transaction methods. For the later, I had to promote the transaction routines from private to package protected so that I could write the tests, which are also in the patch.&lt;/p&gt;</comment>
                    <comment id="12507050" author="mikemccand" created="Thu, 21 Jun 2007 23:11:46 +0100"  >&lt;p&gt;Wow, good catch and nice unit test!&lt;/p&gt;</comment>
                    <comment id="12507052" author="steven_parkes" created="Thu, 21 Jun 2007 23:16:03 +0100"  >&lt;p&gt;Only it&apos;s broke. Mixing a couple of things, I missed a couple of tests that I broke. That&apos;s what I get for coding with a cold. Another fix soon.&lt;/p&gt;

&lt;p&gt;And I was going to mention that I added support in the mock directory stuff for injecting deterministic I/O errors. Should help us capture tricky corner cases where we need to.&lt;/p&gt;</comment>
                    <comment id="12507063" author="steven_parkes" created="Thu, 21 Jun 2007 23:51:31 +0100"  >&lt;p&gt;This version has the missing fixes that got tossed when I tried to clean up that patch.&lt;/p&gt;</comment>
                    <comment id="12510234" author="mikemccand" created="Wed, 4 Jul 2007 20:19:59 +0100"  >&lt;p&gt;Steve, I re-worked this patch now that &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-843&quot; title=&quot;improve how IndexWriter uses RAM to buffer added documents&quot;&gt;&lt;del&gt;LUCENE-843&lt;/del&gt;&lt;/a&gt; is committed (it&lt;br/&gt;
conflicted) and am attaching it (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-938&quot; title=&quot;I/O exceptions can cause loss of buffered deletes&quot;&gt;&lt;del&gt;LUCENE-938&lt;/del&gt;&lt;/a&gt;.take2.patch).  It&apos;s the&lt;br/&gt;
same logic as before.  If it looks good to you I can commit it!&lt;/p&gt;</comment>
                    <comment id="12510235" author="steven_parkes" created="Wed, 4 Jul 2007 20:26:57 +0100"  >&lt;p&gt;Thanks. I figured there&apos;d be conflicts.&lt;/p&gt;

&lt;p&gt;I won&apos;t be able to look at this until next week ...&lt;/p&gt;</comment>
                    <comment id="12510422" author="ningli" created="Thu, 5 Jul 2007 18:47:23 +0100"  >&lt;p&gt;Good catch, Steven!&lt;/p&gt;

&lt;p&gt;One thing though: I thought we had assumed that there wouldn&apos;t be any buffered docs or delete terms when startTransaction(), so no local copies are necessary. That means no change to startTransaction() and rollbackTransaction(). If there could be buffered docs and delete terms when startTransaction(), then local copies should be made for buffered docs and localNumBufferedDeleteTerms should clone numBufferedDeleteTerms instead of just copying the reference.&lt;/p&gt;</comment>
                    <comment id="12512249" author="steven_parkes" created="Thu, 12 Jul 2007 21:33:55 +0100"  >&lt;p&gt;Easy first: there&apos;s a comment in the code about cloning the buf delete term hash with a clear vs. copying the reference and creating a new hash. I&apos;ve gone back and forth. I don&apos;t have a strong opinion.&lt;/p&gt;

&lt;p&gt;I did notice that every call to startTransaction had flushed the deletes ahead but I didn&apos;t see that it was required to be so. I can go either way on this, too. I&apos;d vote for making startTransaction safer.  I think, in theory, it could be opened to users at some point, if it were to help people trying to use Lucene in certain transactional contexts.&lt;/p&gt;

&lt;p&gt;Of course, that violates YAGNI.&lt;/p&gt;

&lt;p&gt;But I hadn&apos;t looked at the ram segments. Does look like if there are any at the start of a trans. and they get flushed, they would/might get lost? Since that touches on the index file deleter, it strikes me as more complex.&lt;/p&gt;</comment>
                    <comment id="12512271" author="ningli" created="Thu, 12 Jul 2007 22:45:37 +0100"  >&lt;p&gt;I didn&apos;t make myself clear. Let me try again. The patch includes two parts of changes to IndexWriter: one adds localNumBufferedDeleteTerms and localBufferedDeleteTerms and uses them in startTransaction() and rollbackTransaction(); the other fixes loss of buffered deletes in flush() (and applyDeletes() which is used by flush()).&lt;/p&gt;

&lt;p&gt;The second part is good and that&apos;s where you had the comment on cloning.&lt;/p&gt;

&lt;p&gt;I was referring to the first part. In startTransaction(), &quot;localBufferedDeleteTerms = bufferedDeleteTerms&quot; reference-copies bufferedDeleteTerms. Then more delete terms are buffered into bufferedDeleteTerms... so localBufferedDeleteTerms would have the delete terms buffered between startTransaction() and the first flush()... &lt;/p&gt;</comment>
                    <comment id="12512274" author="steven_parkes" created="Thu, 12 Jul 2007 22:59:20 +0100"  >&lt;p&gt;Okay. Got it.&lt;/p&gt;

&lt;p&gt;But your earlier note got me thinking. Mike, as far as I can tell, the 843 buffered docs stuff isn&apos;t getting restored around a transaction? Or am I missing something? Are you assuming flush is called before startTransaction?&lt;/p&gt;</comment>
                    <comment id="12512287" author="mikemccand" created="Thu, 12 Jul 2007 23:21:50 +0100"  >&lt;p&gt;Ahh, right, we are not protecting buffered doc state inside the local&lt;br/&gt;
transaction.  And actually doing so would not be very easy.&lt;/p&gt;

&lt;p&gt;I would say we require that there are no buffered docs nor deletes&lt;br/&gt;
when startTransaction() is called.  The code guarantees that now but&lt;br/&gt;
how about we doc this limitation and put an assert in there to make&lt;br/&gt;
sure?&lt;/p&gt;

&lt;p&gt;These methods were added only for protecting the index during the&lt;br/&gt;
addIndexes* calls; if in the future we somehow want to make them more&lt;br/&gt;
powerful I think we can fix it then...&lt;/p&gt;</comment>
                    <comment id="12512289" author="steven_parkes" created="Thu, 12 Jul 2007 23:25:29 +0100"  >&lt;p&gt;Works for me. I&apos;ll submit a new patch.&lt;/p&gt;</comment>
                    <comment id="12512298" author="steven_parkes" created="Thu, 12 Jul 2007 23:55:14 +0100"  >&lt;p&gt;New patch. Removes support for buf deletes around transactions but documents and asserts this.&lt;/p&gt;

&lt;p&gt;Fixes a few typos in the comments.&lt;/p&gt;</comment>
                    <comment id="12512494" author="mikemccand" created="Fri, 13 Jul 2007 15:20:32 +0100"  >&lt;p&gt;This patch looks great!  Thanks Steve.  I&apos;ll commit it shortly.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12361722" name="LUCENE-938.patch.txt" size="10667" author="steven_parkes" created="Thu, 12 Jul 2007 23:55:14 +0100" />
                    <attachment id="12361151" name="LUCENE-938.take2.patch" size="17638" author="mikemccand" created="Wed, 4 Jul 2007 20:19:59 +0100" />
                    <attachment id="12360328" name="LUCENE-938.txt" size="18155" author="steven_parkes" created="Thu, 21 Jun 2007 23:51:31 +0100" />
                    <attachment id="12360326" name="LUCENE-938.txt" size="18084" author="steven_parkes" created="Thu, 21 Jun 2007 22:51:01 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 21 Jun 2007 22:11:46 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12804</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26791</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>