<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:13:51 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2907/LUCENE-2907.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2907] automaton termsenum bug when running with multithreaded search</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2907</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;This one popped in hudson (with a test that runs the same query against fieldcache, and with a filter rewrite, and compares results)&lt;/p&gt;

&lt;p&gt;However, its actually worse and unrelated to the fieldcache: you can set both to filter rewrite and it will still fail.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12497769">LUCENE-2907</key>
            <summary>automaton termsenum bug when running with multithreaded search</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png">Resolved</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="rcmuir">Robert Muir</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Sat, 5 Feb 2011 23:57:30 +0000</created>
                <updated>Sun, 6 Feb 2011 18:43:55 +0000</updated>
                    <resolved>Sun, 6 Feb 2011 18:17:34 +0000</resolved>
                                                                    <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12991087" author="rcmuir" created="Sun, 6 Feb 2011 00:00:04 +0000"  >&lt;p&gt;by printing seeks its easy to see, its not related to automaton.&lt;/p&gt;

&lt;p&gt;i created files per-segment printing the seeks (and what the terms enum hands back)... here&apos;s the diff&lt;/p&gt;

&lt;p&gt;so when it fails, automaton seeks to seek:&lt;span class=&quot;error&quot;&gt;&amp;#91;7f 2f e6 8c b0 ce 8d d2 8b cb ae f4 84 b2 a2&amp;#93;&lt;/span&gt; and the termsenum skips over a large portion of the terms and returns the wrong result.&lt;/p&gt;</comment>
                    <comment id="12991088" author="rcmuir" created="Sun, 6 Feb 2011 00:03:23 +0000"  >&lt;p&gt;here are the two files that I diffed, but note, this isnt the only segment that had wrong seeks... its just an example&lt;/p&gt;</comment>
                    <comment id="12991089" author="rcmuir" created="Sun, 6 Feb 2011 00:07:27 +0000"  >&lt;p&gt;here&apos;s my patch to make the test more easily to reproduce (it simply runs the exact same query, against the same index over and over again until it pops!)&lt;/p&gt;

&lt;p&gt;Also it logs the seeks to the files, because otherwise its too much to try to look at.&lt;/p&gt;

&lt;p&gt;just use the original commandline to reproduce:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
ant test 
-Dtestcase=TestFieldCacheRewriteMethod -Dtestmethod=testRegexps
-Dtests.seed=4072768173808710270:-6218549422363059201
-Dtests.multiplier=3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12991130" author="thetaphi" created="Sun, 6 Feb 2011 09:25:06 +0000"  >&lt;p&gt;Have you found out what happens or where a thread-safety issue could be? Each thread and each query should have its own TermsEnum! Is there maybe a cache on codec-level involved? At least there are no multiple-instance (static) caches in the  search-side of the TermsEnums, so there must be a multi-threading issue in the underlying SegmentReaders.&lt;/p&gt;

&lt;p&gt;To conclude: At least Robert found out that FieldCacheTermsEnum always works correct? Is this true? The information on this issue is too small, there seems to be lots of IRC/GTalk communication in parallel.&lt;/p&gt;</comment>
                    <comment id="12991133" author="rcmuir" created="Sun, 6 Feb 2011 09:43:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Have you found out what happens or where a thread-safety issue could be?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, i found the bug... unfortunately it is actually my automaton problem &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I will create a nice patch today.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The information on this issue is too small, there seems to be lots of IRC/GTalk communication in parallel.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;what do you mean? mike was working a long time on the bug, but quickly had to stop working on it, so he emailed me all of his state. I took over from there for a while, and i opened this issue with my debugging... though I didn&apos;t have much time to work on it yesterday (only like 1 hour), because I already had plans.&lt;/p&gt;

&lt;p&gt;I tried to be completely open and dump all of my state/debugging information/brainstorming on this JIRA issue, but it only resulted in me reporting misleading and confusing information... so I think the information on this issue is actually too much?&lt;/p&gt;</comment>
                    <comment id="12991137" author="thetaphi" created="Sun, 6 Feb 2011 10:09:49 +0000"  >&lt;p&gt;A bug in automaton that only hapoens in multi-threaded? So its the cache there?&lt;/p&gt;</comment>
                    <comment id="12991140" author="rcmuir" created="Sun, 6 Feb 2011 10:16:19 +0000"  >&lt;p&gt;in combination with other things. in my opinion the problem is the cache in getNumberedStates.&lt;/p&gt;

&lt;p&gt;But the real solution (in my opinion) is to clean up all this crap so the termsenum only&lt;br/&gt;
takes a completely immutable view of what it needs and for the Query to compile once in its ctor,&lt;br/&gt;
and remove any stupid caching. &lt;/p&gt;

&lt;p&gt;So, this is what I am working on now.&lt;/p&gt;</comment>
                    <comment id="12991141" author="thetaphi" created="Sun, 6 Feb 2011 10:22:41 +0000"  >&lt;p&gt;Yes the numbered states cache was always bugging me. But at least it is now synchronized (it was not even that at the beginning). I think the problem may be that the parallel queries doing different segments with different numbered states at the same time.&lt;/p&gt;

&lt;p&gt;+1 to remove the cache and calculate on ctor, then its really stateless!&lt;/p&gt;</comment>
                    <comment id="12991149" author="rcmuir" created="Sun, 6 Feb 2011 13:02:15 +0000"  >&lt;p&gt;editing description so its not confusing, sorry &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12991150" author="rcmuir" created="Sun, 6 Feb 2011 13:05:32 +0000"  >&lt;p&gt;attached is a patch. I removed all the transient/synchronized stuff from the query.&lt;/p&gt;

&lt;p&gt;Instead: AutomatonTermsEnum only takes an immutable, compiled form of the automaton (essentially a sorted transitions array).&lt;/p&gt;

&lt;p&gt;the query computes this compiled form (or any other simpler rewritten form) in its ctor.&lt;/p&gt;</comment>
                    <comment id="12991175" author="rcmuir" created="Sun, 6 Feb 2011 17:02:29 +0000"  >&lt;p&gt;here&apos;s the same patch, but cleaned up a bit (e.g. making some things private, final, etc)&lt;/p&gt;</comment>
                    <comment id="12991178" author="simonw" created="Sun, 6 Feb 2011 17:15:03 +0000"  >&lt;p&gt;patch looks good - just being super picky: you don&apos;t need all the this.bla in CompiledAutomaton &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I am not sure if CompiledAutomation is a good name since it is not really an automaton is it?&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="12991180" author="rcmuir" created="Sun, 6 Feb 2011 17:20:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;I am not sure if CompiledAutomation is a good name since it is not really an automaton is it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;it is a compiled form of the automaton... and it is a dfa, mathematically.&lt;/p&gt;

&lt;p&gt;At the end of the day this CompiledAutomaton is an internal api, we can change its name at any time.&lt;/p&gt;</comment>
                    <comment id="12991194" author="rcmuir" created="Sun, 6 Feb 2011 18:17:34 +0000"  >&lt;p&gt;Committed revision 1067720.&lt;/p&gt;</comment>
                    <comment id="12991198" author="thetaphi" created="Sun, 6 Feb 2011 18:43:55 +0000"  >&lt;p&gt;Thanks, really nice now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12470377" name="correct_seeks.txt" size="85149" author="rcmuir" created="Sun, 6 Feb 2011 00:03:23 +0000" />
                    <attachment id="12470378" name="incorrect_seeks.txt" size="67221" author="rcmuir" created="Sun, 6 Feb 2011 00:03:23 +0000" />
                    <attachment id="12470403" name="LUCENE-2907.patch" size="17715" author="rcmuir" created="Sun, 6 Feb 2011 17:02:29 +0000" />
                    <attachment id="12470396" name="LUCENE-2907.patch" size="18407" author="rcmuir" created="Sun, 6 Feb 2011 13:05:32 +0000" />
                    <attachment id="12470379" name="LUCENE-2907_repro.patch" size="3013" author="rcmuir" created="Sun, 6 Feb 2011 00:07:27 +0000" />
                    <attachment id="12470376" name="seeks_diff.txt" size="18779" author="rcmuir" created="Sun, 6 Feb 2011 00:00:04 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 6 Feb 2011 09:25:06 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10961</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24785</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>