<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:13:27 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2881/LUCENE-2881.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2881] Track FieldInfo per segment instead of per-IW-session</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2881</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Currently FieldInfo is tracked per IW session to guarantee consistent global field-naming / ordering. IW carries FI instances over from previous segments which also carries over field properties like isIndexed etc. While having consistent field ordering per IW session appears to be important due to bulk merging stored fields etc. carrying over other properties might become problematic with Lucene&apos;s Codec support.  Codecs that rely on consistent properties in FI will fail if FI properties are carried over.&lt;/p&gt;

&lt;p&gt;The DocValuesCodec (DocValuesBranch) for instance writes files per segment and field (using the field id within the file name). Yet, if a segment has no DocValues indexed in a particular segment but a previous segment in the same IW session had DocValues, FieldInfo#docValues will be true  since those values are reused from previous segments. &lt;/p&gt;

&lt;p&gt;We already work around this &quot;limitation&quot; in SegmentInfo with properties like hasVectors or hasProx which is really something we should manage per Codec &amp;amp; Segment. Ideally FieldInfo would be managed per Segment and Codec such that its properties are valid per segment. It also seems to be necessary to bind FieldInfoS to SegmentInfo logically since its really just per segment metadata.  &lt;/p&gt;</description>
                <environment></environment>
            <key id="12496483">LUCENE-2881</key>
            <summary>Track FieldInfo per segment instead of per-IW-session</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="simonw">Simon Willnauer</assignee>
                                <reporter username="simonw">Simon Willnauer</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Jan 2011 07:32:29 +0000</created>
                <updated>Fri, 10 May 2013 11:43:05 +0100</updated>
                    <resolved>Wed, 30 Mar 2011 14:37:10 +0100</resolved>
                            <version>4.0-ALPHA</version>
                <version>Realtime Branch</version>
                <version>CSF branch</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                <fixVersion>Realtime Branch</fixVersion>
                <fixVersion>CSF branch</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>3</watches>
                                                    <comments>
                    <comment id="12985759" author="michaelbusch" created="Mon, 24 Jan 2011 16:02:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;It also seems to be necessary to bind FieldInfoS to SegmentInfo logically since its really just per segment metadata.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I was going to do this in the realtime branch, because I don&apos;t think we can get DWPTs working correctly without SegmentInfos having private FIs. &lt;/p&gt;</comment>
                    <comment id="12985844" author="simonw" created="Mon, 24 Jan 2011 17:48:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yeah, I was going to do this in the realtime branch, because I don&apos;t think we can get DWPTs working correctly without SegmentInfos having private FIs.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;i think we should do that on trunk and then merge to RT - do you have time to work on this soon?&lt;/p&gt;</comment>
                    <comment id="12985852" author="michaelbusch" created="Mon, 24 Jan 2011 18:01:26 +0000"  >&lt;p&gt;It would probably make sense to have a new class (maybe an extension of SegmentInfo) for in-memory (not-yet-flushed) segments that references the corresponding FieldInfos and SegmentDeletes.  That&apos;d be better I think that adding another map SegmentInfo -&amp;gt; FieldInfos and we could then also remove the SegmentInfo -&amp;gt; SegmentDeletes map (in BufferedDeletes).&lt;/p&gt;</comment>
                    <comment id="12985853" author="michaelbusch" created="Mon, 24 Jan 2011 18:03:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;i think we should do that on trunk and then merge to RT - do you have time to work on this soon?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I agree.  Hmm maybe I can spend some hours tonight on this, otherwise I don&apos;t think I&apos;ll have much time before Thursday.&lt;/p&gt;</comment>
                    <comment id="12985959" author="simonw" created="Mon, 24 Jan 2011 20:14:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Yeah I agree. Hmm maybe I can spend some hours tonight on this, otherwise I don&apos;t think I&apos;ll have much time before Thursday.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Michael, if you start something I can work on it tomorrow for a while too. That way we can get it in quickly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                    <comment id="12991886" author="michaelbusch" created="Tue, 8 Feb 2011 10:25:15 +0000"  >&lt;ul&gt;
	&lt;li&gt;Creates for every segment a new FieldInfos&lt;/li&gt;
	&lt;li&gt;Changes FieldInfos, so that the FieldInfo numbers within a single FieldInfos don&apos;t have to be contiguous - this allows using the same numbering as the previous segment(s), even if not all fields are present in the new segment&lt;/li&gt;
	&lt;li&gt;Adds a global fieldName -&amp;gt; fieldNumber map;  if possible when a new field is added to a FieldInfo it tries to use an already assigned number for that field&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All tests pass.  Though I need to verify if the global map works correctly (it&apos;d probably be good to add a test for that).  Also it&apos;d be nice to remove hasVectors and hasProx from SegmentInfo, but we could also do that in a separate issue. &lt;/p&gt;</comment>
                    <comment id="12992038" author="simonw" created="Tue, 8 Feb 2011 16:43:49 +0000"  >&lt;p&gt;Michael, this looks very good!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;All tests pass. Though I need to verify if the global map works correctly (it&apos;d probably be good to add a test for that). Also it&apos;d be nice to remove hasVectors and hasProx from SegmentInfo, but we could also do that in a separate issue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree we should make FieldInfos a member of SegmentInfo and remove the hasVectors / hasProx an push them down. I tried to apply this patch to the DocValues branch but I didn&apos;t get very far - I haven&apos;t merged for a while that killed me ;( &lt;br/&gt;
I need to push that to after my vacation. I really hoped that I can get further but it didn&apos;t work out ;(&lt;/p&gt;</comment>
                    <comment id="12992150" author="michaelbusch" created="Tue, 8 Feb 2011 20:10:22 +0000"  >&lt;p&gt;New patch that removes the tracking of &apos;hasVectors&apos; and &apos;hasProx&apos; in SegmentInfo.  Instead SegmentInfo now has a reference to its corresponding FieldInfos.  &lt;/p&gt;

&lt;p&gt;For backwards-compatibility reasons we can&apos;t completely remove the hasVectors and hasProx bytes from the serialized SegmentInfo yet.  Eg. if someone uses addIndexes(Directory...) to add external old pre-4.0 segments to a new index, we &quot;upgrade&quot; the SegmentInfo to the latest version.  However, we don&apos;t modify the FieldInfos of that segment, instead we just copy it over to the new dir.  So the hasVector and hasProx bits in the FieldInfos might not be accurate and we have to keep those bits in the SegmentInfo instead.  Not an ideal solution, but we can remove it entirely in Lucene 5.0 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  The alternative would be to&lt;br/&gt;
rewrite the FieldInfos instead of just copying the files, but then we have to rewrite the cfs files.&lt;/p&gt;

&lt;p&gt;All core &amp;amp; contrib tests pass.&lt;/p&gt;</comment>
                    <comment id="12992156" author="simonw" created="Tue, 8 Feb 2011 20:22:45 +0000"  >&lt;blockquote&gt;
&lt;p&gt;New patch that removes the tracking of &apos;hasVectors&apos; and &apos;hasProx&apos; in SegmentInfo. Instead SegmentInfo now has a reference to its corresponding FieldInfos.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wow! nice work Michael! I like how you preserve bw compat in SegmentInfo and FieldInfos is now bound to SegmentInfo - yay! this solves two problems at once for DocValues branch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The alternative would be to rewrite the FieldInfos instead of just copying the files, but then we have to rewrite the cfs files.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think  copying over is fine. Ideally we will move all those boolean etc to the codec level so that we don&apos;t need that at all. Once stored fields and vectors are written by the codec we can push all that into PreFlex codec (maybe!?) and get rid of the bw compat code.&lt;/p&gt;

&lt;p&gt;I think you should commit that patch. I&apos;ll port to docvalues and run some tests that rely on this issue.&lt;/p&gt;</comment>
                    <comment id="12992174" author="simonw" created="Tue, 8 Feb 2011 20:54:45 +0000"  >&lt;p&gt;I gave the patch another glance - here are a couple of very minor comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;maybe we should return Iterable&amp;lt;FieldInfo&amp;gt; from FieldInfos#getFieldInfoIterator() this would make the iteration syntactically more javaish
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (FieldInfo info : getFieldInfoIterator()) {
  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; something with it
&lt;/span&gt;}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;If we return Iterable&amp;lt;FieldInfo&amp;gt; should we name it getFieldInfos?&lt;/li&gt;
	&lt;li&gt;Maybe we can simply implement Iterable&amp;lt;FieldInfo&amp;gt;?&lt;/li&gt;
	&lt;li&gt;Maybe we can rename SI#clearFilesCache() to SI#clearCache() or simply SI#clear() this would make thing less coupled to the SI internal cache but rather something that is called to clear internal state after flush?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12992175" author="michaelbusch" created="Tue, 8 Feb 2011 20:55:27 +0000"  >&lt;p&gt;Thanks for reviewing!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think you should commit that patch. I&apos;ll port to docvalues and run some tests that rely on this issue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I just want to add another tests for the global fieldname-&amp;gt;number map, after that I think it&apos;ll be ready to commit.  Will do that tonight &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12992340" author="michaelbusch" created="Wed, 9 Feb 2011 06:48:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe we can simply implement Iterable&amp;lt;FieldInfo&amp;gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;good idea - done.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Maybe we can rename SI#clearFilesCache()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually I renamed it intentionally, because all this method does is really clearing the files cache.  SI has a separate reset() method for resetting its state entirely.&lt;/p&gt;</comment>
                    <comment id="12992342" author="michaelbusch" created="Wed, 9 Feb 2011 06:52:34 +0000"  >&lt;p&gt;New patch that adds a new junit for testing that field numbering is consistent across segments.  It tests two cases: 1) one IW is used to write two segments; 2) two IWs are used to write two segments.  &lt;br/&gt;
And it also tests that addIndexes(Directory...) doesn&apos;t mess up the field numbering of the external segment.&lt;/p&gt;

&lt;p&gt;All tests pass.  I&apos;ll commit this in a day or two if nobody objects.&lt;/p&gt;</comment>
                    <comment id="12992382" author="simonw" created="Wed, 9 Feb 2011 08:25:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;All tests pass. I&apos;ll commit this in a day or two if nobody objects.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="12992476" author="simonw" created="Wed, 9 Feb 2011 13:37:30 +0000"  >&lt;p&gt;I just integrated this patch to the docvalues branch! It works like a charm! Nice work Michael, this brings docValues a huge step closer. All tests pass which failed before, FieldInfo is reliable now!&lt;/p&gt;</comment>
                    <comment id="12992524" author="michaelbusch" created="Wed, 9 Feb 2011 15:14:39 +0000"  >&lt;p&gt;Awesome, thanks for letting me know!  I hope I&apos;ll be able to say the same about the RT branch after I tried it there... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12992707" author="simonw" created="Wed, 9 Feb 2011 20:44:40 +0000"  >&lt;p&gt;I actually have some intermitted failures on docvalues which seem to be caused by some mixed up codec IDs. I found one which fixed most of the cases in FieldInfo#clone() where the codec ID is lost. But there must be some other situation where the codec ID gets mixed up. I will be AFK for 10 days at least so I have to leave you alone with that. Seems that we need a test for that though. The docValues test bring that up quickly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12995201" author="michaelbusch" created="Wed, 16 Feb 2011 07:26:05 +0000"  >&lt;p&gt;I fixed a bug in FieldInfos that could lead to wrong field numbers, that might have been related to the wrong behavior you&apos;re seeing, Simon.&lt;/p&gt;

&lt;p&gt;About codecIds:  I made the fix to FieldInfo.clone() to set the codecId on the clone.  I also made FieldInfo.codecId private and added getter and setter.  The setter checks whether the new value for codecId is different from the previous one, and throws in exception in that case (unless it was set to the default 0 before, which I think means Preflex codec).&lt;/p&gt;

&lt;p&gt;All tests pass.  Please let me know if that fixes your problem.  If not then you should at least see the new exception that I added, which might make debugging easier.&lt;/p&gt;</comment>
                    <comment id="12997129" author="simonw" created="Sun, 20 Feb 2011 11:32:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;I fixed a bug in FieldInfos that could lead to wrong field numbers, that might have been related to the wrong behavior you&apos;re seeing, Simon&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ah that could be the reason. I will need to patch my branch again to see if your patch helps. Will do tomorrow.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;About codecIds: I made the fix to FieldInfo.clone() to set the codecId on the clone. I also made FieldInfo.codecId private and added getter and setter. The setter checks whether the new value for codecId is different from the previous one, and throws in exception in that case (unless it was set to the default 0 before, which I think means Preflex codec).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The clone issue seems to be fixed in your latest patch. While the setter seems kind of wrong. Lemme explain how that numbering works. If you create a SI for a flushed segment SegmentCodecs creates an ordinal for each codec and sets it to the corresponding fields. The ordinal (codecID) is the array index in the SegmentCodec&apos;s Codec array which holds the codec instance used for that field. So codecID = 0 is a valid value for segments having PreFlex or a &amp;gt;= 4.0 codec. But if we open a segment that is pre-flex there will only be one codec for the entire segment with codecID=0, thats why this is assigned. (Note: I need to document this where its set!) I think we should initialize the codecID with a different value and replace the this.codecId != 0 check with something like this.codecId != -1. Maybe we should just use an assert here instead of an exception, this is somewhat internal though.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&lt;br/&gt;
All tests pass. Please let me know if that fixes your problem. If not then you should at least see the new exception that I added, which might make debugging easier.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will do tomorrow! What exactly was the problem with the previous patch beside the codecID clone issue?&lt;/p&gt;</comment>
                    <comment id="12997252" author="michaelbusch" created="Mon, 21 Feb 2011 01:27:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should initialize the codecID with a different value and replace the this.codecId != 0 check with something like this.codecId != -1.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I had the same though.  I changed it to use -1 and use an assert now instead of throwing the exception.&lt;br/&gt;
(will post the new patch shortly)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What exactly was the problem with the previous patch beside the codecID clone issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not sure if that&apos;s what caused your codecID issues, but the previous patch had a problem with assigning field numbers.  It could happen that a global number for a FieldInfo was acquired, but that number wasn&apos;t available anymore in the local FieldInfos.  I think this would be quite rare, but now I&apos;m preventing this from happening.&lt;/p&gt;</comment>
                    <comment id="12997253" author="michaelbusch" created="Mon, 21 Feb 2011 01:29:34 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uses -1 now as initial value for codecID.&lt;/li&gt;
	&lt;li&gt;updated to current trunk&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Let me know if it works without problems now in the doc values branch, Simon!&lt;/p&gt;</comment>
                    <comment id="12997475" author="simonw" created="Mon, 21 Feb 2011 17:18:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Uses -1 now as initial value for codecID.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;alright that looks good!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Let me know if it works without problems now in the doc values branch, Simon!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;this looks good now. I think we need to add a CHANGES.TXT entry for this issue since it changes the runtime behavior. +1 to commit Nice work!&lt;/p&gt;</comment>
                    <comment id="12997522" author="michaelbusch" created="Mon, 21 Feb 2011 18:55:26 +0000"  >&lt;p&gt;Committed revision 1073110.&lt;/p&gt;

&lt;p&gt;Thanks for reviewing the patch, Simon!&lt;/p&gt;</comment>
                    <comment id="12999809" author="mikemccand" created="Sat, 26 Feb 2011 17:50:21 +0000"  >&lt;p&gt;One question: we seem to have lost DocFieldProcessorPerThread.trimFields?&lt;/p&gt;

&lt;p&gt;If an app indexes docs where each doc has different fields... does this mean we are not going to reclaim the DFPPerField for the fields that are no longer seen after flushing?  Ie, would it be a memory leak?  Somewhere we have a test case for this I think.&lt;/p&gt;</comment>
                    <comment id="12999848" author="michaelbusch" created="Sat, 26 Feb 2011 21:56:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;One question: we seem to have lost DocFieldProcessorPerThread.trimFields?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I actually renamed it to doAfterFlush().  It now resets the whole hashmap in DocFieldProcessorPerThread, because we don&apos;t want to carry over any field settings into the next segment anymore with per-segment FieldInfos.  I think this should be fine?&lt;/p&gt;</comment>
                    <comment id="12999928" author="mikemccand" created="Sun, 27 Feb 2011 10:54:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;I actually renamed it to doAfterFlush(). It now resets the whole hashmap in DocFieldProcessorPerThread, because we don&apos;t want to carry over any field settings into the next segment anymore with per-segment FieldInfos. I think this should be fine?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ahh, good, I think you&apos;re right!  I missed that we clear this on flush.&lt;/p&gt;</comment>
                    <comment id="13000153" author="michaelbusch" created="Mon, 28 Feb 2011 07:30:17 +0000"  >&lt;p&gt;I mentioned on dev that assigning the same field number across segments is best effort now and wanted to explain in greater detail here how it works:&lt;/p&gt;

&lt;p&gt;There is now a global fieldName &amp;lt;-&amp;gt; fieldNumber bi-map in FieldInfos, which contains all fieldName/number pairs seen in a IndexWriter session.  It is passed into each new FieldInfos that is created in the same IndexWriter session.&lt;/p&gt;

&lt;p&gt;Also, when a new IndexWriter is opened, the FieldInfos of all segments are read and the global map created - this is tested in a new unit test this issue adds.&lt;/p&gt;

&lt;p&gt;A FieldInfos has in addition to the reference to the global map also a &quot;private&quot; map, which holds all FieldInfo objects that belong to the corresponding segment (remember there&apos;s now a 1-1 mapping SegmentInfo-&amp;gt;FieldInfos).  &lt;/p&gt;

&lt;p&gt;Now the fieldNumber assignment strategy works as follows:  If a new FI is added to FieldInfos, the global map is checked for the number of that field.  If the field name hasn&apos;t been seen before, the smallest number available in the &lt;b&gt;local&lt;/b&gt; map is picked (to keep the numbers dense).  &lt;br/&gt;
Otherwise, if we have seen the field before, the global number is used.  The problem now might be, that the global number might already be taken in the local FieldInfos.  In this case the global and local numbers for the same fieldName would differ.  This is not a problem in terms of correctness, but could prevent that field from being efficiently bulk-merged.&lt;/p&gt;

&lt;p&gt;With DocumentsWriterPerThreads (DWPTs) in mind I don&apos;t see how we could guarantee consistent field numbering across DWPTs, that&apos;s why I implemented it in this &quot;best effort&quot; way.&lt;/p&gt;

&lt;p&gt;Here&apos;s an example on how we can get into a situation where a field would get different numbers in different segments:&lt;br/&gt;
segment_1 has fields A and B, therefore these mappings A -&amp;gt; 1, B -&amp;gt; 2.&lt;br/&gt;
Now in segment_2 the first field we add is C, which hasn&apos;t been seen ever before, so we pick locally number 1 for it.  Then we add the next document which has field A, but since number 1 is already taken, it would get a different number than in segment_1.  This means A would not get bulk merged.&lt;/p&gt;

&lt;p&gt;Hmm, after writing this example down I&apos;m realizing that it would be better to just always pick the next available global field number for a new field, then, at least until we get DWPTs, we should never get different numbers across segments, I think?  The disadvantage would be that FieldInfos could have &quot;gaps&quot; in the numbers.  I implemented the current approach because I wanted to avoid those gaps, but having them would probably not be a big deal?&lt;/p&gt;</comment>
                    <comment id="13000180" author="simonw" created="Mon, 28 Feb 2011 08:53:18 +0000"  >&lt;p&gt;Thanks for the clarification, michael!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;... the smallest number available in the local map is picked (to keep the numbers dense). ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Oh man I was not aware of this. I got totally confused... see next comment&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Hmm, after writing this example down I&apos;m realizing that it would be better to just always pick the next available global field number for a new field, then, at least until we get DWPTs, we should never get different numbers across segments, I think? The disadvantage would be that FieldInfos could have &quot;gaps&quot; in the numbers. I implemented the current approach because I wanted to avoid those gaps, but having them would probably not be a big deal?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is how I thought it works but I obviously got confused by global vs. local this is also why I had trouble to understand how that failure could ever have happened. But after looking at the code again this makes sense &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I don&apos;t see any problems in FieldInfo number gaps. this should work just fine and guarantee the bulk copy just for now at least.&lt;/p&gt;
</comment>
                    <comment id="13000184" author="michaelbusch" created="Mon, 28 Feb 2011 09:24:26 +0000"  >&lt;p&gt;Reopening to make the described improvement that ensures consistent field numbers.&lt;/p&gt;</comment>
                    <comment id="13000185" author="michaelbusch" created="Mon, 28 Feb 2011 09:26:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t see any problems in FieldInfo number gaps. this should work just fine and guarantee the bulk copy just for now at least.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking that we probably write field numbers as VInts in a lot of places, and it would therefore be less efficient to have gaps... but this is probably negligible.&lt;/p&gt;</comment>
                    <comment id="13000229" author="mikemccand" created="Mon, 28 Feb 2011 11:15:54 +0000"  >&lt;p&gt;This was an impressive change &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Not only did we shift FieldInfos under SegmentInfo, we also fixed a given FieldInfos to allow for sparse mapping (ie, it only contains certain field numbers).  Various places previously assumed this was a dense mapping.&lt;/p&gt;

&lt;p&gt;I think even in the DWPT case we should try to assign consistent field numbers?  I&apos;m already worried enough about the possible perf hit DWPT will put on normal indexing and the NRT case, since it basically pushes merging out from RAM and onto the &quot;normal&quot; more costly disk based merging.  If we also suddenly risk these merges not being bulk merges, that&apos;s even worse.&lt;/p&gt;

&lt;p&gt;Can&apos;t we sync globally on the assignment of field name -&amp;gt; number (the global map lookup)?  And FieldInfos per-DWPT would share the same global map.  Wouldn&apos;t that keep us consistent in the DWPT case?&lt;/p&gt;</comment>
                    <comment id="13000438" author="michaelbusch" created="Mon, 28 Feb 2011 18:04:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can&apos;t we sync globally on the assignment of field name -&amp;gt; number (the global map lookup)?  And FieldInfos per-DWPT would share the same global map.  Wouldn&apos;t that keep us consistent in the DWPT case?&lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;Yes.  The global map is already shared across DWPTs and the lookup is synchronized on the global map.  I think if we change the logic to always pick the next available global number we would increase the likelihood that fields get bulk-merged.&lt;/p&gt;

&lt;p&gt;It can&apos;t be perfect though, because e.g. if you use addIndexes() to add an external segment that has a different field number assignment.  That&apos;s why we definitely have to keep the code that can fallback to  a different local number if it&apos;s not possible to use the global number in a segment.  But I agree that we should optimize for the &quot;normal&quot; indexing case.  And it seems like we all agree that field number gaps are fine.&lt;/p&gt;</comment>
                    <comment id="13000581" author="simonw" created="Mon, 28 Feb 2011 22:39:09 +0000"  >&lt;p&gt;For the record, robert reverted the changes made by this issue since we have been experiencing a fair bit of &lt;a href=&quot;https://hudson.apache.org/hudson/job/Lucene-Solr-tests-only-trunk/5420/&quot; class=&quot;external-link&quot;&gt;problems&lt;/a&gt; lately. &lt;/p&gt;

&lt;p&gt;eventually reproducible with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ant test -Dtestcase=SimpleFacetsTest -Dtestmethod=testFacetSingleValued -Dtests.seed=-4971136915249645135:5200209917417531291 -Dtests.multiplier=3

ant test -Dtestcase=SimpleFacetsTest -Dtestmethod=testFacetSingleValuedFcs -Dtests.seed=-4971136915249645135:-3738166620811568832 -Dtests.multiplier=3

ant test -Dtestcase=SimpleFacetsTest -Dtestmethod=testFacetPrefixMultiValued -Dtests.seed=-4971136915249645135:4594369826150277150 -Dtests.multiplier=3

ant test -Dtestcase=SimpleFacetsTest -Dtestmethod=testFacetPrefixSingleValued -Dtests.seed=-4971136915249645135:-7702531001769827248 -Dtests.multiplier=3

ant test -Dtestcase=SimpleFacetsTest -Dtestmethod=testFacetPrefixSingleValuedFcs -Dtests.seed=-4971136915249645135:698398490325732548 -Dtests.multiplier=3

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I found the problem causing this where certain field numbers got mixed up when the FieldInfos get build initially in IndexWriter and a segment is loaded first which had gaps in its field numbering. &lt;br/&gt;
FieldInfos is ignoring the FieldInfo&apos;s number if the FieldInfo does not exist yet and tries to assigne a new &quot;local&quot; field number. But if the next available field number x while the actual FI&apos;s number was &amp;gt; x+1 the new added FI will be set to x instead.&lt;/p&gt;

&lt;p&gt;in other words, lets say we have 2 segments:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 seg1 : { fields : [(a:0, c:2)] } 
 seg2 : { fields : [(a:0, b:1, c:2)] } 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;if we load seg1&apos;s FI we end up with &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;fields : [(a:0, c:1)] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then we add seg2&apos;s FI&apos;s and end up with &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;fields : [(a:0, c:1, b:2)] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this will also explain the TestNRTThreads.testNRTThreads failure where bulkMerge could not be applied due to different field numbers across segments.&lt;/p&gt;

&lt;p&gt;I will upload a patch tomorrow.&lt;/p&gt;</comment>
                    <comment id="13000885" author="simonw" created="Tue, 1 Mar 2011 14:11:31 +0000"  >&lt;p&gt;Here is an updated patch against trunk that fixes the problems we had with SimpleFacetsTest. &lt;br/&gt;
I added a testcase that triggered anyNonBulkMerges to be false as well as field number to be mixed up across segments. This patch also tracks the fieldNumbers globally within a IW session.&lt;/p&gt;

&lt;p&gt;I have been running tests with while(true) &lt;/p&gt;
{ ant clean test }
&lt;p&gt; on a top level directory without any failure for 12 hours now. Aside of that the testcase I added failed reliably with the previous version and it explains all failures we have see so far especially the one with NRTThreads.&lt;/p&gt;</comment>
                    <comment id="13001009" author="mikemccand" created="Tue, 1 Mar 2011 18:33:59 +0000"  >&lt;p&gt;Unfortunately, I&apos;m still seeing the assert trip (that there are no non-bulk merges) in TestNRTThreads.  Took beast a while to repro but eventually it did...&lt;/p&gt;

&lt;p&gt;I&apos;m also seeing this in TestIndexWriterExceptions:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;NOTE: reproduce with: ant test -Dtestcase=TestIndexWriterExceptions -Dtestmethod=testDocumentsWriterExceptions -Dtests.seed=-1056365072156857559:-3700694839465596125


There was 1 failure:
1) testDocumentsWriterExceptions(org.apache.lucene.index.TestIndexWriterExceptions)
java.io.FileNotFoundException: _1.tvx
	at org.apache.lucene.store.RAMDirectory.fileLength(RAMDirectory.java:147)
	at org.apache.lucene.store.MockDirectoryWrapper.fileLength(MockDirectoryWrapper.java:524)
	at org.apache.lucene.index.SegmentInfo.sizeInBytes(SegmentInfo.java:290)
	at org.apache.lucene.index.LogMergePolicy.sizeBytes(LogMergePolicy.java:211)
	at org.apache.lucene.index.LogByteSizeMergePolicy.size(LogByteSizeMergePolicy.java:45)
	at org.apache.lucene.index.LogMergePolicy.useCompoundFile(LogMergePolicy.java:165)
	at org.apache.lucene.index.DocumentsWriter.flush(DocumentsWriter.java:629)
	at org.apache.lucene.index.IndexWriter.doFlush(IndexWriter.java:2538)
	at org.apache.lucene.index.IndexWriter.flush(IndexWriter.java:2503)
	at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1077)
	at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1041)
	at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1005)
	at org.apache.lucene.index.TestIndexWriterExceptions.testDocumentsWriterExceptions(TestIndexWriterExceptions.java:565)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)
	at java.lang.reflect.Method.invoke(Method.java:597)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20)
	at org.junit.rules.TestWatchman$1.evaluate(TestWatchman.java:48)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:76)
	at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1213)
	at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1145)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
	at org.junit.runners.Suite.runChild(Suite.java:128)
	at org.junit.runners.Suite.runChild(Suite.java:24)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:193)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:52)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:191)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:42)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:184)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:236)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:157)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:136)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:117)
	at org.junit.runner.JUnitCore.runMain(JUnitCore.java:98)
	at org.junit.runner.JUnitCore.runMainAndExit(JUnitCore.java:53)
	at org.junit.runner.JUnitCore.main(JUnitCore.java:45)

FAILURES!!!
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The failure reproduces for me (with the above seed)...&lt;/p&gt;</comment>
                    <comment id="13001010" author="mikemccand" created="Tue, 1 Mar 2011 18:38:36 +0000"  >&lt;p&gt;Also, I think we should understand why Solr&apos;s SimpleFacetsTest failed from the previous patch and hopefully make a standalone test showing the problem (and that we fixed it!).&lt;/p&gt;</comment>
                    <comment id="13001011" author="mikemccand" created="Tue, 1 Mar 2011 18:41:02 +0000"  >
&lt;p&gt;This is a big patch!  Some comments...:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Do we even use FieldInfos.add(Document)?  Maybe we can remove&lt;br/&gt;
    it...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;FieldNumberBiMap.addOrGet doesn&apos;t need to take the FieldInfoBiMap?&lt;br/&gt;
    (It&apos;s an unused param).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Why create the FieldInfoBiMap class?  Ie, why not &quot;merge&quot; that&lt;br/&gt;
    back into FieldInfos itself (like it used to be)?  (I understand&lt;br/&gt;
    why we need FieldNumberBiMap &amp;#8211; so we can share a single instance&lt;br/&gt;
    across FieldInfos).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;We mix up autoboxing then unboxing, eg&lt;br/&gt;
    FieldInfos.addOrUpdateInternal takes int preferredFieldNumber,&lt;br/&gt;
    which is boxed when calling localFieldInfos.nextFieldNumber, then&lt;br/&gt;
    manually unboxed on calling globalFieldNumbers.addOrGet.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;On working with a pre-4.0 index that has non-congruent assignments&lt;br/&gt;
    across segments... I fear we may not necessarily ever &quot;stabilize&quot; on&lt;br/&gt;
    a fixed global name/number bimap, because we re-compute this map&lt;br/&gt;
    on every IW init?  Ie, when you first open 4.0 IW on pre-4.0&lt;br/&gt;
    index, you&apos;ll compute a certain global map, and write new segs&lt;br/&gt;
    with those bindings.  But say some fields differed in their&lt;br/&gt;
    assignment... but then some of those conflicting segs are merged.&lt;br/&gt;
    Later, when you open the IW again, you&apos;ll get a different global&lt;br/&gt;
    map?  And write new segments conflicting with the previous new&lt;br/&gt;
    segments you had written?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The fact that SegmentInfo.clearFilesCache is now a public API and&lt;br/&gt;
    consumer is responsible for knowing when to call this&lt;br/&gt;
    is... spooky.  Previously this cache was a fully private thing (ie&lt;br/&gt;
    invalidated whenever a change was made to the SegmentInfo).  But I&lt;br/&gt;
    don&apos;t see any way around it; since we now embed a FieldInfos and&lt;br/&gt;
    that FieldInfos (hasVectors) could change... maybe, whenever we&lt;br/&gt;
    call this method, add a comment explaining why?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It makes me nervous that the API that&apos;s allowed to pick a new&lt;br/&gt;
    field number (FieldInfo.addInternal) is the same API that used&lt;br/&gt;
    when reading a FieldInfos from _X.fnm (when we better not pick a&lt;br/&gt;
    different field number!).  In theory of course those&lt;br/&gt;
    field numbers will never conflict and we&apos;ll always get our&lt;br/&gt;
    preferred field number... but still.  Maybe add an assert in&lt;br/&gt;
    FieldInfos.read() verifying we always get that field number?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The call to localFieldInfos.setIfNotSet in FieldInfos.addInternal&lt;br/&gt;
    makes me nervous... is it actually possible for it to already be&lt;br/&gt;
    set, to a conflicting binding?  Shouldn&apos;t it always match? (Ie,&lt;br/&gt;
    above, in addOrUpdateInternal, we just consulted the global map to&lt;br/&gt;
    get the binding).  Can&apos;t we assert the global binding is either&lt;br/&gt;
    not present (and we add it) or if it is present it &quot;matches&quot;?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Why do we have FieldInfos.clearVectors?  Nobody should call&lt;br/&gt;
    that...?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It&apos;s not great that we open then close the CFS reader inside&lt;br/&gt;
    SegmentInfo, just to read the FieldInfos.  Ie, this means on&lt;br/&gt;
    opening an SR we will open this CFS reader twice... it also means&lt;br/&gt;
    that opening a SegmentInfos is quite a bit more costly than it&lt;br/&gt;
    used to be.  EG creating an IW must now go and open/close a CFS reader&lt;br/&gt;
    per-segment... not sure what we can really do about that&lt;br/&gt;
    though... maybe, we should store the FieldInfos inside the&lt;br/&gt;
    segments file?  Hmmm....&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Shouldn&apos;t IndexWriter.getFieldInfos(SegmentInfo) use the&lt;br/&gt;
    SegmentInfo&apos;s fieldInfos rather than loading it again from the&lt;br/&gt;
    directory...?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Indentation is also off in various places, for us lonely people who&lt;br/&gt;
still use Emacs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13001214" author="michaelbusch" created="Wed, 2 Mar 2011 00:47:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;maybe, we should store the FieldInfos inside the segments file? Hmmm....&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I had the same thought while adding the ref to FieldInfos to SegmentInfo.  Actually this is probably the right thing to do.  At the same time we could switch to a human-readable format &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;I fear we may not necessarily ever &quot;stabilize&quot; on a fixed global name/number bimap, because we re-compute this map on every IW init?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We could also store the global map on disk?  addIndexes() would have to ignore the global map from the external index(es).&lt;/p&gt;
</comment>
                    <comment id="13001372" author="mikemccand" created="Wed, 2 Mar 2011 11:08:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;I had the same thought while adding the ref to FieldInfos to SegmentInfo. Actually this is probably the right thing to do. At the same time we could switch to a human-readable format &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Human-readable format would be sweet &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Though I&apos;m still generally nervous that this means just opening the segments file will become quite a bit more costly.  Apps that have many fields will be especially penalized, though, apps really should not be creating so many fields.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We could also store the global map on disk?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s an interesting idea?  That&apos;d ensure stability on the bindings, even for pre-4.0 indices.  This way a pre-4.0 index would gradually work itself towards being fully consistent...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;addIndexes() would have to ignore the global map from the external index(es).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, addIndexes(IR[]) would get fully remapped to the correct bindings?  (since it&apos;s a real merge).&lt;/p&gt;

&lt;p&gt;But, yes, addIndexes(Dir[]) would not &amp;#8211; they are just file-copied.  Hmm, they&apos;d also presumably have a different global map, so if we stored the index global map in the Directory, how would we resolve conflicts on the incoming addIndexes...?  I guess the local mapping for the incoming segments would override the global one, on conflict.&lt;/p&gt;</comment>
                    <comment id="13001443" author="yseeley@gmail.com" created="Wed, 2 Mar 2011 15:02:10 +0000"  >&lt;p&gt;w.r.t. storing FielInfos in the segments file - don&apos;t we get some consistency benefit from the segments file being small (i.e. it&apos;s all in one disk block so it either gets written in it&apos;s entirety or not, and readers will see all of it, or not)?&lt;/p&gt;</comment>
                    <comment id="13001534" author="simonw" created="Wed, 2 Mar 2011 18:43:10 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Unfortunately, I&apos;m still seeing the assert trip (that there are no non-bulk merges) in TestNRTThreads. Took beast a while to repro but eventually it did...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;this is a problem we have seen before. This is an exception where we write a single doc segment and fail inverting the doc after FI has been updated. Since hasVectors has been moved to FI out of SI this is inconsistent and the TV tries to open the files since hasVectors is true. &lt;/p&gt;

&lt;p&gt;This is also why buschmi added clearVectors (just as a workaround afaik)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, I think we should understand why Solr&apos;s SimpleFacetsTest failed from the previous patch and hopefully make a standalone test showing the problem (and that we fixed it!).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;man I still try to trigger it in isolation but I can spend too much time on that right now. Got sucked into Tiered Flushing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;About the other comments (the big bulletpoint list) - in the meanwhile I think we should split this up in several smaller issues. &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;start with resetting the FI after flush to make the flags consistent for each segment&lt;/li&gt;
	&lt;li&gt;move FIs into SI with hasVectors etc still in SI&lt;/li&gt;
	&lt;li&gt;factor hasVectors out of SI into FI&lt;/li&gt;
	&lt;li&gt;introduce a global field num map (maybe on realtime first?) and / or store global map&lt;/li&gt;
	&lt;li&gt;...&lt;br/&gt;
We can still use this patch as a PoC does that make sense?&lt;/li&gt;
&lt;/ul&gt;

</comment>
                    <comment id="13001590" author="michaelbusch" created="Wed, 2 Mar 2011 20:09:23 +0000"  >&lt;blockquote&gt;
&lt;p&gt;w.r.t. storing FielInfos in the segments file - don&apos;t we get some consistency benefit from the segments file being small (i.e. it&apos;s all in one disk block so it either gets written in it&apos;s entirety or not, and readers will see all of it, or not)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we have three options here:&lt;br/&gt;
1) Store FIs inside of compound file (current patch)&lt;br/&gt;
2) Store FIs in SI&lt;br/&gt;
3) Store FIs in own file outside of compound file&lt;/p&gt;

&lt;p&gt;Each has disadvantages:&lt;/p&gt;

&lt;p&gt;1) more expensive to open SegmentInfos, as it now has to open cfs files to load FIs&lt;br/&gt;
2) SI files becomes bigger&lt;br/&gt;
3) one more file descriptor per segment - but can be closed as soon as FIs was read into memory&lt;/p&gt;</comment>
                    <comment id="13007938" author="simonw" created="Thu, 17 Mar 2011 14:53:40 +0000"  >&lt;p&gt;Attached next iteration.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;merged FieldInfoBiMap into FieldInfos&lt;/li&gt;
	&lt;li&gt;fixed AutoBoxing issues&lt;/li&gt;
	&lt;li&gt;reverted the deprecation of SegmentInfo#hasVector / hasProx since they where causing many failures due to missing files on exceptions. This also allowed me to make SegmentInfo.clearFilesCache private again.&lt;br/&gt;
*the FieldInfoBiMap now asserts that if you add a field via setIfNotSet that if either the number or the name exists they are the same as in the mapping.&lt;/li&gt;
	&lt;li&gt;added lazy loading of FieldInfos in SegmentInfo to prevent opening the CFS file while opening SegmentInfo. SR#CoreReader now passes in the already opened CFSReader to load the FieldInfos&lt;/li&gt;
	&lt;li&gt;when we open a IW we load the BiMap directly from the SegmentInfos&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;SegmentInfos now owns the FieldInfoBiMap and writes the map upon commit into an additional .fnx file outside of the CFS file. The SegmentInfos persist the bimap only if it has changed otherwise references the previously written map.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I still have one nocommit since I want to add more tests for the persisted global map. Beside that all tests pass and I would appreciate a review though.&lt;br/&gt;
Mike would you be so kind and let beast break it?&lt;/p&gt;
</comment>
                    <comment id="13008116" author="mikemccand" created="Thu, 17 Mar 2011 20:34:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;Mike would you be so kind and let beast break it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Beast ran Lucene&apos;s core+contrib tests 398 times!&lt;/p&gt;

&lt;p&gt;There was one failure, but I suspect it&apos;s unrelated.  I&apos;ll open a separate issue...&lt;/p&gt;</comment>
                    <comment id="13008375" author="simonw" created="Fri, 18 Mar 2011 08:58:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Beast ran Lucene&apos;s core+contrib tests 398 times!&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;awesome. Thanks for letting it chew on that patch for a while. &lt;/p&gt;

&lt;p&gt;I added more tests to ensure field numbers are stable and some jdoc comments to package private apis. This patch also (hopefully) solves all indentation issues.&lt;/p&gt;
</comment>
                    <comment id="13008530" author="mikemccand" created="Fri, 18 Mar 2011 17:29:52 +0000"  >&lt;p&gt;Patch looks much better &amp;#8211; I think it&apos;s close!  Comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think we should put header (id + version, ie&lt;br/&gt;
    CodecUtil.write/readHeader) on fnx file?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When does FieldNumberBiMap init from another...?  (We have ctor&lt;br/&gt;
    that takes a FieldNumberBiMap in... but I don&apos;t see who uses&lt;br/&gt;
    that).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Who uses BiMap.entries()?  Looks like just for testing?  Can you&lt;br/&gt;
    add comment saying &quot;just for testing..&quot;?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;FieldInfos ctor that loads from index file name but makes a new&lt;br/&gt;
    bimap seems spooky...?  Is this only used by tests now...?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The passed in &quot;version&quot; to SIS.readGlobalFieldMap is unused&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I&apos;m a little worried that we name the new file _X.fnx, because it&lt;br/&gt;
    will appear that this file &apos;belongs&apos; to segment X, which is&lt;br/&gt;
    dangerous because in some recovery cases we will remove all&lt;br/&gt;
    files associated w/ a given segment (ie, _X.*).  Maybe, we can&lt;br/&gt;
    name it without the leading _?  Ie, 0.fnx, 1.fnx, etc.?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In IW.getGlobalFieldNumberMap... shouldn&apos;t that &quot;legacy&quot; logic be&lt;br/&gt;
    moved inside SegmentInfos?  Ie it&apos;s a bit weird now how we first&lt;br/&gt;
    pull an (empty) biMap from the legacy SegmentInfos then we go and&lt;br/&gt;
    populate it ourselves...?  Then we don&apos;t need this method in IW&lt;br/&gt;
    (we just ask the SIS for the bimap).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Should FieldInfo.putInternal(FieldInfo) assert that the global&lt;br/&gt;
    bimap &quot;matches&quot;?  (Ie, it makes no effort to update the global&lt;br/&gt;
    bimap).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The addition of &quot;si.hasProx = hasProx&quot; in SegmentInfo.clone isn&apos;t&lt;br/&gt;
    needed; we pass hasProx to the ctor of that si.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Why do we default SegmentInfos.format now...?  Seems spooky?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In SegmentInfos.rollbackCommit shouldn&apos;t we set the&lt;br/&gt;
    pendingMapVersion to -1?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Should we backport this to 3.x (after sufficient aging)?&lt;/p&gt;</comment>
                    <comment id="13008550" author="simonw" created="Fri, 18 Mar 2011 18:02:19 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think we should put header (id + version, ie&lt;br/&gt;
CodecUtil.write/readHeader) on fnx file?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;man, I told myself to add it about 10 times during that patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;When does FieldNumberBiMap init from another...? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;ah legacy&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;m a little worried that we name the new file _X.fnx, because it&lt;br/&gt;
will appear that this file &apos;belongs&apos; to segment X, which is&lt;br/&gt;
dangerous because in some recovery cases we will remove all&lt;br/&gt;
files associated w/ a given segment (ie, _X.*). Maybe, we can&lt;br/&gt;
name it without the leading _? Ie, 0.fnx, 1.fnx, etc.?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;right, good catch! that we can simple remove and then it should be clear that its not a file belonging to a certain segment&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In IW.getGlobalFieldNumberMap... shouldn&apos;t that &quot;legacy&quot; logic be....&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yeah thats is where is should be though. I will move it in.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The addition of &quot;si.hasProx = hasProx&quot; in SegmentInfo.clone isn&apos;t...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;true I will remove&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Why do we default SegmentInfos.format now...? Seems spooky?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;this hasn&apos;t been used in SIS before so I think it didn&apos;t matter before.&lt;br/&gt;
Yet, I check the format in files() so if you create the SIS without reading it its set to 0. I can certainly make that work with default to 0 but it seemed just natural to have it assigned the current_format. I think its fine....&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In SegmentInfos.rollbackCommit shouldn&apos;t we set the pendingMapVersion to -1&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;ah good catch! thanks&lt;/p&gt;

&lt;p&gt;I will fix those issues and upload another patch. Thanks mike for reviewing!!!!&lt;/p&gt;
</comment>
                    <comment id="13008552" author="simonw" created="Fri, 18 Mar 2011 18:03:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;Should we backport this to 3.x (after sufficient aging)?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think we should let it bake in first though. Maybe we can also factor out the hasVectors in another issues and then backport both once they have been random-tested for a little while.&lt;/p&gt;</comment>
                    <comment id="13008777" author="mikemccand" created="Sat, 19 Mar 2011 14:34:28 +0000"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Why do we default SegmentInfos.format now...? Seems spooky?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;this hasn&apos;t been used in SIS before so I think it didn&apos;t matter before.&lt;br/&gt;
Yet, I check the format in files() so if you create the SIS without reading it its set to 0. I can certainly make that work with default to 0 but it seemed just natural to have it assigned the current_format. I think its fine....&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ahh, I see: it&apos;s for the case where we make a new SIS() in RAM, because we&apos;ll now look @ the format in files().  OK this sounds right then.&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Should we backport this to 3.x (after sufficient aging)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should let it bake in first though. Maybe we can also factor out the hasVectors in another issues and then backport both once they have been random-tested for a little while.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Definitely let it bake!&lt;/p&gt;

&lt;p&gt;Also, I have lots of pending backports to 3.2... which this patch likely overlaps on, so we should try to do them &quot;in order&quot; to reduce conflicts I think.&lt;/p&gt;</comment>
                    <comment id="13008778" author="mikemccand" created="Sat, 19 Mar 2011 14:36:29 +0000"  >&lt;p&gt;Hmm, but: if we open a pre-4.0 SIS, make changes, write a new SIS (commit), do we change that new instance&apos;s format to 4.0 (in RAM)?  Ie, so that files() is correct...?&lt;/p&gt;</comment>
                    <comment id="13008892" author="simonw" created="Sun, 20 Mar 2011 08:46:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;if we open a pre-4.0 SIS, make changes, write a new SIS (commit), do we change that new instance&apos;s format to 4.0 (in RAM)? Ie, so that files() is correct...?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;hmm actually we don&apos;t while the DefaultSIWriter changes it upon write which is not reflected to ram. We might should do that either before we write in DSIWriter. The other thing is that we should carry over the format from the oldSegment in the case we open a specific commit point. I will write a test first that hopefully triggers a fail and fix that accordingly.&lt;/p&gt;</comment>
                    <comment id="13009122" author="simonw" created="Mon, 21 Mar 2011 13:28:08 +0000"  >&lt;p&gt;next iteration, I think we are ready to commit here. I added a couple of testcases regarding the fnx file and made sure they get deleted accordingly even if we fail with Exceptions during prepareCommit &amp;amp; finishCommit. Moved the BW-Compat code for building the initial global map to SegmentInfos and cleaned up assertions in FieldInfos (also added the suggested assertion to FIs#putInternal). To prevent that we miss a fnx file if we open an old index, write the fnx file and keep that SIS in memory with format set to some old version I removed the check if we are on 4.0 index but used the latestGlobalFieldNumberVersion which is kept consistent and only include the file if its not set to 0.&lt;/p&gt;

&lt;p&gt;I run whileTrue tests on this patch now for a while and things are looking good from my side. Mike if you have time let beast chew it again. If its fine I will commit tomorrow.&lt;/p&gt;</comment>
                    <comment id="13009340" author="mikemccand" created="Mon, 21 Mar 2011 20:07:00 +0000"  >&lt;p&gt;OK beast chewed on this for a few hours &amp;#8211; ran all (Lucene + Solr)&lt;br/&gt;
tests 144 times.&lt;/p&gt;

&lt;p&gt;The UIMAUpdateRequestProcessorTest had a number of failures, but I&lt;br/&gt;
suspect they are unrelated. (They could also be due to how I run the&lt;br/&gt;
test &amp;#8211; I&apos;m using the python runner from luceneutil).&lt;/p&gt;

&lt;p&gt;So I think it&apos;s good!  I&apos;ll review the patch one more time...&lt;/p&gt;</comment>
                    <comment id="13009599" author="mikemccand" created="Tue, 22 Mar 2011 09:59:26 +0000"  >&lt;p&gt;Patch looks great!  Only a few things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;We still need a header (id + version) on the fnx file?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;FieldInfos ctor that loads from index file name but makes a new&lt;br/&gt;
    bimap seems spooky...? Is this only used by tests now...?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Can you add a comment where we create the N.fnx name, explaining&lt;br/&gt;
    why it has no leading _?  (ie, because it&apos;s not a per-segment&lt;br/&gt;
    file, but rather a global file, shared by multiple segments)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In CHANGES entry, persistend is mis-spelled (need to drop the n);&lt;br/&gt;
    also remove the _ from _X.fnx, and add . after &quot;successful commit&quot;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13009610" author="simonw" created="Tue, 22 Mar 2011 10:48:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;We still need a header (id + version) on the fnx file?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;its there I guess you got the wrong patch.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FieldInfos ctor that loads from index file name but makes a new&lt;br/&gt;
bimap seems spooky...? Is this only used by tests now...?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well this on is only for the read case where we open a FIS. Yet, we need to do this since we store a fnx file per SIS and upon IW#addIndexed(Directory) we could have a FIS that has field number different to the global map. This is fine as long as we don&apos;t seed the FIS on read. I will open another issue to make this case more efficient and assert that the FIS is read-only once we created the FIS from a directory.&lt;/p&gt;

&lt;p&gt;I fixed all the remaining issues and will go ahead and commit now. Thanks mike&lt;/p&gt;</comment>
                    <comment id="13009718" author="simonw" created="Tue, 22 Mar 2011 17:06:57 +0000"  >&lt;p&gt;Committed to trunk - I will keep this open until RT and docvalues have synced up with it.&lt;/p&gt;</comment>
                    <comment id="13012954" author="simonw" created="Wed, 30 Mar 2011 14:37:10 +0100"  >&lt;p&gt;merged to docvalues and realtime branch.&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10032">
                <name>Blocker</name>
                                <outwardlinks description="blocks">
                            <issuelink>
            <issuekey id="12459100">LUCENE-2324</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12502149">LUCENE-2983</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12471538" name="lucene-2881.patch" size="86631" author="michaelbusch" created="Mon, 21 Feb 2011 01:29:34 +0000" />
                    <attachment id="12471158" name="lucene-2881.patch" size="74729" author="michaelbusch" created="Wed, 16 Feb 2011 07:26:05 +0000" />
                    <attachment id="12470659" name="lucene-2881.patch" size="74967" author="michaelbusch" created="Wed, 9 Feb 2011 06:52:34 +0000" />
                    <attachment id="12470623" name="lucene-2881.patch" size="61806" author="michaelbusch" created="Tue, 8 Feb 2011 20:10:22 +0000" />
                    <attachment id="12470580" name="lucene-2881.patch" size="47805" author="michaelbusch" created="Tue, 8 Feb 2011 10:25:15 +0000" />
                    <attachment id="12474174" name="LUCENE-2881.patch" size="136133" author="simonw" created="Mon, 21 Mar 2011 13:28:08 +0000" />
                    <attachment id="12473982" name="LUCENE-2881.patch" size="126176" author="simonw" created="Fri, 18 Mar 2011 08:58:49 +0000" />
                    <attachment id="12473907" name="LUCENE-2881.patch" size="114423" author="simonw" created="Thu, 17 Mar 2011 14:53:40 +0000" />
                    <attachment id="12472310" name="LUCENE-2881.patch" size="93042" author="simonw" created="Tue, 1 Mar 2011 14:11:31 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>9.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 24 Jan 2011 16:02:14 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10986</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24811</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>