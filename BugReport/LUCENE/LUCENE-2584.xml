<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:18:32 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2584/LUCENE-2584.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2584] Concurrency issues in SegmentInfo.files() could lead to ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2584</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;The multi-threaded call of the files() in SegmentInfo could lead to the ConcurrentModificationException if one thread is not finished additions to the ArrayList (files) yet while the other thread already obtained it as cached (see below). This is a rare exception, but it would be nice to fix. I see the code is no longer problematic in the trunk (and others ported from flex_1458), looks it was fixed while implementing post 3.x features. The fix to 3.x and 2.9.x branches could be the same - create the files set first and populate it, and then assign to the member variable at the end of the method. This will resolve the issue. I could prepare the patch for 2.9.4 and 3.x, if needed.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;INFO: &lt;span class=&quot;error&quot;&gt;&amp;#91;19&amp;#93;&lt;/span&gt; webapp= path=/replication params=&lt;/p&gt;
{command=fetchindex&amp;amp;wt=javabin}
&lt;p&gt; status=0 QTime=1&lt;br/&gt;
Jul 30, 2010 9:13:05 AM org.apache.solr.core.SolrCore execute&lt;br/&gt;
INFO: &lt;span class=&quot;error&quot;&gt;&amp;#91;19&amp;#93;&lt;/span&gt; webapp= path=/replication params=&lt;/p&gt;
{command=details&amp;amp;wt=javabin}
&lt;p&gt; status=0 QTime=24&lt;br/&gt;
Jul 30, 2010 9:13:05 AM org.apache.solr.handler.ReplicationHandler doFetch&lt;br/&gt;
SEVERE: SnapPull failed&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)&lt;br/&gt;
        at java.util.AbstractList$Itr.next(AbstractList.java:343)&lt;br/&gt;
        at java.util.AbstractCollection.addAll(AbstractCollection.java:305)&lt;br/&gt;
        at org.apache.lucene.index.SegmentInfos.files(SegmentInfos.java:826)&lt;br/&gt;
        at org.apache.lucene.index.DirectoryReader$ReaderCommit.&amp;lt;init&amp;gt;(DirectoryReader.java:916)&lt;br/&gt;
        at org.apache.lucene.index.DirectoryReader.getIndexCommit(DirectoryReader.java:856)&lt;br/&gt;
        at org.apache.solr.search.SolrIndexReader.getIndexCommit(SolrIndexReader.java:454)&lt;br/&gt;
        at org.apache.solr.handler.SnapPuller.fetchLatestIndex(SnapPuller.java:261)&lt;br/&gt;
        at org.apache.solr.handler.ReplicationHandler.doFetch(ReplicationHandler.java:264)&lt;br/&gt;
        at org.apache.solr.handler.ReplicationHandler$1.run(ReplicationHandler.java:146)&lt;/p&gt;</description>
                <environment></environment>
            <key id="12470693">LUCENE-2584</key>
            <summary>Concurrency issues in SegmentInfo.files() could lead to ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="kanarsky">Alexander Kanarsky</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Aug 2010 03:46:45 +0100</created>
                <updated>Wed, 30 Mar 2011 16:50:25 +0100</updated>
                    <resolved>Tue, 18 Jan 2011 14:45:54 +0000</resolved>
                            <version>2.9</version>
                <version>2.9.1</version>
                <version>2.9.2</version>
                <version>2.9.3</version>
                <version>3.0</version>
                <version>3.0.1</version>
                <version>3.0.2</version>
                                <fixVersion>2.9.5</fixVersion>
                <fixVersion>3.0.4</fixVersion>
                <fixVersion>3.1</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12894860" author="mikemccand" created="Tue, 3 Aug 2010 10:49:45 +0100"  >&lt;p&gt;Ahh great catch!  Yes please create a patch?  Thanks!&lt;/p&gt;</comment>
                    <comment id="12895119" author="kanarsky" created="Wed, 4 Aug 2010 02:38:01 +0100"  >&lt;p&gt;OK, I&apos;ll create patches tomorrow. &lt;/p&gt;</comment>
                    <comment id="12895402" author="kanarsky" created="Wed, 4 Aug 2010 21:23:31 +0100"  >&lt;p&gt;Mike, the patches are attached. One note, I noticed (in flex_1458/trunk) that you are using the HashSet to collect the file names and then convert it to ArrayList; while this is a good idea to  guarantee the uniqueness of the file names, it also could mask any code that accidentally adds the same file more than once (something that I would prefer to notice rather than mask). So I used an assertion to ensure both the uniqueness of the names and correctness of the code that adds names. Also, with assertions disabled, this approach adds no additional performance overhead at all. But if you&apos;d like to use the HashSet to collect the file names, let me know so I will redo the patches.&lt;/p&gt;</comment>
                    <comment id="12983142" author="shaie" created="Tue, 18 Jan 2011 11:12:07 +0000"  >&lt;p&gt;On one hand, it&apos;s good to add the files to a Set, so that we can be sure they are added uniquely. On the other hand though, if we expect files are added properly, then adding to the set is redundant. Since this code is executed once per SI instance, I think explicitly adding to a Set is better.&lt;/p&gt;

&lt;p&gt;Note that while the assert you added will work, if someone runs without assertions he may get duplicate file names, if indeed they are added twice. I think that it&apos;s not so crucial to know that the same files was added twice, it&apos;s a very unlikely bug, but it is crucial that files() return unique names.&lt;/p&gt;

&lt;p&gt;So can you please use a Set in the method instead of the assert (like it&apos;s done on trunk). Also, while you&apos;re at it, the method doesn&apos;t have javadocs - they appear in regular comments. Can you convert them to javadocs (there is a warning there about not modifying the returned List, but it&apos;s not visible as javadocs &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                    <comment id="12983177" author="shaie" created="Tue, 18 Jan 2011 13:10:55 +0000"  >&lt;p&gt;Patch against 3x - fixes the bug according to Alexander&apos;s other patch (but uses HashSet all the way), and I added a CHANGES entry and test case to TestSegmentInfo. I plan to commit this soon and also backport to 3.0 and 2.9&lt;/p&gt;</comment>
                    <comment id="12983183" author="mikemccand" created="Tue, 18 Jan 2011 13:30:08 +0000"  >&lt;p&gt;Patch looks good Shai!&lt;/p&gt;

&lt;p&gt;I don&apos;t think you need to backport to 2.9/3.0 immediately (unless you really want to!)?  We can backport if/when we do another release...&lt;/p&gt;</comment>
                    <comment id="12983210" author="shaie" created="Tue, 18 Jan 2011 14:45:53 +0000"  >&lt;p&gt;Committed revision 1060358 (3x).&lt;br/&gt;
Committed revision 1060391 (3.0).&lt;br/&gt;
Committed revision 1060398 (2.9).&lt;/p&gt;

&lt;p&gt;Thanks Alexander !&lt;/p&gt;</comment>
                    <comment id="12986092" author="kanarsky" created="Mon, 24 Jan 2011 23:14:13 +0000"  >&lt;p&gt;Thanks Shai and Michael!&lt;/p&gt;</comment>
                    <comment id="13013474" author="gsingers" created="Wed, 30 Mar 2011 16:50:25 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12451257" name="LUCENE-2584-branch_3x.patch" size="4026" author="kanarsky" created="Wed, 4 Aug 2010 21:23:31 +0100" />
                    <attachment id="12451258" name="LUCENE-2584-lucene-2_9.patch" size="3969" author="kanarsky" created="Wed, 4 Aug 2010 21:23:31 +0100" />
                    <attachment id="12451259" name="LUCENE-2584-lucene-3_0.patch" size="3971" author="kanarsky" created="Wed, 4 Aug 2010 21:23:31 +0100" />
                    <attachment id="12468646" name="LUCENE-2584.patch" size="9170" author="shaie" created="Tue, 18 Jan 2011 13:10:55 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 3 Aug 2010 09:49:45 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11249</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25108</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>