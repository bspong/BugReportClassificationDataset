<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:10:38 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3126/LUCENE-3126.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3126] IndexWriter.addIndexes can make any incoming segment into CFS if it isn&apos;t already</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3126</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Today, IW.addIndexes(Directory) does not modify the CFS-mode of the incoming segments. However, if IndexWriter&apos;s MP wants to create CFS (in general), there&apos;s no reason why not turn the incoming non-CFS segments into CFS. We anyway copy them, and if MP is not against CFS, we should create a CFS out of them.&lt;/p&gt;

&lt;p&gt;Will need to use CFW, not sure it&apos;s ready for that w/ current API (I&apos;ll need to check), but luckily we&apos;re allowed to change it (@lucene.internal).&lt;/p&gt;

&lt;p&gt;This should be done, IMO, even if the incoming segment is large (i.e., passes MP.noCFSRatio) b/c like I wrote above, we anyway copy it. However, if you think otherwise, speak up &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at this in the next few days.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12507813">LUCENE-3126</key>
            <summary>IndexWriter.addIndexes can make any incoming segment into CFS if it isn&apos;t already</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 May 2011 22:17:43 +0100</created>
                <updated>Fri, 3 Jun 2011 17:37:09 +0100</updated>
                    <resolved>Thu, 26 May 2011 12:16:56 +0100</resolved>
                                            <fixVersion>3.2</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13036481" author="mikemccand" created="Thu, 19 May 2011 22:24:03 +0100"  >&lt;p&gt;Cool idea!&lt;/p&gt;</comment>
                    <comment id="13036726" author="shaie" created="Fri, 20 May 2011 10:06:33 +0100"  >&lt;p&gt;Hmm, that got me thinking &amp;#8211; what if someone adds a CFS segment to IW, where IW&apos;s MP sets cfs=off? Should we consider it a violation (that&apos;s what happens today if you try it)? I personally think that this is not a common (or even expected) scenario, and therefore javadocs is enough, but if others think this is a violation, then we should fix it - we&apos;ll need to &apos;open&apos; the CFS into its individual files.&lt;/p&gt;</comment>
                    <comment id="13036754" author="mikemccand" created="Fri, 20 May 2011 11:00:29 +0100"  >&lt;p&gt;Seems like we should split open the CFS in this case?  Though, I don&apos;t think it&apos;s super-important to do this... it ought to be rare?&lt;/p&gt;</comment>
                    <comment id="13037911" author="shaie" created="Mon, 23 May 2011 13:32:56 +0100"  >&lt;p&gt;Patch includes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Modify CFW to not assume the files it &apos;merges&apos; into a CFS exist in the same Directory as it was initialized with + test&lt;/li&gt;
	&lt;li&gt;Modify SegmentMerger following CFW updates + test&lt;/li&gt;
	&lt;li&gt;Modify IW to copy a segment into a CFS + test.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;NOTES:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I did not cover &apos;unrolling&apos; a CFS if the MP does not support CFS. I don&apos;t think it&apos;s so critical (left a TODO in TestAddIndexes)&lt;/li&gt;
	&lt;li&gt;About shared doc stores &amp;#8211; I&apos;d appreciate a review of this. Since we don&apos;t do shared doc stores anymore, I don&apos;t know how to simulate it for the test.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13037983" author="shaie" created="Mon, 23 May 2011 16:05:52 +0100"  >&lt;p&gt;Patch does not handle all files well (few tests fail). Apparently, the .del file should not be rolled into the .cfs. SegmentMerger.createCompoundFile does this by default, however it&apos;s only called from code that ensures no deletions exist. Would have been nice if this method documented it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;Also, I think *.s&amp;lt;num&amp;gt; should not be rolled into .cfs (those are the separate norms files). I don&apos;t know how to create such files in the first place (thought they&apos;re of old format, but 3.1 indexes have them also), and TestBackCompat fails. Is there a way to identify those files? Is it safe to check if the file extension starts w/ IndexFileNames.SEPARATE_NORMS_EXTENSION? Feels hacky to me.&lt;/p&gt;

&lt;p&gt;Another thing, I think in order to avoid shared doc stores (and whatever other old-format) stuff, since it&apos;s only an optimization, that the code should copy into CFS only if the segment version is on or after 3.1 (that is StringHelper.getVersionComparator().compare(info.getVersion, &quot;3.1&quot;) &amp;gt;= 0).&lt;/p&gt;

&lt;p&gt;I think I&apos;m close to finish it, just need to figure out the separate norms thing.&lt;/p&gt;</comment>
                    <comment id="13038136" author="mikemccand" created="Mon, 23 May 2011 19:59:41 +0100"  >
&lt;blockquote&gt;&lt;p&gt;Patch does not handle all files well (few tests fail). Apparently, the .del file should not be rolled into the .cfs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, .del files never appear inside a CFS.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;SegmentMerger.createCompoundFile does this by default, however it&apos;s only called from code that ensures no deletions exist. Would have been nice if this method documented it .&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Please add comments to this!  It&apos;s non-obvious &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, I think *.s&amp;lt;num&amp;gt; should not be rolled into .cfs (those are the separate norms files). I don&apos;t know how to create such files in the first place (thought they&apos;re of old format, but 3.1 indexes have them also), and TestBackCompat fails.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, these too only live outside a CFS.  You create them by opening a writable IndexReader (I know: confusing!) and calling setNorm, then closing it.  They are not only for old indices... 4.0 creates them too.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is there a way to identify those files? Is it safe to check if the file extension starts w/ IndexFileNames.SEPARATE_NORMS_EXTENSION? Feels hacky to me.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hackish though it seems (I agree) I think that&apos;s the only way?  SegmentInfo.hasSeparateNorms is equally hacky...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Another thing, I think in order to avoid shared doc stores (and whatever other old-format) stuff, since it&apos;s only an optimization, that the code should copy into CFS only if the segment version is on or after 3.1 (that is StringHelper.getVersionComparator().compare(info.getVersion, &quot;3.1&quot;) &amp;gt;= 0).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Shared doc stores, yes, but the separate del docs / norms are produced by all versions.&lt;/p&gt;

&lt;p&gt;More generally: does addIndexes properly refuse to import a too-old index?  We should throw IndexFormatTooOldExc in this case?  (And, maybe also IndexFormatTooNewExc?).&lt;/p&gt;</comment>
                    <comment id="13038558" author="shaie" created="Tue, 24 May 2011 14:47:43 +0100"  >&lt;blockquote&gt;&lt;p&gt;Right, these too only live outside a CFS. You create them by opening a writable IndexReader (I know: confusing!) and calling setNorm, then closing it. They are not only for old indices... 4.0 creates them too.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks Mike ! I was able to reproduce it and fix it (+ add to test). Are there other files that are normally created outside the .cfs? I&apos;ve seen sometimes that the stored fields of CFS are created outside. Was it only for shared doc stores?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;More generally: does addIndexes properly refuse to import a too-old index? We should throw IndexFormatTooOldExc in this case? (And, maybe also IndexFormatTooNewExc?).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not today. I believe it will fail in later stages (e.g. commit()), but we better fail up front. I think it&apos;s a separate issue though, only for 4.0 (b/c 3x supports all formats today)?&lt;/p&gt;</comment>
                    <comment id="13038577" author="shaie" created="Tue, 24 May 2011 15:12:56 +0100"  >&lt;p&gt;Patch w/ all fixes. Tests pass. No CHANGES entry yet, I&apos;ll add it in the next patch (after some comments).&lt;/p&gt;</comment>
                    <comment id="13038611" author="mikemccand" created="Tue, 24 May 2011 16:09:30 +0100"  >&lt;blockquote&gt;&lt;p&gt;Are there other files that are normally created outside the .cfs? I&apos;ve seen sometimes that the stored fields of CFS are created outside. Was it only for shared doc stores?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think just separate norms (_N.sM) and deletions (_N.del) live&lt;br/&gt;
outside CFS?  Yes, only w/ shared doc stores did the shared doc store&lt;br/&gt;
files live outside cfs...&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;More generally: does addIndexes properly refuse to import a too-old index? We should throw IndexFormatTooOldExc in this case? (And, maybe also IndexFormatTooNewExc?).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not today. I believe it will fail in later stages (e.g. commit()), but&lt;br/&gt;
we better fail up front. I think it&apos;s a separate issue though, only&lt;br/&gt;
for 4.0 (b/c 3x supports all formats today)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK I see &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3138&quot; title=&quot;IW.addIndexes should fail fast if an index is too old/new&quot;&gt;LUCENE-3138&lt;/a&gt; for this... thanks.&lt;/p&gt;</comment>
                    <comment id="13038618" author="mikemccand" created="Tue, 24 May 2011 16:18:41 +0100"  >&lt;p&gt;Patch looks good!&lt;/p&gt;

&lt;p&gt;Maybe we should add asserts to SegmentMerger.createCompoundFile, that SI.files() did not return del/separate norms?  I don&apos;t like the ambiguity here... and then strengthen the comment saying SI.files should never return these in this context?  Hopefully this does not cause any test files!  (We can do this as a separate issue...).&lt;/p&gt;</comment>
                    <comment id="13039077" author="shaie" created="Wed, 25 May 2011 12:32:04 +0100"  >&lt;blockquote&gt;&lt;p&gt;Maybe we should add asserts to SegmentMerger.createCompoundFile, that SI.files() did not return del/separate norms?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s do that in a separate issue? I&apos;ll also remove the comment from SM in this issue, and upload it to the other one (after I open it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). Keep this issue focused on IW.addIndexes.&lt;/p&gt;</comment>
                    <comment id="13039646" author="shaie" created="Thu, 26 May 2011 12:16:56 +0100"  >&lt;p&gt;Committed revision 1127871 (trunk).&lt;br/&gt;
Committed revision 1127872 (3x).&lt;/p&gt;</comment>
                    <comment id="13043460" author="rcmuir" created="Fri, 3 Jun 2011 17:37:09 +0100"  >&lt;p&gt;Bulk closing for 3.2&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12480256" name="LUCENE-3126.patch" size="15213" author="shaie" created="Tue, 24 May 2011 15:12:56 +0100" />
                    <attachment id="12480102" name="LUCENE-3126.patch" size="11769" author="shaie" created="Mon, 23 May 2011 13:32:56 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 19 May 2011 21:24:03 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2131</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24569</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>