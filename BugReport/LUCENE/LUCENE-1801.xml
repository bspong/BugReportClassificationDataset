<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:23:05 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1801/LUCENE-1801.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1801] Tokenizers (which are the source of Tokens) should call AttributeSource.clearAttributes() first</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1801</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;This is a followup for &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1796&quot; title=&quot;Speed up repeated TokenStream init&quot;&gt;&lt;del&gt;LUCENE-1796&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Token.clear() used to be called by the consumer... but then it was switched to the producer here: &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1101&quot; title=&quot;TokenStream.next(Token) reuse &amp;#39;policy&amp;#39;: calling Token.clear() should be responsibility of producer.&quot;&gt;&lt;del&gt;LUCENE-1101&lt;/del&gt;&lt;/a&gt; &lt;br/&gt;
I don&apos;t know if all of the Tokenizers in lucene were ever changed, but in any case it looks like at least some of these bugs were introduced with the switch to the attribute API - for example StandardTokenizer did clear it&apos;s reusableToken... and now it doesn&apos;t.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As alternative to changing all core/contrib Tokenizers to call clearAttributes first, we could do this in the indexer, what would be a overhead for old token streams that itsself clear their reusable token. This issue should also update the Javadocs, to clearly state inside Tokenizer.java, that the source TokenStream (normally the Tokenizer) should clear &lt;b&gt;all&lt;/b&gt; Attributes. If it does not do it and e.g. the positionIncrement is changed to 0 by any TokenFilter, but the filter does not change it back to 1, the TokenStream would stay with 0. If the TokenFilter would call PositionIncrementAttribute.clear() (because he is responsible), it could also break the TokenStream, because clear() is a general method for the whole attribute instance. If e.g. Token is used as AttributeImpl, a call to clear() would also clear offsets and termLength, which is not wanted. So the source of the Tokenization should rest the attributes to default values.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1796&quot; title=&quot;Speed up repeated TokenStream init&quot;&gt;&lt;del&gt;LUCENE-1796&lt;/del&gt;&lt;/a&gt; removed the iterator creation cost, so clearAttributes should run fast, but is an additional cost during Tokenization, as it was not done consistently before, so a small speed degradion is caused by this, but has nothing to do with the new TokenStream API.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12432803">LUCENE-1801</key>
            <summary>Tokenizers (which are the source of Tokens) should call AttributeSource.clearAttributes() first</summary>
                <type id="3" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/task.png">Task</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Aug 2009 18:21:01 +0100</created>
                <updated>Fri, 25 Sep 2009 17:23:31 +0100</updated>
                    <resolved>Fri, 14 Aug 2009 23:02:24 +0100</resolved>
                            <version>2.9</version>
                                <fixVersion>2.9</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12742012" author="thetaphi" created="Tue, 11 Aug 2009 19:51:21 +0100"  >&lt;p&gt;There is an additional problem (mentioned above):&lt;br/&gt;
There is currently defined the clear() in Attribute interface, but this leads to the problem, that it is really more the task of AttributeImpl. The porblem is, that e.g. one TokenFilter, that adds a new type of attribute must could clear it. On the other hand, Token, which implements &lt;b&gt;all&lt;/b&gt; attributes could also provide clear(). By this, there is an inconsistency: clear shold be removed from the general Attribute interface and moved downto each separate interface with a separate name. E.g. if somebody calls TermAttribute.clear, but may think that it only clears the term attribute may be wrong, if the actual implementation is Token, whic clears everything.&lt;/p&gt;

&lt;p&gt;The biggest problem is backwards compatibility. Lucene 2.4.1 states in JavaDocs of Token: &quot;public void clear(): Resets the term text, payload, flags, and positionIncrement to default. Other fields such as startOffset, endOffset and the token type are not reset since they are normally overwritten by the tokenizer.&quot;&lt;/p&gt;

&lt;p&gt;I would propose to change the whole thing:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Remove clear() from the superinterface Attribute.&lt;/li&gt;
	&lt;li&gt;Let do Token what it is used to (as of 2.4.1)&lt;/li&gt;
	&lt;li&gt;Define a clearTerm(), clearPositionIncrement(), clearFlags() method for each attribute type separate (Token/TokenWrapper must implement it).&lt;/li&gt;
	&lt;li&gt;clear() is only defined in AttributeImpl and clears the whole implementation. AttributeSource.clearAttributes calls this method. Current code calling clear() on the attribute interface will fail to compile, but these are the places that must be fixed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem of backwards compatibility can be solved the following way:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TokenWrapper clears the complete delegate Token to be consistent with AttributeSource.clearAttributes() - complete reset to default values incl offset. A problem only occurs if somebody registers Token (not the wrapper around as Attribute), then clearAttributes() would not be consistent with the rest, as it would miss to clear the offset.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;How will we handle the clearAttributes() call in Tokenizers then? Should we only clear those attributes we work on in a Tokenizer/TokenFilter?&lt;/p&gt;</comment>
                    <comment id="12742574" author="thetaphi" created="Wed, 12 Aug 2009 22:03:44 +0100"  >&lt;p&gt;Any comments here? I will be unavailable until the weekend, so please make some suggestions, especially about the clear() problem. The first part with clearAttributes is easy, its just adding some code, the second one is refactoring.&lt;br/&gt;
Michael B., what do you think?&lt;/p&gt;</comment>
                    <comment id="12742609" author="thetaphi" created="Wed, 12 Aug 2009 23:16:57 +0100"  >&lt;p&gt;Attached is a patch that implements clearAttributes() in all Tokenizers and other source of Tokens. It also removes clear() from Attribute basic interface.&lt;/p&gt;

&lt;p&gt;I commit in a day or two if nobody objects.&lt;/p&gt;</comment>
                    <comment id="12742616" author="rcmuir" created="Wed, 12 Aug 2009 23:25:37 +0100"  >&lt;p&gt;Uwe, there is also a tokenizer in contrib/memory inside PatternAnalyzer.&lt;/p&gt;

&lt;p&gt;i only mention this because I am trying to hunt down all analyzers/tokenstreams to check reuse/reset at the moment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                    <comment id="12742618" author="michaelbusch" created="Wed, 12 Aug 2009 23:26:09 +0100"  >&lt;p&gt;Sorry, Uwe. I&apos;m in meetings.&lt;/p&gt;

&lt;p&gt;I&apos;ll look into this tonight!&lt;/p&gt;</comment>
                    <comment id="12742620" author="thetaphi" created="Wed, 12 Aug 2009 23:32:52 +0100"  >&lt;p&gt;Thanks Robert!&lt;/p&gt;

&lt;p&gt;Can you look into this special &quot;Tokenizer&quot; for correct &quot;initialization&quot; according to Yonik&apos;s comments?&lt;/p&gt;</comment>
                    <comment id="12742626" author="rcmuir" created="Wed, 12 Aug 2009 23:35:30 +0100"  >&lt;p&gt;Uwe, I can supply updated patch to yours if you want, since I am already staring at it!&lt;/p&gt;

&lt;p&gt;In order to support reuse, it will need to be changed a little bit, but for now, we can simply resolve the clearAttributes issue&lt;/p&gt;</comment>
                    <comment id="12742636" author="rcmuir" created="Wed, 12 Aug 2009 23:51:28 +0100"  >&lt;p&gt;with clearAttributes for the secret and super-secret tokenizer inside memory/PatternAnalyzer&lt;/p&gt;</comment>
                    <comment id="12742638" author="rcmuir" created="Wed, 12 Aug 2009 23:53:30 +0100"  >&lt;p&gt;uwe, sorry I see there is an encoding problem with my patch file... i will supply another.&lt;/p&gt;</comment>
                    <comment id="12742641" author="rcmuir" created="Wed, 12 Aug 2009 23:55:06 +0100"  >&lt;p&gt;sorry for the bad encoding issue!&lt;/p&gt;</comment>
                    <comment id="12742643" author="thetaphi" created="Thu, 13 Aug 2009 00:04:58 +0100"  >&lt;p&gt;No problem, thanks for the patch. I was not aware that there were two inner classes. But they are no Tokenizers but TokenStreams. As they are the source of tokens, they must call clearAttributes(), you are right, thanks!&lt;/p&gt;

&lt;p&gt;If you find another one, please post a patch again, maybe I forgot more of them. I will go to bed now.&lt;/p&gt;

&lt;p&gt;Uwe&lt;/p&gt;</comment>
                    <comment id="12742646" author="rcmuir" created="Thu, 13 Aug 2009 00:10:00 +0100"  >&lt;p&gt;Uwe, get some rest.&lt;/p&gt;

&lt;p&gt;I will double-check later and see. Personally I do not like things that behave as Tokenizer but are TokenStream, not Tokenizer... this is another issue for another day!&lt;/p&gt;</comment>
                    <comment id="12742649" author="yseeley@gmail.com" created="Thu, 13 Aug 2009 00:17:02 +0100"  >&lt;blockquote&gt;&lt;p&gt;As they are the source of tokens, they must call clearAttributes()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Note: I had assumed that restoreState() would be enough if there was saved state being restored... but after checking the docs, it&apos;s not.&lt;/p&gt;

&lt;p&gt;Makes me wonder if there could be a more efficient clearAndRestoreState(State) that clears attributes not in the state?&lt;br/&gt;
Patch for another day I suppose...&lt;/p&gt;</comment>
                    <comment id="12742683" author="michaelbusch" created="Thu, 13 Aug 2009 03:57:13 +0100"  >&lt;p&gt;Patch looks good, Uwe!&lt;/p&gt;

&lt;p&gt;When I change Token.clear() to also set the offsets to 0 and the type to DEFAULT_TYPE, then still &apos;test-core&apos;, &apos;test-contrib&apos; and &apos;test-tag&apos; all pass. &lt;br/&gt;
I think we could make that change and add a comment to the backwards-compatibility section of CHANGES.txt? I think it is the right behavior to reset everything in Tokenizer. &lt;/p&gt;

&lt;p&gt;Also the comment in Token.clear() suggests that the only reason offset and type are not cleared is that tokenizers usually overwrite them anyways; so we&apos;re not changing the suggested behavior, and I doubt that people are really relying on the fact that offsets and type are currently not cleared?&lt;/p&gt;

&lt;p&gt;So in summary, if we:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;change all tokenizers to call clearAttributes() first in incrementToken(),&lt;/li&gt;
	&lt;li&gt;remove clear() from Attribute and leave it in AttributeImpl,&lt;/li&gt;
	&lt;li&gt;change Token.clear() to reset all members and add a comment about that in CHANGES.txt,&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;then everything seems good, or is then there still a problem that I&apos;m missing?&lt;/p&gt;</comment>
                    <comment id="12743118" author="thetaphi" created="Fri, 14 Aug 2009 08:40:18 +0100"  >&lt;p&gt;Final patch with Michaels suggestion.&lt;/p&gt;

&lt;p&gt;Please note: I also changed Token.clearNoTermBuffer() to work identical (please tell me if I should revert this). This method is not used anywhere inside Lucene, but I want to make it work consistent, too.&lt;/p&gt;

&lt;p&gt;I will commit at the end of the day.&lt;/p&gt;</comment>
                    <comment id="12743129" author="michaelbusch" created="Fri, 14 Aug 2009 09:25:25 +0100"  >&lt;p&gt;Patch looks good, Uwe!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I will commit at the end of the day.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1.&lt;/p&gt;</comment>
                    <comment id="12743466" author="thetaphi" created="Fri, 14 Aug 2009 23:02:24 +0100"  >&lt;p&gt;Committed revision 804392. Thanks also to Michael and Robert!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10032">
                <name>Blocker</name>
                                <outwardlinks description="blocks">
                            <issuelink>
            <issuekey id="12432638">LUCENE-1794</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12416537" name="LUCENE-1801.patch" size="13589" author="thetaphi" created="Fri, 14 Aug 2009 08:40:18 +0100" />
                    <attachment id="12416373" name="LUCENE-1801.patch" size="10412" author="rcmuir" created="Wed, 12 Aug 2009 23:55:06 +0100" />
                    <attachment id="12416366" name="LUCENE-1801.patch" size="9600" author="thetaphi" created="Wed, 12 Aug 2009 23:16:57 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 12 Aug 2009 22:25:37 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11961</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25925</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>