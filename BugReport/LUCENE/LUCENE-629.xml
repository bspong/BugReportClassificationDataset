<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:30:44 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-629/LUCENE-629.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-629] Performance improvement for merging stored, compressed fields</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-629</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Hello everyone,&lt;/p&gt;

&lt;p&gt;currently the merging of stored, compressed fields is not optimal for the following reason: every time a stored, compressed field is being merged, the FieldsReader uncompresses the data, hence the FieldsWriter has to compress it again when it writes the merged fields data (.fdt) file. The uncompress/compress step is unneccessary and slows down the merge performance significantly.&lt;/p&gt;

&lt;p&gt;This patch improves the merge performance by avoiding the uncompress/compress step. In the following I give an overview of the changes I made:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Added a new FieldSelectorResult constant named &quot;LOAD_FOR_MERGE&quot; to org.apache.lucene.document.FieldSelectorResult&lt;/li&gt;
	&lt;li&gt;SegmentMerger now uses an FieldSelector to get stored fields from the FieldsReader. This FieldSelector&apos;s accept() method returns the FieldSelectorResult &quot;LOAD_FOR_MERGE&quot; for every field.&lt;/li&gt;
	&lt;li&gt;Added a new inner class to FieldsReader named &quot;FieldForMerge&quot;, which extends  org.apache.lucene.document.AbstractField. This class holds the field properties and its data. If a field has the FieldSelectorResult &quot;LOAD_FOR_MERGE&quot;, then the FieldsReader creates an instance of &quot;FieldForMerge&quot; and does not uncompress the field&apos;s data.&lt;/li&gt;
	&lt;li&gt;FieldsWriter checks if the field it is about to write is an instanceof FieldsReader.FieldForMerge. If true, then it does not compress the field data.&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;To test the performance I index about 350,000 text files and store the raw text in a stored, compressed field in the lucene index. I use a merge factor of 10. The final index has a size of 366MB. After building the index, I optimize it to measure the pure merge performance.&lt;/p&gt;

&lt;p&gt;Here are the performance results:&lt;/p&gt;

&lt;p&gt;old version:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Time for Indexing:  36.7 minutes&lt;/li&gt;
	&lt;li&gt;Time for Optimizing: 4.6 minutes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;patched version:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Time for Indexing:  20.8 minutes&lt;/li&gt;
	&lt;li&gt;Time for Optimizing: 0.5 minutes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The results show that the index build time improved by about 43%, and the optimizing step is more than 8x faster. &lt;/p&gt;

&lt;p&gt;A diff of the final indexes (old and patched version) shows, that they are identical. Furthermore, all junit testcases succeeded with the patched version. &lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
  Michael Busch&lt;/p&gt;</description>
                <environment></environment>
            <key id="12346131">LUCENE-629</key>
            <summary>Performance improvement for merging stored, compressed fields</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png">Resolved</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="buschmic">Michael Busch</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Jul 2006 22:48:27 +0100</created>
                <updated>Sun, 13 Aug 2006 07:10:39 +0100</updated>
                    <resolved>Sun, 13 Aug 2006 07:10:39 +0100</resolved>
                                                            <component>core/index</component>
                        <due></due>
                    <votes>2</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12421726" author="buschmic" created="Mon, 17 Jul 2006 22:51:04 +0100"  >&lt;p&gt;The patch file for this improvement (based on Lucene Rev. 419199)&lt;/p&gt;</comment>
                    <comment id="12421770" author="yseeley@gmail.com" created="Tue, 18 Jul 2006 03:51:09 +0100"  >&lt;p&gt;Thanks Michael, very impressive results!&lt;br/&gt;
It might take a little while to review the patch, but the goals and general approach certainly seem correct.&lt;/p&gt;

&lt;p&gt;What is the impact (if any) for non-compressed fields?  &lt;/p&gt;</comment>
                    <comment id="12421920" author="buschmic" created="Tue, 18 Jul 2006 19:59:23 +0100"  >&lt;p&gt;Yonik,&lt;/p&gt;

&lt;p&gt;in the original version the FieldsReader maps the boolean values &quot;compressed&quot;, &quot;tokenize&quot;, &quot;binary&quot;, &quot;storeOffsetWithTermVector&quot;, &quot;storePositionWithTermVector&quot;, and &quot;storeTermVector&quot; to the Parameters Field.Index, Field.Store, and Field.TermVector. For writing, the FieldsWriter again maps those Parameters to the boolean values. My patched version avoids these mappings, thus we save some if-statements even while merging non-compressed fields. However, the overall merge performance does not benefit significantly in the non-compressed case.&lt;/p&gt;

&lt;p&gt;That should be the only impact for non-compressed fields. &lt;/p&gt;

&lt;p&gt;Michael&lt;/p&gt;</comment>
                    <comment id="12427733" author="otis" created="Sun, 13 Aug 2006 07:03:24 +0100"  >&lt;p&gt;This looks fine to me, patch applied after a bit of persuading, and unit tests all pass.  I&apos;ll commit this in a bit.&lt;br/&gt;
One question, why &quot;...ForMerge&quot; names?  Doesn&apos;t this patch really address only compressed fields?  Wouldn&apos;t it make sense to name things (classes, fields, vars) to indicate that?  Something like &quot;...DontTouchMeImAlreadyCompressed&quot;.  Just kidding, but you get the idea.&lt;/p&gt;</comment>
                    <comment id="12427734" author="otis" created="Sun, 13 Aug 2006 07:10:39 +0100"  >&lt;p&gt;Committed. Muchos gracias!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12337062" name="optimized_merge_compressed_fields.patch" size="8517" author="buschmic" created="Mon, 17 Jul 2006 22:51:04 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 18 Jul 2006 02:51:09 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>13124</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>27101</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>