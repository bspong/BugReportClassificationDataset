<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:24 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2791/LUCENE-2791.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2791] WindowsDirectory</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2791</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;We can use Windows&apos; overlapped IO to do pread() and avoid the performance problems of SimpleFS/NIOFSDir.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12491949">LUCENE-2791</key>
            <summary>WindowsDirectory</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="rcmuir">Robert Muir</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Dec 2010 01:06:45 +0000</created>
                <updated>Wed, 30 Mar 2011 16:50:09 +0100</updated>
                    <resolved>Fri, 3 Dec 2010 15:35:46 +0000</resolved>
                                            <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/store</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12966370" author="rcmuir" created="Fri, 3 Dec 2010 01:07:59 +0000"  >&lt;p&gt;here&apos;s an initial patch:&lt;br/&gt;
All tests pass using this directory with -Dtests.directory, on 32 and 64bit.&lt;/p&gt;

&lt;p&gt;I&apos;ll attach pre-built DLL files and instructions in case someone else wants to test.&lt;/p&gt;</comment>
                    <comment id="12966371" author="rcmuir" created="Fri, 3 Dec 2010 01:10:06 +0000"  >&lt;p&gt;heres a dll built for 32-bit windows.&lt;br/&gt;
to use it, just put it in a folder thats in your windows PATH, then the directory will work.&lt;/p&gt;

&lt;p&gt;to then run all lucene tests with it, first compile contrib/misc, then run a command like this:&lt;/p&gt;

&lt;p&gt;ant -lib \path\to\lusolr\lucene\build\contrib\misc\lucene-misc-4.0-SNAPSHOT.jar test-core -Dtests.directory=WindowsDirectory&lt;/p&gt;</comment>
                    <comment id="12966372" author="rcmuir" created="Fri, 3 Dec 2010 01:11:15 +0000"  >&lt;p&gt;here&apos;s one i compiled for 64-bit. just name it WindowsDirectory.dll and follow the other instructions (obviously, you only use this if you use a 64-bit jvm).&lt;/p&gt;

&lt;p&gt;the compilation instructions are in the javadocs for the WindowsDirectory.java by the way, its pretty easy to install mingw or ming64 to do it.&lt;/p&gt;</comment>
                    <comment id="12966400" author="rcmuir" created="Fri, 3 Dec 2010 03:06:48 +0000"  >&lt;p&gt;attached is an updated patch (fixing some indentation, adding some paranoid NPE checks in the JNI code, various stuff like that)&lt;/p&gt;

&lt;p&gt;I also included a crude benchmark made by mikemccand (I think we should commit this to our tests!)&lt;/p&gt;

&lt;p&gt;It builds a 100k doc index and searches with 20 threads for 10 seconds:&lt;br/&gt;
I used -Dtests.seed=0:0 and -Dtests.codec=Standard, and recorded best out of 3.&lt;br/&gt;
I tested win32 -client, and win64 -server, only because these are the oracle defaults.&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Directory&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS Win32 -client&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NIOFSDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;360&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SimpleFS&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;372&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;WindowsDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;616&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;RAMDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;760&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;MMapDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;772&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Directory&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS Win64 -server&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;NIOFSDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;361&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SimpleFS&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;376&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;WindowsDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;777&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;RAMDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1105&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;MMapDirectory&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1138&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;So, I think this gets you past the sync issue and can be a good choice e.g. for win32&lt;br/&gt;
But MMap still seems to be the best for this benchmark.&lt;/p&gt;
</comment>
                    <comment id="12966459" author="mikemccand" created="Fri, 3 Dec 2010 09:28:30 +0000"  >&lt;p&gt;This is awesome!  It gives us a workaround to the JRE bug (&lt;a href=&quot;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6265734&quot; class=&quot;external-link&quot;&gt;http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6265734&lt;/a&gt;) killing NIOFSDir&apos;s concurrency on Windows.&lt;/p&gt;

&lt;p&gt;Does is also allow for deletion of still-open files?&lt;/p&gt;

&lt;p&gt;You may want to experiment w/ different buffer sizes to see if that impacts performance.&lt;/p&gt;

&lt;p&gt;Also: this allows you to do the equivalent of Linux&apos;s O_DIRECT, right?  If so... I think we should augment the Dir API so that on opening an input it receives some sort of IOContext or something expressing why we are opening.  So for merging we would want &quot;direct iO&quot; (bypass OS buffer cache or NOREUSE fadvise flag, etc.), and larger buffer sizes and perhaps other low level IO settings in the future.&lt;/p&gt;</comment>
                    <comment id="12966486" author="nativepol" created="Fri, 3 Dec 2010 11:08:15 +0000"  >&lt;p&gt;There are some violations:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We can use Windows&apos; overlapped IO to do pread() and avoid the performance problems of SimpleFS/NIOFSDir.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ahm you dont really use overlapped/async IO, ReadFile in your code only returns when read operation is finished, so not async. Because when you do you have to pass a flag: FILE_FLAG_OVERLAPPED. But I don&apos;t think we should really make it async for now, that is too much stuff as Lucene does not really support it at the moment.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Currently you don&apos;t really need the OVERLAPPED structure at all, just pass NULL: &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx&quot; class=&quot;external-link&quot;&gt;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx&lt;/a&gt;, or is there a reason?&lt;/li&gt;
	&lt;li&gt;Do we need FILE_SHARE_WRITE?&lt;/li&gt;
	&lt;li&gt;You use env-&amp;gt;GetStringUTFChars, which is not really a problem as index filenames are always ASCII only. The default methods in the Win32 API use the system default charset (ANSI) for the arguments to OpenFile, which links to &quot;OpenFileA&quot; in kernel32.dll. I would suggest to use the real UTF16 chars (env-&amp;gt;GetStringChars) and use OpenFileW method, which takes wchar instead of char. The same applies to Linux Dir, but there I am not sure how encodings are handled.&lt;/li&gt;
	&lt;li&gt;Also the Format functions for GetLastError() results use ANSI per default. We should use the *W method, too, and pass it to java as wchar.&lt;/li&gt;
	&lt;li&gt;Exception handling: in native read, you call throwIOException, when ReadFile() returns false. But 2 lines later you still call the method to copy the local buffer to the java byte array. JNI docs say, that after an Exception is in the thread&apos;s local exception, you should not call any JNI methods anymore (expect some allowed ones). Also the copy operation is not really needed.&lt;/li&gt;
	&lt;li&gt;As in contract to the native Linux directory we are using our own Handles and not Java&apos;s FileDescriptor class to store the handle. If something goes wrong, GC can never clean up the file and it stays open. So you should add a finalizer, Java&apos;s internal File methods do that also (RandomAccessFile has a finalizer that calls close on operating system file).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12966487" author="thetaphi" created="Fri, 3 Dec 2010 11:13:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does is also allow for deletion of still-open files?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, of course not. Thats native windos, files that are open cannot be closed. No difference how the file was opened. Also MMapped Files cannot be deleted. Windows does not support the semantics of unix in Win32 API (but it does in POSIX! LOL), so open file: no deleting or changing&lt;/p&gt;</comment>
                    <comment id="12966489" author="thetaphi" created="Fri, 3 Dec 2010 11:18:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also: this allows you to do the equivalent of Linux&apos;s O_DIRECT, right? If so... I think we should augment the Dir API so that on opening an input it receives some sort of IOContext or something expressing why we are opening. So for merging we would want &quot;direct iO&quot; (bypass OS buffer cache or NOREUSE fadvise flag, etc.), and larger buffer sizes and perhaps other low level IO settings in the future&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats different to O_DIRECT. FS caches are still used by windows, but there are also options to disable this: FILE_FLAG_WRITE_THROUGH &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/aa363858(v=VS.85).aspx&quot; class=&quot;external-link&quot;&gt;http://msdn.microsoft.com/en-us/library/aa363858(v=VS.85).aspx&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="12966493" author="nativepol" created="Fri, 3 Dec 2010 11:34:30 +0000"  >&lt;p&gt;To my above comment and OVERLAPPED in my opinion not realy used (as not async):&lt;br/&gt;
Reading &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx#synchronization_and_file_position&quot; class=&quot;external-link&quot;&gt;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx#synchronization_and_file_position&lt;/a&gt; it seems to behave little different when OVERLAPPED is non-null for synchronous reads (as we do currently). But as you never read the contents og OVERLAPPED after the function call, why pass it in? Please explain &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12966495" author="rcmuir" created="Fri, 3 Dec 2010 11:37:41 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Ahm you dont really use overlapped/async IO, ReadFile in your code only returns when read operation is finished, so not async. Because when you do you have to pass a flag: FILE_FLAG_OVERLAPPED. But I don&apos;t think we should really make it async for now, that is too much stuff as Lucene does not really support it at the moment.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes I do, Overlapped IO is distinct from asynchronous IO! you just use the overlapped structure without OVERLAPPED, as i did here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Currently you don&apos;t really need the OVERLAPPED structure at all, just pass NULL: &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx&quot; class=&quot;external-link&quot;&gt;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx&lt;/a&gt;, or is there a reason?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes I do use it, do you understand C ?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do we need FILE_SHARE_WRITE?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;You use env-&amp;gt;GetStringUTFChars, which is not really a problem as index filenames are always ASCII only. The default methods in the Win32 API use the system default charset (ANSI) for the arguments to OpenFile, which links to &quot;OpenFileA&quot; in kernel32.dll. I would suggest to use the real UTF16 chars (env-&amp;gt;GetStringChars) and use OpenFileW method, which takes wchar instead of char. The same applies to Linux Dir, but there I am not sure how encodings are handled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We don&apos;t open unicode files in lucene, they are all ascii. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also the Format functions for GetLastError() results use ANSI per default. We should use the *W method, too, and pass it to java as wchar.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not concerned about this here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Exception handling: in native read, you call throwIOException, when ReadFile() returns false. But 2 lines later you still call the method to copy the local buffer to the java byte array. JNI docs say, that after an Exception is in the thread&apos;s local exception, you should not call any JNI methods anymore (expect some allowed ones). Also the copy operation is not really needed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think you know what you are talking about!&lt;/p&gt;

&lt;p&gt;The code uses 2 techniques, alloc on the stack+SetByteArrayRegion (for small reads), and GetByteArrayElements (for larger reads). The JDK (at least sun, etc) &lt;b&gt;always&lt;/b&gt; makes a copy for the latter.&lt;/p&gt;

&lt;p&gt;So bottom line: I disagree with you on everything you said.&lt;/p&gt;</comment>
                    <comment id="12966496" author="rcmuir" created="Fri, 3 Dec 2010 11:51:36 +0000"  >&lt;blockquote&gt;
&lt;p&gt;To my above comment and OVERLAPPED in my opinion not realy used (as not async):&lt;br/&gt;
Reading &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx#synchronization_and_file_position&quot; class=&quot;external-link&quot;&gt;http://msdn.microsoft.com/en-us/library/aa365467(VS.85).aspx#synchronization_and_file_position&lt;/a&gt; it seems to behave little different when OVERLAPPED is non-null for synchronous reads (as we do currently). But as you never read the contents og OVERLAPPED after the function call, why pass it in? Please explain &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;To position the read versus seeking the file. This is explained in the documentation on that very same page!:&lt;/p&gt;

&lt;p&gt;Considerations for working with &lt;b&gt;synchronous&lt;/b&gt; file handles:&lt;/p&gt;

&lt;p&gt;If lpOverlapped is not NULL, the read operation &lt;b&gt;starts at the offset that is specified&lt;/b&gt; in the OVERLAPPED structure and ReadFile does not return until the read operation is complete. The system updates the OVERLAPPED offset before ReadFile returns.&lt;/p&gt;</comment>
                    <comment id="12966497" author="nativepol" created="Fri, 3 Dec 2010 11:54:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;So bottom line: I disagree with you on everything you said.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This was not against you, but I am hacking native Windows since Win32 was started &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Yes I do use it, do you understand C ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I kill you the next time we meet. I am hacking C longer than Java. This was not about C it was about the MSDN docs telling something different. See my last comment above. Thats all. Why are you so aggresive?&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Exception handling: in native read, you call throwIOException, when ReadFile() returns false. But 2 lines later you still call the method to copy the local buffer to the java byte array. JNI docs say, that after an Exception is in the thread&apos;s local exception, you should not call any JNI methods anymore (expect some allowed ones). Also the copy operation is not really needed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think you know what you are talking about!&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry we seem to have a misunderstanding. I was &lt;b&gt;not&lt;/b&gt; talking about the internal copy the JVM does. I was talking about the fact, that you should not call JNI functions anymore when you set the thread&apos;s exception status and exit the function as soon as possible. You set this status after the failed ReadFile with throwIOEx(). After that its no longer needed to copy the buffer[] to the java byte array and its risky to do it because I am not sure if this env-&amp;gt;SetByteArrayRegion() is safe to be called after exception status is set - that all I wanted to say. I would change tha code to:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ReadFile((HANDLE) fd, &amp;amp;buffer, length, &amp;amp;numRead, &amp;amp;io)) {
  env-&amp;gt;SetByteArrayRegion(bytes, offset, numRead, (&lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; jbyte *) buffer);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
  throwIOException(env, GetLastError());
  numRead = -1;
}  	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please note env-&amp;gt;throwNew() always returns, it simply sets the thread&apos;s exception status, so the JVM thorws the Java Exce&#252;ption passed in after the native method returns to Java bytecode again.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Native Policeman&lt;/p&gt;</comment>
                    <comment id="12966501" author="rcmuir" created="Fri, 3 Dec 2010 12:02:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;This was not against you, but I am hacking native Windows since Win32 was started &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But you don&apos;t understand how its IO works?&lt;/p&gt;</comment>
                    <comment id="12966503" author="nativepol" created="Fri, 3 Dec 2010 12:05:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;If lpOverlapped is not NULL, the read operation starts at the offset that is specified in the OVERLAPPED structure and ReadFile does not return until the read operation is complete. The system updates the OVERLAPPED offset before ReadFile returns.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks, I missed that. Sorry - the idea is simply to make positioned reads, I understand that.&lt;/p&gt;</comment>
                    <comment id="12966505" author="nativepol" created="Fri, 3 Dec 2010 12:08:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;But you don&apos;t understand how its IO works?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You will laugh, but I did exactly the same thing a few weeks ago &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Sorry, the whole thing was a misunderstanding.&lt;/p&gt;

&lt;p&gt;The other things are simply minor improvements. And Mike also said that we may create files by codecs with names that are non-ascii. And as you are the unicode policeman, I dont unterstand how you can live with default charsets... This is why I suggested to use *W functions in windows and use the UTF16 chars for that reason.&lt;/p&gt;

&lt;p&gt;The exception status stuff is also just an optimization in the error case? So why are you aggressive?&lt;/p&gt;</comment>
                    <comment id="12966508" author="rcmuir" created="Fri, 3 Dec 2010 12:14:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;And Mike also said that we may create files by codecs with names that are non-ascii. And as you are the unicode policeman, I dont unterstand how you can live with default charsets... &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;its my understanding that all indexfiles/codecs are ascii-only.&lt;/p&gt;

&lt;p&gt;If this is going to change, then there is a lot of policework to do. Personally i would really prefer if we simply keep codecs and lucene filenames as ascii-only! &lt;/p&gt;

&lt;p&gt;For non-ascii filenames, java.io.File is broken, its equals() is inconsistent with its hashCode(), even on windows, and definitely on things like macos (as i think it still uses unicode normalization to normalize filenames). We should seriously avoid the system-dependent problems that will arise by using non-ascii filenames in these parts of lucene: i don&apos;t see this bringing a lot of benefits either.&lt;/p&gt;</comment>
                    <comment id="12966512" author="rcmuir" created="Fri, 3 Dec 2010 12:41:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does is also allow for deletion of still-open files?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, but we could/should investigate trying to improve this, thoguh we might have to implement IndexOutput for it to all work.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;You may want to experiment w/ different buffer sizes to see if that impacts performance.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;maybe, mainly my point was to avoid the synchronized() here. A user could always tweak the buffer size here?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also: this allows you to do the equivalent of Linux&apos;s O_DIRECT, right? If so... I think we should augment the Dir API so that on opening an input it receives some sort of IOContext or something expressing why we are opening. So for merging we would want &quot;direct iO&quot; (bypass OS buffer cache or NOREUSE fadvise flag, etc.), and larger buffer sizes and perhaps other low level IO settings in the future.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, we can use FILE_FLAG_NO_BUFFERING, though it would be more complicated (things must be sector-aligned). In my opinion this should be a separate IndexInput, and as you stated the Dir API  could inform us. But you are right, the general notion seems to be in all major platforms, and I think we should carefully use it (if it can help!)&lt;/p&gt;
</comment>
                    <comment id="12966521" author="thetaphi&#8205;" created="Fri, 3 Dec 2010 13:06:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sorry, the whole thing was a misunderstanding.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Its ok, we understand. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12966522" author="thetaphi" created="Fri, 3 Dec 2010 13:13:14 +0000"  >&lt;p&gt;The Native Policeman now retires!&lt;/p&gt;</comment>
                    <comment id="12966523" author="nativepol" created="Fri, 3 Dec 2010 13:13:49 +0000"  >&lt;p&gt;&lt;b&gt;wink&lt;/b&gt;&lt;/p&gt;</comment>
                    <comment id="12966524" author="thetaphi&#8205;" created="Fri, 3 Dec 2010 13:17:21 +0000"  >&lt;p&gt;I was thinking maybe I retire as generics policeman too.&lt;/p&gt;

&lt;p&gt;I decided we should convert all of our code back to java 1.4, generics are useless and should be abolished!&lt;/p&gt;</comment>
                    <comment id="12966528" author="rcmuir&#160;" created="Fri, 3 Dec 2010 13:31:00 +0000"  >&lt;p&gt;I think, I will also retire as Unicode Policeman, because Unicode is a cruft fore all US americans. Its totally useless!&lt;/p&gt;</comment>
                    <comment id="12966540" author="dmsmith555" created="Fri, 3 Dec 2010 14:06:30 +0000"  >&lt;p&gt;I&apos;ve just back ported all the code to Java 1.1. Also, this port also deletes everything but 7-bit ASCII.&lt;/p&gt;

&lt;p&gt;(Just couldn&apos;t resist....)&lt;/p&gt;
</comment>
                    <comment id="12966548" author="rcmuir" created="Fri, 3 Dec 2010 14:36:29 +0000"  >&lt;p&gt;i turned mike&apos;s benchmark into a unit test, and toned it down a bit.&lt;/p&gt;

&lt;p&gt;so i agree with uwe on only one thing, and thats optimizing the case where we throw an exception.&lt;/p&gt;

&lt;p&gt;but i disagree on the other things: i think we should just have language neutral error messages and ascii-only files as i presented here... this isn&apos;t for general purpose use: its just for lucene. there is no need to bring wchar, etc into this.&lt;/p&gt;

&lt;p&gt;so, since all tests pass and this fixes the bug in SimpleFS, i will commit to contrib/misc coon.&lt;/p&gt;</comment>
                    <comment id="12966556" author="rcmuir" created="Fri, 3 Dec 2010 15:35:45 +0000"  >&lt;p&gt;committed revision 1041844 (trunk), 1041881 (3x).&lt;/p&gt;</comment>
                    <comment id="13013382" author="gsingers" created="Wed, 30 Mar 2011 16:50:09 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12465235" name="LUCENE-2791.patch" size="15188" author="rcmuir" created="Fri, 3 Dec 2010 14:36:29 +0000" />
                    <attachment id="12465202" name="LUCENE-2791.patch" size="15525" author="rcmuir" created="Fri, 3 Dec 2010 03:06:48 +0000" />
                    <attachment id="12465191" name="LUCENE-2791.patch" size="9750" author="rcmuir" created="Fri, 3 Dec 2010 01:07:59 +0000" />
                    <attachment id="12465193" name="WindowsDirectory_amd64.dll" size="442154" author="rcmuir" created="Fri, 3 Dec 2010 01:11:14 +0000" />
                    <attachment id="12465192" name="WindowsDirectory.dll" size="156986" author="rcmuir" created="Fri, 3 Dec 2010 01:10:06 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 3 Dec 2010 09:28:30 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11063</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24901</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>