<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:31:11 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2320/LUCENE-2320.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2320] Add MergePolicy to IndexWriterConfig</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2320</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Now that IndexWriterConfig is in place, I&apos;d like to move MergePolicy to it as well. The change is not straightforward and so I&apos;ve kept it for a separate issue. MergePolicy requires in its ctor an IndexWriter, however none can be passed to it before an IndexWriter actually exists. And today IW may create an MP just for it to be overridden by the application one line afterwards. I don&apos;t want to make iw member of MP non-final, or settable by extending classes, however it needs to remain protected so they can access it directly. So the proposed changes are:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Add a SetOnce object (to o.a.l.util), or Immutable, which can only be set once (hence its name). It&apos;ll have the signature SetOnce&amp;lt;T&amp;gt; w/ &lt;b&gt;synchronized set&amp;lt;T&amp;gt;&lt;/b&gt; and &lt;b&gt;T get()&lt;/b&gt;. T will be declared volatile, so that get() won&apos;t be synchronized.&lt;/li&gt;
	&lt;li&gt;MP will define a &lt;b&gt;protected final SetOnce&amp;lt;IndexWriter&amp;gt; writer&lt;/b&gt; instead of the current writer. &lt;b&gt;NOTE: this is a bw break&lt;/b&gt;. any suggestions are welcomed.&lt;/li&gt;
	&lt;li&gt;MP will offer a public default ctor, together with a set(IndexWriter).&lt;/li&gt;
	&lt;li&gt;IndexWriter will set itself on MP using set(this). Note that if set will be called more than once, it will throw an exception (AlreadySetException - or does someone have a better suggestion, preferably an already existing Java exception?).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That&apos;s the core idea. I&apos;d like to post a patch soon, so I&apos;d appreciate your review and proposals.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12459066">LUCENE-2320</key>
            <summary>Add MergePolicy to IndexWriterConfig</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Sun, 14 Mar 2010 07:32:50 +0000</created>
                <updated>Fri, 10 May 2013 11:43:07 +0100</updated>
                    <resolved>Fri, 19 Mar 2010 22:34:11 +0000</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12845064" author="mikemccand" created="Sun, 14 Mar 2010 10:16:25 +0000"  >&lt;p&gt;This sounds good Shai!&lt;/p&gt;

&lt;p&gt;This is technically a back-compat break, but, these are experimental APIs, and this is an easy fix for users who have impl&apos;d their own MPs, so I think it&apos;s OK to make an exception.  Make sure you note it in the bw break section in CHANGES...&lt;/p&gt;</comment>
                    <comment id="12845077" author="shaie" created="Sun, 14 Mar 2010 13:28:40 +0000"  >&lt;p&gt;Ok, I&apos;ll update that part of CHANGES. The conversion is very straightforward - instead of calling writer.doXYZ(), the code becomes writer.get().doXYZ().&lt;/p&gt;</comment>
                    <comment id="12845099" author="shaie" created="Sun, 14 Mar 2010 15:46:28 +0000"  >&lt;p&gt;Patch with the proposed changes including:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;SetOnce (+ test)&lt;/li&gt;
	&lt;li&gt;Deprecations in IW&lt;/li&gt;
	&lt;li&gt;Adds MP to IWC&lt;/li&gt;
	&lt;li&gt;Changes needed in MP and extensions&lt;/li&gt;
	&lt;li&gt;Converted tests code to not use the deprecated API.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All tests pass, including core, contrib and backwards&lt;/p&gt;</comment>
                    <comment id="12845167" author="earwin" created="Mon, 15 Mar 2010 01:59:38 +0000"  >&lt;p&gt;Or, maybe, we should think of MergePolicy API that doesn&apos;t require one to keep a reference to IW?&lt;br/&gt;
The more you struggle to control such circular multistage initializations and check their validity, the more their ugliness stands out and screams - refactor meee!&lt;/p&gt;</comment>
                    <comment id="12845370" author="mikemccand" created="Mon, 15 Mar 2010 15:44:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Or, maybe, we should think of MergePolicy API that doesn&apos;t require one to keep a reference to IW?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Looks like IW is used pretty widely: for messaging (when infoStream is set), for retrieving the merges, for getting the Directory, and for getting number of deleted docs for a given segment.  I guess an option would be to simply pass it around everywhere.  Then we wouldn&apos;t have to break the circular dependendy.&lt;/p&gt;

&lt;p&gt;This is what MergeScheduler appears to do &amp;#8211; it&apos;s passed to .merge, and then each bg thread in CMS holds a reference to the writer (since it needs to ask for followon merges).&lt;/p&gt;</comment>
                    <comment id="12845490" author="shaie" created="Mon, 15 Mar 2010 20:05:15 +0000"  >&lt;p&gt;The thing is that we were at that position already, before I changed it so that MP requires writer up front. The reason was, like Mike mentioned, that writer had to be passed on all method calls, for really no good reason. A MP is usually coupled w/ an IW instance and I don&apos;t think we should opt for decoupling them.&lt;/p&gt;

&lt;p&gt;Most of this patch removes MP setting from IW to IWC (and hence changes test code to use the new API). The SetOnce juggling is done only to ensure an IW is set exactly once on MP, and allows us to resolve that circular dependency. We can do two things:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Continue w/ SetOnce as introduced in this patch.&lt;/li&gt;
	&lt;li&gt;Introduce a setIndexWriter on MP which anyone can call, even more than once.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;With (1) I don&apos;t think we complicate anything, and SetOnce can be useful in other places as well. (2) is really like passing writer on all method calls, so let&apos;s at least not have it as part of all methods signature. I prefer (1) slightly over (2) but am fine w/ (2) as well. I wouldn&apos;t want to change MP back to require IW on all its methods.&lt;/p&gt;</comment>
                    <comment id="12845530" author="earwin" created="Mon, 15 Mar 2010 21:13:54 +0000"  >&lt;p&gt;We could split MergePolicy in two - class that represents the policy (config/factory) and class that acts on that policy (instance).&lt;/p&gt;

&lt;p&gt;So IW gets a MergePolicy that has no outside references, and creates a MergePoliceman from it, supplying &apos;this&apos; on construction.&lt;br/&gt;
Thus, circular reference still exists, but is contained for good.&lt;/p&gt;

&lt;p&gt;Not sure I totally love the idea myself though.&lt;/p&gt;</comment>
                    <comment id="12845930" author="shaie" created="Tue, 16 Mar 2010 15:14:40 +0000"  >&lt;p&gt;But it&apos;s MP which requires IW. So how will your policeman (like the name &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) proposal prevent it? I think that setting IW on MP is not such a bad thing. If MP needs it then it needs. The question now is to what length do we want to go w/ it: make it sort of final (in which case SetOnce makes sense) or settle w/ a setIW which is simpler.&lt;/p&gt;

&lt;p&gt;This issue is more about moving MP into IWC than refactor MP. I&apos;d like to keep it focused on that as much as possible. I don&apos;t mean that we should stop discussing the refactoring, just to say it can be done separately. After MP moves to IWC and all code is converted to use the new API, refactoring MP internally should not affect the API level, right?&lt;/p&gt;

&lt;p&gt;If u agree w/ that, then how do u propose to continue? W/ SetOnce or a simple setter?  &lt;/p&gt;</comment>
                    <comment id="12846451" author="mikemccand" created="Wed, 17 Mar 2010 16:17:01 +0000"  >&lt;p&gt;Patch looks good Shai!  I&apos;d rather go with the SetOnce approach than introduce a single-use factory for IW to create the MP.&lt;/p&gt;

&lt;p&gt;But, I don&apos;t think we should keep the MP ctors that take IW?  Ie, you make the MP then call .setIW on it?  We can just remove them (and advertise this in the CHANGES bw break entry) since it&apos;s an experimental API...&lt;/p&gt;</comment>
                    <comment id="12846579" author="shaie" created="Wed, 17 Mar 2010 20:53:37 +0000"  >&lt;p&gt;Attached patch w/ removing the IW-related ctors from MPs, as well as fixing backwards. All tests pass, including javadocs&lt;/p&gt;</comment>
                    <comment id="12846600" author="shaie" created="Wed, 17 Mar 2010 21:24:31 +0000"  >&lt;p&gt;Updating to the latest revision. This should be ok now.&lt;/p&gt;</comment>
                    <comment id="12846610" author="shaie" created="Wed, 17 Mar 2010 21:57:53 +0000"  >&lt;p&gt;Sorry ... I generated the patch on the wrong backwards folder (the one before Uwe&apos;s changes) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I hope this time it&apos;s ok ...&lt;/p&gt;</comment>
                    <comment id="12846614" author="thetaphi" created="Wed, 17 Mar 2010 22:06:51 +0000"  >&lt;p&gt;Its normally not the idea of backwards tests to change the src/java part of the backwards part, as this would hide a backwards break. You should only change only src/tests in backwards! src/java is only for compiling a JAR file of the old lucene version, if you change it, you test against the wrong classes!&lt;/p&gt;

&lt;p&gt;Uwe&lt;/p&gt;</comment>
                    <comment id="12846615" author="shaie" created="Wed, 17 Mar 2010 22:10:27 +0000"  >&lt;p&gt;Uwe, I&apos;m pretty familiar w/ how backwards goes .. I&apos;ve had a lot of bw breaks in my contributions history &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. This patch + issue removes the MP ctor which accepts IW and exposes the default ctor only. That&apos;s a bw break, which is documented in CHANGES as well as was agreed on here because MP is experimental and gives us the freedom to do that (not that it&apos;s such a drastic change). Therefore I had to update the src/java section of bw, so that its tests would compile against MPs that expose the default ctor, and not the one accepting IW.&lt;/p&gt;</comment>
                    <comment id="12846619" author="thetaphi" created="Wed, 17 Mar 2010 22:15:43 +0000"  >&lt;p&gt;In that case just remove the test in backwards. If you just replicate it in the same way like in trunk, it does not make sense.&lt;/p&gt;</comment>
                    <comment id="12846621" author="mikemccand" created="Wed, 17 Mar 2010 22:23:27 +0000"  >&lt;p&gt;I think it&apos;s OK to add stubs to src/* under backwards branch, in cases like this?  Ie when an experimental API is changed.&lt;/p&gt;

&lt;p&gt;Just removing the tests that use the affected API isn&apos;t really an option here &amp;#8211; eg some tests explicitly set up a LogDocMergePolicy (not sure exactly why) and we in general can&apos;t just remove that.&lt;/p&gt;</comment>
                    <comment id="12846622" author="markrmiller@gmail.com" created="Wed, 17 Mar 2010 22:29:54 +0000"  >&lt;p&gt;+1 - I&apos;ve had to do this in the past too. Just dropping tests doesn&apos;t seem like the way to go in many cases.&lt;/p&gt;</comment>
                    <comment id="12846665" author="mikemccand" created="Wed, 17 Mar 2010 23:25:59 +0000"  >&lt;p&gt;Shai this patch looks good &amp;#8211; thanks!  Somehow you keep getting yourself sucked into the issues that need big patches to fix....&lt;/p&gt;</comment>
                    <comment id="12846812" author="shaie" created="Thu, 18 Mar 2010 09:29:56 +0000"  >&lt;p&gt;Fixed a copy-paste comment error in IndexWriter (introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2294&quot; title=&quot;Create IndexWriterConfiguration and store all of IW configuration there&quot;&gt;&lt;del&gt;LUCENE-2294&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                    <comment id="12846997" author="shaie" created="Thu, 18 Mar 2010 16:58:54 +0000"  >&lt;p&gt;Mike - are you reviewing it? I think I fixed all mentioned comments.&lt;/p&gt;</comment>
                    <comment id="12847008" author="mikemccand" created="Thu, 18 Mar 2010 17:19:08 +0000"  >&lt;p&gt;The patch looks great Shai &amp;#8211; I plan to commit in a day or two.&lt;/p&gt;

&lt;p&gt;I added @lucene.experimental to SetOnce&apos;s jdocs, and also removed stale javadoc in MP and MS saying that you need access to package-private APIs (unrelated to this issue but spotted it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                    <comment id="12847034" author="shaie" created="Thu, 18 Mar 2010 18:04:31 +0000"  >&lt;p&gt;Thanks Mike !&lt;/p&gt;</comment>
                    <comment id="12847623" author="mikemccand" created="Fri, 19 Mar 2010 22:34:11 +0000"  >&lt;p&gt;Thanks Shai!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12439135" name="LUCENE-2320.patch" size="132792" author="shaie" created="Thu, 18 Mar 2010 09:29:56 +0000" />
                    <attachment id="12439085" name="LUCENE-2320.patch" size="129097" author="shaie" created="Wed, 17 Mar 2010 21:57:53 +0000" />
                    <attachment id="12439083" name="LUCENE-2320.patch" size="130054" author="shaie" created="Wed, 17 Mar 2010 21:24:31 +0000" />
                    <attachment id="12439071" name="LUCENE-2320.patch" size="128378" author="shaie" created="Wed, 17 Mar 2010 20:53:37 +0000" />
                    <attachment id="12438760" name="LUCENE-2320.patch" size="111883" author="shaie" created="Sun, 14 Mar 2010 15:46:28 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 14 Mar 2010 10:16:25 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11474</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25405</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>