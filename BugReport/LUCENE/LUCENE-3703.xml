<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:02:20 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3703/LUCENE-3703.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3703] DirectoryTaxonomyReader.refresh misbehaves with ref counts</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3703</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;DirectoryTaxonomyReader uses the internal IndexReader in order to track its own reference counting. However, when you call refresh(), it reopens the internal IndexReader, and from that point, all previous reference counting gets lost (since the new IndexReader&apos;s refCount is 1).&lt;/p&gt;

&lt;p&gt;The solution is to track reference counting in DTR itself. I wrote a simple unit test which exposes the bug (will be attached with the patch shortly).&lt;/p&gt;</description>
                <environment></environment>
            <key id="12538796">LUCENE-3703</key>
            <summary>DirectoryTaxonomyReader.refresh misbehaves with ref counts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Jan 2012 13:36:11 +0000</created>
                <updated>Fri, 10 May 2013 11:42:48 +0100</updated>
                    <resolved>Sun, 22 Jan 2012 05:15:19 +0000</resolved>
                                            <fixVersion>3.6</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/facet</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13188440" author="shaie" created="Wed, 18 Jan 2012 13:37:46 +0000"  >&lt;p&gt;Forgot to mention that Doron actually discovered the bug, I just had the time to provide the fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                    <comment id="13188444" author="shaie" created="Wed, 18 Jan 2012 13:46:11 +0000"  >&lt;p&gt;Patch fixes the bug by moving to track reference count by DTR. Also, added a test which covers that bug.&lt;/p&gt;

&lt;p&gt;On the go, fixed close() to synchronize on this if the instance is not already closed. Otherwise, two threads that call close() concurrently might fail (one of them) in decRef().&lt;/p&gt;

&lt;p&gt;I think it&apos;s ready to commit, will wait until tomorrow for review.&lt;/p&gt;</comment>
                    <comment id="13188975" author="doronc" created="Thu, 19 Jan 2012 07:37:52 +0000"  >&lt;p&gt;Patch looks good, builds and passes for me, thanks for fixing this Shai.&lt;/p&gt;

&lt;p&gt;Few comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;CHANGES: rephrase the e.g. part like this: (e.g. if application called incRef/decRef).&lt;/li&gt;
	&lt;li&gt;New test:
	&lt;ul&gt;
		&lt;li&gt;LTC.newDirectory() instead of new RAMDirectory().&lt;/li&gt;
		&lt;li&gt;text messages in the asserts.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;DTR:
	&lt;ul&gt;
		&lt;li&gt;Would it be simpler to make close() synchronized (just like IR.close())&lt;/li&gt;
		&lt;li&gt;Would it - again - be simpler to keep maintaining the ref-counts in the internal IR and just, in refresh, decRef as needed in the old one and incRef accordingly in the new one? This way we continue to delegate that logic to IR, and do not duplicate it.&lt;/li&gt;
		&lt;li&gt;Current patch removes the ensureOpen() check from getRefCount(). I think this is correct - in fact I needed that when debugging this. Perhaps should document about it in CHANGES entry.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13188990" author="shaie" created="Thu, 19 Jan 2012 08:17:13 +0000"  >&lt;p&gt;Thanks for reviewing Doron !&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;CHANGES: rephrase the e.g. part like this: (e.g. if application called incRef/decRef).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will fix, thanks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;LTC.newDirectory() instead of new RAMDirectory()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I wrote a comment in the test &quot;// no need for random directories here&quot; &amp;#8211; it&apos;s really not related to any Directory.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;text messages in the asserts.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;added.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would it be simpler to make close() synchronized (just like IR.close())&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It would, but then it&apos;d mean everyone who calls close() will wait, even if the TR is already closed. The code now is a nice way to only block threads which discover that TR is not already closed. I don&apos;t think it&apos;s that critical (how often do you call close() anyway), so I don&apos;t mind to keep it / make the entire method synchronized.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would it - again - be simpler to keep maintaining the ref-counts in the internal IR&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that the code would look odd &amp;#8211; we&apos;ll ir.openIfChanged, then call incRef() until newIR.getRefCount() == oldIR.getRefCount(). And I&apos;m not sure how will that play with someone calling concurrently to DTR.decRef() ... it might be a mess. Even though we duplicate ref counting logic, I think it&apos;s safer, but perhaps I misunderstood what you meant?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Perhaps should document about it in CHANGES entry.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will mention it as well.&lt;/p&gt;</comment>
                    <comment id="13188991" author="shaie" created="Thu, 19 Jan 2012 08:20:43 +0000"  >&lt;p&gt;Patch addresses Doron&apos;s comments.&lt;/p&gt;</comment>
                    <comment id="13189036" author="doronc" created="Thu, 19 Jan 2012 10:05:21 +0000"  >&lt;p&gt;Missed that test comment about no need for random directory.&lt;br/&gt;
About the decRef dup code, yeah, that&apos;s what I meant, but okay.&lt;br/&gt;
I think this is ready to commit.&lt;/p&gt;</comment>
                    <comment id="13190608" author="shaie" created="Sun, 22 Jan 2012 05:15:20 +0000"  >&lt;p&gt;Committed revision 1234450 (3x), 1234451 (trunk).&lt;/p&gt;

&lt;p&gt;Thanks Doron !&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12511105" name="LUCENE-3703.patch" size="5431" author="shaie" created="Thu, 19 Jan 2012 08:20:43 +0000" />
                    <attachment id="12510980" name="LUCENE-3703.patch" size="5296" author="shaie" created="Wed, 18 Jan 2012 13:46:11 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 19 Jan 2012 07:37:52 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>224300</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>23995</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>