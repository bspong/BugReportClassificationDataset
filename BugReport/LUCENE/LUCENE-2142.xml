<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:30:38 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2142/LUCENE-2142.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2142] FieldCache.getStringIndex should not throw exception if term count exceeds doc count</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2142</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Spinoff of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2133&quot; title=&quot;[PATCH] IndexCache: Refactoring of FieldCache, FieldComparator, SortField&quot;&gt;LUCENE-2133&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-831&quot; title=&quot;Complete overhaul of FieldCache API/Implementation&quot;&gt;LUCENE-831&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Currently FieldCache cannot handle more than one value per field.&lt;br/&gt;
We may someday want to fix that... but until that day:&lt;/p&gt;

&lt;p&gt;FieldCache.getStringIndex currently does a simplistic check to try to&lt;br/&gt;
catch when you&apos;ve accidentally allowed more than one term per field,&lt;br/&gt;
by testing if the number of unique terms exceeds the number of&lt;br/&gt;
documents.&lt;/p&gt;

&lt;p&gt;The problem is, this is not a perfect check, in that it allows false&lt;br/&gt;
negatives (you could have more than one term per field for some docs&lt;br/&gt;
and the check won&apos;t catch you).&lt;/p&gt;

&lt;p&gt;Further, the exception thrown is the unchecked RuntimeException.&lt;/p&gt;

&lt;p&gt;So this means... you could happily think all is good, until some day,&lt;br/&gt;
well into production, once you&apos;ve updated enough docs, suddenly the&lt;br/&gt;
check will catch you and throw an unhandled exception, stopping all&lt;br/&gt;
searches &lt;span class=&quot;error&quot;&gt;&amp;#91;that need to sort by this string field&amp;#93;&lt;/span&gt; in their tracks.&lt;br/&gt;
It&apos;s not gracefully degrading.&lt;/p&gt;

&lt;p&gt;I think we should simply remove the test, ie, if you have more terms&lt;br/&gt;
than docs then the terms simply overwrite one another.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12443006">LUCENE-2142</key>
            <summary>FieldCache.getStringIndex should not throw exception if term count exceeds doc count</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Dec 2009 17:32:02 +0000</created>
                <updated>Fri, 28 Jan 2011 02:06:32 +0000</updated>
                    <resolved>Thu, 24 Jun 2010 13:10:22 +0100</resolved>
                                            <fixVersion>2.9.4</fixVersion>
                <fixVersion>3.0.3</fixVersion>
                <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12788925" author="yseeley@gmail.com" created="Thu, 10 Dec 2009 21:05:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="12789474" author="earwin" created="Fri, 11 Dec 2009 19:19:01 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="12873415" author="mikemccand" created="Sun, 30 May 2010 13:29:23 +0100"  >&lt;p&gt;backport&lt;/p&gt;</comment>
                    <comment id="12876102" author="koji" created="Mon, 7 Jun 2010 02:07:04 +0100"  >&lt;blockquote&gt;
&lt;p&gt;I think we should simply remove the test, ie, if you have more terms&lt;br/&gt;
than docs then the terms simply overwrite one another.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think the remove still throws unhandled exception (AIOOBE)?&lt;/p&gt;</comment>
                    <comment id="12880344" author="mikemccand" created="Fri, 18 Jun 2010 23:12:47 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think the remove still throws unhandled exception (AIOOBE)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Duh, right!&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what I was smoking when I did this... the fix makes the exception worse since you now get a cryptic AIOOBE instead of a RuntimeException explaining what&apos;s wrong.&lt;/p&gt;</comment>
                    <comment id="12880432" author="thetaphi" created="Sat, 19 Jun 2010 07:38:38 +0100"  >&lt;p&gt;When does it throw AIOOBE (have not tested it...)? For me the code looked fine, too, so I don&apos;t think Mike was smoking something. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12880441" author="thetaphi" created="Sat, 19 Jun 2010 08:11:20 +0100"  >&lt;p&gt;After a coffee i have seen the problem, too - stupoid &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Here is the fix for 3.x (also 3.0 and 2.9) - in trunk the fix is not needed, as there are growable arrays. Maybe we should add a simple test to all branches!&lt;/p&gt;
</comment>
                    <comment id="12880456" author="thetaphi" created="Sat, 19 Jun 2010 09:15:32 +0100"  >&lt;p&gt;Here patch with test for 3.x and before. Trunk patch only contains test, which passes.&lt;/p&gt;</comment>
                    <comment id="12880463" author="mikemccand" created="Sat, 19 Jun 2010 10:08:43 +0100"  >&lt;p&gt;Thanks Uwe!&lt;/p&gt;

&lt;p&gt;So your fix avoids any exception altogether.  On 3x, you just stop&lt;br/&gt;
loading when we hit a termOrd &amp;gt; number of docs.  On trunk, we keep&lt;br/&gt;
loading, simply growing the array as needed.&lt;/p&gt;

&lt;p&gt;I&apos;m torn on what the best disposition here is.  This API should only&lt;br/&gt;
be used on single-token (per doc) fields, so this handling we&apos;re&lt;br/&gt;
adding/fixing is about how to handle the misuse of the API.&lt;/p&gt;

&lt;p&gt;Neither solution is great &amp;#8211; throwing an exception is nasty since you&lt;br/&gt;
could be fine for some time and then only on indexing enough docs,&lt;br/&gt;
perhaps well into production, trip the exception.  But then silently&lt;br/&gt;
pretending nothing is wrong is also not great because the app then has&lt;br/&gt;
no clue.&lt;/p&gt;

&lt;p&gt;Really this&apos;d be a great time to use a logging framework &amp;#8211; we&apos;d drop&lt;br/&gt;
a error, and then not throw an exception.&lt;/p&gt;

&lt;p&gt;Net/net I think your solution (don&apos;t throw an exception) is the lesser&lt;br/&gt;
evil at this time, so I think we should go with that.&lt;/p&gt;

&lt;p&gt;But: I think we should also fix trunk?  Ie, if hit termOrd &amp;gt; numDocs,&lt;br/&gt;
silently break, instead of trying to grow the array.  Because now (on&lt;br/&gt;
trunk) if you try to load a DocTermsIndex on a large tokenized text&lt;br/&gt;
field in a large index you&apos;ll (try to) use insane amounts of memory...&lt;/p&gt;
</comment>
                    <comment id="12882119" author="thetaphi" created="Thu, 24 Jun 2010 11:42:38 +0100"  >&lt;p&gt;Committed in trunk, 3x, 3.0, 2.9 branches.&lt;/p&gt;

&lt;p&gt;Trunk is still missing the escape-branch when term count exceeds doc count.&lt;/p&gt;</comment>
                    <comment id="12882129" author="mikemccand" created="Thu, 24 Jun 2010 12:10:22 +0100"  >&lt;p&gt;Patch to fix trunk to stop loading when number of terms &amp;gt; maxDoc.&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12480640">SOLR-2249</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                        <issuelinktype id="12310050">
                <name>Regression</name>
                                <outwardlinks description="breaks">
                            <issuelink>
            <issuekey id="12497007">SOLR-2339</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12447527" name="LUCENE-2142-fix-3x.patch" size="1870" author="thetaphi" created="Sat, 19 Jun 2010 09:15:32 +0100" />
                    <attachment id="12447528" name="LUCENE-2142-fix-trunk.patch" size="1271" author="thetaphi" created="Sat, 19 Jun 2010 09:15:32 +0100" />
                    <attachment id="12447940" name="LUCENE-2142-trunk.patch" size="3190" author="mikemccand" created="Thu, 24 Jun 2010 12:10:22 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 10 Dec 2009 21:05:42 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11639</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25583</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>