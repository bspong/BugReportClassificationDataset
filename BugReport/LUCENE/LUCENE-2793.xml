<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:02:04 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2793/LUCENE-2793.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2793] Directory createOutput and openInput should take an IOContext</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2793</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Today for merging we pass down a larger readBufferSize than for searching because we get better performance.&lt;/p&gt;

&lt;p&gt;I think we should generalize this to a class (IOContext), which would hold the buffer size, but then could hold other flags like DIRECT (bypass OS&apos;s buffer cache), SEQUENTIAL, etc.&lt;/p&gt;

&lt;p&gt;Then, we can make the DirectIOLinuxDirectory fully usable because we would only use DIRECT/SEQUENTIAL during merging.&lt;/p&gt;

&lt;p&gt;This will require fixing how IW pools readers, so that a reader opened for merging is not then used for searching, and vice/versa.  Really, it&apos;s only all the open file handles that need to be different &amp;#8211; we could in theory share del docs, norms, etc, if that were somehow possible.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12491994">LUCENE-2793</key>
            <summary>Directory createOutput and openInput should take an IOContext</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="varunthacker">Varun Thacker</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                        <label>gsoc2011</label>
                        <label>lucene-gsoc-11</label>
                        <label>mentor</label>
                    </labels>
                <created>Fri, 3 Dec 2010 15:47:34 +0000</created>
                <updated>Fri, 10 May 2013 11:43:57 +0100</updated>
                    <resolved>Fri, 8 Jul 2011 09:53:32 +0100</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                <fixVersion>IOContext branch</fixVersion>
                                <component>core/store</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>4</watches>
                                                    <comments>
                    <comment id="12966564" author="rcmuir" created="Fri, 3 Dec 2010 16:05:46 +0000"  >&lt;p&gt;Sounds great, at least in theory we could do the DIRECT thing on windows too for this case.&lt;br/&gt;
and we can certainly give the sequential hint.&lt;/p&gt;

&lt;p&gt;in general hints like this are probably good for custom dir impls too, we never know what they are doing&lt;br/&gt;
but its good to somehow inform them of our intentions so they have a chance to be optimal.&lt;/p&gt;</comment>
                    <comment id="12966566" author="thetaphi" created="Fri, 3 Dec 2010 16:12:23 +0000"  >&lt;p&gt;And MMapDir should return a simple/optimized direct FSIndexInput also. Because MMapping for merging is just wasted resources/address space.&lt;/p&gt;</comment>
                    <comment id="12966963" author="rcmuir" created="Sun, 5 Dec 2010 15:05:53 +0000"  >&lt;p&gt;There is another problem we should solve here, and that is the buffersize problem.&lt;/p&gt;

&lt;p&gt;This is totally broken at the moment for custom directories, here&apos;s an example.&lt;br/&gt;
I wanted to set the buffersize by default to 4096 (since i measured this is like a 20% improvement for my directory impl).&lt;/p&gt;

&lt;p&gt;looking at the apis you would think that you simply override the openInput that takes no buffer size like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  @Override
  public IndexInput openInput(String name) throws IOException {
    return openInput(name, 4096);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;unfortunately this doesnt work at all! instead you have to do something like this for it to actually &quot;work&quot;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   @Override
   public IndexInput openInput(String name, int bufferSize) throws IOException {
      ensureOpen();
      return new IndexInput(name, Math.max(bufferSize, 4096));
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is, throughout lucene&apos;s APIs, the directory&apos;s &quot;default&quot; is never used, instead the static BufferedIndexInput.BUFFER_SIZE is used everywhere... eg SegmentReader.get:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  public static SegmentReader get(boolean readOnly, SegmentInfo si, int termInfosIndexDivisor) throws CorruptIndexException, IOException {
    return get(readOnly, si.dir, si, BufferedIndexInput.BUFFER_SIZE, true, termInfosIndexDivisor);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I think lucene&apos;s apis should never specify buffersize, we should remove it completely from the codecs api, and it should be &lt;b&gt;replaced&lt;/b&gt; with IOContext.&lt;/p&gt;</comment>
                    <comment id="12970530" author="jasonrutherglen" created="Sat, 11 Dec 2010 21:43:46 +0000"  >&lt;p&gt;Perhaps we can add the ability to throttle Directory level IO to this issue.   &lt;/p&gt;</comment>
                    <comment id="12979728" author="jasonrutherglen" created="Mon, 10 Jan 2011 20:08:30 +0000"  >&lt;p&gt;Shall I take this one?  With the plan being to add config options to IWC so that IW uses the DirectIOLinuxDirectory (and it&apos;s variants) only for merging?&lt;/p&gt;</comment>
                    <comment id="12979731" author="mikemccand" created="Mon, 10 Jan 2011 20:12:57 +0000"  >&lt;p&gt;Yes please!&lt;/p&gt;

&lt;p&gt;But, this issue only adds the IOContext, threading it down to when you open an input / create an output.  That context should hold enough &quot;information&quot; to allow the Dir impl to make decisions like buffer sizes and avoiding buffer cache, etc.&lt;/p&gt;</comment>
                    <comment id="12979736" author="jasonrutherglen" created="Mon, 10 Jan 2011 20:21:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;this issue only adds the IOContext, threading it down to when you open an input / create an output&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Does this mean we&apos;re not implementing this part?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This will require fixing how IW pools readers, so that a reader opened for merging is not then used for searching, and vice/versa. Really, it&apos;s only all the open file handles that need to be different - we could in theory share del docs, norms, etc, if that were somehow possible.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                    <comment id="12979738" author="mikemccand" created="Mon, 10 Jan 2011 20:30:28 +0000"  >&lt;p&gt;Sorry, I think we should also do that as part of this issue.  Basically the IOContext needs to become part of the cache key uses in IW&apos;s ReaderPool?&lt;/p&gt;</comment>
                    <comment id="12979740" author="jasonrutherglen" created="Mon, 10 Jan 2011 20:33:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;Basically the IOContext needs to become part of the cache key uses in IW&apos;s ReaderPool? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great, I&apos;ll implement this.&lt;/p&gt;</comment>
                    <comment id="12980214" author="jasonrutherglen" created="Tue, 11 Jan 2011 17:52:10 +0000"  >&lt;p&gt;Ok, I created an IOFactory class that generates input and output streams.  It&apos;s settable on IOContext.  The merge IOContext may be set on IWC.  I will test once the object model gets the nod...&lt;/p&gt;</comment>
                    <comment id="12980400" author="earwin" created="Tue, 11 Jan 2011 22:43:38 +0000"  >&lt;p&gt;Looks crazy. In a &lt;del&gt;bad&lt;/del&gt; tangled way.&lt;br/&gt;
You get IOFactory from Directory, put into IOContext, and then invoke it, passing it (wow!) an IOContext and a Directory. What if you pass totally different Directory? Different IOContext? It blows up eerily.&lt;/p&gt;

&lt;p&gt;And there&apos;s no justification for this - we already have an IOFactory, it&apos;s called Directory! It just needs an extra parameter on its factory methods (createInput/Output), that&apos;s all.&lt;/p&gt;</comment>
                    <comment id="12980435" author="jasonrutherglen" created="Tue, 11 Jan 2011 23:35:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;You get IOFactory from Directory&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s for the default, the main use is the static IOFactory class.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we already have an IOFactory, it&apos;s called Directory&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, however we&apos;re basically trying to intermix Directory&apos;s, which doesn&apos;t work when pointed at the same underlying File.  I thought about a meta-Directory that routes based on the IOContext, however we&apos;d still need a way to create an IndexInput and IndexOutput, from different Directory implementations.  &lt;/p&gt;</comment>
                    <comment id="12980454" author="earwin" created="Wed, 12 Jan 2011 00:06:12 +0000"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;You get IOFactory from Directory&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s for the default, the main use is the static IOFactory class.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You lost me here. If you got A from B, you don&apos;t have to pass B again to invoke A, if you do - that&apos;s 99% a design mistake.&lt;br/&gt;
But still, my point was that you don&apos;t need IOFactory at all.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Right, however we&apos;re basically trying to intermix Directory&apos;s, which doesn&apos;t work when pointed at the same underlying File. I thought about a meta-Directory that routes based on the IOContext, however we&apos;d still need a way to create an IndexInput and IndexOutput, from different Directory implementations. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What Directories are you trying to intermix? What for?&lt;/p&gt;

&lt;p&gt;I thought the only thing done in that issue is an attempt to give Directory hints as to why we&apos;re going to open its streams.&lt;br/&gt;
A simple enum IOContext and extra parameter on createOutput/Input would suffice. But with Lucene&apos;s micromanagement attitude, an enum turns into slightly more complex thing, with bufferSizes and whatnot.&lt;br/&gt;
Still - no need for mixing Directories.&lt;/p&gt;</comment>
                    <comment id="12980458" author="earwin" created="Wed, 12 Jan 2011 00:24:46 +0000"  >&lt;p&gt;In fact, I suggest dropping bufferSize altogether. As far as I can recall, it was introduced as a precursor to IOContext and can now be safely replaced.&lt;/p&gt;

&lt;p&gt;Even if we want to give user control over buffer size for all streams, or only those opened in specific IOContext, he can pass these numbers as config parameters to his Directory impl.&lt;br/&gt;
That makes total sense, as:&lt;br/&gt;
1. IndexWriter/IndexReader couldn&apos;t care less about buffer sizes, it just passes them to the Directory. It&apos;s not their concern.&lt;br/&gt;
2. A bunch of Directories doesn&apos;t use said bufferSize at all, making this parameter not only private Directory affairs, but even further - implementation-specific.&lt;/p&gt;

&lt;p&gt;So my bet is - introduce IOContext as a simple Enum, change bufferSize parameter on createInput/Output to IOContext, done.&lt;/p&gt;</comment>
                    <comment id="12980470" author="rcmuir" created="Wed, 12 Jan 2011 00:43:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;In fact, I suggest dropping bufferSize altogether.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2793?focusedCommentId=12966963&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#action_12966963&quot; class=&quot;external-link&quot;&gt;https://issues.apache.org/jira/browse/LUCENE-2793?focusedCommentId=12966963&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#action_12966963&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So my bet is - introduce IOContext as a simple Enum, change bufferSize parameter on createInput/Output to IOContext, done.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, its the directories job to then take that IOContext and create an appropriate IndexOutput.&lt;/p&gt;</comment>
                    <comment id="12980533" author="jasonrutherglen" created="Wed, 12 Jan 2011 03:30:55 +0000"  >&lt;p&gt;Ok, lets remove bufferSize.  &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;its the directories job to then take that IOContext and create an appropriate IndexOutput.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s how the patch works.  If that doesn&apos;t look good, the other option is placing the logic in FSDirectory and removing the FSDirectory subclasses?&lt;/p&gt;</comment>
                    <comment id="12980543" author="rcmuir" created="Wed, 12 Jan 2011 04:08:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;That&apos;s how the patch works. If that doesn&apos;t look good, the other option is placing the logic in FSDirectory and removing the FSDirectory subclasses?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We don&apos;t need to make any changes to Directory itself here, other than openInput/createOutput taking IOContext instead of bufferSize.&lt;br/&gt;
The directory is the factory for opening the correct openInput/createOutput based on its parameters, this just needs to be one.&lt;/p&gt;

&lt;p&gt;As Mike said, the important thing is to not re-use an input that was opened with IOContext=Merging for search.&lt;br/&gt;
If you ask the directory to openInput with IOContext=merging, thats all it should be used for, because that Directory &lt;br/&gt;
could be implementing that with O_DIRECT or similar, which is slow for searching.&lt;/p&gt;

&lt;p&gt;we can muck with DirectIOLinuxDirectory later on another issue (e.g. make it a directory wrapper that just overrides &lt;br/&gt;
openInput and only does something interesting when IOContext=Merging, or NIOFSDirectory subclass, or whatever&lt;br/&gt;
we end up deciding).&lt;/p&gt;</comment>
                    <comment id="12980546" author="jasonrutherglen" created="Wed, 12 Jan 2011 04:24:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;The directory is the factory for opening the correct openInput/createOutput based on its parameters, this just needs to be one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, however which Directory impl is going to do this?  Today they&apos;re tied to their specific implementations of IndexInputs and IndexOutputs, eg, NIOFSIndexInput, DirectIOLinuxIndexInput, etc.  In order to get an NIOFSIndexInput we need to instantiate NIOFSDirectory, however if we also want to use DirectIOLinuxDirectory, then (in today&apos;s model) we need to instantiate it as well.  To create an index or output, all we need is a parent FSDIrectory and the rest is encapsulated in the underlying input/output implementation.  &lt;/p&gt;</comment>
                    <comment id="12980551" author="shaie" created="Wed, 12 Jan 2011 04:33:34 +0000"  >&lt;p&gt;If we drop bufferSize, how will I be able to tell Lucene I&apos;m willing to spare, say, 1 MB buffer for this IndexInput/Output? Am I supposed to create my own Directory and open II/IO, depending on the IOContext.Mode and decide on the buffer size then?&lt;/p&gt;

&lt;p&gt;If so, then I don&apos;t understand how this would work (think that&apos;s what Jason is asking) - if I impl MyDirectory (extending Directory? FSDirectory?) which is probably going to be a wrapper Directory, what II/IO impl should I invoke? I&apos;ll need to extend BufferedIndexInput/Output, impl its abstract methods, just for delegating to the wrapped Directory&apos;s II/IO?&lt;/p&gt;

&lt;p&gt;If I misunderstood the intentions, I&apos;d appreciate if you can clarify them. But if not, I think IOContext should include a bufferSize hint. If the Directory does not intend to do anything special for &apos;merging&apos;, then it can take bufferSize into account. If however it&apos;s a Linux Directory that wants to set the O_DIRECT, then it can ignore bufferSize. But I think it&apos;s a useful hint.&lt;/p&gt;</comment>
                    <comment id="12980555" author="jasonrutherglen" created="Wed, 12 Jan 2011 04:41:00 +0000"  >&lt;p&gt;In the patch the bufferSize is an int member of IOContext.  We could feasibly go to a map of attributes model if we think there&apos;ll be a lot more options in the future?  Or the IOContext class can be subclassed.&lt;/p&gt;

&lt;p&gt;Also, in the patch the IOContext for searching and merging is set in IWC, then should be reused.  This way the bufferSize is settable by the user, which I don&apos;t think is easily possible today (perhaps the main motivation for this issue?).&lt;/p&gt;</comment>
                    <comment id="12980557" author="rcmuir" created="Wed, 12 Jan 2011 04:47:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we drop bufferSize, how will I be able to tell Lucene I&apos;m willing to spare, say, 1 MB buffer for this IndexInput/Output? Am I supposed to create my own Directory and open II/IO, depending on the IOContext.Mode and decide on the buffer size then?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;with .setBufferSize. The only place in lucene that intelligently uses buffersize (Skiplist reading) sets it this way, not with the ctor param.&lt;/p&gt;

&lt;p&gt;otherwise, i think you are confused if you think lucene actually passes any intelligent value for this ctor parameter.&lt;br/&gt;
it doesn&apos;t... it usually passes the static BufferedIndexInput.BUFFER_SIZE&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If so, then I don&apos;t understand how this would work (think that&apos;s what Jason is asking) - if I impl MyDirectory (extending Directory? FSDirectory?) which is probably going to be a wrapper Directory, what II/IO impl should I invoke? I&apos;ll need to extend BufferedIndexInput/Output, impl its abstract methods, just for delegating to the wrapped Directory&apos;s II/IO?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t understand whats so terribly difficult about:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (context == MERGING)
 return mySpecialmergingInput();
else
 return super.openInput(...);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12980559" author="shaie" created="Wed, 12 Jan 2011 04:54:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;This way the bufferSize is settable by the user, which I don&apos;t think is easily possible today (perhaps the main motivation for this issue?)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Exactly ! That&apos;s what I thought of this issue in the first place - allow the app to more easily control the size of the buffers used by Lucene. That that IOContext will allow me to set different bufferSizes per the work that Lucene&apos;s doing (i.e. merge, search) is a bonus for me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;I still think bufferSize can be used as a hint by the specific Directory impl, but it should be there.&lt;/p&gt;

&lt;p&gt;If we want to allow control of different buffer sizes per operation, then maybe we can do the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Set a default buffer size on IOContext.&lt;/li&gt;
	&lt;li&gt;Add a setBufferSize(OpType type, int/long bufferSize)&lt;/li&gt;
	&lt;li&gt;Add getBufferSize(OpType) &amp;#8211; returns the set buffer size, or the default if not set.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I don&apos;t think it&apos;s too complicated and gives enough control to the application?&lt;/p&gt;</comment>
                    <comment id="12980561" author="shaie" created="Wed, 12 Jan 2011 04:57:18 +0000"  >&lt;p&gt;Robert, nothing is too difficult to understand. But your code example tells me that if I want to control the buffer size used by Lucene (whether it&apos;s done intelligently or not today is what we try to fix here), I need to create my own Dir impl. That seems an overkill to me, for just controlling the bufferSize !?&lt;/p&gt;</comment>
                    <comment id="12980564" author="rcmuir" created="Wed, 12 Jan 2011 05:22:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;But your code example tells me that if I want to control the buffer size used by Lucene (whether it&apos;s done intelligently or not today is what we try to fix here), I need to create my own Dir impl. That seems an overkill to me, for just controlling the bufferSize !?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No you dont... you can also call the .setBufferSize like the skiplist reader does.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;IndexInput input = dir.openInput(....)
if (input instanceof BufferedIndexInput)
...setBufferSize(whatever_you_want);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because after all, buffersize only makes sense on Buffered*.&lt;/p&gt;

&lt;p&gt;It makes no sense to be on Directory&apos;s openInput, e.g. it makes no sense for directories like MMapDirectory.&lt;/p&gt;</comment>
                    <comment id="12980625" author="shaie" created="Wed, 12 Jan 2011 08:51:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;No you dont... you can also call the .setBufferSize like the skiplist reader does.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;d still need to impl my Directory though right? That&apos;s the overkill I&apos;m trying to avoid.&lt;/p&gt;

&lt;p&gt;But, I&apos;ve been thinking about how would a merge/search code, which can only tell the Directory it&apos;s in SEARCH / MERGE context, get the buffer size the application wanted to use in that context. I don&apos;t think it has a way to do so without either using a static class, something we try to avoid, or propagating those settings down everywhere, which does not make sense either.&lt;/p&gt;

&lt;p&gt;So, Robert, I think you&apos;re right &amp;#8211; bufferSize should not exist on IOContext. A custom Directory impl seems unavoided. So I think it&apos;d be good if we can create a BufferedDirectoryWrapper which wraps a Directory and offers a BufferedIndexInput/OutputWrapper which delegate the necessary calls to the wrapped Directory. We&apos;ve found ourselves needing to implement that kind of Directory several times already, and it&apos;d be good if Lucene can offer one.&lt;/p&gt;

&lt;p&gt;That Directory would then take IOContext -&amp;gt; bufferSize map/properties/whatever and can take that into account in openInput/createOutput.&lt;/p&gt;

&lt;p&gt;If users will need to impl Directory wrapping, if they want to control buffer sizes, I suggest we make that as painless as possible.&lt;/p&gt;</comment>
                    <comment id="12980649" author="earwin" created="Wed, 12 Jan 2011 10:20:26 +0000"  >&lt;p&gt;What&apos;s with ongoing crazyness? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;DirectIOLinuxDirectory&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;First you introduce a kind of directory that is utterly useless except certain special situations. Then, instead of fixing the directory/folding its code somewhere normal, you try to workaround by switching between directories. What&apos;s the point of using abstract classes or interfaces, if you leak their implementation&apos;s logic all over the place?&lt;br/&gt;
Or making DIOLD wrap something. Yeah! Wrap my RAMDir!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;bufferSize&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This value is only meaningful to a certain subset of Directory implementations. So the only logical place we want to see this value set - is these very impls.&lt;br/&gt;
Sample code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Directory ramDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RAMDirectory();
ramDir.createIndexInput(name, context);
&lt;span class=&quot;code-comment&quot;&gt;// See, ma? No bufferSizes, they are pointless &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; RAMDir
&lt;/span&gt;
Directory fsDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NIOFSDirectory();
fsDir.setBufferSize(IOContext.NORMAL_READ, 1024);
fsDir.setBufferSize(IOContext.MERGE, 4096);
fsDir.createIndexInput(name, context)
&lt;span class=&quot;code-comment&quot;&gt;// See, ma? The only one who&apos;s really concerned with &apos;actual&apos; buffer size is &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; concrete Directory impl
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// All client code is only concerned with the context.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// It&apos;s NIOFSDirectory&apos;s business to give meaningful interpretation &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; IOContext and assign the buffer sizes.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You don&apos;t need custom Directory impls to make DIOLD work, you should freakin&apos; fix it.&lt;br/&gt;
The proper way is to test out the things, and then move DirectIO code to the only place it makes sense in - FSDir? Probably make it switch on/off-able, maybe not.&lt;/p&gt;

&lt;p&gt;You don&apos;t need custom Directory impls to set buffer sizes (neither cast to BufferedIndexInput!), you should add the setting to these Directories, which make sense of it.&lt;/p&gt;</comment>
                    <comment id="12980727" author="shaie" created="Wed, 12 Jan 2011 14:28:35 +0000"  >&lt;p&gt;I assume you mean setBufferSize(IOContext, size) should be added to specific Directory impls, and not Directory? Because in your example code above, it looks like it&apos;s added to Directory itself. Though we can add it to Directory as well, and do nothing there. It simplifies matters as you don&apos;t need to check whether the Dir you receive supports setting buffer size (in case you&apos;re not the one creating it).&lt;/p&gt;

&lt;p&gt;At any rate, this looks like it can work too.&lt;/p&gt;</comment>
                    <comment id="12980731" author="rcmuir" created="Wed, 12 Jan 2011 14:37:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;The proper way is to test out the things, and then move DirectIO code to the only place it makes sense in - FSDir? Probably make it switch on/off-able, maybe not. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure it should be there... at least not soon. its not even something you can implement in pure java? &lt;br/&gt;
we definitely have to keep it still simple and possible for people to use the java library in a platform-indepedent way. &lt;br/&gt;
its also a bit dangerous, whenever JNI is involved....even if its working. &lt;/p&gt;

&lt;p&gt;So I think its craziness, to put this direct-io stuff in fsdirectory itself. &lt;/p&gt;

&lt;p&gt;As I said before though, i wouldn&apos;t mind if we had something more like a &apos;modules/native&apos; and FSDirectory checked, if this was available and automagically used it... &lt;br/&gt;
but I can&apos;t see myself thinking that we should put this logic into fsdir itself, sorry. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Sample code &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My problem with your sample code is that it appears that the .setBufferSize method is on Directory itself. &lt;br/&gt;
Again i disagree with this because: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;its useless to certain directories like MMapDirectory&lt;/li&gt;
	&lt;li&gt;its dangerous in the direct-io case (different platforms have strict requirements that things be sector-aligned etc, see the mac case where it actually &apos;works&apos; if the buffer isnt, but is just slow).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I definitely don&apos;t like the confusion regarding buffersizes now. A very small % of the time its actually meaningful and should be respected, &lt;br/&gt;
but most of the time the value is completely bogus. &lt;/p&gt;</comment>
                    <comment id="12980732" author="earwin" created="Wed, 12 Jan 2011 14:47:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Because in your example code above, it looks like it&apos;s added to Directory itself.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;My problem with your sample code is that it appears that the .setBufferSize method is on Directory itself. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ohoho. My fault, sorry. It should look like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RAMDirectory ramDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RAMDirectory();
ramDir.setBufferSize(whatever) &lt;span class=&quot;code-comment&quot;&gt;// Compilation error!
&lt;/span&gt;ramDir.createIndexInput(name, context);

NIOFSDirectory fsDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NIOFSDirectory();
fsDir.setBufferSize(IOContext.NORMAL_READ, 1024);
fsDir.setBufferSize(IOContext.MERGE, 4096);
fsDir.createIndexInput(name, context)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12980736" author="earwin" created="Wed, 12 Jan 2011 14:51:36 +0000"  >&lt;blockquote&gt;
&lt;p&gt;As I said before though, i wouldn&apos;t mind if we had something more like a &apos;modules/native&apos; and FSDirectory checked, if this was available and automagically used it...&lt;br/&gt;
but I can&apos;t see myself thinking that we should put this logic into fsdir itself, sorry. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m perfectly OK with that approach (having some module FSDir checks). I also feel uneasy having JNI in core.&lt;br/&gt;
What I don&apos;t want to see, is Directory impls that you can&apos;t use on their own. If you can only use it for merging, then it&apos;s not a Directory, it breaks the contract! - move the code elsewhere.&lt;/p&gt;</comment>
                    <comment id="12980740" author="rcmuir" created="Wed, 12 Jan 2011 15:00:53 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;m perfectly OK with that approach (having some module FSDir checks). I also feel uneasy having JNI in core.&lt;br/&gt;
What I don&apos;t want to see, is Directory impls that you can&apos;t use on their own. If you can only use it for merging, then it&apos;s not a Directory, it breaks the contract! - move the code elsewhere.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, i think we all agree we want to fix the DirectIOLinuxDirectory into being a &apos;real&apos; directory?&lt;/p&gt;

&lt;p&gt;As i said before, from a practical perspective, it could be named LinuxDirectory, extend NIOFS, &lt;br/&gt;
and when openInput(IOContext=Merge) it opens its special input. but personally i don&apos;t care how &lt;br/&gt;
we actually implement it &apos;becoming a real directory&apos;. this is another issue, unrelated to this one really.&lt;/p&gt;

&lt;p&gt;this issue is enough and should stand on its own... we should be able to do enough nice things&lt;br/&gt;
here without dealing with JNI: improving our existing directory impls to use larger buffer sizes by &lt;br/&gt;
default when merging, etc (like in your example).&lt;/p&gt;</comment>
                    <comment id="13015785" author="varunthacker" created="Tue, 5 Apr 2011 08:26:23 +0100"  >&lt;p&gt;Hi. I would be interested in taking this up as a GSOC project . Are there any resource that I can read to understand the problem in depth ?&lt;/p&gt;</comment>
                    <comment id="13015790" author="simonw" created="Tue, 5 Apr 2011 08:42:22 +0100"  >&lt;blockquote&gt;&lt;p&gt;Hi. I would be interested in taking this up as a GSOC project . Are there any resource that I can read to understand the problem in depth ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Hey, I just marked it as GSoC-able &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; so you are free to take it. I would also volunteer to mentor on this issue if mike doesn&apos;t want to take it though. Let me try to explain you quickly what this issue is about:&lt;/p&gt;

&lt;p&gt;Lucene uses Directory as an abstraction on top of the filesystem or RAM or any other storage to write the index data. Yet, Lucene has different &quot;stages&quot; where we have different requirements to the underlying storage / directory. When you index documents you eventually flush the index to disk and continue indexing until you created enough &quot;segments&quot; on disk that you need to merged them. This operations should if possible not pollute the FS cache since its really just housekeeping. With Java such its currently not possible to use some flags like DIRECT / SEQUENTIAL, this is what we have the native DirectIODirectory implementations in contrib for. Yet, for reading stuff from the index while searching we want to have the FS cache helping us as much as possible so this has again different requriements. What we currently do is that we pass different read buffer sizes to the directory to improve performance. All those kinds of information should be passed to the directory on a IndexInput / IndexOutput (similar to Input and OutputStream just tailored &amp;amp; enhanced for Lucene) basis and this is what this issue is about. &lt;/p&gt;

&lt;p&gt;hope that helps.&lt;/p&gt;</comment>
                    <comment id="13032992" author="mikemccand" created="Fri, 13 May 2011 13:37:50 +0100"  >&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3092&quot; title=&quot;NRTCachingDirectory, to buffer small segments in a RAMDir&quot;&gt;&lt;del&gt;LUCENE-3092&lt;/del&gt;&lt;/a&gt;, it would be nice if the IOContext would optionally include the OneMerge if in fact the file is being opened for merging... this lets the Dir impl be smart if it wants to customize its behavior according to overall properties of the merge (eg total merged bytes).&lt;/p&gt;</comment>
                    <comment id="13033279" author="earwin" created="Fri, 13 May 2011 21:50:49 +0100"  >&lt;p&gt;As mentioned @&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3092&quot; title=&quot;NRTCachingDirectory, to buffer small segments in a RAMDir&quot;&gt;&lt;del&gt;LUCENE-3092&lt;/del&gt;&lt;/a&gt;, it would be nice not to include the OneMerge, but some meaningful value like &apos;expectedSize&apos;, &apos;expectedSegmentSize&apos; or whatnot, that would work both for merges &lt;b&gt;and&lt;/b&gt; flushes, and also won&apos;t introduce needless dependency on MergePolicy.&lt;/p&gt;</comment>
                    <comment id="13040844" author="varunthacker" created="Sun, 29 May 2011 19:24:32 +0100"  >&lt;p&gt;I have made a class IOContext and added a IOContext object to the Directory createOutput and openInput method parameters. &lt;/p&gt;

&lt;p&gt;If this is the right way to go ?&lt;/p&gt;</comment>
                    <comment id="13040845" author="jasonrutherglen" created="Sun, 29 May 2011 19:34:29 +0100"  >&lt;p&gt;I already posted a patch to this issue a while back, &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12468030/LUCENE-2793.patch&quot; class=&quot;external-link&quot;&gt;https://issues.apache.org/jira/secure/attachment/12468030/LUCENE-2793.patch&lt;/a&gt;  It seems we&apos;re looping here.&lt;/p&gt;</comment>
                    <comment id="13040850" author="varunthacker" created="Sun, 29 May 2011 19:46:57 +0100"  >&lt;p&gt;I should have seen the patch! I have taken this up as a GSoC project. I&apos;ll try to use that patch too if it&apos;s ok.&lt;/p&gt;</comment>
                    <comment id="13040906" author="simonw" created="Mon, 30 May 2011 01:19:17 +0100"  >&lt;blockquote&gt;&lt;p&gt;I already posted a patch to this issue a while back...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Jason I appreciate that you are still around on this issue. Varun is doing his GSoC project on this issue and others so there might be some duplication here and there or similarities with you patch but in this case this is ok though. He needs to get started as well as getting a feeling how things work here. So I hope you don&apos;t mind. I can only encourage you to help reviewing and commenting!&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;If this is the right way to go ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for the patch man! Good to get started eventually. here are some comments for you patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When I look at IOContext I think it should be a little more sophisticated. What I have in mind is something similar to ScorerContext in org.apache.lucene.search.Weight.java. Some kind of a copy-on-write builder pattern that lets us provide some defaults for Merging, Searching and Indexing so by default we can reuse the same instance in many places. If we follow a this copy on write model we could also make this class non-final to let people customize the context if they needs to.&lt;/li&gt;
	&lt;li&gt;I am not sure if we really need the enumeration in IO Context unless me make decisions based on what an input / output is used for. IMO it might make more sense to have default instances for Searching Indexing and Merging and set the flags like SEQUENTIAL and the buffers to good defaults and only tweak them when we are aware of the context ie. when we pull the input / output. The most of the usecases need good defaults and only some need tweaks but if we hold the use-case information on IOContext some directories might want to be very smart and this might duplicate code.&lt;/li&gt;
	&lt;li&gt;I wonder if it makes sense to bind the IO Context instance to the directory and add a factory to the directory like Directory#getIOContext(Merge|Search|Index) to enable the directory impl to set platform specific defaults. I think that would make things easier and customization would be straight forward.&lt;/li&gt;
	&lt;li&gt;You should add a space after a comma in the arguments list like here: int bufferSize,IOContext context)&lt;/li&gt;
	&lt;li&gt;Enum elements should be CamelCase and start with a leading Uppercase character&lt;/li&gt;
&lt;/ul&gt;


</comment>
                    <comment id="13041223" author="varunthacker" created="Mon, 30 May 2011 19:24:55 +0100"  >&lt;p&gt;I edited IOContext . &lt;/p&gt;

&lt;p&gt;I&apos;m not sure on where to go from here. Should I add the context to all the createOutput/openImput parameters in the Directory implementations or add getIOContext method to Directory?&lt;/p&gt;</comment>
                    <comment id="13041224" author="mikemccand" created="Mon, 30 May 2011 19:28:35 +0100"  >&lt;p&gt;Great to see your patch here Varun!&lt;/p&gt;

&lt;p&gt;I think we should start with only high level details in the IOContext?&lt;br/&gt;
Ie, the Merge/Search(Reader?)/Writer is great, but I think low level&lt;br/&gt;
stuff (bufferSize, sequential/direct) should stay private to the Dir&lt;br/&gt;
impl?&lt;/p&gt;

&lt;p&gt;Ideally, I would also like to see details about the&lt;br/&gt;
merge/reader/writer &quot;context&quot;, eg for merging I&apos;d like to see the&lt;br/&gt;
OneMerge instance, for Reader/Writer maybe a SegmentInfo instance?&lt;/p&gt;

&lt;p&gt;This would then make Dir impls like NRTCachingDirectory (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3092&quot; title=&quot;NRTCachingDirectory, to buffer small segments in a RAMDir&quot;&gt;&lt;del&gt;LUCENE-3092&lt;/del&gt;&lt;/a&gt;)&lt;br/&gt;
&quot;clean&quot; (vs the sneaky ConcurrentMergeScheduler entangling it now must&lt;br/&gt;
do), though, in that particular case we could accomplish this by only&lt;br/&gt;
adding an estimatedSegmentSizeBytes to the IOCtx.&lt;/p&gt;

&lt;p&gt;We should remove the bufferSize that now plumbs all up and down&lt;br/&gt;
the APIs, and replace it with IOCtx?&lt;/p&gt;</comment>
                    <comment id="13041225" author="mikemccand" created="Mon, 30 May 2011 19:32:21 +0100"  >&lt;blockquote&gt;&lt;p&gt;Some kind of a copy-on-write builder pattern&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why not use a normal struct/bean like class here?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I wonder if it makes sense to bind the IO Context instance to the directory and add a factory to the directory like Directory#getIOContext(Merge|Search|Index) to enable the directory impl to set platform specific defaults&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, but, if the IOCtxt is &apos;high level&apos;, and then details (bufferSize, seq/direct flags, etc.) are private to the dir impl, I think we (Lucene) can create the IOCtx and pass it down?  Ie this is a one-way communication, I think (Lucene -&amp;gt; Dir impl).&lt;/p&gt;</comment>
                    <comment id="13041241" author="varunthacker" created="Mon, 30 May 2011 20:19:49 +0100"  >&lt;p&gt;I removed bufferSize from all the Directory implementations and made it part of IOContext.&lt;/p&gt;
</comment>
                    <comment id="13041248" author="mikemccand" created="Mon, 30 May 2011 20:34:22 +0100"  >&lt;blockquote&gt;&lt;p&gt;I removed bufferSize from all the Directory implementations and made it part of IOContext.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it shouldn&apos;t even be part of IOCtx?  Ie this is private to the Dir impl?&lt;/p&gt;

&lt;p&gt;Another thing we have to do is add IOCtx into the cache key used in IndexWriter&apos;s ReaderPool inner class.  Ie, a reader opened for merging cannot be later shared with a reader opened for searching.&lt;/p&gt;</comment>
                    <comment id="13041560" author="simonw" created="Tue, 31 May 2011 13:48:11 +0100"  >&lt;blockquote&gt;&lt;p&gt;Why not use a normal struct/bean like class here?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What I had in mind here is a more sophisticated IOContext. I&apos;d like to see some default IOCtx for Merge, Search, Write etc. that folks can simply modify if needed. For that to work it should be immutable. The question here is if we go the high level way like you suggested and make the most of the properties private to the dir (like buffersize etc) or is we should make it available to the user of the API. Some Dirs might have different defaults than others though. &lt;/p&gt;

&lt;p&gt;I can see why this should be private to the directory and it might make more sense to simply indicate what the input / output is used for and let the directory figure out the details. So yeah +1 to keep it high level. If bean or copy-on-write builder I need to see what properties should be on it. so lets keep that for later.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Ideally, I would also like to see details about the&lt;br/&gt;
merge/reader/writer &quot;context&quot;, eg for merging I&apos;d like to see the&lt;br/&gt;
OneMerge instance, for Reader/Writer maybe a SegmentInfo instance?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I really don&apos;t like the idea of exploiting OneMerge to the Directory. We might introduce some other internface that holds enough metadata to get the info and let OneMerge implement this but we should not pass it down to the dir. Same is true for SI I don&apos;t want directory mess around with those classes. &lt;/p&gt;</comment>
                    <comment id="13041617" author="mikemccand" created="Tue, 31 May 2011 16:13:06 +0100"  >&lt;blockquote&gt;&lt;p&gt;If bean or copy-on-write builder I need to see what properties should be on it. so lets keep that for later.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK let&apos;s defer this decision for now.&lt;/p&gt;

&lt;p&gt;I just see &quot;builder pattern&quot; being too much of a hammer in search of&lt;br/&gt;
nails...&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I really don&apos;t like the idea of exploiting OneMerge to the Directory. We might introduce some other internface that holds enough metadata to get the info and let OneMerge implement this but we should not pass it down to the dir. Same is true for SI I don&apos;t want directory mess around with those classes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, it&apos;s spooky letting such a low level class (Dir) have access&lt;br/&gt;
to high level stuff (OneMerge, SegmentInfo)... but it&apos;s really the&lt;br/&gt;
only way to ensure we don&apos;t &quot;miss&quot; useful context about this file?&lt;/p&gt;

&lt;p&gt;Ie these high level classes already encompass the full context for a&lt;br/&gt;
given file.&lt;/p&gt;

&lt;p&gt;So, if we really don&apos;t want to include these classes, and instead pick &amp;amp;&lt;br/&gt;
choose what &quot;digested&quot; properties to include... then we risk some Dir&lt;br/&gt;
impl not having access to something &quot;interesting&quot; because we forgot to&lt;br/&gt;
include it, which means they&apos;ll have to hack something up, like&lt;br/&gt;
NRTCachingDir does now in coupling threads to OneMerge instances.&lt;/p&gt;

&lt;p&gt;But, maybe the restrictions won&apos;t be so bad in practice... if we can&lt;br/&gt;
try to brainstorm what Dirs may want to &quot;know&quot; about the full context&lt;br/&gt;
and include that in IOCtx.&lt;/p&gt;

&lt;p&gt;For example, just by adding estimatedFullSegmentSizeBytes, for both&lt;br/&gt;
Merge and Write (hmm: maybe Flush?), NRTCachingDir can cutover to&lt;br/&gt;
IOCtx.&lt;/p&gt;</comment>
                    <comment id="13041642" author="cmale" created="Tue, 31 May 2011 17:03:59 +0100"  >&lt;blockquote&gt;
&lt;p&gt;So, if we really don&apos;t want to include these classes, and instead pick &amp;amp;&lt;br/&gt;
choose what &quot;digested&quot; properties to include... then we risk some Dir&lt;br/&gt;
impl not having access to something &quot;interesting&quot; because we forgot to&lt;br/&gt;
include it, which means they&apos;ll have to hack something up, like&lt;br/&gt;
NRTCachingDir does now in coupling threads to OneMerge instances.&lt;/p&gt;

&lt;p&gt;But, maybe the restrictions won&apos;t be so bad in practice... if we can&lt;br/&gt;
try to brainstorm what Dirs may want to &quot;know&quot; about the full context&lt;br/&gt;
and include that in IOCtx.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the alternatives to this are definitely worse.  I&apos;ve been trying to think of some sort of intermediary component that could decouple the interests of Directories from the sources of that info, but it just seems to make everything way more complicated.  I agree it seems best to stick to what Dirs want to know, present that as the IOCtx, and then work out the sources of that information.&lt;/p&gt;</comment>
                    <comment id="13042790" author="varunthacker" created="Thu, 2 Jun 2011 15:27:39 +0100"  >&lt;p&gt;I have edited org.apache.lucene.store and org.apache.index where needed. If this is correct I&apos;ll change the codecs too&lt;/p&gt;</comment>
                    <comment id="13042824" author="mikemccand" created="Thu, 2 Jun 2011 16:22:11 +0100"  >&lt;p&gt;Patch is looking good!  Some feedback:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think CompoundFileReader should not store the IOCtx passed to&lt;br/&gt;
    the ctor?  It should just fwd to the dir.openInput...?  It used to&lt;br/&gt;
    have to store the readBufferSize in case openInput was called w/o&lt;br/&gt;
    a readBufferSize, but we now require IOCtx to openInput.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Is IOCtx never allowed to be null?  (I think so?).  In which case&lt;br/&gt;
    we should jdoc this, and Dir impls can rely on it.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I don&apos;t think NRTCachingDir.unCache should take an IOCtx?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think NRTCachineDir.doCacheWrite should take the IOCtx, and, we&lt;br/&gt;
    should remove all the merge thread hacks that it now does.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The super(bufferSize) call is needed in SimpleFSDir (and others).&lt;br/&gt;
    I think what must happen here is SimpleFSDir look @ the IOCtx and&lt;br/&gt;
    decides what buffer size to use (the logic in IW should be moved&lt;br/&gt;
    down into here), with getters/setters to be able to change&lt;br/&gt;
    read/write buffer size for merging vs reading/flushing.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;IOContext.Context should also have Flush?  And maybe rename Search&lt;br/&gt;
    -&amp;gt; Read?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;IndexWriter ctor shouldn&apos;t take an incoming IOCtx; instead,&lt;br/&gt;
    IndexWriter should create a new IOCtx each time it opens reader /&lt;br/&gt;
    flushes segments / does merging.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The ReaderPool.get* methods (inside IndexWriter) should take an&lt;br/&gt;
    IOCtx, and the .context from that IOCtx should be part of the key&lt;br/&gt;
    used to cache that reader in the pool.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13045315" author="varunthacker" created="Tue, 7 Jun 2011 09:09:21 +0100"  >&lt;p&gt;I have made the required changes. There are places where I have made the Context=Other , some of which might be wrong. Please suggest me where to make the necessary changes. &lt;/p&gt;</comment>
                    <comment id="13045322" author="simonw" created="Tue, 7 Jun 2011 09:29:01 +0100"  >&lt;p&gt;Very very quick review:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think OneMerge should not be required for createing a IOContext we maybe should add a default ctor.&lt;/li&gt;
	&lt;li&gt;IOContext.Other is confusing I think. If a IOContext doesn&apos;t make lots of sense somewhere we should not need to pass it in. Can&apos;t we simply have overloaded methods? maybe I just don&apos;t like the name, maybe use DEFAULT?&lt;/li&gt;
	&lt;li&gt;IOContext seem to pretty straight forward you either read or write but it seems to be confused with high level operations like Merge and Flush. Either with go on a high level or we only have read and write here. Since read / write is implicit (you either pull input or output) we should make this high-level only. So maybe we have Query or Search instead of Read here? Maybe it makes sense to specify stuff like Consume or Sequential here too some high level APIs define sequential access so I think it does not conflict?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13045354" author="mikemccand" created="Tue, 7 Jun 2011 11:38:58 +0100"  >&lt;p&gt;Patch looks great!  Comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think IOCtx should have ctor taking only OneMerge, which would&lt;br/&gt;
    set the OneMerge and set the context as Merge?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Likewise, a ctor taking a SegmentInfo to mean context = Flush?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;And finally a default ctor that maps to Other (or Default or&lt;br/&gt;
    Unknown or Unspecified or something)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;You don&apos;t need to create the IOCtx in IW.maybeMerge?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Maybe we want a &quot;readOnce&quot; boolean in IOCtx?  When we read del&lt;br/&gt;
    docs, norms, terms index, doc values, segments file /&lt;br/&gt;
    segments.gen, we would set this?  (And UnixDir would send eg&lt;br/&gt;
    NO_REUSE down to the OS).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think we&apos;ll need a NativeMMapDir as well as NativeDir (or&lt;br/&gt;
    NativeUnix/WindowsDir), because mmap can also take flags giving&lt;br/&gt;
    hints about access patterns.  I&apos;ll open a new issue...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Why does SegmentCoreReaders hang onto the IOCtx?  Seems like&lt;br/&gt;
    classes shouldn&apos;t hang onto it... (also: PreFlexFields).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Hmm.... does createOutput even need an IOCtx...?  What would a dir&lt;br/&gt;
    do with this?  I suppose if it&apos;s a merge and we had io&lt;br/&gt;
    prioritization (someday) we could set lower prio... OK let&apos;s keep&lt;br/&gt;
    it.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think Codec.fieldsProducer/Consumer should take an IOCtx?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Still need to fix IW&apos;s ReaderPool to key off of IOCtx.Context plus&lt;br/&gt;
    the info.  Maybe put a // nocommit in there so we remember...?&lt;br/&gt;
    Eg, where you commented out the readBufferSize = ... inside&lt;br/&gt;
    ReaderPool.get is a good place.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13045455" author="mikemccand" created="Tue, 7 Jun 2011 15:39:37 +0100"  >&lt;blockquote&gt;
&lt;p&gt;I think we&apos;ll need a NativeMMapDir as well as NativeDir (or&lt;br/&gt;
NativeUnix/WindowsDir), because mmap can also take flags giving&lt;br/&gt;
hints about access patterns. I&apos;ll open a new issue...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3178&quot; title=&quot;Native MMapDir&quot;&gt;LUCENE-3178&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="13045824" author="varunthacker" created="Wed, 8 Jun 2011 08:47:42 +0100"  >&lt;p&gt;I just put up the IOContext class. If this is looking good then I&apos;ll make the necessary changes to the other classes.&lt;/p&gt;</comment>
                    <comment id="13046403" author="simonw" created="Thu, 9 Jun 2011 09:48:53 +0100"  >&lt;p&gt;Hey varun,&lt;/p&gt;

&lt;p&gt;here are some more comments for the latest complete patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;We should have a static instance for IOContext with Context.Other which you can use in BitVector / CheckIndex for instance Maybe IOContext#DEFAULT_CONTEXT&lt;/li&gt;
	&lt;li&gt;It seems that we don&apos;t need to provide IOContext to FieldInfos and SegmentInfo since we are reading them into memory anyway. I think you can just use a default context here without changing the constructors. Same is true for SegmentInfos&lt;/li&gt;
	&lt;li&gt;This is unrelated to your patch but in PreFlexFields we should use IndexFileNames.segmentFileName(info.name, &quot;&quot;, PreFlexCodec.FREQ_EXTENSION) and IndexFileNames.segmentFileName(info.name, &quot;&quot;, PreFlexCodec.PROX_EXTENSION) instead of info.name + &quot;.frq&quot;  and info.name + &quot;.prx&quot;&lt;/li&gt;
	&lt;li&gt;it seems that we should communicate the IOContext to the codec somehow. I suggest we put IOContext to SegmentWriteState and SegmentReadState that way we don&apos;t need to change the Codec interface and clutter it with internals. This would also fix mikes comment for FieldsConsumer etc.&lt;/li&gt;
	&lt;li&gt;TermVectorsWriter is only used in Merges so maybe it should also get a Context.Merge for consistency?&lt;/li&gt;
	&lt;li&gt;I really don&apos;t like OneMerge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I think we should add an abstract class  (maybe MergeInfo) that exposes the estimatedMergeBytes, totalDocCount for now.&lt;/li&gt;
	&lt;li&gt;small typo in RamDirectory, there is a space missing after the second file here: dir.copy(this, file, file,context);&lt;/li&gt;
	&lt;li&gt;SegmentReader should also use the static Default IOContext - make sure its used where needed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding the IOContext class I think we should design for what we have right now and since SegementInfo is not used anywhere (as far as I can see) we should add it once we need it. OneMerge should not go in there but rather the interface / abstract class I talked about above. &lt;/p&gt;</comment>
                    <comment id="13046635" author="mikemccand" created="Thu, 9 Jun 2011 16:54:31 +0100"  >&lt;blockquote&gt;&lt;p&gt;It seems that we don&apos;t need to provide IOContext to FieldInfos and SegmentInfo since we are reading them into memory anyway. I think you can just use a default context here without changing the constructors. Same is true for SegmentInfo&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should pass down &quot;readOnce=true&quot; for these cases?  EG some&lt;br/&gt;
kind of caching dir (or something) would know not to bother caching&lt;br/&gt;
such files...&lt;/p&gt;

&lt;p&gt;Same for del docs, terms index, doc values (well, sometimes), etc.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it seems that we should communicate the IOContext to the codec somehow. I suggest we put IOContext to SegmentWriteState and SegmentReadState that way we don&apos;t need to change the Codec interface and clutter it with internals. This would also fix mikes comment for FieldsConsumer etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 that&apos;s great.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I really don&apos;t like OneMerge  I think we should add an abstract class (maybe MergeInfo) that exposes the estimatedMergeBytes, totalDocCount for now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we can&apos;t include OneMerge, and I agree it&apos;d be nice not to, I think&lt;br/&gt;
we should try hard to pull stuff out of OneMerge that may be of&lt;br/&gt;
interest to a Dir impl?  Maybe:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;estimatedTotalSegmentSizeBytes&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;docCount&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;optimize/expungeDeletes&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;isExternal (so Dir can know if this is addIndexes vs &quot;normal&quot; merging)&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;Regarding the IOContext class I think we should design for what we have right now and since SegementInfo is not used anywhere (as far as I can see) we should add it once we need it. OneMerge should not go in there but rather the interface / abstract class I talked about above.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, let&apos;s wait until we have a need.&lt;/p&gt;

&lt;p&gt;In fact... SegmentInfo for flush won&apos;t work: we go and open all files&lt;br/&gt;
for flushing, write to them, close them, and only then do we make the&lt;br/&gt;
SegmentInfo.&lt;/p&gt;

&lt;p&gt;So it seems like we should also have some abtracted stuff about the&lt;br/&gt;
to-be-flushed segment?  Maybe for starters the&lt;br/&gt;
estimatedSegmentSizeBytes?  EG, NRTCachingDir could use this to decide&lt;br/&gt;
whether to cache the new segment (today it fragile-ly relies on the&lt;br/&gt;
app to open new NRT reader frequently enough).&lt;/p&gt;</comment>
                    <comment id="13047197" author="varunthacker" created="Fri, 10 Jun 2011 14:58:54 +0100"  >&lt;p&gt;I think I have successfully threaded IOContext to the codecs and index package wherever required. There might be instances where I have used Context.Default wrongly.&lt;/p&gt;

&lt;p&gt;I&apos;ll begin adding documentation.&lt;/p&gt;

&lt;p&gt;In NRTCachingDir.doCacheWrite method where IOContext is used if the context has it&apos;s OnceMergeInfo field null might lead to a bug ? Should cases like those added to the docs ?&lt;/p&gt;</comment>
                    <comment id="13047230" author="varunthacker" created="Fri, 10 Jun 2011 15:49:04 +0100"  >&lt;p&gt;I had messed up the patch using eclipse. This should be ok.&lt;/p&gt;</comment>
                    <comment id="13047234" author="simonw" created="Fri, 10 Jun 2011 16:04:24 +0100"  >&lt;p&gt;Varun, your patch doesn&apos;t apply cleanly to my latest trunk. i think you should update your local copy again!&lt;/p&gt;

&lt;p&gt;I have trouble to understand how you use MergeInfo etc. I figure there might be a misunderstanding so here is what I had in mind roughly: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

Index: lucene/src/java/org/apache/lucene/index/MergePolicy.java
===================================================================
--- lucene/src/java/org/apache/lucene/index/MergePolicy.java	(revision 1134335)
+++ lucene/src/java/org/apache/lucene/index/MergePolicy.java	(working copy)
@@ -64,7 +64,7 @@
    *  subset of segments to be merged as well as whether the
    *  &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; segment should use the compound file format. */
 
-  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; class OneMerge {
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; class OneMerge &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; MergeInfo {
 
     SegmentInfo info;               &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; optimize;               &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;@@ -72,25 +72,26 @@
     &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; mergeGen;                  &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isExternal;             &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxNumSegmentsOptimize;     &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; estimatedMergeBytes;       &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;     List&amp;lt;SegmentReader&amp;gt; readers;        &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;     List&amp;lt;SegmentReader&amp;gt; readerClones;   &lt;span class=&quot;code-comment&quot;&gt;// used by IndexWriter
&lt;/span&gt;-    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;SegmentInfo&amp;gt; segments;
-    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; totalDocCount;
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;SegmentInfo&amp;gt; segments = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;SegmentInfo&amp;gt;();
     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; aborted;
     Throwable error;
     &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; paused;
 
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; OneMerge(List&amp;lt;SegmentInfo&amp;gt; segments) {
+      &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(getSegments(segments));
+    }
+
+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getSegments(List&amp;lt;SegmentInfo&amp;gt; segments) {
       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (0 == segments.size())
         &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;segments must include at least one segment&quot;&lt;/span&gt;);
       &lt;span class=&quot;code-comment&quot;&gt;// clone the list, as the in list may be based off original SegmentInfos and may be modified
&lt;/span&gt;-      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.segments = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;SegmentInfo&amp;gt;(segments);
       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; count = 0;
       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(SegmentInfo info : segments) {
         count += info.docCount;
       }
-      totalDocCount = count;
+      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; count;
     }
 
     /** Record that an exception occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; executing
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13047945" author="varunthacker" created="Sat, 11 Jun 2011 17:50:57 +0100"  >&lt;p&gt;I hope this time I haven&apos;t messed up the making the patch. I corrected MergeInfo too.&lt;/p&gt;</comment>
                    <comment id="13047970" author="simonw" created="Sat, 11 Jun 2011 19:50:58 +0100"  >&lt;p&gt;hi varun,&lt;/p&gt;

&lt;p&gt;looks good, some quick comments, &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Can OneMerge extend MergeInfo?&lt;/li&gt;
	&lt;li&gt;Can we introduce a static IOContext instance like public static final IOContext DEFAULT = new IOContext() and use this everywhere where we need to use the default. All those object creations are unnecessary.&lt;/li&gt;
	&lt;li&gt;Can IOContext() call this(false) instead of manually setting the values&lt;/li&gt;
	&lt;li&gt;I think IOContext should take MergeInfo instead of OneMerge if you extend MergeInfo in OneMerge you can just pass OneMerge and you are done.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will have a closer look tomorrow&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="13048283" author="mikemccand" created="Sun, 12 Jun 2011 10:56:20 +0100"  >
&lt;p&gt;Patch is looking good!&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I thinkt the Context enum values should be ALL_CAPS&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;FieldsWriter&apos;s ctor should take an IOContext?  Generally low level&lt;br/&gt;
    places shouldn&apos;t create a new IOContext; they should be passed&lt;br/&gt;
    one (though there are exceptions... eg I think it&apos;s fine that&lt;br/&gt;
    SegmentInfos.run uses DEFAULT).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Same for values/IntsImpl, values/Bytes, values/Floats,&lt;br/&gt;
    SegmentReader.get, TermVectorsTermsReader, TermVectorsWriter,&lt;br/&gt;
    DefaultSegmentInfosWriter, DefaultSegmentInfosReader,&lt;br/&gt;
    FixedGapTermsIndexReader, VariableGapTermsIndexReader,&lt;br/&gt;
    NormsWriter, BitVector (read &amp;amp; write)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think MP.OneMerge should not extend the new MergeInfo; I&apos;m&lt;br/&gt;
    worried about cases where classes hang onto the IOContext (eg,&lt;br/&gt;
    various places save the IOContxt away as a member) because this&lt;br/&gt;
    could then risk holding refs to the SegmentReaders created for&lt;br/&gt;
    merging.  I think it&apos;s less risky to fully decouple the MergeInfo&lt;br/&gt;
    from OneMerge.  Then, maybe MergeInfo should be a static inner&lt;br/&gt;
    class inside IOContext?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;IndexWriter.ReaderPool.get should pass the IOCtx down to&lt;br/&gt;
    SegmentReader.get&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;IndexWriter.prepareFlushedSegment should be FLUSH not DEFAULT&lt;br/&gt;
    context.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Can you add assert inside IOContext: if the ctx is MERGE then the&lt;br/&gt;
    MergeInfo must not be null (ie in the ctor that takes only a&lt;br/&gt;
    Context).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;MergeInfo needs a few more fields (eg optimize, isExternal)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When IndexWriter.addIndexes makes the MERGE context it should pass&lt;br/&gt;
    a MergeInfo with isExternal true&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In IndexWriter.mergeMiddle, you should make a single IOCtx(MERGE)&lt;br/&gt;
    up front and pass to all readerPool.get calls&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;At the end of IndexWriter.mergeMiddle, when we open the&lt;br/&gt;
    mergedReader... we should not pass MERGE context here, somehow,&lt;br/&gt;
    because this open is very different than when we open the&lt;br/&gt;
    to-be-merged segments.  IE, we are opening the merged segment.&lt;br/&gt;
    Hmm, maybe, we can add a new flag to the MergeInfo,&lt;br/&gt;
    &quot;isMergedSegment&quot;?  Alternatively... we use Context.READ, but then&lt;br/&gt;
    I think we need something else that states what &quot;READ&quot; this really&lt;br/&gt;
    is &amp;#8211; eg NRT reader, merged segment reader, &quot;normal&quot; (IR.open)&lt;br/&gt;
    reader?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;TermVectorsTermsWriter should be a Context.FLUSH&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;SegmentWriteState.context can be final&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Somehow, PerFieldCodecWrapper.java shows as deleted...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;MergeInfo.java needs copygirht header &amp;amp; javadoc.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Need whitespace around &apos;=&apos;, eg &quot;this.context=context;&quot; should be&lt;br/&gt;
    &quot;this.context = context;&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13048285" author="mikemccand" created="Sun, 12 Jun 2011 10:59:17 +0100"  >&lt;blockquote&gt;&lt;p&gt;Can OneMerge extend MergeInfo?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this is risky because it then makes IOContext an unexpectedly&lt;br/&gt;
heavy object, since OneMerge holds SegmentReaders used for merging.&lt;/p&gt;

&lt;p&gt;There are already some places that save away an IOContext instance as&lt;br/&gt;
a member (to be used later), and if something ever does this for a MERGE&lt;br/&gt;
then we can unexpectedly hold keep a lot of garbage alive.&lt;/p&gt;

&lt;p&gt;I think, instead, when the context is MERGE, we should make a new&lt;br/&gt;
(lightweight) MergeInfo instance that pulls the necessary details from&lt;br/&gt;
the OneMerge, ie fully decouples from the OneMerge instance.&lt;/p&gt;</comment>
                    <comment id="13049293" author="mikemccand" created="Tue, 14 Jun 2011 18:25:19 +0100"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3203&quot; title=&quot;Rate-limit IO used by merging&quot;&gt;&lt;del&gt;LUCENE-3203&lt;/del&gt;&lt;/a&gt; is another example where a Dir needs the IOContext so it can optionally rate limit the bytes/second if it&apos;s a merge.&lt;/p&gt;</comment>
                    <comment id="13050336" author="varunthacker" created="Thu, 16 Jun 2011 11:29:40 +0100"  >&lt;p&gt;I made the changes. I also fixed test-framework but haven&apos;t touched the test cases yet. &lt;/p&gt;</comment>
                    <comment id="13050444" author="simonw" created="Thu, 16 Jun 2011 15:28:45 +0100"  >&lt;p&gt;hey varun&lt;/p&gt;

&lt;p&gt;patch looks close!&lt;/p&gt;

&lt;p&gt;here are some comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the assert context == Context.MERGE should be assert context != Context.MERGE || mergeInfo != null;&lt;/li&gt;
	&lt;li&gt;can you move that assert into IOContext(Context, MergeInfo) and let other related constructors call this(context, mergeInfo) instead of initializing all members themself?&lt;/li&gt;
	&lt;li&gt;I think there should be a public static final IOContext READONCE = new IOContext(true); then you can make the corresponding constructor private. I think the context should be Context.READ instead of default in that case right?&lt;/li&gt;
	&lt;li&gt;IOContext(MergePolicy.OneMerge) seems to be unnecessary. I think you should add a method to OneMerge to get a MergeInfo from it and only have a MergeInfo ctor. Then you can move MergeInfo into OneMerge too.&lt;/li&gt;
	&lt;li&gt;PerFieldCodecWrapper still seems to be deleted&lt;/li&gt;
	&lt;li&gt;In IndexReader IOContext context=null; should be IOContext context= new IOContext(READ); no?&lt;/li&gt;
	&lt;li&gt;no commit should be nocommit - we have a script on jenkins that checks this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;I still see some whitespace problems in SegmentWriteState.java&lt;/li&gt;
	&lt;li&gt;I think IOContext.DEFAULT_IOCONTEXT should be IOContext.DEFAULT since IOContext is implicit&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;I am waiting for you fixing the tests before I review further. Yet, what is missing is still the decision what buffer size to used down in direcotries etc.&lt;/p&gt;

&lt;p&gt;good work so far!&lt;/p&gt;
</comment>
                    <comment id="13050448" author="varunthacker" created="Thu, 16 Jun 2011 15:30:39 +0100"  >&lt;p&gt;Sorry for messing up the patch again! &lt;/p&gt;</comment>
                    <comment id="13050738" author="varunthacker" created="Thu, 16 Jun 2011 22:18:27 +0100"  >&lt;p&gt;I have made changes suggested by Simon and have added Context to the test cases, though I&apos;ve used DEFAULT in most of it. &lt;/p&gt;

&lt;p&gt;Also do we need the test- TestBufferedIndexInput ? I have added a IOContext.DEFAULT and fixed it though. &lt;/p&gt;</comment>
                    <comment id="13051473" author="varunthacker" created="Sat, 18 Jun 2011 09:16:33 +0100"  >&lt;p&gt;I made some more changes to the earlier patch. I tried putting a nocommit wherever I thought the code was leading to a assertError or a bufferSize as 0 error. &lt;/p&gt;</comment>
                    <comment id="13051665" author="simonw" created="Sun, 19 Jun 2011 11:08:07 +0100"  >&lt;p&gt;hey varun thanks for the new patch, some comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;the nocommit in IW you should maybe add a second ctor to MergeInfo that takes arguments and then use something like this in IW: final IOContext context = new IOContext(new MergeInfo(info.docCount, info.sizeInBytes(true), true, false));&lt;/li&gt;
	&lt;li&gt;It seems kind of odd to always prefix MergeInfo with OneMerge so maybe move it into its own file&lt;/li&gt;
	&lt;li&gt;regarding the read buffer problem, can you simply use BufferedIndexInput.BUFFER_SIZE to initialize it and put a TODO / nocommit on top&lt;/li&gt;
	&lt;li&gt;You should look into contrib/misc there are some compile errors in AppendingCodec as well as in solr land.&lt;/li&gt;
	&lt;li&gt;I think in Directory the openInput method should be abstract:   public abstract IndexInput openInput(String name, IOContext context) throws IOException; and FSDirectory should not specify this method at all. Currently your code would produce a stack overflow since it calls itself.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If I fix the nocommits in your patch test-core passes without problems. Looking good man we are getting closer!&lt;/p&gt;

&lt;p&gt;Simon&lt;/p&gt;</comment>
                    <comment id="13051720" author="varunthacker" created="Sun, 19 Jun 2011 20:06:43 +0100"  >&lt;p&gt;Made the changes and I get a Build Successful too !&lt;/p&gt;</comment>
                    <comment id="13051857" author="simonw" created="Mon, 20 Jun 2011 10:01:40 +0100"  >&lt;p&gt;I created a branch for this issue and follow up issues here: &lt;a href=&quot;https://svn.apache.org/repos/asf/lucene/dev/branches/LUCENE2793/&quot; class=&quot;external-link&quot;&gt;https://svn.apache.org/repos/asf/lucene/dev/branches/LUCENE2793/&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="13051983" author="simonw" created="Mon, 20 Jun 2011 15:11:07 +0100"  >&lt;p&gt;For the record - I went through the latest patch and added some nocommits where needed. I will take this patch and commit it to the branch. We should now work on that branch to fix all the remaining issues.&lt;/p&gt;</comment>
                    <comment id="13053437" author="varunthacker" created="Wed, 22 Jun 2011 21:11:10 +0100"  >&lt;p&gt;I am not sure whether the MergeInfo used in SegmentMerger#mergeFields&lt;/p&gt;

&lt;p&gt;I have kept most of the nocommits there even after correcting it for reference.&lt;/p&gt;

&lt;p&gt;In MockDirectoryWrapper#crash() to randomize IOContext I have used either a READONCE or DEFAULT or Merge context. Is this the correct way to go?&lt;/p&gt;

&lt;p&gt;In LuceneTeseCase#newDirectory(), MockDirectoryWrapper#createOutput(), MockDirectoryWrapper#openInput() will randomizing the context here help? &lt;/p&gt;</comment>
                    <comment id="13054358" author="mikemccand" created="Fri, 24 Jun 2011 11:51:38 +0100"  >&lt;p&gt;Patch, fixing NRTCachingDir to no longer have anything to do with the merge scheduler (yay!).&lt;/p&gt;</comment>
                    <comment id="13054359" author="mikemccand" created="Fri, 24 Jun 2011 11:52:43 +0100"  >&lt;p&gt;I took quick look @ the branch &amp;#8211; it&apos;s looking good!  Some small stuff:&lt;/p&gt;




&lt;ul&gt;
	&lt;li&gt;Should IOContext and MergeInfo be in oal.store not .index?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think SegmentMerger should receive an IOCtx from its caller, and&lt;br/&gt;
    then apss that to all the IO ops it invokes?  But the code has a&lt;br/&gt;
    nocommit about tripping an assert &amp;#8211; which one?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think on flush IOContext should include num docs and estimated&lt;br/&gt;
    segment size (we can roughly pull this from RAM used for the&lt;br/&gt;
    segment), but we should include comment that this is only approx.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Somehow, lucene/contrib/demo/data is deleted on the branch.  We&lt;br/&gt;
    should check if anything else is missing!&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13055649" author="simonw" created="Mon, 27 Jun 2011 17:52:40 +0100"  >&lt;blockquote&gt;&lt;p&gt;Should IOContext and MergeInfo be in oal.store not .index?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think SegmentMerger should receive an IOCtx from its caller, and&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yeah I think we should pass the IOContext in via the ctor. Yet, for IW#addIndexes you can simply build a best effort IOContext like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; for (IndexReader indexReader : readers) &lt;/p&gt;
{
   numDocs += indexReader.numDocs();
 }
&lt;p&gt; final IOContext context = new IOContext(new MergeInfo(numDocs, -1, true, false));&lt;br/&gt;
}&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think on flush IOContext should include num docs and estimated&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1 I think that is good no?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Somehow, lucene/contrib/demo/data is deleted on the branch. We should check if anything else is missing!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;oh man... I will check&lt;/p&gt;

&lt;p&gt;you use new IOContext(Context.FLUSH) and new IOContext(Context.READ) in your patch but we have some static like IOContext.READ maybe we need FLUSH too?&lt;/p&gt;

&lt;p&gt;for the tests I think we should start randomizing the IOContext. I think you should add a newIOContext(Random random) to LuceneTestCase and get the context from there in a unit test. At the end of the day we should see same behavior whatever context you pass in right?&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;



</comment>
                    <comment id="13056188" author="varunthacker" created="Tue, 28 Jun 2011 00:15:30 +0100"  >&lt;p&gt;I have made the necessary changes. Still I might have missed out changing couple of Test Cases to random IOContext. &lt;/p&gt;

&lt;p&gt;I wanted to put it our so that you&apos;ll can have a look as soon as possible. &lt;/p&gt;</comment>
                    <comment id="13056449" author="simonw" created="Tue, 28 Jun 2011 12:19:23 +0100"  >&lt;p&gt;Varun, patch looks great!&lt;/p&gt;

&lt;p&gt;here are some comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;in LuceneTestCase#newIOContext(Random) your switch statement misses necessary break; statements no matter what you will always get a flush&lt;br/&gt;
context. I think you should also randominze the numbers for numDocs and sizeInBytes. nobody should rely on these number they are just best effort.&lt;/li&gt;
	&lt;li&gt;in  o.a.l.i.values.Bytes#getValues, o.a.l.i.StoredFieldsWriter#initFieldsWriter, o.a.l.i.SegmentMerger#mergeVectors, MemoryCodec#fieldsProducer, MockSingleIntIndexOutput#MockSingleIntIndexOutput you can remove the nocommit&lt;/li&gt;
	&lt;li&gt;the public members in FlushInfo should be final&lt;/li&gt;
	&lt;li&gt;the MergeInfo ctors javadoc should either describe the arguments or omit them. In this case I think you can simply omit them since they are pretty self explained. I think what we need on MergeInfo as well as on FlushInfo is a javadoc comment that says that the values are estimates not necessarily real / correct values.&lt;/li&gt;
	&lt;li&gt;on private IOContext (Context context, MergeInfo mergeInfo ) I don&apos;t understand the assert why is there a context != Flush?&lt;/li&gt;
	&lt;li&gt;in MockDirectoryWrapper there is a nocommit that says randomize the IOContext. Maybe we should put the newIOContext to _TestUtils and delegate to this from LuceneTestCase?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Overall I think we are really close here. Once those comments are fixed I will commit the patch to the branch and we go through the remaining nocommits. Once this is done we should close this and create a new issue to fix all the buffer sizes just like &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3248&quot; title=&quot;In BufferedIndexInput to cleanup the bufferSize variable passed down to it as the default bufferSize(BUFFER_SIZE) is always used&quot;&gt;LUCENE-3248&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;good job varun&lt;/p&gt;</comment>
                    <comment id="13057133" author="varunthacker" created="Wed, 29 Jun 2011 10:59:06 +0100"  >&lt;p&gt;I also removed nocommits from &lt;br/&gt;
o.a.l/index/codecs/DefaultDocValuesProducer.java&lt;br/&gt;
o.a.l/index/values/VarStraightBytesImpl.java&lt;br/&gt;
o.a.l/index/values/FixedStraightBytesImpl.java&lt;br/&gt;
o.a.l/index/codecs/appending/AppendingCodec.java&lt;/p&gt;</comment>
                    <comment id="13057903" author="simonw" created="Thu, 30 Jun 2011 17:01:29 +0100"  >&lt;p&gt;Varun this patch looks great. I am about to commit it. Can you now work through the nocommits, fix them or post questions here?&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="13057911" author="simonw" created="Thu, 30 Jun 2011 17:16:57 +0100"  >&lt;p&gt;Varun, &lt;/p&gt;

&lt;p&gt;the latest patch is committed. I added some minor cleanups and removed invalid nocommits. We are in good shape already&lt;/p&gt;</comment>
                    <comment id="13058116" author="mikemccand" created="Thu, 30 Jun 2011 23:48:46 +0100"  >&lt;p&gt;To address the nocommits about losing the larger buffer size during merging, should we add set/getMergeBufferSize and set/getDefaultBufferSize to those Dir impls that do buffering?  (And default to what they are today on trunk, I think 1 KB and 4 KB?)&lt;/p&gt;</comment>
                    <comment id="13059293" author="varunthacker" created="Sun, 3 Jul 2011 23:24:40 +0100"  >&lt;p&gt;I am not sure on the way I have tried to correct the nocommits on how to use buffer sizes based on IOContext. Let me know if this is not the correct way of doing it or are there any changes required. &lt;/p&gt;</comment>
                    <comment id="13059527" author="mikemccand" created="Mon, 4 Jul 2011 18:56:52 +0100"  >&lt;p&gt;I think BufferedIndexInput doesn&apos;t need a set/getMergeBufferSize?  Ie, BII only knows its bufferSize, regardless of the context from its parent.&lt;/p&gt;

&lt;p&gt;Otherwise I think your patch is good: today on trunk we hardwire the 4 KB buffer size for merges, which is the same thing your patch is doing; the only difference is the constant MERGE_BUFFER_SIZE has moved from IW to BII, and each Dir impl now has the &quot;if&quot;.  As a future improvement we can add a set/getMergeBufferSize to each Dir impl...&lt;/p&gt;</comment>
                    <comment id="13059825" author="varunthacker" created="Tue, 5 Jul 2011 11:30:13 +0100"  >&lt;p&gt;Made the necessary changes and hopefully addressed all the nocommits. &lt;/p&gt;</comment>
                    <comment id="13059838" author="varunthacker" created="Tue, 5 Jul 2011 12:14:18 +0100"  >&lt;p&gt;Made some more changes...&lt;/p&gt;</comment>
                    <comment id="13060537" author="simonw" created="Wed, 6 Jul 2011 13:43:01 +0100"  >&lt;blockquote&gt;&lt;p&gt;Made the necessary changes and hopefully addressed all the nocommits.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;varun, I still see lots of nocommits here. Would be good if you could address them this week. You don&apos;t need to solve them but discuss them here with us. you can do that in a patch and add your comments to the parts where you are not sure how to resolve.&lt;/p&gt;

&lt;p&gt;I would like to commit the patches this week so we can merge to trunk soonish.&lt;/p&gt;

&lt;p&gt;Simon&lt;/p&gt;</comment>
                    <comment id="13060538" author="mikemccand" created="Wed, 6 Jul 2011 13:48:16 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="13060581" author="varunthacker" created="Wed, 6 Jul 2011 14:53:12 +0100"  >&lt;p&gt;I removed all the remaining nocommits as I think all of them had been addressed to.&lt;/p&gt;</comment>
                    <comment id="13060663" author="simonw" created="Wed, 6 Jul 2011 17:12:53 +0100"  >&lt;p&gt;I took varuns patch and cleaned a couple of things up. I think this is ready, if nobody objects I will go ahead and commit this to the branch, merge up with trunk and upload a new patch to integrate this into trunk.&lt;/p&gt;

&lt;p&gt;Once this is on trunk we can follow up with native stuff etc.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                    <comment id="13060671" author="simonw" created="Wed, 6 Jul 2011 17:28:41 +0100"  >&lt;p&gt;s/4069/4096&lt;/p&gt;</comment>
                    <comment id="13061197" author="simonw" created="Thu, 7 Jul 2011 11:56:51 +0100"  >&lt;p&gt;I committed the latest patch, merged the branch with trunk and created a final diff for review. I think this is ready and I would like to reintegrate rather sooner than later.&lt;/p&gt;

&lt;p&gt;reviews welcome&lt;/p&gt;</comment>
                    <comment id="13061439" author="mikemccand" created="Thu, 7 Jul 2011 18:01:58 +0100"  >&lt;p&gt;Looks good!  +1 to land it!&lt;/p&gt;

&lt;p&gt;Just a few things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Shouldn&apos;t WindowsDirectory also call BII.bufferSize(context) and&lt;br/&gt;
    do the same Math.max it used to do?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Should VarGapTermsIndexReader should pass READONCE context down when it&lt;br/&gt;
    opens/reads the FST?  Hmm, though, it should just replace the ctx&lt;br/&gt;
    passed in, ie if we are merging vs reading we want to&lt;br/&gt;
    differentiate.  Let&apos;s open separate issue for this and address&lt;br/&gt;
    post merge?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Can you open an issue for this one: &quot;// TODO: context should be&lt;br/&gt;
    part of the key used to cache that reader in the pool.&quot;?  This is&lt;br/&gt;
    pretty important, else you can get NRT readers with too-large&lt;br/&gt;
    buffer sizes because the readers had been opened for merging&lt;br/&gt;
    first.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Extra space in SegmentInfo.java: IOContext.READONCE );&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13061836" author="simonw" created="Fri, 8 Jul 2011 09:10:39 +0100"  >&lt;p&gt;I fixed the two minor things from above, created two followup issues (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3292&quot; title=&quot;IOContext should be part of the SegmentReader cache key &quot;&gt;&lt;del&gt;LUCENE-3292&lt;/del&gt;&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3293&quot; title=&quot;Use IOContext.READONCE in VarGapTermsIndexReader to load FST&quot;&gt;&lt;del&gt;LUCENE-3293&lt;/del&gt;&lt;/a&gt;) for the remaining TODOs and will go ahead reintegrating the branch now.&lt;/p&gt;</comment>
                    <comment id="13061849" author="simonw" created="Fri, 8 Jul 2011 09:53:32 +0100"  >&lt;p&gt;I reintegrated the branch and committed to trunk in revision 1144196. I will now go ahead and delete the branch. all further developments should happen on trunk. @Varun make sure you move you current work in progress to trunk and be careful with svn update on the branch since some of your changes might get lost.&lt;/p&gt;

&lt;p&gt;Thanks Varun... good job!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10032">
                <name>Blocker</name>
                                <outwardlinks description="blocks">
                            <issuelink>
            <issuekey id="12509467">LUCENE-3178</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12510334">LUCENE-3203</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12491996">LUCENE-2795</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12507048">LUCENE-3092</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                        <issuelinktype id="10001">
                <name>dependent</name>
                                                <inwardlinks description="is depended upon by">
                            <issuelink>
            <issuekey id="12513232">LUCENE-3292</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12513233">LUCENE-3293</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12485568" name="LUCENE-2793_final.patch" size="322179" author="simonw" created="Thu, 7 Jul 2011 11:56:51 +0100" />
                    <attachment id="12483690" name="LUCENE-2793-nrt.patch" size="4545" author="mikemccand" created="Fri, 24 Jun 2011 11:51:38 +0100" />
                    <attachment id="12485444" name="LUCENE-2793.patch" size="17363" author="simonw" created="Wed, 6 Jul 2011 17:28:41 +0100" />
                    <attachment id="12485442" name="LUCENE-2793.patch" size="17363" author="simonw" created="Wed, 6 Jul 2011 17:12:53 +0100" />
                    <attachment id="12485432" name="LUCENE-2793.patch" size="8091" author="varunthacker" created="Wed, 6 Jul 2011 15:53:12 +0100" />
                    <attachment id="12485423" name="LUCENE-2793.patch" size="17433" author="varunthacker" created="Wed, 6 Jul 2011 14:53:12 +0100" />
                    <attachment id="12485265" name="LUCENE-2793.patch" size="8562" author="varunthacker" created="Tue, 5 Jul 2011 12:14:18 +0100" />
                    <attachment id="12485263" name="LUCENE-2793.patch" size="9107" author="varunthacker" created="Tue, 5 Jul 2011 11:30:13 +0100" />
                    <attachment id="12485112" name="LUCENE-2793.patch" size="10456" author="varunthacker" created="Sun, 3 Jul 2011 23:24:40 +0100" />
                    <attachment id="12484616" name="LUCENE-2793.patch" size="184756" author="varunthacker" created="Wed, 29 Jun 2011 10:59:05 +0100" />
                    <attachment id="12484361" name="LUCENE-2793.patch" size="183836" author="varunthacker" created="Tue, 28 Jun 2011 00:15:30 +0100" />
                    <attachment id="12483498" name="LUCENE-2793.patch" size="51859" author="varunthacker" created="Wed, 22 Jun 2011 21:11:10 +0100" />
                    <attachment id="12483159" name="LUCENE-2793.patch" size="236776" author="simonw" created="Mon, 20 Jun 2011 15:11:07 +0100" />
                    <attachment id="12483099" name="LUCENE-2793.patch" size="228219" author="varunthacker" created="Sun, 19 Jun 2011 20:06:43 +0100" />
                    <attachment id="12483031" name="LUCENE-2793.patch" size="217234" author="varunthacker" created="Sat, 18 Jun 2011 09:16:33 +0100" />
                    <attachment id="12482864" name="LUCENE-2793.patch" size="202362" author="varunthacker" created="Thu, 16 Jun 2011 22:18:27 +0100" />
                    <attachment id="12482800" name="LUCENE-2793.patch" size="135409" author="varunthacker" created="Thu, 16 Jun 2011 15:30:39 +0100" />
                    <attachment id="12482771" name="LUCENE-2793.patch" size="143113" author="varunthacker" created="Thu, 16 Jun 2011 11:29:40 +0100" />
                    <attachment id="12482155" name="LUCENE-2793.patch" size="108456" author="varunthacker" created="Sat, 11 Jun 2011 17:50:57 +0100" />
                    <attachment id="12482063" name="LUCENE-2793.patch" size="94653" author="varunthacker" created="Fri, 10 Jun 2011 15:49:03 +0100" />
                    <attachment id="12482060" name="LUCENE-2793.patch" size="95878" author="varunthacker" created="Fri, 10 Jun 2011 14:58:54 +0100" />
                    <attachment id="12481782" name="LUCENE-2793.patch" size="2863" author="varunthacker" created="Wed, 8 Jun 2011 08:47:41 +0100" />
                    <attachment id="12481671" name="LUCENE-2793.patch" size="76701" author="varunthacker" created="Tue, 7 Jun 2011 09:09:21 +0100" />
                    <attachment id="12481235" name="LUCENE-2793.patch" size="24091" author="varunthacker" created="Thu, 2 Jun 2011 15:27:39 +0100" />
                    <attachment id="12480868" name="LUCENE-2793.patch" size="15517" author="varunthacker" created="Mon, 30 May 2011 20:19:49 +0100" />
                    <attachment id="12480863" name="LUCENE-2793.patch" size="2326" author="varunthacker" created="Mon, 30 May 2011 19:24:55 +0100" />
                    <attachment id="12480793" name="LUCENE-2793.patch" size="15901" author="varunthacker" created="Sun, 29 May 2011 19:24:32 +0100" />
                    <attachment id="12468030" name="LUCENE-2793.patch" size="32021" author="jasonrutherglen" created="Tue, 11 Jan 2011 17:52:10 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>28.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 3 Dec 2010 16:05:46 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3944</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24899</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>