<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:18:15 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1374/LUCENE-1374.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1374] Merging of compressed string Fields may hit NPE</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1374</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;This bug was introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1219&quot; title=&quot;support array/offset/ length setters for Field with binary data&quot;&gt;&lt;del&gt;LUCENE-1219&lt;/del&gt;&lt;/a&gt; (only present on 2.4).&lt;/p&gt;

&lt;p&gt;The bug happens when merging compressed string fields, but only if bulk-merging code does not apply because the FieldInfos for the segment being merged are not congruent.  This test shows the bug:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMergeCompressedFields() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    File indexDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.getProperty(&lt;span class=&quot;code-quote&quot;&gt;&quot;tempDir&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;mergecompressedfields&quot;&lt;/span&gt;);
    Directory dir = FSDirectory.getDirectory(indexDir);
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;5;i++) {
        &lt;span class=&quot;code-comment&quot;&gt;// Must make a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; writer &amp;amp; doc each time, w/
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// different fields, so bulk merge of stored fields
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// cannot run:
&lt;/span&gt;        IndexWriter w = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriter(dir, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WhitespaceAnalyzer(), i==0, IndexWriter.MaxFieldLength.UNLIMITED);
        w.setMergeFactor(5);
        w.setMergeScheduler(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerialMergeScheduler());
        Document doc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Document();
        doc.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;test1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is some data that will be compressed &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;, Field.Store.COMPRESS, Field.Index.NO));
        doc.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;test2&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[20], Field.Store.COMPRESS));
        doc.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;field&quot;&lt;/span&gt; + i, &lt;span class=&quot;code-quote&quot;&gt;&quot;random field&quot;&lt;/span&gt;, Field.Store.NO, Field.Index.TOKENIZED));
        w.addDocument(doc);
        w.close();
      }

      &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] cmp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[20];

      IndexReader r = IndexReader.open(dir);
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;5;i++) {
        Document doc = r.document(i);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is some data that will be compressed &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;, doc.getField(&lt;span class=&quot;code-quote&quot;&gt;&quot;test1&quot;&lt;/span&gt;).stringValue());
        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] b = doc.getField(&lt;span class=&quot;code-quote&quot;&gt;&quot;test2&quot;&lt;/span&gt;).binaryValue();
        assertTrue(Arrays.equals(b, cmp));
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      dir.close();
      _TestUtil.rmDir(indexDir);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s because in FieldsReader, when we load a field &quot;for merge&quot; we create a FieldForMerge instance which subsequently does not return the right values for getBinary&lt;/p&gt;
{Value,Length,Offset}
&lt;p&gt;.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12403599">LUCENE-1374</key>
            <summary>Merging of compressed string Fields may hit NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Sep 2008 11:14:18 +0100</created>
                <updated>Sat, 11 Oct 2008 13:49:41 +0100</updated>
                    <resolved>Wed, 3 Sep 2008 15:00:07 +0100</resolved>
                            <version>2.4</version>
                                <fixVersion>2.4</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12627968" author="mikemccand" created="Wed, 3 Sep 2008 12:51:11 +0100"  >&lt;p&gt;Attached patch that fixes AbstractField&apos;s getBinaryValue() and getBinaryLength() methods to fallback to &quot;fieldsData instanceof byte[]&quot; when appropriate.  I plan to commit shortly.&lt;/p&gt;</comment>
                    <comment id="12628002" author="mikemccand" created="Wed, 3 Sep 2008 15:00:07 +0100"  >&lt;p&gt;Committed revision 691617.&lt;/p&gt;</comment>
                    <comment id="12628055" author="ryguasu" created="Wed, 3 Sep 2008 18:01:46 +0100"  >&lt;p&gt;&quot;ant test&quot; on 691617 for me fails on the following test:&lt;/p&gt;

&lt;p&gt;  &amp;lt;testcase classname=&quot;org.apache.lucene.index.TestIndexWriter&quot; name=&quot;testMergeCompressedFields&quot; time=&quot;0.36&quot;&amp;gt;&lt;br/&gt;
    &amp;lt;error message=&quot;could not delete C:\lucene\691647\build\test\mergecompressedfields&amp;#95;5.cfs&quot; type=&quot;java.io.IOException&quot;&amp;gt;java.io.IOException: could not delete C:\lucene\691647\build\test\mergecompressedfields&amp;#95;5.cfs&lt;br/&gt;
	at org.apache.lucene.util._TestUtil.rmDir(_TestUtil.java:37)&lt;br/&gt;
	at org.apache.lucene.index.TestIndexWriter.testMergeCompressedFields(TestIndexWriter.java:4111)&lt;br/&gt;
&amp;lt;/error&amp;gt;&lt;br/&gt;
  &amp;lt;/testcase&amp;gt;&lt;/p&gt;

&lt;p&gt;It might be one of those things that shows up only on Windows. In any case, adding a call to IndexReader.close() in testMergeCompressedFields() seems to fix things up:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      IndexReader r = IndexReader.open(dir);
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i=0;i&amp;lt;5;i++) {
        Document doc = r.document(i);
        assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is some data that will be compressed &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;, doc.getField(&lt;span class=&quot;code-quote&quot;&gt;&quot;test1&quot;&lt;/span&gt;).stringValue());
        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] b = doc.getField(&lt;span class=&quot;code-quote&quot;&gt;&quot;test2&quot;&lt;/span&gt;).binaryValue();
        assertTrue(Arrays.equals(b, cmp));
      }
      r.close();  &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;------------------------------- New line
&lt;/span&gt;    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      dir.close();
      _TestUtil.rmDir(indexDir);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I guess technically the r.close() probably belongs in a finally block as well.&lt;/p&gt;</comment>
                    <comment id="12628067" author="mikemccand" created="Wed, 3 Sep 2008 18:33:08 +0100"  >&lt;p&gt;Woops, you&apos;re right: I too see that failure (to rmDir the directory) only on Windows.  I&apos;ll commit a fix.  Thanks Chris!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12389419" name="LUCENE-1374.patch" size="3414" author="mikemccand" created="Wed, 3 Sep 2008 12:51:11 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 3 Sep 2008 17:01:46 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12377</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26357</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>