<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:18:53 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1310/LUCENE-1310.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1310] Phrase query with term repeated 3 times requires more slop than expected</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1310</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Consider a document with the text &quot;A A A&quot;.&lt;br/&gt;
The phrase query &quot;A A A&quot; (exact match) succeeds.&lt;br/&gt;
The query &quot;A A A&quot;~1 (same document and query, just increasing the slop value by one) fails.&lt;br/&gt;
&quot;A A A&quot;~2 succeeds again.&lt;/p&gt;

&lt;p&gt;If the exact match succeeds, I wouldn&apos;t expect the same query but with more slop to fail.  The fault seems to require some term to be repeated at least three times in the query, but the three occurrences do not need to be adjacent.  I will attach a file that contains a set of JUnit tests that demonstrate what I mean.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12398660">LUCENE-1310</key>
            <summary>Phrase query with term repeated 3 times requires more slop than expected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png">Resolved</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="gglouser">Grant Glouser</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jun 2008 04:48:57 +0100</created>
                <updated>Tue, 5 Aug 2008 08:44:04 +0100</updated>
                    <resolved>Tue, 5 Aug 2008 08:44:04 +0100</resolved>
                            <version>2.3.1</version>
                <version>2.3.2</version>
                                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12608484" author="doronc" created="Thu, 26 Jun 2008 17:28:55 +0100"  >&lt;p&gt;I am too getting the error with the test. It is a bug indeed.&lt;br/&gt;
I think I see where the problem is - working on it.&lt;/p&gt;</comment>
                    <comment id="12608528" author="doronc" created="Thu, 26 Jun 2008 19:05:36 +0100"  >&lt;p&gt;Patch with a fix.&lt;/p&gt;

&lt;p&gt;Problem was in the logic for advancing PhrasePositions that were pointing to exactly the same term in the document.&lt;br/&gt;
Note that this advancing is required to avoid false matches (as was fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-736&quot; title=&quot;Sloppy Phrase Scorer matches the doc &amp;quot;A B C D E&amp;quot; for query = &amp;quot;B C B&amp;quot;~2&quot;&gt;&lt;del&gt;LUCENE-736&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
However must first advance the PhrasePosition whose offset (in the query) is the highest.&lt;/p&gt;

&lt;p&gt;As a side effect of this fix sorting of the &quot;repeats&quot; array (at scorer initialization) is no longer required.&lt;/p&gt;

&lt;p&gt;Grant&apos;s test is also in the patch, slightly modified.&lt;/p&gt;

&lt;p&gt;Grant, can you give it a try and report here?&lt;/p&gt;</comment>
                    <comment id="12608648" author="gglouser" created="Fri, 27 Jun 2008 04:57:37 +0100"  >&lt;p&gt;There is a potential NPE.  I am adding a patch (which should apply on top of the previous patch) that adds a test case and possible fix.&lt;/p&gt;

&lt;p&gt;I will continue testing this.  Thanks for looking at it, Doron.&lt;/p&gt;</comment>
                    <comment id="12609022" author="doronc" created="Sat, 28 Jun 2008 17:04:23 +0100"  >&lt;p&gt;You&apos;re right! And thanks for cacthing this!&lt;br/&gt;
NPE is possible and I see it too with the new test. &lt;br/&gt;
I think the suggested new fix is likely to miss additional matches in the same doc. &lt;br/&gt;
I&apos;ll later post a test that shows this.&lt;/p&gt;

&lt;p&gt;(As a side comment, its useful to post patches named &quot;LUCENE-NNN.patch&quot; where NNN is the issue number.&lt;br/&gt;
This way JIRA shows which fix is the most recent very clearly, and also, being a complete patch, everyone can easily apply the entire patch.&lt;br/&gt;
More on this in the Wiki under HowToContribute.)&lt;/p&gt;</comment>
                    <comment id="12609025" author="doronc" created="Sat, 28 Jun 2008 17:29:18 +0100"  >&lt;p&gt;Updated patch with a fix for the NPE and with a test that fails with the previous fix for the NPE.&lt;br/&gt;
The point is to switch to the pp with higher (query) offset in case two pps are in the same (doc) position.&lt;/p&gt;</comment>
                    <comment id="12609047" author="doronc" created="Sat, 28 Jun 2008 21:19:08 +0100"  >&lt;p&gt;Previous patch might restore the queue wrongly - pop pp but put pp2.&lt;br/&gt;
This patch fixes that by returning the correct pp into the pq.&lt;br/&gt;
However it is yet not perfect since the one pp returned to pq might not be the last one advanced.&lt;br/&gt;
This means pq could be sorted incorrectly with regard to repeating terms.&lt;br/&gt;
I didn&apos;t manage to create a test case that fails due to this - testDoc4_Query3_All_Slops_Should_match in the test was the last trial to catch this.&lt;br/&gt;
The only perfect solution I see is to re-populate the queue when this happens but this is costly and I tend not to do it.&lt;br/&gt;
Open for suggestions...&lt;/p&gt;
</comment>
                    <comment id="12609271" author="doronc" created="Mon, 30 Jun 2008 16:56:42 +0100"  >&lt;p&gt;Updated patch fixes this issue. &lt;br/&gt;
In case of repeating terms in the query, this might be slower than previous patch, but it is supposedly correct in all cases while the previous one was not guaranteed to be always correct. There are no performance implications for the more common case of no repeating terms in the query.&lt;br/&gt;
I plan to commit this in a day or two.&lt;/p&gt;</comment>
                    <comment id="12609406" author="gglouser" created="Tue, 1 Jul 2008 00:47:20 +0100"  >&lt;p&gt;termPositionsDiffer can return the PhrasePositions that was passed in (pp), which means you could be passing the same PhrasePositions to flip in both arguments.  But flip assumes that the arguments are different.  This can result in an ArrayIndexOutOfBoundsException in flip.  Perhaps just checking that pp2 != pp on line 76 would be sufficient to avoid this.&lt;/p&gt;

&lt;p&gt;I have not been able to come up with a simple test case that triggers this.  I have a complex one, but it uses a custom Analyzer.&lt;/p&gt;</comment>
                    <comment id="12609436" author="doronc" created="Tue, 1 Jul 2008 04:56:50 +0100"  >&lt;p&gt;You&apos;re right, Grant, good catch, thanks!&lt;br/&gt;
(I&apos;m sure had this check but lost it when refactoring flipping to a method)&lt;br/&gt;
Updated patch to follow.&lt;/p&gt;</comment>
                    <comment id="12609438" author="doronc" created="Tue, 1 Jul 2008 05:01:31 +0100"  >&lt;p&gt;Updated patch with required check (pp!=pp2) before flipping as Grant suggested.&lt;/p&gt;</comment>
                    <comment id="12609445" author="doronc" created="Tue, 1 Jul 2008 05:28:32 +0100"  >&lt;p&gt;same patch but for 2.3.1.&lt;/p&gt;</comment>
                    <comment id="12619339" author="doronc" created="Sun, 3 Aug 2008 16:54:22 +0100"  >&lt;p&gt;Committed to trunk.&lt;/p&gt;

&lt;p&gt;I was wondering if this should be backported to 2.3.1 and/or 2.3.2. &lt;br/&gt;
It is not a major bug so I think not, though it might be critical to some application.&lt;br/&gt;
Didn&apos;t find a guideline for this in the wiki but I may be missing it?&lt;/p&gt;</comment>
                    <comment id="12619809" author="doronc" created="Tue, 5 Aug 2008 08:44:04 +0100"  >&lt;p&gt;Fixed, thanks for the review Grant!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12384809" name="LUCENE-1310.1.patch" size="1810" author="gglouser" created="Fri, 27 Jun 2008 04:57:37 +0100" />
                    <attachment id="12384998" name="LUCENE-1310.patch" size="13348" author="doronc" created="Tue, 1 Jul 2008 05:01:31 +0100" />
                    <attachment id="12384967" name="LUCENE-1310.patch" size="13337" author="doronc" created="Mon, 30 Jun 2008 16:56:42 +0100" />
                    <attachment id="12384899" name="LUCENE-1310.patch" size="12528" author="doronc" created="Sat, 28 Jun 2008 21:19:08 +0100" />
                    <attachment id="12384890" name="LUCENE-1310.patch" size="11628" author="doronc" created="Sat, 28 Jun 2008 17:29:18 +0100" />
                    <attachment id="12384774" name="LUCENE-1310.patch" size="9766" author="doronc" created="Thu, 26 Jun 2008 19:05:36 +0100" />
                    <attachment id="12385000" name="LUCENE-2.3.1-1310.patch" size="13262" author="doronc" created="Tue, 1 Jul 2008 05:28:32 +0100" />
                    <attachment id="12384342" name="TestSloppyPhraseQuery.java" size="3370" author="gglouser" created="Fri, 20 Jun 2008 04:50:29 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>8.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 26 Jun 2008 16:28:55 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12438</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26418</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>