<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:23:19 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1120/LUCENE-1120.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1120] Use bulk-byte-copy when merging term vectors</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1120</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Indexing all of Wikipedia, with term vectors on, under the YourKit&lt;br/&gt;
profiler, shows that 26% of the time (!!) was spent merging the&lt;br/&gt;
vectors.  This was without offsets &amp;amp; positions, which would make&lt;br/&gt;
matters even worse.&lt;/p&gt;

&lt;p&gt;Depressingly, merging, even with ConcurrentMergeScheduler, cannot in&lt;br/&gt;
fact keep up with the flushing of new segments in this test, and this&lt;br/&gt;
is on a strong IO system (Mac Pro with 4 drive RAID 0 array, 4 CPU&lt;br/&gt;
cores).&lt;/p&gt;

&lt;p&gt;So, just like Robert&apos;s idea to merge stored fields with bulk copying&lt;br/&gt;
whenever the field name-&amp;gt;number mapping is &quot;congruent&quot; (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1043&quot; title=&quot;Speedup merging of stored fields when field mapping &amp;quot;matches&amp;quot;&quot;&gt;&lt;del&gt;LUCENE-1043&lt;/del&gt;&lt;/a&gt;),&lt;br/&gt;
we can do the same with term vectors.&lt;/p&gt;

&lt;p&gt;It&apos;s a little trickier because the term vectors format doesn&apos;t quite&lt;br/&gt;
make it easy to bulk-copy because it doesn&apos;t directly encode the&lt;br/&gt;
offset into the tvf file.&lt;/p&gt;

&lt;p&gt;I worked out a patch that changes the tvx format slightly, by storing&lt;br/&gt;
the absolute position in the tvf file for the start of each document&lt;br/&gt;
into the tvx file, just like it does for tvd now.  This adds an extra&lt;br/&gt;
8 bytes (long) in the tvx file, per document.&lt;/p&gt;

&lt;p&gt;Then, I removed a vLong (the first &quot;position&quot; stored inside the tvd&lt;br/&gt;
file), which makes tvd contents fully position independent (so you can&lt;br/&gt;
just copy the bytes).&lt;/p&gt;

&lt;p&gt;This adds up to 7 bytes per document (less for larger indices) that&lt;br/&gt;
have term vectors enabled, but I think this small increase in index&lt;br/&gt;
size is acceptable for the gains in indexing performance?&lt;/p&gt;

&lt;p&gt;With this change, the time spent merging term vectors dropped from 26%&lt;br/&gt;
to 3%.  Of course, this only applies if your documents are &quot;regular&quot;.&lt;br/&gt;
I think in the future we could have Lucene try hard to assign the same&lt;br/&gt;
field number for a given field name, if it had been seen before in the&lt;br/&gt;
index...&lt;/p&gt;

&lt;p&gt;Merging terms now dominates the merge cost (~20% over overall time&lt;br/&gt;
building the Wikipedia index).&lt;/p&gt;

&lt;p&gt;I also beefed up TestBackwardsCompatibility unit test: test a non-CFS&lt;br/&gt;
and a CFS of versions 1.9, 2.0, 2.1, 2.2 index formats, and added some&lt;br/&gt;
term vector fields to these indices.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12385707">LUCENE-1120</key>
            <summary>Use bulk-byte-copy when merging term vectors</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jan 2008 14:52:38 +0000</created>
                <updated>Sat, 11 Oct 2008 13:49:34 +0100</updated>
                    <resolved>Fri, 25 Jan 2008 11:33:34 +0000</resolved>
                                            <fixVersion>2.4</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12556576" author="mikemccand" created="Mon, 7 Jan 2008 14:55:42 +0000"  >&lt;p&gt;Attached patch.  All tests pass.&lt;/p&gt;

&lt;p&gt;(Note that the TestBackwardsCompatibility test will fail if you apply the patch because the new *.zip files I added aren&apos;t in the patch).&lt;/p&gt;

&lt;p&gt;I think we should commit this for 2.3?  It&apos;s a sizable gain in merging&lt;br/&gt;
performance.&lt;/p&gt;</comment>
                    <comment id="12556586" author="michaelbusch" created="Mon, 7 Jan 2008 15:21:40 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think we should commit this for 2.3? It&apos;s a sizable gain in merging&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;HI Mike,&lt;/p&gt;

&lt;p&gt;I&apos;m planning to branch the trunk today. Considering the file format changes, it might be a bit risky to apply this patch last minute. I think we should commit this for 2.4. What do you think?&lt;/p&gt;

&lt;p&gt;-Michael&lt;/p&gt;</comment>
                    <comment id="12556589" author="mikemccand" created="Mon, 7 Jan 2008 15:36:26 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Considering the file format changes, it might be a bit risky to apply this patch last minute. I think we should commit this for 2.4. What do you think?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK, I agree, it is somewhat risky, so let&apos;s wait.  (Though it is a sizable gain in performance!).&lt;/p&gt;</comment>
                    <comment id="12556590" author="michaelbusch" created="Mon, 7 Jan 2008 15:36:57 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Indexing all of Wikipedia, with term vectors on, under the YourKit&lt;br/&gt;
profiler, shows that 26% of the time (!!) was spent merging the&lt;br/&gt;
vectors. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I wonder how accurate these profiling numbers are? Java profiling slows&lt;br/&gt;
down (non-native) method calls, but not I/O operations. Did you measure&lt;br/&gt;
the merge time before and after applying this patch without a profiling&lt;br/&gt;
tool?&lt;/p&gt;

&lt;p&gt;-Michael&lt;/p&gt;</comment>
                    <comment id="12556593" author="mikemccand" created="Mon, 7 Jan 2008 15:39:47 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I wonder how accurate these profiling numbers are? Java profiling slows&lt;br/&gt;
down (non-native) method calls, but not I/O operations. Did you measure&lt;br/&gt;
the merge time before and after applying this patch without a profiling&lt;br/&gt;
tool?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good point &amp;#8211; I haven&apos;t measured outside of profiling.  I plan to build a full Wiki index with and without this change to test....&lt;/p&gt;</comment>
                    <comment id="12560916" author="mikemccand" created="Mon, 21 Jan 2008 02:51:50 +0000"  >&lt;p&gt;Attached patch updated to current trunk.  All tests pass.  I plan to&lt;br/&gt;
commit after 2.3 is out...&lt;/p&gt;

&lt;p&gt;OK I ran a performance test with this patch, indexing the first 200K&lt;br/&gt;
docs of Wikipedia using this alg:&lt;/p&gt;

&lt;p&gt;  analyzer=org.apache.lucene.analysis.standard.StandardAnalyzer&lt;br/&gt;
  doc.maker=org.apache.lucene.benchmark.byTask.feeds.LineDocMaker&lt;/p&gt;

&lt;p&gt;  doc.stored = true&lt;br/&gt;
  doc.term.vector = true&lt;br/&gt;
  doc.term.vector.positions = true&lt;br/&gt;
  doc.term.vector.offsets = true&lt;/p&gt;

&lt;p&gt;  docs.file=/Volumes/External/lucene/wiki.txt&lt;/p&gt;

&lt;p&gt;  directory=FSDirectory&lt;/p&gt;

&lt;p&gt;  merge.scheduler=org.apache.lucene.index.SerialMergeScheduler&lt;/p&gt;

&lt;p&gt;  { &quot;Rounds&quot;&lt;br/&gt;
    ResetSystemErase&lt;br/&gt;
    { &quot;BuildIndex&quot;&lt;br/&gt;
      CreateIndex&lt;/p&gt;
      { &quot;AddDocs&quot; AddDoc &amp;gt; : 200000
      CloseIndex
    }
&lt;p&gt;    NewRound&lt;br/&gt;
  } : 3&lt;/p&gt;

&lt;p&gt;  RepSumByPrefRound BuildIndex&lt;/p&gt;

&lt;p&gt;I used SerialMergeScheduler so that I could measure time saved due to&lt;br/&gt;
faster merging.&lt;/p&gt;

&lt;p&gt;Without the patch, best of 3 was 509.0 sec; with patch, best of 3 was&lt;br/&gt;
448.8 sec = 11.8% overall speedup.&lt;/p&gt;</comment>
                    <comment id="12560917" author="mikemccand" created="Mon, 21 Jan 2008 02:53:18 +0000"  >&lt;p&gt;Attaching the right patch this time...&lt;/p&gt;</comment>
                    <comment id="12562448" author="mikemccand" created="Fri, 25 Jan 2008 11:33:34 +0000"  >&lt;p&gt;I just committed this.  Note that this is a &lt;span class=&quot;error&quot;&gt;&amp;#91;small&amp;#93;&lt;/span&gt; change to the index format, so if you use trunk to build an index, 2.3 won&apos;t be able to read it!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12372624" name="LUCENE-1120.patch" size="32805" author="mikemccand" created="Mon, 7 Jan 2008 14:55:42 +0000" />
                    <attachment id="12373647" name="LUCENE-1120.take2.patch" size="34353" author="mikemccand" created="Mon, 21 Jan 2008 02:53:18 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 7 Jan 2008 15:21:40 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12625</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26609</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>