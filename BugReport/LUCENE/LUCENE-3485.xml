<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:32:26 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3485/LUCENE-3485.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3485] LuceneTaxonomyReader .decRef() may close the inner IR, renderring the LTR in a limbo.</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3485</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;TaxonomyReader which supports ref-counting, has a decRef() method which delegates to an inner IndexReader and calls its .decRef(). The latter may close the reader (if the ref is zeroes) but the taxonomy would remain &apos;open&apos; which will fail many of its method calls.&lt;/p&gt;

&lt;p&gt;Also, the LTR&apos;s .close() method does not work in the same manner as IndexReader&apos;s - which calls decRef(), and leaves the real closing logic to the decRef(). I believe this should be the right approach for the fix.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12525663">LUCENE-3485</key>
            <summary>LuceneTaxonomyReader .decRef() may close the inner IR, renderring the LTR in a limbo.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="giladbarkai">Gilad Barkai</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Oct 2011 14:32:26 +0100</created>
                <updated>Sun, 27 Nov 2011 12:29:29 +0000</updated>
                    <resolved>Wed, 5 Oct 2011 13:24:47 +0100</resolved>
                            <version>3.4</version>
                                <fixVersion>3.5</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/facet</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13120232" author="shaie" created="Tue, 4 Oct 2011 16:53:43 +0100"  >&lt;p&gt;Good catch Gilad ! Do you intend to prepare a patch?&lt;/p&gt;

&lt;p&gt;Also, we probably shouldn&apos;t close the directory in close(), since it was given to us from the outside. So it&apos;s whoever created the directory responsibility to close it. We should however eliminate the two deprecated ctors which take a File &amp;#8211; no need to have them around anymore, and we&apos;re not bound to back-compat in this module, yet &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                    <comment id="13120235" author="giladbarkai" created="Tue, 4 Oct 2011 16:56:12 +0100"  >&lt;p&gt;Thanks for the comment Shai.&lt;/p&gt;

&lt;p&gt;The only Directory that is closed is the one that is NOT given - but rather wrapped around a given File.&lt;br/&gt;
I agree that this constructor should be removed, I did not take care of it just yet...&lt;/p&gt;

&lt;p&gt;Attached a patch - Moving closer to IndexReader&apos;s ref counting paradigm, also introducing ensureClose().&lt;/p&gt;</comment>
                    <comment id="13120247" author="giladbarkai" created="Tue, 4 Oct 2011 17:16:36 +0100"  >&lt;p&gt;Removed deprecated constructors, no private directory to close now.&lt;/p&gt;

&lt;p&gt;Also fixed a small bug from the previous patch.&lt;/p&gt;</comment>
                    <comment id="13120386" author="shaie" created="Tue, 4 Oct 2011 20:06:26 +0100"  >&lt;p&gt;Patch looks good ! Few minor comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think that it&apos;s better to set closed=true in the end of doClose(), after everything succeeds.&lt;/li&gt;
	&lt;li&gt;In doClose, perhaps nullify the two caches? this can come instead of, or in addition to, clear()-ing them&lt;/li&gt;
	&lt;li&gt;doClose is package-private: is that on purpose, or did you mean to make it protected/private? Seems to me like it should be private, because you don&apos;t want to call it more than once.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13120664" author="shaie" created="Wed, 5 Oct 2011 05:23:21 +0100"  >&lt;p&gt;I had another look at the patch, and something bothers me about ensureOpen() and how close is set to true. Currently, if I call close(), and another thread has an instance of TR, any operations he&apos;ll try to do will fail by ensureOpen().&lt;/p&gt;

&lt;p&gt;I think that we should remove &apos;close&apos; and check on IR.refCount(). When it&apos;s &amp;lt;= 0, we&apos;re closed for business, otherwise the TR should not be marked close().&lt;/p&gt;

&lt;p&gt;I looked at IndexReader and two things:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Its ensureOpen checks refCount()&lt;/li&gt;
	&lt;li&gt;Its close looks entirely redundant ...&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    <comment id="13120670" author="giladbarkai" created="Wed, 5 Oct 2011 05:40:59 +0100"  >&lt;p&gt;Thanks Shai, you are right, &apos;closed&apos; should only be used inside close().&lt;br/&gt;
About your previous comment on nullifying the caches, those are &apos;final&apos; at the moment and i&apos;m not sure it worthwhile unfinaling them just to be nullified - IIRC there are optimizations that may benefit from final variables, and those caches could be hotspots.&lt;/p&gt;

&lt;p&gt;I&apos;ll modify the ensureOpen and post a new patch.&lt;/p&gt;</comment>
                    <comment id="13120774" author="shaie" created="Wed, 5 Oct 2011 10:22:10 +0100"  >&lt;p&gt;I&apos;m fine with not null-ing the caches then. It&apos;s not a big deal.&lt;/p&gt;

&lt;p&gt;About close(), we should keep closed so that calling close() multiple times has no side-effects, but we should change ensureReopen().&lt;/p&gt;</comment>
                    <comment id="13120781" author="giladbarkai" created="Wed, 5 Oct 2011 10:47:46 +0100"  >&lt;p&gt;New patch as per Shai&apos;s comments.&lt;/p&gt;</comment>
                    <comment id="13120883" author="shaie" created="Wed, 5 Oct 2011 13:24:47 +0100"  >&lt;p&gt;I removed some copy-paste errors from the test you added, and moved &apos;closed=true&apos; to after indexReader.close().&lt;/p&gt;

&lt;p&gt;Committed revision 1179183 (3x).&lt;br/&gt;
Committed revision 1179194 (trunk).&lt;/p&gt;

&lt;p&gt;Thanks Gilad !&lt;/p&gt;</comment>
                    <comment id="13157774" author="thetaphi" created="Sun, 27 Nov 2011 12:29:29 +0000"  >&lt;p&gt;Bulk close after release of 3.5&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12497773" name="LUCENE-3485.patch" size="11824" author="giladbarkai" created="Wed, 5 Oct 2011 10:47:46 +0100" />
                    <attachment id="12497653" name="LUCENE-3485.patch" size="7686" author="giladbarkai" created="Tue, 4 Oct 2011 17:16:36 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 4 Oct 2011 15:53:43 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>44295</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24211</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>