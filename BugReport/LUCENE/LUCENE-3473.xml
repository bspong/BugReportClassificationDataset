<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:09:38 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3473/LUCENE-3473.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3473] CheckIndex should verify numUniqueTerms == recomputedNumUniqueTerms</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3473</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Just glancing at the code it seems to sorta do this check, but only in the hasOrd==true case maybe (which seems to be testing something else)?&lt;/p&gt;

&lt;p&gt;It would be nice to verify this also for terms dicts that dont support ord.&lt;/p&gt;

&lt;p&gt;we should add explicit checks per-field in 4.x, and for-all-fields in 3.x and preflex&lt;/p&gt;</description>
                <environment></environment>
            <key id="12524969">LUCENE-3473</key>
            <summary>CheckIndex should verify numUniqueTerms == recomputedNumUniqueTerms</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="rcmuir">Robert Muir</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Sep 2011 22:04:10 +0100</created>
                <updated>Sun, 27 Nov 2011 12:29:34 +0000</updated>
                    <resolved>Tue, 25 Oct 2011 01:14:23 +0100</resolved>
                            <version>3.4</version>
                <version>4.0-ALPHA</version>
                                <fixVersion>3.5</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13133783" author="rcmuir" created="Mon, 24 Oct 2011 00:54:56 +0100"  >&lt;p&gt;Patch adding the checks to checkindex.&lt;/p&gt;

&lt;p&gt;there were some problems:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;IndexReader.getUniqueTermCount doesn&apos;t work in trunk, but works fine in 3.x. This is because it sums per-field across the Terms api, but PreFlex codec doesn&apos;t know this information per-field&lt;/li&gt;
	&lt;li&gt;If a field has no postings (but exists in fieldinfos), then IR.getUniqueTermCount hits an NPE (ant test-core -Dtestcase=TestNorms -Dtestmethod=testCustomEncoder -Dtests.seed=-6a2248fc7313e45:c41a685f840f6ed:-5a3fd5b8ec315508)&lt;/li&gt;
	&lt;li&gt;MemoryCodec didn&apos;t implement Fields.getUniqueTermCount, probably just forgotten because its not abstract (instead throwing UOE by default).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, i fixed MemoryCodec to impl Terms.getUniqueTermCount, changed Terms.getUniqueTermCount to be abstract (throw -1 if you cannot implement it), and added Fields.getUniqueTermCount, called by IR.getUniqueTermCount: default implementation sums across fields, but PreFlex overrides so that its IR.getUniqueTermCount works again.&lt;/p&gt;

&lt;p&gt;we might want to deprecate the latter method when 3.x indexes no longer need to be supported, or maybe its just fine as-is (you have to do the summing somewhere).&lt;/p&gt;</comment>
                    <comment id="13133784" author="rcmuir" created="Mon, 24 Oct 2011 01:22:43 +0100"  >&lt;p&gt;More fixes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;catch(UOE)&apos;s are removed in checkindex because now this stat just returns -1 like other stats when it isnt available.&lt;/li&gt;
	&lt;li&gt;DR.getUniqueTermCount returns -1 like MR now, and I adjusted the test to expect this rather than the exception.&lt;/li&gt;
	&lt;li&gt;Preflex is disabled in the test: only because we currently &apos;write&apos; preflex indexes actually as PerFieldCodecWrapper... which is bogus but a larger issue. Still, the preflex method is being tested for the older indexes when checkIndex runs. once we fix PreFlexRW to be a &quot;real codec&quot; that writes actual valid 3.x indexes we can remove the assume()&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13133800" author="rcmuir" created="Mon, 24 Oct 2011 03:01:00 +0100"  >&lt;p&gt;Hmm, I noticed i left a s.o.p in the previous patch for preflex, but it wasn&apos;t being called from CheckIndex.&lt;/p&gt;

&lt;p&gt;This is because we always wrap PreFlex inside PerFieldCodecWrapper... even if its a 3.x index! This is a problem as it still perpetuates the loss of IR.numUniqueTerms.&lt;/p&gt;

&lt;p&gt;So in this patch we no longer do this, which means I&apos;m able to remove the assume as well.&lt;/p&gt;

&lt;p&gt;But, now that preflex is being tested I think I&apos;ve found an off-by-one with this statistic when the field name is the empty string. &lt;/p&gt;

&lt;p&gt;I&apos;m gonna see if i can make a testcase/issue against 3.x separately for this... because this patch is already too big. &lt;/p&gt;

&lt;p&gt;NOTE: reproduce with: ant test -Dtestcase=TestIndexWriter -Dtestmethod=testEmptyFieldName -Dtests.seed=57fd2807ecfb5a2b:5556d32d3a1f68b7:469f7ed779c63825 -Dtests.codec=PreFlex&lt;/p&gt;</comment>
                    <comment id="13133803" author="rcmuir" created="Mon, 24 Oct 2011 03:23:32 +0100"  >&lt;p&gt;I committed the trivial patch to enable this check on 3.x branch... so something else is up with trunk... ill investigate.&lt;/p&gt;</comment>
                    <comment id="13134247" author="thetaphi" created="Mon, 24 Oct 2011 18:06:18 +0100"  >&lt;p&gt;Robert: In your patch is an additional test for CheckIndex on the old indexes. This is implicitely already done by: testSearchOldIndex, which calls Testutil&apos;s checkindex as first step. So this test is duplicate and slows down, right?&lt;/p&gt;</comment>
                    <comment id="13134248" author="rcmuir" created="Mon, 24 Oct 2011 18:09:54 +0100"  >&lt;p&gt;Uwe yes: i was actually adding this test only for debugging... I&apos;ll remove it (it does not give us any additional test coverage)&lt;/p&gt;</comment>
                    <comment id="13134259" author="rcmuir" created="Mon, 24 Oct 2011 18:16:47 +0100"  >&lt;p&gt;updated patch, now that &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3526&quot; title=&quot;preflex codec returns wrong terms if you use an empty field name&quot;&gt;&lt;del&gt;LUCENE-3526&lt;/del&gt;&lt;/a&gt; is fixed, all tests passed.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;removed the useless TestBackwardsCompatibility test (i was just debugging)&lt;/li&gt;
	&lt;li&gt;fixed TestRollingUpdates to not combine PreFlexCodec and MemoryCodec in PerFieldCodecWrapper (this is stupid, and causes my assert to trip)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13157806" author="thetaphi" created="Sun, 27 Nov 2011 12:29:34 +0000"  >&lt;p&gt;Bulk close after release of 3.5&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10032">
                <name>Blocker</name>
                                                <inwardlinks description="is blocked by">
                            <issuelink>
            <issuekey id="12528434">LUCENE-3526</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12500498" name="LUCENE-3473.patch" size="16966" author="rcmuir" created="Mon, 24 Oct 2011 18:16:47 +0100" />
                    <attachment id="12500391" name="LUCENE-3473.patch" size="17150" author="rcmuir" created="Mon, 24 Oct 2011 03:01:00 +0100" />
                    <attachment id="12500385" name="LUCENE-3473.patch" size="12903" author="rcmuir" created="Mon, 24 Oct 2011 01:22:43 +0100" />
                    <attachment id="12500384" name="LUCENE-3473.patch" size="11835" author="rcmuir" created="Mon, 24 Oct 2011 00:54:56 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 24 Oct 2011 17:06:18 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>33633</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24223</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>