<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:02:18 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3215/LUCENE-3215.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3215] SloppyPhraseScorer sometimes computes Infinite freq</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3215</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;reported on user list:&lt;br/&gt;
&lt;a href=&quot;http://www.lucidimagination.com/search/document/400cbc528ed63db9/score_of_infinity_on_dismax_query&quot; class=&quot;external-link&quot;&gt;http://www.lucidimagination.com/search/document/400cbc528ed63db9/score_of_infinity_on_dismax_query&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
            <key id="12510901">LUCENE-3215</key>
            <summary>SloppyPhraseScorer sometimes computes Infinite freq</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Jun 2011 04:45:38 +0100</created>
                <updated>Sun, 27 Nov 2011 12:29:36 +0000</updated>
                    <resolved>Thu, 22 Sep 2011 10:13:34 +0100</resolved>
                                            <fixVersion>3.5</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>1</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13051783" author="rcmuir" created="Mon, 20 Jun 2011 04:46:10 +0100"  >&lt;p&gt;test case&lt;/p&gt;</comment>
                    <comment id="13051786" author="rcmuir" created="Mon, 20 Jun 2011 04:51:07 +0100"  >&lt;p&gt;the problem in this case, is it computes a &apos;matchLength&apos; of -1.&lt;br/&gt;
then the default impl of sloppyFreq divides by zero, because its defined as:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;return 1.0f / (distance + 1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13051793" author="rcmuir" created="Mon, 20 Jun 2011 05:14:31 +0100"  >&lt;p&gt;those lyrics are entertaining, but here is a more concise test.&lt;/p&gt;</comment>
                    <comment id="13079964" author="rcmuir" created="Fri, 5 Aug 2011 14:23:56 +0100"  >&lt;p&gt;It seems to me the root cause of the bug is having position &apos;holes&apos; (e.g. stopwords), especially across duplicated terms...&lt;/p&gt;

&lt;p&gt;For example, if you disable position increments in queryparser it won&apos;t trigger the bug.&lt;/p&gt;</comment>
                    <comment id="13081350" author="rcmuir" created="Tue, 9 Aug 2011 02:08:48 +0100"  >&lt;p&gt;Here&apos;s a hack patch... &lt;/p&gt;

&lt;p&gt;I tried writing some correctness tests here but its &lt;b&gt;really&lt;/b&gt; hard for me to visualize what the freq should even be for these &quot;sloppy repeating phrase queries with holes&quot;.&lt;/p&gt;</comment>
                    <comment id="13100182" author="doronc" created="Thu, 8 Sep 2011 10:43:45 +0100"  >&lt;p&gt;An update on this...&lt;/p&gt;

&lt;p&gt;This is not related to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3142&quot; title=&quot;benchmark/stats package is obsolete and unused - remove it&quot;&gt;&lt;del&gt;LUCENE-3142&lt;/del&gt;&lt;/a&gt; - the latter was fixed but this one still fails.&lt;/p&gt;

&lt;p&gt;The patch fix which &apos;abs&apos; the distance indeed avoids the infinite score problem, but I was not 100% comfortable with it - how can the distance be none positive?&lt;/p&gt;

&lt;p&gt;Digging into it shows a wrong assumption in SloppyPhraseScorer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; initPhrasePositions() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; end = 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The initial value of end assumes that all positions will be nonnegative.&lt;br/&gt;
But this is wrong, as PP position is computed as &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  position = postings.nextPosition() - offset
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, whenever the query term appears in the doc in a position smaller than its offset in the query, the computed position is negative. The correct initialization for end is therefore:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; initPhrasePositions() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; end = &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MIN_VALUE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You would expect this bug to surfaced sooner...&lt;/p&gt;

&lt;p&gt;Anyhow, for the 3 tests that Robert added, this only resolve testInfiniteFreq1() but the other two tests still fail, investigating...&lt;/p&gt;</comment>
                    <comment id="13107209" author="doronc" created="Sat, 17 Sep 2011 19:52:21 +0100"  >&lt;p&gt;OK I think I have a fix for this.&lt;/p&gt;

&lt;p&gt;While looking at it, I realized that PhraseScorer (the one that used to base both Exact&amp;amp;Sloppy phrase scorers but now is the base of only sloppy phrase scorer) is way too complicated and inefficient. All those sort calls after each matching doc can be avoided. &lt;/p&gt;

&lt;p&gt;So I am modifying PhraseScorer to not have a phrase-queue at all - just the sorted linked list, which is always kept sorted by advancing last beyond first. Last is renamed to &apos;min&apos; and first is renamed to &apos;max&apos;. Making the list cyclic allows more efficient manipulation of it. &lt;/p&gt;

&lt;p&gt;With this, SloppyPhraseScorer is modified to maintain its own phrase queue. The queue size is set at the first candidate document. In order to handle repetitions (Same term in different query offsets) it will contain only some of the pps: those that either have no repetitions, or are the first (lower query offset) in a repeating group. A linked list of repeating pps was added: so PhrasePositions has a new member: nextRepeating.&lt;/p&gt;

&lt;p&gt;Detection of repeating pps and creation of that list is done once per scorer: at the first candidate doc.&lt;/p&gt;

&lt;p&gt;For solving the bugs reported here, in addition to the initiation of &apos;end&apos; as explained in previous comment, advanceRepeatingPPs now also update two values:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;end, in case one of the repeating pps is far ahead (larger)&lt;/li&gt;
	&lt;li&gt;position of the first pp in a repeating list (the one that is in the queue - in case the repeating pp is far behind (smaller). This can happen when there are holes in the query, as position = tpPOs - offset. It fixes the problem of false negative distances which caused this bug. It is tricky: relies on that PhrasePositions.nextPosition() ignores pp.position and just call positions.nextPosition(). But it is correct, as the modified position is used to replace pp in the queue.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Last, I think that the test added with holes had one wrong assert: It added four docs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;drug drug&lt;/li&gt;
	&lt;li&gt;drug druggy drug&lt;/li&gt;
	&lt;li&gt;drug druggy druggy drug&lt;/li&gt;
	&lt;li&gt;drug druggy drug druggy drug&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;defined this query (number is the offset):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;drug(1) drug(3)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and expected that with slop=1 the first doc would not be found.&lt;br/&gt;
I think it should be found, as the slop operates in both directions.&lt;br/&gt;
So modified the query to: drug(1) drug(3)&lt;/p&gt;

&lt;p&gt;Patch to follow.&lt;/p&gt;</comment>
                    <comment id="13107211" author="doronc" created="Sat, 17 Sep 2011 20:01:14 +0100"  >&lt;p&gt;Attached patch is based on r1166541 - before recent changes to scorers. Will merge with recent changes tomorrow or so. All tests pass.&lt;br/&gt;
I believe that sloppy scoring performance should improve with this change but did not check this.&lt;/p&gt;</comment>
                    <comment id="13107223" author="doronc" created="Sat, 17 Sep 2011 20:37:07 +0100"  >&lt;p&gt;Updated patch for current trunk r1172055.&lt;/p&gt;</comment>
                    <comment id="13108441" author="doronc" created="Tue, 20 Sep 2011 09:42:20 +0100"  >&lt;p&gt;Previous patch still produces NANs and infinite scores with holes.&lt;br/&gt;
Updated patch is fixing this, by updating END (before computing the new match-length) also for pp (not only for its repeats).&lt;/p&gt;

&lt;p&gt;I plan to commit this soon.&lt;/p&gt;</comment>
                    <comment id="13112429" author="doronc" created="Thu, 22 Sep 2011 10:13:34 +0100"  >&lt;p&gt;Fixed&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;r1173961 - trunk&lt;/li&gt;
	&lt;li&gt;r1174002 - 3x&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Prior to committing I compared the performance of sloppy phrase queries with/out repeats for large documents with many candidate matches and did not see the anticipated speedup, though, at least, no degradations as well.&lt;/p&gt;</comment>
                    <comment id="13157814" author="thetaphi" created="Sun, 27 Nov 2011 12:29:36 +0000"  >&lt;p&gt;Bulk close after release of 3.5&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12495200" name="LUCENE-3215.patch" size="33796" author="doronc" created="Tue, 20 Sep 2011 09:42:20 +0100" />
                    <attachment id="12494939" name="LUCENE-3215.patch" size="33306" author="doronc" created="Sat, 17 Sep 2011 20:37:07 +0100" />
                    <attachment id="12494937" name="LUCENE-3215.patch" size="34331" author="doronc" created="Sat, 17 Sep 2011 20:01:14 +0100" />
                    <attachment id="12489790" name="LUCENE-3215.patch" size="6068" author="rcmuir" created="Tue, 9 Aug 2011 02:08:48 +0100" />
                    <attachment id="12483109" name="LUCENE-3215_test.patch" size="2453" author="rcmuir" created="Mon, 20 Jun 2011 05:14:31 +0100" />
                    <attachment id="12483108" name="LUCENE-3215_test.patch" size="3578" author="rcmuir" created="Mon, 20 Jun 2011 04:46:10 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 8 Sep 2011 09:43:45 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10778</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24482</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>