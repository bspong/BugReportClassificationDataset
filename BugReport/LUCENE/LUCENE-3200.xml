<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:16:50 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3200/LUCENE-3200.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3200] Cleanup MMapDirectory to use only one MMapIndexInput impl with mapping sized of powers of 2</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3200</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Robert and me discussed a little bit after Mike&apos;s investigations, that using SingleMMapIndexinput together with MultiMMapIndexInput leads to hotspot slowdowns sometimes.&lt;/p&gt;

&lt;p&gt;We had the following ideas:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MultiMMapIndexInput is almost as fast as SingleMMapIndexInput, as the switching between buffer boundaries is done in exception catch blocks. So normal code path is always the same like for Single*&lt;/li&gt;
	&lt;li&gt;Only the seek method uses strange calculations (the modulo is totally bogus, it could be simply: int bufOffset = (int) (pos % maxBufSize); - very strange way of calculating modulo in the original code)&lt;/li&gt;
	&lt;li&gt;Because of speed we suggest to no longer use arbitrary buffer sizes. We should pass only the power of 2 to the indexinput as size. All calculations in seek and anywhere else would be simple bit shifts and AND operations (the and masks for the modulo can be calculated in the ctor like NumericUtils does when calculating precisionSteps).&lt;/li&gt;
	&lt;li&gt;the maximum buffer size will now be 2^30, not 2^31-1. But thats not an issue at all. In my opinion, a buffer size of 2^31-1 is stupid in all cases, as it will no longer fit page boundaries and mmapping gets harder for the O/S.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We will provide a patch with those cleanups.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12510243">LUCENE-3200</key>
            <summary>Cleanup MMapDirectory to use only one MMapIndexInput impl with mapping sized of powers of 2</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Jun 2011 23:38:35 +0100</created>
                <updated>Tue, 22 Nov 2011 20:20:46 +0000</updated>
                    <resolved>Tue, 14 Jun 2011 13:55:49 +0100</resolved>
                                            <fixVersion>3.3</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13048858" author="rcmuir" created="Tue, 14 Jun 2011 00:05:18 +0100"  >&lt;p&gt;also, we can fix the issue Shai brought up for the 3.1 VOTE while we are here.&lt;/p&gt;

&lt;p&gt;in seek(long pos) i think we should do:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
 ...
 position()
 ...
} &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalArgumentException e) {
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (pos &amp;lt; 0) 
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; exc;
  &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; 
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IOException(&lt;span class=&quot;code-quote&quot;&gt;&quot;read past EOF&quot;&lt;/span&gt;); 
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This would be more consistent with NIOFS/SimpleFS from an exception perspective.&lt;/p&gt;</comment>
                    <comment id="13048921" author="thetaphi" created="Tue, 14 Jun 2011 01:54:37 +0100"  >&lt;p&gt;Here the patch.&lt;/p&gt;</comment>
                    <comment id="13048923" author="rcmuir" created="Tue, 14 Jun 2011 02:02:22 +0100"  >&lt;p&gt;at a glance the patch is looking really good overall! I&apos;ll help with some review and testing.&lt;/p&gt;</comment>
                    <comment id="13048951" author="rcmuir" created="Tue, 14 Jun 2011 03:06:45 +0100"  >&lt;p&gt;here are some additional stress tests for mmap&lt;/p&gt;</comment>
                    <comment id="13048952" author="thetaphi" created="Tue, 14 Jun 2011 03:15:53 +0100"  >&lt;p&gt;New patch with some minor issues fixed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed the RuntimeException&lt;/li&gt;
	&lt;li&gt;fixed readByte to throw EOF if we are at the end of the n-1 th buffer. as buffer n may be size 0, we will throw BufferUnderFlow in the chatch block. I added hasRemaining() there, so its consistent with readBytes.&lt;/li&gt;
	&lt;li&gt;The check for an invalid power was bogus (0 is allowed, leads to buffer size 1)&lt;/li&gt;
	&lt;li&gt;The check for RandomAccessFile too big for maximum buffer size did not respect the additional buffer. nrBuffers can then overflow easily&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13048955" author="thetaphi" created="Tue, 14 Jun 2011 03:20:47 +0100"  >&lt;p&gt;Same patch with Robert&apos;s tests included.&lt;/p&gt;</comment>
                    <comment id="13048958" author="rcmuir" created="Tue, 14 Jun 2011 03:26:49 +0100"  >&lt;p&gt;same as uwe&apos;s patch, but i also nuked the previous hack in TestTermVectorsReader, as MMapDir returns read past EOF now like the others.&lt;/p&gt;</comment>
                    <comment id="13049053" author="thetaphi" created="Tue, 14 Jun 2011 09:12:32 +0100"  >&lt;p&gt;Little cleanups &amp;amp; improvements:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;made readByte() consistent with readBytes() &lt;span class=&quot;error&quot;&gt;&amp;#91;catch block using remaining-while loop for size=0 buffers&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;renamed field names and variables to use chunkSize consistently&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think it&apos;s ready to commit, we should only wait for Mike to check on beast.&lt;/p&gt;</comment>
                    <comment id="13049115" author="mikemccand" created="Tue, 14 Jun 2011 11:49:03 +0100"  >&lt;p&gt;+1 to commit!&lt;/p&gt;

&lt;p&gt;In my stress NRT test (runs optimize on a full Wiki index with ongoing&lt;br/&gt;
indexing / reopening), without this patch, I see performance drop&lt;br/&gt;
substantially (like 180 QPS down to 140 QPS) when the JVM cuts over to&lt;br/&gt;
the optimized segment.  With the patch I see it jump up a bit after&lt;br/&gt;
the optimize completes!  So this seems to make hotspot&apos;s job&lt;br/&gt;
easier...&lt;/p&gt;</comment>
                    <comment id="13049117" author="rcmuir" created="Tue, 14 Jun 2011 11:53:12 +0100"  >&lt;p&gt;+1, great work Uwe.&lt;/p&gt;</comment>
                    <comment id="13049154" author="simonw" created="Tue, 14 Jun 2011 13:29:14 +0100"  >&lt;p&gt;+1 this looks awesome. Gute Arbeit Uwe &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13049165" author="thetaphi" created="Tue, 14 Jun 2011 13:55:49 +0100"  >&lt;p&gt;Committed trunk revision: 1135537&lt;br/&gt;
Committed 3.x revision: 1135538&lt;/p&gt;</comment>
                    <comment id="13049166" author="thetaphi" created="Tue, 14 Jun 2011 13:57:39 +0100"  >&lt;p&gt;Thanks to Robert for help debugging my stupid + vs | problem and lots of fruitful discussions about the whole stuff and how to improve &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Thanks to Mike for testing on beast!&lt;/p&gt;

&lt;p&gt;Now you can refactor CFSIndexInput &amp;amp; Co!&lt;/p&gt;</comment>
                    <comment id="13058920" author="rcmuir" created="Sat, 2 Jul 2011 03:40:14 +0100"  >&lt;p&gt;bulk close for 3.3&lt;/p&gt;</comment>
                    <comment id="13155404" author="thetaphi" created="Tue, 22 Nov 2011 20:20:46 +0000"  >&lt;p&gt;MMapDirectory missed a explicit nulling of curBuf, commited trunk revision: 1205152, 3x in revision: 1205153&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12482527" name="LUCENE-3200.patch" size="16246" author="thetaphi" created="Tue, 14 Jun 2011 09:12:32 +0100" />
                    <attachment id="12482510" name="LUCENE-3200.patch" size="15460" author="rcmuir" created="Tue, 14 Jun 2011 03:26:49 +0100" />
                    <attachment id="12482509" name="LUCENE-3200.patch" size="14654" author="thetaphi" created="Tue, 14 Jun 2011 03:20:47 +0100" />
                    <attachment id="12482508" name="LUCENE-3200.patch" size="10480" author="thetaphi" created="Tue, 14 Jun 2011 03:15:53 +0100" />
                    <attachment id="12482501" name="LUCENE-3200.patch" size="10095" author="thetaphi" created="Tue, 14 Jun 2011 01:54:37 +0100" />
                    <attachment id="12482507" name="LUCENE-3200_tests.patch" size="4167" author="rcmuir" created="Tue, 14 Jun 2011 03:06:45 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 13 Jun 2011 23:05:18 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2093</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24497</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>