<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 12:57:57 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3690/LUCENE-3690.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3690] JFlex-based HTMLStripCharFilter replacement</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3690</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;A JFlex-based HTMLStripCharFilter replacement would be more performant and easier to understand and maintain.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12538152">LUCENE-3690</key>
            <summary>JFlex-based HTMLStripCharFilter replacement</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="steve_rowe">Steve Rowe</assignee>
                                <reporter username="steve_rowe">Steve Rowe</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Jan 2012 05:36:06 +0000</created>
                <updated>Fri, 10 May 2013 11:43:40 +0100</updated>
                    <resolved>Tue, 24 Jan 2012 15:53:45 +0000</resolved>
                            <version>3.5</version>
                <version>4.0-ALPHA</version>
                                <fixVersion>3.6</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/analysis</component>
                        <due></due>
                    <votes>3</votes>
                        <watches>2</watches>
                                                    <comments>
                    <comment id="13184740" author="steve_rowe" created="Thu, 12 Jan 2012 05:40:03 +0000"  >&lt;p&gt;Patch implementing the idea.&lt;/p&gt;

&lt;p&gt;This patch just creates a new class named &lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt;.  All of the &lt;tt&gt;HTMLStripCharFilterTest&lt;/tt&gt; tests are copied over to &lt;tt&gt;JFlexHTMLStripCharFilterTest&lt;/tt&gt;; Robert&apos;s random test is un-&lt;tt&gt;@Ignore&lt;/tt&gt;&apos;d, and several more tests are added.&lt;/p&gt;</comment>
                    <comment id="13184745" author="steve_rowe" created="Thu, 12 Jan 2012 06:04:30 +0000"  >&lt;p&gt;Left to do:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Accept supplementary characters in HTML tag names.&lt;/li&gt;
	&lt;li&gt;Recognize uppercase character entity variants for &quot;quot&quot;, &quot;copy&quot;, &quot;gt&quot;, &quot;lt&quot;, &quot;reg&quot;, and &quot;amp&quot; (from Dawid Weiss&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-882&quot; title=&quot;HTMLStripReader improvement - padding corrected for hexadecimal entities, option not to emit padding at all added&quot;&gt;&lt;del&gt;SOLR-882&lt;/del&gt;&lt;/a&gt; patch)&lt;/li&gt;
	&lt;li&gt;Rename current &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; to &lt;tt&gt;ClassicHTMLStripCharFilter&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Rename &lt;tt&gt;JFlexStripCharFilter&lt;/tt&gt; to &lt;tt&gt;HTMLStripCharFilterImpl&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Make a back-compat-enabling wrapper class (like &lt;tt&gt;StandardTokenizer&lt;/tt&gt;) that will use &lt;tt&gt;ClassicHTMLStripCharFilter&lt;/tt&gt; for Version.LUCENE_35 and earlier, and &lt;tt&gt;HTMLStripCharFilterImpl&lt;/tt&gt; otherwise.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This would be the first back-compat enabled CharFilter.  Should the existing HTMLStripCharFilter instead vanish off the face of the earth?&lt;/p&gt;</comment>
                    <comment id="13184746" author="steve_rowe" created="Thu, 12 Jan 2012 06:08:23 +0000"  >&lt;p&gt;This JFlex-based &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; replacement will fix &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2208&quot; title=&quot;Token div exceeds length of provided text sized 4114&quot;&gt;&lt;del&gt;LUCENE-2208&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="13184749" author="steve_rowe" created="Thu, 12 Jan 2012 06:14:00 +0000"  >&lt;p&gt;One other thing left to do: I added javadocs to &lt;tt&gt;BaseCharFilter.addOffCorrectMap()&lt;/tt&gt;, but I think they should be moved to the package javadocs for &lt;tt&gt;o.a.l.analysis.charfilter&lt;/tt&gt;, and maybe add some examples.  (This package has basically zero documentation currently.)&lt;/p&gt;</comment>
                    <comment id="13184773" author="steve_rowe" created="Thu, 12 Jan 2012 07:00:17 +0000"  >&lt;p&gt;Added a &lt;tt&gt;&amp;lt;![CDATA[...]]&amp;gt;&lt;/tt&gt; section test, and fixed the CDATA section handling.&lt;/p&gt;</comment>
                    <comment id="13184889" author="rcmuir" created="Thu, 12 Jan 2012 12:30:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Robert&apos;s random test is un-@Ignore&apos;d&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1!&lt;/p&gt;
</comment>
                    <comment id="13184890" author="brianmeidell" created="Thu, 12 Jan 2012 12:37:10 +0000"  >&lt;p&gt;Any idea how quickly this will be rolled into a new version?&lt;/p&gt;</comment>
                    <comment id="13184904" author="rcmuir" created="Thu, 12 Jan 2012 12:45:15 +0000"  >&lt;blockquote&gt;
&lt;p&gt;This would be the first back-compat enabled CharFilter. Should the existing HTMLStripCharFilter instead vanish off the face of the earth?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What would be the motivation? Are there some features of the previous one that don&apos;t make sense in this implementation?&lt;br/&gt;
I don&apos;t think fixing offsets bugs like &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2208&quot; title=&quot;Token div exceeds length of provided text sized 4114&quot;&gt;&lt;del&gt;LUCENE-2208&lt;/del&gt;&lt;/a&gt; counts as breaking index backwards compat, because it won&apos;t change search results.&lt;br/&gt;
It will just prevent highlighters from throwing exceptions.&lt;/p&gt;

&lt;p&gt;(&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3642&quot; title=&quot;EdgeNgrams creates invalid offsets&quot;&gt;&lt;del&gt;LUCENE-3642&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3668&quot; title=&quot;offsets issues with multiword synonyms&quot;&gt;&lt;del&gt;LUCENE-3668&lt;/del&gt;&lt;/a&gt; fixed lots of offset bugs already, we didn&apos;t spend time on any back compat).&lt;/p&gt;</comment>
                    <comment id="13184914" author="rcmuir" created="Thu, 12 Jan 2012 12:47:12 +0000"  >&lt;p&gt;Also I don&apos;t know how Version etc would work here, since the old HtmlStripCharFilter was never part of lucene.&lt;/p&gt;

&lt;p&gt;from lucene&apos;s perspective, its a new feature.&lt;/p&gt;</comment>
                    <comment id="13184969" author="steve_rowe" created="Thu, 12 Jan 2012 13:55:51 +0000"  >&lt;p&gt;Here&apos;s another to-do, from &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-42?focusedCommentId=12625835&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-12625835&quot; class=&quot;external-link&quot;&gt;comment-12625835 in SOLR-42&lt;/a&gt;: handle MS-Word-generated broken processing instructions &lt;tt&gt;&amp;lt;? ... /&amp;gt;&lt;/tt&gt; (instead of &lt;tt&gt;&amp;lt;? ... ?&amp;gt;&lt;/tt&gt;.&lt;/p&gt;</comment>
                    <comment id="13184983" author="steve_rowe" created="Thu, 12 Jan 2012 14:19:07 +0000"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;This would be the first back-compat enabled CharFilter.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What would be the motivation?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There are differences in the behavior, but I guess all of these could be characterized as bug fixes:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Supplementary characters in tags will be recognized.  The old version doesn&apos;t do this.&lt;/li&gt;
	&lt;li&gt;CDATA sections are recognized.  The old version doesn&apos;t; people have requested this, e.g. &lt;a href=&quot;http://www.lucidimagination.com/search/document/48fcd906e39764ec#48fcd906e39764ec&quot; class=&quot;external-link&quot;&gt;http://www.lucidimagination.com/search/document/48fcd906e39764ec#48fcd906e39764ec&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;No space is substituted for inline tags (e.g. &lt;tt&gt;&amp;lt;b&amp;gt;&lt;/tt&gt;, &lt;tt&gt;&amp;lt;i&amp;gt;&lt;/tt&gt;, &lt;tt&gt;&amp;lt;span&amp;gt;&lt;/tt&gt;).  The old version substitutes spaces for all tags; people have complained e.g. &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1343?focusedCommentId=13096839&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13096839&quot; class=&quot;external-link&quot;&gt;on SOLR-1343&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Broken MS-Word-generated processing instructions &lt;tt&gt;&amp;lt;? ... /&amp;gt;&lt;/tt&gt; will be handled.&lt;/li&gt;
	&lt;li&gt;Uppercase character entities &quot;quot&quot;, &quot;copy&quot;, &quot;gt&quot;, &quot;lt&quot;, &quot;reg&quot;, and &quot;amp&quot; will be recognized (from Dawid Weiss&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-882&quot; title=&quot;HTMLStripReader improvement - padding corrected for hexadecimal entities, option not to emit padding at all added&quot;&gt;&lt;del&gt;SOLR-882&lt;/del&gt;&lt;/a&gt; patch); the old version doesn&apos;t do this.&lt;/li&gt;
&lt;/ol&gt;


&lt;blockquote&gt;&lt;p&gt;Are there some features of the previous one that don&apos;t make sense in this implementation?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, not as far as I can tell.  I think all features of the previous one are included.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also I don&apos;t know how Version etc would work here, since the old HtmlStripCharFilter was never part of lucene.  from lucene&apos;s perspective, its a new feature.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point.  Should I make it a new Lucene feature on 3.X?  That is, should I remove Solr&apos;s HTMLStripCharFilter and have it refer to a new Lucene HTMLStripCharFilter?&lt;/p&gt;</comment>
                    <comment id="13184985" author="steve_rowe" created="Thu, 12 Jan 2012 14:24:03 +0000"  >&lt;p&gt;AFAICT, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2891&quot; title=&quot;InvalidTokenOffsetsException when using MappingCharFilterFactory, DictionaryCompoundWordTokenFilterFactory and Highlighting&quot;&gt;&lt;del&gt;SOLR-2891&lt;/del&gt;&lt;/a&gt; will be fixed by this implementation.&lt;/p&gt;</comment>
                    <comment id="13184986" author="rcmuir" created="Thu, 12 Jan 2012 14:24:37 +0000"  >&lt;blockquote&gt;
&lt;p&gt;There are differences in the behavior, but I guess all of these could be characterized as bug fixes:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This sounds awesome!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Good point. Should I make it a new Lucene feature on 3.X? That is, should I remove Solr&apos;s HTMLStripCharFilter and have it refer to a new Lucene HTMLStripCharFilter?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think so.&lt;/p&gt;

&lt;p&gt;If you want to, you can make it package-private + deprecated inside o.a.solr.analysis. The Solr factory could respect&lt;br/&gt;
the luceneMatchVersion parameter for backwards compatibility, and instantiate the old version in that case.&lt;/p&gt;

&lt;p&gt;So you would then move the old charfilter from modules/analysis to the same place in trunk, too... its purely a solr&lt;br/&gt;
back-compat issue. For lucene users its just a new feature and they don&apos;t see any of this.&lt;/p&gt;

&lt;p&gt;This is what we did with Synonyms.&lt;/p&gt;</comment>
                    <comment id="13185759" author="steve_rowe" created="Fri, 13 Jan 2012 19:04:11 +0000"  >&lt;p&gt;This patch contains a feature-complete version.  Changes from the previous patch:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Now substituting newlines instead of spaces for block-level elements; this corresponds more closely to on-screen layout, enables sentence segmentation, and doesn&apos;t change offsets.&lt;/li&gt;
	&lt;li&gt;Supplementary characters are now accepted in tags.&lt;/li&gt;
	&lt;li&gt;Switched accepted tag names from &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;:XID_Start:&amp;#93;&lt;/span&gt;&lt;/tt&gt; and &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;:XID_Continue:&amp;#93;&lt;/span&gt;&lt;/tt&gt; Unicode properties to the more relaxed &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;:ID_Start:&amp;#93;&lt;/span&gt;&lt;/tt&gt; and &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;:ID_Continue:&amp;#93;&lt;/span&gt;&lt;/tt&gt; properties, in order to broaden the range of recognizable input.  (The improved security afforded by the &lt;tt&gt;XID_*&lt;/tt&gt; properties is irrelevant to what a &lt;tt&gt;CharFilter&lt;/tt&gt; does.)&lt;/li&gt;
	&lt;li&gt;Uppercase character entity variants for &quot;quot&quot;, &quot;copy&quot;, &quot;gt&quot;, &quot;lt&quot;, &quot;reg&quot;, and &quot;amp&quot; (from Dawid Weiss&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-882&quot; title=&quot;HTMLStripReader improvement - padding corrected for hexadecimal entities, option not to emit padding at all added&quot;&gt;&lt;del&gt;SOLR-882&lt;/del&gt;&lt;/a&gt; patch) are now accepted.&lt;/li&gt;
	&lt;li&gt;MS-Word-generated broken processing instructions (&lt;tt&gt;&amp;lt;? ... /&amp;gt;&lt;/tt&gt; instead of &lt;tt&gt;&amp;lt;? ... ?&amp;gt;&lt;/tt&gt;) are now accepted.&lt;/li&gt;
	&lt;li&gt;Added several tests, including parsing a full MS-Word-2010-generated HTML file.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Left to do:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Move javadocs from &lt;tt&gt;BaseCharFilter.addOffCorrectMap()&lt;/tt&gt; to &lt;tt&gt;o.a.l.analysis.charfilter&lt;/tt&gt; package level javadoc file.&lt;/li&gt;
	&lt;li&gt;Rename the existing &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; to &lt;tt&gt;ClassicHTMLStripCharFilter&lt;/tt&gt;; move it to Solr &lt;tt&gt;o.a.s.analysis&lt;/tt&gt; package; deprecate it; and make it package private.&lt;/li&gt;
	&lt;li&gt;Rename &lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt; to &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Enable Solr back-compat (but not Lucene back-compat, since &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; has never been released as part of Lucene) by making &lt;tt&gt;HTMLStripCharFilterFactory&lt;/tt&gt; instantiate &lt;tt&gt;ClassicHTMLStripCharFilter&lt;/tt&gt; if the &lt;tt&gt;luceneMatchVersion&lt;/tt&gt; parameter is &lt;tt&gt;LUCENE_35&lt;/tt&gt; or earlier, and otherwise instantiate the new &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    <comment id="13185771" author="steve_rowe" created="Fri, 13 Jan 2012 19:18:54 +0000"  >&lt;p&gt;Forgot to mention two more change in the latest patch from the previous version: &lt;/p&gt;

&lt;p&gt;7. The generated scanner&apos;s parse method now returns the next available character if one is available; this simplifies/clarifies the processing flow. (Previously the parse method returned an enum indicating whether to copy a char directly from the input buffer &amp;#8211; &lt;tt&gt;OutputSource.DIRECT&lt;/tt&gt; &amp;#8211; or from another location &amp;#8211; &lt;tt&gt;OutputSource.INDIRECT&lt;/tt&gt; &amp;#8211; the &lt;tt&gt;read()&lt;/tt&gt; method would then have to go fetch the next character from the given source.)&lt;br/&gt;
8. Renamed the generated scanner&apos;s parse method from the default &lt;tt&gt;yylex()&lt;/tt&gt; to &lt;tt&gt;nextChar()&lt;/tt&gt;.&lt;/p&gt;</comment>
                    <comment id="13185789" author="hossman" created="Fri, 13 Jan 2012 19:35:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think fixing offsets bugs like &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2208&quot; title=&quot;Token div exceeds length of provided text sized 4114&quot;&gt;&lt;del&gt;LUCENE-2208&lt;/del&gt;&lt;/a&gt; counts as breaking index backwards compat, because it won&apos;t change search results.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;It will just prevent highlighters from throwing exceptions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;FWIW: If i understand the issue correctly, then the one risk i can imagine here is that people don&apos;t reindex, and get the new behavior for new docs, so they&apos;ll get diff behavior are query time depending on when the doc is re-indexed.  that seems significant enough to definitely warrant the luceneMatchVersion toggle sarowe has on his todo list &amp;#8211; which seems fairly straight forward.&lt;/p&gt;

&lt;p&gt;The only concern i really have is...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A JFlex-based HTMLStripCharFilter replacement would be more performant...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;..before deprecating &quot;ClassicHTMLStripCharFilter&quot; we should actually test that the Jlex version is faster ... because if it winds up being noticible slower in some cases, some people may prefer the the &quot;classic&quot; mode to the JFlex mode if the &quot;warts&quot; of the existing one don&apos;t affect them &amp;#8211; in which case i might almost suggest actually using multiple factories in solr instead of making it versionMatch dependent.  &lt;/p&gt;

&lt;p&gt;(fingers crossed it&apos;s a non-issue)&lt;/p&gt;</comment>
                    <comment id="13185793" author="yseeley@gmail.com" created="Fri, 13 Jan 2012 19:41:32 +0000"  >&lt;p&gt;Let&apos;s be conservative and keep around HTMLStripCharFilter, and name this one something else?&lt;br/&gt;
The original was meant to handle all sorts of bad, partial, and weird input.&lt;br/&gt;
Or are we really confident that this implementation handles everything the current one does?&lt;/p&gt;</comment>
                    <comment id="13185795" author="rcmuir" created="Fri, 13 Jan 2012 19:44:43 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Let&apos;s be conservative and keep around HTMLStripCharFilter, and name this one something else?&lt;br/&gt;
The original was meant to handle all sorts of bad, partial, and weird input.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I call bullshit. It fails on all kinds of bad/partial/and weird input.&lt;/p&gt;

&lt;p&gt;In fact ill go remove my @Ignore now. Lets see if anyone can fix the bugs in it. That should settle this.&lt;/p&gt;</comment>
                    <comment id="13185796" author="steve_rowe" created="Fri, 13 Jan 2012 19:47:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;are we really confident that this implementation handles everything the current one does?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, this implementation&apos;s bad/partial/weird HTML handling capabilities are a superset of the current implementation.  The tests for the new implementation are a superset of the old implementation&apos;s tests.&lt;/p&gt;

&lt;p&gt;I welcome more examples of junk HTML to add to the tests &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13185797" author="steve_rowe" created="Fri, 13 Jan 2012 19:50:30 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The only concern i really have is...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A JFlex-based HTMLStripCharFilter replacement would be more performant...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;..before deprecating &quot;ClassicHTMLStripCharFilter&quot; we should actually test that the Jlex version is faster ... &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1.  I&apos;ll do this before committing anything.&lt;/p&gt;</comment>
                    <comment id="13185799" author="dweiss" created="Fri, 13 Jan 2012 19:52:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;I welcome more examples of junk HTML to add to the tests &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Julien Nioche (Nutch) may have access to realistic large HTML crawls... there&apos;s nothing wilder and weirder than real-life HTML &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13185810" author="hossman" created="Fri, 13 Jan 2012 20:06:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;+1.  I&apos;ll do this before committing anything.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;i wouldn&apos;t be shy about committing the new impl + tests, i would just wait to change the solr factory default behavior until we prove the perf is as good as the existing one in some common cases, and if it&apos;s not, then re-evaluate the names of the classes.&lt;/p&gt;

&lt;p&gt;and by common cases i&apos;m thinking...&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;some test docs using typical wellformed html markup&lt;/li&gt;
	&lt;li&gt;some test docs using malformed markup that require backtracking&lt;/li&gt;
	&lt;li&gt;some test docs that contain almost no HTML at all (this is the one that i have a hunch may be a big differentiator &amp;#8211; i&apos;ve seen lots of people who use the HTML stripper not becuase they expect HTML, but because they want to be sure it doesn&apos;t get indexed if some stray html encoding sneaks into their data)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13185811" author="yseeley@gmail.com" created="Fri, 13 Jan 2012 20:07:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;The tests for the new implementation are a superset of the old implementation&apos;s tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Unfortunately I&apos;m not sure how much of a story the tests tell (and yes, that would be my fault &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
My memory is rusty, but back in &apos;05 when I coded this thing, I threw a lot stuff we had lying around CNET at it, and also a lot of stuff downloaded from the web (which I couldn&apos;t just copy-n-paste into a unit test obviously).  I had a heck of a time handling all the weird stuff that could appear inside script tags, for example, and I don&apos;t think I see much of a test for that (again... my fault.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I welcome more examples of junk HTML to add to the tests&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not saying the new one isn&apos;t great (and matching a lot of crap from the old one is quite an achievement).&lt;br/&gt;
One can be sure that the current implementation doesn&apos;t always do the right thing, but unfortunately &quot;right&quot; isn&apos;t well defined here considering the domain.&lt;br/&gt;
The cost to keeping around the current version for a little while seems minimal.&lt;/p&gt;</comment>
                    <comment id="13185831" author="steve_rowe" created="Fri, 13 Jan 2012 20:34:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;I had a heck of a time handling all the weird stuff that could appear inside script tags, for example, and I don&apos;t think I see much of a test for that (again... my fault.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I added tests with the following snippets:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;one&amp;lt;script&amp;gt;&amp;lt;!-- &amp;lt;!--#config comment=&quot;&amp;lt;!-- \&quot;comment\&quot;--&amp;gt;&quot;--&amp;gt; --&amp;gt;&amp;lt;/script&amp;gt;two

=&amp;gt; &apos;one
two&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;one&amp;lt;script attr= bare&amp;gt;&amp;lt;!-- action(&apos;&amp;lt;!-- comment --&amp;gt;&apos;, &quot;\&quot;--&amp;gt;\&quot;&quot;); --&amp;gt;&amp;lt;/script&amp;gt;two

=&amp;gt; &apos;one
two&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;hello&amp;lt;script&amp;gt;&amp;lt;!-- f(&apos;&amp;lt;!--internal--&amp;gt;&amp;lt;/script&amp;gt;&apos;); --&amp;gt;&amp;lt;/script&amp;gt;

=&amp;gt; &apos;hello
&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;One can be sure that the current implementation doesn&apos;t always do the right thing, but unfortunately &quot;right&quot; isn&apos;t well defined here considering the domain.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree - the &quot;right&quot; thing IMHO is: get as much content from as varied a range of sources as possible, and never ever allow the input to bork processing.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The cost to keeping around the current version for a little while seems minimal.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My proposal would do this, though under a different name, and requiring a luceneMatchVersion of 3.5 or earlier for the factory to use it.  Do you object to this?  &lt;/p&gt;

&lt;p&gt;I have two issues with not switching over now:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It&apos;s a chicken and egg problem: how will people know if there is a problem with the new implementation if they don&apos;t use it?&lt;/li&gt;
	&lt;li&gt;The current version has several long standing bugs that nobody has fixed.  I personally wouldn&apos;t attempt it with the current implementation: it&apos;s difficult to understand.  This is one of my main motivations for making this new version: when people find issues, fixing them should be much easier with the new implementation.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    <comment id="13185855" author="steve_rowe" created="Fri, 13 Jan 2012 21:10:00 +0000"  >&lt;p&gt;From &lt;a href=&quot;http://colabti.org/irclogger/irclogger_log/lucene-dev?date=2012-01-13#l130&quot; class=&quot;external-link&quot;&gt;#lucene-dev IRC&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;yonik_:	sarowe: if we change the name of the current html strip stuff, it seems like doing anything with luceneMatchVersion isn&apos;t needed (or overkill?)&lt;/p&gt;

&lt;p&gt;sarowe:	but then people will need to take action to use the (non-broken) new impl&lt;br/&gt;
        me no likey&lt;/p&gt;

&lt;p&gt;yonik_:	but if the name is changed, they won&apos;t use it by accident&lt;/p&gt;

&lt;p&gt;sarowe:	oh, you mean: don&apos;t even attempt back-compat - just provide the ability to use the previous implementation&lt;/p&gt;

&lt;p&gt;yonik_:	yeah&lt;/p&gt;

&lt;p&gt;sarowe:	via a new/different name&lt;br/&gt;
        I&apos;m definitely okay with that&lt;/p&gt;&lt;/blockquote&gt;</comment>
                    <comment id="13185904" author="yseeley@gmail.com" created="Fri, 13 Jan 2012 22:09:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;In fact ill go remove my @Ignore now. Lets see if anyone can fix the bugs in it. That should settle this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see you&apos;ve done this.  Purposely breaking the build really isn&apos;t necessary to make a point about a known bug.&lt;/p&gt;</comment>
                    <comment id="13185917" author="hossman" created="Fri, 13 Jan 2012 22:22:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;sarowe: oh, you mean: don&apos;t even attempt back-compat - just provide the ability to use the previous implementation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;right, this is what we did with DateField a while back, note the CHANGES.txt entry on r658003.  now that we have luceneMatchVersion though i kind of go back and forth on when to use it to pick an impl vs when to do stuff like this. dealers choice...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=658003&quot; class=&quot;external-link&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=658003&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="13186005" author="steve_rowe" created="Sat, 14 Jan 2012 00:04:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;some test docs using malformed markup that require backtracking&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I set up a quick test for this in both of the test classes using output from the synthetic broken HTML generator &lt;tt&gt;o.a.l.util._TestUtil.randomHtmlishString()&lt;/tt&gt; and ran 100K iterations of it - here&apos;s the HTMLStripCharFilterTest version:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testRandomBrokenHTML() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxNumElements = 10000;
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; text = _TestUtil.randomHtmlishString(random, maxNumElements);
    Reader reader
        = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HTMLStripCharFilter(CharReader.get(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(text)));
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (reader.read() != -1);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Best/worst of 5 (as reported by Ant for the individual test, rather than for the entire Ant invocation):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;: best: 73.4 sec, worst: 76.5 sec&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt;: best: 73.5 sec, worst: 76.0 sec&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m going to increase the evilness of &lt;tt&gt;_TestUtil.randomHtmlishString()&lt;/tt&gt; and re-run to see if the numbers shift.&lt;/p&gt;</comment>
                    <comment id="13186123" author="steve_rowe" created="Sat, 14 Jan 2012 07:10:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m going to increase the evilness of &lt;tt&gt;_TestUtil.randomHtmlishString()&lt;/tt&gt; and re-run to see if the numbers shift.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did this, and it uncovered a bug in handling of Server Side Includes in &lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt; - hooray for evil tests.&lt;/p&gt;

&lt;p&gt;The timings, this time for 10K iterations:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;: best: 48.6 sec, worst: 49.7 sec&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt;: best: 15.5 sec, worst: 17.3 sec&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13186127" author="steve_rowe" created="Sat, 14 Jan 2012 07:24:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;some test docs that contain almost no HTML at all&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I used the following to test the zero-markup case in both test classes (the &lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt; version is given below):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testRandomText() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    StringBuilder text = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minNumWords = 10;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxNumWords = 10000;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minWordLength = 3;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxWordLength = 20;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numWords = _TestUtil.nextInt(random, minNumWords, maxNumWords);
    &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; (_TestUtil.nextInt(random, 0, 4)) {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; 0: {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; wordNum = 0 ; wordNum &amp;lt; numWords ; ++wordNum) {
          text.append(_TestUtil.randomUnicodeString(random, maxWordLength));
          text.append(&apos; &apos;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; 1: {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; wordNum = 0 ; wordNum &amp;lt; numWords ; ++wordNum) {
          text.append(_TestUtil.randomRealisticUnicodeString
              (random, minWordLength, maxWordLength));
          text.append(&apos; &apos;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
      }
      &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;: { &lt;span class=&quot;code-comment&quot;&gt;// ASCII 50% of the time
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; wordNum = 0 ; wordNum &amp;lt; numWords ; ++wordNum) {
          text.append(_TestUtil.randomSimpleString(random));
          text.append(&apos; &apos;);
        }
      }
    }
    Reader reader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JFlexHTMLStripCharFilter
        (CharReader.get(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringReader(text.toString())));
    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (reader.read() != -1);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The results for 10K iterations (best/worst of 5):&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;: best: 23.7 sec, worst: 24.8 sec&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt;: best: 22.0 sec, worst: 24.7 sec&lt;/li&gt;
&lt;/ul&gt;

</comment>
                    <comment id="13186818" author="steve_rowe" created="Mon, 16 Jan 2012 09:45:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;some test docs using typical wellformed html markup&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have access to &lt;a href=&quot;http://lemurproject.org/clueweb09.php&quot; class=&quot;external-link&quot;&gt;ClueWeb09&lt;/a&gt;.  For performance testing I used the first WARC file for the English and Chinese languages (&lt;tt&gt;en0000/00.warc.gz&lt;/tt&gt; and &lt;tt&gt;zh0000/00.warc.gz&lt;/tt&gt;), each of which when uncompressed contains about 1GB of text (including a small amount of non-HTML metadata: WARC information and HTTP headers).  The English WARC contains about 35,000 documents from about 2,100 unique domains.  The Chinese WARC contains about 33,000 documents from about 550 unique domains.&lt;/p&gt;

&lt;p&gt;I compared &lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt;&apos;s output with that of &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; for several hundred documents.  In the course of this comparison, I found several problems with the JFlex implementation (e.g. no &lt;tt&gt;&amp;lt;STYLE&amp;gt;&lt;/tt&gt; tag handling; no MS conditional tag handling, e.g. &lt;tt&gt;&amp;lt;![if ! IE]&amp;gt;&lt;/tt&gt;; and some problems handling creative attribute values), which the attached patch fixes.  I re-ran the text-only and malformed HTML performance tests on the final implementation, and the numbers aren&apos;t significantly different from those prior to these fixes.  The new patch also contains the more-evil &lt;tt&gt;_TestUtils.randomHtmlishString()&lt;/tt&gt;;  shifts the &lt;tt&gt;CharFilter&lt;/tt&gt; javadocs from &lt;tt&gt;BaseCharFilter.addOffCorrectMapping()&lt;/tt&gt; to &lt;tt&gt;package.html&lt;/tt&gt;; and adds several more tests to &lt;tt&gt;JFlexHTMLStripCharFilterTest.java&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have attached the three classes I used to test performance over the ClueWeb09 subset.  &lt;tt&gt;BaselineWarcTest.java&lt;/tt&gt; uses &lt;a href=&quot;http://boston.lti.cs.cmu.edu/clueweb09/wiki/tiki-index.php?page=Working+with+WARC+Files&quot; class=&quot;external-link&quot;&gt;the WarcRecord class supplied with the ClueWeb09 collection&lt;/a&gt; to read the compressed WARC files; looks for a declared charset first in each document&apos;s content in the Content-Type &lt;tt&gt;&amp;lt;meta&amp;gt;&lt;/tt&gt; tag, and then in the HTTP header; feeds this charset, if any, to the ICU4J charset detector, which instantiates a Reader using the detected charset; and then &lt;tt&gt;read()&apos;s&lt;/tt&gt; all content.  The other two classes add the respective CharFilter on top of &lt;tt&gt;BaselineWarcTest&lt;/tt&gt;&apos;s functionality.&lt;/p&gt;

&lt;p&gt;The performance numbers (best of 5 trials):&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Language&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Baseline&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Classic&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;JFlex&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;English&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;156s&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;179s&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;171s&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Chinese&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;155s&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;180s&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;172s&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Excluding charset detection and I/O (measured by &lt;tt&gt;BaselineWarcTest&lt;/tt&gt;), &lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt; appears to improve on &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;&apos;s throughput by about 50% in both languages.&lt;/p&gt;

&lt;p&gt;I found a few problems with &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The following exception was thrown for six of the English documents:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.io.IOException: Mark invalid
        at java.io.BufferedReader.reset(BufferedReader.java:485)
        at org.apache.lucene.analysis.CharReader.reset(CharReader.java:69)
        at org.apache.lucene.analysis.charfilter.HTMLStripCharFilter.restoreState(HTMLStripCharFilter.java:171)
        at org.apache.lucene.analysis.charfilter.HTMLStripCharFilter.read(HTMLStripCharFilter.java:734)
        at HTMLStripCharFilterWarcTest.main(HTMLStripCharFilterWarcTest.java:86)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;&amp;amp;apos;&lt;/tt&gt; is not decoded.&lt;/li&gt;
	&lt;li&gt;Content between some &amp;lt;script&amp;gt; tags is not stripped out.&lt;/li&gt;
	&lt;li&gt;Unbalanced quotation marks in opening tags cause the tag to not be stripped out.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Left to do:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Rename &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; to &lt;tt&gt;ClassicHTMLStripCharFilter&lt;/tt&gt;; move it to Solr &lt;tt&gt;o.a.s.analysis&lt;/tt&gt; package; deprecate it; and create a new Solr Factory for it.&lt;/li&gt;
	&lt;li&gt;Rename JFlexHTMLStripCharFilter to HTMLStripCharFilter.&lt;/li&gt;
	&lt;li&gt;Commit to trunk&lt;/li&gt;
	&lt;li&gt;Backport and commit to branch_3x.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    <comment id="13187301" author="hossman" created="Mon, 16 Jan 2012 23:27:15 +0000"  >&lt;p&gt;+1 ... to everything.&lt;/p&gt;</comment>
                    <comment id="13190588" author="steve_rowe" created="Sun, 22 Jan 2012 02:56:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;AFAICT, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2891&quot; title=&quot;InvalidTokenOffsetsException when using MappingCharFilterFactory, DictionaryCompoundWordTokenFilterFactory and Highlighting&quot;&gt;&lt;del&gt;SOLR-2891&lt;/del&gt;&lt;/a&gt; will be fixed by this implementation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I misspoke, having misread that issue - despite the reference to &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; in the most recent comment on the issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2891&quot; title=&quot;InvalidTokenOffsetsException when using MappingCharFilterFactory, DictionaryCompoundWordTokenFilterFactory and Highlighting&quot;&gt;&lt;del&gt;SOLR-2891&lt;/del&gt;&lt;/a&gt; is not about &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;.&lt;/p&gt;</comment>
                    <comment id="13190609" author="steve_rowe" created="Sun, 22 Jan 2012 05:17:32 +0000"  >&lt;p&gt;Here is the final patch.&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;sarowe: oh, you mean: don&apos;t even attempt back-compat - just provide the ability to use the previous implementation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;right, this is what we did with DateField a while back, note the CHANGES.txt entry on r658003. now that we have luceneMatchVersion though i kind of go back and forth on when to use it to pick an impl vs when to do stuff like this. dealers choice...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=658003&quot; class=&quot;external-link&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=658003&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I took the same approach - here are the changes from the previous version of the patch:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The previous &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt; implementation is moved to Solr, renamed to &lt;tt&gt;LegacyHTMLStripCharFilter&lt;/tt&gt;, and deprecated, and a Factory is added for it.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JFlexHTMLStripCharFilter&lt;/tt&gt; is renamed to &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Support for &lt;tt&gt;HTMLStripCharFilter&lt;/tt&gt;&apos;s &quot;escapedTags&quot; functionality is added to &lt;tt&gt;HTMLStripCharFilterFactory&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Added &lt;tt&gt;TestHTMLStripCharFilterFactory&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Solr and Lucene &lt;tt&gt;CHANGES.txt&lt;/tt&gt; entries are added.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Run the following svn copy script before applying the patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;svn cp modules/analysis/common/src/java/org/apache/lucene/analysis/charfilter/HTMLStripCharFilter.java solr/core/src/java/org/apache/solr/analysis/LegacyHTMLStripCharFilter.java
svn cp modules/analysis/common/src/test/org/apache/lucene/analysis/charfilter/htmlStripReaderTest.html solr/core/src/test/org/apache/solr/analysis/
svn cp modules/analysis/common/src/test/org/apache/lucene/analysis/charfilter/HTMLStripCharFilterTest.java solr/core/src/test/org/apache/solr/analysis/LegacyHTMLStripCharFilterTest.java
svn cp solr/core/src/java/org/apache/solr/analysis/HTMLStripCharFilterFactory.java solr/core/src/java/org/apache/solr/analysis/LegacyHTMLStripCharFilterFactory.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I plan to commit to trunk shortly, then backport and commit to branch_3x.&lt;/p&gt;</comment>
                    <comment id="13190701" author="rcmuir" created="Sun, 22 Jan 2012 15:57:40 +0000"  >&lt;p&gt;Here&apos;s a standalone testcase for the fail from jenkins&lt;/p&gt;</comment>
                    <comment id="13190704" author="rcmuir" created="Sun, 22 Jan 2012 16:11:18 +0000"  >&lt;p&gt;By the way: &quot;expected&quot; in that test is wrong. its just the same input string to trigger the assert in MockTokenizer...&lt;/p&gt;</comment>
                    <comment id="13190908" author="steve_rowe" created="Mon, 23 Jan 2012 07:30:12 +0000"  >&lt;p&gt;Patch (excluding the re-generated .java scanner) that addresses the unpaired surrogate numeric character entity failures uncovered by random testing, by outputting REPLACEMENT CHARACTER U+FFFD, and adds the ability to interpret properly paired UTF-16 surrogates as an above-BMP codepoint.  Added tests to cover all four combinations of hex &amp;amp; decimal surrogate numeric character entities in surrogate pairs.&lt;/p&gt;

&lt;p&gt;Also added &lt;tt&gt;@SuppressWarnings(&quot;fallthrough&quot;)&lt;/tt&gt; to the JFlex-generated scanner class, so that the 40+ warnings about switch case fall-throughs don&apos;t clutter the output.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Edit&lt;/b&gt;: committing to trunk shortly.&lt;/p&gt;</comment>
                    <comment id="13190911" author="steve_rowe" created="Mon, 23 Jan 2012 07:43:55 +0000"  >&lt;p&gt;Committed the fixed UTF-16 numeric character reference surrogates handling to trunk in r1234687.&lt;/p&gt;</comment>
                    <comment id="13190913" author="steve_rowe" created="Mon, 23 Jan 2012 07:46:21 +0000"  >&lt;p&gt;Thanks Robert for your help diagnosing and fixing the surrogates problem!&lt;/p&gt;</comment>
                    <comment id="13192223" author="steve_rowe" created="Tue, 24 Jan 2012 15:53:46 +0000"  >&lt;p&gt;Backported to branch_3x.&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310040">
                <name>Required</name>
                                <outwardlinks description="requires">
                            <issuelink>
            <issuekey id="12409216">SOLR-882</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                        <issuelinktype id="12310051">
                <name>Supercedes</name>
                                <outwardlinks description="supercedes">
                            <issuelink>
            <issuekey id="12445424">LUCENE-2208</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12346872">SOLR-42</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12510686" name="BaselineWarcTest.java" size="3486" author="steve_rowe" created="Mon, 16 Jan 2012 09:45:45 +0000" />
                    <attachment id="12510688" name="HTMLStripCharFilterWarcTest.java" size="3707" author="steve_rowe" created="Mon, 16 Jan 2012 09:45:45 +0000" />
                    <attachment id="12511433" name="jenkins_test.patch" size="1373" author="rcmuir" created="Sun, 22 Jan 2012 15:57:39 +0000" />
                    <attachment id="12510687" name="JFlexHTMLStripCharFilterWarcTest.java" size="3727" author="steve_rowe" created="Mon, 16 Jan 2012 09:45:45 +0000" />
                    <attachment id="12511477" name="LUCENE-3690-handle-utf16-surrogates.patch" size="12945" author="steve_rowe" created="Mon, 23 Jan 2012 07:30:12 +0000" />
                    <attachment id="12511421" name="LUCENE-3690.patch" size="2528423" author="steve_rowe" created="Sun, 22 Jan 2012 05:17:32 +0000" />
                    <attachment id="12510685" name="LUCENE-3690.patch" size="2478570" author="steve_rowe" created="Mon, 16 Jan 2012 09:45:45 +0000" />
                    <attachment id="12510511" name="LUCENE-3690.patch" size="946579" author="steve_rowe" created="Fri, 13 Jan 2012 19:04:11 +0000" />
                    <attachment id="12510317" name="LUCENE-3690.patch" size="235318" author="steve_rowe" created="Thu, 12 Jan 2012 07:00:16 +0000" />
                    <attachment id="12510313" name="LUCENE-3690.patch" size="234674" author="steve_rowe" created="Thu, 12 Jan 2012 05:40:03 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 12 Jan 2012 12:30:03 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>223659</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24008</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>