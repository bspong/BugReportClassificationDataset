<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:16:06 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2984/LUCENE-2984.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2984] Move hasVectors() &amp; hasProx() responsibility out of SegmentInfo to FieldInfos </title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2984</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Spin-off from &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2881&quot; title=&quot;Track FieldInfo per segment instead of per-IW-session&quot;&gt;&lt;del&gt;LUCENE-2881&lt;/del&gt;&lt;/a&gt; which had this change already but due to some random failures related to this change I remove this part of the patch to make it more isolated and easier to test. &lt;/p&gt;</description>
                <environment></environment>
            <key id="12502151">LUCENE-2984</key>
            <summary>Move hasVectors() &amp; hasProx() responsibility out of SegmentInfo to FieldInfos </summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="simonw">Simon Willnauer</assignee>
                                <reporter username="simonw">Simon Willnauer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Mar 2011 09:15:33 +0000</created>
                <updated>Fri, 10 May 2013 11:44:19 +0100</updated>
                    <resolved>Thu, 12 May 2011 22:51:57 +0100</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13031282" author="simonw" created="Tue, 10 May 2011 19:18:04 +0100"  >&lt;p&gt;Attaching my current state.&lt;br/&gt;
This patch moves all responsibility for hasVectors / hasProx out of SI into FIs. I also added some transactional code to FI that resets the FI#storeTermVector for a field if the TermVectors creation for that FI in the current segment has not successful.&lt;/p&gt;</comment>
                    <comment id="13031350" author="selckin" created="Tue, 10 May 2011 21:20:33 +0100"  >&lt;p&gt;&lt;a href=&quot;http://www.selckin.be/trunk-2984-patched.txt&quot; class=&quot;external-link&quot;&gt;http://www.selckin.be/trunk-2984-patched.txt&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="13031595" author="simonw" created="Wed, 11 May 2011 09:21:12 +0100"  >&lt;p&gt;here is a new patch that should fix selckins failur. I added javadoc, some comments and TODOs to remove the hasProx hasVector flags once we don&apos;t need to support it anymore.&lt;/p&gt;

&lt;p&gt;I also added a testcase for the vector flags in the exception case.&lt;/p&gt;</comment>
                    <comment id="13031820" author="simonw" created="Wed, 11 May 2011 17:17:29 +0100"  >&lt;p&gt;new patch!&lt;br/&gt;
I was running tests with the previous patch and tripped a very nifty exception.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; [junit] Testsuite: org.apache.lucene.store.TestLockFactory
    [junit] Testcase: testStressLocksNativeFSLockFactory(org.apache.lucene.store.TestLockFactory):	FAILED
    [junit] IndexWriter hit unexpected exceptions
    [junit] junit.framework.AssertionFailedError: IndexWriter hit unexpected exceptions
    [junit] 	at org.apache.lucene.store.TestLockFactory._testStressLocks(TestLockFactory.java:164)
    [junit] 	at org.apache.lucene.store.TestLockFactory.testStressLocksNativeFSLockFactory(TestLockFactory.java:144)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1282)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:1211)
    [junit] 
    [junit] 
    [junit] Tests run: 11, Failures: 1, Errors: 0, Time elapsed: 7.092 sec
    [junit] 
    [junit] ------------- Standard Output ---------------
    [junit] Stress Test Index Writer: creation hit unexpected IOException: java.io.FileNotFoundException: _u.fnm
    [junit] java.io.FileNotFoundException: _u.fnm
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:386)
    [junit] 	at org.apache.lucene.index.FieldInfos.&amp;lt;init&amp;gt;(FieldInfos.java:273)
    [junit] 	at org.apache.lucene.index.SegmentInfo.loadFieldInfos(SegmentInfo.java:264)
    [junit] 	at org.apache.lucene.index.SegmentInfo.getFieldInfos(SegmentInfo.java:315)
    [junit] 	at org.apache.lucene.index.SegmentInfo.files(SegmentInfo.java:603)
    [junit] 	at org.apache.lucene.index.SegmentInfos.files(SegmentInfos.java:873)
    [junit] 	at org.apache.lucene.index.IndexFileDeleter$CommitPoint.&amp;lt;init&amp;gt;(IndexFileDeleter.java:625)
    [junit] 	at org.apache.lucene.index.IndexFileDeleter.&amp;lt;init&amp;gt;(IndexFileDeleter.java:199)
    [junit] 	at org.apache.lucene.index.IndexWriter.&amp;lt;init&amp;gt;(IndexWriter.java:830)
    [junit] 	at org.apache.lucene.store.TestLockFactory$WriterThread.run(TestLockFactory.java:283)
    [junit] Stress Test Index Writer: creation hit unexpected IOException: java.io.FileNotFoundException: _u.fnm
    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestLockFactory -Dtestmethod=testStressLocksNativeFSLockFactory -Dtests.seed=9223296054268232625:-7758089421938554917
    [junit] NOTE: test params are: codec=RandomCodecProvider: {content=MockFixedIntBlock(blockSize=1397)}, locale=ar_MA, timezone=Indian/Antananarivo
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestDateTools, Test2BTerms, TestAddIndexes, TestFilterIndexReader, TestIndexWriterExceptions, TestIndexWriterMerging, TestMaxTermFrequency, TestParallelReaderEmptyIndex, TestParallelTermEnum, TestPerSegmentDeletes, TestPersistentSnapshotDeletionPolicy, TestSegmentReader, TestStressAdvance, TestConstantScoreQuery, TestDateFilter, TestDateSort, TestDocIdSet, TestNot, TestPrefixQuery, TestSetNorm, TestTopScoreDocCollector, TestBasics, TestSpansAdvanced2, TestDirectory, TestLockFactory]
    [junit] NOTE: Linux 2.6.37-gentoo amd64/Sun Microsystems Inc. 1.6.0_25 (64-bit)/cpus=8,threads=1,free=136724544,total=292618240
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;that is caused by MockDirectoryWrapper behaving like Windows not deleting files if they are still open. So there might be a segments_x file around but the _x.fnm has already been deleted. That wasn&apos;t a problem before but since we now need FIs to decide if a segment is storing vectors or not this file is required. &lt;/p&gt;

&lt;p&gt;To work around this I had to add some code to IndexFileDeleter which makes me worry a little. Now I drop a commit-point if either I can&apos;t load the SIS or I can not load one of the FIs from the loaded SI. I still try to delete all files of the &quot;broken&quot;?! segment though but the question is if there could be cases where I should rather throw an exception in such a case. Maybe some infoStream output would be helpful here to.&lt;/p&gt;

&lt;p&gt;Any comments largely appreciated.&lt;/p&gt;</comment>
                    <comment id="13032345" author="simonw" created="Thu, 12 May 2011 11:33:13 +0100"  >&lt;p&gt;next iteration.&lt;br/&gt;
Since we are iterating FieldInfos to find out if we store vectors printing mergingSegments in IW#registerMerge is not save anymore since a merge can update the segments FIs. I simplified that infostream output a little and made FieldInfos for new flushed segments readonly.&lt;/p&gt;

&lt;p&gt;I think we are close here so I will commit in a day or so if nobody objects&lt;/p&gt;</comment>
                    <comment id="13032500" author="mikemccand" created="Thu, 12 May 2011 17:43:24 +0100"  >&lt;p&gt;Patch looks good Simon!  Maybe add a comment on the changes in IFD about why we also go and force-load the FIS for each segment?  It&apos;s sorta... spooky.&lt;/p&gt;</comment>
                    <comment id="13032503" author="simonw" created="Thu, 12 May 2011 17:50:35 +0100"  >&lt;blockquote&gt;&lt;p&gt;Patch looks good Simon! Maybe add a comment on the changes in IFD about why we also go and force-load the FIS for each segment? It&apos;s sorta... spooky.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;ah yeah I already added a note to myself to do that - I will also add a infostream output for that.&lt;/p&gt;</comment>
                    <comment id="13032699" author="simonw" created="Thu, 12 May 2011 22:51:57 +0100"  >&lt;p&gt;committed in revision 1102476&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12478950" name="LUCENE-2984.patch" size="37536" author="simonw" created="Thu, 12 May 2011 11:33:13 +0100" />
                    <attachment id="12478842" name="LUCENE-2984.patch" size="35341" author="simonw" created="Wed, 11 May 2011 17:17:29 +0100" />
                    <attachment id="12478786" name="LUCENE-2984.patch" size="34478" author="simonw" created="Wed, 11 May 2011 09:21:12 +0100" />
                    <attachment id="12478717" name="LUCENE-2984.patch" size="29294" author="simonw" created="Tue, 10 May 2011 19:18:04 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 10 May 2011 20:20:33 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10896</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24708</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>