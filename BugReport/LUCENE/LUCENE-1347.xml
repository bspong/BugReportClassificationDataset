<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:30:36 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1347/LUCENE-1347.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1347] IndexWriter.rollback can hang if a previous call hit an exception</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1347</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;IW.rollback has logic to make sure only one thread actually gets to do&lt;br/&gt;
the rollback whenever multiple threads are calling it at the same&lt;br/&gt;
time, by setting the &quot;boolean closing&quot; to true in the thread that got&lt;br/&gt;
there first.&lt;/p&gt;

&lt;p&gt;Other threads wait for that variable to become false again before&lt;br/&gt;
returning from abort.&lt;/p&gt;

&lt;p&gt;But, we are not restoring closing to false in a try/finally in&lt;br/&gt;
rollback(), which means on hitting an exception in rollback, a&lt;br/&gt;
subsequent call to rollback() will hang forever.&lt;/p&gt;

&lt;p&gt;close() has the same logic, but there is already a try/finally there&lt;br/&gt;
to restore closing to false on exception.&lt;/p&gt;

&lt;p&gt;The fix is straightforward.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12401316">LUCENE-1347</key>
            <summary>IndexWriter.rollback can hang if a previous call hit an exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Jul 2008 13:45:39 +0100</created>
                <updated>Fri, 13 May 2011 19:20:37 +0100</updated>
                    <resolved>Wed, 30 Jul 2008 16:53:47 +0100</resolved>
                            <version>2.3</version>
                <version>2.3.1</version>
                                <fixVersion>2.4</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12618313" author="mikemccand" created="Wed, 30 Jul 2008 13:47:35 +0100"  >&lt;p&gt;Attached patch.  I plan to commit in a day or so, and then backport to 2.3.x.&lt;/p&gt;</comment>
                    <comment id="12618356" author="yseeley@gmail.com" created="Wed, 30 Jul 2008 15:23:07 +0100"  >&lt;p&gt;Looks good Mike!&lt;br/&gt;
Just one question.... it looks like there might be a race condition in rollbackInternal()&lt;br/&gt;
Thread A calls rollbackInternal calls closeInternal which executes the finally block, waking up thread B.&lt;br/&gt;
Thread B sets closing=true and then calls closeInternal or rollbackInternal... meanwhile thread A executes the finally block in rollbackInternal and sets closing=false (oops, it shouldn&apos;t do that if closeInternal already did it).&lt;/p&gt;

&lt;p&gt;That breaks the invariant, and thread C could then set closing=true and call closeInternal or rollbackInternal concurrently with thread B.&lt;/p&gt;

&lt;p&gt;Not sure if this would cause any real problems or not though.&lt;/p&gt;</comment>
                    <comment id="12618375" author="mikemccand" created="Wed, 30 Jul 2008 15:55:41 +0100"  >&lt;p&gt;Woops, you&apos;re right &amp;#8211; thanks for the review!  Two threads (B &amp;amp; C) could in fact enter closeInternal at the same time.&lt;/p&gt;

&lt;p&gt;Inside rollbackInternal, if I move the closeInternal() call out of the try/finally that sets closing to false, I believe that should resolve this?  In other words, I would only revert closing to false on hitting an exception in all the logic rollbackInternal does before calling closeInternal.&lt;/p&gt;

&lt;p&gt;OK new patch attached.&lt;/p&gt;</comment>
                    <comment id="12618390" author="yseeley@gmail.com" created="Wed, 30 Jul 2008 16:32:16 +0100"  >&lt;p&gt;Yep... the success flag ensures that closing=false  is only done once.&lt;/p&gt;</comment>
                    <comment id="12618392" author="mikemccand" created="Wed, 30 Jul 2008 16:36:37 +0100"  >&lt;p&gt;Super, I&apos;ll commit shortly &amp;#8211; thanks Yonik!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12387199" name="LUCENE-1347.patch" size="6781" author="mikemccand" created="Wed, 30 Jul 2008 15:55:41 +0100" />
                    <attachment id="12387183" name="LUCENE-1347.patch" size="6655" author="mikemccand" created="Wed, 30 Jul 2008 13:47:35 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 30 Jul 2008 14:23:07 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12401</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26381</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>