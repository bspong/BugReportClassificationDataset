<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:32:26 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3201/LUCENE-3201.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3201] improved compound file handling</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3201</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Currently CompoundFileReader could use some improvements, i see the following problems&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;its CSIndexInput extends bufferedindexinput, which is stupid for directories like mmap.&lt;/li&gt;
	&lt;li&gt;it seeks on every readInternal&lt;/li&gt;
	&lt;li&gt;its not possible for a directory to override or improve the handling of compound files.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;for example: it seems if you were impl&apos;ing this thing from scratch, you would just wrap the II directly (not extend BufferedIndexInput,&lt;br/&gt;
and add compound file offset X to seek() calls, and override length(). But of course, then you couldnt throw read past EOF always when you should,&lt;br/&gt;
as a user could read into the next file and be left unaware.&lt;/p&gt;

&lt;p&gt;however, some directories could handle this better. for example MMapDirectory could return an indexinput that simply mmaps the &apos;slice&apos; of the CFS file.&lt;br/&gt;
its underlying bytebuffer etc naturally does bounds checks already etc, so it wouldnt need to be buffered, not even needing to add any offsets to seek(),&lt;br/&gt;
as its position would just work.&lt;/p&gt;

&lt;p&gt;So I think we should try to refactor this so that a Directory can customize how compound files are handled, the simplest &lt;br/&gt;
case for the least code change would be to add this to Directory.java:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Directory openCompoundInput(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; filename) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompoundFileReader(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, filename);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Because most code depends upon the fact compound files are implemented as a Directory and transparent. at least then a subclass could override...&lt;br/&gt;
but the &apos;recursion&apos; is a little ugly... we could still label it expert+internal+experimental or whatever.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12510247">LUCENE-3201</key>
            <summary>improved compound file handling</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="simonw">Simon Willnauer</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jun 2011 00:57:35 +0100</created>
                <updated>Fri, 10 May 2013 11:44:23 +0100</updated>
                    <resolved>Fri, 7 Oct 2011 22:57:14 +0100</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13048906" author="mikemccand" created="Tue, 14 Jun 2011 01:01:07 +0100"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="13048912" author="rcmuir" created="Tue, 14 Jun 2011 01:12:30 +0100"  >&lt;p&gt;I think for this one, I prefer to wait for Uwe&apos;s refactoring of MMap on &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3200&quot; title=&quot;Cleanup MMapDirectory to use only one MMapIndexInput impl with mapping sized of powers of 2&quot;&gt;&lt;del&gt;LUCENE-3200&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Then mmap is simpler, and i think we can even use the same indexinput implementation here.&lt;/p&gt;

&lt;p&gt;This would mean no slowdown when searching CFS.&lt;/p&gt;</comment>
                    <comment id="13049283" author="rcmuir" created="Tue, 14 Jun 2011 18:13:43 +0100"  >&lt;p&gt;Initial patch for review. In this patch I only cut over MMapDirectory to using a special CompoundFileDirectory, all others use the default as before (but i cleaned up some things about it).&lt;/p&gt;

&lt;p&gt;Pretty sure i can easily improve SimpleFS and NIOFS, i&apos;ll take a look at that now, but I wanted to get this up for review.&lt;/p&gt;</comment>
                    <comment id="13049287" author="mikemccand" created="Tue, 14 Jun 2011 18:19:19 +0100"  >&lt;p&gt;Patch looks great!  Incredible that this means there&apos;s no penalty at all at search time when using CFS, if you use MMapDir.&lt;/p&gt;

&lt;p&gt;I like that CFS reader is now under oal.store not .index.&lt;/p&gt;</comment>
                    <comment id="13049296" author="rcmuir" created="Tue, 14 Jun 2011 18:29:15 +0100"  >&lt;p&gt;setting 3.3/4.0 as fix version, as the changes are backwards compatible (compoundfilereader is pkg-private still in 3.x)&lt;/p&gt;</comment>
                    <comment id="13049335" author="thetaphi" created="Tue, 14 Jun 2011 19:56:41 +0100"  >&lt;p&gt;Hi Robert, great patch, exactly as I would have wished to have it when we discussed about it!&lt;/p&gt;

&lt;p&gt;Patch looks file, small bug:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;FileSwitchDirectory should also override the openCompoundInput() from Directory and delegate to the correct underlying directory. Now it always uses the default impl, which is double buffering. So if you e.g. put MMapDirectory as a delegate for CFS files, those files would be opened like before your patch. Just copy&apos;n&apos;paste the code from one of the other FileSwitchDirectory methods.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Some suggestions:&lt;br/&gt;
We currently map the whole compound file into address space, read the header/contents and unmap it again. This may be some overhead especially if unmapping is not supported.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We could use SimpleFSIndexInput to read CFS contents (we only need to pass the already open RAF there, alternatively use Dawids new wrapper IndexInput around a standard InputStream, got from RAF -&amp;gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3202&quot; title=&quot;Add DataInput/DataOutput subclasses that delegate to an InputStream/OutputStream.&quot;&gt;&lt;del&gt;LUCENE-3202&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Only map the header of the CFS file, the problem: we dont know exact size.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13049346" author="rcmuir" created="Tue, 14 Jun 2011 20:10:01 +0100"  >&lt;p&gt;I agree, the fileswitchdirectory should delegate the openCompoundInput.&lt;/p&gt;

&lt;p&gt;As far as mapping small things, I think we should set this aside for another issue. &lt;br/&gt;
as far as this issue goes, I don&apos;t mind returning the DefaultCompound impl if unmapping isn&apos;t supported, but i&apos;d really rather defer the open the can of worms of &apos;mapping small things&apos; to some other issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13049352" author="thetaphi" created="Tue, 14 Jun 2011 20:19:38 +0100"  >&lt;p&gt;We have &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1743&quot; title=&quot;MMapDirectory should only mmap large files, small files should be opened using SimpleFS/NIOFS&quot;&gt;LUCENE-1743&lt;/a&gt; for the small files can of worms.&lt;/p&gt;</comment>
                    <comment id="13049446" author="rcmuir" created="Tue, 14 Jun 2011 22:42:14 +0100"  >&lt;p&gt;here is an updated patch, including impls for SimpleFS and NIOFS, fixing the FileSwitchDirectory thing uwe mentioned, and also mockdirectorywrapper and NRTCachingDirectory.&lt;/p&gt;

&lt;p&gt;all the tests pass with Simple/NIO/MMap but we need to benchmark. haven&apos;t had good luck today with luceneutil&lt;/p&gt;</comment>
                    <comment id="13049460" author="thetaphi" created="Tue, 14 Jun 2011 23:00:14 +0100"  >&lt;p&gt;Robert: Very nice. Small thing:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;NIOFSCompoundFileDirectory / SimpleFSCompoundFileDirectory / MMapCompoundFileDirectory are non-static inner classes but still get parent Directory in ctor. This is douplicated as javac also passes the parent around (the special ParentClassName.this one). I would remove the ctor param and use &quot;*FSDirectory.this&quot; as reference to outer class. I nitpick, because at some places it references the parent directory without the ctor param, so its inconsistent.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That&apos;s all for now, thanks for hard work!&lt;/p&gt;</comment>
                    <comment id="13052156" author="simonw" created="Mon, 20 Jun 2011 19:59:27 +0100"  >&lt;p&gt;this seems ready to commit... I think we should get that in so I can take it further on &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3218&quot; title=&quot;Make CFS appendable  &quot;&gt;&lt;del&gt;LUCENE-3218&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Robert is it ok for you if I commit this or are you gonig to do it?&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="13052159" author="rcmuir" created="Mon, 20 Jun 2011 20:03:12 +0100"  >&lt;p&gt;I didnt commit because I didn&apos;t measure any performance improvements from the patch (this frustrated me).&lt;br/&gt;
Also, I didn&apos;t address Uwe&apos;s last comment...&lt;/p&gt;

&lt;p&gt;In general, I was thinking that this would be a good performance win, but it isn&apos;t. So we should consider it from a refactoring perspective only.&lt;/p&gt;</comment>
                    <comment id="13052634" author="simonw" created="Tue, 21 Jun 2011 16:54:57 +0100"  >&lt;p&gt;incorporated in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3218&quot; title=&quot;Make CFS appendable  &quot;&gt;&lt;del&gt;LUCENE-3218&lt;/del&gt;&lt;/a&gt; I will track backporting there&lt;/p&gt;</comment>
                    <comment id="13088167" author="rcmuir" created="Sat, 20 Aug 2011 10:09:10 +0100"  >&lt;p&gt;reopening, like &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3218&quot; title=&quot;Make CFS appendable  &quot;&gt;&lt;del&gt;LUCENE-3218&lt;/del&gt;&lt;/a&gt;, I think we should pull this stuff back and revisit.&lt;/p&gt;</comment>
                    <comment id="13088169" author="thetaphi" created="Sat, 20 Aug 2011 10:19:28 +0100"  >&lt;p&gt;My last comment was wrong, the impl was changed before commit so it reuses RAF.&lt;/p&gt;</comment>
                    <comment id="13088170" author="rcmuir" created="Sat, 20 Aug 2011 10:19:35 +0100"  >&lt;p&gt;thats just not true... but illustrates my point that this stuff is complicated and I think we need to take the safe option here and back it out.&lt;/p&gt;</comment>
                    <comment id="13088172" author="thetaphi" created="Sat, 20 Aug 2011 10:24:33 +0100"  >&lt;p&gt;I reverted my comment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13118988" author="simonw" created="Sun, 2 Oct 2011 10:49:46 +0100"  >&lt;p&gt;I think we can close this issue unless we plan to backport the CFS changes to 3.x? Opinions?&lt;/p&gt;</comment>
                    <comment id="13123108" author="rcmuir" created="Fri, 7 Oct 2011 20:34:26 +0100"  >&lt;p&gt;not a blocker, it was pulled from 3.x (and fixed in trunk)&lt;/p&gt;</comment>
                    <comment id="13123243" author="simonw" created="Fri, 7 Oct 2011 22:57:14 +0100"  >&lt;p&gt;I am closing this... if we feel like porting we can still reopen&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310010">
                <name>Incorporates</name>
                                                <inwardlinks description="is part of">
                            <issuelink>
            <issuekey id="12510917">LUCENE-3218</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12482601" name="LUCENE-3201.patch" size="59474" author="rcmuir" created="Tue, 14 Jun 2011 22:42:14 +0100" />
                    <attachment id="12482570" name="LUCENE-3201.patch" size="44278" author="rcmuir" created="Tue, 14 Jun 2011 18:13:43 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 14 Jun 2011 00:01:07 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2883</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24496</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>