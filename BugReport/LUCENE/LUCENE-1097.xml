<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:08:33 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1097/LUCENE-1097.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1097] IndexWriter.close(false) does not actually stop background merge threads</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1097</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Right now when you close(false), IndexWriter marks any running merges&lt;br/&gt;
as aborted but then does not wait for these merges to finish.  This&lt;br/&gt;
can cause problems because those threads still hold files open, so,&lt;br/&gt;
someone might think they can call close(false) and then (say) delete&lt;br/&gt;
all files from that directory, which would fail on Windows.&lt;/p&gt;

&lt;p&gt;Instead, close(false) should notify each running merge that it has&lt;br/&gt;
been aborted, and not return until all running merges are done.  Then,&lt;br/&gt;
SegmentMerger should periodically check whether it has been aborted&lt;br/&gt;
and stop if so.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12385028">LUCENE-1097</key>
            <summary>IndexWriter.close(false) does not actually stop background merge threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Dec 2007 15:02:14 +0000</created>
                <updated>Fri, 25 Jan 2008 03:24:15 +0000</updated>
                    <resolved>Sat, 22 Dec 2007 10:07:04 +0000</resolved>
                            <version>2.3</version>
                                <fixVersion>2.3</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12553807" author="mikemccand" created="Thu, 20 Dec 2007 22:38:46 +0000"  >&lt;p&gt;Patch attached.  I plan to commit in a day or two.&lt;/p&gt;

&lt;p&gt;I changed SegmentMerger to periodically check whether the merge has&lt;br/&gt;
been aborted, and changed IndexWriter.close(false) to mark all merges&lt;br/&gt;
as aborted and then wait for them to actually finish.&lt;/p&gt;

&lt;p&gt;I changed it so when a merge is aborted it throws an explicit&lt;br/&gt;
exception (MergeAbortedException) which is cleaner than before when&lt;br/&gt;
any number of exceptions could be thrown.&lt;/p&gt;

&lt;p&gt;I also added a test case to IndexWriter to test closing a writer w/&lt;br/&gt;
doWait=false while another thread is still adding documents, which&lt;br/&gt;
uncovered a deadlock case, that I also fixed.&lt;/p&gt;</comment>
                    <comment id="12553920" author="michaelbusch" created="Fri, 21 Dec 2007 10:31:21 +0000"  >&lt;p&gt;Mike,&lt;/p&gt;

&lt;p&gt;cool patch! It looks like you added the abort check to all the&lt;br/&gt;
different spots in SegmentMerger and CFSWriter where most of &lt;br/&gt;
the merge time is spent: mergeFields, mergeTerms, mergeNorms,&lt;br/&gt;
and mergeVectors. So an abort should never take long, no &lt;br/&gt;
matter which part of the merge is being done when &lt;br/&gt;
IndexWriter.close(false) is called. Good!&lt;/p&gt;

&lt;p&gt;I&apos;m wondering how you came up with the values you pass in &lt;br/&gt;
checkAbort.work()? And does this abort checking have a &lt;br/&gt;
performance impact?&lt;/p&gt;

&lt;p&gt;In the future when we add more files (e. g. for column &lt;br/&gt;
fields) we have to remember to add corresponding abort checks &lt;br/&gt;
to new code that we add to SegmentMerger. I think it would be &lt;br/&gt;
good if you added some comments to SegmentMerger.merge() that&lt;br/&gt;
reminds us and gives some hints how to determine the values &lt;br/&gt;
for checkAbort.work().&lt;/p&gt;

&lt;p&gt;The abort logic should work with all merge policies, right?&lt;br/&gt;
Not only with background merges?&lt;/p&gt;

&lt;p&gt;I think this patch finally makes &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-887&quot; title=&quot;Interruptible segment merges&quot;&gt;&lt;del&gt;LUCENE-887&lt;/del&gt;&lt;/a&gt; obsolete. I&apos;ll &lt;br/&gt;
close it. &lt;/p&gt;</comment>
                    <comment id="12553925" author="mikemccand" created="Fri, 21 Dec 2007 11:22:36 +0000"  >
&lt;blockquote&gt;
&lt;p&gt;cool patch! It looks like you added the abort check to all the&lt;br/&gt;
different spots in SegmentMerger and CFSWriter where most of&lt;br/&gt;
the merge time is spent: mergeFields, mergeTerms, mergeNorms,&lt;br/&gt;
and mergeVectors. So an abort should never take long, no&lt;br/&gt;
matter which part of the merge is being done when&lt;br/&gt;
IndexWriter.close(false) is called. Good!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks!  Yes, all places that can take alot of time are now checking&lt;br/&gt;
whether the merge has been aborted.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;m wondering how you came up with the values you pass in&lt;br/&gt;
checkAbort.work()? And does this abort checking have a&lt;br/&gt;
performance impact?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did this empirically by increasing the value to .work() until the&lt;br/&gt;
msec delay in successive calls was not larger than ~ 3 seconds or so,&lt;br/&gt;
when building the Wikipedia index with full length docs.  Most of the&lt;br/&gt;
time it&apos;s ~50-100 msec between checks.&lt;/p&gt;

&lt;p&gt;I wanted to keep the number of calls to the synchronized&lt;br/&gt;
merge.isAborted() method to a minimum so we don&apos;t impact performance.&lt;br/&gt;
I haven&apos;t yet tested it, but I think the performance impact will be in&lt;br/&gt;
the noise...I&apos;ll test to be sure.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;In the future when we add more files (e. g. for column&lt;br/&gt;
fields) we have to remember to add corresponding abort checks&lt;br/&gt;
to new code that we add to SegmentMerger. I think it would be&lt;br/&gt;
good if you added some comments to SegmentMerger.merge() that&lt;br/&gt;
reminds us and gives some hints how to determine the values&lt;br/&gt;
for checkAbort.work().&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point, will do!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The abort logic should work with all merge policies, right?&lt;br/&gt;
Not only with background merges?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You mean merge schedulers right?  (Aborting shouldn&apos;t affect the merge&lt;br/&gt;
policy, which just selects the merges to be done but doesn&apos;t run&lt;br/&gt;
them).  But, yes, this will work w/ all merge schedulers.  The new&lt;br/&gt;
unit test (in TestIndexWriter) specifically tests SerialMergeScheduler&lt;br/&gt;
(in addition to ConcurrentMergeScheduler).&lt;/p&gt;</comment>
                    <comment id="12553927" author="michaelbusch" created="Fri, 21 Dec 2007 11:28:46 +0000"  >&lt;blockquote&gt;
&lt;p&gt;You mean merge schedulers right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I meant merge schedulers. Thanks for the explanation!&lt;/p&gt;</comment>
                    <comment id="12554101" author="mikemccand" created="Sat, 22 Dec 2007 10:07:04 +0000"  >&lt;p&gt;I just committed this!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12372045" name="LUCENE-1097.patch" size="24302" author="mikemccand" created="Thu, 20 Dec 2007 22:38:46 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 21 Dec 2007 10:31:21 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12648</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26632</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>