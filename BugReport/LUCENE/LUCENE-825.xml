<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:10:50 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-825/LUCENE-825.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-825] NullPointerException from SegmentInfos.FindSegmentsFile.run() if FSDirectory.list() returns NULL </title>
                <link>https://issues.apache.org/jira/browse/LUCENE-825</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Found this bug while running unit tests to verify an upgrade of our system from 1.4.3 to 2.1.0.  This bug did &lt;b&gt;not&lt;/b&gt; occur during 1.4.3, it is new to 2.x (I&apos;m pretty sure it&apos;s 2.1-only)&lt;/p&gt;

&lt;p&gt;If the index directory gets deleted out from under Lucene after the FSDirectory has been created, then attempts to open an IndexWriter or IndexReader will result in an NPE.  Lucene should be throwing an IOException in this case.&lt;/p&gt;

&lt;p&gt;Repro:&lt;br/&gt;
    1) Create an FSDirectory pointing somewhere in the filesystem (e.g. /foo/index/1)&lt;br/&gt;
    2) rm -rf the parent dir (rm -rf /foo/index)&lt;br/&gt;
    3) Try to open an IndexReader&lt;/p&gt;

&lt;p&gt;Result: NullPointerException on line &quot;for(int i=0;i&amp;lt;files.length;i++) { &quot; &amp;#8211; &apos;files&apos; is NULL.&lt;/p&gt;

&lt;p&gt;Expect: IOException&lt;/p&gt;


&lt;p&gt;....  &lt;/p&gt;

&lt;p&gt;This is happening because of a missing NULL check in SegmentInfos$FindSegmentsFile.run():&lt;/p&gt;

&lt;p&gt;        if (0 == method) {&lt;br/&gt;
          if (directory != null) &lt;/p&gt;
{
            files = directory.list();
          }
&lt;p&gt; else &lt;/p&gt;
{
            files = fileDirectory.list();
          }

&lt;p&gt;          gen = getCurrentSegmentGeneration(files);&lt;/p&gt;

&lt;p&gt;          if (gen == -1) {&lt;br/&gt;
            String s = &quot;&quot;;&lt;br/&gt;
            for(int i=0;i&amp;lt;files.length;i++) &lt;/p&gt;
{ 
              s += &quot; &quot; + files[i];
            }
&lt;p&gt;            throw new FileNotFoundException(&quot;no segments* file found: files:&quot; + s);&lt;br/&gt;
          }&lt;br/&gt;
        }&lt;/p&gt;


&lt;p&gt;The FSDirectory constructor will make sure the index dir exists, but if it is for some reason deleted out from underneath Lucene after the FSDirectory is instantiated, then java.io.File.list() will return NULL.  Probably better to fix FSDirectory.list() to just check for null and return a 0-length array:&lt;/p&gt;

&lt;p&gt;(in org/apache/lucene/store/FSDirectory.java)&lt;br/&gt;
314c314,317&lt;br/&gt;
&amp;lt;         return directory.list(IndexFileNameFilter.getFilter());&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;     String[] toRet = directory.list(IndexFileNameFilter.getFilter());&lt;br/&gt;
&amp;gt;     if (toRet == null)&lt;br/&gt;
&amp;gt;         return new String[]{};&lt;br/&gt;
&amp;gt;     return toRet;&lt;/p&gt;</description>
                <environment></environment>
            <key id="12364313">LUCENE-825</key>
            <summary>NullPointerException from SegmentInfos.FindSegmentsFile.run() if FSDirectory.list() returns NULL </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="timbrennan">Tim Brennan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Mar 2007 01:12:02 +0000</created>
                <updated>Tue, 19 Jun 2007 09:14:55 +0100</updated>
                    <resolved>Thu, 8 Mar 2007 18:06:30 +0000</resolved>
                            <version>2.1</version>
                                <fixVersion>2.2</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12478704" author="mikemccand" created="Wed, 7 Mar 2007 08:22:16 +0000"  >&lt;p&gt;Whoa, thanks for catching this!&lt;/p&gt;

&lt;p&gt;I would rather leave FSDirectory.list() returning null when the&lt;br/&gt;
directory does not exist because that would be an API change that&lt;br/&gt;
makes me a little nervous.&lt;/p&gt;

&lt;p&gt;I&apos;ll instead fix it in SegmentInfos and add a unit test showing the&lt;br/&gt;
bug.&lt;/p&gt;

&lt;p&gt;Index: src/java/org/apache/lucene/index/SegmentInfos.java&lt;br/&gt;
===================================================================&lt;br/&gt;
&amp;#8212; src/java/org/apache/lucene/index/SegmentInfos.java	(revision 515317)&lt;br/&gt;
+++ src/java/org/apache/lucene/index/SegmentInfos.java	(working copy)&lt;br/&gt;
@@ -481,6 +481,10 @@&lt;br/&gt;
             files = fileDirectory.list();&lt;br/&gt;
           }&lt;/p&gt;

&lt;p&gt;+          if (files == null) &lt;/p&gt;
{
+            throw new FileNotFoundException(&quot;no segments* file found in directory &quot; + directory + &quot;: list() returned null&quot;);
+          }
&lt;p&gt;+&lt;br/&gt;
           gen = getCurrentSegmentGeneration(files);&lt;/p&gt;

&lt;p&gt;           if (gen == -1) {&lt;/p&gt;</comment>
                    <comment id="12478714" author="mikemccand" created="Wed, 7 Mar 2007 08:46:47 +0000"  >&lt;p&gt;Thanks Tim.  Keep the patches coming!&lt;/p&gt;</comment>
                    <comment id="12478733" author="timbrennan" created="Wed, 7 Mar 2007 10:19:22 +0000"  >&lt;p&gt;The reason I suggested changing FSDirectory is that a quick look through the callers of Directory.list() show that pretty much none of the callsites expect a null return from this function. &lt;/p&gt;

&lt;p&gt; Check out:&lt;/p&gt;

&lt;p&gt;1) SegmentInfos.java - boolean hasSeparateNorms():&lt;br/&gt;
        String[] result = dir.list();&lt;br/&gt;
        String pattern;&lt;br/&gt;
        pattern = name + &quot;.s&quot;;&lt;br/&gt;
        int patternLength = pattern.length();&lt;br/&gt;
        for(int i = 0; i &amp;lt; result.length; i++){&lt;br/&gt;
          if(result&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.startsWith(pattern) &amp;amp;&amp;amp; Character.isDigit(result&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.charAt(patternLength)))&lt;br/&gt;
(accesses result.length w/o null check on result)&lt;/p&gt;


&lt;p&gt;2) IndexFileDeleter.java - void findDeletableFiles():&lt;br/&gt;
    String[] files = directory.list();&lt;/p&gt;

&lt;p&gt;    for (int i = 0; i &amp;lt; files.length; i++) {&lt;br/&gt;
(access to files.length w/o null check)&lt;/p&gt;

&lt;p&gt;3) Directory.java - static void copy(...)&lt;br/&gt;
....same thing...&lt;/p&gt;


&lt;p&gt;Should probably fix all those callsites as well, if we really expect Directory.list() to return null...&lt;/p&gt;

</comment>
                    <comment id="12478738" author="mikemccand" created="Wed, 7 Mar 2007 10:32:05 +0000"  >&lt;p&gt;Excellent point.  I will do that.&lt;/p&gt;</comment>
                    <comment id="12478749" author="mikemccand" created="Wed, 7 Mar 2007 11:16:41 +0000"  >&lt;p&gt;Attached patch to check all places internal to Lucene where we call Directory.list().  I also updated the javadoc of that method to state that it may return null.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12352828" name="LUCENE-825.patch" size="5358" author="mikemccand" created="Wed, 7 Mar 2007 11:16:41 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 7 Mar 2007 08:22:16 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12915</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26905</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>