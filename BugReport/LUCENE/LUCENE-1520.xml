<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:04:08 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1520/LUCENE-1520.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1520] OOM erros with CheckIndex with indexes containg a lot of fields with norms</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1520</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;All index readers have a cache of the last used norms (SegmentReader, MultiReader, MultiSegmentReader,...). This cache is never cleaned up, so if you access norms of a field, the norm&apos;s byte&lt;span class=&quot;error&quot;&gt;&amp;#91;maxdoc()&amp;#93;&lt;/span&gt; array is not freed until you close/reopen the index.&lt;/p&gt;

&lt;p&gt;You can see this problem, if you create an index with many fields with norms (I tested with about 4,000 fields) and many documents (half a million). If you then call CheckIndex, that calls norms() for each &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; field in the Segment and each of this calls creates a new cache entry, you get OutOfMemoryExceptions after short time (I tested with the above index: I was not able to do a CheckIndex even with &quot;-Xmx 16GB&quot; on 64bit Java).&lt;/p&gt;

&lt;p&gt;CheckIndex opens and then tests each segment of a index with a separate SegmentReader. The big index with the OutOfMemory problem was optimized, so consisting of one segment with about half a million docs and about 4,000 fields. Each byte[] array takes about a half MiB for this index. The CheckIndex funtion created the norm for 4000 fields and the SegmentReader cached them, which is about 2 GiB RAM. So OOMs are not unusal.&lt;/p&gt;

&lt;p&gt;In my opinion, the best would be to use a Weak- or better a SoftReference so norms.bytes gets java.lang.ref.SoftReference&amp;lt;byte[]&amp;gt; and used for caching. With proper synchronization (which is done on the norms cache in SegmentReader) you can do the best with SoftReference, as this reference is garbage collected only when an OOM may happen. If the byte[] array is freed (but it is only freed if no other references exist), a lter call to getNorms() creates a new array. When code is hard referencing the norms array, it will not be freed, so no problem. The same could be done for the other IndexReaders.&lt;/p&gt;

&lt;p&gt;Fields without norm() do not have this problem, as all these fields share a one-time allocated dummy norm array. So the same index without norms enabled for most of the fields checked perfectly.&lt;/p&gt;

&lt;p&gt;I will prepare a patch tomorrow.&lt;/p&gt;

&lt;p&gt;Mike proposed another quick fix for CheckIndex:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;we could do something first specifically for CheckIndex (eg it could simply use the 3-arg non-caching bytes method instead) to prevent OOM errors when using it.&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
            <key id="12412538">LUCENE-1520</key>
            <summary>OOM erros with CheckIndex with indexes containg a lot of fields with norms</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Jan 2009 22:44:08 +0000</created>
                <updated>Fri, 25 Sep 2009 17:23:17 +0100</updated>
                    <resolved>Fri, 16 Jan 2009 10:49:46 +0000</resolved>
                            <version>2.9</version>
                                <fixVersion>2.9</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12664467" author="thetaphi" created="Fri, 16 Jan 2009 10:37:25 +0000"  >&lt;p&gt;This is a patch for Mike&apos;s suggestion: It just fixes CheckIndex to not use norms(fieldname) which caches, but uses the uncached 3-arg variant. TestCheckIndex passes.&lt;/p&gt;

&lt;p&gt;No more OOM error with the many-field-index.&lt;/p&gt;</comment>
                    <comment id="12664472" author="mikemccand" created="Fri, 16 Jan 2009 10:46:27 +0000"  >&lt;p&gt;Patch looks good; I&apos;ll commit shortly.&lt;/p&gt;</comment>
                    <comment id="12664473" author="thetaphi" created="Fri, 16 Jan 2009 10:48:44 +0000"  >&lt;p&gt;Again a slightly improved patch. byte[] is only allocated one time for all fields in CheckIndex. The length check is unnecessary, because the array is preallocated to maxDoc. Moved this a little bit modified to compare SegmentInfo docCount and Reader maxDoc&lt;/p&gt;</comment>
                    <comment id="12664474" author="mikemccand" created="Fri, 16 Jan 2009 10:49:46 +0000"  >&lt;p&gt;Committed revision 734967.&lt;/p&gt;

&lt;p&gt;Thanks Uwe!&lt;/p&gt;</comment>
                    <comment id="12664476" author="thetaphi" created="Fri, 16 Jan 2009 10:58:01 +0000"  >&lt;p&gt;Again my last patch with optimized memory usage, now on the current svn trunk after Mike&apos;s commit.&lt;/p&gt;</comment>
                    <comment id="12664480" author="mikemccand" created="Fri, 16 Jan 2009 11:11:00 +0000"  >&lt;p&gt;OK, even better &amp;#8211; I&apos;ll commit.&lt;/p&gt;</comment>
                    <comment id="12664481" author="mikemccand" created="Fri, 16 Jan 2009 11:11:37 +0000"  >&lt;p&gt;Committed revision 734974.  Thanks!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12398055" name="LUCENE-1520.patch" size="1277" author="thetaphi" created="Fri, 16 Jan 2009 10:58:01 +0000" />
                    <attachment id="12398054" name="LUCENE-1520.patch" size="1269" author="thetaphi" created="Fri, 16 Jan 2009 10:48:44 +0000" />
                    <attachment id="12398052" name="LUCENE-1520.patch" size="745" author="thetaphi" created="Fri, 16 Jan 2009 10:37:25 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 16 Jan 2009 10:46:27 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12233</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26208</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>