<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:25 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3515/LUCENE-3515.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3515] Possible slowdown of indexing/merging on 3.x vs trunk</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3515</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Opening an issue to pursue the possible slowdown Marc Sturlese uncovered.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12527037">LUCENE-3515</key>
            <summary>Possible slowdown of indexing/merging on 3.x vs trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Oct 2011 16:44:52 +0100</created>
                <updated>Fri, 10 May 2013 11:44:46 +0100</updated>
                    <resolved>Fri, 14 Oct 2011 20:41:43 +0100</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>2</watches>
                                                    <comments>
                    <comment id="13126677" author="mikemccand" created="Thu, 13 Oct 2011 16:47:48 +0100"  >&lt;p&gt;Patches from Marc showing the issue (thanks Marc!).&lt;/p&gt;</comment>
                    <comment id="13126686" author="rcmuir" created="Thu, 13 Oct 2011 17:04:04 +0100"  >&lt;p&gt;we should run the comparisons as a public static void main i think instead of extending LuceneTestCase.&lt;/p&gt;

&lt;p&gt;4.0 could be getting SimpleText etc &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13126692" author="mikemccand" created="Thu, 13 Oct 2011 17:13:10 +0100"  >&lt;p&gt;Same tests, just cut over to static void main instead.&lt;/p&gt;</comment>
                    <comment id="13126693" author="rcmuir" created="Thu, 13 Oct 2011 17:16:33 +0100"  >&lt;p&gt;3.x:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Time taken indexing: 114&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Time taken closing: 20&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Time taken whole process: 134&lt;/p&gt;

&lt;p&gt;4.x:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Time taken indexing: 133&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Time taken closing: 1&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; Time taken whole process: 134&lt;/p&gt;

&lt;p&gt;So for me, its the same speed.&lt;/p&gt;

&lt;p&gt;I didnt use the public static void main, i used the test as-is, except i disabled assertions and forced StandardCodec.&lt;/p&gt;</comment>
                    <comment id="13126704" author="mikemccand" created="Thu, 13 Oct 2011 17:31:11 +0100"  >&lt;p&gt;I actually see 3.x running slower:&lt;/p&gt;

&lt;p&gt;Trunk:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  Time taken indexing: 184
  Time taken closing: 2
  Time taken whole process: 187
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3.x:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Time taken indexing: 205
  Time taken closing: 40
  Time taken whole process: 245
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But, this is because 3.x does a level 2 merge just before close, and&lt;br/&gt;
the close must wait for that merge to complete.  Whereas trunk never&lt;br/&gt;
gets to the level 2 merge (only level 0/1), likely because trunk&apos;s RAM&lt;br/&gt;
efficiency is a better and so it packs more docs into each level 0 segment.&lt;/p&gt;

&lt;p&gt;If we pushed the number of doc up to maybe 1.1M then we should&lt;br/&gt;
similarly see trunk trigger a level 2 merge.&lt;/p&gt;

&lt;p&gt;Really when benchmarking indexing it&apos;s best to just close the IW&lt;br/&gt;
without waiting for merges; otherwise you&apos;re comparing apples &amp;amp;&lt;br/&gt;
oranges.&lt;/p&gt;</comment>
                    <comment id="13126762" author="sturlese" created="Thu, 13 Oct 2011 18:57:25 +0100"  >&lt;p&gt;Seeing others results the &quot;problem&quot; seems to be merges are very slow on trunk on Snow Leopard (where I&apos;ve been running the tests).&lt;br/&gt;
I&apos;ve attached the whole stdout for both executions. Soon will run the tests on a debian box and post the results too.&lt;br/&gt;
Here are the results:&lt;br/&gt;
trunk&lt;br/&gt;
Time taken indexing: 927&lt;br/&gt;
Time taken closing: 283&lt;br/&gt;
Time taken whole process: 1211&lt;/p&gt;

&lt;p&gt;3.4&lt;br/&gt;
Time taken indexing: 303&lt;br/&gt;
Time taken closing: 37&lt;br/&gt;
Time taken whole process: 340&lt;/p&gt;</comment>
                    <comment id="13126773" author="rcmuir" created="Thu, 13 Oct 2011 19:08:32 +0100"  >&lt;p&gt;something is severely wrong on mac os X with NIOFSDirectory (when merging, on the read side).&lt;/p&gt;

&lt;p&gt;with mmapdirectory, its fast.&lt;/p&gt;</comment>
                    <comment id="13126786" author="rcmuir" created="Thu, 13 Oct 2011 19:24:38 +0100"  >&lt;p&gt;simplefs is slow too.&lt;/p&gt;</comment>
                    <comment id="13126795" author="sturlese" created="Thu, 13 Oct 2011 19:40:02 +0100"  >&lt;p&gt;I&apos;ve tried snow leopard and MMap. Trunk went much better than before:&lt;/p&gt;

&lt;p&gt;trunk&lt;br/&gt;
Time taken indexing: 416&lt;br/&gt;
Time taken closing: 1&lt;br/&gt;
Time taken whole process: 417&lt;/p&gt;

&lt;p&gt;3.4:&lt;br/&gt;
Time taken indexing: 321&lt;br/&gt;
Time taken closing: 46 &lt;br/&gt;
Time taken whole process: 368&lt;/p&gt;

</comment>
                    <comment id="13126820" author="rcmuir" created="Thu, 13 Oct 2011 20:10:46 +0100"  >&lt;p&gt;it looks like the bug will especially affect any directory that uses bufferedindexinput (NIOFS/SimpleFS).&lt;/p&gt;

&lt;p&gt;The problem is multitermsenum doesnt reuse the sub-docs&amp;amp;positionsenums, so for each term*segment we clone the input, and&lt;br/&gt;
bufferedindexinput.clone() sets the clone&apos;s buffer to null.&lt;/p&gt;

&lt;p&gt;so across lots of low freq-terms we re-read 4096 bytes (MERGE_BUFFER_SIZE) to refill the buffer on each one...&lt;/p&gt;

&lt;p&gt;mmapdirectory is less affected because it has no buffer to re-read but seems like fixing the reusing would even help it...&lt;/p&gt;</comment>
                    <comment id="13126898" author="mikemccand" created="Thu, 13 Oct 2011 21:41:50 +0100"  >&lt;p&gt;Patch, fixing the lack of reuse in MultiTermsEnum (used during merging).&lt;/p&gt;

&lt;p&gt;The lack of re-use meant we were cloning 2 IndexInputs (frq/prx) per term being merged!  For NIOFSDir this then meant we would read the same 4K region of the file over and over and over again.&lt;/p&gt;

&lt;p&gt;I added a test to catch &quot;over-cloning&quot;, but, the test sometimes fails when it gets pulsing codec because that codec does not properly reuse (a known issue that we should now fix!).&lt;/p&gt;</comment>
                    <comment id="13126900" author="mikemccand" created="Thu, 13 Oct 2011 21:43:01 +0100"  >&lt;p&gt;This seed will fail due to pulsing codec:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;otv TestForTooMuchCloning.test -seed 6407e19e4835e90d:-d7cdae0d4a378eb:-ee1a92b677887
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13126940" author="rcmuir" created="Thu, 13 Oct 2011 22:18:27 +0100"  >&lt;p&gt;i opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3517&quot; title=&quot;Fix pulsingcodec to reuse its enums&quot;&gt;&lt;del&gt;LUCENE-3517&lt;/del&gt;&lt;/a&gt; for the pulsing bug.&lt;/p&gt;

&lt;p&gt;But i think we should fix this &apos;general bug&apos; which affects all codecs first?&lt;br/&gt;
I think &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3517&quot; title=&quot;Fix pulsingcodec to reuse its enums&quot;&gt;&lt;del&gt;LUCENE-3517&lt;/del&gt;&lt;/a&gt; might involve attributes-policeman &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;we could do this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    String bodyCodec = CodecProvider.getDefault().getFieldCodec(&quot;body&quot;);
    assumeFalse(&quot;PulsingCodec fails this test because of over-cloning&quot;, bodyCodec.equals(&quot;Pulsing&quot;) || bodyCodec.equals(&quot;MockRandom&quot;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13127466" author="mikemccand" created="Fri, 14 Oct 2011 13:05:46 +0100"  >&lt;p&gt;New patch.&lt;/p&gt;

&lt;p&gt;I changed the test to just use random terms, and also added the&lt;br/&gt;
workaround for Pulsing&apos;s non-reuse.&lt;/p&gt;

&lt;p&gt;I discovered SimpleText also fails to properly reuse (it failed the&lt;br/&gt;
new test) and fixed that.&lt;/p&gt;

&lt;p&gt;I think it&apos;s ready!&lt;/p&gt;</comment>
                    <comment id="13127801" author="mikemccand" created="Fri, 14 Oct 2011 20:41:43 +0100"  >&lt;p&gt;Thank you Marc and Erick!  This was a devious issue and severely impacted merge performance for non-MMapDir impls.&lt;/p&gt;</comment>
                    <comment id="13134592" author="mikemccand" created="Mon, 24 Oct 2011 23:46:15 +0100"  >&lt;p&gt;This bug was only present in 4.0.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12499025" name="LUCENE-3515.patch" size="15696" author="mikemccand" created="Fri, 14 Oct 2011 13:05:46 +0100" />
                    <attachment id="12498922" name="LUCENE-3515.patch" size="12442" author="mikemccand" created="Thu, 13 Oct 2011 21:41:50 +0100" />
                    <attachment id="12498890" name="LUCENE-index-34.patch" size="5868" author="mikemccand" created="Thu, 13 Oct 2011 16:47:48 +0100" />
                    <attachment id="12498891" name="LUCENE-index-40.patch" size="6315" author="mikemccand" created="Thu, 13 Oct 2011 16:47:48 +0100" />
                    <attachment id="12498904" name="stdout-snow-leopard.tar.gz" size="98119" author="sturlese" created="Thu, 13 Oct 2011 18:58:31 +0100" />
                    <attachment id="12498895" name="TestGenerationTime.java.3x" size="5462" author="mikemccand" created="Thu, 13 Oct 2011 17:13:09 +0100" />
                    <attachment id="12498896" name="TestGenerationTime.java.40" size="5879" author="mikemccand" created="Thu, 13 Oct 2011 17:13:09 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>7.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 13 Oct 2011 16:04:04 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>85401</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24182</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>