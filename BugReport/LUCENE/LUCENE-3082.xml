<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:38 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3082/LUCENE-3082.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3082] Add tool to upgrade all segments of an index to last recent supported index format without optimizing</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3082</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Currently if you want to upgrade an old index to the format of your current Lucene version, you have to optimize your index or use addIndexes(IndexReader...) &lt;span class=&quot;error&quot;&gt;&amp;#91;see LUCENE-2893&amp;#93;&lt;/span&gt; to copy to a new directory. The optimize() approach fails if your index is already optimized.&lt;/p&gt;

&lt;p&gt;I propose to add a custom MergePolicy to upgrade all segments to the last format. This MergePolicy could simply also ignore all segments already up-to-date. All segments in prior formats would be merged to a new segment using another MergePolicy&apos;s optimize strategy.&lt;/p&gt;

&lt;p&gt;This issue is different from &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2893&quot; title=&quot;index upgrade tool for /dev-tools&quot;&gt;LUCENE-2893&lt;/a&gt;, as it would only support upgrading indexes from previous Lucene versions in-place using the official path. Its a tool for the end user, not a developer tool.&lt;/p&gt;

&lt;p&gt;This addition should also go to Lucene 3.x, as we need to make users with pre-3.0 indexes go the step through 3.x, else they would not be able to open their index with 4.0. With this tool in 3.x the users could safely upgrade their index without relying on optimize to work on already-optimized indexes.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12506535">LUCENE-3082</key>
            <summary>Add tool to upgrade all segments of an index to last recent supported index format without optimizing</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Sun, 8 May 2011 14:09:29 +0100</created>
                <updated>Fri, 3 Jun 2011 17:37:09 +0100</updated>
                    <resolved>Fri, 13 May 2011 11:50:47 +0100</resolved>
                                            <fixVersion>3.2</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13030483" author="mikemccand" created="Sun, 8 May 2011 14:16:18 +0100"  >&lt;p&gt;Maybe instead of a new method on IW, this is a new tool (eg oal.index.UpgradeIndex)?  That tool would create IW w/ a custom UpgradeMergePolicy that rewrites all segments (or only segments not matching current format, but often that would presumably be all segments).&lt;/p&gt;</comment>
                    <comment id="13030484" author="thetaphi" created="Sun, 8 May 2011 14:25:31 +0100"  >&lt;p&gt;Here the discussion of #lucene-dev irc channel: &lt;a href=&quot;http://colabti.org/irclogger/irclogger_log/lucene-dev?date=2011-05-08#l117&quot; class=&quot;external-link&quot;&gt;http://colabti.org/irclogger/irclogger_log/lucene-dev?date=2011-05-08#l117&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="13030518" author="shaie" created="Sun, 8 May 2011 19:21:58 +0100"  >&lt;p&gt;This is a great idea. We should also allow one to plug in a PayloadProcessorProvider so he can rewrite the payload &quot;on the go&quot; if need be.&lt;/p&gt;

&lt;p&gt;Also, while the index is being upgraded, I think it will be useful if we merge the segments that are upgraded, however not do cascading merges. Since segments are rewritten anyway, we can only gain from the merge. As always, if not everybody agree on this, we can make it a parameter.&lt;/p&gt;

&lt;p&gt;And let&apos;s make sure that whatever &apos;upgrade&apos; means is at the application control. I.e., upgrade can be simply upgrading from 3x to 4.0, but it can also be using PayloadProcessorProvider as well suddenly deciding that all segments should be compound. I&apos;m pretty sure I&apos;ll want to control the first two, not so about the last one.&lt;/p&gt;

&lt;p&gt;It can be a simple &apos;boolean shouldUpgradeSegment(SegmentInfo)&apos; on this UpgradeMP, which apps can override.&lt;/p&gt;</comment>
                    <comment id="13030519" author="thetaphi" created="Sun, 8 May 2011 19:25:09 +0100"  >&lt;p&gt;Patch that implements this with a merge policy:&lt;/p&gt;

&lt;p&gt;It does not yet contain the command line updater, if you want to upgrade an old index, the API code to do this is very simple:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
IndexWriterConfig iwc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriterConfig(Version.LUCENE_XX, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KeywordAnalyzer());
iwc = iwc.setMergePolicy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UpgradeIndexMergePolicy(iwc.getMergePolicy()));
IndexWriter w = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriter(dir, iwc);
w.optimize();
w.close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The patch contains new tests in TestBackwards that verify the upgrade process:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It tries to upgrade all old indexes from the well-known list in TestBackwards. When this is done, all of them should contain exactly one segment (because all segments previously in index are older version, so they are merged/optimized together in new format). It also verifies all segment versions to be Constants.LUCENE_MAIN_VERSION.&lt;/li&gt;
	&lt;li&gt;It tries to upgrade two old, already optimized indexes (with prev version, I changed TestBackwards in my 3.1 checkout to generate those). It verifies the segment versions after the upgrade. This special case is needed, as optimizing a one-segment index is a no-op without the special merge-policy&lt;/li&gt;
	&lt;li&gt;It uses the old optimized indexes, opens them using standard merge policy and adds some documents to them. After that it upgrades the index with a new IndexWriter using the special merge policy. In that case (as some segments are already in new version), the index should only have the old-segments merged together, the newly added ones are untouched. So segment is verified to be count &amp;gt; 1.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13030525" author="thetaphi" created="Sun, 8 May 2011 19:38:55 +0100"  >&lt;p&gt;Shai:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The supplied patch should handle all you want (there would be only one addition, the proposed &apos;boolean shouldUpgradeSegment(SegmentInfo)&apos; method, which is a one-liner, will upload new patch for that und make the merge policy unfinal.&lt;/li&gt;
	&lt;li&gt;It will not do cascading merges, because when the merge policy recognizes that all segments have already the new version it will not merge anything. So after the first iteration all segments will be upgraded, so on the next run of this policy, it will return null merges.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The other ideas like PayloadProcessor can be done outside of that in user code (but beware, it will not touch segments already in new version).&lt;/p&gt;</comment>
                    <comment id="13030527" author="thetaphi" created="Sun, 8 May 2011 19:42:29 +0100"  >&lt;p&gt;Upgraded patch with a protected shouldUpgradeSegment(SI) method.&lt;/p&gt;</comment>
                    <comment id="13030528" author="mikemccand" created="Sun, 8 May 2011 19:47:37 +0100"  >&lt;p&gt;Patch looks great!&lt;/p&gt;

&lt;p&gt;The segmentsToOptimize ought to contain every segment in the index; that&apos;s only present for the case where optimize() is called in a bg thread but other threads continue to index new documents causing new segments to be flushed.  These new segments would then NOT be in the segmentsToOptimize when the optimize merges need to cascade.&lt;/p&gt;

&lt;p&gt;TODO: for the command-line tool, we should make sure the index only has a single commit point (ie, abort if not).  Upgrading an index with more than one commit point is hairy (I think it&apos;s fine not to support this case... but we should not remove the commits).&lt;/p&gt;</comment>
                    <comment id="13030533" author="thetaphi" created="Sun, 8 May 2011 20:38:17 +0100"  >&lt;p&gt;Small change to the merging of the leftover segments, that are not scheduled for merge by the wrapped MergePolicy: They re now merged together into one segment instead of separately. Normally that are only few ones (e.g. when TieredMergePolicy only optimized the first 30 segments and leave the rest for later). As we have no cascading optimize, we merge the remaining segments into one.&lt;/p&gt;</comment>
                    <comment id="13030571" author="thetaphi" created="Mon, 9 May 2011 01:56:18 +0100"  >&lt;p&gt;Patch with updated and randomized tests, command line tool (oal.index.IndexFormatUpgrader) and javadocs.&lt;/p&gt;

&lt;p&gt;I think it&apos;s ready to commit.&lt;/p&gt;</comment>
                    <comment id="13030676" author="mikemccand" created="Mon, 9 May 2011 11:38:02 +0100"  >&lt;p&gt;How about this wording:&lt;/p&gt;

&lt;p&gt;Expert: this tool keeps only the last commit in an index; for this&lt;br/&gt;
reason, if the incoming index has more than one commit, the tool&lt;br/&gt;
refuses to run by default.  Specify -delete-prior-commits to override&lt;br/&gt;
this, allowing the tool to delete all but the last commit.&lt;/p&gt;

&lt;p&gt;Maybe just call it IndexUpgrader?  (Format seems redundant?)&lt;/p&gt;

&lt;p&gt;There&apos;s a missing &lt;/p&gt;
{ and }
&lt;p&gt; after the &quot;if (commits.size() &amp;gt; 1)&quot;&lt;/p&gt;</comment>
                    <comment id="13030691" author="thetaphi" created="Mon, 9 May 2011 12:36:47 +0100"  >&lt;p&gt;New patch with renamed class and added documentation as suggested by Mike.&lt;/p&gt;

&lt;p&gt;The previous patch had also a bug in the command line tool (instead of &quot;dir&quot; it used still &quot;args&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&quot; to invoke the ctor, which was a relict from earlier tool version).&lt;/p&gt;

&lt;p&gt;I also fixed javadocs and added lucene.experimental to the UpgradeIndexMergePolicy, as we should not make it too public (but its not really &quot;internal&quot; because there are use cases not covered by the easy-to-use IndexUpgrader tool.&lt;/p&gt;</comment>
                    <comment id="13030796" author="thetaphi" created="Mon, 9 May 2011 17:31:16 +0100"  >&lt;p&gt;Committed trunk revision: 1101088&lt;br/&gt;
Committed 3.x revision: 1101093&lt;/p&gt;</comment>
                    <comment id="13030797" author="thetaphi" created="Mon, 9 May 2011 17:32:37 +0100"  >&lt;p&gt;I also used the full random IndexWriterConfig now after &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3083&quot; title=&quot;MockRandomMergePolicy optimizes segments not in the Set passed in&quot;&gt;&lt;del&gt;LUCENE-3083&lt;/del&gt;&lt;/a&gt; was committed (Fix MockRandomMergePolicy).&lt;/p&gt;

&lt;p&gt;I will now commit and merge the test code to produce the optimized indexes.&lt;/p&gt;</comment>
                    <comment id="13032283" author="thetaphi" created="Thu, 12 May 2011 08:11:28 +0100"  >&lt;p&gt;We should add a warning to the MergePolicy/IndexUpgrader, that this tool reorders segments, if the index was partially upgraded before (e.g. by adding new documents). Segments that were upgraded before a call to MP&apos;s optimize come first, then the upgraded ones.&lt;/p&gt;</comment>
                    <comment id="13032708" author="thetaphi" created="Thu, 12 May 2011 23:09:19 +0100"  >&lt;p&gt;Patch that adds some warnings about reordering of documents IDs if the index was partially upgraded before execution.&lt;/p&gt;</comment>
                    <comment id="13032954" author="thetaphi" created="Fri, 13 May 2011 11:48:00 +0100"  >&lt;p&gt;Upgraded patch. Will now be committed.&lt;/p&gt;

&lt;p&gt;I added Version ctor argument, as in 3.x this would chose the default merge policy.&lt;/p&gt;</comment>
                    <comment id="13032956" author="thetaphi" created="Fri, 13 May 2011 11:50:47 +0100"  >&lt;p&gt;Committed trunk revision: 1102658&lt;br/&gt;
Merged 3.x revision: 1102659&lt;/p&gt;</comment>
                    <comment id="13043457" author="rcmuir" created="Fri, 3 Jun 2011 17:37:09 +0100"  >&lt;p&gt;Bulk closing for 3.2&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12496891">LUCENE-2893</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12478546" name="index.31.optimized.cfs.zip" size="2174" author="thetaphi" created="Sun, 8 May 2011 19:26:32 +0100" />
                    <attachment id="12478547" name="index.31.optimized.nocfs.zip" size="3638" author="thetaphi" created="Sun, 8 May 2011 19:26:32 +0100" />
                    <attachment id="12478584" name="LUCENE-3082.patch" size="19481" author="thetaphi" created="Mon, 9 May 2011 12:36:47 +0100" />
                    <attachment id="12478561" name="LUCENE-3082.patch" size="18942" author="thetaphi" created="Mon, 9 May 2011 01:56:18 +0100" />
                    <attachment id="12478550" name="LUCENE-3082.patch" size="10389" author="thetaphi" created="Sun, 8 May 2011 20:38:17 +0100" />
                    <attachment id="12478548" name="LUCENE-3082.patch" size="10254" author="thetaphi" created="Sun, 8 May 2011 19:42:29 +0100" />
                    <attachment id="12478545" name="LUCENE-3082.patch" size="9983" author="thetaphi" created="Sun, 8 May 2011 19:25:09 +0100" />
                    <attachment id="12479081" name="LUCENE-3082-reorder-warnings.patch" size="4736" author="thetaphi" created="Fri, 13 May 2011 11:48:00 +0100" />
                    <attachment id="12479015" name="LUCENE-3082-reorder-warnings.patch" size="2106" author="thetaphi" created="Thu, 12 May 2011 23:09:19 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>9.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 8 May 2011 13:16:18 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2146</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24611</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>