<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:09:16 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2621/LUCENE-2621.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2621] Extend Codec to handle also stored fields and term vectors</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2621</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Currently Codec API handles only writing/reading of term-related data, while stored fields data and term frequency vector data writing/reading is handled elsewhere.&lt;/p&gt;

&lt;p&gt;I propose to extend the Codec API to handle this data as well.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12472405">LUCENE-2621</key>
            <summary>Extend Codec to handle also stored fields and term vectors</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="rcmuir">Robert Muir</assignee>
                                <reporter username="ab">Andrzej Bialecki </reporter>
                        <labels>
                        <label>gsoc2011</label>
                        <label>lucene-gsoc-11</label>
                        <label>mentor</label>
                    </labels>
                <created>Tue, 24 Aug 2010 20:24:14 +0100</created>
                <updated>Fri, 10 May 2013 11:43:34 +0100</updated>
                    <resolved>Wed, 16 Nov 2011 19:41:02 +0000</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12920332" author="ab" created="Tue, 12 Oct 2010 21:23:19 +0100"  >&lt;p&gt;.. and norms while we&apos;re at it.&lt;/p&gt;</comment>
                    <comment id="12920335" author="simonw" created="Tue, 12 Oct 2010 21:35:49 +0100"  >&lt;blockquote&gt;&lt;p&gt;.. and norms while we&apos;re at it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;just for the record we should explore if norms could just be a doc payload see &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2186&quot; title=&quot;First cut at column-stride fields (index values storage)&quot;&gt;&lt;del&gt;LUCENE-2186&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="13004796" author="simonw" created="Wed, 9 Mar 2011 21:02:37 +0000"  >&lt;p&gt;FYI - I marked this as gsoc-2011 I think this would make a wonderful project. If any student needs more info go ahead and ask on the dev list. &lt;/p&gt;</comment>
                    <comment id="13006180" author="simonw" created="Sun, 13 Mar 2011 12:06:57 +0000"  >&lt;p&gt;Brief Summary for GSoC Students:&lt;/p&gt;

&lt;p&gt;This issue is about extend Codec to handle also stored fields and term vectors&lt;br/&gt;
This is a very interesting and at the same time very much needed&lt;br/&gt;
feature which involves API Design, Refactoring and in depth&lt;br/&gt;
understanding of how IndexWriter and its internals work. The API which&lt;br/&gt;
needs to be refactored (Codec API) was made to consume PostingLists&lt;br/&gt;
once an in memory index segment is flushed to disc. Yet, to expose&lt;br/&gt;
Stored Fields to this API we need to prepare it to consume data for&lt;br/&gt;
every document while we build the in memory segment. So there is a&lt;br/&gt;
little paradigm missmatch here which needs to be addressed.&lt;/p&gt;</comment>
                    <comment id="13006181" author="simonw" created="Sun, 13 Mar 2011 12:06:58 +0000"  >&lt;p&gt;Brief Summary for GSoC Students:&lt;/p&gt;

&lt;p&gt;This issue is about extend Codec to handle also stored fields and term vectors&lt;br/&gt;
This is a very interesting and at the same time very much needed&lt;br/&gt;
feature which involves API Design, Refactoring and in depth&lt;br/&gt;
understanding of how IndexWriter and its internals work. The API which&lt;br/&gt;
needs to be refactored (Codec API) was made to consume PostingLists&lt;br/&gt;
once an in memory index segment is flushed to disc. Yet, to expose&lt;br/&gt;
Stored Fields to this API we need to prepare it to consume data for&lt;br/&gt;
every document while we build the in memory segment. So there is a&lt;br/&gt;
little paradigm missmatch here which needs to be addressed.&lt;/p&gt;</comment>
                    <comment id="13006223" author="zjshen" created="Sun, 13 Mar 2011 17:11:23 +0000"  >&lt;p&gt;I&apos;ve some questions here to make sure I&apos;m looking into the correct codes:&lt;br/&gt;
When you mentioned Codec API, do you mean the abstract class org.apache.lucene.index.codecs.Codec?&lt;br/&gt;
Term vectors refer to org.apache.lucene.index.TermFreqVector, and it is processed by TermVectorsWriter now, correct?&lt;br/&gt;
But what are the stored fields? I cannot find them immediately.&lt;/p&gt;

&lt;p&gt;BTW, is there any design document of Lucene in the Wiki?&lt;/p&gt;</comment>
                    <comment id="13006439" author="simonw" created="Mon, 14 Mar 2011 14:50:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;When you mentioned Codec API, do you mean the abstract class org.apache.lucene.index.codecs.Codec?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes that is the main entry point. Currently a codec offer a FieldsConsumer which is pulled by the IndexWriter upon a flush request. Codecs are assigned per field and segment via the CodecProvider. So each field can have its own codec and each codec can have a different implementation. Yet, currently we only provide codec support for the reverse index so a codec can customize the term dictionary (TermsEnum would be the API counterpart) and posting lists (DocsEnum / DocsAndPositionsEnum in the API). What this issue tries to do is to open up this API as a general low level customization layer that enables users to also customize how Stored Fields and TermVectors are stored on disk.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Term vectors refer to org.apache.lucene.index.TermFreqVector, and it is processed by TermVectorsWriter now, correct?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes thats true.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But what are the stored fields? I cannot find them immediately.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;there should be a StoredFieldsWriter and a FieldsReader.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;BTW, is there any design document of Lucene in the Wiki?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;nothing that I would call a design document. there are some pages which could be similar to what you are looking for but those might be out of date. You should maybe look int the corresponding issues to find design decisions.&lt;/p&gt;</comment>
                    <comment id="13006440" author="simonw" created="Mon, 14 Mar 2011 14:51:03 +0000"  >&lt;p&gt;I assigned this to me since I would volunteer to mentor this issue. Hope that is ok Andrzej?&lt;/p&gt;</comment>
                    <comment id="13006612" author="ab" created="Mon, 14 Mar 2011 20:09:38 +0000"  >&lt;p&gt;Sure, go ahead.&lt;/p&gt;</comment>
                    <comment id="13114013" author="rcmuir" created="Sat, 24 Sep 2011 18:15:53 +0100"  >&lt;p&gt;Here is a minimal &apos;rote refactor&apos; for stored fields, there is a lot more to do (e.g. filenames/extensions should come from codec, segmentmerger optimizations (bulk merging) should not be in the API but customized by the codec, the codec name (format) of fields should be recorded in the index, we should implement a simpletext version and refactor/generalize, ...)&lt;/p&gt;

&lt;p&gt;but more importantly, I think we need to restructure the class hierarchy: Codec is a per-field thing currently but I think the name &quot;Codec&quot; should represent the entire index... &lt;/p&gt;

&lt;p&gt;maybe what is Codec now should be named FieldCodec? maybe the parts of CodecProvider (e.g. segmentinfosreader, storedfields, etc) should be be moved to this new Codec class? in this world maybe PreFlex codec for example returns its hardcoded representation for every field since in 3.x this stuff is &lt;b&gt;not&lt;/b&gt; per field, and with more of the back compat code refactored down into PreFlex.&lt;/p&gt;

&lt;p&gt;Would be good to come up with a nice class naming/hierarchy that represents reality here.&lt;/p&gt;</comment>
                    <comment id="13114022" author="mikemccand" created="Sat, 24 Sep 2011 18:45:30 +0100"  >&lt;p&gt;Awesome!&lt;/p&gt;

&lt;p&gt;I think, like the postings, we can add a .merge() method, and the impl for that would do bulk-merge when it can?&lt;/p&gt;

&lt;p&gt;On the restructuring, maybe we can go back to a PerFieldCodecWrapper, which is itself a Codec?  This would simplify CodecProvider back to just being a name -&amp;gt; Codec instance provider?  We would still use SegmentCodecs/FieldInfo(s) to compute/record the codecID, though, in theory this could become &quot;private&quot; to PFCW once it&apos;s a Codec again.&lt;/p&gt;</comment>
                    <comment id="13114024" author="rcmuir" created="Sat, 24 Sep 2011 18:51:17 +0100"  >&lt;p&gt;I think so, assuming FieldInfos etc are &lt;b&gt;also&lt;/b&gt; read/written by the codec.&lt;/p&gt;

&lt;p&gt;Then I think PFCW could be an abstract class that writes per-field configuration into the index, but for example PreFlexCodec would &lt;b&gt;not&lt;/b&gt; extend this class, as a 3.x index is the same codec across all fields.&lt;/p&gt;

&lt;p&gt;I think if we do things this way we have a lot more flexibility with backwards compatibility instead of all this if-then-else conditional version-checking code when reading these files... &lt;/p&gt;

&lt;p&gt;Really, for example if someone wanted to make a Codec that reads a lucene 2.x indexes (compressed fields and all) they should be able to do this if we reorganize this right.&lt;/p&gt;</comment>
                    <comment id="13114036" author="rcmuir" created="Sat, 24 Sep 2011 19:23:31 +0100"  >&lt;p&gt;I created a branch (&lt;a href=&quot;https://svn.apache.org/repos/asf/lucene/dev/branches/lucene2621&quot; class=&quot;external-link&quot;&gt;https://svn.apache.org/repos/asf/lucene/dev/branches/lucene2621&lt;/a&gt;) for extending and refactoring the codec API to cover more portions of the index...&lt;/p&gt;

&lt;p&gt;I think it would be really nice to flesh this out for 4.0&lt;/p&gt;</comment>
                    <comment id="13120888" author="ab" created="Wed, 5 Oct 2011 13:32:06 +0100"  >&lt;p&gt;CodecProvider -&amp;gt; Codec and Codec -&amp;gt; FieldCodec makes sense to me. This way the Codec would be responsible for all global index parts (seginfos, fieldinfos), and it would provide API to manage per-field data (FieldCodec), stored fields (FieldsWriter/Reader, perhaps a class to tie these two together), and term vectors (TermVectorsWriter/Reader, again grouped in a class).&lt;/p&gt;

&lt;p&gt;Re. current patch: this looks like a great start. I discovered a problem lurking in SegmentMerger.mergeFields. setMatchingSegmentReaders checks only fieldInfos for compatibility, but it doesn&apos;t check the codecs (and fieldWriter/fieldReader) compatibility. It&apos;s happy then to use the matchingSegmentReader directly, which results in raw documents encoded with one codec being sent as a raw stream to a fieldWriter from another codec.&lt;/p&gt;

&lt;p&gt;Also, SegmentInfo.files() is messy, it should be populated from codecs - as soon as I changed the extension of the stored fields file things exploded because TieredMergePolicy couldn&apos;t find the .fdx file reported by files().&lt;/p&gt;</comment>
                    <comment id="13120899" author="rcmuir" created="Wed, 5 Oct 2011 13:47:27 +0100"  >&lt;p&gt;yeah another alternative name to FieldCodec would be something like PostingsFormat (or similar).&lt;/p&gt;

&lt;p&gt;Because there is a big difference between PreFlex (which is actually a codec), and Memory/Pulsing.&lt;/p&gt;

&lt;p&gt;as far as the current patch: yeah its missing a lot... because as soon as I started digging here I thought, well we have to probably try to fix these codec classes first before going further. Really I would like for some of the stuff like shared docstores to be private to PreFlex codec, part of fixing the files() issue.&lt;/p&gt;

&lt;p&gt;Same with the merging, this bulk copying of index inputs should be in codec as well. Currently its not only wrong as you noted, but makes assumptions about the implementation. But i didn&apos;t want to just shove this into CodecProvider since it doesnt really belong there.&lt;/p&gt;

&lt;p&gt;Finally, I do think the CodecProvider has a place after we fix these names. But I dont think it should be really any more than name -&amp;gt; Codec resolution... currently it does too much. But to fix this, we really want to remove all the special per-field map, etc stuff it has... and this means factoring PerFieldCodecWrapper back out into codecs (in my opinion this should be PerFieldPostingsFormat, and just an &apos;ordinary&apos; Codec). And for that to work correctly, we need FieldInfos reading/writing under codec control so that this per-field stuff can be private to PerFieldPostingsFormat....&lt;/p&gt;

&lt;p&gt;So there is a ton to do, although I made a branch I&apos;m kinda concerned about doing a bunch of renaming and keeping things in sync... maybe I should ignore this though. But for now I&apos;ve been trying to figure out any way we can do this in individual incremental steps/issues directly on trunk, its always nice to make progress that way.&lt;/p&gt;</comment>
                    <comment id="13120916" author="ab" created="Wed, 5 Oct 2011 13:58:04 +0100"  >&lt;p&gt;IMHO you could merge the branch back into trunk, we are allowed to experiment and the current patch already improves the API and shows what to do next.&lt;/p&gt;</comment>
                    <comment id="13121016" author="mikemccand" created="Wed, 5 Oct 2011 15:47:09 +0100"  >&lt;blockquote&gt;&lt;p&gt;IMHO you could merge the branch back into trunk,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;This baby step (rote move of stored fields under codec control) is great.&lt;/p&gt;</comment>
                    <comment id="13121048" author="rcmuir" created="Wed, 5 Oct 2011 16:27:43 +0100"  >&lt;p&gt;Well technically its Codec*Provider* control, which is global, until we fix the codec hierarchy.&lt;/p&gt;

&lt;p&gt;But you can also subclass segmentinfosreader/writer in the same expert way (even harder/impossible to &quot;fix&quot;), so how about for now i just mark these methods &quot;expert&quot;, merge, and followup with an issue to fix the codec hierarchy? (and later we need to make the apis more general and all these other things)&lt;/p&gt;</comment>
                    <comment id="13121095" author="rcmuir" created="Wed, 5 Oct 2011 17:16:32 +0100"  >&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3490&quot; title=&quot;Restructure codec hierarchy&quot;&gt;&lt;del&gt;LUCENE-3490&lt;/del&gt;&lt;/a&gt; to try to restructure our current &quot;Codec&quot; idea so that we can put more of the index underneath it.&lt;/p&gt;</comment>
                    <comment id="13145771" author="rcmuir" created="Mon, 7 Nov 2011 20:27:14 +0000"  >&lt;p&gt;OK I think the stored fields are all cleaned up in the lucene2621 branch: the issues Andrzej encountered&lt;br/&gt;
when trying to extend it should no longer be an issue: fdx/fdt are no longer in IndexFileNames (but codec-private),&lt;br/&gt;
codecs can override how merging happens for stored fields (the default is just the obvious impl),&lt;br/&gt;
the indexinput/output &quot;raw&quot; methods for bulk merging are removed from the abstract API and only &lt;br/&gt;
inside DefaultFieldsReader/Writer, DefaultFieldsWriter overrides merge() and uses bulk optimisations &lt;br/&gt;
when the paired-up reader is also a DefaultFieldsReader&lt;/p&gt;

&lt;p&gt;Before merging to trunk, i think we need a SimpleText stored fields implementation to ensure everything is ok... &lt;br/&gt;
I&apos;ll try to do this next.&lt;/p&gt;</comment>
                    <comment id="13146616" author="rcmuir" created="Tue, 8 Nov 2011 22:41:16 +0000"  >&lt;p&gt;All tests pass with the new simpletext stored fields impl: I&apos;d like to merge the branch to trunk.&lt;/p&gt;

&lt;p&gt;attached is a patch between trunk and branch.&lt;/p&gt;</comment>
                    <comment id="13146634" author="ab" created="Tue, 8 Nov 2011 23:05:55 +0000"  >&lt;p&gt;+1 looks good (as far as I can tell!), even SegmentMerger starts making sense now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13146955" author="mikemccand" created="Wed, 9 Nov 2011 11:38:29 +0000"  >&lt;p&gt;+1!  Very exciting to finally have stored fields under codec control...&lt;/p&gt;</comment>
                    <comment id="13150785" author="rcmuir" created="Tue, 15 Nov 2011 21:18:25 +0000"  >&lt;p&gt;Attached is a new patch between trunk and branch. I think its at a point ready for merging.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;term vectors and fieldinfos move to codec.&lt;/li&gt;
	&lt;li&gt;segmentinfos is moved to codec (before you could only realistically tweak a few things).&lt;/li&gt;
	&lt;li&gt;term vectors are cut over to flex apis&lt;/li&gt;
	&lt;li&gt;much better testing of term vectors in checkindex.&lt;/li&gt;
	&lt;li&gt;added simpletext impls of term vectors, fieldinfos, and segmentinfos.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After this I would propose closing this issue and opening followup issues for:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;make a new more efficient term vector implementation for 4.0, the existing one would go to preflex, and preflex impl should reorder the terms correctly to UTF8 order (this is a bug all along in trunk, not caused here!)&lt;/li&gt;
	&lt;li&gt;see if we can remove the global .fnx file completely, as its not per-segment and i&apos;m not sure its totally necessary, perhaps the field number consistency can be achieved with another mechanism. Otherwise, we should add a codec hack/hook at least so that preflexRW can write segments without .fnx files.&lt;/li&gt;
	&lt;li&gt;make preflex implementations of the other various reader/writers so that our 4.0 impls are clean and don&apos;t contain backwards compatibility code, and so that we have more realistic testing of backwards with PreFlexRW.&lt;/li&gt;
	&lt;li&gt;allow adding offsets to the postings lists impls either startOffset/endOffset() or via attribute like term vectors do in this patch, so that a D&amp;amp;Penum can retrieve the offsets at a position. this could make highlighting much faster without having to use vectors.&lt;/li&gt;
	&lt;li&gt;try to make a few other things like deletes extendable via codec&lt;/li&gt;
	&lt;li&gt;figure out a good design to cut over norms to DocValues.&lt;/li&gt;
	&lt;li&gt;add a SimpleTextDocValues, its sorely needed.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13151578" author="markrmiller@gmail.com" created="Wed, 16 Nov 2011 22:26:05 +0000"  >&lt;p&gt;Nice!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10032">
                <name>Blocker</name>
                                                <inwardlinks description="is blocked by">
                            <issuelink>
            <issuekey id="12502173">LUCENE-2985</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                        <issuelinktype id="12310010">
                <name>Incorporates</name>
                                <outwardlinks description="incorporates">
                            <issuelink>
            <issuekey id="12525855">LUCENE-3490</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12528687">LUCENE-3535</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12499259">LUCENE-2935</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12502977" name="LUCENE-2621.patch" size="489056" author="rcmuir" created="Tue, 8 Nov 2011 22:41:16 +0000" />
                    <attachment id="12496367" name="LUCENE-2621_rote.patch" size="53007" author="rcmuir" created="Sat, 24 Sep 2011 18:15:53 +0100" />
                    <attachment id="12503795" name="LUCENE-2621_tv_fi_si.patch" size="820863" author="rcmuir" created="Tue, 15 Nov 2011 21:18:25 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 12 Oct 2010 20:35:49 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3945</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25071</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>