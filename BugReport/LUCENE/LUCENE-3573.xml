<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 12:58:13 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3573/LUCENE-3573.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3573] TaxonomyReader.refresh() is broken, replace its logic with reopen(), following IR.reopen pattern</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3573</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;When recreating the taxonomy index, TR&apos;s assumption that categories are only added does not hold anymore.&lt;br/&gt;
As result, calling TR.refresh() will be incorrect at best, but usually throw an AIOOBE.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12531324">LUCENE-3573</key>
            <summary>TaxonomyReader.refresh() is broken, replace its logic with reopen(), following IR.reopen pattern</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png">Resolved</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="doronc">Doron Cohen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Nov 2011 14:24:01 +0000</created>
                <updated>Thu, 17 Nov 2011 12:31:55 +0000</updated>
                    <resolved>Thu, 17 Nov 2011 12:31:55 +0000</resolved>
                                                            <component>modules/facet</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13149653" author="doronc" created="Mon, 14 Nov 2011 14:32:37 +0000"  >&lt;p&gt;Attached patch for trunk adds two tests:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;one of them is opening a new TR and passes&lt;/li&gt;
	&lt;li&gt;the other is refreshing the TR and fails.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13149661" author="shaie" created="Mon, 14 Nov 2011 14:55:55 +0000"  >&lt;p&gt;+1. I think that we should nuke refresh() and adopt the IR approach, even though I don&apos;t like the &apos;maybe&apos; and &apos;if&apos;, might as well make the API consistent. So instead of refresh() we&apos;ll have a static TR.openIfChanged that either returns null (no changes, or the taxonomy wasn&apos;t recreated) or a new instance in case it was recreated.&lt;/p&gt;

&lt;p&gt;Note that unlike IndexReader, if the taxonomy index wasn&apos;t recreated, openIfChanged will modify the internal state of TR. That&apos;s ok since the taxonomy index was built for it: existing TR instances (that weren&apos;t refreshed) won&apos;t be affected as they won&apos;t know about the new categories (and taxonomy index doesn&apos;t support deletes) and the caller can use the same TR instance in that case.&lt;/p&gt;

&lt;p&gt;Whatever we end up doing, we should remove refresh(). Even though we&apos;re not committed to back-compat yet (it&apos;s all experimental), I think it is dangerous if we&apos;ll simply modify refresh() behavior, because users may not be aware of the change. So a new method is a must.&lt;/p&gt;

&lt;p&gt;Besides that, the test looks good. Was there any reason to add it to TestTaxonomyCombined?&lt;/p&gt;</comment>
                    <comment id="13149684" author="doronc" created="Mon, 14 Nov 2011 15:24:41 +0000"  >&lt;p&gt;I agree about keeping the same notions as IR. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;returns null (no changes, or the taxonomy wasn&apos;t recreated) &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In fact I was thinking of a different &quot;contract&quot;.&lt;/p&gt;

&lt;p&gt;So we have two approaches here for the returned value:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Option A:
	&lt;ol&gt;
		&lt;li&gt;&lt;b&gt;new TR&lt;/b&gt; - if the taxonomy was recreated.&lt;/li&gt;
		&lt;li&gt;&lt;b&gt;null&lt;/b&gt; - if the taxonomy was either not modified or just grew.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Option B:
	&lt;ol&gt;
		&lt;li&gt;&lt;b&gt;new TR&lt;/b&gt; - if the taxonomy was modified (either recreated or just grew)&lt;/li&gt;
		&lt;li&gt;&lt;b&gt;null&lt;/b&gt; - if the taxonomy was not modified.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Option A is simpler to implement, but I think it has two drawbacks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;it is confusingly different from that of IR&lt;/li&gt;
	&lt;li&gt;the fact that the TR was refreshed is hidden from the caller.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Option B is a bit more involved to implement:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;would need to copy arrays&apos; data from old TR to new one in case the taxonomy only grew&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I started to implement option B but now rethinking this...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Was there any reason to add it to TestTaxonomyCombined?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point, should probably move this to TestDirectoryTaxonomyReader.&lt;/p&gt;</comment>
                    <comment id="13149687" author="doronc" created="Mon, 14 Nov 2011 15:30:55 +0000"  >&lt;p&gt;One more thing &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In approach B, the fact that the taxonomy just grew simply allows an optimization (read only the new ordinals), and so it is not a part of the API logic, and the only logic is - was the taxonomy modified or not.&lt;/li&gt;
	&lt;li&gt;In approach A, this fact is part of the API logic.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13149737" author="shaie" created="Mon, 14 Nov 2011 16:47:09 +0000"  >&lt;p&gt;My thinking is that today refresh() modifies the internal state, and does so in an optimized manner (however I think we thought there might be concurrency issues with it). And people (whoever they are) got used to it. And the TaxonomyReader does not imply in any way that it is an index (i.e. we&apos;ve been thinking about implementing the taxonomy as a serialized FST maybe).&lt;/p&gt;

&lt;p&gt;So in fact, let&apos;s not call it openIfChanged, because may not be meaningful. We can call it reload() maybe (just to have a better name). Now the question is whether we want to trust javadocs to note that the returned value may not be equals to the given one (ala the old IndexReader.reopen()), or follow the same IR concept where reload() is static.&lt;/p&gt;

&lt;p&gt;If we want to follow IR semantics fully, then option B is the right one. But can it be done in an optimized manner? I bet we won&apos;t have any concurrency issues with it ...&lt;/p&gt;</comment>
                    <comment id="13150229" author="shaie" created="Tue, 15 Nov 2011 04:15:30 +0000"  >&lt;p&gt;I thought about it more, and I really think that we should go with option A. The common case is that the taxonomy index is not recreated, however it may be updated very frequently. TR.refresh() denotes exactly that &amp;#8211; it refreshes the internal state of the TaxonomyReader. This method must be very efficient. I.e., with NRT, people rely on IR.openIfChanged to only open new segments, which is what DTR.refresh() does (calls IR.openIfChanged).&lt;/p&gt;

&lt;p&gt;So putting the name aside, we should have the method X() which either returns null (and updates or not the internal state) or returns a new TR. Unfortunately refresh() is not a bad name (reload() sounds more drastic and less efficient), so maybe refreshIfChanged?&lt;/p&gt;</comment>
                    <comment id="13150279" author="doronc" created="Tue, 15 Nov 2011 07:29:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;So in fact, let&apos;s not call it openIfChanged, because may not be meaningful.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes this bothered me too. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;so maybe refreshIfChanged?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;... let&apos;s stick to refresh() (but...)&lt;/p&gt;

&lt;p&gt;Current refresh impl is efficient in that (1) arrays only grow if needed (2) caches only cleaned from wrong &apos;invalid ordinals&apos;. In that, it relies on that the taxonomy can only grow (unless it is recreated, hence this issue).&lt;/p&gt;

&lt;p&gt;So I now think it would be best to modify slightly refresh() - in case it detects that the taxonomy was created, it will throw a new (checked) exception - telling the application that this TR cannot be refreshed but the app can open a new TR.&lt;/p&gt;

&lt;p&gt;This way there is no 3-way logic - either the TR was refreshed or it was not.&lt;/p&gt;

&lt;p&gt;And while we are at this, refresh() is void. I think it would be useful to return boolean, indicating whether any refresh took place.&lt;/p&gt;</comment>
                    <comment id="13150286" author="shaie" created="Tue, 15 Nov 2011 07:41:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;This way there is no 3-way logic - either the TR was refreshed or it was not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And while we are at this, refresh() is void. I think it would be useful to return boolean, indicating whether any refresh took place.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1.&lt;/p&gt;</comment>
                    <comment id="13150503" author="doronc" created="Tue, 15 Nov 2011 14:05:25 +0000"  >&lt;p&gt;Patch, in principle ready to commit, though I plan to go through it once more.&lt;/p&gt;

&lt;p&gt;In this patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;new tests moved to TestDirectoryTaxonomyReader&lt;/li&gt;
	&lt;li&gt;an exception added: InconsistentTaxonomyException&lt;/li&gt;
	&lt;li&gt;when the reader cannot refresh because the taxonomy was recreated since the last time open/refresh, that exception is thrown and the application should open a fresh taxonomy reader.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Bumped into 3 TODO&apos;s while working on this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FilterIndexReader does not implement getCommitUserData(). Once this is fixed can resolvethe TODO in TestIndexClose. I&apos;ll open an issue later.&lt;/li&gt;
	&lt;li&gt;TR.refresh() should return a boolean indicating anything was changed (issue).&lt;/li&gt;
	&lt;li&gt;DTW.rollback() seems wrong to me - it rollback the internal IW, which also closes it, but then it refreshes its internal TR, seems wrong...&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13151057" author="shaie" created="Wed, 16 Nov 2011 06:34:20 +0000"  >&lt;p&gt;Patch looks good ! Few minor comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;DirTW: shoudl --&amp;gt; should&lt;/li&gt;
	&lt;li&gt;Can we name &apos;taxoCreateTimeToCommit&apos; just &apos;taxoCreateTime&apos;?&lt;/li&gt;
	&lt;li&gt;OpenMode.CREATE.equals(openMode) can be OpenMode.CREATE == openMode&lt;/li&gt;
	&lt;li&gt;Perhaps DirTW.commit() can call commit(null) to reduce code duplication? IndexWriter anyway calls commit(null) in its commit(), so it&apos;s not an error to call iw.commit(null).
	&lt;ul&gt;
		&lt;li&gt;Same for prepareCommit()&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;I think that DirectoryTaxonomyReader.DIR_TAXONOMY_CREATE_TIME_PROP should be in DirTW since it is the one writing it. We also have this notion in other places in the code, i.e. TermInfosWriter declares the format constants, and other classes reference them.
	&lt;ul&gt;
		&lt;li&gt;Also, how about renaming it to INDEX_CREATE_TIME, since technically it is the index that has been recreated. This is to avoid confusion when storing this time in e.g. the search index&apos;s commit data, which we do in order to synchronize the taxo and search indices.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Maybe for debugging add a message to InconsistentTaxonomyException which will tell us that the taxo has been recreated + the recreate time?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;About the other comments:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;FilterIndexReader does not implement getCommitUserData(). Once this is fixed can resolvethe TODO in TestIndexClose. I&apos;ll open an issue later.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We need a separate issue to write a test which ensures FilterIndexReader overrides all non-final methods of IndexReader. But why not fix FIR to override getCommitData in this issue? It&apos;s a simple fix, no need for the TODO (or any change to TestIndexClose) and it is technically related to the issue, as it exposes a bug in FIR.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;TR.refresh() should return a boolean indicating anything was changed (issue).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I prefer that we change the method signature once. Why not modify it to return a boolean? Isn&apos;t that a simple change?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;DTW.rollback() seems wrong to me&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I added it when TW was changed to extend TwoPhaseCommit. I&apos;ll take a look. Thanks for raising that.&lt;/p&gt;</comment>
                    <comment id="13151089" author="shaie" created="Wed, 16 Nov 2011 08:31:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;DTW.rollback() seems wrong to me&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I modified the method impl to call close() instead of refreshReader() and added an appropriate test to DirTWTest to assert that following rollback, no more actions are allowed on DirTW.&lt;/p&gt;

&lt;p&gt;Separately, I think that we should add ensureOpen() to DirTW so that if you call its API after rollback()/close(), you get a proper exception rather than random exceptions (like NPE). I will open an issue for that (and cover the rollback changes there too).&lt;/p&gt;</comment>
                    <comment id="13151177" author="doronc" created="Wed, 16 Nov 2011 12:59:46 +0000"  >&lt;p&gt;Thanks for the review and comments Shai, and also thanks for taking care of DTW.rollback() in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3579&quot; title=&quot;DirectoryTaxonomyWriter should throw a proper exception if it was closed&quot;&gt;&lt;del&gt;LUCENE-3579&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I fixed the typos and the == as suggested.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;name &apos;taxoCreateTimeToCommit&apos; just &apos;taxoCreateTime&apos;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Given your further comment renamed it to &apos;taxoIndexCreateTime&apos;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Perhaps DirTW.commit() can call commit(null)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I considered this when first coding, as it would have compacted the code. But felt uncomfortable (still do) relying on a non documented behavior of IW.commit(null).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;DirectoryTaxonomyReader.DIR_TAXONOMY_CREATE_TIME_PROP should be in DirTW + renaming to INDEX_CREATE_TIME&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;add a message to InconsistentTaxonomyException&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But why not fix FIR to override getCommitData in this issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done. Now it feels a bit wrong that this will not appear in lucene/CHANGES since this issue is in lucene/contrib. Guess this is not too bad...?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;TR.refresh() should return a boolean indicating anything was changed (issue). I prefer that we change the method signature once...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. Added a test case in TestDirectoryTaxonomyReader for this.&lt;/p&gt;</comment>
                    <comment id="13151188" author="doronc" created="Wed, 16 Nov 2011 13:27:23 +0000"  >&lt;p&gt;Hmm, now that there is a test for LTW.rollback() my changes fail LTW&apos;s testRollback() because LTW.close() now may call IW.commit(Map) (which it did not do before my changes).&lt;/p&gt;

&lt;p&gt;For fixing this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;added private doClose() which closes IW and nullifies it, and calls closeResources().&lt;/li&gt;
	&lt;li&gt;rollback() calls doClose() instead of close().&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also, rollback() now made synchronized.&lt;/p&gt;</comment>
                    <comment id="13151237" author="shaie" created="Wed, 16 Nov 2011 14:41:07 +0000"  >&lt;blockquote&gt;
&lt;p&gt;For fixing this:&lt;/p&gt;

&lt;p&gt;    added private doClose() which closes IW and nullifies it, and calls closeResources().&lt;br/&gt;
    rollback() calls doClose() instead of close().&lt;/p&gt;

&lt;p&gt;Also, rollback() now made synchronized.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good catch. It is dangerous that rollback is not sync&apos;ed when commit/prepare/close are.&lt;/p&gt;

&lt;p&gt;+1 to commit !&lt;/p&gt;</comment>
                    <comment id="13151272" author="doronc" created="Wed, 16 Nov 2011 15:40:40 +0000"  >&lt;p&gt;Final patch.&lt;/p&gt;

&lt;p&gt;Also updated the user-guide about refresh() behavior.&lt;/p&gt;

&lt;p&gt;Removed the changes entry - for facet this would go only into 3x.&lt;/p&gt;

&lt;p&gt;Planning to commit this soon.&lt;/p&gt;</comment>
                    <comment id="13152024" author="doronc" created="Thu, 17 Nov 2011 12:31:55 +0000"  >&lt;p&gt;Committed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;r1202754 - trunk&lt;/li&gt;
	&lt;li&gt;r1203165 - 3x&lt;/li&gt;
&lt;/ul&gt;
</comment>
                </comments>
                    <attachments>
                    <attachment id="12503895" name="LUCENE-3573.patch" size="17526" author="doronc" created="Wed, 16 Nov 2011 15:40:40 +0000" />
                    <attachment id="12503740" name="LUCENE-3573.patch" size="19349" author="doronc" created="Tue, 15 Nov 2011 14:05:24 +0000" />
                    <attachment id="12503622" name="LUCENE-3573.patch" size="2958" author="doronc" created="Mon, 14 Nov 2011 14:32:36 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 14 Nov 2011 14:55:55 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>217061</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24124</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>