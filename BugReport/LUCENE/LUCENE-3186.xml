<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 12:57:50 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3186/LUCENE-3186.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3186] DocValues type should be recored in FNX file to early fail if user specifies incompatible type</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3186</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Currently segment merger fails if the docvalues type is not compatible across segments. We already catch this problem if somebody changes the values type for a field within one segment but not across segments. in order to do that we should record the type in the fnx fiel alone with the field numbers.&lt;/p&gt;

&lt;p&gt;I marked this 4.0 since it should not block the landing on trunk&lt;/p&gt;</description>
                <environment></environment>
            <key id="12509692">LUCENE-3186</key>
            <summary>DocValues type should be recored in FNX file to early fail if user specifies incompatible type</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="simonw">Simon Willnauer</assignee>
                                <reporter username="simonw">Simon Willnauer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Jun 2011 10:41:42 +0100</created>
                <updated>Fri, 10 May 2013 11:43:17 +0100</updated>
                    <resolved>Mon, 10 Oct 2011 16:28:50 +0100</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13046467" author="rcmuir" created="Thu, 9 Jun 2011 12:15:38 +0100"  >&lt;p&gt;do we really need to do this? I guess also looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3187&quot; title=&quot;Store NumericField precisionStep in fnx file&quot;&gt;LUCENE-3187&lt;/a&gt;, I think I&apos;m against this trend.&lt;/p&gt;

&lt;p&gt;Shall we put analyzer classnames in there too? If we are going to put docvalues type and precision step, well then i want the stopwords file in the fnx file too!&lt;/p&gt;

&lt;p&gt;At some point, if a user is going to shoot themselves in the foot, we simply cannot stop them, and I don&apos;t think its our job to.&lt;/p&gt;</comment>
                    <comment id="13046479" author="thetaphi" created="Thu, 9 Jun 2011 12:39:45 +0100"  >&lt;p&gt;Hi Robert,&lt;/p&gt;

&lt;p&gt;I am also not really happy with this trend. I just opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3187&quot; title=&quot;Store NumericField precisionStep in fnx file&quot;&gt;LUCENE-3187&lt;/a&gt; to start a discussion. In my opinion we should improve documentation instead.&lt;/p&gt;</comment>
                    <comment id="13046481" author="simonw" created="Thu, 9 Jun 2011 12:43:28 +0100"  >&lt;p&gt;I think for this issue we can compute that info at IW open time. we can simply run through the FIs and prepopulate the info. I think this is better than redundantly store this info.&lt;/p&gt;</comment>
                    <comment id="13046602" author="mikemccand" created="Thu, 9 Jun 2011 16:06:43 +0100"  >&lt;p&gt;I think there are a few separate questions here...&lt;/p&gt;

&lt;p&gt;Today, on doc values branch, if you mix up your doc values, ie a field&lt;br/&gt;
&quot;foo&quot; is at first indexed as a FLOAT_32 and then later you change your&lt;br/&gt;
mind and later docs are index field &quot;foo&quot; as BYTES_FIXED_STRAIGHT,&lt;br/&gt;
then this is bad news right now because everything will index fine,&lt;br/&gt;
you can close your IW, etc., but at some later time merges will hit&lt;br/&gt;
unrecoverable exceptions.  You&apos;ll have no choice but to fully rebuild&lt;br/&gt;
the index, which is rather awful.&lt;/p&gt;

&lt;p&gt;However, this is true even for cases you would expect to work, eg say&lt;br/&gt;
&quot;foo&quot; was BYTES_FIXED_STRAIGHT but then later you decided you will&lt;br/&gt;
want to sort on this field and so you use BYTES_FIXED_SORTED.  (Simon:&lt;br/&gt;
this also results in exception I think...?).  Ideally we should do the&lt;br/&gt;
right thing here and &quot;upgrade&quot; the BYTES_FIXED_STRAIGHT to&lt;br/&gt;
BYTES_FIXED_SORTED (I think) &amp;#8211; Simon is there an issue open for this?&lt;/p&gt;

&lt;p&gt;So, I think the first question here is: which cases should be merged&lt;br/&gt;
&quot;properly&quot; and which should be considered &quot;an error&quot;?  Probably we have&lt;br/&gt;
to work out the full matrix...&lt;/p&gt;

&lt;p&gt;Then the second question is, for the &quot;error&quot; cases (if any!),&lt;br/&gt;
can/should we detect this up front, as you&apos;re indexing?&lt;/p&gt;

&lt;p&gt;Then third question is, if we want to detect up front, do we do that&lt;br/&gt;
w/ fnx file or do we do that on init of IW (= no index change).&lt;/p&gt;</comment>
                    <comment id="13046604" author="rcmuir" created="Thu, 9 Jun 2011 16:14:20 +0100"  >&lt;blockquote&gt;
&lt;p&gt;So, I think the first question here is: which cases should be merged&lt;br/&gt;
&quot;properly&quot; and which should be considered &quot;an error&quot;? Probably we have&lt;br/&gt;
to work out the full matrix...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;this is all implementation details of docvalues, that it must deal with during merging.&lt;br/&gt;
I think it should work out the &quot;LCD&quot; and merge to that.&lt;/p&gt;

&lt;p&gt;This is no different than if i have a field with all 8 character terms and then i add a 10-character term,&lt;br/&gt;
sure my impl/codec&apos;s encoding could internally rely upon the the fact all terms are 8 chars, but it must transparently change&lt;br/&gt;
its encoding to then support both 8 and 10 character terms and not throw an error.&lt;/p&gt;

&lt;p&gt;If you mix up your doc values with ints and floats and bytes, isnt the least common denominator always bytes?&lt;br/&gt;
(just encode the int as 4 bytes or whatever).&lt;/p&gt;

&lt;p&gt;So in other words, i think its up to docvalues to change its encoding to support the LCD, which might mean&lt;br/&gt;
downgrading ints to bytes or whatever, my only opinion is that it should never &apos;create&apos; data (this was my issue with fake norms,&lt;br/&gt;
lets not do that).&lt;/p&gt;</comment>
                    <comment id="13116330" author="simonw" created="Wed, 28 Sep 2011 11:37:51 +0100"  >&lt;p&gt;This issue still remains and we need to solve this in order to move forward towards 4.0. Yet, I am still banging my head against the wall about how to really fix this.&lt;br/&gt;
Promoting up values that are compatible should be doable like Int_32 and Int_8 should be promoted to Int_32 likewise for float &amp;amp; double. Regarding byte values this is kind of tricky. Var length vs Fixed length is still doable but what if something is sorted. I don&apos;t think we should promote something to sorted in any case. The problem here is not just merging but also reading, I can not pull a sorted source from a non-sorted DV field which would cause confusion on the user level.&lt;/p&gt;

&lt;p&gt;I think we should compromise here and try to promote what we can like Ints, Floats and unsorted bytes (incompatible can go to variable length simply) and for Sorted if something is not sorted we should just drop the entire field. SortedVar &amp;amp; SortedFixed can be promoted to SortedVar and everything should be fine IMO. &lt;/p&gt;

&lt;p&gt;One other idea would be removing the flexibility to set the actual type on the user level and decide at indexing time to use var vs. fixed and straight vs. deref and move the sorting decision to the codec ie. if you want to sort then your codec needs to provide sorting otherwise its not sorted. We could then treat everything as bytes and convert at load time. Like you say getSource(Int | Float | Bytes) and the codec decides how to convert each value to a float / int / byte and fails if not possible?&lt;/p&gt;</comment>
                    <comment id="13116334" author="mikemccand" created="Wed, 28 Sep 2011 11:50:03 +0100"  >&lt;p&gt;Remember we are talking about the exception case here (app mis-uses&lt;br/&gt;
the API by mixing up types).&lt;/p&gt;

&lt;p&gt;So I think a best-effort approach is fine: we &quot;cast up&quot; when we can,&lt;br/&gt;
but when we cannot we should silently drop the inconsistent values&lt;br/&gt;
(better, I think, than getting an unrecoverable exception on merge).&lt;/p&gt;

&lt;p&gt;Having indexer/searcher decide what&apos;s best is an interesting&lt;br/&gt;
option... though, I think sorted or not should be specified in the&lt;br/&gt;
Field and not codec?  Ie, I think that&apos;s higher up than the codec (all&lt;br/&gt;
codecs should be able to sort, or not, my byte[] DV field).&lt;/p&gt;</comment>
                    <comment id="13116544" author="simonw" created="Wed, 28 Sep 2011 16:38:47 +0100"  >&lt;p&gt;here is an initial patch that promotes the following types:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;all permutations of int8, int16, int32, int64 and packed ints&lt;/li&gt;
	&lt;li&gt;all permutations of float32 and float 64&lt;/li&gt;
	&lt;li&gt;all permutations of var_deref_bytes, var_straight_bytes, fixed_deref_bytes, fixed_straight_bytes&lt;/li&gt;
	&lt;li&gt;all permuations of sorted_fixed_bytes and sorted_var_bytes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;general rule here is that var wins over fixed and straight wins over deref. For int types variable ints wins over all other fixed types (according to var wins over fixed). &lt;/p&gt;

&lt;p&gt;if those types are mixed up like float32 and int32 this patch drops the docvalues field. &lt;/p&gt;

&lt;p&gt;this patch is still very rough and has one rather critical nocommit in SegmentMerger since I am changeing the FieldInfo for a field if I promote the type or drop the dv field which essentially means that I need to write the FI after this has been done.&lt;/p&gt;</comment>
                    <comment id="13118497" author="simonw" created="Fri, 30 Sep 2011 23:01:30 +0100"  >&lt;p&gt;any comments on this?&lt;/p&gt;</comment>
                    <comment id="13120782" author="mikemccand" created="Wed, 5 Oct 2011 10:49:28 +0100"  >&lt;p&gt;I hit several test failures w/ the patch, all from same exc, eg:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  ant test-core -Dtestcase=TestIndexWriterDelete -Dtestmethod=testDeleteAllSlowly -Dtests.seed=-8b03171493c8e71:-20c60f02979a36ec:-485ea5dac6836e33
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I didn&apos;t dig...&lt;/p&gt;

&lt;p&gt;Net/net this approach looks good!  Though I have to say it&apos;s hard to&lt;br/&gt;
follow all the numerous tied-together classes we now have for&lt;br/&gt;
DocValues... I find myself getting &quot;lost&quot; but I don&apos;t know how to&lt;br/&gt;
simplify it.&lt;/p&gt;

&lt;p&gt;Random feedback:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;About the nocommit in SegmentMerger: I think writing FIS after&lt;br/&gt;
    merge is OK?  In theory nothing should care?  Anything that needs&lt;br/&gt;
    FIS during merging should receive the object, not load it from&lt;br/&gt;
    the directory...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;You can remove the TODO in DocValuesConsumer.merge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Make sure we mark TypePromoter as @lucene.internal.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;If we hit exc inside FixedStraightBytesImpl.merge, we are still&lt;br/&gt;
    setting merge=true; is finish then called, up above?  (At which&lt;br/&gt;
    point we are going to try to write to the closed file).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Maybe rename that bool to &quot;merged&quot; or &quot;didMerge&quot; or something?&lt;br/&gt;
    &quot;merge&quot; sounds like it&apos;s an imperative command.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The jdocs for DocValuesConsumer.merge say &quot;Merging segments out of&lt;br/&gt;
    order is not supported&quot;, but you just mean segments must arrive in&lt;br/&gt;
    sorted order right?  (Ie, TieredMP merges non-sequential segments,&lt;br/&gt;
    which we have been calling out-of-order merge).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Since DocValuesConsumer.merge ignores the incoming IndexDocValues&lt;br/&gt;
    (a MultiIndexDocValues), do we even need to pass that in...?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It&apos;s sort of confusing how we have a DocValuesConsumer.MergeState&lt;br/&gt;
    (holds one segment&apos;s reader) and the oal.index.codecs.MergeState&lt;br/&gt;
    (references all segments); maybe rename the former to&lt;br/&gt;
    SingleReaderMergeState?  SubMergeState?  (Something to indicate it&lt;br/&gt;
    just covers one sub reader at a time).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It looks like we don&apos;t handle the case of merging segs when a&lt;br/&gt;
    given field is always FixedStraightBytes but the size had changed&lt;br/&gt;
    from one seg to another?  (We throw IAE in&lt;br/&gt;
    FixedStraightBytesImpl.merge).  Are there other cases that will&lt;br/&gt;
    lead to &quot;late binding&quot; exc during merge?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In TypePromoter, instead of &quot;promoted.flags &amp;amp; ~(1 &amp;lt;&amp;lt; 3)&quot; can you&lt;br/&gt;
    name that constant bit mask?  EG IS_BYTES or NOT_NUMERIC&lt;br/&gt;
    or something? &lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;With this patch, does this mean we can type-promote on the fly?&lt;br/&gt;
    Ie, if I make a SlowMRWrapper, and pull its perDocValues, we will&lt;br/&gt;
    present the promoted type (across all segments) correctly?  And&lt;br/&gt;
    when the user looks up the value for a certain docID, we promote&lt;br/&gt;
    it as needed?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Typo in comment in Floats.java: &quot;only bulk merge is value type is&lt;br/&gt;
    the same otherwise size differs&quot;: change &quot;is&quot; to &quot;if&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Can we rename Writer.setNextEnum -&amp;gt; Writer.setNextMergeEnum?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13123562" author="simonw" created="Sat, 8 Oct 2011 21:50:07 +0100"  >&lt;p&gt;attaching current state. I updated the latest patch to trunk and fixed several issues...&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;You can remove the TODO in DocValuesConsumer.merge &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Make sure we mark TypePromoter as @lucene.internal.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;f we hit exc inside FixedStraightBytesImpl.merge, we are still&lt;br/&gt;
setting merge=true; is finish then called, up above? (At which&lt;br/&gt;
point we are going to try to write to the closed file).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;no, this merge only is taken into account if the merge is successful. in the case of an exception we don&apos;t call finish. I renamed it to hasMerged.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The jdocs for DocValuesConsumer.merge say &quot;Merging segments out of&lt;br/&gt;
order is not supported&quot;, but you just mean segments must arrive in&lt;br/&gt;
sorted order right? (Ie, TieredMP merges non-sequential segments,&lt;br/&gt;
which we have been calling out-of-order merge).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;this is bogus (leftover from branch) I removed it&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since DocValuesConsumer.merge ignores the incoming IndexDocValues&lt;br/&gt;
(a MultiIndexDocValues), do we even need to pass that in...?&lt;/p&gt;&lt;/blockquote&gt; 
&lt;p&gt;I fixed this too. I don&apos;t create this MIDV anymore and use the readers directly which I need anyway for type promotion.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It looks like we don&apos;t handle the case of merging segs when a&lt;br/&gt;
given field is always FixedStraightBytes but the size had changed&lt;br/&gt;
from one seg to another? (We throw IAE in&lt;br/&gt;
FixedStraightBytesImpl.merge). Are there other cases that will&lt;br/&gt;
lead to &quot;late binding&quot; exc during merge?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;FixedStraightBytes with different sizes are promoted to VarStraightBytes so this is not an issue.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;With this patch, does this mean we can type-promote on the fly?&lt;br/&gt;
Ie, if I make a SlowMRWrapper, and pull its perDocValues, we will&lt;br/&gt;
present the promoted type (across all segments) correctly? And&lt;br/&gt;
when the user looks up the value for a certain docID, we promote&lt;br/&gt;
it as needed?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;actually yes! I implemented this in the patch but need to test it though.&lt;/p&gt;

&lt;p&gt;the current patch has one problem, if you add three incompatible types A,B,C and Segs with A &amp;amp; B get merged (and dropped) but segs containing C are not in that merge those the type will be C eventually. but this seems ok to me though.&lt;/p&gt;

&lt;p&gt;still some nocommits left but I think we are getting close &lt;/p&gt;</comment>
                    <comment id="13123985" author="simonw" created="Mon, 10 Oct 2011 11:14:40 +0100"  >&lt;p&gt;next iteration. Added JavaDoc, removed all nocommits and fixed all tests.&lt;/p&gt;

&lt;p&gt;This version of the patch promotes incompatible variants to BYTES_VAR_STRAIGHT instead of dropping the data entirely. this looses at least no data if somebody messes up their types. I think this is ready - if nobody objects I am going to commit this tomorrow...&lt;/p&gt;</comment>
                    <comment id="13124061" author="mikemccand" created="Mon, 10 Oct 2011 14:05:20 +0100"  >&lt;p&gt;Patch looks good Simon!  Thanks.&lt;/p&gt;</comment>
                    <comment id="13124170" author="simonw" created="Mon, 10 Oct 2011 16:28:50 +0100"  >&lt;p&gt;committed to trunk in rev. 1181020&lt;/p&gt;

&lt;p&gt;thanks&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12498409" name="LUCENE-3186.patch" size="44235" author="simonw" created="Mon, 10 Oct 2011 11:14:40 +0100" />
                    <attachment id="12498329" name="LUCENE-3186.patch" size="38690" author="simonw" created="Sat, 8 Oct 2011 21:50:07 +0100" />
                    <attachment id="12496889" name="LUCENE-3186.patch" size="31945" author="simonw" created="Wed, 28 Sep 2011 16:38:47 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 9 Jun 2011 11:15:38 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2899</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24511</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>