<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:29:42 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-823/LUCENE-823.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-823] Lucene fails to close file handles under certain situations</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-823</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;As a followon to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-820&quot; title=&quot;SegmentReader.setNorm can fail to remove separate norms file, on Windows&quot;&gt;&lt;del&gt;LUCENE-820&lt;/del&gt;&lt;/a&gt;, I&apos;ve added a further check in&lt;br/&gt;
MockRAMDirectory to assert that there are no open files when the&lt;br/&gt;
directory is closed.&lt;/p&gt;

&lt;p&gt;That check caused a few unit tests to fail, and in digging into the&lt;br/&gt;
reason I uncovered these cases where Lucene fails to close file&lt;br/&gt;
handles:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;TermInfosReader.close() was setting its ThreadLocal enumerators to&lt;br/&gt;
    null without first closing the SegmentTermEnum in there.  It looks&lt;br/&gt;
    like this was part of the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-436&quot; title=&quot;[PATCH] TermInfosReader, SegmentTermEnum Out Of Memory Exception&quot;&gt;&lt;del&gt;LUCENE-436&lt;/del&gt;&lt;/a&gt;.  I just added the&lt;br/&gt;
    call to close.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is somewhat severe since we could leak many file handles for&lt;br/&gt;
    use cases that burn through threads and/or indexes.  Though,&lt;br/&gt;
    FSIndexInput does have a finalize() to close itself.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Flushing of deletes in IndexWriter opens SegmentReader to do the&lt;br/&gt;
    flushing, and it correctly calls close() to close the reader.  But&lt;br/&gt;
    if an exception is hit during commit and before actually closing,&lt;br/&gt;
    it will leave open those handles.  I fixed this first calling&lt;br/&gt;
    doCommit() and then doClose() in a finally.  The &quot;disk full&quot; tests&lt;br/&gt;
    we now have were hitting this.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;IndexWriter&apos;s addIndexes(IndexReader[]) method was opening a&lt;br/&gt;
    reader but not closing it with a try/finally.  I just put a&lt;br/&gt;
    try/finally in.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve also changed some unit tests to use MockRAMDirectory instead of&lt;br/&gt;
RAMDirectory to increase testing coverage of &quot;leaking open file&lt;br/&gt;
handles&quot;.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12364057">LUCENE-823</key>
            <summary>Lucene fails to close file handles under certain situations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Sun, 4 Mar 2007 09:15:25 +0000</created>
                <updated>Tue, 19 Jun 2007 09:14:54 +0100</updated>
                    <resolved>Tue, 6 Mar 2007 21:45:25 +0000</resolved>
                            <version>2.1</version>
                                <fixVersion>2.2</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12477791" author="yseeley@gmail.com" created="Sun, 4 Mar 2007 15:50:29 +0000"  >&lt;p&gt;&amp;gt; TermInfosReader.close() was setting its ThreadLocal enumerators to&lt;br/&gt;
 &amp;gt;  null without first closing the SegmentTermEnum in there.&lt;/p&gt;

&lt;p&gt;Are you sure descriptors are really leaked in this case?&lt;br/&gt;
There are other cases where Lucene doesn&apos;t close IndexInput clones... see &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-686&quot; title=&quot;Resources not always reclaimed in scorers after each search&quot;&gt;&lt;del&gt;LUCENE-686&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The SegmentTermEnum constructor is only called in two places:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;to init TermInfosReader.origEnum&lt;/li&gt;
	&lt;li&gt;to init TermInfosReader.indexEnum&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We can therefore conclude that all other SegmentTermEnum instances are clones, and hence close is a no-op.&lt;/p&gt;</comment>
                    <comment id="12477852" author="mikemccand" created="Sun, 4 Mar 2007 19:56:02 +0000"  >&lt;p&gt;Ahh, tricky!&lt;/p&gt;

&lt;p&gt;You are right, this is not a real leak, since it&apos;s a clone that&apos;s&lt;br/&gt;
failing to be closed and since FSIndexInput does not make a clone of&lt;br/&gt;
the underlying file descriptor.&lt;/p&gt;

&lt;p&gt;I had assumed/expected that a clone must be closed, but I guess it&apos;s&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;currently&amp;#93;&lt;/span&gt; a no-op.  This is the heart of the debate in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-686&quot; title=&quot;Resources not always reclaimed in scorers after each search&quot;&gt;&lt;del&gt;LUCENE-686&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I guess I&apos;ll leave the close in there, but change MockRAMDirectory to&lt;br/&gt;
ignore still-open clones when the dir is closed and add a comment&lt;br/&gt;
about this &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-686&quot; title=&quot;Resources not always reclaimed in scorers after each search&quot;&gt;&lt;del&gt;LUCENE-686&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="12477855" author="yseeley@gmail.com" created="Sun, 4 Mar 2007 20:06:30 +0000"  >&lt;p&gt;&amp;gt; guess I&apos;ll leave the close in there&lt;/p&gt;

&lt;p&gt;Since it&apos;s a thread-local, that only closes (maybe) for a single thread.&lt;br/&gt;
Doesn&apos;t seem worth it, and could be misleading to anyone thinking it closed all the enumerators.&lt;/p&gt;</comment>
                    <comment id="12477861" author="mikemccand" created="Sun, 4 Mar 2007 20:23:00 +0000"  >&lt;p&gt;&amp;gt; Since it&apos;s a thread-local, that only closes (maybe) for a single thread.&lt;br/&gt;
&amp;gt; Doesn&apos;t seem worth it, and could be misleading to anyone thinking it closed all the enumerators.&lt;/p&gt;

&lt;p&gt;Good point.  OK, I won&apos;t add the close call in.&lt;/p&gt;</comment>
                    <comment id="12477868" author="mikemccand" created="Sun, 4 Mar 2007 21:12:31 +0000"  >&lt;p&gt;Fixed patch based on Yonik&apos;s comments (thanks for the review!).&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12352539" name="LUCENE-823.patch" size="18846" author="mikemccand" created="Sun, 4 Mar 2007 09:16:46 +0000" />
                    <attachment id="12352572" name="LUCENE-823.take2.patch" size="20122" author="mikemccand" created="Sun, 4 Mar 2007 21:12:31 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 4 Mar 2007 15:50:29 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12917</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26907</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>