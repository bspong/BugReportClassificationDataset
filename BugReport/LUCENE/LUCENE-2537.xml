<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:05:55 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2537/LUCENE-2537.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2537] FSDirectory.copy() impl is unsafe</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2537</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;There are a couple of issues with it:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;FileChannel.transferFrom documents that it may not copy the number of bytes requested, however we don&apos;t check the return value. So need to fix the code to read in a loop until all bytes were copied..&lt;/li&gt;
	&lt;li&gt;When calling addIndexes() w/ very large segments (few hundred MBs in size), I ran into the following exception (Java 1.6 &amp;#8211; Java 1.5&apos;s exception was cryptic):
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.io.IOException: Map failed
    at sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:770)
    at sun.nio.ch.FileChannelImpl.transferToTrustedChannel(FileChannelImpl.java:450)
    at sun.nio.ch.FileChannelImpl.transferTo(FileChannelImpl.java:523)
    at org.apache.lucene.store.FSDirectory.copy(FSDirectory.java:450)
    at org.apache.lucene.index.IndexWriter.addIndexes(IndexWriter.java:3019)
Caused by: java.lang.OutOfMemoryError: Map failed
    at sun.nio.ch.FileChannelImpl.map0(Native Method)
    at sun.nio.ch.FileChannelImpl.map(FileChannelImpl.java:767)
    ... 7 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I changed the impl to something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; numWritten = 0;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; numToWrite = input.size();
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; bufSize = 1 &amp;lt;&amp;lt; 26;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (numWritten &amp;lt; numToWrite) {
  numWritten += output.transferFrom(input, numWritten, bufSize);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the code successfully adds the indexes. This code uses chunks of 64MB, however that might be too large for some applications, so we definitely need a smaller one. The question is how small so that performance won&apos;t be affected, and it&apos;d be great if we can let it be configurable, however since that API is called by other API, such as addIndexes, not sure it&apos;s easily controllable.&lt;/p&gt;

&lt;p&gt;Also, I read somewhere (can&apos;t remember now where) that on Linux the native impl is better and does copy in chunks. So perhaps we should make a Linux specific impl?&lt;/p&gt;</description>
                <environment></environment>
            <key id="12469184">LUCENE-2537</key>
            <summary>FSDirectory.copy() impl is unsafe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Jul 2010 20:02:47 +0100</created>
                <updated>Wed, 30 Mar 2011 16:49:56 +0100</updated>
                    <resolved>Mon, 26 Jul 2010 08:25:24 +0100</resolved>
                                            <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/store</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12887935" author="shaie" created="Tue, 13 Jul 2010 20:06:15 +0100"  >&lt;p&gt;Oh .. found the thread we discussed that on the list, to which I&apos;ve actually last posted w/ the following text:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;ve Googled around a bit and came across this: &lt;a href=&quot;http://markmail.org/message/l67bierbmmedrfw5&quot; class=&quot;external-link&quot;&gt;http://markmail.org/message/l67bierbmmedrfw5&lt;/a&gt;. Apparently, there&apos;s a long standing bug against SUN since May 2006 (&lt;a href=&quot;http://bugs.sun.com/view_bug.do?bug_id=6431344&quot; class=&quot;external-link&quot;&gt;http://bugs.sun.com/view_bug.do?bug_id=6431344&lt;/a&gt;) that&apos;s still open and reports the exact same behavior that I&apos;m seeing.&lt;/p&gt;

&lt;p&gt;If I understand correctly, this might be a Windows limitation and is expected to work well on Linux. I&apos;ll give it a try. But this makes me think if we should keep the current behavior for Linux-based directories, and fallback to the chunks approach for Windows ones? Since eventually I&apos;ll be running on Linux, I don&apos;t want to lose performance ...&lt;/p&gt;

&lt;p&gt;This isn&apos;t the first that we&apos;ve witnessed the &quot;write once, run everywhere&quot; misconception of Java &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I&apos;m thinking if in general we should have a Windows/Linux FSDirectory impl, or handlers, to prepare for future cases as well. Mike already started this with &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2500&quot; title=&quot;A Linux-specific Directory impl that bypasses the buffer cache&quot;&gt;&lt;del&gt;LUCENE-2500&lt;/del&gt;&lt;/a&gt; (DirectIOLinuxDirectory). Instead of writing a Directory, perhaps we could have a handler object or something, or a generic LinuxDirectory that impls some stuff the &apos;linux&apos; way. In FSDirectory we already have code which detects the OS and JRE used to decide between Simple, NIO and MMAP Directories ...&lt;/p&gt;&lt;/blockquote&gt;</comment>
                    <comment id="12891120" author="shaie" created="Thu, 22 Jul 2010 13:20:48 +0100"  >&lt;p&gt;I wrote a test which compares FileChannel API to intermediate buffer copies. The test runs each method 3 times and reports the best time of each. It can be run w/ different file and chunk sizes.&lt;/p&gt;

&lt;p&gt;Here are the results of copying a 1GB file using different chunk sizes (the chunk is used as the intermediate buffer size as well).&lt;/p&gt;

&lt;p&gt;Machine spec:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Linux, 64-bit (IBM) JVM&lt;/li&gt;
	&lt;li&gt;2xQuad (+hyper-threading) - 16 cores overall&lt;/li&gt;
	&lt;li&gt;16GB RAM&lt;/li&gt;
	&lt;li&gt;SAS HD&lt;/li&gt;
&lt;/ul&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Chunk Size&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;FileChannel&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Intermediate Buffer&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;64K&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1865&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1528&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;-18%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;128K&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1660&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1526&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;-9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;512K&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1514&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1493&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;-2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1552&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2072&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;+33%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1488&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1559&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1596&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1831&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;13%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;16M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1563&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1964&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;21%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;64M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1494&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2442&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;39%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;128M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1469&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2445&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;40%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;For small buffer sizes, intermediate byte[] copies is preferable. However, FileChannel method performs pretty much consistently, irregardless of the buffer size (except for the first run), while the byte[] approach degrades a lot, as the buffer size increases.&lt;/p&gt;

&lt;p&gt;I think, given these results, we can use the FileChannel method w/ a chunk size of 4 (or even 2) MB, to be on the safe side and don&apos;t eat up too much RAM?&lt;/p&gt;</comment>
                    <comment id="12891123" author="mikemccand" created="Thu, 22 Jul 2010 13:23:10 +0100"  >&lt;p&gt;Nice results Shai!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think, given these results, we can use the FileChannel method w/ a chunk size of 4 (or even 2) MB, to be on the safe side and don&apos;t eat up too much RAM?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="12891138" author="shaie" created="Thu, 22 Jul 2010 13:48:48 +0100"  >&lt;p&gt;Patch copies the files in chunks of 2MB. All core tests pass. I&apos;ll wait a day or two in case someone wants to suggests a different approach, or chunk size limit before I commit.&lt;/p&gt;</comment>
                    <comment id="12891572" author="shaie" created="Fri, 23 Jul 2010 13:45:09 +0100"  >&lt;p&gt;Patch adds the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FSIndexOutput overrides copyBytes to do optimized copies as well (when possible).&lt;/li&gt;
	&lt;li&gt;CompoundFileWriter changed to call copyBytes, instead of using an intermediate buffer.&lt;/li&gt;
	&lt;li&gt;Some minor typos and code corrections.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;NOTE:&lt;/b&gt; with the changes to CFW, CheckAbort is accessed only after an entire file is written. The estimated amount of work is the length copied. This means that if abort() is called, it might take a tad longer until CFW will detect it.&lt;br/&gt;
I don&apos;t think it&apos;s serious, since (1) abort() is not called often, (2) for small segments this will probably have no effect (OneMerge was accessed roughly every ~2MB copied) and (3) as reported, the optimized copy is faster when using FileChannel, therefore the time that passes between checks may not be that long.&lt;br/&gt;
And there&apos;s a (4) &amp;#8211; for really large segments, the amount of work done to merge them is far larger than copying them into the CFS. Therefore the chances that abort() will be called during that process is relatively small ...&lt;/p&gt;

&lt;p&gt;All tests pass.&lt;/p&gt;</comment>
                    <comment id="12892073" author="shaie" created="Sun, 25 Jul 2010 06:58:02 +0100"  >&lt;p&gt;If there are no objections, I&apos;ll commit this today,&lt;/p&gt;</comment>
                    <comment id="12892203" author="shaie" created="Mon, 26 Jul 2010 08:25:23 +0100"  >&lt;p&gt;Committed revision 979161 (3x).&lt;br/&gt;
Committed revision 979185.&lt;/p&gt;</comment>
                    <comment id="13013311" author="gsingers" created="Wed, 30 Mar 2011 16:49:56 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12450164" name="FileCopyTest.java" size="3994" author="shaie" created="Thu, 22 Jul 2010 13:20:48 +0100" />
                    <attachment id="12450305" name="LUCENE-2537.patch" size="10462" author="shaie" created="Fri, 23 Jul 2010 13:45:09 +0100" />
                    <attachment id="12450167" name="LUCENE-2537.patch" size="1858" author="shaie" created="Thu, 22 Jul 2010 13:48:48 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 22 Jul 2010 12:23:10 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11290</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25155</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>