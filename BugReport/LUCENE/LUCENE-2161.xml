<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:10:44 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2161/LUCENE-2161.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2161] Some concurrency improvements for NRT</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2161</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Some concurrency improvements for NRT&lt;/p&gt;

&lt;p&gt;I found &amp;amp; fixed some silly thread bottlenecks that affect NRT:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Multi/DirectoryReader.numDocs is synchronized, I think so only 1&lt;br/&gt;
    thread computes numDocs if it&apos;s -1.  I removed this sync, and made&lt;br/&gt;
    numDocs volatile, instead.  Yes, multiple threads may compute the&lt;br/&gt;
    numDocs for the first time, but I think that&apos;s harmless?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Fixed BitVector&apos;s ctor to set count to 0 on creating a new BV, and&lt;br/&gt;
    clone to copy the count over; this saves CPU computing the count&lt;br/&gt;
    unecessarily.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Also strengthened assertions done in SR, testing the delete docs&lt;br/&gt;
    count.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also found an annoying thread bottleneck that happens, due to CMS.&lt;br/&gt;
Whenever CMS hits the max running merges (default changed from 3 to 1&lt;br/&gt;
recently), and the merge policy now wants to launch another merge, it&lt;br/&gt;
forces the incoming thread to wait until one of the BG threads&lt;br/&gt;
finishes.&lt;/p&gt;

&lt;p&gt;This is a basic crude throttling mechanism &amp;#8211; you force the mutators&lt;br/&gt;
(whoever is causing new segments to appear) to stop, so that merging&lt;br/&gt;
can catch up.&lt;/p&gt;

&lt;p&gt;Unfortunately, when stressing NRT, that thread is the one that&apos;s&lt;br/&gt;
opening a new NRT reader.&lt;/p&gt;

&lt;p&gt;So, the first serious problem happens when you call .reopen() on your&lt;br/&gt;
NRT reader &amp;#8211; this call simply forwards to IW.getReader if the reader&lt;br/&gt;
was an NRT reader.  But, because DirectoryReader.doReopen is&lt;br/&gt;
synchronized, this had the horrible effect of holding the monitor lock&lt;br/&gt;
on your main IR.  In my test, this blocked all searches (since each&lt;br/&gt;
search uses incRef/decRef, still sync&apos;d until &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2156&quot; title=&quot;use AtomicInteger/Boolean to track IR.refCount and IW.closed&quot;&gt;&lt;del&gt;LUCENE-2156&lt;/del&gt;&lt;/a&gt;, at least).&lt;br/&gt;
I fixed this by making doReopen only sync&apos;d on this if it&apos;s not simply&lt;br/&gt;
forwarding to getWriter.  So that&apos;s a good step forward.&lt;/p&gt;

&lt;p&gt;This prevents searches from being blocked while trying to reopen to a&lt;br/&gt;
new NRT.&lt;/p&gt;

&lt;p&gt;However... it doesn&apos;t fix the problem that when an immense merge is&lt;br/&gt;
off and running, opening an NRT reader could hit a tremendous delay&lt;br/&gt;
because CMS blocks it.  The BalancedSegmentMergePolicy should help&lt;br/&gt;
here... by avoiding such immense merges.&lt;/p&gt;

&lt;p&gt;But, I think we should also pursue an improvement to CMS.  EG, if it&lt;br/&gt;
has 2 merges running, where one is huge and one is tiny, it ought to&lt;br/&gt;
increase thread priority of the tiny one.  I think with such a change&lt;br/&gt;
we could increase the max thread count again, to prevent this&lt;br/&gt;
starvation.  I&apos;ll open a separate issue....&lt;/p&gt;</description>
                <environment></environment>
            <key id="12443360">LUCENE-2161</key>
            <summary>Some concurrency improvements for NRT</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Dec 2009 10:37:37 +0000</created>
                <updated>Fri, 18 Jun 2010 09:03:55 +0100</updated>
                    <resolved>Wed, 2 Jun 2010 00:33:51 +0100</resolved>
                                            <fixVersion>2.9.3</fixVersion>
                <fixVersion>3.0.2</fixVersion>
                <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12790657" author="mikemccand" created="Tue, 15 Dec 2009 10:48:43 +0000"  >&lt;p&gt;Attached patch.  Also adds an expert public String IndexReader.segString for debug purposes.&lt;/p&gt;</comment>
                    <comment id="12790663" author="earwin" created="Tue, 15 Dec 2009 11:08:26 +0000"  >&lt;p&gt;Remove volatile from numDocs? All threads will hit some other sync sooner or later and see the value computed by the first (?few?).&lt;/p&gt;</comment>
                    <comment id="12790675" author="mikemccand" created="Tue, 15 Dec 2009 11:20:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Remove volatile from numDocs? All threads will hit some other sync sooner or later and see the value computed by the first (?few?).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I guess this would be fine.  Even if they don&apos;t see the value (ie they still see the stale -1), it&apos;s harmless if they recompute it and re-overwrite it.  So I&apos;ll remove volatile.&lt;/p&gt;</comment>
                    <comment id="12873414" author="mikemccand" created="Sun, 30 May 2010 13:27:37 +0100"  >&lt;p&gt;Backport&lt;/p&gt;</comment>
                    <comment id="12873475" author="kimchy" created="Sun, 30 May 2010 20:34:49 +0100"  >&lt;p&gt;Mike, is there a reason why this is not backported to 3.0.2?&lt;/p&gt;</comment>
                    <comment id="12874253" author="mikemccand" created="Tue, 1 Jun 2010 22:40:52 +0100"  >&lt;p&gt;Shay it will be backported to 3.0.2.&lt;/p&gt;</comment>
                    <comment id="12874454" author="kimchy" created="Wed, 2 Jun 2010 07:39:12 +0100"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12428027" name="LUCENE-2161.patch" size="10950" author="mikemccand" created="Tue, 15 Dec 2009 10:48:43 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 15 Dec 2009 11:08:26 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11624</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25564</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>