<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:16:23 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3255/LUCENE-3255.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3255] Corrupted segment file not detected and wipes index contents</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3255</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Lucene will happily wipe an existing index if presented with a latest generation segments_n file of all zeros. File format documentation says segments_N files should start with a format of -9 but SegmentInfos.read accepts &amp;gt;=0 as valid for backward compatibility reasons.&lt;/p&gt;
</description>
                <environment></environment>
            <key id="12512002">LUCENE-3255</key>
            <summary>Corrupted segment file not detected and wipes index contents</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="markh">Mark Harwood</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Jun 2011 15:47:52 +0100</created>
                <updated>Sun, 27 Nov 2011 12:31:36 +0000</updated>
                    <resolved>Tue, 28 Jun 2011 17:38:14 +0100</resolved>
                            <version>2.9.4</version>
                <version>3.2</version>
                                <fixVersion>3.4</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>3</watches>
                                                    <comments>
                    <comment id="13056550" author="gregtarr" created="Tue, 28 Jun 2011 15:56:37 +0100"  >&lt;p&gt;Thanks for this Mark. A speedy resolution would be extremely helpful for confidence in our lucene-based implementation.&lt;/p&gt;</comment>
                    <comment id="13056600" author="simonw" created="Tue, 28 Jun 2011 17:07:53 +0100"  >&lt;p&gt;here is a more self contained testcase showing the problem - applies on 3.x and trunk&lt;/p&gt;</comment>
                    <comment id="13056602" author="mikemccand" created="Tue, 28 Jun 2011 17:12:38 +0100"  >&lt;p&gt;Nice catch!  Indeed, because of back compat, we read a leading 0 as being an ancient format, and then interpret the next 0 to mean index has no segments.&lt;/p&gt;

&lt;p&gt;However, that ancient format predates 1.9, so the fix for 3.x is easy (remove support for this ancient format).&lt;/p&gt;

&lt;p&gt;Not sure what to do if we really need to fix this in pre-3.x releases...&lt;/p&gt;</comment>
                    <comment id="13056605" author="mikemccand" created="Tue, 28 Jun 2011 17:15:20 +0100"  >&lt;p&gt;4.0 is not affected because we had already removed this back compat code.&lt;/p&gt;</comment>
                    <comment id="13056606" author="simonw" created="Tue, 28 Jun 2011 17:18:10 +0100"  >&lt;blockquote&gt;&lt;p&gt;Not sure what to do if we really need to fix this in pre-3.x releases...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;there is not much todo really here. I don&apos;t see a good way to fix this there. :/ &lt;/p&gt;</comment>
                    <comment id="13056615" author="mikemccand" created="Tue, 28 Jun 2011 17:34:16 +0100"  >&lt;p&gt;Patch; I&apos;ll commit shortly...&lt;/p&gt;</comment>
                    <comment id="13056619" author="markh" created="Tue, 28 Jun 2011 17:41:00 +0100"  >&lt;p&gt;Thanks for the quick turnaround Mike/Simon.&lt;/p&gt;

&lt;p&gt;Greg is on 2.9.x and so the suggestion I have is that he adds some checking code in the app to remove the latest segments_n file if it looks to have anything other than -9 as a format value given he knows that his Lucene indexes should always be of that version. Maybe that could be a utility class that can be posted here on this issue for others who might share this issue. I&apos;m guessing it&apos;s a quirk of the  file system to leave that all-zeros file in place prior to a flush of some kind?&lt;/p&gt;
</comment>
                    <comment id="13056639" author="mikemccand" created="Tue, 28 Jun 2011 18:06:17 +0100"  >&lt;p&gt;That sounds like a good fix for 2.9.x.&lt;/p&gt;

&lt;p&gt;+1 for posting a utility here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m guessing it&apos;s a quirk of the file system to leave that all-zeros file in place prior to a flush of some kind?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually I think various filesystems could conceivably do this (write all 0s to a file), eg on OS/hardware crash, if the file was written by not yet sync&apos;d.&lt;/p&gt;</comment>
                    <comment id="13057052" author="simonw" created="Wed, 29 Jun 2011 08:32:53 +0100"  >&lt;p&gt;I wonder if we could check the latest segments_N file against a previous one and if the version of that file is older that the previous one we drop it since we don&apos;t provide forward compatibility. we could even spin a 2.9 bugfix release for that though.&lt;/p&gt;</comment>
                    <comment id="13057144" author="mikemccand" created="Wed, 29 Jun 2011 11:47:01 +0100"  >&lt;p&gt;Ahh, good idea Simon!  That should work.&lt;/p&gt;

&lt;p&gt;Another simple thing we could do is, throw an exc if we did not consume all bytes from the segments file.  In this case, the segments file was 20 bytes long, but the double 0 ints only consumes 8 bytes (two 0 ints).&lt;/p&gt;</comment>
                    <comment id="13057186" author="mikemccand" created="Wed, 29 Jun 2011 12:59:54 +0100"  >&lt;p&gt;Actually, we can do something even simpler here: in the 1.9.x days Lucene never wrote a generation (_N) segments file.  It always wrote just &quot;segments&quot;, so, if we see first int is a 0, and the file has a generation in it, then it&apos;s corrupt.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12484453" name="AllZerosSegmentFile" size="20" author="markh" created="Tue, 28 Jun 2011 15:49:57 +0100" />
                    <attachment id="12484452" name="BadSegmentsFileTest.java" size="2580" author="markh" created="Tue, 28 Jun 2011 15:48:50 +0100" />
                    <attachment id="12484477" name="CorruptionCheckerForPreLucene3.java" size="911" author="markh" created="Tue, 28 Jun 2011 17:56:54 +0100" />
                    <attachment id="12484474" name="LUCENE-3255.patch" size="4754" author="mikemccand" created="Tue, 28 Jun 2011 17:34:16 +0100" />
                    <attachment id="12484469" name="LUCENE-3255_testcase.patch" size="2623" author="simonw" created="Tue, 28 Jun 2011 17:07:53 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 28 Jun 2011 14:56:37 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10747</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24441</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>