<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 12:58:09 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3776/LUCENE-3776.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3776] NRTManager shouldn&apos;t expose its private SearcherManager</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3776</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Spinoff from &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3769&quot; title=&quot;Simplify NRTManager&quot;&gt;&lt;del&gt;LUCENE-3769&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To actually obtain an IndexSearcher from NRTManager, it&apos;s a 2-step process now.&lt;/p&gt;

&lt;p&gt;You must .getSearcherManager(), then .acquire() from the returned SearcherManager.&lt;/p&gt;

&lt;p&gt;This is very trappy... because if the app incorrectly calls maybeReopen on that private SearcherManager (instead of NRTManager.maybeReopen) then it can unexpectedly cause threads to block forever, waiting for the necessary gen to become visible.  This will be hard to debug... I don&apos;t like creating trappy APIs.&lt;/p&gt;

&lt;p&gt;Hopefully once &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3761&quot; title=&quot;Generalize SearcherManager&quot;&gt;&lt;del&gt;LUCENE-3761&lt;/del&gt;&lt;/a&gt; is in, we can fix NRTManager to no longer expose its private SM, instead subclassing ReferenceManaager.&lt;/p&gt;

&lt;p&gt;Or alternatively, or in addition, maybe we factor out a new interface (SearcherProvider or something...) that only has acquire and release methods, and both NRTManager and ReferenceManager/SM impl that, and we keep NRTManager&apos;s SM private.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12542437">LUCENE-3776</key>
            <summary>NRTManager shouldn&apos;t expose its private SearcherManager</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.png">Blocker</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Feb 2012 19:45:03 +0000</created>
                <updated>Fri, 10 May 2013 11:44:19 +0100</updated>
                    <resolved>Fri, 17 Feb 2012 19:30:34 +0000</resolved>
                                            <fixVersion>3.6</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13209351" author="mikemccand" created="Thu, 16 Feb 2012 13:39:36 +0000"  >&lt;p&gt;Patch, cutting over NRTManager to subclass ReferenceManager, and also&lt;br/&gt;
some minor cleanups to ReferenceManager/SearcherManager.&lt;/p&gt;

&lt;p&gt;I added a method, afterRefresh, to ReferenceManager, which it calls&lt;br/&gt;
after a refresh; NRTManager needs this so it can&lt;br/&gt;
notify any waiting threads that the new gen is now live.&lt;/p&gt;</comment>
                    <comment id="13209392" author="shaie" created="Thu, 16 Feb 2012 14:36:06 +0000"  >&lt;p&gt;Patch looks good !&lt;/p&gt;

&lt;p&gt;&lt;b&gt;SearcherManager&lt;/b&gt;&lt;br/&gt;
with these changes, if the app passes an IndexReader that is not DirectoryReader, it will get ClassCastException (if asserts are disabled). Is that ok? Perhaps it&apos;d be better if you check that in SM&apos;s ctor and throw IllegalArgumentException? The problem is that app cannot pass DirReader in 3x, so this will apply to trunk only. In fact, I think that for trunk it will be better if SM declared it expects a DirectoryReader up front?&lt;/p&gt;

&lt;p&gt;We cannot avoid the cast in refreshIfNeeded because IR is obtained from IS, but at least the app won&apos;t hit ClassCastExceptions after it created SM?&lt;/p&gt;

&lt;p&gt;That kinda makes SearcherManager a DirReader only impl which is unfortunate IMO. But I&apos;m not sure if any IR can openIfChanged() anymore, so perhaps that&apos;s unavoidable.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;ReferenceManager&lt;/b&gt;&lt;br/&gt;
About close() &amp;#8211; do you think it&apos;ll be better to keep close() final, and introduce a new protected closeResource()/closeInternal() that NRTManager can override? That way, RefManagers won&apos;t accidentally override close() and forget to call super.close()?&lt;/p&gt;

&lt;p&gt;About afterRefresh() &amp;#8211; I&apos;ll admit that first I didn&apos;t understand why you need it. Previously, it was used to warm an IndexSearcher, but now we say it&apos;s the responsibility of SearcherFactory. I can see why it&apos;s useful for NRTManager, and it might even help me in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3793&quot; title=&quot;Use ReferenceManager in DirectoryTaxonomyReader&quot;&gt;&lt;del&gt;LUCENE-3793&lt;/del&gt;&lt;/a&gt; ! Do you think that we should declare that it can throw IOE? I know that if I&apos;ll use it in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3793&quot; title=&quot;Use ReferenceManager in DirectoryTaxonomyReader&quot;&gt;&lt;del&gt;LUCENE-3793&lt;/del&gt;&lt;/a&gt;, I&apos;ll need that and I&apos;d hate to throw RuntimeException. NRTManager can still override and not declare that. I&apos;m just thinking that since almost all methods declare throwing IOE, it won&apos;t be odd if we declare it too on afterRefresh(), and it&apos;s not unlikely that afterRefresh() will do something that throws exceptions.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NRTManager&lt;/b&gt;&lt;br/&gt;
About openIfNeeded:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Can you cast to DirectoryReader once? I don&apos;t know if the assert is better than a ClassCastException ... with how the code is written, ClassCastException is better than assert because at least it will tell the user what went wrong?&lt;/li&gt;
	&lt;li&gt;How critical it is to declare newSearcher final? If you didn&apos;t, you could init it to null, and only change if newReader != null. Saving 4 lines of code (improves readability IMO &amp;#8211; something that I know you care about &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    <comment id="13209693" author="mikemccand" created="Thu, 16 Feb 2012 20:18:25 +0000"  >&lt;p&gt;Thanks Shai.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;with these changes, if the app passes an IndexReader that is not DirectoryReader, it will get ClassCastException (if asserts are disabled).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hang on &amp;#8211; SM now takes either IW or Directory, from which we always&lt;br/&gt;
pull a DirectoryReader, right (we call DR.open ourselves)?  Won&apos;t we&lt;br/&gt;
always have a DR in SM...?&lt;/p&gt;

&lt;p&gt;Hmm, or do you mean the SearcherFactory could make some other&lt;br/&gt;
reader...?  Hmm maybe we should have a hard check for that&lt;br/&gt;
(SearcherFactory shouldn&apos;t do that...?)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;About close() &#8211; do you think it&apos;ll be better to keep close() final, and introduce a new protected closeResource()/closeInternal() that NRTManager can override? That way, RefManagers won&apos;t accidentally override close() and forget to call super.close()?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good idea... I&apos;ll add afterClose (matches afterRefresh);&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;About afterRefresh() &#8211; I&apos;ll admit that first I didn&apos;t understand why you need it. Previously, it was used to warm an IndexSearcher, but now we say it&apos;s the responsibility of SearcherFactory. I can see why it&apos;s useful for NRTManager, and it might even help me in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3793&quot; title=&quot;Use ReferenceManager in DirectoryTaxonomyReader&quot;&gt;&lt;del&gt;LUCENE-3793&lt;/del&gt;&lt;/a&gt; ! Do you think that we should declare that it can throw IOE? I know that if I&apos;ll use it in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3793&quot; title=&quot;Use ReferenceManager in DirectoryTaxonomyReader&quot;&gt;&lt;del&gt;LUCENE-3793&lt;/del&gt;&lt;/a&gt;, I&apos;ll need that and I&apos;d hate to throw RuntimeException. NRTManager can still override and not declare that. I&apos;m just thinking that since almost all methods declare throwing IOE, it won&apos;t be odd if we declare it too on afterRefresh(), and it&apos;s not unlikely that afterRefresh() will do something that throws exceptions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good, I&apos;ll add throws IOE.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; About openIfNeeded:&lt;br/&gt;
Can you cast to DirectoryReader once?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I don&apos;t know if the assert is better than a ClassCastException ... with how the code is written, ClassCastException is better than assert because at least it will tell the user what went wrong?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I &lt;b&gt;think&lt;/b&gt; there&apos;s no way a non-DirReader can get into NRTManager (like&lt;br/&gt;
SM), except for SearcherFactory.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;How critical it is to declare newSearcher final? If you didn&apos;t, you could init it to null, and only change if newReader != null. Saving 4 lines of code (improves readability IMO &#8211; something that I know you care about ).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not critical!  Good idea...&lt;/p&gt;</comment>
                    <comment id="13209696" author="mikemccand" created="Thu, 16 Feb 2012 20:20:24 +0000"  >&lt;p&gt;New patch folding in Shai&apos;s suggestions (thanks!).&lt;/p&gt;

&lt;p&gt;I didn&apos;t yet add a hard check for an evil SearcherFactory...&lt;/p&gt;</comment>
                    <comment id="13210064" author="shaie" created="Fri, 17 Feb 2012 05:24:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Hang on &#8211; SM now takes either IW or Director&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, I missed that. For some reason I had the impression it takes an IR, which is obviously wrong, since it won&apos;t be allowed to close it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;do you mean the SearcherFactory could make some other reader&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m less worried about that. We give SF an IndexReader, I can only expect that it will return an IndexSearcher on top of it. Maybe we can assert that IndexSearcher.getIndexReader == newReader in refreshIfNeeded?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think there&apos;s no way a non-DirReader can get into NRTManager &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right. If you keep the assert, maybe add a nice msg to it?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I didn&apos;t yet add a hard check for an evil SearcherFactory...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that&apos;s ok to assume that SearcherFactory is not evil. Maybe the assert I suggested above would be enough?&lt;/p&gt;</comment>
                    <comment id="13210279" author="mikemccand" created="Fri, 17 Feb 2012 14:05:35 +0000"  >&lt;p&gt;OK, I made the evil SearcherFactory a real check; it&apos;s too dangerous if the app messes this up (eg it could be a DirReader, but a different one, and then we are inc/decRefing the wrong DR).&lt;/p&gt;

&lt;p&gt;I also add messages to the new asserts... I think it&apos;s ready!&lt;/p&gt;</comment>
                    <comment id="13210327" author="shaie" created="Fri, 17 Feb 2012 15:28:38 +0000"  >&lt;p&gt;Looks good Mike.&lt;/p&gt;

&lt;p&gt;Do we still need that assert, now that getSearcher() checks that the returned IR is the one it passed to SearcherFactory? I think it covers the case the returned IR is also a DirReader?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; r &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; DirectoryReader: &lt;span class=&quot;code-quote&quot;&gt;&quot;searcher&apos;s IndexReader should be a DirectoryReader, but got &quot;&lt;/span&gt; + r;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I noticed that NRTManager shares some logic with SearcherManager (e.g. getSearcher) &amp;#8211; is there a way to avoid the duplication? Maybe if getSearcher would be a package-private static method on SM?&lt;/p&gt;

&lt;p&gt;These are not critical IMO, so I&apos;ll leave the decision on whether to fix or not to you. +1 to commit.&lt;/p&gt;</comment>
                    <comment id="13210337" author="mikemccand" created="Fri, 17 Feb 2012 15:36:17 +0000"  >&lt;p&gt;Thanks Shai &amp;#8211; I&apos;ll share a common (static) getSearcher.  I think assert only makes it safer, eg in case someone changes something in the future that somehow lets a non-DR in or something...&lt;/p&gt;</comment>
                    <comment id="13210465" author="mikemccand" created="Fri, 17 Feb 2012 19:30:34 +0000"  >&lt;p&gt;Thanks Shai!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12514985" name="LUCENE-3776.patch" size="25319" author="mikemccand" created="Fri, 17 Feb 2012 14:05:35 +0000" />
                    <attachment id="12514860" name="LUCENE-3776.patch" size="20434" author="mikemccand" created="Thu, 16 Feb 2012 20:20:23 +0000" />
                    <attachment id="12514797" name="LUCENE-3776.patch" size="18362" author="mikemccand" created="Thu, 16 Feb 2012 13:39:36 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 16 Feb 2012 14:36:06 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>227724</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>23923</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>