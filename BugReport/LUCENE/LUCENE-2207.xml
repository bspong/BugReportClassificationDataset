<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:35:02 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2207/LUCENE-2207.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2207] CJKTokenizer generates tokens with incorrect offsets</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2207</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;If I index a Japanese &lt;b&gt;multi-valued&lt;/b&gt; document with CJKTokenizer and highlight a term with FastVectorHighlighter, the output snippets have incorrect highlighted string. I&apos;ll attach a program that reproduces the problem soon.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12445414">LUCENE-2207</key>
            <summary>CJKTokenizer generates tokens with incorrect offsets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="rcmuir">Robert Muir</assignee>
                                <reporter username="koji">Koji Sekiguchi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Jan 2010 16:38:27 +0000</created>
                <updated>Mon, 16 May 2011 19:15:43 +0100</updated>
                    <resolved>Sun, 17 Jan 2010 21:45:27 +0000</resolved>
                            <version>2.9.1</version>
                <version>3.0</version>
                                <fixVersion>2.9.2</fixVersion>
                <fixVersion>3.0.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/analysis</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12799827" author="koji" created="Wed, 13 Jan 2010 16:57:36 +0000"  >&lt;p&gt;Attached the program that reproduces the problem. In the program, I didn&apos;t use FastVectorHighlighter, instead, I printed out offsets from TermVectorOffsetInfo. You&apos;ll see the following results:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
=== WhitespaceAnalyzer ===
&#12354;&#12356;(0,2)
&#12358;&#12360;&#12362;(3,6)
=== CJKAnalyzer ===
&#12354;&#12356;(0,2)
&#12358;&#12360;(4,6)
&#12360;&#12362;(5,7)
=== BasicNGramAnalyzer ===
&#12354;&#12356;(0,2)
&#12358;&#12360;(3,5)
&#12360;&#12362;(4,6)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For people who are seeing garbage characters, I want to rephrase using &apos;Cn&apos; symbols as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
=== WhitespaceAnalyzer ===
C1C2(0,2)
C3C4C5(3,6)
=== CJKAnalyzer ===
C1C2(0,2)
C3C4(4,6)
C4C5(5,7)
=== BasicNGramAnalyzer ===
C1C2(0,2)
C3C4(3,5)
C4C5(4,6)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see, the start offset of &apos;C3&apos; is 3 in WhitespaceAnalyzer and BasicNGramAnalyzer (an analyzer which uses BasicNGramTokenizer. BasicNGramTokenizer is used in FastVectorHighlighter test code. It works as a 2-gram tokenizer for not only CJK but also ASCII), but is 4 in CJKAnalyzer &amp;#8211; incorrect!&lt;/p&gt;

&lt;p&gt;I&apos;ll look into it tomorrow or after, but volunteers are welcome!&lt;/p&gt;</comment>
                    <comment id="12799831" author="rcmuir" created="Wed, 13 Jan 2010 17:09:10 +0000"  >&lt;p&gt;Hi Koji, this looks like a bug in CJK offset calculations, probably involving end()&lt;/p&gt;

&lt;p&gt;Personally i find the offset logic a little complex. It currently does both additions and subtractions to the offset and I think there is an off-by-one error in this.&lt;/p&gt;

&lt;p&gt;I will play around and see if I can simplify this logic, but please don&apos;t wait on me, if you have an idea already how to fix it!&lt;/p&gt;</comment>
                    <comment id="12799841" author="rcmuir" created="Wed, 13 Jan 2010 17:48:19 +0000"  >&lt;p&gt;ok i found the bug. the problem is incrementToken() unconditionally increments the offset before it starts its main loop:&lt;/p&gt;

&lt;p&gt;line 165:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
offset++;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so, when incrementToken() has no more text to return and returns false, it needs to subtract from this.&lt;/p&gt;

&lt;p&gt;again i think in the future we try to refactor this offset logic to be simpler, but for the short term, this fixes the bug and all tests pass.&lt;/p&gt;

&lt;p&gt;Koji, can you review?&lt;/p&gt;</comment>
                    <comment id="12799848" author="rcmuir" created="Wed, 13 Jan 2010 17:59:46 +0000"  >&lt;p&gt;i added a testcase for end() to my patch that fails on trunk, but passes with the fix.&lt;/p&gt;</comment>
                    <comment id="12799857" author="rcmuir" created="Wed, 13 Jan 2010 18:16:02 +0000"  >&lt;p&gt;hello, this tokenizer has more serious offset/end problems than I originally thought.&lt;/p&gt;

&lt;p&gt;attached is my previous patch and testcase but with 3 more testcases, one still fails. &lt;/p&gt;</comment>
                    <comment id="12801312" author="koji" created="Sun, 17 Jan 2010 03:51:27 +0000"  >&lt;p&gt;Hi Robert, thank you for looking this so quickly!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ok i found the bug. the problem is incrementToken() unconditionally increments the offset before it starts its main loop:&lt;/p&gt;

&lt;p&gt;line 165:&lt;/p&gt;

&lt;p&gt;offset++;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Indeed.&lt;/p&gt;

&lt;p&gt;In attached patch, I added one more offset-- line and two more testcases. All tests pass and this patch fixes the original problem that was found in Solr with FastVectorHighlighter.&lt;/p&gt;</comment>
                    <comment id="12801336" author="rcmuir" created="Sun, 17 Jan 2010 07:25:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;In attached patch, I added one more offset-- line and two more testcases. All tests pass and this patch fixes the original problem that was found in Solr with FastVectorHighlighter.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;nice, fix looks good to me.&lt;/p&gt;</comment>
                    <comment id="12801346" author="rcmuir" created="Sun, 17 Jan 2010 08:50:41 +0000"  >&lt;p&gt;Koji, I am testing other end() offsets with all other tokenizers, I noticed that CJKTokenizer does not call correctOffset() in end:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; finalOffset = offset;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think instead this should be&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; finalOffset = correctOffset(offset);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in case there is a CharFilter present.&lt;/p&gt;</comment>
                    <comment id="12801363" author="koji" created="Sun, 17 Jan 2010 10:27:24 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I think instead this should be&lt;/p&gt;

&lt;p&gt;final int finalOffset = correctOffset(offset);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, thank you for pointing this!&lt;br/&gt;
I think this is ready to commit. Robert, can you do it? And it&apos;d be great if it could go 2.9 branch so that Solr can use the fix.&lt;/p&gt;</comment>
                    <comment id="12801366" author="rcmuir" created="Sun, 17 Jan 2010 10:31:08 +0000"  >&lt;p&gt;Koji, sure I can take care of it.&lt;/p&gt;

&lt;p&gt;Also i added &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2219&quot; title=&quot;improve BaseTokenStreamTestCase to test end()&quot;&gt;&lt;del&gt;LUCENE-2219&lt;/del&gt;&lt;/a&gt; to find these bugs in other tokenizers.&lt;/p&gt;

&lt;p&gt;In the future I also want to explore if we can somehow use a fake CharFilter in BaseTokenStreamTest to also ensure that correctOffset() is called when setting offsets in both incrementToken() and end(), don&apos;t yet know how it would work yet.&lt;/p&gt;</comment>
                    <comment id="12801518" author="rcmuir" created="Sun, 17 Jan 2010 21:45:27 +0000"  >&lt;p&gt;thanks Koji!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310010">
                <name>Incorporates</name>
                                                <inwardlinks description="is part of">
                            <issuelink>
            <issuekey id="12445757">LUCENE-2219</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12430533" name="LUCENE-2207.patch" size="5709" author="koji" created="Sun, 17 Jan 2010 03:51:27 +0000" />
                    <attachment id="12430155" name="LUCENE-2207.patch" size="3851" author="rcmuir" created="Wed, 13 Jan 2010 18:16:02 +0000" />
                    <attachment id="12430152" name="LUCENE-2207.patch" size="1876" author="rcmuir" created="Wed, 13 Jan 2010 17:59:46 +0000" />
                    <attachment id="12430151" name="LUCENE-2207.patch" size="751" author="rcmuir" created="Wed, 13 Jan 2010 17:48:19 +0000" />
                    <attachment id="12430150" name="TestCJKOffset.java" size="7019" author="koji" created="Wed, 13 Jan 2010 16:57:36 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 13 Jan 2010 17:09:10 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11580</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25518</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>