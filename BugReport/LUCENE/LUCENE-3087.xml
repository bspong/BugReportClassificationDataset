<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:06:43 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3087/LUCENE-3087.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3087] highlighting exact phrase with overlapping tokens fails.</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3087</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Fields with overlapping token are not highlighted in search results when searching exact phrases, when using TermVector.WITH_OFFSET.&lt;/p&gt;

&lt;p&gt;The document builded in MemoryIndex for highlight does not preserve positions of tokens in this case. Overlapping tokens get &quot;flattened&quot; (position increment always set to 1), the spanquery used for searching relevant fragment will fail to identify the correct token sequence because the position shift.&lt;/p&gt;

&lt;p&gt;I corrected this by adding a position increment calculation in sub class StoredTokenStream. I added junit test covering this case.&lt;/p&gt;

&lt;p&gt;I used the eclipse codestyle from trunk, but style add quite a few format differences between repository and working copy files. I tried to reduce them, but some linewrapping rules still doesn&apos;t match.&lt;/p&gt;

&lt;p&gt;Correction patch joined&lt;/p&gt;</description>
                <environment></environment>
            <key id="12506847">LUCENE-3087</key>
            <summary>highlighting exact phrase with overlapping tokens fails.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="pigo">Pierre Goss&#233;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 May 2011 14:47:30 +0100</created>
                <updated>Fri, 7 Jun 2013 13:37:58 +0100</updated>
                    <resolved>Thu, 12 May 2011 18:08:16 +0100</resolved>
                            <version>2.9.4</version>
                <version>3.1</version>
                                <fixVersion>3.2</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/highlighter</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="13031698" author="pigo" created="Wed, 11 May 2011 14:48:45 +0100"  >&lt;p&gt;correction patch with junit tests&lt;/p&gt;</comment>
                    <comment id="13032349" author="mikemccand" created="Thu, 12 May 2011 11:43:11 +0100"  >&lt;p&gt;Thank you for the patch with test case Pierre!&lt;/p&gt;

&lt;p&gt;So this bug only applies if you store offset but not positions in your term vectors (TermVector.WITH_OFFSET).  Previously we would always set posIncr=1, now (with your patch) we set it to 0 if the offset didn&apos;t change vs the prior token.  I think this seems reasonable &amp;#8211; we have to fallback on heuristics since positions were not stored.&lt;/p&gt;</comment>
                    <comment id="13032421" author="pigo" created="Thu, 12 May 2011 15:14:04 +0100"  >&lt;p&gt;Thanks for taking a look at this Michael.&lt;/p&gt;

&lt;p&gt;In fact, I should be in the case of TermVector.WITH_POSITIONS_OFFSETS, using this parameters in my solr Shema.xml&lt;br/&gt;
&amp;lt;field name=&quot;...&quot; type=&quot;...&quot; indexed=&quot;true&quot; stored=&quot;true&quot; compressed=&quot;true&quot; omitNorms=&quot;true&quot; termVectors=&quot;true&quot; termPositions=&quot;true&quot; termOffsets=&quot;true&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;Somehow, I end up in TokenSources with argument tokenPositionsGuaranteedContiguous to false, which falls back to using offsets instead of positions.&lt;/p&gt;

&lt;p&gt;Maybe this is because of my overlapping tokens, maybe not, I&apos;ll have to take a couple of hours sometime to figure this out. At first sight, however it seams this parameter is always set to false when calling TokenSource.getTokenStream with an IndexReader because some code to use field infos is missing.&lt;/p&gt;

&lt;p&gt;Some work to do here, maybe, sometime. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13032468" author="mikemccand" created="Thu, 12 May 2011 16:46:30 +0100"  >&lt;p&gt;Ahh, interesting.&lt;/p&gt;

&lt;p&gt;So... maybe we should fix the code so that if in fact positions were included in the TVs, we use them?  Else, we fallback to the offset check to guess at the posIncr?  Could that work?&lt;/p&gt;</comment>
                    <comment id="13032472" author="pigo" created="Thu, 12 May 2011 16:58:38 +0100"  >&lt;p&gt;Yes, that would be the best.&lt;/p&gt;

&lt;p&gt;But I&apos;m not sure how to do that :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Check for positions in token stream ? Not sure it &quot;guaranties&quot; anything. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;add some kind of additionnal properties to the TermFreqVector returned by the IndexReader.getTermFreqVector() since it already access fields info ? Not sure it has&apos;nt too much impact.&lt;/li&gt;
	&lt;li&gt;Ask the index for field infos from TokenSources.getTokenStream ? Not sure it is the place but looks like the less dangerous option.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I haven&apos;t much time &apos;till the end of month to take a serious look at this, but I&apos;ll try to take some time next month.&lt;/p&gt;</comment>
                    <comment id="13032476" author="rcmuir" created="Thu, 12 May 2011 17:05:11 +0100"  >&lt;blockquote&gt;&lt;p&gt;So... maybe we should fix the code so that if in fact positions were included in the TVs, we use them? Else, we fallback to the offset check to guess at the posIncr? Could that work?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But this patch is still good right? We introduce this heuristic when positions are not available (or when highlighter pretends they are not).&lt;/p&gt;

&lt;p&gt;From my very vague understanding of highlighting, when overlapping positions or gaps in the position increment exist (tokenPositionsGuaranteedContiguous=false), the highlighter uses this algorithm intentionally (there are comments in the code indicating this position-based algorithm would fail otherwise).&lt;/p&gt;

&lt;p&gt;We could try to improve that on a followup issue?&lt;/p&gt;</comment>
                    <comment id="13032488" author="mikemccand" created="Thu, 12 May 2011 17:28:20 +0100"  >&lt;blockquote&gt;&lt;p&gt;We could try to improve that on a followup issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, I agree: progress not perfection!&lt;/p&gt;

&lt;p&gt;So I&apos;ll commit this patch and then open a follow on issue...&lt;/p&gt;

&lt;p&gt;Thanks Pierre!&lt;/p&gt;</comment>
                    <comment id="13032514" author="mikemccand" created="Thu, 12 May 2011 18:07:53 +0100"  >&lt;p&gt;OK I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3091&quot; title=&quot;Highlighter&amp;#39;s TokenSources should use TermVector positions if indexed&quot;&gt;LUCENE-3091&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="13043493" author="rcmuir" created="Fri, 3 Jun 2011 17:37:15 +0100"  >&lt;p&gt;Bulk closing for 3.2&lt;/p&gt;</comment>
                    <comment id="13677992" author="vrparekh@gmail.com" created="Fri, 7 Jun 2013 13:37:58 +0100"  >&lt;p&gt;i am facing same problem in solr 3.5&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12478817" name="LUCENE-3087.patch" size="9775" author="pigo" created="Wed, 11 May 2011 14:48:45 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 12 May 2011 10:43:11 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2142</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24606</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>