<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:32:07 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3097/LUCENE-3097.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3097] Post grouping faceting</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3097</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;This issues focuses on implementing post grouping faceting.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;How to handle multivalued fields. What field value to show with the facet.&lt;/li&gt;
	&lt;li&gt;Where the facet counts should be based on
	&lt;ul&gt;
		&lt;li&gt;Facet counts can be based on the normal documents. Ungrouped counts.&lt;/li&gt;
		&lt;li&gt;Facet counts can be based on the groups. Grouped counts.&lt;/li&gt;
		&lt;li&gt;Facet counts can be based on the combination of group value and facet value. Matrix counts.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And properly more implementation options.&lt;/p&gt;

&lt;p&gt;The first two methods are implemented in the &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-236&quot; title=&quot;Field collapsing&quot;&gt;&lt;del&gt;SOLR-236&lt;/del&gt;&lt;/a&gt; patch. For the first option it calculates a DocSet based on the individual documents from the query result. For the second option it calculates a DocSet for all the most relevant documents of a group. Once the DocSet is computed the FacetComponent and StatsComponent use one the DocSet to create facets and statistics.  &lt;/p&gt;

&lt;p&gt;This last one is a bit more complex. I think it is best explained with an example. Lets say we search on travel offers:&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;hotel&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;departure_airport&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;duration&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Hotel a&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AMS&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Hotel a&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;DUS&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Hotel b&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AMS&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Hotel b&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AMS&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;If we group by hotel and have a facet for airport. Most end users expect (according to my experience off course) the following airport facet:&lt;br/&gt;
AMS: 2&lt;br/&gt;
DUS: 1&lt;/p&gt;

&lt;p&gt;The above result can&apos;t be achieved by the first two methods. You either get counts AMS:3 and DUS:1 or 1 for both airports.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12507220">LUCENE-3097</key>
            <summary>Post grouping faceting</summary>
                <type id="2" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/newfeature.png">New Feature</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="martijn.v.groningen">Martijn van Groningen</assignee>
                                <reporter username="martijn.v.groningen">Martijn van Groningen</reporter>
                        <labels>
                    </labels>
                <created>Sat, 14 May 2011 15:10:32 +0100</created>
                <updated>Thu, 2 May 2013 03:29:42 +0100</updated>
                    <resolved>Mon, 14 Nov 2011 12:22:07 +0000</resolved>
                                            <fixVersion>3.4</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/grouping</component>
                        <due></due>
                    <votes>5</votes>
                        <watches>13</watches>
                                                    <comments>
                    <comment id="13033575" author="mikemccand" created="Sat, 14 May 2011 17:21:23 +0100"  >&lt;blockquote&gt;&lt;p&gt;If we group by hotel and have a facet for airport. Most end users expect (according to my experience off course) the following airport facet:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, I think that semantics is intuitive.  It treats each group as a doc w/ multi-valued field whose values are unioned from all docs within it.  So group &quot;Hotel a&quot; has values AMS, DUS for the departure_airport field.&lt;/p&gt;</comment>
                    <comment id="13033865" author="billnbell" created="Mon, 16 May 2011 05:09:47 +0100"  >&lt;p&gt;Here is another example...&lt;/p&gt;

&lt;p&gt;Doctors have multiple offices. I want to store doctorid, doctor&apos;s name, gender (male/female), and office address as separate rows. Then I want to group by doctorid. I only want the one doctor. I then want to facet by gender and see the numbers after it is grouped. I also want the total rows to be after grouping.&lt;/p&gt;

&lt;p&gt;doctorid, doctor&apos;s name,  gender, address&lt;br/&gt;
1, Bill Bell, male, 55 east main St&lt;br/&gt;
1, Bill Bell, male, 103 E 5th St&lt;br/&gt;
2, Sue Jones, female, 67 W 97th St&lt;br/&gt;
2, Sue Jones, female, 888 O&apos;West St&lt;br/&gt;
3, Toby Williams, male, 8 Vale St&lt;br/&gt;
4, Margie Youth, female, 5 E Medical Center&lt;br/&gt;
4, Margie Youth, female, 98456 E Rose St&lt;/p&gt;

&lt;p&gt;I would expect the grouping to return:&lt;/p&gt;

&lt;p&gt;total rows = 7&lt;br/&gt;
group total rows = 4&lt;br/&gt;
group_by&lt;br/&gt;
1, &lt;br/&gt;
   Bill Bell, male, 55 east main St&lt;br/&gt;
   Bill Bell, male, 103 E 5th St&lt;br/&gt;
2, &lt;br/&gt;
   Sue Jones, female, 67 W 97th St&lt;br/&gt;
   Sue Jones, female, 888 O&apos;West St&lt;br/&gt;
3, &lt;br/&gt;
   Toby Williams, male, 8 Vale St&lt;br/&gt;
4, &lt;br/&gt;
   Margie Youth, female, 5 E Medical Center&lt;br/&gt;
   Margie Youth, female, 98456 E Rose St&lt;/p&gt;

&lt;p&gt;I would expect if I say, rows=2, start=0, order by doctorid, I would get:&lt;/p&gt;

&lt;p&gt;1, &lt;br/&gt;
   Bill Bell, male, 55 east main St&lt;br/&gt;
   Bill Bell, male, 103 E 5th St&lt;br/&gt;
2, &lt;br/&gt;
   Sue Jones, female, 67 W 97th St&lt;br/&gt;
   Sue Jones, female, 888 O&apos;West St&lt;/p&gt;

&lt;p&gt;If I say, facet.field=gender I would expect:&lt;/p&gt;

&lt;p&gt;male: 2 (Bill Bell, Toby Williams)&lt;br/&gt;
female: 2 (Sue Jones, Margie Youth)&lt;/p&gt;

&lt;p&gt;If we had Spatial, and I had lat long for each address, I would expect if I say sort=geodist() asc that it would group and then find the closest &lt;br/&gt;
point for each grouping to return in the proper order. For example, if I was at 103 E 5th St, I would expect the output for doctorid=1 to be:&lt;/p&gt;

&lt;p&gt;group_by&lt;br/&gt;
1, &lt;br/&gt;
   Bill Bell, male, 103 E 5th St&lt;br/&gt;
   Bill Bell, male, 55 east main St&lt;/p&gt;


&lt;p&gt;If I only need the 1st point in the grouping I would expect the other points to be omitted. &lt;/p&gt;

&lt;p&gt;group_by&lt;br/&gt;
1, &lt;br/&gt;
   Bill Bell, male, 103 E 5th St&lt;br/&gt;
2, &lt;br/&gt;
   Sue Jones, female, 67 W 97th St&lt;br/&gt;
3, &lt;br/&gt;
   Toby Williams, male, 8 Vale St&lt;br/&gt;
4, &lt;br/&gt;
   Margie Youth, female, 5 E Medical Center&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;
</comment>
                    <comment id="13033939" author="mikemccand" created="Mon, 16 May 2011 10:50:31 +0100"  >&lt;p&gt;Thanks for the example Bill &amp;#8211; that makes sense!&lt;/p&gt;

&lt;p&gt;I think, in general, the post-group faceting should act &quot;as if&quot; you had indexed a single document per group, with multi-valued fields containing the union of all field values within that group, and then done &quot;normal&quot; faceting.  I believe this defines the semantics we are after for post-grouping faceting.&lt;/p&gt;</comment>
                    <comment id="13033940" author="martijn.v.groningen" created="Mon, 16 May 2011 10:59:27 +0100"  >&lt;blockquote&gt;&lt;p&gt;If I say, facet.field=gender I would expect:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think this can be achieved by basing the facet counts on the normal documents. Ungrouped counts.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If we had Spatial, and I had lat long for each address, I would expect if I say sort=geodist() asc that it would group and then find the closest &lt;br/&gt;
point for each grouping to return in the proper order. For example, if I was at 103 E 5th St, I would expect the output for doctorid=1 to be:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This just depends on the sort / group sort you provide. I think this should already work in the Solr trunk.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If I only need the 1st point in the grouping I would expect the other points to be omitted.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This depends on the group limit you provide in the request.&lt;/p&gt;</comment>
                    <comment id="13033947" author="mikemccand" created="Mon, 16 May 2011 11:10:38 +0100"  >&lt;p&gt;Right, gender in this example was single-valued per group.&lt;/p&gt;

&lt;p&gt;Another way to visualize / define how post-group faceting should behave is: imagine for ever facet value (ie field + value) you could define an aggregator.  Today, that aggregator is just the count of how many docs had that value from the full result set.  But you could, instead define it to be &quot;count(distinct(doctor_id))&quot;, and then you&apos;ll get the group counts you want.  (Other aggregators are conceivable &amp;#8211; max(relevance), min+max(prices), etc.).&lt;/p&gt;

&lt;p&gt;Conceptually I think this also defines the post-group faceting functionality, even if we would never implement it this way (ie count(distinct(doctor_id)) would be way too costly to do naively).&lt;/p&gt;</comment>
                    <comment id="13033953" author="mikemccand" created="Mon, 16 May 2011 11:23:39 +0100"  >&lt;p&gt;In fact, I think a very efficient way to implement post-group faceting is something like &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2454&quot; title=&quot;Nested Document query support&quot;&gt;&lt;del&gt;LUCENE-2454&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Ie, we just have to insure, at indexing time, that docs within the same &quot;group&quot; are adjacent, if you want to be able to count by unique group values.&lt;/p&gt;

&lt;p&gt;Hmm... but I think this (what your &quot;identifier&quot; field is, for facet counting purposes) should be decoupled from how you group.  I may group by State, for presentation purposes, but count facets by doctor_id.&lt;/p&gt;</comment>
                    <comment id="13034312" author="martijn.v.groningen" created="Mon, 16 May 2011 22:10:04 +0100"  >&lt;blockquote&gt;&lt;p&gt;Ie, we just have to insure, at indexing time, that docs within the same &quot;group&quot; are adjacent, if you want to be able to count by unique group values.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This means that in the same group also need to be in the same segment, right? Or if we use this mechanism for faceting documents with the same facet need to be in the same segment??? If that is true, it would make the collectors easier. The SentinelIntSet we use in the collectors is not necessary, because we can lookup the norm from the DocIndexTerms. We won&apos;t find the same group in a different segment. On the other hand with scalability in mind would make it complex. Since documents with the in the same group need to be in the same segment. Which makes indexing complex.&lt;/p&gt;</comment>
                    <comment id="13034836" author="mikemccand" created="Tue, 17 May 2011 17:00:44 +0100"  >&lt;p&gt;Right, this&apos;d mean all docs sharing a given group value are contiguous and in the same segment.  The app would have to ensure this, in order to use a collector that takes advantage of it.&lt;/p&gt;</comment>
                    <comment id="13037070" author="simonw" created="Fri, 20 May 2011 21:38:26 +0100"  >&lt;p&gt;Martjin, you should assigne this issue to you to make sure its not moved to version 3.3&lt;/p&gt;</comment>
                    <comment id="13037643" author="martijn.v.groningen" created="Sun, 22 May 2011 19:52:18 +0100"  >&lt;p&gt;Attached an initial patch with a collector that collects the most relevant documents for each group that match the query.&lt;/p&gt;

&lt;p&gt;This collector can be used to create facets based on grouped counts. Actually the collector has many implementations for different situations. For example when the group sort within the groups is only score or fields. There is a general implementation that works for all sorts (e.g. a function).&lt;/p&gt;

&lt;p&gt;Just as in the caching collector there is a factory method that selects the most efficient collector based on the group sort.&lt;/p&gt;

&lt;p&gt;TODO:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Add tests&lt;/li&gt;
	&lt;li&gt;Clean up code / jdoc&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Feedback welcome!&lt;/p&gt;</comment>
                    <comment id="13038297" author="mikemccand" created="Mon, 23 May 2011 23:51:11 +0100"  >
&lt;p&gt;Patch looks good Martijn!  A few small things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think create() needs to be fixed to handle other SortField&lt;br/&gt;
    types?  Eg, INT, FLOAT?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I think you need to hold the docBase from each setNextReader and&lt;br/&gt;
    re-base your docs stored in the GroupHead?  Because when you&lt;br/&gt;
    retrieve them in the end you return them as top-level docIDs.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This would really benefit from the random test in TestGrouping &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;This can indeed help with post-facet counting, but I think only on&lt;br/&gt;
fields whose value is constant within the group?  (Ie, because we pick&lt;br/&gt;
only the &quot;head&quot; doc, as long as the head doc is guaranteed to have the&lt;br/&gt;
same value for field X, it&apos;s safe to use that doc to represent the&lt;br/&gt;
entire group for facet counting).&lt;/p&gt;

&lt;p&gt;Once docs within one can have different values for field X then we&lt;br/&gt;
need a different approach for counting their facets...&lt;/p&gt;</comment>
                    <comment id="13038317" author="martijn.v.groningen" created="Tue, 24 May 2011 00:23:23 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think create() needs to be fixed to handle other SortField types? Eg, INT, FLOAT?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Oops I forgot. We need to use the general impl for that.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think you need to hold the docBase from each setNextReader and re-base your docs stored in the GroupHead?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think I&apos;m doing that. If you look at the updateHead() methods. You see that I rebasing the ids.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Once docs within one can have different values for field X then we need a different approach for counting their facets...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;But that would only happen when if an update happen during a search? Then all collectors can have this problem, right?&lt;/p&gt;</comment>
                    <comment id="13038605" author="mikemccand" created="Tue, 24 May 2011 16:01:10 +0100"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I think you need to hold the docBase from each setNextReader and re-base your docs stored in the GroupHead?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think I&apos;m doing that. If you look at the updateHead() methods. You see that I rebasing the ids.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ahh excellent, I missed that.  Looks good!&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Once docs within one can have different values for field X then we need a different approach for counting their facets...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But that would only happen when if an update happen during a search?&lt;br/&gt;
Then all collectors can have this problem, right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is independent of updating during search I think.&lt;/p&gt;

&lt;p&gt;I don&apos;t think the existing collectors have a problem here?  Ie the&lt;br/&gt;
grouping collectors aren&apos;t normally concerned w/ multivalued fields of&lt;br/&gt;
the docs within each group.&lt;/p&gt;

&lt;p&gt;It&apos;s only because we intend for these new group collectors to make&lt;br/&gt;
&quot;post-grouping facet counting&quot; work in Solr that we have a problem.&lt;br/&gt;
Ie, these collectors won&apos;t properly count facets of fields that have&lt;br/&gt;
different values w/in one group?&lt;/p&gt;

&lt;p&gt;Say this is my original content:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  name=3-wolf shirt
    size=M, color=red
    size=S, color=red
    size=L, color=blue

  name=frog shirt
    size=M, color=white
    size=S, color=red
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But, I&apos;m not using nested docs (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2454&quot; title=&quot;Nested Document query support&quot;&gt;&lt;del&gt;LUCENE-2454&lt;/del&gt;&lt;/a&gt;), so I had to fully&lt;br/&gt;
denormalize into these docs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  name=3-wolf shirt, size=M, color=red
  name=3-wolf shirt, size=S, color=red
  name=3-wolf shirt, size=L, color=blue
  name=frog shirt,   size=M, color=white
  name=frog shirt,   size=S, color=red
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, if user does a search for &quot;color=red&quot;... without post-group&lt;br/&gt;
faceting (ie what Solr has today), you incorrectly see count=3 for&lt;br/&gt;
color=red.&lt;/p&gt;

&lt;p&gt;With post-group faceting, you should see count=2 for color=red (which&lt;br/&gt;
these collectors will do, correctly, I think?), but you should also&lt;br/&gt;
see count=2 for size=S, which I think these collectors will fail to&lt;br/&gt;
do?  (Ie, because they only retain the top doc per group...?).&lt;/p&gt;</comment>
                    <comment id="13040033" author="billnbell" created="Fri, 27 May 2011 03:18:38 +0100"  >&lt;p&gt;One way to do this would be to treat each grouping as unique fields. That would solve both use cases:&lt;/p&gt;

&lt;p&gt;My use case would work for top doc per group, but I can see that the counting looks for &quot;unique values in the field per group&quot;. So your example would &quot;look like for counting&quot; for color:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 name=3-wolf shirt
    color=red
    color=blue

  name=frog shirt
    color=white
    color=red
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;color&lt;br/&gt;
   red=2, blue=1, white=1&lt;/p&gt;

&lt;p&gt;For size the counting looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
name=3-wolf shirt
    size=M, color=red
    size=S, color=red
    size=L, color=blue

  name=frog shirt
    size=M, color=white
    size=S, color=red
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;size&lt;br/&gt;
   M=2, S=2, L=1&lt;/p&gt;

&lt;p&gt;And the facets for size would not change for:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
name=3-wolf shirt
    size=M, color=red
    size=S, color=red
    size=L, color=blue
    size=S, color=blue
    size=S, color=blue
    size=L, color=blue

  name=frog shirt
    size=M, color=white
    size=S, color=red
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                    <comment id="13040304" author="mikemccand" created="Fri, 27 May 2011 17:10:15 +0100"  >&lt;p&gt;Right, I think for post-grouping facet counts, the facet counting&lt;br/&gt;
process must be aware of the groups.  Within each group, it can only&lt;br/&gt;
count each value (color=red, size=S) once...&lt;/p&gt;</comment>
                    <comment id="13043210" author="billnbell" created="Fri, 3 Jun 2011 05:35:18 +0100"  >&lt;p&gt;OK... This issue seems stalled? Are we waiting on something else?&lt;/p&gt;</comment>
                    <comment id="13043229" author="martijn.v.groningen" created="Fri, 3 Jun 2011 07:35:56 +0100"  >&lt;blockquote&gt;&lt;p&gt;OK... This issue seems stalled? Are we waiting on something else?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For the current attached patch I think that we first need to have the same abstraction as the collectors in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3099&quot; title=&quot;Grouping module should allow subclasses to set the group key per document&quot;&gt;&lt;del&gt;LUCENE-3099&lt;/del&gt;&lt;/a&gt; have. I think that it can be committed. After that we only need to wire it up in Solr (I&apos;ll open a new issue for that). Then we have the same behavior as in &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-236&quot; title=&quot;Field collapsing&quot;&gt;&lt;del&gt;SOLR-236&lt;/del&gt;&lt;/a&gt; patch with the facet.after option. Don&apos;t worry we&apos;ll get this soon!&lt;/p&gt;

&lt;p&gt;This patch only support computing the grouped counts. Not the other the other count variant. I think for that we also depend on the faceting module.&lt;/p&gt;</comment>
                    <comment id="13043561" author="rcmuir" created="Fri, 3 Jun 2011 17:40:47 +0100"  >&lt;p&gt;bulk move 3.2 -&amp;gt; 3.3&lt;/p&gt;</comment>
                    <comment id="13044256" author="mikemccand" created="Sat, 4 Jun 2011 11:20:45 +0100"  >&lt;p&gt;Also, this patch won&apos;t properly count facets if the field ever has multiple values within one group.  But maybe that&apos;s fine for the first go.... progress not perfection.&lt;/p&gt;</comment>
                    <comment id="13044269" author="martijn.v.groningen" created="Sat, 4 Jun 2011 12:05:18 +0100"  >&lt;blockquote&gt;&lt;p&gt;Also, this patch won&apos;t properly count facets if the field ever has multiple values within one group&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That is true. If facet values are different within a group the current collectors in the patch won&apos;t notice that.&lt;br/&gt;
For the case Bill is describing that facets work as expected with the current patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But maybe that&apos;s fine for the first go.... progress not perfection.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Definitely! But to continue I think we need the facet module.&lt;/p&gt;</comment>
                    <comment id="13048742" author="martijn.v.groningen" created="Mon, 13 Jun 2011 21:13:42 +0100"  >&lt;p&gt;An updated version of the patch. This is still work in progress.&lt;/p&gt;

&lt;p&gt;I basically rewrote the code in the same way as the other collectors were rewritten for &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3099&quot; title=&quot;Grouping module should allow subclasses to set the group key per document&quot;&gt;&lt;del&gt;LUCENE-3099&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Things todo are creating tests and add some more documentation. This patch only covers the second facet / grouping method. &lt;/p&gt;</comment>
                    <comment id="13066742" author="martijn.v.groningen" created="Sun, 17 Jul 2011 22:51:29 +0100"  >&lt;p&gt;Attached updated patch.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Updated to current trunk.&lt;/li&gt;
	&lt;li&gt;Added first test, that prove that the basic functionality is working.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Things to be done:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Hook the collectors into the random test.&lt;/li&gt;
	&lt;li&gt;Some more javadoc&lt;/li&gt;
	&lt;li&gt;Backport to 3x.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13069249" author="martijn.v.groningen" created="Thu, 21 Jul 2011 23:26:39 +0100"  >&lt;p&gt;Updated the patch.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Included the grouping collector into the random test.&lt;/li&gt;
	&lt;li&gt;Added more documentation.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think this collector is ready to be committed. This collector implements the second grouping / faceting case that I&apos;ve described in the issue description.&lt;/p&gt;</comment>
                    <comment id="13069536" author="mikemccand" created="Fri, 22 Jul 2011 14:16:45 +0100"  >&lt;p&gt;Hmm I hit a test failure w/ this patch:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ant test -Dtestcase=TermAllGroupHeadsCollectorTest -Dtestmethod=testRetrieveGroupHeadsAsArrayAndOpenBitset -Dtests.seed=-8084704095495262480:-1926953444883897447
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also: can this collector use the new FixedBitSet instead of OpenBitSet...?&lt;/p&gt;</comment>
                    <comment id="13070158" author="martijn.v.groningen" created="Sun, 24 Jul 2011 13:40:18 +0100"  >&lt;p&gt;Updated the patch.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Fixed the test failure that Michael reported. The numbits in the bitset was equal to number of ids I set. There fore the Java assertion failed. Obviously the numbits must be one greater than the ids being set.&lt;/li&gt;
	&lt;li&gt;Changed retrieveGroupHeads(maxDoc) return type to FixedBitSet.&lt;/li&gt;
	&lt;li&gt;Moved random tests related to AbstractAllGroupHeadsCollector to TermAllGroupHeadsCollectorTest.&lt;/li&gt;
	&lt;li&gt;During the random tests I ran into some other test failures related to sorting inside a group. I fixed those test failures as well.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think the patch is now ready to be committed!&lt;/p&gt;</comment>
                    <comment id="13070160" author="martijn.v.groningen" created="Sun, 24 Jul 2011 13:43:39 +0100"  >&lt;p&gt;Updated patch again. I forgot to update some jdocs.&lt;/p&gt;</comment>
                    <comment id="13070231" author="martijn.v.groningen" created="Sun, 24 Jul 2011 20:11:23 +0100"  >&lt;p&gt;Committed to trunk (rev. 1150470) and 3x branch (rev. 1150472). I&apos;ll keep this issue open for future developments.&lt;/p&gt;</comment>
                    <comment id="13070451" author="mikemccand" created="Mon, 25 Jul 2011 13:06:33 +0100"  >&lt;p&gt;The package.html still references OpenBitSet here?&lt;/p&gt;</comment>
                    <comment id="13070464" author="martijn.v.groningen" created="Mon, 25 Jul 2011 13:38:15 +0100"  >&lt;p&gt;I&apos;ve fixed that. It now references FixedBitSet.&lt;/p&gt;</comment>
                    <comment id="13070486" author="mikemccand" created="Mon, 25 Jul 2011 14:13:31 +0100"  >&lt;p&gt;Thanks/&lt;/p&gt;

&lt;p&gt;Woops &amp;#8211; also the comment in the java code in the package.html still says OpenBitSet!&lt;/p&gt;</comment>
                    <comment id="13080735" author="billnbell" created="Mon, 8 Aug 2011 05:28:16 +0100"  >&lt;p&gt;Set this to resolved?&lt;/p&gt;</comment>
                    <comment id="13148859" author="simonw" created="Fri, 11 Nov 2011 23:52:39 +0000"  >&lt;p&gt;martjin, is this done? seems like you committed to 3.x and trunk. if so can you close/resolve this issue?&lt;/p&gt;</comment>
                    <comment id="13149006" author="martijn.v.groningen" created="Sat, 12 Nov 2011 08:28:08 +0000"  >&lt;p&gt;Well the code that got committed only creates facets for the most relevant document per group. This isn&apos;t really grouped facets. To implement this we need to modify Solr&apos;s faceting code / facet module code. So I think we can close this one and open a Solr issue to implement grouped facets in Solr (I do have some code for this, but it isn&apos;t perfect...) and maybe also an issue to add this to the faceting module&lt;/p&gt;</comment>
                    <comment id="13149601" author="martijn.v.groningen" created="Mon, 14 Nov 2011 12:22:07 +0000"  >&lt;p&gt;The support for real grouped faceting (matrix counts) needs to be added to Solr or faceting module.&lt;/p&gt;</comment>
                    <comment id="13164331" author="iangrainger" created="Wed, 7 Dec 2011 11:29:57 +0000"  >&lt;p&gt;Hi - is the matrix count feature available in Solr 3.5? Seeing as this is marked as closed I assume it is? If so do I need to do anything to use this feature?&lt;/p&gt;</comment>
                    <comment id="13164482" author="iangrainger" created="Wed, 7 Dec 2011 16:24:00 +0000"  >&lt;p&gt;Oh, sorry- I just read the previous comment &lt;em&gt;properly&lt;/em&gt; - So the case I need fixing is &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2898&quot; class=&quot;external-link&quot;&gt;SOLR-2898&lt;/a&gt;?&lt;/p&gt;</comment>
                    <comment id="13164496" author="martijn.v.groningen" created="Wed, 7 Dec 2011 16:37:06 +0000"  >&lt;p&gt;Yes, if you&apos;re using Solr. You can try to apply the patch it should work for field facets. &lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10032">
                <name>Blocker</name>
                                                <inwardlinks description="is blocked by">
                            <issuelink>
            <issuekey id="12506488">LUCENE-3079</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12406299">LUCENE-1421</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                        <issuelinktype id="10001">
                <name>dependent</name>
                                                <inwardlinks description="is depended upon by">
                            <issuelink>
            <issuekey id="12514540">SOLR-2665</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12487369" name="LUCENE-30971.patch" size="44758" author="martijn.v.groningen" created="Thu, 21 Jul 2011 23:26:39 +0100" />
                    <attachment id="12487636" name="LUCENE-3097.patch" size="50749" author="martijn.v.groningen" created="Sun, 24 Jul 2011 13:43:39 +0100" />
                    <attachment id="12487635" name="LUCENE-3097.patch" size="49928" author="martijn.v.groningen" created="Sun, 24 Jul 2011 13:40:18 +0100" />
                    <attachment id="12486781" name="LUCENE-3097.patch" size="33502" author="martijn.v.groningen" created="Sun, 17 Jul 2011 22:51:29 +0100" />
                    <attachment id="12482368" name="LUCENE-3097.patch" size="26588" author="martijn.v.groningen" created="Mon, 13 Jun 2011 21:13:42 +0100" />
                    <attachment id="12480052" name="LUCENE-3097.patch" size="25168" author="martijn.v.groningen" created="Sun, 22 May 2011 19:52:18 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 14 May 2011 16:21:23 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10829</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12225</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>