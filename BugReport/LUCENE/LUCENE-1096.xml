<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:28:13 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1096/LUCENE-1096.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1096] Deleting docs of all returned Hits during search causes ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1096</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;For background user discussion:&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/document-deletion-problem-to14414351.html&quot; class=&quot;external-link&quot;&gt;http://www.nabble.com/document-deletion-problem-to14414351.html&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Hits h = m_indexSearcher.search(q); &lt;span class=&quot;code-comment&quot;&gt;// Returns 11475 documents 
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; h.length(); i++) 
{ 
  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; doc = h.id(i); 
  m_indexSearcher.getIndexReader().deleteDocument(doc);  &amp;lt;-- causes ArrayIndexOutOfBoundsException when i = 6400
} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;WindowsXPSP1/Lenovo-T60p&lt;/p&gt;</environment>
            <key id="12385007">LUCENE-1096</key>
            <summary>Deleting docs of all returned Hits during search causes ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="snowhow">Tushar B</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Dec 2007 06:22:37 +0000</created>
                <updated>Fri, 25 Jan 2008 03:24:14 +0000</updated>
                    <resolved>Sun, 23 Dec 2007 20:57:47 +0000</resolved>
                            <version>2.1</version>
                                <fixVersion>2.3</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12553657" author="doronc" created="Thu, 20 Dec 2007 12:35:24 +0000"  >&lt;p&gt;refine summary and beautify description.&lt;/p&gt;</comment>
                    <comment id="12553658" author="doronc" created="Thu, 20 Dec 2007 12:36:53 +0000"  >&lt;p&gt;Test failing with this bug.&lt;/p&gt;</comment>
                    <comment id="12553817" author="doronc" created="Thu, 20 Dec 2007 23:21:57 +0000"  >&lt;p&gt;It seems that this is a serious problem with Hits based search. An application deleting returned hits as in this case will actually get &quot;holes&quot; in the returned docs, every time getMoreDocs() is internally invoked. &lt;/p&gt;

&lt;p&gt;For instance, say all docs match, and the app deletes doc 50. Hits 0 to 99 are ok, they will contain docs 0 to 99. But because of the deletion, hit 100 will be doc 101, i.e. doc 100 was skipped.&lt;/p&gt;

&lt;p&gt;Fixing this behavior is possible in the Hits class if only hits are deleted. I.e. if, while getting hit n, hits m where m&amp;lt;=n are deleted. But if a higher doc is deleted, a doc that would be seen later, after more internal calls to getMoreDocs(), things get more messy, and an ArrayIndexOutOfBound exception can be caused, as in this bug.&lt;/p&gt;

&lt;p&gt;Note that the latter case can also happen if another thread deletes such a &quot;front&quot; hit doc. &lt;/p&gt;

&lt;p&gt;I think the proper exception for the latter case is ConcurrentModificationException, and Hits should be changed to distinguish between the two.&lt;/p&gt;</comment>
                    <comment id="12553824" author="doronc" created="Thu, 20 Dec 2007 23:54:18 +0000"  >&lt;p&gt;Patch with tests for the two scenarios described above, and a fix for Hits.&lt;/p&gt;

&lt;p&gt;The fix works as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Records the # deleted docs when the search starts.&lt;/li&gt;
	&lt;li&gt;Records the total number of hits as found in the&lt;br/&gt;
   first call to getMoreDocs(). &lt;/li&gt;
	&lt;li&gt;After every additional call to getMoreDocs(), the # deleted&lt;br/&gt;
   docs is checked again. &lt;br/&gt;
   If it was modified, the new hits are checked to see if some &lt;br/&gt;
   of the old hits are missing, due to deletions in between. &lt;br/&gt;
   The start point for copying new hits into the array of hits &lt;br/&gt;
    is updated accordingly. Also updated is the totalHits count.&lt;/li&gt;
	&lt;li&gt;Trying to fetch a hit that is not higher than the original # hits&lt;br/&gt;
   but is larger than the current number of hits, triggers &lt;br/&gt;
   a ConcurrentModificationException, because this hit was&lt;br/&gt;
   deleted before we were able to retrieve it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note that when searching not with an IndexSearcher,&lt;br/&gt;
there is no access for counting deletions and so the two&lt;br/&gt;
arrays check is always performed - as part of getMoreDocs().&lt;/p&gt;

&lt;p&gt;All tests pass.&lt;/p&gt;</comment>
                    <comment id="12553944" author="doronc" created="Fri, 21 Dec 2007 13:27:49 +0000"  >&lt;p&gt;An updated patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;more intensive tests.&lt;/li&gt;
	&lt;li&gt;Hits now compares status between iterations so that it checks&lt;br/&gt;
  for hits deletions only if anything changed from previous invocation&lt;br/&gt;
  of getMoreDocs().&lt;/li&gt;
	&lt;li&gt;Javadocs updated explaining when ConcurrentModificationException is thrown.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12554196" author="doronc" created="Sun, 23 Dec 2007 20:57:46 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12372081" name="lucene-1096.patch" size="11725" author="doronc" created="Fri, 21 Dec 2007 13:27:48 +0000" />
                    <attachment id="12372049" name="lucene-1096.patch" size="8988" author="doronc" created="Thu, 20 Dec 2007 23:54:18 +0000" />
                    <attachment id="12372018" name="TestSearchDelete.java" size="2804" author="doronc" created="Thu, 20 Dec 2007 12:36:53 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 20 Dec 2007 12:35:24 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12649</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26633</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>