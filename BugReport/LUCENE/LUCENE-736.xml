<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:29:13 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-736/LUCENE-736.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-736] Sloppy Phrase Scorer matches the doc &quot;A B C D E&quot; for query = &quot;B C B&quot;~2</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-736</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;This is an extension of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-697&quot; class=&quot;external-link&quot;&gt;https://issues.apache.org/jira/browse/LUCENE-697&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In addition to abnormalities Yonik pointed out in 697, there seem to be other issues with slopy phrase search and scoring.&lt;/p&gt;

&lt;p&gt;1) A phrase with a repeated word would be detected in a document although it is not there.&lt;br/&gt;
I.e. document = A B D C E , query = &quot;B C B&quot; would not find this document (as expected), but query &quot;B C B&quot;~2 would find it. &lt;br/&gt;
I think that no matter how large the slop is, this document should not be a match.&lt;/p&gt;

&lt;p&gt;2) A document containing both orders of a query, symmetrically, would score differently for the queru and for its reveresed form.&lt;br/&gt;
I.e. document = A B C B A would score differently for queries &quot;B C&quot;~2 and &quot;C B&quot;~2, although it is symmetric to both.&lt;/p&gt;

&lt;p&gt;I will attach test cases that show both these problems and the one reported by Yonik in 697. &lt;/p&gt;</description>
                <environment></environment>
            <key id="12357428">LUCENE-736</key>
            <summary>Sloppy Phrase Scorer matches the doc &quot;A B C D E&quot; for query = &quot;B C B&quot;~2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="doronc">Doron Cohen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 Dec 2006 09:13:34 +0000</created>
                <updated>Tue, 19 Jun 2007 09:14:50 +0100</updated>
                    <resolved>Tue, 24 Apr 2007 06:37:43 +0100</resolved>
                                            <fixVersion>2.2</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12454847" author="doronc" created="Fri, 1 Dec 2006 09:24:59 +0000"  >&lt;p&gt;sloppy_phrase_tests.patch.txt  contains:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;two test cases added in TestPhraseQuery.&lt;br/&gt;
These new tests currently fail. &lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;skipTo() behavior tests that were originaly in issue 697.&lt;br/&gt;
This too currently fails.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12454866" author="doronc" created="Fri, 1 Dec 2006 10:24:49 +0000"  >&lt;p&gt;Attached sloppy_phrase_java.patch.txt is fixing the failing new tests. &lt;br/&gt;
This also includes the skipTo() bug from issue 697.&lt;/p&gt;

&lt;p&gt;The fix does not guarantee that document A B C B A would score &quot;A B C&quot;~4 and &quot;C B A&quot;~4 the same. &lt;br/&gt;
It does that for &quot;B C&quot;~2 and &quot;C B&quot;~2.&lt;br/&gt;
This is because a general fix for that (at least the one that I devised) would be too expensive.&lt;br/&gt;
Although this is an interesting case, I&apos;d like to think it is not an important one.&lt;/p&gt;

&lt;p&gt;This fix comes with a performance cost:  about 15% degradation in CPU activity of sloppy phrase scoring, as the attcahed perf logs show.&lt;br/&gt;
Here is the summary of these tests:&lt;/p&gt;

&lt;p&gt;.......Operation..........runCnt...recsPerRun.....rec/s..elapsedSec&lt;br/&gt;
Orig:..SearchSameRdr_3000......4.........3000.....216.1.......55.52&lt;br/&gt;
New:...SearchSameRdr_3000......4.........3000.....187.8.......63.91&lt;/p&gt;

&lt;p&gt;I think that in a real life scenario - real index, real documents, real queries - this extra CPU will be shaded by IO, but I also belive we should refrain from slowing down search, so, unhappy with this degradation (anyone would&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, I would look for a other ways to fix this - ideas are welcome.&lt;/p&gt;

&lt;p&gt;Perf test was done using the task benchmark framework (see issue 675), The logs show also the queries that were searched.&lt;/p&gt;

&lt;p&gt;All tests pass with new code.&lt;/p&gt;</comment>
                    <comment id="12454955" author="yseeley@gmail.com" created="Fri, 1 Dec 2006 17:04:59 +0000"  >&lt;p&gt;Great investigations Doron!&lt;br/&gt;
Personally I&apos;m more concerned with (1) than (2).  Was the fix for one issue more responsible for the performance loss than the other?&lt;/p&gt;
</comment>
                    <comment id="12454971" author="paul.elschot@xs4all.nl" created="Fri, 1 Dec 2006 19:02:18 +0000"  >&lt;p&gt;I have had similar concerns when I implemented NearSpansOrdered.java and NearSpansUnordered.java,&lt;br/&gt;
which are in the trunk now.&lt;br/&gt;
These match somewhat different phrases, but it would be good to ensure that the same matches score&lt;br/&gt;
the same for spans and phrases.&lt;/p&gt;</comment>
                    <comment id="12455080" author="doronc" created="Sat, 2 Dec 2006 08:33:34 +0000"  >&lt;p&gt;The change to fix case 2 was not the main performance degradation cause.&lt;/p&gt;

&lt;p&gt;I agree with Yonik that case 2 is much more important than case 1.&lt;br/&gt;
So I modified to fix case 2 but not case 1. &lt;br/&gt;
Also extended the perf test to create also the &quot;reversed&quot; form of the sloppy phrases (slop increased for reversed cases so that queries would match docs).&lt;/p&gt;

&lt;p&gt;Cost of this fix dropped from 15% more CPU time to about 3%. &lt;br/&gt;
I feel ok with this.&lt;/p&gt;

&lt;p&gt;.....Operation..........runCnt...recsPerRun...rec/s..elapsedSec....avgUsedMem....avgTotalMem&lt;br/&gt;
Orig.SearchSameRdr_6000......4.........6000...194.2......123.59.....8,032,732.....11,333,632&lt;br/&gt;
New..SearchSameRdr_6000......4.........6000...187.5......128.02.....8,172,258.....11,333,632&lt;/p&gt;

&lt;p&gt;Attached sloppy_phrase.patch2.txt has the updated fix, including both java and test parts. Some of the asserts in the new tests were commented out cause the patch takes decision not to fix case 1 above.&lt;/p&gt;

&lt;p&gt;Also attaching the updates perf test logs - res-search-orig2.log and res-search-new2.log.&lt;/p&gt;

&lt;p&gt;I did not compare scoring of similar cases between sloppy phrase and near spans and Paul suggested - perhaps next week - not sure this should hold progress with this issue.&lt;/p&gt;</comment>
                    <comment id="12455085" author="paul.elschot@xs4all.nl" created="Sat, 2 Dec 2006 09:46:14 +0000"  >&lt;p&gt;There is no need to hold up this issue for span phrases.&lt;br/&gt;
Perhaps a good way to get the spans and the phrases work well together is by adding a getSpans() to&lt;br/&gt;
PhraseQuery, or by introduction of a SpanPhraseQuery. But this would better be done at a new jira issue.&lt;/p&gt;</comment>
                    <comment id="12455422" author="doronc" created="Mon, 4 Dec 2006 21:08:57 +0000"  >&lt;p&gt;There is a bug in my recent patch (sloppy_phrase.patch2.txt):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for the case of phrase with repetitions, some additional computation is required before starting each doc.&lt;/li&gt;
	&lt;li&gt;this does not affect the regular/common case of phrase with no repetitions.&lt;br/&gt;
I extended the test to expose this and will commit an updated patch later today.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12455429" author="doronc" created="Mon, 4 Dec 2006 21:49:59 +0000"  >&lt;p&gt;Test case - testNonExistingWrappedPhrase - was extended.&lt;br/&gt;
A bug in the patch (described above) was fixed.&lt;/p&gt;

&lt;p&gt;All tests pass. &lt;/p&gt;</comment>
                    <comment id="12489187" author="otis" created="Mon, 16 Apr 2007 19:23:55 +0100"  >&lt;p&gt;Doron, sounds like this is ripe for a commit now to take care of both this and &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-697&quot; title=&quot;Scorer.skipTo affects sloppyPhrase scoring&quot;&gt;&lt;del&gt;LUCENE-697&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="12489930" author="doronc" created="Thu, 19 Apr 2007 06:23:14 +0100"  >&lt;p&gt;Need to see if the parts of the test (in QueryUtils) that were disabled by &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-730&quot; title=&quot;Restore top level disjunction performance&quot;&gt;&lt;del&gt;LUCENE-730&lt;/del&gt;&lt;/a&gt; (BooleanScorer2 sometimes falls back to BooleanScorer). One possibility is to have two versions of this - a BooleanScoere version, and the rest - this issue (736) is about sloppy/exact phrase scoring, so it would fall into the &quot;rest&quot;, and so the test would still catch this.&lt;/p&gt;</comment>
                    <comment id="12491136" author="doronc" created="Tue, 24 Apr 2007 06:15:11 +0100"  >&lt;p&gt;Changing the title to match what we decided to fix here.&lt;/p&gt;</comment>
                    <comment id="12491138" author="doronc" created="Tue, 24 Apr 2007 06:37:43 +0100"  >&lt;p&gt;Fixed.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Search time cost of this fix is 4%, for sloppy phrase search.&lt;/li&gt;
	&lt;li&gt;This fix also partially brings back the the tests checkSkipTo() in QueryUtils,&lt;br/&gt;
  (which was disabled by &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-730&quot; title=&quot;Restore top level disjunction performance&quot;&gt;&lt;del&gt;LUCENE-730&lt;/del&gt;&lt;/a&gt;), but this is now invoked only for non Boolean scorers.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12491141" author="doronc" created="Tue, 24 Apr 2007 06:39:53 +0100"  >&lt;p&gt;Attaching for any future reference the fix that was applied for this.&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12353904">LUCENE-697</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12346205" name="perf-search-new.log" size="188239" author="doronc" created="Fri, 1 Dec 2006 10:24:49 +0000" />
                    <attachment id="12346206" name="perf-search-orig.log" size="188052" author="doronc" created="Fri, 1 Dec 2006 10:24:49 +0000" />
                    <attachment id="12346273" name="res-search-new2.log" size="371871" author="doronc" created="Sat, 2 Dec 2006 08:33:34 +0000" />
                    <attachment id="12346272" name="res-search-orig2.log" size="372317" author="doronc" created="Sat, 2 Dec 2006 08:33:34 +0000" />
                    <attachment id="12346204" name="sloppy_phrase_java.patch.txt" size="12058" author="doronc" created="Fri, 1 Dec 2006 10:24:49 +0000" />
                    <attachment id="12346271" name="sloppy_phrase.patch2.txt" size="25389" author="doronc" created="Sat, 2 Dec 2006 08:33:34 +0000" />
                    <attachment id="12356110" name="sloppy_phrase.patch3.txt" size="31150" author="doronc" created="Tue, 24 Apr 2007 06:39:53 +0100" />
                    <attachment id="12346374" name="sloppy_phrase.patch3.txt" size="27983" author="doronc" created="Mon, 4 Dec 2006 21:49:59 +0000" />
                    <attachment id="12346191" name="sloppy_phrase_tests.patch.txt" size="11812" author="doronc" created="Fri, 1 Dec 2006 09:24:59 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>9.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 1 Dec 2006 17:04:59 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>13016</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26994</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>