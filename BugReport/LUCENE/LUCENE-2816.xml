<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:11:46 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2816/LUCENE-2816.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2816] MMapDirectory speedups</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2816</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;MMapDirectory has some performance problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When the file is larger than Integer.MAX_VALUE, we use MultiMMapIndexInput,&lt;br/&gt;
which does a lot of unnecessary bounds-checks for its buffer-switching etc. &lt;br/&gt;
Instead, like MMapIndexInput, it should rely upon the contract of these operations&lt;br/&gt;
in ByteBuffer (which will do a bounds check always and throw BufferUnderflowException).&lt;br/&gt;
Our &apos;buffer&apos; is so large (Integer.MAX_VALUE) that its rare this happens and doing&lt;br/&gt;
our own bounds checks just slows things down.&lt;/li&gt;
	&lt;li&gt;the readInt()/readLong()/readShort() are slow and should just defer to ByteBuffer.readInt(), etc&lt;br/&gt;
This isn&apos;t very important since we don&apos;t much use these, but I think there&apos;s no reason&lt;br/&gt;
users (e.g. codec writers) should have to readBytes() + wrap as bytebuffer + get an &lt;br/&gt;
IntBuffer view when readInt() can be almost as fast...&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
            <key id="12493492">LUCENE-2816</key>
            <summary>MMapDirectory speedups</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png">Resolved</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="rcmuir">Robert Muir</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Fri, 17 Dec 2010 08:34:31 +0000</created>
                <updated>Sun, 26 Dec 2010 15:04:01 +0000</updated>
                    <resolved>Sun, 26 Dec 2010 15:04:01 +0000</resolved>
                            <version>3.1</version>
                <version>4.0-ALPHA</version>
                                                <component>core/store</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12972392" author="rcmuir" created="Fri, 17 Dec 2010 08:36:19 +0000"  >&lt;p&gt;Here&apos;s the most important benchmark: speeding up the MultiMMap&apos;s readByte(s) in general:&lt;/p&gt;

&lt;p&gt;MultiMMapIndexInput readByte(s) improvements &lt;span class=&quot;error&quot;&gt;&amp;#91;trunk, Standard codec&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Query&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Pct diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanFirst(unit, 5)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.72&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.85&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;1.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+nebraska +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;137.47&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;139.33&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;1.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanNear(&lt;span class=&quot;error&quot;&gt;&amp;#91;unit, state&amp;#93;&lt;/span&gt;, 10, true)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.90&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.94&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;1.4%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&quot;unit state&quot;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5.88&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5.99&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;1.8%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.06&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.20&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;2.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+unit +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.68&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.87&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;2.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.00&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.23&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;2.9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.19&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.41&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;3.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;22.66&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;23.41&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;3.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;uni*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.54&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;13.12&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;4.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.61&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.12&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;4.8%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.52&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.65&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;5.1%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;28.72&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;30.23&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;5.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;un*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;44.84&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;48.06&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;7.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;u*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;13.17&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;14.51&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;10.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;In the bulk postings branch, I&apos;ve been experimenting with various techniques for FOR/PFOR &lt;br/&gt;
and one thing i tried was simply decoding with readInt() from the DataInput. So I adapted For/PFOR&lt;br/&gt;
to just take DataInput and work on it directly, instead of reading into a byte[], wrapping it with a ByteBuffer,&lt;br/&gt;
and working on an IntBuffer view.&lt;/p&gt;

&lt;p&gt;But when I did this, i found that MMap was slow for readInt(), etc. So we implement these primitives&lt;br/&gt;
with ByteBuffer.readInt(). This isn&apos;t very important since lucene doesn&apos;t much use these, and mostly theoretical &lt;br/&gt;
but I still think things like readInt(), readShort(), readLong() should be fast... for example just earlier today &lt;br/&gt;
someone posted an alternative PFOR implementation on &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1410&quot; title=&quot;PFOR implementation&quot;&gt;&lt;del&gt;LUCENE-1410&lt;/del&gt;&lt;/a&gt; that uses DataInput.readInt().&lt;/p&gt;

&lt;p&gt;MMapIndexInput readInt() improvements &lt;span class=&quot;error&quot;&gt;&amp;#91;bulkpostings, FrameOfRefDataInput codec&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Query&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Pct diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanFirst(unit, 5)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.99&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;-1.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.32&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.33&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;0.1%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.51&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.56&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;2.1%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.98&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.19&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;3.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.88&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;3.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanNear(&lt;span class=&quot;error&quot;&gt;&amp;#91;unit, state&amp;#93;&lt;/span&gt;, 10, true)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.81&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.96&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;5.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.04&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.59&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;6.8%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+unit +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.97&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.12&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;10.5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;26.67&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;29.80&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;11.7%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&quot;unit state&quot;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5.59&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.27&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;12.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;uni*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.10&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17.51&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;15.9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;33.20&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;38.72&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;16.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+nebraska +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;59.17&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;71.45&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;20.8%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;un*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;35.98&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;47.14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;31.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;u*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9.48&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.46&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;31.4%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Here&apos;s the same benchmark of DataInput.readInt() but with the MultiMMapIndexInput&lt;/p&gt;

&lt;p&gt;MultiMMapIndexInput readInt() improvements &lt;span class=&quot;error&quot;&gt;&amp;#91;bulkpostings, FrameOfRefDataInput codec&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Query&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Pct diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.43&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.54&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;4.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.78&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.39&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;5.7%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.81&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.21&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;5.8%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.62&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.05&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;6.5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanNear(&lt;span class=&quot;error&quot;&gt;&amp;#91;unit, state&amp;#93;&lt;/span&gt;, 10, true)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.77&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.96&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;6.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7.85&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8.53&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;8.7%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanFirst(unit, 5)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.50&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.71&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;11.5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+unit +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.26&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.94&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;16.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&quot;unit state&quot;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5.39&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.31&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;17.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;31.95&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;39.17&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;22.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;24.39&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;31.02&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;27.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+nebraska +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;54.68&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;71.98&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;31.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;u*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9.53&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.62&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;32.5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;uni*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;13.72&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;18.23&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;32.9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;un*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;35.87&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;48.19&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;34.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Just to be sure, I ran this last one on sparc64 (bigendian) also.&lt;/p&gt;

&lt;p&gt;MultiMMapIndexInput readInt() improvements &lt;span class=&quot;error&quot;&gt;&amp;#91;bulkpostings, FrameOfRefDataInput codec&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Query&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Pct diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.23&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.26&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;1.5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~2.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.37&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.47&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;1.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;united~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.33&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11.59&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;2.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit~1.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9.68&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.05&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;3.7%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanNear(&lt;span class=&quot;error&quot;&gt;&amp;#91;unit, state&amp;#93;&lt;/span&gt;, 10, true)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.60&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17.54&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;12.5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;127.14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;144.08&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;13.3%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;unit state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;44.93&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;51.30&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;14.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;spanFirst(unit, 5)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;58.42&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;68.37&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;17.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;uni*&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;56.66&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;67.53&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;19.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+nebraska +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;215.62&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;262.99&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;22.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;+unit +state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;63.18&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;77.86&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;23.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&quot;unit state&quot;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32.24&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;40.05&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;24.2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;u*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;29.13&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;36.69&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;26.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;state&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;145.99&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;188.33&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;29.0%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;un*d&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;65.27&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;87.20&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;33.6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;I think some of these benchmarks also show that MultiMMapIndexInput might now be&lt;br/&gt;
essentially just as fast as MMapIndexInput... but lets not go there yet and keep them separate for now.&lt;/p&gt;</comment>
                    <comment id="12972398" author="simonw" created="Fri, 17 Dec 2010 08:58:59 +0000"  >&lt;p&gt;Awesome results robert!! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12972413" author="thetaphi" created="Fri, 17 Dec 2010 09:38:20 +0000"  >&lt;p&gt;Awesome, Ro bert is changing to the MMap Performance Policeman!&lt;/p&gt;

&lt;p&gt;I like the idea to simply delegate the methods and catch exception to fallback to manual read with boundary transition! I just wanted to be sure that the position pointer in the buffer does not partly go forward when you read request fails at a buffer boundary, but that seems to be the case.&lt;/p&gt;</comment>
                    <comment id="12972416" author="thetaphi" created="Fri, 17 Dec 2010 09:41:43 +0000"  >&lt;p&gt;&lt;del&gt;One thing to add: When using readFloat &amp;amp; co, we should make sure that we set the endianness explicitely in the ctor. I just want to explicitely make sure that the endianness is correct and document it that it is big endian for Lucene.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;We don&apos;t need that: &quot;The initial order of a byte buffer is always BIG_ENDIAN.&quot;&lt;/p&gt;</comment>
                    <comment id="12972418" author="rcmuir" created="Fri, 17 Dec 2010 09:47:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;I just wanted to be sure that the position pointer in the buffer does not partly go forward when you read request fails at a buffer boundary, but that seems to be the case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, this is guaranteed in the APIs, and also tested well by TestMultiMMap, which uses random chunk sizes between 20 and 100 (including odd numbers etc)&lt;br/&gt;
Though we should enhance this test, i think it just retrieves documents at the moment... probably better if it did some searches too.&lt;/p&gt;</comment>
                    <comment id="12972420" author="mikemccand" created="Fri, 17 Dec 2010 09:48:36 +0000"  >&lt;p&gt;Good grief!  What amazing gains, especially w/ PFor codec which of course makes super heavy use of .readInt().  Awesome Robert!&lt;/p&gt;

&lt;p&gt;This will mean w/ the cutover to FORPFOR codec for 4.0, MMapDir will likely have a huge edge over NIOFSDir?&lt;/p&gt;</comment>
                    <comment id="12972422" author="rcmuir" created="Fri, 17 Dec 2010 09:53:41 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Good grief! What amazing gains, especially w/ PFor codec which of course makes super heavy use of .readInt(). Awesome Robert!&lt;br/&gt;
This will mean w/ the cutover to FORPFOR codec for 4.0, MMapDir will likely have a huge edge over NIOFSDir?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This isn&apos;t really a &apos;gain&apos; for the bulkpostings branch?&lt;br/&gt;
This is just making DataInput.readInt() faster.&lt;br/&gt;
Currently the bulkpostings branch uses readByte(byte[]), then wraps into a ByteBuffer and processes an IntBuffer view of that.&lt;br/&gt;
I switched to just using readInt() from DataInputDirectly &lt;span class=&quot;error&quot;&gt;&amp;#91;FrameOfRefDataInput&amp;#93;&lt;/span&gt; and found it to be much slower than this IntBuffer method.&lt;/p&gt;

&lt;p&gt;this whole benchmark is just benching DataInput.readInt()...&lt;/p&gt;

&lt;p&gt;So, we shouldn&apos;t change anything in bulkpostings, this isn&apos;t faster than the intbuffer method in my tests, at best its equivalent... but we should fix this slowdown in our APIs.&lt;/p&gt;</comment>
                    <comment id="12972880" author="rcmuir" created="Sun, 19 Dec 2010 00:34:47 +0000"  >&lt;p&gt;committed revision 1050737. I&apos;ll wait a bit for branch_3x.&lt;/p&gt;</comment>
                    <comment id="12975114" author="rcmuir" created="Sun, 26 Dec 2010 15:04:01 +0000"  >&lt;p&gt;Committed revision 1052892 to branch_3x.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12466451" name="LUCENE-2816.patch" size="4201" author="rcmuir" created="Fri, 17 Dec 2010 08:36:19 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 17 Dec 2010 08:58:59 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11043</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24876</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>