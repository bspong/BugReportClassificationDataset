<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:30:08 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1919/LUCENE-1919.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1919] Analysis back compat break</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1919</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Old and new style token streams don&apos;t mix well.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12436011">LUCENE-1919</key>
            <summary>Analysis back compat break</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="yseeley@gmail.com">Yonik Seeley</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Sep 2009 01:01:04 +0100</created>
                <updated>Fri, 25 Sep 2009 17:23:39 +0100</updated>
                    <resolved>Fri, 18 Sep 2009 16:39:13 +0100</resolved>
                                            <fixVersion>2.9</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12756870" author="yseeley@gmail.com" created="Fri, 18 Sep 2009 01:03:12 +0100"  >&lt;p&gt;Background:&lt;br/&gt;
&lt;a href=&quot;http://search.lucidimagination.com/search/document/4b2b4210e2516769/analysis_back_compat_break&quot; class=&quot;external-link&quot;&gt;http://search.lucidimagination.com/search/document/4b2b4210e2516769/analysis_back_compat_break&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://search.lucidimagination.com/search/document/26c044ecbce3ed29&quot; class=&quot;external-link&quot;&gt;http://search.lucidimagination.com/search/document/26c044ecbce3ed29&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="12756883" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 01:27:47 +0100"  >&lt;p&gt;At the worst, we can just clone the delegate and not be reusable (the javadoc says you don&apos;t have to be reusable)&lt;/p&gt;

&lt;p&gt;Not ideal, but it will fix, and cease to be a (possible performance) problem in 3.0 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12756884" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 01:29:23 +0100"  >&lt;p&gt;Now give us some better options Uwe &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12756887" author="rcmuir" created="Fri, 18 Sep 2009 01:55:58 +0100"  >&lt;p&gt;alternative patch, should not change performance.&lt;/p&gt;</comment>
                    <comment id="12756897" author="rcmuir" created="Fri, 18 Sep 2009 02:32:33 +0100"  >&lt;p&gt;better patch with testcase for the issue.&lt;/p&gt;

&lt;p&gt;really, its just that in next() tokenwrapper must be cloned before calling incrementToken, instead of after.&lt;/p&gt;</comment>
                    <comment id="12756898" author="yseeley@gmail.com" created="Fri, 18 Sep 2009 02:36:34 +0100"  >&lt;p&gt;edit: collision w/ robert.&lt;br/&gt;
Still wonder if it&apos;s safe to get rid of that second clone()... the combinations are mind-bending.&lt;/p&gt;</comment>
                    <comment id="12756901" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 02:50:41 +0100"  >&lt;p&gt;Nice - thanks Robert!&lt;/p&gt;</comment>
                    <comment id="12756903" author="jasonrutherglen" created="Fri, 18 Sep 2009 02:54:16 +0100"  >&lt;p&gt;With &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-908&quot; title=&quot;Port of Nutch  CommonGrams filter to Solr&quot;&gt;&lt;del&gt;SOLR-908&lt;/del&gt;&lt;/a&gt; CommonGramsQueryFilter which uses the old API,&lt;br/&gt;
we&apos;ve been seeing since we upgraded to Solr 1.4/Lucene 2.9,&lt;br/&gt;
random negations to query clauses. It almost looks like there&apos;s&lt;br/&gt;
some sort of shared state or multithreading issue, however I&apos;ve&lt;br/&gt;
also thought somehow it&apos;s related to mixing the old and new&lt;br/&gt;
APIs. Unfortunately it&apos;s so inconsistent I don&apos;t have a test&lt;br/&gt;
case that reproduces it (happens in production only). &lt;/p&gt;

&lt;p&gt;Is there any sort of shared state in the analyzing, possibly&lt;br/&gt;
between instances that is fixed in this patch?&lt;/p&gt;</comment>
                    <comment id="12756909" author="rcmuir" created="Fri, 18 Sep 2009 03:17:14 +0100"  >&lt;blockquote&gt;
&lt;p&gt;edit: collision w/ robert.&lt;br/&gt;
Still wonder if it&apos;s safe to get rid of that second clone()... the combinations are mind-bending. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yonik, hmm i think the second clone() is a hint there remains another problem&lt;br/&gt;
if you look at my patch, it only fixes the case where you have a tokenstream supporting incrementToken(), and you use both next() and next(Token) apis.&lt;/p&gt;

&lt;p&gt;what if the tokenstream only supports next(reusableTS) ?&lt;br/&gt;
if you call next(token) then next(), i think in that case you will have the same problem.&lt;br/&gt;
this still won&apos;t introduce any extra cloning, just fix the logic so it doesnt overwrite the tokenWrapper, and returns a &quot;full private copy&quot; like the javadocs say.&lt;/p&gt;

&lt;p&gt; (i&apos;ll add another test and upload a new patch)&lt;/p&gt;</comment>
                    <comment id="12756920" author="rcmuir" created="Fri, 18 Sep 2009 03:55:27 +0100"  >&lt;blockquote&gt;&lt;p&gt;what if the tokenstream only supports next(reusableTS) ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ok i tested the 2nd scenario and it is ok.&lt;br/&gt;
if you want my additional tests, i can add them, but the existing patch is fine... i confused myself worrying about this 2nd case.&lt;br/&gt;
in this case when the consumer calls next(reusableTS), no delegate is involved since its overridden... duh &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                    <comment id="12756924" author="rcmuir" created="Fri, 18 Sep 2009 03:59:09 +0100"  >&lt;blockquote&gt;&lt;p&gt;Still wonder if it&apos;s safe to get rid of that second clone()... the combinations are mind-bending. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;its not safe to do this for the case of tokenstream that only supports next(reusableTS) but not incrementToken.&lt;br/&gt;
otherwise, next() does not return a full copy, but a reference to the delegate, which will be overwritten by future calls to next().&lt;br/&gt;
if you want to get rid of it, then you need to clone the delegate before deferring to next(Token).&lt;/p&gt;</comment>
                    <comment id="12756944" author="rcmuir" created="Fri, 18 Sep 2009 04:42:17 +0100"  >&lt;blockquote&gt;
&lt;p&gt;Is there any sort of shared state in the analyzing, possibly&lt;br/&gt;
between instances that is fixed in this patch?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes. if for instance you call foo = ts.next(reusableToken), then call bar = ts.next() &lt;br/&gt;
foo will be overwritten by bar in the second call.&lt;br/&gt;
this is because it is incorrectly &quot;reused&quot; in next()... see the testcase i attached for an example.&lt;/p&gt;</comment>
                    <comment id="12757007" author="thetaphi" created="Fri, 18 Sep 2009 07:50:10 +0100"  >&lt;p&gt;Good morning all together! What a nice day and then this problem &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Here is my solution for the problem: Michael and me never thought about mixing the old and very old API as consumer, which seems to be used. The problem is now, that the behaviour changed for calling next(). The original 2.4.1 code looks the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Token next() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
  &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Token reusableToken = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Token();
  Token nextToken = next(reusableToken);

  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (nextToken != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
    Payload p = nextToken.getPayload();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      nextToken.setPayload((Payload) p.clone());
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; nextToken;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The difference is, that a new token is created &lt;b&gt;before&lt;/b&gt; the call to the reusable next() methods (incrementToken() is somehow reuseable, too).&lt;/p&gt;

&lt;p&gt;The attached patch, restores exactly this functionality, but also for incrementToken(). It also removes an unneeded assignment to the delegate in the case of next(Token) delegating to next() (which is also a bug, because it makes the token no longer private for the caller - it can be overridden by a later call to incrementToken()) - sorry for that.&lt;/p&gt;

&lt;p&gt;Tokens generated by next() must be always private and not shared or reused as reusableToken for later next/incrementToken calls by the API. This is the problem of Robert&apos;s patch. The full private token (which was cloned before) is then also available as delegate for later calls to incrementToken() (for next(Token) the delegate is replaced, as Robert noticed, so no problem here).&lt;/p&gt;

&lt;p&gt;The wrapper around incrementToken() does the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;save the current delegate&lt;/li&gt;
	&lt;li&gt;replace delegate by a new Token (just like the old next() in 2.4.1)&lt;/li&gt;
	&lt;li&gt;call incrementToken and assign to nextToken variable&lt;/li&gt;
	&lt;li&gt;restore the reusable delegate&lt;/li&gt;
	&lt;li&gt;after that all goes like for next(Token)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Simply said: the next() wrapper is completely decoupled and always uses a completely private (new) Token instance.&lt;/p&gt;

&lt;p&gt;I am not sure, why this payload cloning code is in 2.4.1, but I moved it here, too. I think it is because of some old bug, where a payload was assigned in next(Token), that was also shared by the TokenStream itsself between more than one tokens. Using this code, the Token is for sure full private (and even not reused later as before).&lt;/p&gt;

&lt;p&gt;Using this patch, you should now even be able to mix all three APIs in one filter/consumer - but I still would&apos;nt do this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12757068" author="thetaphi" created="Fri, 18 Sep 2009 10:15:39 +0100"  >&lt;p&gt;This is just a patch that enhances/rectifies the BW testcase. It corrects the messages in assertTrue, because they should refelct that something is going wrong (just cosmetics). But it adds a test for correctness of other token&apos;s contents to these POSToken tests, not only if the one is a proper noun.&lt;/p&gt;

&lt;p&gt;It also mixes consuming the new API into Robert&apos;s test and the call to next(Token), to check if the full-private Token returned from next() is still valid.&lt;/p&gt;

&lt;p&gt;Nothing special, no other changes in core code.&lt;/p&gt;</comment>
                    <comment id="12757092" author="thetaphi" created="Fri, 18 Sep 2009 11:34:33 +0100"  >&lt;p&gt;I would suggest to create a new RC because of this issue. The TokenStream BW stuff is very tricky and is not limited to only one TokenStream. When fixing thigs here, you must always also look into issues that could arise by mixing old/new API. The current issue is a typical example for that. Your brain is always &quot;fuming&quot;, when you think about what happens if TF1 calls TF2 using old API, but TF2 is new API and calls TF3 using new API. TF3 itsself is again very old API without reuse and so on.&lt;/p&gt;

&lt;p&gt;But this one is new, a reusable TF is calling another TS mixing the APIs, but the changes also affect the other variants. So testing, testing, testing and take a cold shower when your brain starts getting hot &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I will commit the current patch later in the afternoon, when you are awake at the west coast.&lt;/p&gt;</comment>
                    <comment id="12757140" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 13:44:15 +0100"  >&lt;p&gt;Commit away as soon as you can Uwe - I pump out RC5 as soon as I can right after.&lt;/p&gt;</comment>
                    <comment id="12757143" author="thetaphi" created="Fri, 18 Sep 2009 13:53:17 +0100"  >&lt;p&gt;OK, will do. Do you know if Yonik also reviewed this patch, because he was the person who reported the bug. Maybe he tests with his failing TS. Also Jason could check out this patch with his problem (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-908&quot; title=&quot;Port of Nutch  CommonGrams filter to Solr&quot;&gt;&lt;del&gt;SOLR-908&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I will commit in 2 hours, is this early enough?&lt;/p&gt;</comment>
                    <comment id="12757149" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 14:04:44 +0100"  >&lt;p&gt;I tested the patch I did with the failing test, and it worked - so I&apos;m sure yours does too - I&apos;ll do a test with the latest patch right now though.&lt;/p&gt;

&lt;p&gt;The original report came from Gregg Donovanin Solr land.&lt;/p&gt;

&lt;p&gt;He made a nice little unit test that fails in Solr showing the problem (see the links Yonik posted).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1445&quot; class=&quot;external-link&quot;&gt;https://issues.apache.org/jira/browse/SOLR-1445&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2 hours is fine with me - I just would like to get the RC out today if possible. &lt;/p&gt;</comment>
                    <comment id="12757156" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 14:19:25 +0100"  >&lt;p&gt;I can confirm the latest patch fixes the Solr issue that prompted this.&lt;/p&gt;</comment>
                    <comment id="12757178" author="rcmuir" created="Fri, 18 Sep 2009 15:24:01 +0100"  >&lt;p&gt;Uwe, i tested your patch, this is good &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Just out of curiousity though, I am not sure i see the problem with next() then incrementToken() with my patch.&lt;br/&gt;
(Your patch is better imho, this is not the issue).&lt;/p&gt;

&lt;p&gt;I tried your modified test and it passes with my patch also, is there something I am missing?&lt;/p&gt;</comment>
                    <comment id="12757187" author="rcmuir" created="Fri, 18 Sep 2009 15:51:21 +0100"  >&lt;p&gt;nevermind: found it.&lt;/p&gt;

&lt;p&gt;Uwe&apos;s patch plus a testcase that passes with his fix, but fails with the old patch i supplied.&lt;/p&gt;

&lt;p&gt;what Uwe fixed was the case where TokenStream only supports next(Token), but you consume it foo = incrementToken(), followed by bar = next()&lt;br/&gt;
in this case bar should be fully private and not overwrite the contents of foo.&lt;/p&gt;</comment>
                    <comment id="12757201" author="thetaphi" created="Fri, 18 Sep 2009 16:21:18 +0100"  >&lt;p&gt;Thanks Robert, I added your test and did some more tests with the round robin stream. We can now be sure, that it is fully private, not even the attributes are touched &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; -&amp;gt; but I see no real sense in this requirement &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; People should never use old and the brand new API in one consumer. Mixing old and very-old is ok and was obviously used.&lt;/p&gt;

&lt;p&gt;I will commit shortly.&lt;/p&gt;

&lt;p&gt;Just one question: Does anybody know, why there is this extra payload cloning?&lt;/p&gt;</comment>
                    <comment id="12757205" author="thetaphi" created="Fri, 18 Sep 2009 16:32:55 +0100"  >&lt;blockquote&gt;&lt;p&gt;Just one question: Does anybody know, why there is this extra payload cloning?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This was introduced at the end of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1057&quot; title=&quot;indexing doesn&amp;#39;t reset token state&quot;&gt;&lt;del&gt;LUCENE-1057&lt;/del&gt;&lt;/a&gt; without patch in JIRA. So it must have something to do with this. Maybe Yonik can explain.&lt;/p&gt;</comment>
                    <comment id="12757207" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 16:34:02 +0100"  >&lt;p&gt;The copy of payload came in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1057&quot; title=&quot;indexing doesn&amp;#39;t reset token state&quot;&gt;&lt;del&gt;LUCENE-1057&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The clone came in &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1062&quot; title=&quot;Improved Payloads API&quot;&gt;&lt;del&gt;LUCENE-1062&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="12757210" author="thetaphi" created="Fri, 18 Sep 2009 16:39:13 +0100"  >&lt;p&gt;Committed revision: 816673&lt;/p&gt;

&lt;p&gt;I added no CHANGES entry as we are all committers and no external persons involved. This bug was not in any previous release.&lt;/p&gt;

&lt;p&gt;Thanks Robert for the great tests and all others for help resolving this bug. Mark, go on with the RC5! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12757215" author="yseeley@gmail.com" created="Fri, 18 Sep 2009 16:52:52 +0100"  >&lt;blockquote&gt;&lt;p&gt;This was introduced at the end of &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1057&quot; title=&quot;indexing doesn&amp;#39;t reset token state&quot;&gt;&lt;del&gt;LUCENE-1057&lt;/del&gt;&lt;/a&gt; without patch in JIRA. So it must have something to do with this. Maybe Yonik can explain.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Urg... 2 years ago.&lt;br/&gt;
I think it was because Token.clone() didn&apos;t clone the payload, so next() would do it to create a fully private copy.&lt;br/&gt;
Is it stil applicable?  So many changes, I don&apos;t know.&lt;/p&gt;</comment>
                    <comment id="12757224" author="thetaphi" created="Fri, 18 Sep 2009 17:03:50 +0100"  >&lt;p&gt;Token.clone() is not called by next() anymore (and even not in 2.4.1) - because of this we need the Payload cloning (Token.clone() would do it). The full private Token is done like this now (and this was the same in 1057): next(Token) is simply called with a new Token instance. The fix for this issue does it in the same way (like 2.4.1). The extension here is, that it now works exactly the same with incrementToken(). After calling next(Token) with the private token, the Payload is explicitely cloned.&lt;/p&gt;

&lt;p&gt;As I told some comments above, I think more the problem is the following: If a next(Token) or incrementToken() method sets a Payload, the payload data is not copied, its only a reference to the byte array. E.g. the next(Token) methods uses a pre-allocated array and sets this always as data (which is perfectly legal in the reuse case), only modifying the data contents. If you call next(Token) with a new allocated Token, this Token is private, but if next(Token) sets again the preallocated byte array, it is not private anymore (you will se the modifications in the previous token, too). You would have the same bug like now (even in 2.4.1). I think because of this the payload is cloned separately to be sure that it is private like the newly allocated Token.&lt;/p&gt;</comment>
                    <comment id="12757225" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 17:06:34 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think because of this the payload is cloned separately to be sure that it is private like the newly allocated Token.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats what it appears to be if you look at the tests added with the change -&lt;/p&gt;

&lt;p&gt;one of the tests is a next(Token) impl that just keeps setting the payload with the same payload instance that it has as a field.&lt;/p&gt;</comment>
                    <comment id="12757232" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 17:13:18 +0100"  >&lt;blockquote&gt;&lt;p&gt;Thanks Robert for the great tests and all others for help resolving this bug. Mark, go on with the RC5! &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks a lot Uwe! I really appreciate the speed with which you have been addressing these RC issues!&lt;/p&gt;

&lt;p&gt;Its taken a while to get this release out, but we have barley wasted a moment in cranking along.&lt;/p&gt;</comment>
                    <comment id="12757263" author="jasonrutherglen" created="Fri, 18 Sep 2009 17:57:20 +0100"  >&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-908&quot; title=&quot;Port of Nutch  CommonGrams filter to Solr&quot;&gt;&lt;del&gt;SOLR-908&lt;/del&gt;&lt;/a&gt;, I can try out the patch, though we&apos;ve reverted&lt;br/&gt;
back to Solr trunk from 8/31, unfortunately, I can&apos;t reproduce&lt;br/&gt;
the bug using a multithreaded query parsing unit test.&lt;/p&gt;

&lt;p&gt;I decided the best avenue, given it must be thread related to&lt;br/&gt;
behave so randomly, is to alter QueryParser.getFieldQuery to not&lt;br/&gt;
call analyzer.reusableTokenStream and only use&lt;br/&gt;
analyzer.tokenStream. &lt;/p&gt;

&lt;p&gt;This effectively avoids the use of threadlocal reusable&lt;br/&gt;
tokenstreams for query parsing. I am left wondering about the&lt;br/&gt;
state of our index using reusable tokenstreams but luckily we&lt;br/&gt;
have so many documents, that this is less of a concern. &lt;/p&gt;

&lt;p&gt;The queries being truncated is of course very serious as users&lt;br/&gt;
see irrelevant results and assume that Lucene/Solr 2.9/1.4 is no&lt;br/&gt;
good.&lt;/p&gt;</comment>
                    <comment id="12757402" author="yseeley@gmail.com" created="Fri, 18 Sep 2009 21:38:28 +0100"  >&lt;p&gt;I&apos;ve been doing some more testing... everything looks good.&lt;br/&gt;
I did some random testing too, just to see if there are any combination corner cases we forgot about... it tries random combination of filters that support and used the different old/new stile APIs.  It was inline with other Solr tests, so I just cut-n-pasted it to this file for posterity.&lt;/p&gt;</comment>
                    <comment id="12757444" author="thetaphi" created="Fri, 18 Sep 2009 22:19:10 +0100"  >&lt;p&gt;A really funny test fragment. Fascinating &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Good to hear that the API even passes this test! Thanks for testing!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10001">
                <name>dependent</name>
                                                <inwardlinks description="is depended upon by">
                            <issuelink>
            <issuekey id="12436018">SOLR-1445</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12420027" name="LUCENE-1919.patch" size="12275" author="rcmuir" created="Fri, 18 Sep 2009 15:51:21 +0100" />
                    <attachment id="12419995" name="LUCENE-1919.patch" size="11520" author="thetaphi" created="Fri, 18 Sep 2009 10:15:39 +0100" />
                    <attachment id="12419978" name="LUCENE-1919.patch" size="2562" author="thetaphi" created="Fri, 18 Sep 2009 07:50:10 +0100" />
                    <attachment id="12419957" name="LUCENE-1919.patch" size="1402" author="rcmuir" created="Fri, 18 Sep 2009 02:32:33 +0100" />
                    <attachment id="12419953" name="LUCENE-1919.patch" size="722" author="rcmuir" created="Fri, 18 Sep 2009 01:55:58 +0100" />
                    <attachment id="12419951" name="LUCENE-1919.patch" size="628" author="markrmiller@gmail.com" created="Fri, 18 Sep 2009 01:29:23 +0100" />
                    <attachment id="12420071" name="random_tests_fragment.txt" size="4063" author="yseeley@gmail.com" created="Fri, 18 Sep 2009 21:38:28 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>7.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 18 Sep 2009 00:27:47 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11849</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25806</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>