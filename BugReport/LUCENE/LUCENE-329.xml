<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:05:50 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-329/LUCENE-329.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-329] Fuzzy query scoring issues</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-329</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Queries which automatically produce multiple terms (wildcard, range, prefix, &lt;br/&gt;
fuzzy etc)currently suffer from two problems:&lt;/p&gt;

&lt;p&gt;1) Scores for matching documents are significantly smaller than term queries &lt;br/&gt;
because of the volume of terms introduced (A match on query Foo~ is 0.1 &lt;br/&gt;
whereas a match on query Foo is 1).&lt;br/&gt;
2) The rarer forms of expanded terms are favoured over those of more common &lt;br/&gt;
forms because of the IDF. When using Fuzzy queries for example, rare mis-&lt;br/&gt;
spellings typically appear in results before the more common correct spellings.&lt;/p&gt;


&lt;p&gt;I will attach a patch that corrects the issues identified above by &lt;br/&gt;
1) Overriding Similarity.coord to counteract the downplaying of scores &lt;br/&gt;
introduced by expanding terms.&lt;br/&gt;
2) Taking the IDF factor of the most common form of expanded terms as the &lt;br/&gt;
basis of scoring all other expanded terms.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Operating System: All&lt;br/&gt;
Platform: All&lt;/p&gt;</environment>
            <key id="12314479">LUCENE-329</key>
            <summary>Fuzzy query scoring issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="markharw00d@yahoo.co.uk">Mark Harwood</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 Jan 2005 06:34:19 +0000</created>
                <updated>Fri, 9 Mar 2012 13:35:10 +0000</updated>
                    <resolved>Thu, 27 Jan 2011 10:30:18 +0000</resolved>
                            <version>1.2</version>
                                <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>2</votes>
                        <watches>3</watches>
                                                    <comments>
                    <comment id="12322124" author="markharw00d@yahoo.co.uk" created="Wed, 5 Jan 2005 06:39:35 +0000"  >&lt;p&gt;Created an attachment (id=13887)&lt;br/&gt;
Fix for issues identified in this bug&lt;/p&gt;

&lt;p&gt;Fix for the fuzzy scoring issues. Introduced new subclasses for BooleanQuery&lt;br/&gt;
and TermQuery - ExpandedTermsQuery and ExpandedTermQuery respectively.&lt;br/&gt;
&quot;Fuzzy&quot; queries (range, multiterm and fuzzy) now use these subclasses to make&lt;br/&gt;
use of their new Similarity implementations.&lt;/p&gt;</comment>
                    <comment id="12330222" author="markh" created="Fri, 23 Sep 2005 05:45:14 +0100"  >&lt;p&gt;This has been partially addressed. &lt;/p&gt;

&lt;p&gt;Issue 1, the coord factor has been rectified with the introduction of new constructor BooleanQuery(boolean disableCoord).&lt;/p&gt;

&lt;p&gt;Issue 2 (idf ranking) has not been addressed. &lt;/p&gt;</comment>
                    <comment id="12440168" author="mdissel" created="Thu, 5 Oct 2006 16:41:49 +0100"  >&lt;p&gt;Why isn&apos;t the patch implemented? My users are finding the current result of fuzzy searched not correct (as stated in the sample provided by Mark)&lt;/p&gt;
</comment>
                    <comment id="12440213" author="hossman" created="Thu, 5 Oct 2006 19:50:30 +0100"  >&lt;p&gt;I&apos;m not very familiar with this issue, but a quick review of the patch and the existing comments lead me to believe that commiting it as is wouldn&apos;t be the cleanest way to deal with this problem:&lt;/p&gt;

&lt;p&gt;1) As Mark mentioned, a &quot;disableCoord&quot; option has been added to BooleanQuery which makes the ExpandedTermsQuery class in this patch unneccessary.  furthermore, the ExpandedTermsQuery class is (in my opinion) broken because it ignores any user specific Similarity completely (instead of just ignoring the coord factor)&lt;/p&gt;

&lt;p&gt;2) This patch does not include any test cases.&lt;/p&gt;


&lt;p&gt;Furthermore, this patch (assuming it does what it says it does) would fundementally alter the scoring of a FuzzyQuery &amp;#8211; the new scoring may seem like the right thing to do for you and for Mark, but without a larger concensus I&apos;m a little worried that perhaps there are just as many FuzzyQuery users out there who are happy with the current behavior and would consider this change a bug.  So any &quot;fix&quot; for this should either be configurable, or have an overwelming amount of support that the change is the &quot;right&quot; thing to do.&lt;/p&gt;

&lt;p&gt;(The main issue seems to be that terms with low idf have a larger impact, and that results in rare mis-spellings getting higher scores &amp;#8211; but assuming &quot;clean data&quot; with no mis-spellings, scoring &quot;rare&quot; terms higher seems like the ideal behavior, correct?)&lt;/p&gt;
</comment>
                    <comment id="12440219" author="mdissel" created="Thu, 5 Oct 2006 20:10:12 +0100"  >&lt;p&gt;&amp;gt;&amp;gt; but assuming &quot;clean data&quot; with no mis-spellings, scoring &quot;rare&quot; terms higher seems like the ideal behavior&lt;/p&gt;

&lt;p&gt;Exact matched of a term should have a higher ranking then fuzzy matched terms.. at least that&apos;s the expected behaviour in my situation although i think it seems the most common behaviour.. We could also make this optionally, so that we don&apos;t affect the current scoring algorithm..&lt;/p&gt;

&lt;p&gt;ps. i&apos;m using the Lucene.NET port, so by changing/extending this behaviour in Java we (or George) can implement this at the .NET version as well.&lt;/p&gt;</comment>
                    <comment id="12647168" author="markrmiller@gmail.com" created="Thu, 13 Nov 2008 02:37:50 +0000"  >&lt;p&gt;Any consensus on this? We have the disableCoord and now the option to use a constant score mode for all the mult-term queries. Is that enough? What do you think Mark H? Does this patch still make sense?&lt;/p&gt;</comment>
                    <comment id="12647175" author="alexeylef" created="Thu, 13 Nov 2008 03:51:56 +0000"  >&lt;p&gt;I&apos;ve been using DisjunctionMaxQuery for term expansion. It seems to be a much more natural fit for this kind of problem. BooleanQuery never worked for me even with disableCoord.&lt;/p&gt;</comment>
                    <comment id="12647243" author="markh" created="Thu, 13 Nov 2008 09:54:36 +0000"  >&lt;p&gt;This patch goes back a while.&lt;br/&gt;
Contrib&apos;s FuzzyLikeThisQuery contains my current &quot;best practice&quot; for fuzzy matching but the logic is mixed in with code that also does &quot;LikeThis&quot; optimisations ie working out which input terms are the best to search on rather than using all input terms. This could usefully be lifted out and used elsewhere.&lt;/p&gt;

&lt;p&gt;The fuzzy scoring logic takes the IDF of the input term and uses that as the IDF for scoring all expanded variants. If the input term does not exist then all variants are rewarded with their averaged IDF. Coord is disabled.&lt;/p&gt;

&lt;p&gt;Using some form of IDF is typically desirable to balance a fuzzy query with other (potentially non fuzzy) clauses in the overall user query. Within a fuzzy query (or wildcard or other auto-expanding queries) however I see no reason to differentiate between the auto-expanded terms with different IDF values. In my view these auto-expand queries should generally use the same IDF for all variants and only reward them differently based on edit distance or what other distance metric is meaningful to that form of expansion (e.g. age range query on age 40 +/- 10 years could reward based on closeness to input term 40).&lt;/p&gt;

&lt;p&gt;Cheers&lt;br/&gt;
Mark&lt;/p&gt;</comment>
                    <comment id="12833812" author="rcmuir" created="Mon, 15 Feb 2010 14:42:02 +0000"  >&lt;p&gt;in my opinion this is now fixable in a very nice way.&lt;/p&gt;

&lt;p&gt;we can make an alternative rewrite method for fuzzy that does just like TopTermsRewrite, except it creates a BooleanQuery of ConstantScore queries instead. this way the score will be equal to the boost.&lt;/p&gt;

&lt;p&gt;then users could choose which one they want to use.&lt;/p&gt;</comment>
                    <comment id="12833822" author="markh" created="Mon, 15 Feb 2010 14:54:37 +0000"  >&lt;p&gt;The problem with ignoring IDF completely is that it doesn&apos;t help balance partial matches where there is &amp;gt;1 fuzzy element in the query e.g.in a query  for John~ Patitucci~ I&apos;m probably more interested in a partial match on the rarer surname than a partial match on the common forename. Obliterating IDF completely as a factor would lose this feature (available in FuzzyLikeThisQuery)&lt;/p&gt;</comment>
                    <comment id="12833828" author="rcmuir" created="Mon, 15 Feb 2010 15:00:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem with ignoring IDF completely is that it doesn&apos;t help balance partial matches where there is &amp;gt;1 fuzzy element in the query e.g.in a query for John~ Patitucci~ I&apos;m probably more interested in a partial match on the rarer surname than a partial match on the common forename. Obliterating IDF completely as a factor would lose this feature (available in FuzzyLikeThisQuery)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Mark, it wouldn&apos;t lose any features. we simply provide another option, just like we do for other MultiTermQuery rewrites for other queries, so users can choose what they want to use. its just an additional choice.&lt;/p&gt;</comment>
                    <comment id="12833829" author="rcmuir" created="Mon, 15 Feb 2010 15:01:37 +0000"  >&lt;p&gt;here is a rough patch&lt;/p&gt;</comment>
                    <comment id="12833835" author="rcmuir" created="Mon, 15 Feb 2010 15:19:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m probably more interested in a partial match on the rarer surname than a partial match on the common forename. Obliterating IDF completely as a factor would lose this feature (available in FuzzyLikeThisQuery)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;oh I see, this issue is really different from &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-124&quot; title=&quot;Fuzzy Searches do not get a boost of 0.2 as stated in &amp;quot;Query Syntax&amp;quot; doc&quot;&gt;&lt;del&gt;LUCENE-124&lt;/del&gt;&lt;/a&gt; (they arent technically duplicates). I can move my patch there. You can still create a &apos;smarter&apos; method here, it won&apos;t get in the way as now FuzzyQuery does not have a hardcoded rewrite method.&lt;/p&gt;</comment>
                    <comment id="12833840" author="markh" created="Mon, 15 Feb 2010 15:24:23 +0000"  >&lt;p&gt;My &quot;best-practice&quot; suggestion isn&apos;t as simple as offering a choice between preserving IDF for all terms or not.&lt;/p&gt;

&lt;p&gt;Instead, it is a proposal that we should use the &lt;b&gt;input&lt;/b&gt; term&apos;s IDF for scoring all variants of the same root term (or taking an average of variants where the root term does not exist).&lt;/p&gt;

&lt;p&gt;This I feel preserves the benefits of keeping IDF as a factor (as in my John~ Patitucci~ balancing example) but also eliminating the side effects we see where a rare mis-spelling beats exact matches.&lt;/p&gt;</comment>
                    <comment id="12833841" author="rcmuir" created="Mon, 15 Feb 2010 15:27:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;My &quot;best-practice&quot; suggestion isn&apos;t as simple as offering a choice between preserving IDF for all terms or not. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Mark, right, my mistake. I will move this patch to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-124&quot; title=&quot;Fuzzy Searches do not get a boost of 0.2 as stated in &amp;quot;Query Syntax&amp;quot; doc&quot;&gt;&lt;del&gt;LUCENE-124&lt;/del&gt;&lt;/a&gt; so there is a simple alternative, you can proceed here with a smarter method... sorry i got confused amongst the different issues &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12833860" author="eksdev" created="Mon, 15 Feb 2010 15:54:39 +0000"  >&lt;blockquote&gt;
&lt;p&gt;query for John~ Patitucci~ I&apos;m probably more interested in a partial match on the rarer surname than a partial match on the common forename. &lt;/p&gt;&lt;/blockquote&gt;


&lt;p&gt;as a matter of fact, we have not only one frequency  to consider, rather two Term frequencies!&lt;/p&gt;

&lt;p&gt;consider simpler case&lt;br/&gt;
Query term: &quot;Johan&quot; //would be High frequency term&lt;br/&gt;
gives:&lt;br/&gt;
Fuzzy Expanded term1 &quot;Johana&quot; // High frequency&lt;br/&gt;
Fuzzy Expanded term2 &quot;Joahn&quot; // Low Freq&lt;/p&gt;

&lt;p&gt;I guess you would like to score the second term higher, meaning Lower frequency (higher IDF)... So far so good. &lt;/p&gt;

&lt;p&gt;Now turn it upside down and search for LF typo &quot;Joahn&quot;... in that case you would preffer HF Term &quot;Johan&quot; from expanded list to score higher...&lt;/p&gt;

&lt;p&gt;Point being, this situation here is just not &quot;complete&quot; without taking both frequencies into consideration (Query Term and Expanded term). In my experience, some simple nonlinear hints based on these two freqs bring some easy precision points (HF-LF Pairs are much more likely to be typos that two HF-HF...  ). &lt;/p&gt;</comment>
                    <comment id="12833876" author="markh" created="Mon, 15 Feb 2010 16:27:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;consider simpler case&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK - but we need to remember that it is important to achieve balance &lt;em&gt;across&lt;/em&gt; different fuzzy queries as well as terms &lt;em&gt;within&lt;/em&gt; the same fuzzy query.&lt;br/&gt;
Let&apos;s stick to the terms within a single fuzzy query for now:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I guess you would like to score the second term higher, meaning Lower frequency&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, variant&apos;s frequency is not a deciding factor - only edit distance. &quot;Johana&quot; is similarity 0.6 while &quot;Joahn&quot; is 0.2 so I would favour result one  (although the this difference seems a little off in this case)&lt;br/&gt;
The basic assumption is that user&apos;s input is valid and not a typo (deriving spelling suggestions etc are a different topic and one we shouldnt try cover here). &lt;br/&gt;
Fuzzy matching can drag in all sorts of unqualified variants with massively different frequencies. Because we cannot control these discrepancies we should reward all these alternatives using the known factors we have to hand - the IDF of the user&apos;s supposedly valid input and the similarity measure of each variant compared to the input.&lt;br/&gt;
We could get fancy about probability of variants given the other input terms in the query but that feels like its straying into spell checker territory and ngrams etc.&lt;/p&gt;</comment>
                    <comment id="12987483" author="thetaphi" created="Thu, 27 Jan 2011 10:30:18 +0000"  >&lt;p&gt;Recent 3.x versions contain a new FuzzyQuery rewrite method (MultiTermQuery.TopTermsBoostOnlyBooleanQueryRewrite)  that uses a BooleanQuery with clauses of ConstantScoreQuery(TermQuery) usig the fuzzy boost. So term&apos;s idf is not used at all.&lt;/p&gt;

&lt;p&gt;This should solve this problem.&lt;/p&gt;</comment>
                    <comment id="12987585" author="markh" created="Thu, 27 Jan 2011 14:38:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;So term&apos;s idf is not used at all. This should solve this problem&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A sub-optimal  for the reasons I outlined earlier:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The problem with ignoring IDF completely is that it doesn&apos;t help balance partial matches where there is &amp;gt;1 fuzzy element in the query e.g.in a query for John~ Patitucci~ I&apos;m probably more interested in a partial match on the rarer surname than a partial match on the common forename. Obliterating IDF completely as a factor would lose this feature (available in FuzzyLikeThisQuery)&lt;/p&gt;&lt;/blockquote&gt;</comment>
                    <comment id="12987598" author="thetaphi" created="Thu, 27 Jan 2011 15:21:48 +0000"  >&lt;p&gt;I agree with your complaints, but this issue was more about MTQ queries at all and strange scoring. So FuzzyQuery behaves now more as one would expect. We already have different variants of this query like FuzzyLikeThis that also solve this issue.&lt;/p&gt;

&lt;p&gt;This is why I closed the issue.&lt;/p&gt;</comment>
                    <comment id="12987600" author="rcmuir" created="Thu, 27 Jan 2011 15:22:20 +0000"  >&lt;p&gt;Mark, I tend to agree, but at the same time I think you can safely implement&lt;br/&gt;
a RewriteMethod to do whatever you want? (e.g. apply the logic of FuzzyLikeThis)&lt;/p&gt;

&lt;p&gt;Doing something special with IDF is really specific to certain Similarities, for example&lt;br/&gt;
your Similarity might not use the traditional IDF at all, but something involving&lt;br/&gt;
totalTermFreq and sumOfTotalTermFreq (like language modelling).&lt;/p&gt;

&lt;p&gt;So I am concerned about doing tricky things with the scoring system by default &lt;br/&gt;
for this query... we provide the simple options in core (Scoring, BoostOnly, etc) though.&lt;/p&gt;

&lt;p&gt;An idea would be to factor the logic out of FuzzyLikeThisQuery into a FuzzyLikeThisRewriteMethod,&lt;br/&gt;
so you could just call .setRewriteMethod on your fuzzy query and use it.&lt;/p&gt;</comment>
                    <comment id="12987650" author="markh" created="Thu, 27 Jan 2011 17:02:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think you can safely implement a RewriteMethod to do whatever you want?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep, I&apos;ve got workarounds using FuzzyLikeThis that work for me but have long had a general unease about the &quot;out of the box&quot; experience for others.&lt;/p&gt;

&lt;p&gt;However things are certainly better than they were when this issue was first raised and the main concerns have been addressed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So FuzzyQuery behaves now more as one would expect&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is it worth explicitly stating those expectations? Mine would be based on these principles:&lt;br/&gt;
1) IDF is commonly accepted as useful when ranking partial matches of queries with multiple optional clauses&lt;br/&gt;
2) IDF doesn&apos;t stop being useful if one of those clauses just  happens to be a term flagged as &quot;fuzzy&quot;.&lt;/p&gt;

&lt;p&gt;So given a query:    rareWord~ OR commonWord~ &lt;br/&gt;
I would expect an exact match on &quot;rareWord&quot; to rank higher than an exact match on &quot;commonWord&quot;.&lt;br/&gt;
I don&apos;t think the current implementation respects this.&lt;/p&gt;





</comment>
                    <comment id="13013497" author="gsingers" created="Wed, 30 Mar 2011 16:50:29 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                    <comment id="13226066" author="ijabz" created="Fri, 9 Mar 2012 13:35:10 +0000"  >&lt;p&gt;Why has this been closed ?&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310000">
                <name>Duplicate</name>
                                                <inwardlinks description="is duplicated by">
                            <issuelink>
            <issuekey id="12314274">LUCENE-124</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12406757">LUCENE-1424</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12312489" name="ASF.LICENSE.NOT.GRANTED--patch.txt" size="11164" author="markharw00d@yahoo.co.uk" created="Wed, 5 Jan 2005 06:39:35 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_10010" key="com.atlassian.jira.plugin.system.customfieldtypes:importid">
                <customfieldname>Bugzilla Id</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>32942</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 23 Sep 2005 04:45:14 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>13420</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>27402</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>