<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:01:08 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1312/LUCENE-1312.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1312] InstantiatedIndexReader does not implement getFieldNames properly</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1312</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Causes error in org.apache.lucene.index.SegmentMerger.mergeFields&lt;/p&gt;</description>
                <environment></environment>
            <key id="12398763">LUCENE-1312</key>
            <summary>InstantiatedIndexReader does not implement getFieldNames properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="karl.wettin">Karl Wettin</assignee>
                                <reporter username="jasonrutherglen">Jason Rutherglen</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Jun 2008 01:26:35 +0100</created>
                <updated>Sat, 28 Jun 2008 18:26:53 +0100</updated>
                    <resolved>Sat, 28 Jun 2008 18:26:53 +0100</resolved>
                                            <fixVersion>2.4</fixVersion>
                                <component>modules/other</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12607056" author="jasonrutherglen" created="Sun, 22 Jun 2008 02:16:14 +0100"  >&lt;p&gt;lucene-1312.patch&lt;/p&gt;

&lt;p&gt;Fixed this bug and one related to termenum with no term.  These made SegmentMerger fail.  &lt;/p&gt;</comment>
                    <comment id="12607064" author="jasonrutherglen" created="Sun, 22 Jun 2008 07:18:49 +0100"  >&lt;p&gt;lucene-1312.patch&lt;/p&gt;

&lt;p&gt;A few additional updates related to deleted docs in InstantiatedIndexReader&lt;/p&gt;</comment>
                    <comment id="12607117" author="karl.wettin" created="Sun, 22 Jun 2008 21:44:58 +0100"  >&lt;p&gt;Hi Jason!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Fixed this bug and one related to termenum with no term. These made SegmentMerger fail.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you please supply a test case that demonstrate SegmentMerger failing? Your next() in InstantiatedTermEnum() changes the behaviour InstantiatedIndexReader#terms() compared to IndexReader#terms() and makes the index comparation test to to fail:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;junit.framework.AssertionFailedError: expected:&amp;lt;a:0&amp;gt; but was:&amp;lt;a:1&amp;gt;
	at org.apache.lucene.store.instantiated.TestIndicesEquals.testEquals(TestIndicesEquals.java:244)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;InstantiatedIndex#fieldSettingsByFieldName that getFieldNames(FieldOption) seem to only be updated by InstantiatedIndexWriter and not when populated by InstantiatedIndex(IndexReader).&lt;/p&gt;

&lt;p&gt;Can you please supply test cases that demonstrate getFieldNames(FieldOption) works with both index population strategies? &lt;/p&gt;

&lt;p&gt;I think you can factor out the FieldSetting class from InstantiatedIndexWriter as it now is used by InstantiatedIndex and InstantiatedIndexReader too.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A few additional updates related to deleted docs in InstantiatedIndexReader&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This looks good. I noticed that TestIndicesEquals does not actually delete any documents and make sure the indices still equals. I can fix that.&lt;/p&gt;


&lt;p&gt;Also, please try not to reformat the code, it makes it harder to see the important changes. &lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                    <comment id="12607263" author="jasonrutherglen" created="Mon, 23 Jun 2008 16:37:11 +0100"  >&lt;p&gt;lucene-1312.patch&lt;/p&gt;

&lt;p&gt;The problem with TermEnum is term() needed: &lt;/p&gt;

&lt;p&gt;if (term == null) return null;&lt;/p&gt;

&lt;p&gt;That fixed the issue and next has been removed from InstantiatedTermEnum(InstantiatedIndexReader reader).&lt;/p&gt;

&lt;p&gt;Will work on the rest when I have time.&lt;/p&gt;</comment>
                    <comment id="12607272" author="jasonrutherglen" created="Mon, 23 Jun 2008 16:54:34 +0100"  >&lt;p&gt;lucene-1312.patch&lt;/p&gt;

&lt;p&gt;Added the code to InstantiatedIndex(IndexReader sourceIndexReader, Set&amp;lt;String&amp;gt; fields) to create the fieldsetting map.  Separated FieldSetting into it&apos;s own class.  TestIndicesEquals worked.&lt;/p&gt;</comment>
                    <comment id="12607441" author="karl.wettin" created="Tue, 24 Jun 2008 02:49:38 +0100"  >&lt;p&gt;Thanks for the updated patch Jason!&lt;/p&gt;

&lt;p&gt;I worked a bit on it:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Factored out the writer specific field settings (omitnorms, binary, etc)  and introduced an extention in the writer.&lt;/li&gt;
	&lt;li&gt;Added test cases for deleting documents and comparing field options in TestIndiciesEquals.&lt;/li&gt;
	&lt;li&gt;Fixed bug in index writer that did not create field settings for non indexed non stored fields, identified by the new test in previous point.&lt;/li&gt;
	&lt;li&gt;Introduced new class FieldNames that actually merges the field options. The previous patch just copied the most recent field setting from the writer, thus changing a setting  from true to false in some cases.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think that was all. I&apos;ll be committing this soon pending any comments.&lt;/p&gt;</comment>
                    <comment id="12607445" author="jasonrutherglen" created="Tue, 24 Jun 2008 03:14:32 +0100"  >&lt;p&gt;Will be interesting to try out your new patch.  The previous patch (may not be related to InstantiatedIndex though) is still yielding some errors in SegmentMerger.  It would be good to have a test using IndexWriter.addIndexes(IndexReader[] readers) simply passing in one InstantiatedIndexReader.  &lt;/p&gt;</comment>
                    <comment id="12607683" author="karl.wettin" created="Tue, 24 Jun 2008 17:57:26 +0100"  >&lt;blockquote&gt;&lt;p&gt;Will be interesting to try out your new patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s right there in the issue, as the top patch. ; )&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The previous patch (may not be related to InstantiatedIndex though) is still yielding some errors in SegmentMerger. It would be good to have a test using IndexWriter.addIndexes(IndexReader[] readers) simply passing in one InstantiatedIndexReader.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Feel free to add such a test to the patch. If not I&apos;ll look in to it next time I sit down with it.&lt;/p&gt;
</comment>
                    <comment id="12607686" author="jasonrutherglen" created="Tue, 24 Jun 2008 18:16:25 +0100"  >&lt;p&gt;The error I was seeing in SegmenMerger was related to how InstantiatedIndex keeps Document in memory, so any editting of the Document after the Document is returned by InstantiatedIndexReader later messes up SegmentMerger.  Tried out the patch and it worked for me.&lt;/p&gt;</comment>
                    <comment id="12607813" author="karl.wettin" created="Wed, 25 Jun 2008 01:10:16 +0100"  >&lt;blockquote&gt;&lt;p&gt;The error I was seeing in SegmenMerger was related to how InstantiatedIndex keeps Document in memory, so any editting of the Document after the Document is returned by InstantiatedIndexReader later messes up SegmentMerger.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you still have the exception? Can you paste it here?&lt;/p&gt;

&lt;p&gt;It&apos;s a bit dangerous to go modifying the Document instances returned by InstantiatedIndexReader unless you are really sure of what you are doing. The documents are the actual index document instances and not a deserialized clones as when using the Directory implementations. &lt;/p&gt;

&lt;p&gt;If you delete a field of such a document it&apos;s gone from the index. If you add a new field not previously known in the index, it will not be in sync with field options and you&apos;ll probably see strange side effects when merging with other indices, et c.  &lt;/p&gt;

&lt;p&gt;This could also be seen as a great feature that was lost in documentation. One of my favorites is to store the domain object(s) as Fieldable in the document(s) representing them.&lt;/p&gt;

&lt;p&gt;I&apos;ll add an appropriate comment about this in the javadocs.&lt;/p&gt;
</comment>
                    <comment id="12607828" author="jasonrutherglen" created="Wed, 25 Jun 2008 02:18:35 +0100"  >&lt;p&gt;I have an exception but it&apos;s different and not sure what it&apos;s related to.  I need more debug code to see the details, if I can reproduce it.  I am assuming it is related to InstantiatedIndexReader, given it would be difficult to make happen with the regular IndexReader code.  Fails on the last line of the code given.  Probably something to do with InstantiatedIndexReader and deleted docs differing somehow with other data SegmentMerger is obtaining.&lt;/p&gt;

&lt;p&gt;Exception:&lt;/p&gt;

&lt;p&gt;org.apache.lucene.index.CorruptIndexException: doc counts differ for segment _0: fieldsReader shows 5 but segmentInfo shows 20&lt;br/&gt;
	at org.apache.lucene.index.SegmentReader.initialize(SegmentReader.java:322)&lt;br/&gt;
	at org.apache.lucene.index.SegmentReader.get(SegmentReader.java:267)&lt;br/&gt;
	at org.apache.lucene.index.SegmentReader.get(SegmentReader.java:235)&lt;br/&gt;
	at org.apache.lucene.index.DirectoryIndexReader$1.doBody(DirectoryIndexReader.java:90)&lt;br/&gt;
	at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:649)&lt;br/&gt;
	at org.apache.lucene.index.DirectoryIndexReader.open(DirectoryIndexReader.java:97)&lt;br/&gt;
	at org.apache.lucene.index.IndexReader.open(IndexReader.java:213)&lt;br/&gt;
	at org.apache.lucene.index.IndexReader.open(IndexReader.java:209)&lt;/p&gt;

&lt;p&gt;Code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RAMDirectory ramDirectory = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RAMDirectory();
IndexWriter indexWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriter(ramDirectory, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, system.getDefaultAnalyzer(), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
indexWriter.setMergeScheduler(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerialMergeScheduler());
indexWriter.setUseCompoundFile(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
indexWriter.addIndexes(indexReaders);
indexWriter.close();
Directory.copy(ramDirectory, directory, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
initialIndexReader = IndexReader.open(directory, indexDeletionPolicy);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                    <comment id="12607833" author="jasonrutherglen" created="Wed, 25 Jun 2008 02:29:11 +0100"  >&lt;p&gt;In order to simulate a different IndexReader per update using InstantiatedIndexReader  I wrote the following code.  There must be some flaws in it as it keeps on causing errors in SegmentMerger.  I am overriding deleted docs and max doc.  Also the latest error, which I am sure is probably somehow fixable.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class OceanInstantiatedIndexReader &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; InstantiatedIndexReader {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDoc;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; deletedDocs;
  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; OceanInstantiatedIndexReader(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDoc, InstantiatedIndex index, Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; deletedDocs) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(index);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.maxDoc = maxDoc;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deletedDocs = deletedDocs;
  }
  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDoc() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; maxDoc;
  }
  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numDocs() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; maxDoc() - deletedDocs.size();
  }
  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isDeleted(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (n &amp;gt;= maxDoc) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deletedDocs != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; deletedDocs.contains(n)) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }
  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasDeletions() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ArrayIndexOutOfBoundsException
at java.lang.System.arraycopy(Native Method)
at org.apache.lucene.store.instantiated.InstantiatedIndexReader.norms(InstantiatedIndexReader.java:276)
at org.apache.lucene.index.SegmentMerger.mergeNorms(SegmentMerger.java:693)
at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:136)
at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:111)
at org.apache.lucene.index.IndexWriter.addIndexes(IndexWriter.java:3045)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12607838" author="jasonrutherglen" created="Wed, 25 Jun 2008 02:58:57 +0100"  >&lt;p&gt;Because the patch looks like a mess with the various changes I copied and pasted the alterations to InstantiatedIndexReader to allow the following code which works.  Basically saving a copy of normsByFieldNameAndDocumentNumber into the OceanInstantiatedIndexReader fixes the problem.  &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,List&amp;lt;NormUpdate&amp;gt;&amp;gt; updatedNormsByFieldNameAndDocumentNumber = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; class NormUpdate {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; doc;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; value;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; NormUpdate(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; doc, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; value) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.doc = doc;
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.value = value;
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; class OceanInstantiatedIndexReader &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; InstantiatedIndexReader {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDoc;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; deletedDocs;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt; normsByFieldNameAndDocumentNumber;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; OceanInstantiatedIndexReader(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDoc, InstantiatedIndex index, Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; deletedDocs) {
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(index);
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.maxDoc = maxDoc;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.deletedDocs = deletedDocs;
    normsByFieldNameAndDocumentNumber = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[]&amp;gt;(index.getNormsByFieldNameAndDocumentNumber());
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDoc() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; maxDoc;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void doSetNorm(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; doc, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; field, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; value) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updatedNormsByFieldNameAndDocumentNumber == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      updatedNormsByFieldNameAndDocumentNumber = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,List&amp;lt;NormUpdate&amp;gt;&amp;gt;(normsByFieldNameAndDocumentNumber.size());
    }
    List&amp;lt;NormUpdate&amp;gt; list = updatedNormsByFieldNameAndDocumentNumber.get(field);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (list == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      list = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LinkedList&amp;lt;NormUpdate&amp;gt;();
      updatedNormsByFieldNameAndDocumentNumber.put(field, list);
    }
    list.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NormUpdate(doc, value));
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] norms(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; field) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] norms = normsByFieldNameAndDocumentNumber.get(field);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updatedNormsByFieldNameAndDocumentNumber != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      norms = norms.clone();
      List&amp;lt;NormUpdate&amp;gt; updated = updatedNormsByFieldNameAndDocumentNumber.get(field);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updated != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (NormUpdate normUpdate : updated) {
          norms[normUpdate.doc] = normUpdate.value;
        }
      }
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; norms;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void norms(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; field, &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; offset) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] norms = normsByFieldNameAndDocumentNumber.get(field);
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(norms, offset, bytes, 0, norms.length);
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numDocs() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; maxDoc() - deletedDocs.size();
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isDeleted(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (n &amp;gt;= maxDoc)
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (deletedDocs != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; deletedDocs.contains(n))
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasDeletions() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12608466" author="karl.wettin" created="Thu, 26 Jun 2008 16:17:10 +0100"  >&lt;blockquote&gt;&lt;p&gt;Because the patch looks like a mess with the various changes I copied and pasted the alterations to InstantiatedIndexReader to allow the following code which works. Basically saving a copy of normsByFieldNameAndDocumentNumber into the OceanInstantiatedIndexReader fixes the problem.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t had time to look in to why you need to extend the code, but notice that InstantiatedIndexWriter creates a new byte[] on commit so your copy of the norms will be out of sync with the index unless you also update it at that point. There might be more to this than I can think of right now.&lt;/p&gt;

&lt;p&gt;Any other problems with the patch? I&apos;m ready to commit it.&lt;/p&gt;</comment>
                    <comment id="12608477" author="jasonrutherglen" created="Thu, 26 Jun 2008 17:03:53 +0100"  >&lt;p&gt;The byte[] stuff seems ok.  &lt;/p&gt;

&lt;p&gt;Is there an easy way to add a InstantiatedIndexWriter.addIndexes(IndexReader[] readers) method?  Seems doable with the InstantiatedIndex(IndexReader sourceIndexReader) constructor however I want to me able to merge another IndexReader in.  &lt;/p&gt;</comment>
                    <comment id="12608479" author="karl.wettin" created="Thu, 26 Jun 2008 17:15:36 +0100"  >&lt;blockquote&gt;&lt;p&gt;Is there an easy way to add a InstantiatedIndexWriter.addIndexes(IndexReader[] readers) method? Seems doable with the InstantiatedIndex(IndexReader sourceIndexReader) constructor however I want to me able to merge another IndexReader in.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s doable. The simplest solution I can think of is to reconstruct all the documents in one single enumeration of the source index and then add them to the writer. I&apos;m however not certain this is the best way nor if InstantiatedIndexWriter is the place for the code. &lt;/p&gt;

&lt;p&gt;I think it should be discussed in a new issue.&lt;/p&gt;</comment>
                    <comment id="12609028" author="karl.wettin" created="Sat, 28 Jun 2008 18:26:53 +0100"  >&lt;p&gt;Committed in revision 672556.&lt;/p&gt;

&lt;p&gt;Thanks Jason!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12384553" name="lucene-1312.patch" size="39948" author="karl.wettin" created="Tue, 24 Jun 2008 02:49:38 +0100" />
                    <attachment id="12384505" name="lucene-1312.patch" size="24934" author="jasonrutherglen" created="Mon, 23 Jun 2008 16:54:34 +0100" />
                    <attachment id="12384502" name="lucene-1312.patch" size="19412" author="jasonrutherglen" created="Mon, 23 Jun 2008 16:37:11 +0100" />
                    <attachment id="12384443" name="lucene-1312.patch" size="18731" author="jasonrutherglen" created="Sun, 22 Jun 2008 07:18:49 +0100" />
                    <attachment id="12384442" name="lucene-1312.patch" size="18646" author="jasonrutherglen" created="Sun, 22 Jun 2008 02:16:14 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 22 Jun 2008 20:44:58 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12436</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26416</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>