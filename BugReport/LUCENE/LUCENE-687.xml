<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:28:17 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-687/LUCENE-687.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-687] Performance improvement: Lazy skipping on proximity file</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-687</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I&apos;m proposing a patch here that changes org.apache.lucene.index.SegmentTermPositions to avoid unnecessary skips and reads on the proximity stream. Currently a call of next() or seek(), which causes a movement to a document in the freq file also moves the prox pointer to the posting list of that document.  But this is only necessary if actual positions have to be retrieved for that particular document. &lt;/p&gt;

&lt;p&gt;Consider for example a phrase query with two terms: the freq pointer for term 1 has to move to document x to answer the question if the term occurs in that document. But &lt;b&gt;only&lt;/b&gt; if term 2 also matches document x, the positions have to be read to figure out if term 1 and term 2 appear next to each other in document x and thus satisfy the query. &lt;/p&gt;

&lt;p&gt;A move to the posting list of a document can be quite expensive. It has to be skipped to the last skip point before that document and then the documents between the skip point and the desired document have to be scanned, which means that the VInts of all positions of those documents have to be read and decoded. &lt;/p&gt;

&lt;p&gt;An improvement is to move the prox pointer lazily to a document only if nextPosition() is called. This will become even more important in the future when the size of the proximity file increases (e. g. by adding payloads to the posting lists).&lt;/p&gt;

&lt;p&gt;My patch implements this lazy skipping. All unit tests pass. &lt;/p&gt;


&lt;p&gt;I also attach a new unit test that works as follows:&lt;br/&gt;
Using a RamDirectory an index is created and test docs are added. Then the index is optimized to make sure it only has a single segment. This is important, because IndexReader.open() returns an instance of SegmentReader if there is only one segment in the index. The proxStream instance of SegmentReader is package protected, so it is possible to set proxStream to a different object. I am using a class called SeeksCountingStream that extends IndexInput in a way that it is able to count the number of invocations of seek(). &lt;/p&gt;

&lt;p&gt;Then the testcase searches the index using a PhraseQuery &quot;term1 term2&quot;. It is known how many documents match that query and the testcase can verify that seek() on the proxStream is not called more often than number of search hits.&lt;/p&gt;

&lt;p&gt;Example:&lt;br/&gt;
Number of docs in the index: 500&lt;br/&gt;
Number of docs that match the query &quot;term1 term2&quot;: 5&lt;/p&gt;

&lt;p&gt;Invocations of seek on prox stream (old code): 29&lt;br/&gt;
Invocations of seek on prox stream (patched version): 5&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Michael&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
            <key id="12353477">LUCENE-687</key>
            <summary>Performance improvement: Lazy skipping on proximity file</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="yseeley@gmail.com">Yonik Seeley</assignee>
                                <reporter username="buschmic">Michael Busch</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Oct 2006 10:15:40 +0100</created>
                <updated>Tue, 27 Feb 2007 18:10:35 +0000</updated>
                    <resolved>Mon, 30 Oct 2006 22:01:02 +0000</resolved>
                                            <fixVersion>2.1</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>1</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12443303" author="yseeley@gmail.com" created="Wed, 18 Oct 2006 18:27:50 +0100"  >&lt;p&gt;Awesome stuff Michael!&lt;/p&gt;

&lt;p&gt;This looks like it should speed up most phrase seaches.  Do you have any performance numbers?&lt;br/&gt;
Is the slowdown measurable in the worst case of a phrase query with both terms in every document?&lt;/p&gt;

&lt;p&gt;I&apos;ll try and review it more in-depth soon.&lt;/p&gt;</comment>
                    <comment id="12443343" author="buschmic" created="Wed, 18 Oct 2006 20:41:19 +0100"  >&lt;p&gt;Hi Yonik,&lt;/p&gt;

&lt;p&gt;thanks for the quick reply! I&apos;m going to do performance tests and will give you some numbers soon.&lt;/p&gt;</comment>
                    <comment id="12445683" author="michaelbusch" created="Mon, 30 Oct 2006 18:35:23 +0000"  >&lt;p&gt;I made some performance experiments with phrase searches. For every query I measured the search time as well as the number of invocations of IndexInput.readVint(). While the search time is very specific for my test environment, the number of Vints should tell us how much I/O we safe independent from the actual hardware.&lt;/p&gt;

&lt;p&gt;Test environment:&lt;br/&gt;
2x Intel Xeon CPU 2.80GHz&lt;br/&gt;
4GB RAM&lt;br/&gt;
280GB SCSI HD&lt;br/&gt;
Windows Server 2003&lt;/p&gt;


&lt;p&gt;My index contains about 460,000 documents from different websites like www.cnn.com, www.joelonsoftware.com,..., also German sites like www.heise.de.&lt;br/&gt;
The search times below are average values over 10 searches.&lt;/p&gt;

&lt;p&gt;Tests:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Query: &quot;the der&quot;&lt;br/&gt;
  This should be a hard query, because &quot;the&quot; appears in almost every English document whereas &quot;der&quot; in almost every German document.&lt;br/&gt;
  Number of hits: 15&lt;br/&gt;
  Execution time in ms (old, new, improvement): 651.3, 472.1, 28%&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;if VInts (old, new, improvement): 25786474, 16007634, 38%&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Query: &quot;joel on software&quot;&lt;br/&gt;
  &quot;joel&quot; only appears in a small subset of documents, &quot;on&quot; in all English documents, and &quot;software&quot; can appear in German and English documents.&lt;br/&gt;
  Number of hits: 1613&lt;br/&gt;
  Execution time in ms (old, new, improvement): 33.0, 20.1, 39%&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;if VInts (old, new, improvement): 950243, 256481, 73%&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Query: &quot;much much more&quot;&lt;br/&gt;
  This is an example where we don&apos;t save so much I/O, because it is likely that all terms appear in the most English documents.&lt;br/&gt;
  Number of hits: 76&lt;br/&gt;
  Execution time in ms (old, new, improvement): 228.2, 215.5, 6%&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;if VInts (old, new, improvement): 3580288, 3067693, 14%&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think these numbers look pretty good. In the future, when we hopefully have proximity scoring, every search would benefit from this improvement. (I actually have a running version of proximity scoring in my local code and verified this). &lt;/p&gt;

&lt;p&gt;Did you have some time to look into the patch yet, Yonik? Let me know if you need more information, please.&lt;/p&gt;</comment>
                    <comment id="12445707" author="yseeley@gmail.com" created="Mon, 30 Oct 2006 20:33:41 +0000"  >&lt;p&gt;I did some quick synthetic tests of my own.... Java5 -server&lt;/p&gt;

&lt;p&gt;100,000 documents, 25 different terms, prob of term in doc = 1/term_number, sloppy phrase on 2 random terms&lt;br/&gt;
Improvement: -3.1%&lt;/p&gt;

&lt;p&gt;Change term probability to 1/(term_number**2)&lt;br/&gt;
Improvement: 10.0%&lt;/p&gt;

&lt;p&gt;Test only terms 24,25 with term probability=1/term_number (so probabilities were 0.5 and 1.0)&lt;br/&gt;
Imprivement: -8.4%&lt;/p&gt;

&lt;p&gt;I think your patch is still worth applying because the likely distribution of terms, but I just wish that the performance hit was smaller in the worst-case scenario.&lt;/p&gt;</comment>
                    <comment id="12445709" author="yseeley@gmail.com" created="Mon, 30 Oct 2006 20:43:01 +0000"  >&lt;p&gt;Oh, those synthetic tests were done on a RAMDirectory, so that also reduces the benefits of your patch.&lt;/p&gt;</comment>
                    <comment id="12445727" author="yseeley@gmail.com" created="Mon, 30 Oct 2006 22:01:02 +0000"  >&lt;p&gt;Reviewed and committed.  Thanks Michael!&lt;/p&gt;</comment>
                    <comment id="12445742" author="michaelbusch" created="Tue, 31 Oct 2006 00:08:54 +0000"  >&lt;p&gt;Yonik,&lt;/p&gt;

&lt;p&gt;thanks for committing the patch!&lt;br/&gt;
About the performance tests you did: I think even on a RAMDirectory the patch should not slow down any queries significantly. I did some profiling and I think that the frequent calls of lazySkip() are quite expensive. I attach a small patch that uses a boolean variable &quot;needsSkip&quot; to check whether lazySkip() actually needs to be called. Could you rerun your experiments with this version?&lt;/p&gt;

&lt;p&gt;All unit tests pass with this patch.&lt;/p&gt;</comment>
                    <comment id="12445979" author="yseeley@gmail.com" created="Tue, 31 Oct 2006 18:04:36 +0000"  >&lt;p&gt;I tried with the boolean, but it made no difference with 1.5 or 1.6 server JVMs.  The overhead is probably due to increased state in the object as well as an unpredictable branch in the inner loop.&lt;br/&gt;
I&apos;m not too worried though... my artificial test isn&apos;t really representative if the common usecases of phrase queries on  full-text fields which have more varied term frequencies and more positions per document.&lt;/p&gt;</comment>
                    <comment id="12476267" author="mikemccand" created="Tue, 27 Feb 2007 18:10:35 +0000"  >&lt;p&gt;Closing all issues that were resolved for 2.1.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12343966" name="lazy_prox_skipping2.patch" size="2156" author="michaelbusch" created="Tue, 31 Oct 2006 00:08:54 +0000" />
                    <attachment id="12343150" name="lazy_prox_skipping.patch" size="9110" author="buschmic" created="Wed, 18 Oct 2006 10:18:59 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 18 Oct 2006 17:27:50 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>13065</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>27043</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>