<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:11:24 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3328/LUCENE-3328.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3328] Specialize BooleanQuery if all clauses are TermQueries</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3328</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;During work on &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3319&quot; title=&quot;Cut over remaining queries to provide PositionIterators&quot;&gt;&lt;del&gt;LUCENE-3319&lt;/del&gt;&lt;/a&gt; I ran into issues with BooleanQuery compared to PhraseQuery in the exact case. If I disable scoring on PhraseQuery and bypass the position matching, essentially doing a conjunction match, ExactPhraseScorer beats plain boolean scorer by 40% which is a sizeable gain. I converted a ConjunctionScorer to use DocsEnum directly but still didn&apos;t get all the 40% from PhraseQuery. Yet, it turned out with further optimizations this gets very close to PhraseQuery. The biggest gain here came from converting the hand crafted loop in ConjunctionScorer#doNext to a for loop which seems to be less confusing to hotspot. In this particular case I think code specialization makes lots of sense since BQ with TQ is by far one of the most common queries.&lt;/p&gt;

&lt;p&gt;I will upload a patch shortly&lt;/p&gt;</description>
                <environment></environment>
            <key id="12514777">LUCENE-3328</key>
            <summary>Specialize BooleanQuery if all clauses are TermQueries</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="simonw">Simon Willnauer</assignee>
                                <reporter username="simonw">Simon Willnauer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Jul 2011 11:40:44 +0100</created>
                <updated>Fri, 10 May 2013 11:44:03 +0100</updated>
                    <resolved>Fri, 22 Jul 2011 17:08:12 +0100</resolved>
                            <version>3.4</version>
                <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13068269" author="simonw" created="Wed, 20 Jul 2011 11:41:54 +0100"  >&lt;p&gt;here is a first patch that rewrites to ConjunctinTermQuery if possible. &lt;/p&gt;</comment>
                    <comment id="13068272" author="rcmuir" created="Wed, 20 Jul 2011 11:46:12 +0100"  >&lt;p&gt;do we really need an extra query or rewrite? Can&apos;t booleanweight just pick ConjunctionTermScorer in this case?&lt;/p&gt;</comment>
                    <comment id="13068287" author="rcmuir" created="Wed, 20 Jul 2011 12:35:30 +0100"  >&lt;p&gt;here is the same thing, only as a scorer that booleanweight picks.&lt;/p&gt;

&lt;p&gt;this is much simpler imo:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;no state-keeping of &apos;rewriteToConjunctionTermsQuery&apos; in the Query&lt;/li&gt;
	&lt;li&gt;no hassles for any highlighters or anything doing instanceof&lt;/li&gt;
	&lt;li&gt;plays correct with booleanquery&apos;s rewrite: e.g. hoisting of single-clauses into termqueries.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In general i think Query.rewrite should be reserved for simplifying Queries, this is not a simpler query, just a faster scorer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13068394" author="simonw" created="Wed, 20 Jul 2011 15:17:05 +0100"  >&lt;blockquote&gt;&lt;p&gt;here is the same thing, only as a scorer that booleanweight picks.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I like the size of the patch! Thanks for moving this into the weight. I had it separate to make BW less complex but this looks good though.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;In general i think Query.rewrite should be reserved for simplifying Queries, this is not a simpler query, just a faster scorer &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I disagree here, if this would be the case it should be called simplify(Query). In general its a rewrite method and should not be judged if it simplifies or not. &lt;/p&gt;



&lt;p&gt;Here are some benchmark results trunk vs. patch (10M medium wiki docs):&lt;/p&gt;


&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Task&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS Trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;StdDev&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS Patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&#160;StdDev&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Pct diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Prefix3&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;29.84&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;29.02&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.37&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; -10% - 5%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;IntNRQ&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;5.82&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.67&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5.68 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &#160;0.55&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-20% - 20%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Wildcard&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.96&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.77&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.62&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.63&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; -10% - 7%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Term &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;79.10&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;4.32&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;77.43&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;3.25&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; -11% -  7%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OrHighMed &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;15.67&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.94&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.44&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.00&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-13% - 11%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;TermGroup1M  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160; 10.82&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.76&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.77&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.69 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-13% - &#160; 13%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OrHighHigh&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;3.31&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.37&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;3.29&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.37 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; -20% - 24% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Respell&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.99&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.59&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.95&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.52&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-6% -  6%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;TermBGroup1M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.87&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.09&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.86&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.94&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-14% - 17% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Fuzzy1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;24.38&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.19&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;24.39&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.84&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-7% -  8% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;TermBGroup1M1P&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17.67&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.33&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17.79&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-12% - 15% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Fuzzy2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;7.60&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.64&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;7.67&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.59&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-14% - 18% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Phrase&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;6.84&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.64&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;6.91&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.62&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-15% - 21% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SpanNear&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.90&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.24&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.92&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.22&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-20% - 29% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;PKLookup&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;76.01&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;4.56&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;76.99&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;3.26&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-8% - 12% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SloppyPhrase&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;2.49&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.25&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;2.53&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.23&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-16% - 23% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AndHighMed&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;29.80&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;33.50&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;1.31 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;4% - 21% &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AndHighHigh&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.74&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.67&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;12.26&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;0.55 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;2% - 27% &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
</comment>
                    <comment id="13068398" author="rcmuir" created="Wed, 20 Jul 2011 15:24:21 +0100"  >&lt;blockquote&gt;
&lt;p&gt;I disagree here, if this would be the case it should be called simplify(Query). In general its a rewrite method and should not be judged if it simplifies or not. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think this is really important to hash out: if we want to optimize query execution, we should do this totally internally at the lowest level possible.&lt;br/&gt;
If the optimization is to use a specialized scorer, then I think the right place to do this is inside the Weight.&lt;/p&gt;

&lt;p&gt;I don&apos;t think we should create a bunch of queries that are really the same and rewrite to each other: because this is more &apos;exposed&apos; to end users, e.g.&lt;br/&gt;
highlighting, caching, and who knows what people are doing in their custom code.&lt;/p&gt;

&lt;p&gt;It also requires a heavy maintenance burden of duplicate logic and testing for explain, hashcode, equals, etc.&lt;/p&gt;</comment>
                    <comment id="13068431" author="simonw" created="Wed, 20 Jul 2011 16:16:34 +0100"  >&lt;p&gt;I agree with you that in this case a scorer is more elegant. Yet, the rewrite process is a very powerful process that can be used for query optimization etc. from the outside. What I am trying to say is that this is not necessarily bound to &quot;simplification&quot;. All your points are valid!&lt;/p&gt;</comment>
                    <comment id="13068443" author="mikemccand" created="Wed, 20 Jul 2011 16:44:56 +0100"  >&lt;p&gt;That&apos;s a nice speedup for AND of terms!!&lt;/p&gt;</comment>
                    <comment id="13068455" author="rcmuir" created="Wed, 20 Jul 2011 17:02:07 +0100"  >&lt;p&gt;Also, I am usually positive on backporting improvements to 3.x to get them back to the users quickly, but I think&lt;br/&gt;
we should do this only in trunk.&lt;/p&gt;

&lt;p&gt;The reason is: 3.x is going to be very hairy here, since the computation of scoring (including score caches and shit) is&lt;br/&gt;
conflated into the postings list matching for termquery, since it has no termstate to pull from, ...&lt;/p&gt;</comment>
                    <comment id="13068467" author="rcmuir" created="Wed, 20 Jul 2011 17:11:25 +0100"  >&lt;p&gt;setting 4.0-only.&lt;/p&gt;

&lt;p&gt;if someone volunteers to comes up with some smart not-buggy and not-hairy patch, thats cool, I just can&apos;t visualize it now.&lt;/p&gt;</comment>
                    <comment id="13068683" author="simonw" created="Wed, 20 Jul 2011 23:38:11 +0100"  >&lt;p&gt;next iteration. I added two util methods to get a TermsEnum and a ExactDocScorer from a TermWeight which allowed to make all the members private again. This looks little cleaner now and eventually if we cut over PhraseQuery to use BQ + PosIterators it can simply get all it needs from the TermsEnum like DocsAndPosEnum &amp;amp; totalTermFreq.&lt;/p&gt;

&lt;p&gt;I also tried to optimize the doNext() loop even further to save one more comparison to hopefully help hotspot even further. I need to benchmark this patch one more time but overall this looks close.&lt;/p&gt;

&lt;p&gt;I also added a CHANGES.TXT entry.&lt;/p&gt;</comment>
                    <comment id="13068703" author="mikemccand" created="Thu, 21 Jul 2011 00:16:03 +0100"  >&lt;p&gt;Results from latest patch:&lt;/p&gt;

&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Task&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS base&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;StdDev base&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;QPS bqterms&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;StdDev bqterms&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Pct diff&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Fuzzy2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;34.74&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.40&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;34.58&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.49&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;2%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Fuzzy1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;23.85&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.25&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;23.78&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.31&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;2%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;2%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Respell&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;31.26&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.40&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;31.24&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.08&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;4%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;4%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;PKLookup&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;137.63&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.79&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;138.19&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.90&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;6%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;7%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OrHighHigh&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;18.91&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.29&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;19.04&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.49&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;3%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;4%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Wildcard&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;50.35&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.12&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;50.82&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.32&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;3%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;5%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;IntNRQ&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9.14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.38&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9.24&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.42&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;7%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;10%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OrHighMed&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.38&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.36&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10.55&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.39&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;5%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Prefix3&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.22&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.34&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15.51&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.30&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;2%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;6%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;TermBGroup1M1P&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;57.45&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;58.81&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.75&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;4%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SpanNear&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4.28&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.28&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4.40&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.08&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;5%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;11%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;TermBGroup1M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;46.36&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.38&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;47.93&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.88&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;3%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;10%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;TermGroup1M&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;47.63&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.93&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;49.31&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.83&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;2%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Term&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;137.86&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.74&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;142.82&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;6.55&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;5%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;13%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SloppyPhrase&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;19.72&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.87&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;20.62&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.01&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;0%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;9%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Phrase&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.28&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.19&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.50&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;red&quot;&gt;2%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;16%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AndHighMed&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;87.52&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.55&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;100.80&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4.80&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;6%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;24%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AndHighHigh&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;14.92&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.55&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17.33&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;0.91&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;green&quot;&gt;6%&lt;/font&gt;-&lt;font color=&quot;green&quot;&gt;26%&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;


&lt;p&gt;Looks great!&lt;/p&gt;</comment>
                    <comment id="13068807" author="michaelbusch" created="Thu, 21 Jul 2011 06:23:56 +0100"  >&lt;p&gt;Nice improvements!&lt;/p&gt;

&lt;p&gt;I&apos;m wondering if you considered having ConjunctionTermScorer use the terms&apos; IDF values to decide which iterator to advance when all are on the same docID? It should always be best to pick the rarest term.&lt;/p&gt;

&lt;p&gt;We&apos;ve talked about doing that in the past, but it&apos;s hard to support this for any type of subclause, because you&apos;d have to add the ability to estimate the IDFs of possible subclauses.&lt;/p&gt;

&lt;p&gt;But with this change it seems very feasible to try for BQs that only have TQ clauses.&lt;/p&gt;</comment>
                    <comment id="13068821" author="simonw" created="Thu, 21 Jul 2011 07:08:25 +0100"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m wondering if you considered having ConjunctionTermScorer use the terms&apos; IDF values to decide which iterator to advance when all are on the same docID? It should always be best to pick the rarest term.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The ConjunctionTermScorer sorts the DocsEnums by their frequency in the ctor. The leader will always be the lowest frequent term in the set. is this what you mean here?&lt;/p&gt;

&lt;p&gt;We could even optimize the doNext loop and advance the lead to the last document we stepped out of the inner loop since this is guaranteed to be greater than the document the lead enum is on. I just wonder if we at some point step into the slowness of DocsEnum#advance(). It very important to make #advance(doc+1) as fast as #nextDoc() in order to keep our algs clean! &lt;/p&gt;</comment>
                    <comment id="13068982" author="simonw" created="Thu, 21 Jul 2011 14:49:13 +0100"  >&lt;p&gt;I think this is ready. I will commit this tomorrow if nobody objects.&lt;/p&gt;</comment>
                    <comment id="13069061" author="michaelbusch" created="Thu, 21 Jul 2011 17:42:43 +0100"  >&lt;blockquote&gt;
&lt;p&gt;The ConjunctionTermScorer sorts the DocsEnums by their frequency in the ctor. The leader will always be the lowest frequent term in the set. is this what you mean here?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Cool, yeah that&apos;s roughly what I meant. In general, it&apos;s best to always pick the lowest-df enum as leader:&lt;br/&gt;
1) after initialization&lt;br/&gt;
2) after a hit was found&lt;br/&gt;
3) whenever a doc matched m out of n enums, 1 &amp;lt; m &amp;lt; n&lt;/p&gt;

&lt;p&gt;I think what you described covers situation 1), does it also cover 2) and 3)?&lt;/p&gt;</comment>
                    <comment id="13069479" author="simonw" created="Fri, 22 Jul 2011 11:02:11 +0100"  >&lt;blockquote&gt;
&lt;p&gt;2) after a hit was found&lt;br/&gt;
3) whenever a doc matched m out of n enums, 1 &amp;lt; m &amp;lt; n&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;maybe I miss something here but really how can we know how many docs are left in an enum during 2. and 3. We could use the doc an enum has advanced to in 3. to also advance the leader but as I said in a comment above I am still afraid of the advance call since it can give a serious perf hit if docs are close together.&lt;/p&gt;</comment>
                    <comment id="13069488" author="simonw" created="Fri, 22 Jul 2011 11:28:49 +0100"  >&lt;p&gt;I just committed the latest patch to trunk. should we open a new issue for disjunction?&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="13069526" author="mikemccand" created="Fri, 22 Jul 2011 13:44:48 +0100"  >&lt;blockquote&gt;&lt;p&gt;should we open a new issue for disjunction?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="13069690" author="paul.elschot@xs4all.nl" created="Fri, 22 Jul 2011 20:24:26 +0100"  >&lt;p&gt;Sorry for not looking at this earlier, but in trunk now in ConjunctionTermScorer in the doNext method the lead TermScorer is not advanced when breaking to the advanceHead label even though the comment at the break states so.&lt;br/&gt;
I would expect this to works correctly but it is probably not as efficient as intended.&lt;/p&gt;

&lt;p&gt;I think advancing the lead in program code at the place of the break comment could fix this.&lt;/p&gt;</comment>
                    <comment id="13069728" author="simonw" created="Fri, 22 Jul 2011 21:38:19 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think advancing the lead in program code at the place of the break comment could fix this.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Paul this works and looks as expected. Once we break to the advanceHead label we step out the inner do {} while; and advance the head. Maybe I don&apos;t understand your comment correctly?&lt;/p&gt;

&lt;p&gt;There is certainly space for improvement here. for instance could the head be advanced to the doc we break on but the advance call there actually yields a perf hit. Yet, we can play some tricks like if (DF / maxdoc &amp;gt; X) enum.advance( n ) else while(n &amp;gt; enum.nextDoc()); which I think I&apos;ll look into after vacation &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13070134" author="paul.elschot@xs4all.nl" created="Sun, 24 Jul 2011 10:54:23 +0100"  >&lt;blockquote&gt;&lt;p&gt;this works and looks as expected. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Indeed so. I mistook the working of a labeled break for jumping to the beginning instead of to the end.&lt;br/&gt;
(The last time I used a label was actually with another programming language...)&lt;/p&gt;</comment>
                    <comment id="13070135" author="thetaphi" created="Sun, 24 Jul 2011 11:12:45 +0100"  >&lt;p&gt;Indeed breaks in Java are no real gotos. The label must always be placed &lt;b&gt;before&lt;/b&gt; the loop that you want to break out (it would give syntax error otherwise). In fact it simply exits the loop to this level and proceeds working &lt;b&gt;after&lt;/b&gt; the loop. A simple break without a label is identical to a non-hierarchical loop with a autogenerated label in front of it.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12487226" name="LUCENE-3328.patch" size="11311" author="simonw" created="Wed, 20 Jul 2011 23:38:10 +0100" />
                    <attachment id="12487141" name="LUCENE-3328.patch" size="8682" author="rcmuir" created="Wed, 20 Jul 2011 12:35:30 +0100" />
                    <attachment id="12487138" name="LUCENE-3328.patch" size="16416" author="simonw" created="Wed, 20 Jul 2011 11:41:54 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 20 Jul 2011 10:46:12 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2750</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24368</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>