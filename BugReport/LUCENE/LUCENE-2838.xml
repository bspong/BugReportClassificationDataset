<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:14 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2838/LUCENE-2838.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2838] ConstantScoreQuery should directly support wrapping Query and simply strip off scores</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2838</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Especially in MultiTermQuery rewrite modes we often simply need to strip off scores from Queries and make them constant score. Currently the code to do this looks quite ugly: new ConstantScoreQuery(new QueryWrapperFilter(query))&lt;/p&gt;

&lt;p&gt;As the name says, QueryWrapperFilter should make any other Query constant score, so why does it not take a Query as ctor param? This question was aldso asked quite often by my customers and is simply correct, if you think about it.&lt;/p&gt;

&lt;p&gt;Looking closer into the code, it is clear that this would also speed up MTQs:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;One additional wrapping and method calls can be removed&lt;/li&gt;
	&lt;li&gt;Maybe we can even deprecate QueryWrapperFilter in 3.1 now (it&apos;s now only used in tests and the use-case for this class is not really available) and &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2831&quot; title=&quot;Revise Weight#scorer &amp;amp; Filter#getDocIdSet API to pass Readers context&quot;&gt;&lt;del&gt;LUCENE-2831&lt;/del&gt;&lt;/a&gt; does not need the stupid hack to make Simon&apos;s assertions pass&lt;/li&gt;
	&lt;li&gt;CSQ now supports out-of-order scoring and topLevel scoring, so a CSQ on top-level now directly feeds the Collector. For that a small trick is used: The score(Collector) calls are directly delegated and the scores are stripped by wrapping the setScorer() method in Collector&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;During that I found a visibility bug in Scorer (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2839&quot; title=&quot;Visibility of Scorer.score(Collector, int, int) is wrong&quot;&gt;&lt;del&gt;LUCENE-2839&lt;/del&gt;&lt;/a&gt;): The method &quot;boolean score(Collector collector, int max, int firstDocID)&quot; should be public not protected, as its not solely intended to be overridden by subclasses and is called from other classes, too! This leads to no compiler bugs as the other classes that calls it is mainly BooleanScorer(2) and thats in same package, but visibility is wrong. I will open an issue for that and fix it at least in trunk where we have no backwards-requirement.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12494206">LUCENE-2838</key>
            <summary>ConstantScoreQuery should directly support wrapping Query and simply strip off scores</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Dec 2010 22:24:53 +0000</created>
                <updated>Wed, 30 Mar 2011 16:50:14 +0100</updated>
                    <resolved>Sun, 2 Jan 2011 14:17:10 +0000</resolved>
                                            <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12976034" author="thetaphi" created="Thu, 30 Dec 2010 13:05:49 +0000"  >&lt;p&gt;Cleaned up patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed a useless testcase, no longer needed&lt;/li&gt;
	&lt;li&gt;added test for CSQ, that checks equals and hashCode&lt;/li&gt;
	&lt;li&gt;code cleanup&lt;/li&gt;
	&lt;li&gt;javadocs&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will commit this if nobody objects to 3.x and trunk. About deprecating QWF we should discuss in separate issues, maybe we can merge Filter and Query before 4.0!&lt;/p&gt;</comment>
                    <comment id="12976091" author="thetaphi" created="Thu, 30 Dec 2010 19:36:36 +0000"  >&lt;p&gt;After thinking one day about it, I found some problems with the &quot;collector hack&quot; and this style of decorator pattern:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If you wrap multiple times, the setScorer() method in the wrapped collector may set the wrong scorer (you see this, if you wrap multiple ConstantScoreQueries on top of each other, then the boost of the inner one is returned. The problem is that the score(Collector) method inverts the decorator pattern.&lt;/li&gt;
	&lt;li&gt;The inner scorer (like BoolenScorer with its buckets) may set a different scorer in the collector than itsself that implements doc() different, so setting the ConstantScorer always as collector&apos;s scorer can lead to wrong results (we dont see this in the test, as no collector uses Scorer.doc(), only Scorer.score(), which returns constant).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I changed the code so CSQ now passes always topScorer=false to Weight.scorer() of the wrapped query and does not overwrite score(Collector,...) methods. It still allows out-of-order collection. Now BooleanScorer2 is always used with MTQs.&lt;/p&gt;

&lt;p&gt;The question is, would the previous but broken optimization make sense for speed? Mike/Mark?&lt;/p&gt;</comment>
                    <comment id="12976445" author="thetaphi" created="Sat, 1 Jan 2011 20:23:35 +0000"  >&lt;p&gt;Attached is the correct solution of ConstantScoreQuery with a scorer that supports topScorer and directly delegates hit collection to its wrapped scorer. This enables use of the bucket-using BooleanScorer instead of BooleanScorer2 for MTQs.&lt;/p&gt;

&lt;p&gt;The test case verifies that the correct boosts are collected and queries wrapped two times with different boosts return the correct scores, too.&lt;/p&gt;</comment>
                    <comment id="12976446" author="thetaphi" created="Sat, 1 Jan 2011 20:41:54 +0000"  >&lt;p&gt;Sorry last patch was outdated...&lt;/p&gt;</comment>
                    <comment id="12976515" author="rcmuir" created="Sun, 2 Jan 2011 13:39:21 +0000"  >&lt;p&gt;I benchmarked the test (and wired the benchmark to use constant score boolean)...&lt;br/&gt;
I think the changes are in the wind, but its definitely no slower... +1 from me.&lt;/p&gt;

&lt;p&gt;separately, at some point we should open an issue to re-assess the cutoff criteria for constant score auto (maybe after the termstate thing).&lt;br/&gt;
we have been hacking on the boolean rewrites a lot and we want to make sure we default to the best performance!&lt;/p&gt;</comment>
                    <comment id="12976517" author="thetaphi" created="Sun, 2 Jan 2011 13:48:21 +0000"  >&lt;p&gt;Committed trunk revision: 1054406&lt;/p&gt;

&lt;p&gt;Now backporting!&lt;/p&gt;</comment>
                    <comment id="12976522" author="thetaphi" created="Sun, 2 Jan 2011 14:17:10 +0000"  >&lt;p&gt;Committed 3.x revision: 1054412&lt;/p&gt;

&lt;p&gt;Thanks Robert for building heavy indexes and testing performance!&lt;/p&gt;</comment>
                    <comment id="12976574" author="mikemccand" created="Sun, 2 Jan 2011 23:26:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;separately, at some point we should open an issue to re-assess the cutoff criteria for constant score auto (maybe after the termstate thing).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I&apos;ve been wondering about those cutoffs for a while now...&lt;/p&gt;
</comment>
                    <comment id="13013409" author="gsingers" created="Wed, 30 Mar 2011 16:50:14 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                <outwardlinks description="relates to">
                            <issuelink>
            <issuekey id="12493981">LUCENE-2831</issuekey>
        </issuelink>
                    </outwardlinks>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12494210">LUCENE-2839</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12467177" name="LUCENE-2838-no-topscorer-opt.patch" size="18465" author="thetaphi" created="Thu, 30 Dec 2010 19:36:36 +0000" />
                    <attachment id="12467259" name="LUCENE-2838.patch" size="24173" author="thetaphi" created="Sat, 1 Jan 2011 20:41:53 +0000" />
                    <attachment id="12467165" name="LUCENE-2838.patch" size="20190" author="thetaphi" created="Thu, 30 Dec 2010 13:05:49 +0000" />
                    <attachment id="12467075" name="LUCENE-2838.patch" size="12049" author="thetaphi" created="Tue, 28 Dec 2010 22:27:07 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>4.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 2 Jan 2011 13:39:21 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11023</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24854</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>