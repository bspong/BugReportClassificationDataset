<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:24:40 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3146/LUCENE-3146.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3146] IndexReader.setNorms is no op if one of the field instances omits norms</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3146</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;If I add two documents to an index w/ same field, and one of them omit norms, then IndexReader.setNorms is no-op. I&apos;ll attach a patch w/ test case&lt;/p&gt;</description>
                <environment></environment>
            <key id="12508409">LUCENE-3146</key>
            <summary>IndexReader.setNorms is no op if one of the field instances omits norms</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 May 2011 09:50:22 +0100</created>
                <updated>Sat, 2 Jul 2011 03:40:18 +0100</updated>
                    <resolved>Wed, 1 Jun 2011 09:15:46 +0100</resolved>
                                            <fixVersion>3.3</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13039591" author="shaie" created="Thu, 26 May 2011 09:52:23 +0100"  >&lt;p&gt;Patch w/ test that reproduces the problem. If you uncomment the commit() between addDoc() calls, the test passes. Could be related to recent changes w/ DWPT?&lt;/p&gt;</comment>
                    <comment id="13039592" author="shaie" created="Thu, 26 May 2011 09:52:55 +0100"  >&lt;p&gt;Forgot to mention that the same test passes on 3x, even w/o the commit() in between addDoc() calls&lt;/p&gt;</comment>
                    <comment id="13039611" author="mikemccand" created="Thu, 26 May 2011 10:37:58 +0100"  >&lt;p&gt;I think this behavior, while spooky, is correct.  &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2846&quot; title=&quot;omitTF is viral, but omitNorms is anti-viral.&quot;&gt;&lt;del&gt;LUCENE-2846&lt;/del&gt;&lt;/a&gt; flipped the norms merging behavior so that omitNorm now &quot;spreads&quot;, in 4.0 (not 3.x).&lt;/p&gt;

&lt;p&gt;But the javadoc in Field.NOT_ANALYZED_NO_NORMS needs to be fixed, on trunk.&lt;/p&gt;

&lt;p&gt;I think, also, SegmentReader.doSetNorm should throw an exc if you attempt to set norm on a field that does not have norms... it&apos;s bad that we silently ignore that... makes the app think the call succeeded when in fact nothing happened.&lt;/p&gt;</comment>
                    <comment id="13039614" author="mikemccand" created="Thu, 26 May 2011 10:43:54 +0100"  >&lt;p&gt;Also, in trunk, we now store a separate global field infos file (.fnx), which in theory could be used to catch this case when app attempts to use different omitNorms for different docs.  However, this only tracks field name -&amp;gt; number mapping, not settings in the schema like omitNorms... if we added things like omitNorms, omitTF to this, then we&apos;d have more consistent behavior here, and could fix this trap (if you uncomment the commit in the test case) where app thinks it succeeded in setting a norm but in fact on future merging it did not succeed.&lt;/p&gt;</comment>
                    <comment id="13041189" author="shaie" created="Mon, 30 May 2011 17:25:45 +0100"  >&lt;p&gt;Adding that info to .fnx is a good idea. But I&apos;m not sure it will solve the problem demonstrated in the test, only in different order.&lt;/p&gt;

&lt;p&gt;Say the app adds field &quot;a&quot; w/ omitNorms=false and commit(). Then .fnx records that field &quot;a&quot; stores norms and you can call IR.setNorms. Afterwards it adds field &quot;a&quot; w/ omitNorms=true &amp;#8211; now what? Do we fail the addDocument() (I think we should)? If we don&apos;t, then norms will be merged away, according to trunk&apos;s semantics.&lt;/p&gt;

&lt;p&gt;So I think we should fix the jdocs + throw the ex from IR.setNorms in this issue, and open a separate one for tracking norms in .fnx + fixing the scenario I&apos;ve described above?&lt;/p&gt;

&lt;p&gt;Do we have a ready-to-use exception? If not, how about IllegalArgEx (cause the field is an illegal arg, but weak), IllegalStateEx (cause the field does not track norms, but that ex is usually associated w/ Threads&apos; states), IllegalOpEx (is there such ex)? At any rate, we must throw a RuntimeEx (at least in 3x) to not break apps, compile-wise.&lt;/p&gt;</comment>
                    <comment id="13041213" author="mikemccand" created="Mon, 30 May 2011 18:51:13 +0100"  >&lt;p&gt;I agree we should first fix IR.setNorm to throw exc today... I like IllegalStateEx.&lt;/p&gt;

&lt;p&gt;And then open a separate issue; I agree add/updateDocument should fail.  Or, maybe, we allow the case you described (and it means all norms will now be omitted for this field), but the reverse case (you have been omitting norms up until now and suddenly you try to add a doc not omitting norms) we throw exc?&lt;/p&gt;</comment>
                    <comment id="13041234" author="shaie" created="Mon, 30 May 2011 20:01:36 +0100"  >&lt;blockquote&gt;&lt;p&gt;maybe, we allow the case you described (and it means all norms will now be omitted for this field)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Though I don&apos;t like the idea of someone mistakenly adding a field w/ omitNorms=true, and suddenly all norms disappear, I think we must allow that scenario in order to apps to be able to disable all norms for a field. Basically, I hope that apps don&apos;t do crazy things and are consistent &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. I&apos;ll open a separate issue to track that.&lt;/p&gt;</comment>
                    <comment id="13041252" author="mikemccand" created="Mon, 30 May 2011 20:39:58 +0100"  >&lt;p&gt;It&apos;s true that&apos;s a risk but... omitNorms (and omitTF) are effectively today a &quot;global schema&quot; because on merge Lucene cannot preserve different settings here, unlike, eg, term vectors or stored fields or the upcoming doc values, where every document is free to have its own &quot;schema&quot;.&lt;/p&gt;

&lt;p&gt;The fact that apps now see different behavior depending on when Lucene happened to merge segments is awful.&lt;/p&gt;

&lt;p&gt;Catching/enforcing this global schema up front, now made possible because we have the fnx file, is cleaner because merge selection would no longer be &quot;visible&quot; in the API.&lt;/p&gt;</comment>
                    <comment id="13041266" author="shaie" created="Mon, 30 May 2011 21:13:42 +0100"  >&lt;p&gt;Patch against trunk:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;fixes jdocs&lt;/li&gt;
	&lt;li&gt;SR.doSetNorms throws IllegalStateEx&lt;/li&gt;
	&lt;li&gt;CHANGES&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13042037" author="shaie" created="Wed, 1 Jun 2011 09:15:46 +0100"  >&lt;p&gt;Committed revision 1130039 (trunk).&lt;br/&gt;
Committed revision 1130041 (3x).&lt;/p&gt;

&lt;p&gt;Thanks Mike !&lt;/p&gt;</comment>
                    <comment id="13058942" author="rcmuir" created="Sat, 2 Jul 2011 03:40:18 +0100"  >&lt;p&gt;bulk close for 3.3&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12480872" name="LUCENE-3146.patch" size="3351" author="shaie" created="Mon, 30 May 2011 21:13:42 +0100" />
                    <attachment id="12480520" name="LUCENE-3146.patch" size="1995" author="shaie" created="Thu, 26 May 2011 09:52:23 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 26 May 2011 09:37:58 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2120</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24550</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>