<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:29:59 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3855/LUCENE-3855.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3855] TestStressNRT failures (reproducible)</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3855</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Build server logs. Reproduces on at least two machines.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=74960064,total=135987200
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_ng.cfs=8}
    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_ng.cfs=8}
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)
    [junit] 	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _ng.cfs
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper$1.openSlice(MockDirectoryWrapper.java:777)
    [junit] 	at org.apache.lucene.store.CompoundFileDirectory.openInput(CompoundFileDirectory.java:221)
    [junit] 	at org.apache.lucene.codecs.lucene3x.TermInfosReader.&amp;lt;init&amp;gt;(TermInfosReader.java:112)
    [junit] 	at org.apache.lucene.codecs.lucene3x.Lucene3xFields.&amp;lt;init&amp;gt;(Lucene3xFields.java:84)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.&amp;lt;init&amp;gt;(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.index.SegmentCoreReaders.&amp;lt;init&amp;gt;(SegmentCoreReaders.java:108)
    [junit] 	at org.apache.lucene.index.SegmentReader.&amp;lt;init&amp;gt;(SegmentReader.java:51)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] 
    [junit] 
    [junit] Test org.apache.lucene.index.TestStressNRT FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
            <key id="12545483">LUCENE-3855</key>
            <summary>TestStressNRT failures (reproducible)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="dweiss">Dawid Weiss</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Mar 2012 11:32:32 +0000</created>
                <updated>Fri, 10 May 2013 11:43:48 +0100</updated>
                    <resolved>Mon, 12 Mar 2012 12:23:42 +0000</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13224214" author="rcmuir" created="Wed, 7 Mar 2012 11:45:43 +0000"  >&lt;p&gt;This must be a timing issue/race of some sort?&lt;/p&gt;

&lt;p&gt;Doesn&apos;t reproduce on my machine... does it need multiple iterations usually to fail?&lt;/p&gt;</comment>
                    <comment id="13224232" author="dweiss" created="Wed, 7 Mar 2012 12:28:59 +0000"  >&lt;p&gt;Ok, it doesn&apos;t always happen, but it happens quite frequently (I re-run the test from scratch, didn&apos;t use repetitions). Interestingly, the problem seems to be different every time. I&apos;ll attach logs.&lt;/p&gt;</comment>
                    <comment id="13224236" author="dweiss" created="Wed, 7 Mar 2012 12:37:38 +0000"  >&lt;p&gt;Four executions, four errors (same seed).&lt;/p&gt;</comment>
                    <comment id="13224239" author="dweiss" created="Wed, 7 Mar 2012 12:39:21 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 10.377 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit] The following exceptions were thrown by threads:
    [junit] *** Thread: Lucene Merge Thread #133 ***
    [junit] org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:507)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)
    [junit] Caused by: java.lang.AssertionError
    [junit] 	at org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)
    [junit] 	at org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=86308600,total=202244096
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] java.lang.AssertionError: Some threads threw uncaught exceptions!
    [junit] java.lang.RuntimeException: java.lang.AssertionError: Some threads threw uncaught exceptions!
    [junit] 	at org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:816)
    [junit] 	at org.apache.lucene.util.LuceneTestCase.access$1100(LuceneTestCase.java:137)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:640)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.AssertionError: Some threads threw uncaught exceptions!
    [junit] 	at org.apache.lucene.util.LuceneTestCase.checkUncaughtExceptionsAfter(LuceneTestCase.java:844)
    [junit] 	at org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:788)
    [junit] 
    [junit] 

junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 11.454 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=77427992,total=143851520
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_eb.cfs=5}
    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_eb.cfs=5}
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)
    [junit] 	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _eb.cfs
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper$1.openSlice(MockDirectoryWrapper.java:777)
    [junit] 	at org.apache.lucene.store.CompoundFileDirectory.openInput(CompoundFileDirectory.java:221)
    [junit] 	at org.apache.lucene.codecs.lucene3x.TermInfosReader.&amp;lt;init&amp;gt;(TermInfosReader.java:112)
    [junit] 	at org.apache.lucene.codecs.lucene3x.Lucene3xFields.&amp;lt;init&amp;gt;(Lucene3xFields.java:84)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.&amp;lt;init&amp;gt;(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.index.SegmentCoreReaders.&amp;lt;init&amp;gt;(SegmentCoreReaders.java:108)
    [junit] 	at org.apache.lucene.index.SegmentReader.&amp;lt;init&amp;gt;(SegmentReader.java:51)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] 
    [junit] 

junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 10.892 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=70056648,total=148111360
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_30.frq=1, _l8.cfs=5, _30.tis=1, _30.tvx=1, _30.fdx=1, _30.fdt=1, _30.tvf=1, _30.tvd=1}
    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_30.frq=1, _l8.cfs=5, _30.tis=1, _30.tvx=1, _30.fdx=1, _30.fdt=1, _30.tvf=1, _30.tvd=1}
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)
    [junit] 	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _30.tis
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:504)
    [junit] 	at org.apache.lucene.codecs.lucene3x.TermInfosReader.&amp;lt;init&amp;gt;(TermInfosReader.java:112)
    [junit] 	at org.apache.lucene.codecs.lucene3x.Lucene3xFields.&amp;lt;init&amp;gt;(Lucene3xFields.java:84)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.&amp;lt;init&amp;gt;(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.index.SegmentCoreReaders.&amp;lt;init&amp;gt;(SegmentCoreReaders.java:108)
    [junit] 	at org.apache.lucene.index.SegmentReader.&amp;lt;init&amp;gt;(SegmentReader.java:51)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] 
    [junit] 

junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 11.678 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit] The following exceptions were thrown by threads:
    [junit] *** Thread: Lucene Merge Thread #78 ***
    [junit] org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:507)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)
    [junit] Caused by: java.lang.AssertionError
    [junit] 	at org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)
    [junit] 	at org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] *** Thread: Lucene Merge Thread #125 ***
    [junit] org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:507)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)
    [junit] Caused by: java.lang.AssertionError
    [junit] 	at org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)
    [junit] 	at org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+1
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_27 (64-bit)/cpus=2,threads=1,free=135293744,total=194379776
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] java.lang.AssertionError: Some threads threw uncaught exceptions!
    [junit] java.lang.RuntimeException: java.lang.AssertionError: Some threads threw uncaught exceptions!
    [junit] 	at org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:816)
    [junit] 	at org.apache.lucene.util.LuceneTestCase.access$1100(LuceneTestCase.java:137)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:640)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.AssertionError: Some threads threw uncaught exceptions!
    [junit] 	at org.apache.lucene.util.LuceneTestCase.checkUncaughtExceptionsAfter(LuceneTestCase.java:844)
    [junit] 	at org.apache.lucene.util.LuceneTestCase.tearDownInternal(LuceneTestCase.java:788)
    [junit] 
    [junit] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13224500" author="dweiss" created="Wed, 7 Mar 2012 16:52:54 +0000"  >&lt;p&gt;I began to think it&apos;s the Java version/ jvm bug that is causing these, but doesn&apos;t seem like it. Ran with the newest JRE 1.6:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 9.536 sec
    [junit]
    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=US/East-Indiana
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.0.0-16-generic amd64/Sun Microsystems Inc. 1.6.0_31 (64-bit)/cpus=2,threads=1,free=95936736,total=148307968
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):      FAILED
    [junit] info=_gx(4.0):C9/7 isn&apos;t live
    [junit] junit.framework.AssertionFailedError: info=_gx(4.0):C9/7 isn&apos;t live
    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)
    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)
    [junit]     at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1136)
    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)
    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)
    [junit]     at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)
    [junit]     at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:380)
    [junit]     at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit]     at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit]     at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit]     at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit]     at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit]
    [junit]
    [junit] Test org.apache.lucene.index.TestStressNRT FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13224801" author="dweiss" created="Wed, 7 Mar 2012 22:38:03 +0000"  >&lt;p&gt;Can&apos;t reproduce this on Windows, interestingly. But on another Ubuntu machine, without a problem &amp;#8211;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 1, Errors: 0, Time elapsed: 4.449 sec
    [junit]
    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Etc/GMT+11
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 2.6.32-38-server amd64/Sun Microsystems Inc. 1.6.0_20 (64-bit)/cpus=4,threads=1,free=150044128,total=174260224
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):      FAILED
    [junit] info=_dm(4.0):cv6/4 isn&apos;t live
    [junit] junit.framework.AssertionFailedError: info=_dm(4.0):cv6/4 isn&apos;t live
    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)
    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)
    [junit]     at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1136)
    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)
    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)
    [junit]     at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)
    [junit]     at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:380)
    [junit]     at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit]     at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit]     at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit]     at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit]     at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit]     at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit]     at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit]
    [junit]
    [junit] Test org.apache.lucene.index.TestStressNRT FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13225057" author="giladbarkai" created="Thu, 8 Mar 2012 07:04:01 +0000"  >&lt;p&gt;It fails here as well, not as often though,  &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=US/East-Indiana
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 3.2.7-1.fc16.x86_64 amd64/Sun Microsystems Inc. 1.6.0_24 (64-bit)/cpus=2,threads=1,free=44668576,total=133169152
    [junit] ------------- ---------------- ---------------

    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_vv.cfs=5, _j1.cfs=5}
    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_vv.cfs=5, _j1.cfs=5}
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)
    [junit] 	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _j1.cfs
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper$1.openSlice(MockDirectoryWrapper.java:777)
    [junit] 	at org.apache.lucene.store.CompoundFileDirectory.openInput(CompoundFileDirectory.java:221)
    [junit] 	at org.apache.lucene.codecs.lucene3x.Lucene3xStoredFieldsReader.&amp;lt;init&amp;gt;(Lucene3xStoredFieldsReader.java:156)
    [junit] 	at org.apache.lucene.codecs.lucene3x.Lucene3xStoredFieldsFormat.fieldsReader(Lucene3xStoredFieldsFormat.java:38)
    [junit] 	at org.apache.lucene.index.SegmentCoreReaders.&amp;lt;init&amp;gt;(SegmentCoreReaders.java:116)
    [junit] 	at org.apache.lucene.index.SegmentReader.&amp;lt;init&amp;gt;(SegmentReader.java:51)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13225085" author="dweiss" created="Thu, 8 Mar 2012 08:29:49 +0000"  >&lt;p&gt;Yep, there is something severely wrong in there, but I won&apos;t be able to figure it out on my own. Don&apos;t get the logic in IndexWriter. But I tracked one of the above exceptions to this scenario:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] junit.framework.AssertionFailedError: info=_dm(4.0):cv6/4 isn&apos;t live
    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)
    [junit]     at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)
    [junit]     at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1136)
    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)
    [junit]     at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)
    [junit]     at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)
    [junit]     at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:380)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, the case here is that infoIsLive attempts to check:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      int idx = segmentInfos.indexOf(info);
      assert idx != -1: &quot;info=&quot; + info + &quot; isn&apos;t live&quot;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I added tracing to segmentInfos when segments do get removed from the underlying array. Once executed, I get the listing:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;...
&amp;gt;&amp;gt;&amp;gt; Removing: _o1(4.0):Cv13/13
&amp;gt;&amp;gt;&amp;gt; Removing: _o0(4.0):Cv6/6
&amp;gt;&amp;gt;&amp;gt; Removing: _nu(4.0):C12/12
&amp;gt;&amp;gt;&amp;gt; Removing: _nw(4.0):Cv12/12
&amp;gt;&amp;gt;&amp;gt; Removing: _o9(4.0):c2/2
&amp;gt;&amp;gt;&amp;gt; Removing: _q2(4.0):C12/12
&amp;gt;&amp;gt;&amp;gt; Removing: _qc(4.0):Cv7/7
&amp;gt;&amp;gt;&amp;gt; Removing: _q6(4.0):C12/12
&amp;gt;&amp;gt;&amp;gt; Not found: _d9(4.0):Cv8/3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But that last segment is never on the list of removed segments. It was never added there in the first place. The allocation stack for that segment is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;	at java.lang.Thread.getStackTrace(Thread.java:1436)
	at org.apache.lucene.index.SegmentInfo.&amp;lt;init&amp;gt;(SegmentInfo.java:130)
	at org.apache.lucene.index.IndexWriter._mergeInit(IndexWriter.java:3418)
	at org.apache.lucene.index.IndexWriter.mergeInit(IndexWriter.java:3382)
	at org.apache.lucene.index.ConcurrentMergeScheduler.merge(ConcurrentMergeScheduler.java:346)
	at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1905)
	at org.apache.lucene.index.IndexWriter.maybeMerge(IndexWriter.java:1899)
	at org.apache.lucene.index.IndexWriter.prepareCommit(IndexWriter.java:2726)
	at org.apache.lucene.index.IndexWriter.commitInternal(IndexWriter.java:2809)
	at org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:2791)
	at org.apache.lucene.index.IndexWriter.commit(IndexWriter.java:2775)
	at org.apache.lucene.index.RandomIndexWriter.commit(RandomIndexWriter.java:313)
	at org.apache.lucene.index.TestStressNRT$1.run(TestStressNRT.java:156)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this looks like a race condition between closing the writer and a concurrent merge scheduler? &lt;/p&gt;

&lt;p&gt;Let me know if you need any further stacks/ tracing listings &amp;#8211; this is fairly easy to reproduce on my machine and I can add anything.&lt;/p&gt;</comment>
                    <comment id="13225088" author="dweiss" created="Thu, 8 Mar 2012 08:49:55 +0000"  >&lt;p&gt;This is definitely a race between ConcurrentMergeScheduler and the thread calling close. Everything else seems to stem from this problem. For example this one:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_dc.tvx=1, _dc.tvf=1, _dc.tvd=1, _dc.fdx=1, _dc.fdt=1, _dc.frq=1, _dc.tis=1}
	at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)
	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;has an underlying open file handle stack:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.lang.RuntimeException: unclosed IndexInput: _dc.tvf
	at org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)
	at org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:504)
	at org.apache.lucene.codecs.lucene3x.Lucene3xTermVectorsReader.&amp;lt;init&amp;gt;(Lucene3xTermVectorsReader.java:137)
	at org.apache.lucene.codecs.lucene3x.PreFlexRWTermVectorsFormat$1.&amp;lt;init&amp;gt;(PreFlexRWTermVectorsFormat.java:39)
	at org.apache.lucene.codecs.lucene3x.PreFlexRWTermVectorsFormat.vectorsReader(PreFlexRWTermVectorsFormat.java:39)
	at org.apache.lucene.index.SegmentCoreReaders.&amp;lt;init&amp;gt;(SegmentCoreReaders.java:119)
	at org.apache.lucene.index.SegmentReader.&amp;lt;init&amp;gt;(SegmentReader.java:51)
	at org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)
	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3591)
	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3261)
	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Uwe, this just calls for your German analytic mind to solve &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13225134" author="mikemccand" created="Thu, 8 Mar 2012 11:09:45 +0000"  >&lt;p&gt;I can &lt;span class=&quot;error&quot;&gt;&amp;#91;eventually&amp;#93;&lt;/span&gt; reproduce the failure too, if I beast the test...&lt;/p&gt;</comment>
                    <comment id="13225136" author="dweiss" created="Thu, 8 Mar 2012 11:12:47 +0000"  >&lt;p&gt;I think you can try to run a few threads in the background doing just while (true);. I have a slower computer 2-core computer and this happens there most often.&lt;/p&gt;</comment>
                    <comment id="13225229" author="mikemccand" created="Thu, 8 Mar 2012 14:45:07 +0000"  >&lt;p&gt;Hmm... compounding problems here is that, somehow, an exception is occurring in a CMS merge thread, yet is never reported by the test runner.  I hit a fail, and only got this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Australia/LHI
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 2.6.33.6-147.fc13.x86_64 amd64/Sun Microsystems Inc. 1.6.0_21 (64-bit)/cpus=24,threads=1,free=257856112,total=285933568
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	FAILED
    [junit] info=_fu(4.0):C11/1 isn&apos;t live
    [junit] junit.framework.AssertionFailedError: info=_fu(4.0):C11/1 isn&apos;t live
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReaderPool.infoIsLive(IndexWriter.java:663)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReaderPool.dropAll(IndexWriter.java:717)
    [junit] 	at org.apache.lucene.index.IndexWriter.closeInternal(IndexWriter.java:1137)
    [junit] 	at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1069)
    [junit] 	at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:1033)
    [junit] 	at org.apache.lucene.index.RandomIndexWriter.close(RandomIndexWriter.java:408)
    [junit] 	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:386)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 
    [junit] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also separately added a SOP to ConcurrentMergeScheduler.handleMergeException and we are calling that... yet something is not then reporting this exception.&lt;/p&gt;

&lt;p&gt;However: I made a silly small test case that spawns a thread that throws an exception from its run method, and when I run that indeed I see the &quot;unhandled exception from thread&quot;.  So I&apos;m not sure why exceptions in CMS threads in particular are not being reported...&lt;/p&gt;</comment>
                    <comment id="13225241" author="dweiss" created="Thu, 8 Mar 2012 15:04:46 +0000"  >&lt;p&gt;I&apos;ll fix this, Mike.&lt;/p&gt;</comment>
                    <comment id="13225242" author="dweiss" created="Thu, 8 Mar 2012 15:05:08 +0000"  >&lt;p&gt;And by &quot;this&quot; I mean &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3857&quot; title=&quot;exceptions from other threads in beforeclass/etc do not fail the test&quot;&gt;&lt;del&gt;LUCENE-3857&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    <comment id="13225250" author="mikemccand" created="Thu, 8 Mar 2012 15:13:13 +0000"  >&lt;p&gt;Thanks Dawid!  I&apos;m not sure &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3857&quot; title=&quot;exceptions from other threads in beforeclass/etc do not fail the test&quot;&gt;&lt;del&gt;LUCENE-3857&lt;/del&gt;&lt;/a&gt; is what I&apos;m hitting (this test doesn&apos;t have a @beforeClass).&lt;/p&gt;

&lt;p&gt;One more piece of data: sometimes the CMS exception &lt;b&gt;is&lt;/b&gt; printed in the &quot;unhandled exceptions&quot; output... so it&apos;s somehow intermittant.  Hmm, it could be... the main thread threw its exc before CMS thread did?  Odd, though, because IW closes CMS first (which should join to all outstanding threads), before hitting the exc in main thread.  Still baffled...&lt;/p&gt;

&lt;p&gt;Anyway it&apos;s not a blocker for me... I&apos;m printing the exc in CMS.handleExc.&lt;/p&gt;</comment>
                    <comment id="13225265" author="dweiss" created="Thu, 8 Mar 2012 15:36:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3857&quot; title=&quot;exceptions from other threads in beforeclass/etc do not fail the test&quot;&gt;&lt;del&gt;LUCENE-3857&lt;/del&gt;&lt;/a&gt; is what I&apos;m hitting (this test doesn&apos;t have a @beforeClass).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, I don&apos;t think it is. But I&apos;ll fix that issue anyway.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;One more piece of data: sometimes the CMS exception is printed in the &quot;unhandled exceptions&quot; output... so it&apos;s somehow intermittant.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is really messy in the current LTC. I&apos;ll try to do something about it.&lt;/p&gt;</comment>
                    <comment id="13225416" author="hossman" created="Thu, 8 Mar 2012 19:15:11 +0000"  >&lt;p&gt;attached file was generated using trunk r1298470 with the command...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;X=0; while ant test-core -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;; do X=$(($X+1)); echo &quot;Finished Loop $X&quot;; done; echo &quot;TOTAL LOOPS: $X&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the failure occured on loop #52&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit-sequential:
    [junit] Testsuite: org.apache.lucene.index.TestStressNRT
    [junit] Tests run: 1, Failures: 0, Errors: 1, Time elapsed: 5.082 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestStressNRT -Dtestmethod=test -Dtests.seed=69468941c1bbf693:19e66d58475da929:69e9d2f81769b6d0 -Dargs=&quot;-Dfile.encoding=UTF-8&quot;
    [junit] NOTE: test params are: codec=Lucene3x, sim=RandomSimilarityProvider(queryNorm=true,coord=false): {}, locale=ro, timezone=Asia/Thimphu
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestStressNRT]
    [junit] NOTE: Linux 2.6.31-23-generic amd64/Sun Microsystems Inc. 1.6.0_24 (64-bit)/cpus=2,threads=1,free=192293192,total=256966656
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: test(org.apache.lucene.index.TestStressNRT):	Caused an ERROR
    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_47.frq=1, _47.tis=1, _47.fdx=1, _47.fdt=1}
    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_47.frq=1, _47.tis=1, _47.fdx=1, _47.fdt=1}
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:555)
    [junit] 	at org.apache.lucene.index.TestStressNRT.test(TestStressNRT.java:385)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$SubclassSetupTeardownRule$1.evaluate(LuceneTestCase.java:743)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$InternalSetupTeardownRule$1.evaluate(LuceneTestCase.java:639)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$TestResultInterceptorRule$1.evaluate(LuceneTestCase.java:538)
    [junit] 	at org.apache.lucene.util.LuceneTestCase$RememberThreadRule$1.evaluate(LuceneTestCase.java:600)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:164)
    [junit] 	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:57)
    [junit] 	at org.apache.lucene.util.StoreClassNameRule$1.evaluate(StoreClassNameRule.java:21)
    [junit] 	at org.apache.lucene.util.SystemPropertiesInvariantRule$1.evaluate(SystemPropertiesInvariantRule.java:22)
    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput: _47.tis
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.addFileHandle(MockDirectoryWrapper.java:479)
    [junit] 	at org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:504)
    [junit] 	at org.apache.lucene.codecs.lucene3x.TermInfosReader.&amp;lt;init&amp;gt;(TermInfosReader.java:112)
    [junit] 	at org.apache.lucene.codecs.lucene3x.Lucene3xFields.&amp;lt;init&amp;gt;(Lucene3xFields.java:84)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat$1.&amp;lt;init&amp;gt;(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.codecs.lucene3x.PreFlexRWPostingsFormat.fieldsProducer(PreFlexRWPostingsFormat.java:51)
    [junit] 	at org.apache.lucene.index.SegmentCoreReaders.&amp;lt;init&amp;gt;(SegmentCoreReaders.java:108)
    [junit] 	at org.apache.lucene.index.SegmentReader.&amp;lt;init&amp;gt;(SegmentReader.java:51)
    [junit] 	at org.apache.lucene.index.IndexWriter$ReadersAndLiveDocs.getMergeReader(IndexWriter.java:521)
    [junit] 	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3587)
    [junit] 	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
    [junit] 	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
    [junit] 
    [junit] 
    [junit] Test org.apache.lucene.index.TestStressNRT FAILED

BUILD FAILED
/home/hossman/lucene/dev/lucene/build.xml:43: The following error occurred while executing this line:
/home/hossman/lucene/dev/lucene/common-build.xml:688: The following error occurred while executing this line:
/home/hossman/lucene/dev/lucene/common-build.xml:677: Tests failed!

Total time: 8 seconds
TOTAL LOOPS: 52
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13225517" author="dweiss" created="Thu, 8 Mar 2012 21:11:01 +0000"  >&lt;p&gt;Mike, would it help if we dumped a linear sequence of each thread&apos;s ops on indexwriter/ segmentinfos, whatever else? If you can tell me which classes and methods would be of interest then I can provide such dumps with relative ease (using an aspect or even hardcoded printlns).&lt;/p&gt;

&lt;p&gt;Alternatively, can you express certain assertions that should always hold wrt multi-threaded access? I mean something that I could try to weave into the code so that we can catch an abnormal interaction pattern while it&apos;s happening (as opposed just seing the result)?&lt;/p&gt;</comment>
                    <comment id="13226393" author="mikemccand" created="Fri, 9 Mar 2012 20:11:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Mike, would it help if we dumped a linear sequence of each thread&apos;s ops on indexwriter/ segmentinfos, whatever else?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks Dawid!&lt;/p&gt;

&lt;p&gt;I actually know the root cause here:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Uncaught exception by thread: Thread[Lucene Merge Thread #72,6,main]
org.apache.lucene.index.MergePolicy$MergeException: java.lang.AssertionError
	at org.apache.lucene.index.ConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler.java:509)
	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:480)
Caused by: java.lang.AssertionError
	at org.apache.lucene.index.IndexWriter.commitMergedDeletes(IndexWriter.java:3028)
	at org.apache.lucene.index.IndexWriter.commitMerge(IndexWriter.java:3137)
	at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:3718)
	at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3257)
	at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:382)
	at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:451)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After that assert trips all kinds of crazy other exceptions can happen (not-closed files, not-live SegmentInfo, etc.).&lt;/p&gt;

&lt;p&gt;After the merge finishes, which can take a long time, in commitMergedDeletes we revisit each segment so we can &quot;carry forward&quot; any new deletions recorded against that segment, to the newly merged segment.  In an active NRT app there can be many deletes to carry forward...&lt;/p&gt;

&lt;p&gt;That tripped assert was to verify the ReadersAndLiveDocs (RLD) was still present in IW&apos;s ReaderPool; it&apos;s supposed to remain present throughout merging because we had incRef&apos;d the SegmentReader we opened for merging.&lt;/p&gt;

&lt;p&gt;But, it can in fact be dropped (the bug here) by another thread opening a reader and applying deletes and decRef&apos;ing the reader all after the merge thread 1) acquired the RLD but 2) before it opened the mergeReader from it.&lt;/p&gt;

&lt;p&gt;I (accidentally!!) caused this with &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3631&quot; title=&quot;Remove write access from SegmentReader and possibly move to separate class or IndexWriter/BufferedDeletes/...&quot;&gt;&lt;del&gt;LUCENE-3631&lt;/del&gt;&lt;/a&gt;, where we moved writeable deletes from SegmentReader into IndexWriter.  I suspect we need to add a separate refCount to RLD to fix this... I&apos;m working on that.&lt;/p&gt;</comment>
                    <comment id="13227045" author="mikemccand" created="Sun, 11 Mar 2012 13:29:48 +0000"  >&lt;p&gt;Patch, fixing the issue.  I think it&apos;s ready...&lt;/p&gt;

&lt;p&gt;Basically I added a refCount to ReadersAndLiveDocs, and&lt;br/&gt;
incRef/decRef&apos;d in the right places.  I also pulled out&lt;br/&gt;
ReadersAndLiveDocs to its own source, and tried to simplify&lt;br/&gt;
it a bit (separate method calls to dropChanges,&lt;br/&gt;
drop, release).&lt;/p&gt;</comment>
                    <comment id="13227058" author="rcmuir" created="Sun, 11 Mar 2012 14:40:23 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I also pulled out&lt;br/&gt;
ReadersAndLiveDocs to its own source&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="13227358" author="dweiss" created="Mon, 12 Mar 2012 08:02:58 +0000"  >&lt;p&gt;I&apos;m no longer able to reproduce this with the patch applied. I think this should be committed in as soon as possible?&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12517594" name="hoss-r1298470-fixed-seed__TEST-org.apache.lucene.index.TestStressNRT.xml" size="18073" author="hossman" created="Thu, 8 Mar 2012 19:15:11 +0000" />
                    <attachment id="12517887" name="LUCENE-3855.patch" size="43906" author="mikemccand" created="Sun, 11 Mar 2012 13:29:48 +0000" />
                    <attachment id="12517389" name="output1.log" size="4660" author="dweiss" created="Wed, 7 Mar 2012 12:37:38 +0000" />
                    <attachment id="12517390" name="output2.log" size="4760" author="dweiss" created="Wed, 7 Mar 2012 12:37:38 +0000" />
                    <attachment id="12517391" name="output3.log" size="4808" author="dweiss" created="Wed, 7 Mar 2012 12:37:38 +0000" />
                    <attachment id="12517392" name="output4.log" size="5661" author="dweiss" created="Wed, 7 Mar 2012 12:37:38 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 7 Mar 2012 11:45:43 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>230670</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>23846</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>