<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:11:10 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-481/LUCENE-481.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-481] IndexReader.getCurrentVersion() and isCurrent should use commit lock.</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-481</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;There is a race condition if one machine is checking the current version of an index while another wants to update the segments file in IndexWriter.close().&lt;/p&gt;

&lt;p&gt;java.io.IOException: Cannot delete segments&lt;br/&gt;
	at org.apache.lucene.store.FSDirectory.renameFile(FSDirectory.java:213)&lt;br/&gt;
	at org.apache.lucene.index.SegmentInfos.write(SegmentInfos.java:90)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter$3.doBody(IndexWriter.java:503)&lt;br/&gt;
	at org.apache.lucene.store.Lock$With.run(Lock.java:109)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.mergeSegments(IndexWriter.java:501)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.flushRamSegments(IndexWriter.java:440)&lt;br/&gt;
	at org.apache.lucene.index.IndexWriter.close(IndexWriter.java:242)&lt;/p&gt;

&lt;p&gt;On the windows platform reading the contents of a file disallows deleting the file.&lt;/p&gt;

&lt;p&gt;I use Lucene to maintain an index of +-700.000 documents, one server adds documents, while other servers handle the searches.&lt;br/&gt;
The search servers poll the index version regularly to check if they have to reopen their IndexSearcher.&lt;br/&gt;
Once in a while (about once every two days on average), IndexWriter.close() fails because it cannot delete the previous segments file, even though it hold the commit lock.&lt;br/&gt;
The reason is probably that search servers are reading the segments file to check the version without using the commit lock.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows platform, all Lucene versions&lt;/p&gt;</environment>
            <key id="12326920">LUCENE-481</key>
            <summary>IndexReader.getCurrentVersion() and isCurrent should use commit lock.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="lvl">Luc Vanlerberghe</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Dec 2005 20:10:06 +0000</created>
                <updated>Thu, 2 Jun 2011 23:03:41 +0100</updated>
                    <resolved>Fri, 23 Dec 2005 11:40:36 +0000</resolved>
                                            <fixVersion>1.9</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12361120" author="lvl" created="Fri, 23 Dec 2005 01:35:36 +0000"  >&lt;p&gt;This should fix the problem.&lt;/p&gt;

&lt;p&gt;I didn&apos;t use the Lock.With helper class to avoid having to wrap the long or boolean result in a Long or Boolean first.&lt;br/&gt;
The try ... finally block should be at least as clear to read as the Lock.With construct in this case...&lt;/p&gt;

&lt;p&gt;The problem is not limited to Windows Platforms:&lt;br/&gt;
The search servers also threw &quot;java.io.FileNotFoundException: ...\segments (The system cannot find the file specified)&quot; once every few days....&lt;/p&gt;

&lt;p&gt;This is because the new segments data is first written to the file &quot;segments.new&quot; which is then renamed to &quot;segments&quot;.&lt;br/&gt;
The javadoc for Directory says renameTo() should be atomic, but the current implementation in FSDirectory isn&apos;t.&lt;br/&gt;
If the searcher happens to try to read the segments file in the (admittedly very small) time between the &quot;nu.delete()&quot; and the &quot;old.renameTo(nu)&quot; it gets the FileNotFoundException&lt;/p&gt;</comment>
                    <comment id="12361159" author="yseeley@gmail.com" created="Fri, 23 Dec 2005 11:40:36 +0000"  >&lt;p&gt;Thanks Luc, i&apos;ve commited this!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12321525" name="LUCENE-481.patch" size="1685" author="lvl" created="Fri, 23 Dec 2005 01:35:36 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 23 Dec 2005 11:40:36 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>13268</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>27250</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>