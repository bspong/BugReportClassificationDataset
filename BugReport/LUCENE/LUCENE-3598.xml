<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:11:08 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3598/LUCENE-3598.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3598] Improve InfoStream class in trunk to be more consistent with logging-frameworks like slf4j/log4j/commons-logging</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3598</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Followup on a &lt;a href=&quot;http://lucene.472066.n3.nabble.com/IndexWriter-infoStream-is-final-td3537485.html&quot; class=&quot;external-link&quot;&gt;thread by Shai Erea on java-dev@lao&lt;/a&gt;: I already discussed with Robert about that, that there is one thing missing. Currently the IW only checks if the infoStream!=null and then passes the message to the method, and that &lt;b&gt;may&lt;/b&gt; ignore it. For your requirement it is the case that this is enabled or disabled dynamically. Unfortunately if the construction of the message is heavy, then this wastes resources.&lt;/p&gt;

&lt;p&gt;I would like to add another method to this class: abstract boolean isEnabled() that can also be implemented. I would then replace all null checks in IW by this method. The default config in IW would be changed to use a NoOutputInfoStream that returns false here and ignores the message.&lt;/p&gt;

&lt;p&gt;A simple logger wrapper for e.g. log4j / slf4j then could look like (ignoring component, could be enabled):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Loger log = YourLoggingFramework.getLogger(IndexWriter.class);

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void message(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; component, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; message) {
  log.debug(component + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt; + message);
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEnabled(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; component) {
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; log.isDebugEnabled();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using this you could enable/disable logging live by e.g. the log4j management console of your app server by enabling/disabling IndexWriter.class logging.&lt;/p&gt;

&lt;p&gt;The changes are really simple:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;PrintStreamInfoStream returns true, always, mabye make it dynamically enable/disable to allow Shai&apos;s request&lt;/li&gt;
	&lt;li&gt;infoStream.getDefault() is never null and can never be set to null. Instead the default is a singleton NoOutputInfoStream that returns false of isEnabled(component).&lt;/li&gt;
	&lt;li&gt;All null checks on infoStream should be replaced by infoStream.isEanbled(component), this is possible as always != null. There are no slowdowns by this - it&apos;s like Collections.emptyList() instead stupid null checks.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
            <key id="12532781">LUCENE-3598</key>
            <summary>Improve InfoStream class in trunk to be more consistent with logging-frameworks like slf4j/log4j/commons-logging</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 Nov 2011 10:08:49 +0000</created>
                <updated>Fri, 10 May 2013 11:44:52 +0100</updated>
                    <resolved>Tue, 20 Dec 2011 13:45:24 +0000</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13157452" author="thetaphi" created="Sat, 26 Nov 2011 12:33:05 +0000"  >&lt;p&gt;Here a first patch to show the API.&lt;/p&gt;

&lt;p&gt;The current patch misses to replace all &quot;if (infoStream != null)&quot; by &quot;if (infoStream.isEnabled())&quot;, so it of course slows down indexing because all messages are passed to the no-longer-null InfoStream&lt;/p&gt;

&lt;p&gt;I also have to check for other components using InfoStream except IndexWriter to add null checks with IAE.&lt;/p&gt;</comment>
                    <comment id="13157454" author="thetaphi" created="Sat, 26 Nov 2011 12:34:34 +0000"  >&lt;p&gt;Update method name in description.&lt;/p&gt;</comment>
                    <comment id="13157457" author="rcmuir" created="Sat, 26 Nov 2011 12:40:57 +0000"  >&lt;p&gt;I agree with the plan here &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(once we are sure all != null checks have been eliminated!)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Just as an aside we may want to cut over other classes like CheckIndex and SegmentInfos to use this class too eventually, just for consistency. I think currently these still take PrintStreams.&lt;/p&gt;</comment>
                    <comment id="13157475" author="thetaphi" created="Sat, 26 Nov 2011 13:21:20 +0000"  >&lt;p&gt;This just moves the implementation-specific messageID to the PrintStream impl&lt;/p&gt;</comment>
                    <comment id="13157701" author="shaie" created="Sun, 27 Nov 2011 08:39:09 +0000"  >&lt;p&gt;Why do I have a feeling like we&apos;re reinventing a logging framework? In the past, I&apos;ve suggested that we use either JDK logging (simplest) and some have suggested SLF4J. Why don&apos;t we reconsider this again, removing InfoStream entirely? This will allow better logging control of Lucene modules and remove a whole lot of API to pass the InfoStream down to every class that we&apos;ll want to log debug messages.&lt;/p&gt;

&lt;p&gt;We can still include a Logger only for the classes that accept InfoStream today, but we won&apos;t need the setInfoStream() API + one will be able to turn on logging for just, say, DocumentsWriter.&lt;/p&gt;</comment>
                    <comment id="13157901" author="rcmuir" created="Sun, 27 Nov 2011 13:36:27 +0000"  >&lt;p&gt;We don&apos;t need logging for infostream.&lt;/p&gt;

&lt;p&gt;Most of the time someone just wants a simple configuration to dump to a file or they are &lt;br/&gt;
a developer that wants to dump to stdout for a test.&lt;/p&gt;

&lt;p&gt;Please, lets not make this difficult for the 0.000001% of users with some complex use case.&lt;/p&gt;</comment>
                    <comment id="13157902" author="thetaphi" created="Sun, 27 Nov 2011 13:54:28 +0000"  >&lt;p&gt;Ideally this InfoStream should be an simple 2 method interface, not even an abstract class.&lt;/p&gt;</comment>
                    <comment id="13157949" author="thetaphi" created="Sun, 27 Nov 2011 18:09:13 +0000"  >&lt;p&gt;Patch that replaces all infoStream != null occurences and renmoves checks where not needed (e.g. only message with static string).&lt;br/&gt;
Somme comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removed IndexWriter.verbose()&lt;/li&gt;
	&lt;li&gt;MergePolicy code should be cleaned up and all stupid verbos() calls removed. Instead the logging should be implemented one level higher (MergePolicy abstract class)&lt;/li&gt;
	&lt;li&gt;DocState still has a strange PrintStream&lt;/li&gt;
	&lt;li&gt;same with different other classes, they should move to InfoStream&lt;/li&gt;
	&lt;li&gt;IndexFileDeleter requires InfoStream, for now I made a noncommit in DirectoryReader, which instantiates with InfoStream.NO_OUTPUT - this should maybe use the default?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13157966" author="thetaphi" created="Sun, 27 Nov 2011 18:48:48 +0000"  >&lt;p&gt;Fix also SolrIndexWriter: remove TimeLoggingPrintStream: the default PrintStreamInfoStream of Lucene logs with data/time.&lt;br/&gt;
Maybe add in the future the option to add all infoStream messages to the standard Solr SLF4J log as DEBUG/TRACE (only if really enabled - log.isDebugEnabled(SolrIndexWriter.class), so no synchronized logging shit occurs).&lt;/p&gt;</comment>
                    <comment id="13158171" author="shaie" created="Mon, 28 Nov 2011 04:30:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;Please, lets not make this difficult for the 0.000001% of users with some complex use case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that the InfoStream solution is complex, and not vice versa. But that&apos;s just my opinion. And besides, not all of our code is consistent on the use of InfoStream. For instance, the facet module uses JDK logging (it came with it) in various classes. Do you suggest that we remove it and add setInfoStream API to all the classes that want to output logging info? I wouldn&apos;t want to do that ...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Most of the time someone just wants a simple configuration to dump to a file ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that&apos;s the whole idea behind logging. It&apos;s just that today we force an &quot;all or nothing&quot; behavior for the code. Perhaps with the new InfoStream class (with its &apos;component&apos; argument) this will be improved.&lt;/p&gt;</comment>
                    <comment id="13158229" author="rcmuir" created="Mon, 28 Nov 2011 06:43:04 +0000"  >&lt;p&gt;My problem is this isn&apos;t logging but debugging. And since we are a library, we don&apos;t need to enforce logging on anyone.&lt;/p&gt;

&lt;p&gt;Otherwise we have to deal with overcomplicated logging frameworks, and people will start opening issues about what is/isn&apos;t logged.&lt;br/&gt;
I don&apos;t think lucene should be responsible for logging, we should just leave that to the users to implement their own logging.&lt;/p&gt;

&lt;p&gt;Infostream is just an internal thing for debugging and testing, and we already have it hooked nicely into the tests now&lt;br/&gt;
(note: since fixing this stuff I removed all the if (VERBOSE) setInfoStream... across tons of tests and added &lt;br/&gt;
-Dtests.infostream to control it across the board, set automatically by tests.verbose but can be controlled separately)&lt;/p&gt;

&lt;p&gt;But this being said, I am for uwe&apos;s improvement because it makes it possible for someone to turn on/off infostream &quot;live&quot; themselves,&lt;br/&gt;
without taking any performance hit from the calculations if they have it disabled, and they are responsible for their own &lt;br/&gt;
implementation (if they want to make stuff volatile or synced, good for them). The complexity is all out of indexwriter&apos;s &lt;br/&gt;
classes to manage this &quot;liveness&quot;, and that was the whole reason for s/printstream/infostream/ in the first place.&lt;/p&gt;</comment>
                    <comment id="13158697" author="hossman" created="Mon, 28 Nov 2011 19:59:13 +0000"  >&lt;p&gt;From a practical usage standpoint, i think it makes a lot more sense to add minor enhancements to the &quot;infoStream&quot; concept then it would to start using JUL or SLF4J (or any other logging API) in the core Lucene code.&lt;/p&gt;

&lt;p&gt;with infoStream, the default assumption has always been (and with this patch: seems to continue to be) that you want &quot;fast&quot; production code w/o the overhead of debugging info.  the client app has to go out of the way to turn on the debugging info from lucene, recognizing that that may slow things down.&lt;/p&gt;

&lt;p&gt;I don&apos;t know of any logging API we could use where that default assumption would remain the status quo &amp;#8211; JUL, JCL, L4J, SLF4J, etc... if we switched to using any of those the burden would be on client libraries to actively disable messages coming from Lucene either by adding a logging config file, or by updating their existing logging config file, or adding a NOOP SLF4J impl, etc... (even JCL defaults to writting to System.err instead of being a NOOP!)&lt;/p&gt;

&lt;p&gt;So lets keep simple/common things simple/common/fast &amp;#8211; and people who want to hook into a logging framework can do that.&lt;/p&gt;

&lt;p&gt;Hell: since JUL is guaranteed to be implemented by all JVMs, and since we already have the Jar for the SLF4J API in the build system for Solr, it would be trivial to offer out of the box JUL and SLF4J backed implementations of the InfoStream API to make it &lt;b&gt;really&lt;/b&gt; trivial for client apps to use them&lt;/p&gt;</comment>
                    <comment id="13160724" author="thetaphi" created="Thu, 1 Dec 2011 08:26:36 +0000"  >&lt;p&gt;@Hoss: Good idea, we can create JUL+SLF4J impls under contrib/misc with a compile-time dependency to SLF4J.&lt;/p&gt;

&lt;p&gt;I think the current patch is fine so I can commit it before it gets outdated? We can improve logging later by adding more classes using InfoStream but thats out of the scope of this issue.&lt;/p&gt;</comment>
                    <comment id="13160884" author="thetaphi" created="Thu, 1 Dec 2011 12:52:55 +0000"  >&lt;p&gt;Committed trunk revision: 1209059&lt;/p&gt;

&lt;p&gt;For improvements like JUL/SLF4J convenience impl I will open other issues.&lt;/p&gt;</comment>
                    <comment id="13161821" author="mikemccand" created="Fri, 2 Dec 2011 19:59:02 +0000"  >&lt;p&gt;I noticed a few accidental changes here (lost an important !success);&lt;br/&gt;
I fixed those (rev 1209663), but while fixing them I noticed.... we&lt;br/&gt;
are inconsistent on when we call infoStream.isEnabled?  Sometimes we&lt;br/&gt;
call it, sometimes we don&apos;t.&lt;/p&gt;

&lt;p&gt;I think we should always call it?  I don&apos;t like that there&apos;s a sudden&lt;br/&gt;
inconsistency (it was consistent before), and that now present &amp;amp;&lt;br/&gt;
future coders working on our code must now wonder/think about when to&lt;br/&gt;
check and when not to.  I think the rule should be very simple:&lt;br/&gt;
always call .isEnabled.&lt;/p&gt;

&lt;p&gt;And I don&apos;t think we should assume it&apos;s &quot;cheap&quot; to always call&lt;br/&gt;
infoStream.message (ie, even when it&apos;s a single static string); the&lt;br/&gt;
logger could somehow be costly, and had implemented isEnabled exactly&lt;br/&gt;
for this reason (so that it&apos;s &quot;free&quot; to have a costly&lt;br/&gt;
message impl, eg maybe sync&apos;d or something).&lt;/p&gt;

&lt;p&gt;Once we fix this... then we can easily test for it by having&lt;br/&gt;
NullInfoStream validate it&apos;s never called when it wasn&apos;t enabled.&lt;/p&gt;</comment>
                    <comment id="13161853" author="thetaphi" created="Fri, 2 Dec 2011 21:04:31 +0000"  >&lt;p&gt;Hi Mike,&lt;br/&gt;
sorry for the (!sucess) bugs, I have seen the patch.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I think we should always call it? I don&apos;t like that there&apos;s a sudden&lt;br/&gt;
inconsistency (it was consistent before), and that now present &amp;amp;&lt;br/&gt;
future coders working on our code must now wonder/think about when to&lt;br/&gt;
check and when not to. I think the rule should be very simple:&lt;br/&gt;
always call .isEnabled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The idea behind InfoStream interface was to mimic logging frameworks, which accept calls to the log methods always. Only if the string creation is expensive, you may call isXxxEnabled().&lt;/p&gt;

&lt;p&gt;But I have no preference, if you like change it to require a call to isEnabled, do it. NullInfoStream has isEnabled() returning true (as we use it to actually test that all logging code actually works). But the singleton implementation InfoStream.NO_OUTPUT (the default setting) returns false in isEnabled() so you can add an &quot;assert false&quot; in its message() method.&lt;/p&gt;

&lt;p&gt;Did you once again go through the patch I committed and checked, trat no other bugs were introduced?&lt;/p&gt;</comment>
                    <comment id="13166940" author="mikemccand" created="Sat, 10 Dec 2011 18:55:38 +0000"  >&lt;p&gt;Patch, always calling .isEnabled before .message, and adding a new test-only AlwaysDisabledInfoStream, swapped in randomly 1/3rd of the time, that returns false always from isEnabled and then asserts false in its message() method.&lt;/p&gt;</comment>
                    <comment id="13166941" author="thetaphi" created="Sat, 10 Dec 2011 18:58:37 +0000"  >&lt;p&gt;Mike, you dont need the AlwaysDisabledIS.&lt;/p&gt;

&lt;p&gt;Just add the assert in InfoStream.NO_OUTPUT &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13166961" author="mikemccand" created="Sat, 10 Dec 2011 19:51:51 +0000"  >&lt;p&gt;Aha!  Excellent... I&apos;ll do that.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12506860" name="LUCENE-3598.patch" size="37631" author="mikemccand" created="Sat, 10 Dec 2011 18:55:38 +0000" />
                    <attachment id="12505258" name="LUCENE-3598.patch" size="64072" author="thetaphi" created="Sun, 27 Nov 2011 18:48:48 +0000" />
                    <attachment id="12505257" name="LUCENE-3598.patch" size="62594" author="thetaphi" created="Sun, 27 Nov 2011 18:09:12 +0000" />
                    <attachment id="12505195" name="LUCENE-3598.patch" size="8417" author="thetaphi" created="Sat, 26 Nov 2011 13:21:20 +0000" />
                    <attachment id="12505192" name="LUCENE-3598.patch" size="7580" author="thetaphi" created="Sat, 26 Nov 2011 12:33:05 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 26 Nov 2011 12:40:57 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>218515</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24099</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>