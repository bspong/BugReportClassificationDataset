<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:08:37 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2883/LUCENE-2883.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2883] Consolidate Solr  &amp; Lucene FunctionQuery into modules</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2883</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Spin-off from the &lt;a href=&quot;http://www.mail-archive.com/dev@lucene.apache.org/msg13261.html&quot; class=&quot;external-link&quot;&gt;dev list &lt;/a&gt;  &lt;/p&gt;</description>
                <environment></environment>
            <key id="12496516">LUCENE-2883</key>
            <summary>Consolidate Solr  &amp; Lucene FunctionQuery into modules</summary>
                <type id="3" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/task.png">Task</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="cmale">Chris Male</assignee>
                                <reporter username="simonw">Simon Willnauer</reporter>
                        <labels>
                        <label>gsoc2011</label>
                        <label>lucene-gsoc-11</label>
                        <label>mentor</label>
                    </labels>
                <created>Mon, 24 Jan 2011 10:34:28 +0000</created>
                <updated>Fri, 10 May 2013 11:44:25 +0100</updated>
                    <resolved>Fri, 1 Jul 2011 00:31:03 +0100</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>3</watches>
                                                                                  <comments>
                    <comment id="12986502" author="yseeley@gmail.com" created="Tue, 25 Jan 2011 16:30:25 +0000"  >&lt;p&gt;One issue here is the different purposes for lucene and solr function queries.&lt;br/&gt;
Solr&apos;s function queries have always evolved at a rapid pace (and are continuing to evolve) to support higher level features and interfaces in Solr.  They are able to evolve rapidly because they are seen more as an implementation detail rather than interface classes, and I&apos;d hate to lose that.  So if we do try to make Solr&apos;s function queries more accessible to lucene users (again), it should be as a Solr module.  As we can see from history and usage, function queries are critically important to Solr, but are obviously not to Lucene.&lt;/p&gt;</comment>
                    <comment id="12986529" author="simonw" created="Tue, 25 Jan 2011 17:23:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;One issue here is the different purposes for lucene and solr function queries.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yonik, if that is your only issue then we are good to go. I don&apos;t think that moving stuff to modules changes anything how we develop software. Modularization, decoupling, interfaces etc. you know how to work with those ey? so hey what is really the point here, this modularization is a key point of merging development with lucene and everytime somebody proposes something like this you fear that that monolithic thing under /solr could become more modular and decoupled. I don&apos;t know why this is the case but we should and will move on with modularization. Folks will use it once its there, thats for sure. Same is true for faceting, replication, queryparsers, functionparser... those are on the list!&lt;/p&gt;</comment>
                    <comment id="12986558" author="mikemccand" created="Tue, 25 Jan 2011 18:04:25 +0000"  >&lt;p&gt;Can&apos;t we consolidate them under a new toplevel module?  modules/queries?&lt;/p&gt;

&lt;p&gt;We can mark the classes as lucene.experimental?  Then we are free to iterate quickly.  Does that address your concern Yonik?&lt;/p&gt;</comment>
                    <comment id="12986561" author="yseeley@gmail.com" created="Tue, 25 Jan 2011 18:08:07 +0000"  >&lt;p&gt;Not sure if I communicated the issue clearly: taking what is essentially implementation and trying to make it interface clearly has a cost.&lt;br/&gt;
Function queries and the solr qparser architecture are constantly evolving, and wind all through solr.&lt;/p&gt;

&lt;p&gt;If we attempt to make this easier to use by lucene users by moving it out to a module then:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it should be a solr module... keep the solr package names and make it clear that it&apos;s primary purpose is supporting higher level features in solr&lt;/li&gt;
	&lt;li&gt;we should make it such that java interface back compatibility is not a requirement, even for point releases&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The other approach is to make a Lucene function query module (actually, we already have that), try to update it with stuff from solr, but make it&apos;s primary purpose to support the Java interfaces.&lt;/p&gt;</comment>
                    <comment id="12986569" author="rcmuir" created="Tue, 25 Jan 2011 18:13:56 +0000"  >&lt;p&gt;Wait, why again did we merge lucene and solr? This is crazy-talk.&lt;/p&gt;

&lt;p&gt;I don&apos;t see a single valid reason why queries should be in solr-only.&lt;/p&gt;</comment>
                    <comment id="12986571" author="yseeley@gmail.com" created="Tue, 25 Jan 2011 18:14:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;We can mark the classes as lucene.experimental?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If they remain experimental I suppose, but lucene.internal would be a more accurate description.&lt;/p&gt;</comment>
                    <comment id="12986871" author="simonw" created="Wed, 26 Jan 2011 07:15:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can&apos;t we consolidate them under a new toplevel module? modules/queries?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was the entire plan for this issue. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it should be a solr module... keep the solr package names and make it clear that it&apos;s primary purpose is supporting higher level features in solr&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Are you serious? If you need to change something or make additions to such an interface / abstract class or whatever you should be able to do this. But I am totally against it if you say this is you internal playground and If I decide to change it entirely I will do so. I start getting the impression that this anti-modularization thing has nothing todo with code and development.. Lots of software has been evolving even with bwcompat etc. but hey this is not core - deprecation and changes should not be super hard to do and we always decided case by case. if it was easy / doable with bw compat we did it - if not we broke it so what it the big deal again? Seriously, I don&apos;t want to have this discussion everything somebody comes up with a /modules suggestion - the is the way to go, we agreed and voted on it and it passed.  &lt;/p&gt;</comment>
                    <comment id="12987096" author="michaelbusch" created="Wed, 26 Jan 2011 17:16:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Seriously, I don&apos;t want to have this discussion everything somebody comes up with a /modules suggestion - the is the way to go, we agreed and voted on it and it passed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1.  I agree with Simon and Robert.  &lt;/p&gt;</comment>
                    <comment id="12987119" author="markrmiller@gmail.com" created="Wed, 26 Jan 2011 17:57:49 +0000"  >&lt;p&gt;I&apos;m trying to follow this thread. If I extract the somewhat off topic bitterness I seem to see:&lt;/p&gt;

&lt;p&gt;1. There is interest in trying to unify function queries again.&lt;/p&gt;

&lt;p&gt;2. There is a concern - currently the Solr function queries are part of Solr - java code in Solr is changed on a whim. In Lucene, the bar is higher - java code is generally considered an impl detail in Solr, unless it&apos;s a plugin api. This has been an attractive quality in the past. Moving it to Lucene changes it to more of a supported API. Valid point if you ask me.&lt;/p&gt;

&lt;p&gt;3. A response was made about marking it experimental.&lt;/p&gt;

&lt;p&gt;4. A response was made about perhaps internal.&lt;/p&gt;

&lt;p&gt;The rest does not add much. We have not voted on this issue - we voted on broad topics - to be sorted out as we go. Lets discuss it for a bit before everyone just gets pissed off.&lt;/p&gt;</comment>
                    <comment id="12987146" author="yseeley@gmail.com" created="Wed, 26 Jan 2011 18:33:34 +0000"  >&lt;p&gt;One concern some people have had is that lucene not become too tailored just for solr - a very valid point, and I&apos;ve tried hard not to add anything to lucene that&apos;s solr specific or that only solr would benefit from.  Nevertheless, there have been a number of occasions (normally on IRC) where there has been disagreement/debate and I&apos;ve had statements of the form &quot;solr&apos;s not the only lucene user you know&quot; type of arguments thrown up.&lt;/p&gt;

&lt;p&gt;I&apos;m not against modularizing some solr functionality so lucene users can use it, but hopefully you understand why I think it should retain the solr package namespace and be a solr module (or at a minimum perhaps a lucene/solr module).  It just wouldn&apos;t be fair to downgrade solr support for such a large core piece of solr, and have people cry foul when something is added that only solr can benefit from (as is done fairly regularly today since it&apos;s just part of solr).&lt;/p&gt;</comment>
                    <comment id="12987162" author="simonw" created="Wed, 26 Jan 2011 18:52:41 +0000"  >&lt;blockquote&gt;

&lt;p&gt;I&apos;m not against modularizing some solr functionality so lucene users can use it, but hopefully you understand why I think it should retain the solr package namespace and be a solr module (or at a minimum perhaps a lucene/solr module). It just wouldn&apos;t be fair to downgrade solr support for such a large core piece of solr, and have people cry foul when something is added that only solr can benefit from (as is done fairly regularly today since it&apos;s just part of solr).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t give a sh.. about the package name -  /modules is shared space - some is more luceneish some is more solrish. I also think that bwcomap is not a super big deal with modules either. Why don&apos;t we get a proposal patch wise and see how that goes... Still - the concerns are super minor IMO and should not keep us from making progress on the modularization side of things.&lt;/p&gt;</comment>
                    <comment id="12987186" author="yseeley@gmail.com" created="Wed, 26 Jan 2011 19:47:04 +0000"  >&lt;p&gt;Let me try to recap my concerns here (2 main ones):&lt;br/&gt;
1) changing implementation to interface&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;a different back compat policy for the module (i.e. the java interfaces only) could partially address this.&lt;/li&gt;
	&lt;li&gt;marking as lucene.internal could mostly address, but that&apos;s prob not what direct module users would prefer.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;2) downgrading of solr support for this core piece of solr&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;making it a solr module (retaining the solr package naming, etc) should mostly handle this issue.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12987197" author="cmale" created="Wed, 26 Jan 2011 20:15:58 +0000"  >&lt;p&gt;Hey Yonik,&lt;/p&gt;

&lt;p&gt;I&apos;m just trying to understand what you mean by 2).  How is Solr&apos;s support of function queries downgraded if they dont have the Solr package name?  &lt;/p&gt;

&lt;p&gt;I can appreciate the need to be able to make changes easily but with function queries becoming so widely used in Solr, Solr users and probably Lucene users, I think having a stable interface is a good thing.&lt;/p&gt;</comment>
                    <comment id="12987204" author="yseeley@gmail.com" created="Wed, 26 Jan 2011 20:29:00 +0000"  >&lt;p&gt;Chris: #2 is just an attempted recap of this comment: &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2883?focusedCommentId=12987146&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12987146&quot; class=&quot;external-link&quot;&gt;https://issues.apache.org/jira/browse/LUCENE-2883?focusedCommentId=12987146&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12987146&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="12987207" author="cmale" created="Wed, 26 Jan 2011 20:38:08 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Hmm I don&apos;t really understand that part either.  You&apos;re concerned that you&apos;ll lose the freedom to add functionality that&apos;d benefit Solr only?&lt;/p&gt;</comment>
                    <comment id="12987262" author="simonw" created="Wed, 26 Jan 2011 22:28:58 +0000"  >&lt;p&gt;Really back in the days where stuff like that was moved to solr there was a good reason for duplicating the func - lucene was  on a totally different release schedule, bw. compat etc. But now since we are aligned with releases and we have the modules area there is really no good reason for stuff like that. If solr needs some feature in FuncQuery &amp;amp; friends we are going to add it. If we can fix it without breaking BWCompat we should do it - if not we discuss case by case! I have actually written some FuncQuery related code for customers and they would not be happy if we break bwcompat codewise (I exclude package naming here) - just saying that keeping it internal so that we can hack it as we like is not an option anyway!!&lt;/p&gt;

&lt;p&gt;just my $0.05&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="12987549" author="gsingers" created="Thu, 27 Jan 2011 13:23:03 +0000"  >&lt;p&gt;I think it makes sense to make function queries a module and expose them more to Lucene users for a number of reasons.&lt;/p&gt;

&lt;p&gt;First off, though, I get the concern about implementation detail versus interface, but I think the tradeoff is worth it for several reasons.  &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Function queries (FQs) already have a pretty stable interface and we have already worked hard to maintain BWC for them since they are one of the more common areas that people actually do extend in Solr.  In other words,  FQs are already more interface than implementation.&lt;/li&gt;
	&lt;li&gt;I&apos;ve always been stumped as to why more Lucene users don&apos;t use them and instead re-invent the wheel.  The fact that it has taken this long frankly mystifies me&lt;/li&gt;
	&lt;li&gt;As a corollary of that, more light on them will make them better, improve performance, etc.&lt;/li&gt;
	&lt;li&gt;I agree with most here that the ability to do this kind of thing is exactly why we merged.&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;Hmm I don&apos;t really understand that part either. You&apos;re concerned that you&apos;ll lose the freedom to add functionality that&apos;d benefit Solr only?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think that is the concern.  I think the concern is that if one only has to worry about implementation details and not about backwards compat, public API, etc. then it is a lot easier to innovate.  It&apos;s the equivalent of refactoring IndexWriter public methods versus the underlying DocumentsWriter.   Remember, in Solr, 99% of the public API is in the Request parameters, not in Java interface.  As long as we maintain BWC for the Request interface (i.e. &amp;amp;start=0&amp;amp;rows=10&amp;amp;q=foo), we are more or less free to do what we want in the implementation layer.  &lt;/p&gt;

&lt;p&gt;In the end, I&apos;m +1 on moving it, but with the distinction that changes in modules need to account for Solr as well as Lucene.&lt;/p&gt;</comment>
                    <comment id="12987550" author="simonw" created="Thu, 27 Jan 2011 13:32:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;Function queries (FQs) already have a pretty stable interface and we have already worked hard to maintain BWC for them since they are one of the more common areas that people actually do extend in Solr. In other words, FQs are already more interface than implementation.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;YES! +1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;As a corollary of that, more light on them will make them better, improve performance, etc.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;again +1&lt;/p&gt;

&lt;p&gt;I think we can maintain the interface and innovations side by side - that said, lets look at a patch and discuss further once we see code / moving paths etc.&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="12987557" author="rcmuir" created="Thu, 27 Jan 2011 13:39:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;but with the distinction that changes in modules need to account for Solr as well as Lucene.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought this was understood about modules anyway, that we move the code there, all committers&lt;br/&gt;
have access and its shared code to support both projects.&lt;/p&gt;

&lt;p&gt;hopefully we didnt screw this up in anyway for modules/analysis, I don&apos;t think Solr lost anything here.&lt;/p&gt;

&lt;p&gt;Separately, for the record, we didnt merge ALL of Solr&apos;s analysis stuff into modules/analysis.&lt;br/&gt;
Some of this stuff really is solr-specific (e.g. ReverseWildCard support that needs some schema + qp integration).&lt;br/&gt;
This really solr-specific stuff that isn&apos;t generally useful stayed in Solr.&lt;/p&gt;

&lt;p&gt;So I think we should always consider this for future modules, it doesn&apos;t have to be a binary decision,&lt;br/&gt;
but instead what is general and makes sense.&lt;/p&gt;</comment>
                    <comment id="12987582" author="gsingers" created="Thu, 27 Jan 2011 14:25:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;I thought this was understood about modules anyway, that we move the code there, all committers&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;have access and its shared code to support both projects.&lt;/p&gt;

&lt;p&gt;Cool.  I was just re-iterating it.  As such, I don&apos;t think it makes sense to mark it as lucene.internal, but experimental does make sense.&lt;/p&gt;</comment>
                    <comment id="12987589" author="mikemccand" created="Thu, 27 Jan 2011 14:44:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;As such, I don&apos;t think it makes sense to mark it as lucene.internal, but experimental does make sense.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                    <comment id="12987595" author="yseeley@gmail.com" created="Thu, 27 Jan 2011 15:07:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;hopefully we didnt screw this up in anyway for modules/analysis, I don&apos;t think Solr lost anything here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, modules/analysis never concerned me since the filters moved there were nice and self contained, they only already relied on the lucene analysis interfaces, would easy to make a solr-specific copy of one if really needed in the future, and left some of the solr specific stuff where it was.  It all made sense and was a win-win.&lt;/p&gt;

&lt;p&gt;We&apos;ve hung a lot of features on function queries in Solr, and I&apos;ve had plans for more to come - which is why it&apos;s not acceptable for it to suddenly not be a core part of Solr.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;its shared code to support both projects.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The &quot;status&quot; and expectations for the code are one of the big issues here - it&apos;s not just about the technical issues of what a patch looks like.  I would expect, for example, to be able to add a feature that probably only made sense for solr (as long as it didn&apos;t prevent lucene users from using function queries in general of course).  Is that acceptable to everyone?  I would not necessarily have the same expectation for other things in modules - it really depends on what it is.  Does that make sense?&lt;/p&gt;
</comment>
                    <comment id="12987604" author="gsingers" created="Thu, 27 Jan 2011 15:27:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does that make sense?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it does.  I think, as usual, it can be handled case by case.  Just as Robert pointed out, some analysis things stayed in Solr, I don&apos;t think anyone is going to argue that we should put things where they most make sense.  In general, though, I think the modules affords us a lot of opportunity through more exposure at the loss of a little bit of flexibility in Solr, which, as you said can still be handled by doing that little piece in just Solr.&lt;/p&gt;</comment>
                    <comment id="12987605" author="rcmuir" created="Thu, 27 Jan 2011 15:32:33 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The &quot;status&quot; and expectations for the code are one of the big issues here - it&apos;s not just about the technical issues of what a patch looks like. I would expect, for example, to be able to add a feature that probably only made sense for solr (as long as it didn&apos;t prevent lucene users from using function queries in general of course). Is that acceptable to everyone? I would not necessarily have the same expectation for other things in modules - it really depends on what it is. Does that make sense?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you have an example of what type of feature you are talking about? I think it would really clarify things.&lt;/p&gt;</comment>
                    <comment id="12987809" author="cmale" created="Thu, 27 Jan 2011 22:48:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would expect, for example, to be able to add a feature that probably only made sense for solr (as long as it didn&apos;t prevent lucene users from using function queries in general of course).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Does any of these features you allude to rely on stuff that thats in Solr core? This impacts the dependencies this module will have.&lt;/p&gt;</comment>
                    <comment id="13035330" author="cmale" created="Wed, 18 May 2011 13:06:18 +0100"  >&lt;p&gt;Patch that factors out the core FunctionQuery stuff into a queries module.  Theres alot of issues here but it does compile.  &lt;/p&gt;

&lt;p&gt;The following issues need to be addressed:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MutableValue &amp;amp; MutableFloatValue are used in the FunctionQuery code so I&apos;ve pulled them into the module too.  Should all the other Mutable*Value classes come too? Should they go into some other module?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;What to return in ValueSource#getSortField which currently returns a SortField which implements SolrSortField.  This is currently commented out so we can determine what best to do.  Having this commented out breaks the Solr tests.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Many of the ValueSources and DocValues in Solr could be moved to the module, but not all of them.  Some have dependencies on Solr dependencies / Solr core code.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Module isn&apos;t full integrated into the build.xmls and dev-tools.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Lucene core&apos;s FunctionQuery stuff needs to be removed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ll add a script that needs to be run before adding this patch shortly.&lt;/p&gt;</comment>
                    <comment id="13035331" author="cmale" created="Wed, 18 May 2011 13:06:56 +0100"  >&lt;p&gt;Script needed to run to use patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
svn mkdir --parents modules/queries/src/java/org/apache/lucene/queries/function
svn move solr/src/java/org/apache/solr/search/function/FunctionQuery.java modules/queries/src/java/org/apache/lucene/queries/function/FunctionQuery.java
svn move solr/src/java/org/apache/solr/search/function/ValueSource.java modules/queries/src/java/org/apache/lucene/queries/function/ValueSource.java
svn move solr/src/java/org/apache/solr/search/function/DocValues.java modules/queries/src/java/org/apache/lucene/queries/function/DocValues.java
svn move solr/src/java/org/apache/solr/search/MutableValue.java modules/queries/src/java/org/apache/lucene/queries/function/MutableValue.java
svn move solr/src/java/org/apache/solr/search/MutableValueFloat.java modules/queries/src/java/org/apache/lucene/queries/function/MutableValueFloat.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                    <comment id="13035508" author="mikemccand" created="Wed, 18 May 2011 18:37:11 +0100"  >&lt;p&gt;Thanks Chris!  The patch applies cleanly for me (after running the svn&lt;br/&gt;
commands) and everything compiles.&lt;/p&gt;

&lt;p&gt;I think the patch is a great start, ie, we will need the low level&lt;br/&gt;
infra used by FQs in the module.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;MutableValue &amp;amp; MutableFloatValue are used in the FunctionQuery code so I&apos;ve pulled them into the module too. Should all the other Mutable*Value classes come too? Should they go into some other module?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should move Mutable* over?  Grouping module will need all&lt;br/&gt;
of these, I think?  (Ie if we want to allow users to group by&lt;br/&gt;
arbitrary typed field).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What to return in ValueSource#getSortField which currently returns a SortField which implements SolrSortField. This is currently commented out so we can determine what best to do. Having this commented out breaks the Solr tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm good question.  This looks to be related to sorting by FQ&lt;br/&gt;
(&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1297&quot; title=&quot;Enable sorting by Function Query&quot;&gt;&lt;del&gt;SOLR-1297&lt;/del&gt;&lt;/a&gt;) because some FQs need to be weighted.  Not sure what to do&lt;br/&gt;
here yet... which FQs in particular require this?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Many of the ValueSources and DocValues in Solr could be moved to the module, but not all of them. Some have dependencies on Solr dependencies / Solr core code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think apply 90/10 rule here?  Start with the easy-to-move queries?&lt;br/&gt;
We don&apos;t need initial go to be perfect... progress not perfection.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Lucene core&apos;s FunctionQuery stuff needs to be removed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you have a sense of whether Solr&apos;s FQs are a superset of Lucene&apos;s?&lt;br/&gt;
Ie, is there anything Lucene&apos;s FQs can do that Solr&apos;s can&apos;t?&lt;/p&gt;

&lt;p&gt;Probably, as a separate issue, we should also move contrib/queries -&amp;gt;&lt;br/&gt;
modules/queries.  And I think the cool nested queries (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2454&quot; title=&quot;Nested Document query support&quot;&gt;&lt;del&gt;LUCENE-2454&lt;/del&gt;&lt;/a&gt;)&lt;br/&gt;
would also go into this module...&lt;/p&gt;</comment>
                    <comment id="13035967" author="cmale" created="Thu, 19 May 2011 04:33:49 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think we should move Mutable* over? Grouping module will need all of these, I think? (Ie if we want to allow users to group by arbitrary typed field).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yup okay.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Hmm good question. This looks to be related to sorting by FQ (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1297&quot; title=&quot;Enable sorting by Function Query&quot;&gt;&lt;del&gt;SOLR-1297&lt;/del&gt;&lt;/a&gt;) because some FQs need to be weighted. Not sure what to do here yet... which FQs in particular require this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Both all of them and not many of them (complicated).  The sorting of FQ&lt;br/&gt;
functionality is necessary for all FQs in Solr since the user can sort&lt;br/&gt;
by any FQ.  However the extension made by the SolrSortField is the ability&lt;br/&gt;
to create a &apos;weighted&apos; SortField by passing in a IndexSearcher and having&lt;br/&gt;
it stored in a Map.  The Map is then made available to any DocValues when&lt;br/&gt;
they create their values.  &lt;/p&gt;

&lt;p&gt;This is when the &apos;not many&apos; comes into effect.  Only a few DocValues implementations&lt;br/&gt;
use the contents of the Map.  DocFreqValueSource for example uses the IndexSearcher&lt;br/&gt;
in the Map.  But I suppose there could be many user implementations that do.&lt;/p&gt;

&lt;p&gt;SolrSortField is currently used in SolrIndexSearcher to &apos;weight&apos; the Sorts.  I wonder&lt;br/&gt;
whether we can simplify this? When ValueSource#getSort is called (which is only in 1&lt;br/&gt;
place really), we can pass in the IndexSearcher, meaning the SortField can be &apos;weighted&apos;&lt;br/&gt;
then and there.&lt;/p&gt;

&lt;p&gt;Since SolrSortField is only used in this 1 place currently, we can then revisit dropping it?&lt;/p&gt;

&lt;p&gt;Do you think its worth opening an issue to address this first?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think apply 90/10 rule here? Start with the easy-to-move queries? We don&apos;t need initial go to be perfect... progress not perfection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could we sort the initial commit out and then I can move them over in batches?&lt;br/&gt;
Already have a 108k patch, I&apos;d say moving what we can will push it towards 300k&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do you have a sense of whether Solr&apos;s FQs are a superset of Lucene&apos;s? Ie, is there anything Lucene&apos;s FQs can do that Solr&apos;s can&apos;t?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Solr FQs are hugely more advanced than the ValueSourceQuery based stuff in Lucene.&lt;br/&gt;
Its not a full 1 to 1 change since the APIs are slightly different, but I&apos;d say&lt;br/&gt;
that we&apos;d want users to use the FQ line of classes.  I cant see anything in Lucene&apos;s&lt;br/&gt;
VSQs that you couldn&apos;t do using FQs.&lt;/p&gt;</comment>
                    <comment id="13036479" author="mikemccand" created="Thu, 19 May 2011 22:22:48 +0100"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Hmm good question. This looks to be related to sorting by FQ (&lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-1297&quot; title=&quot;Enable sorting by Function Query&quot;&gt;&lt;del&gt;SOLR-1297&lt;/del&gt;&lt;/a&gt;) because some FQs need to be weighted. Not sure what to do here yet... which FQs in particular require this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Both all of them and not many of them (complicated). The sorting of FQ&lt;br/&gt;
functionality is necessary for all FQs in Solr since the user can sort&lt;br/&gt;
by any FQ. However the extension made by the SolrSortField is the ability&lt;br/&gt;
to create a &apos;weighted&apos; SortField by passing in a IndexSearcher and having&lt;br/&gt;
it stored in a Map. The Map is then made available to any DocValues when&lt;br/&gt;
they create their values.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So the goal here is to make the top-level searcher (IR) visible to the&lt;br/&gt;
FQ&apos;s getValues?  I think this pre-dated the cutover to&lt;br/&gt;
AtomicReaderContext, which now provides the top reader?  Maybe this&lt;br/&gt;
isn&apos;t needed anymore...?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This is when the &apos;not many&apos; comes into effect. Only a few DocValues implementations&lt;br/&gt;
use the contents of the Map. DocFreqValueSource for example uses the IndexSearcher&lt;br/&gt;
in the Map. But I suppose there could be many user implementations that do.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;EG DocFreqValueSource could pull docFreq from the top reader?&lt;/p&gt;

&lt;p&gt;Though QueryValueSource needs a searcher (but, seems to make one, from&lt;br/&gt;
the top reader, if it wasn&apos;t provided one).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;SolrSortField is currently used in SolrIndexSearcher to &apos;weight&apos; the Sorts. I wonder&lt;br/&gt;
whether we can simplify this? When ValueSource#getSort is called (which is only in 1&lt;br/&gt;
place really), we can pass in the IndexSearcher, meaning the SortField can be &apos;weighted&apos;&lt;br/&gt;
then and there.&lt;/p&gt;

&lt;p&gt;Since SolrSortField is only used in this 1 place currently, we can then revisit dropping it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That seems good too?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Do you think its worth opening an issue to address this first?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes can you do that, and mark this issue as depending in it?&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;I think apply 90/10 rule here? Start with the easy-to-move queries? We don&apos;t need initial go to be perfect... progress not perfection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could we sort the initial commit out and then I can move them over in batches?&lt;br/&gt;
Already have a 108k patch, I&apos;d say moving what we can will push it towards 300k&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good question... maybe we can do this on a branch?&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Do you have a sense of whether Solr&apos;s FQs are a superset of Lucene&apos;s? Ie, is there anything Lucene&apos;s FQs can do that Solr&apos;s can&apos;t?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Solr FQs are hugely more advanced than the ValueSourceQuery based stuff in Lucene.&lt;br/&gt;
Its not a full 1 to 1 change since the APIs are slightly different, but I&apos;d say&lt;br/&gt;
that we&apos;d want users to use the FQ line of classes. I cant see anything in Lucene&apos;s&lt;br/&gt;
VSQs that you couldn&apos;t do using FQs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK then once we finally have the &quot;superset&quot; moved into the module we&lt;br/&gt;
should remove Lucene&apos;s (deprecate on 3.x).&lt;/p&gt;</comment>
                    <comment id="13036501" author="yseeley@gmail.com" created="Thu, 19 May 2011 22:38:12 +0100"  >&lt;p&gt;Regarding weighting - function queries can contain normal queries, so anywhere a function query is used, it must be weighted first.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;When ValueSource#getSort is called (which is only in 1 place really), we can pass in the IndexSearcher, meaning the SortField can be &apos;weighted&apos; then and there.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sort instances are like Query instances, and for many reasons should not be bound to any particular searcher.&lt;/p&gt;</comment>
                    <comment id="13036631" author="cmale" created="Fri, 20 May 2011 03:22:30 +0100"  >&lt;blockquote&gt;
&lt;p&gt;So the goal here is to make the top-level searcher (IR) visible to the&lt;br/&gt;
FQ&apos;s getValues? I think this pre-dated the cutover to&lt;br/&gt;
AtomicReaderContext, which now provides the top reader? Maybe this&lt;br/&gt;
isn&apos;t needed anymore...?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Its very intentional (as Yonik has pointed out).  It allows any Querys in the ValueSources to be weighted.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Though QueryValueSource needs a searcher (but, seems to make one, from&lt;br/&gt;
the top reader, if it wasn&apos;t provided one).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is this desirable? IndexSearcher is pretty thin I know but is it fast enough to create that it has a nominal effect? If its faster than passing down the IndexSearcher then maybe its a good idea for anybody wanting an IndexSearcher to do this.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Good question... maybe we can do this on a branch?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Absolutely, can you create one?&lt;/p&gt;</comment>
                    <comment id="13036633" author="cmale" created="Fri, 20 May 2011 03:34:43 +0100"  >&lt;p&gt;Hey Yonik,&lt;/p&gt;

&lt;p&gt;Its super to hear from you on this, it&apos;ll be a real help.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Regarding weighting - function queries can contain normal queries, so anywhere a function query is used, it must be weighted first.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yup I&apos;ve come to understand that.  So the challenge is how to do this when a FunctionQuery is used to sort and not Query? Okay.  I&apos;m going to open an issue to see if we can address this better, maybe by extending SortField or something.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Sort instances are like Query instances, and for many reasons should not be bound to any particular searcher.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah that is true.  But ValueSource#getSort actually returns a SortField.  Does the same apply to SortField instances?  Also, ValueSource#weight(IndexSearcher) returns a new SortField as well, with a context containing the IndexSearcher.  Consequently the new SortField is bound to that particular searcher.&lt;/p&gt;</comment>
                    <comment id="13036637" author="cmale" created="Fri, 20 May 2011 03:43:43 +0100"  >&lt;p&gt;I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SOLR-2533&quot; title=&quot;Improve API of ValueSource &amp;amp; FunctionQuery SortField weighting&quot;&gt;&lt;del&gt;SOLR-2533&lt;/del&gt;&lt;/a&gt; to look at ways to standardise the ValueSource sort weighting API.&lt;/p&gt;</comment>
                    <comment id="13036641" author="cmale" created="Fri, 20 May 2011 04:09:13 +0100"  >&lt;blockquote&gt;
&lt;p&gt;Is this desirable? IndexSearcher is pretty thin I know but is it fast enough to create that it has a nominal effect? If its faster than passing down the IndexSearcher then maybe its a good idea for anybody wanting an IndexSearcher to do this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually one flaw in this is that SolrIndexSearcher has overridden some functionality in IndexSearcher, such as SimilarityProvider, which is used NormValueSource.&lt;/p&gt;</comment>
                    <comment id="13036898" author="yseeley@gmail.com" created="Fri, 20 May 2011 16:42:40 +0100"  >&lt;blockquote&gt;&lt;p&gt;&amp;gt; Sort instances are like Query instances, and for many reasons should not be bound to any particular searcher.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;Yeah that is true. But ValueSource#getSort actually returns a SortField. Does the same apply to SortField instances?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, that&apos;s part of a Sort.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, ValueSource#weight(IndexSearcher) returns a new SortField as well, with a context containing the IndexSearcher. Consequently the new SortField is bound to that particular searcher.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ValueSourceSortField.weight(IndexSearcher) - right.  That&apos;s sort of how queries can be re-written too... and the returned temporary SortField is never retained.  I guess I should have said that it should always be possible for Query and Sort instances to be independent of searchers and readers... but temporary ones can be created for the purposes of actually executing the query.&lt;/p&gt;

&lt;p&gt;Note that Solr&apos;s query cache uses Sort as part of the cache key too.&lt;/p&gt;</comment>
                    <comment id="13036906" author="mikemccand" created="Fri, 20 May 2011 17:12:35 +0100"  >&lt;p&gt;OK I created branch &lt;a href=&quot;https://svn.apache.org/repos/asf/lucene/dev/branches/fqmodule_2883&quot; class=&quot;external-link&quot;&gt;https://svn.apache.org/repos/asf/lucene/dev/branches/fqmodule_2883&lt;/a&gt;&lt;/p&gt;</comment>
                    <comment id="13053566" author="cmale" created="Thu, 23 Jun 2011 01:40:11 +0100"  >&lt;p&gt;Rather than doing all the work in this issue, I&apos;m going to spin off a few subtasks and resolve this one by one.&lt;/p&gt;</comment>
                    <comment id="13058132" author="cmale" created="Fri, 1 Jul 2011 00:31:03 +0100"  >&lt;p&gt;Committed revision 1141749.&lt;/p&gt;

&lt;p&gt;Its done.  Finally.&lt;/p&gt;</comment>
                    <comment id="13058142" author="rcmuir" created="Fri, 1 Jul 2011 00:59:51 +0100"  >&lt;p&gt;Thanks for all your hard refactoring work here Chris!&lt;/p&gt;</comment>
                    <comment id="13058549" author="mikemccand" created="Fri, 1 Jul 2011 14:25:54 +0100"  >&lt;p&gt;+1, this is great Chris!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310000">
                <name>Duplicate</name>
                                                <inwardlinks description="is duplicated by">
                            <issuelink>
            <issuekey id="12384049">LUCENE-1081</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12365317">SOLR-192</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12384266">LUCENE-1085</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                        <issuelinktype id="10001">
                <name>dependent</name>
                                <outwardlinks description="depends upon">
                            <issuelink>
            <issuekey id="12507839">SOLR-2533</issuekey>
        </issuelink>
                    </outwardlinks>
                                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12479572" name="LUCENE-2883.patch" size="110409" author="cmale" created="Wed, 18 May 2011 13:06:18 +0100" />
                </attachments>
            <subtasks>
            <subtask id="12511297">LUCENE-3232</subtask>
            <subtask id="12511512">LUCENE-3240</subtask>
            <subtask id="12511513">LUCENE-3241</subtask>
            <subtask id="12511933">LUCENE-3249</subtask>
            <subtask id="12512150">LUCENE-3256</subtask>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Tue, 25 Jan 2011 16:30:25 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3941</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24809</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>