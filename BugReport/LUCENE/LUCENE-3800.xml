<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 12:58:48 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3800/LUCENE-3800.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3800] Readers wrapping other readers don&apos;t prevent usage if any of their subreaders was closed</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3800</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;On recent trunk test we got this problem:&lt;br/&gt;
org.apache.lucene.index.TestReaderClosed.test&lt;br/&gt;
fails because the inner reader is closed but the wrapped outer ones are still open.&lt;/p&gt;

&lt;p&gt;I fixed the issue partially for SlowCompositeReaderWrapper and ParallelAtomicReader but it failed again. The cool thing with this test is the following:&lt;/p&gt;

&lt;p&gt;The test opens an DirectoryReader and then creates a searcher, closes the reader and executes a search. This is not an issue, if the reader is closed that the search is running on. This test uses LTC.newSearcher(wrap=true), which randomly wraps the passed Reader with SlowComposite or ParallelReader - or with both!!! If you then close the original inner reader, the close is not detected when excuting search. This can cause SIGSEGV when MMAP is used.&lt;/p&gt;

&lt;p&gt;The problem in (in Slow* and Parallel*) is, that both have their own Fields instances thats are kept alive until the reader itsself is closed. If the child reader is closed, the wrapping reader does not know and still uses its own Fields instance that delegates to the inner readers. On this step no more ensureOpen checks are done, causing the failures.&lt;/p&gt;

&lt;p&gt;The first fix done in Slow and Parallel was to call ensureOpen() on the subReader, too when requesting fields(). This works fine until you wrap two times: ParallelAtomicReader(SlowCompositeReaderWrapper(StandardDirectoryReader(segments_1:3:nrt _0(4.0):C42)))&lt;/p&gt;

&lt;p&gt;One solution would be to make ensureOpen also check all subreaders, but that would do the volatile checks way too often (with n is the total number of subreaders and m is the number of hierarchical levels this is n^m) - we cannot do this. Currently we only have n*m which is fine.&lt;/p&gt;

&lt;p&gt;The proposal how to solve this (closing subreaders under the hood of parent readers is to use the readerClosedListeners. Whenever a composite or slow reader wraps another readers, it registers itself as interested in readerClosed events. When a subreader is then forcefully closed (e.g by a programming error or this crazy test), we automatically close the parents, too.&lt;/p&gt;

&lt;p&gt;We should also fix this in 3.x, if we have similar problems there (needs investigation).&lt;/p&gt;</description>
                <environment></environment>
            <key id="12543266">LUCENE-3800</key>
            <summary>Readers wrapping other readers don&apos;t prevent usage if any of their subreaders was closed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Sun, 19 Feb 2012 17:55:18 +0000</created>
                <updated>Fri, 10 May 2013 11:43:50 +0100</updated>
                    <resolved>Wed, 22 Feb 2012 13:58:13 +0000</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13211447" author="rcmuir" created="Sun, 19 Feb 2012 17:59:08 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The proposal how to solve this (closing subreaders under the hood of parent readers is to use the readerClosedListeners. Whenever a composite or slow reader wraps another readers, it registers itself as interested in readerClosed events. When a subreader is then forcefully closed (e.g by a programming error or this crazy test), we automatically close the parents, too.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1. free safety.&lt;/p&gt;</comment>
                    <comment id="13211568" author="thetaphi" created="Sun, 19 Feb 2012 22:09:24 +0000"  >&lt;p&gt;I am still playing around with different solutions, its not so easy. I have a patch, but I have to think more about it.&lt;/p&gt;

&lt;p&gt;For now (to prevent test failures), I will commit a temporary fix to TestReaderClosed.test, so it does not wrap on newSearcher().&lt;/p&gt;</comment>
                    <comment id="13211572" author="thetaphi" created="Sun, 19 Feb 2012 22:14:34 +0000"  >&lt;p&gt;Until this is fixed, I added a workaround for the test that&apos;s failing in revision: 1291071&lt;/p&gt;</comment>
                    <comment id="13211970" author="thetaphi" created="Mon, 20 Feb 2012 16:51:09 +0000"  >&lt;p&gt;Patch for trunk that enforces a &quot;soft-close&quot; (make it unuseable) once a child-reader (subreader, delegate, parallel reader) is closed.&lt;/p&gt;

&lt;p&gt;The implementation works like that:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;A parent reader that delegates to one or more child readers (its currently BaseCompositeReader, SlowCompositeReaderWrapper, FilterAtomicReader, ParallelAtomicReader), register itsself on every child/delegate reader. The registration is done using a weak reference, so there is no circular ref problems. To be able to use WeakHashMap, this patch explicitely enforces identity equals/hashcode on IndexReader (which we always assumedin the past for FieldCache and so on, now its enforced like in MMapIndexInput)&lt;/li&gt;
	&lt;li&gt;When a reader closes, it simply iterates over all registered parents and &quot;marks&quot; them as &quot;unuseable&quot; (they are not really closed).&lt;/li&gt;
	&lt;li&gt;When somebody calls any method of a reader of which any child was closed, ensureOpen() will throw an AlreadyClosedEx with corresponding message.&lt;/li&gt;
	&lt;li&gt;You are still able to decRef/close readers which are marked as invalid (otherwise tests would fail). The child reader closed -&amp;gt; disable parent reader is simply done for safety.&lt;/li&gt;
	&lt;li&gt;To make the ensureOpen() checks not more expensive than before, the extra boolean was not made volatile, instead happens before and volatile behaviour as explained in Michael Busch&apos;s talks was used to guard the &quot;closedByChild&quot; boolean.&lt;/li&gt;
	&lt;li&gt;The patch does not use readerClosedListener for 2 reasons: (1) RCL has no weak refs, so we don&apos;t produce circular references between parents and childs, (2) We have to recursively go up the parent chain, which may confuse conventional readerClosedListeners. Also the parent readers are not closed, so its not applicable to call the listeners.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="13212190" author="thetaphi" created="Mon, 20 Feb 2012 22:54:32 +0000"  >&lt;p&gt;Improved patch with some minor things fixed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Better test for the close child case&lt;/li&gt;
	&lt;li&gt;Fix Solr TestDocSet now hopefully the last time by implementing the fake reader correctly as AtomicReader subclass without passing null to FilterAtomicReader&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All tests pass.&lt;/p&gt;</comment>
                    <comment id="13212580" author="thetaphi" created="Tue, 21 Feb 2012 13:30:41 +0000"  >&lt;p&gt;New patch, as parts of it were already committed (LTC changes).&lt;/p&gt;</comment>
                    <comment id="13213624" author="thetaphi" created="Wed, 22 Feb 2012 13:58:13 +0000"  >&lt;p&gt;Committed trunk revision: 1292293&lt;/p&gt;</comment>
                    <comment id="13213626" author="thetaphi" created="Wed, 22 Feb 2012 13:59:02 +0000"  >&lt;p&gt;If this would be good for 3.x, too -&amp;gt; reopen. 3.x is more safe as if a child reader is closed also parent readers have mostly no chance to do anything.&lt;/p&gt;</comment>
                    <comment id="13213638" author="yseeley@gmail.com" created="Wed, 22 Feb 2012 14:14:16 +0000"  >&lt;p&gt;Ouch - more weak references.  I was hoping we could reduce the number of those (I&apos;ve seen them cause worse GC problems for a number of people).&lt;br/&gt;
But if I understand the description correctly, then without this patch things could core dump when using mmap directory?&lt;/p&gt;</comment>
                    <comment id="13213642" author="thetaphi" created="Wed, 22 Feb 2012 14:16:49 +0000"  >&lt;p&gt;Yes! By the way, the same trick is used for MMapDirectory to keep track of its clones IndexInputs.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12515356" name="LUCENE-3800.patch" size="12858" author="thetaphi" created="Tue, 21 Feb 2012 13:30:41 +0000" />
                    <attachment id="12515294" name="LUCENE-3800.patch" size="15372" author="thetaphi" created="Mon, 20 Feb 2012 22:54:32 +0000" />
                    <attachment id="12515259" name="LUCENE-3800.patch" size="12914" author="thetaphi" created="Mon, 20 Feb 2012 16:51:09 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 19 Feb 2012 17:59:08 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>228513</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>23899</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>