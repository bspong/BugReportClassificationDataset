<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:28:16 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2421/LUCENE-2421.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2421] Hardening of NativeFSLock</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2421</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;NativeFSLock create a test lock file which its name might collide w/ another JVM that is running. Very unlikely, but still it happened a couple of times already, since the tests were parallelized. This may result in a false exception thrown from release(), when the lock file&apos;s delete() is called and returns false, because the file does not exist (deleted by another JVM already). In addition, release() should give a second attempt to delete() if it fails, since the file may be held temporarily by another process (like AntiVirus) before it fails. The proposed changes are:&lt;/p&gt;

&lt;p&gt;1) Use ManagementFactory.getRuntimeMXBean().getName() as part of the test lock name (should include the process Id)&lt;br/&gt;
2) In release(), if delete() fails, check if the file indeed exists. If it is, let&apos;s attempt a re-delete() few ms later.&lt;br/&gt;
3) If (3) still fails, throw an exception. Alternatively, we can attempt a deleteOnExit.&lt;/p&gt;

&lt;p&gt;I&apos;ll post a patch later today.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12463332">LUCENE-2421</key>
            <summary>Hardening of NativeFSLock</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Apr 2010 14:16:17 +0100</created>
                <updated>Wed, 30 Mar 2011 16:50:25 +0100</updated>
                    <resolved>Thu, 8 Jul 2010 09:03:32 +0100</resolved>
                                            <fixVersion>2.9.3</fixVersion>
                <fixVersion>3.0.2</fixVersion>
                <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12862660" author="shaie" created="Fri, 30 Apr 2010 13:55:37 +0100"  >&lt;p&gt;Patch w/ the proposed changes and a fallback to deleteOnExit in acquireTestLock, if deleting the test lock fails still.&lt;/p&gt;

&lt;p&gt;BTW, I&apos;ve used 100ms for the re-delete attempt delay. Do you think that&apos;s enough, or should I use a lower value, or perhaps IndexWriterConfig.getDefaultWriteLockTimeout (which is 1s unless changed)?&lt;/p&gt;</comment>
                    <comment id="12862666" author="shaie" created="Fri, 30 Apr 2010 14:24:27 +0100"  >&lt;p&gt;I&apos;m having second thoughts about using MXBean, since the name returned includes invalid filename characters such as @. Will need to check that next time I&apos;m infront of the code, but perhaps w/ all the other changes that might not be necessary ...&lt;/p&gt;</comment>
                    <comment id="12862706" author="mikemccand" created="Fri, 30 Apr 2010 16:11:06 +0100"  >&lt;p&gt;I think 100 msec is way too long &amp;#8211; I was thinking more like 10 msec &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                    <comment id="12862725" author="shaie" created="Fri, 30 Apr 2010 16:56:53 +0100"  >&lt;p&gt;Well ... we are talking about a fallback, last chance code, that should hardly ever be executed (i.e., I&apos;m pretty sure the delete() failed b/c the file wasn&apos;t there anymore). So if we&apos;ve reached that situation, I think we should give a reasonable &quot;last chance&quot;? So that if the file can&apos;t be deleted since it&apos;s locked by AntiVirus, we should be on the safe side?&lt;/p&gt;

&lt;p&gt;But I don&apos;t have any strong feelings for it - if you think 10 ms are enough, I&apos;ll change it.&lt;/p&gt;</comment>
                    <comment id="12862735" author="mikemccand" created="Fri, 30 Apr 2010 17:21:41 +0100"  >&lt;p&gt;I guess since it&apos;s a last resort &quot;we think will very rarely happen in practice&quot; thing... we can leave it @ 100 msec.  Just makes me nervous &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Libraries shouldn&apos;t be doing things like sleeping on you (for so long)...&lt;/p&gt;

&lt;p&gt;Hmm &amp;#8211; after that sleep, we still throw LockReleaseFailedException if we are still unable to delete it?  Isn&apos;t it &quot;harmless&quot; if we can&apos;t delete it?&lt;/p&gt;

&lt;p&gt;Also, rather than swallowing the InterruptedException, you should immediately throw ThreadInterruptedException &amp;#8211; we fixed Lucene a while back to not swallow this exception (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2053&quot; title=&quot;When thread is interrupted we should throw a clear exception&quot;&gt;&lt;del&gt;LUCENE-2053&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                    <comment id="12862805" author="shaie" created="Fri, 30 Apr 2010 19:56:51 +0100"  >&lt;blockquote&gt;&lt;p&gt;Libraries shouldn&apos;t be doing things like sleeping on you (for so long)...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well ... I think they&apos;d appreciate the sleep instead of the immediate exception. Previuosly, I&apos;ve been asked by customers to do that in other places. A 100ms sleep is barely noticeable (being so rare), but an exception definitely is! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Isn&apos;t it &quot;harmless&quot; if we can&apos;t delete it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No it isn&apos;t. I distinguish between two cases: the regular and test lock. For the regular lock, we&apos;ve already agreed we cannot leave it behind as it will prevent future locking. For the test lock I catch the exception in acquireTestLock and call deleteOnExit() suppressing the exception.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;you should immediately throw ThreadInterruptedException&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ok, thought it&apos;d be harmless here to ignore it since I&apos;m only doing last resort actions. But if that&apos;s common practice now, I will throw the exception.&lt;/p&gt;

&lt;p&gt;Thanks for the comments !&lt;/p&gt;</comment>
                    <comment id="12862834" author="mikemccand" created="Fri, 30 Apr 2010 20:53:24 +0100"  >&lt;blockquote&gt;&lt;p&gt;Well ... I think they&apos;d appreciate the sleep instead of the immediate exception. Previuosly, I&apos;ve been asked by customers to do that in other places. A 100ms sleep is barely noticeable (being so rare), but an exception definitely is&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I agree we should try to be robust to the &quot;diverse&quot; installations out there, like AVs that tie up our files.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For the regular lock, we&apos;ve already agreed we cannot leave it behind as it will prevent future locking&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wait, how come?  (SimpleFSLF does this, but native gets a &quot;real&quot; lock).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For the test lock I catch the exception in acquireTestLock and call deleteOnExit() suppressing the exception.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK.&lt;/p&gt;</comment>
                    <comment id="12862835" author="markrmiller@gmail.com" created="Fri, 30 Apr 2010 20:56:48 +0100"  >&lt;blockquote&gt;&lt;p&gt;Wait, how come? (SimpleFSLF does this, but native gets a &quot;real&quot; lock).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, this doesn&apos;t make sense to me either - native file locks don&apos;t care if the file is preexisting or not. It shouldnt matter if the file is already there or needs to be created. Its just a dummy file to get the lock on - even you start Lucene and the file exists, there will be no lock on it, so it won&apos;t matter.&lt;/p&gt;</comment>
                    <comment id="12862967" author="shaie" created="Sat, 1 May 2010 05:03:37 +0100"  >&lt;p&gt;I guess that you&apos;ve missed that on the thread: &quot;&lt;em&gt;It is possible that two JVMs will attempt to lock the same Directory, one w/ Native and the other w/ Simple. If we won&apos;t check in obtain() whether the file exists, it might obtain a native lock, while the Directory is actually locked by another JVM using Simple&lt;/em&gt;&quot;. Uwe also mentioned Native was fixed to use the same lock file name in 2.9 because of that.&lt;/p&gt;

&lt;p&gt;Another thing why we cannot leave the lock file behind is because if you e.g. switch from Native to Simple you won&apos;t be able to obtain a lock.&lt;/p&gt;

&lt;p&gt;And personally I prefer that if the Directory is not locked then the file won&apos;t be there - even if just for clarity, or because how we&apos;ve all become used to treat the existence of the lock file by now. And I&apos;d also hate to add another line to bw section &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12862968" author="shaie" created="Sat, 1 May 2010 05:26:41 +0100"  >&lt;p&gt;Patch adds throwin ThreadInterruptedException.&lt;/p&gt;

&lt;p&gt;About using MXBean name, I wrote this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; name = &lt;span class=&quot;code-quote&quot;&gt;&quot;d:/temp/file-&quot;&lt;/span&gt; + ManagementFactory.getRuntimeMXBean().getName();
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(name).createNewFile();
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(name).exists());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The file created included the @ character, which is valid on Windows (and also verified on Linux). But I&apos;m still not sure about using it, because if a system returns a character that is not a valid file character, we may not get the same file name we think ... so maybe if we still want to use it, we should move it to the end of the string, so that the name includes the random number for sure ... what do you think?&lt;/p&gt;</comment>
                    <comment id="12862969" author="markrmiller@gmail.com" created="Sat, 1 May 2010 05:27:38 +0100"  >&lt;blockquote&gt;&lt;p&gt;I guess that you&apos;ve missed that on the thread&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, just havn&apos;t seen a good reason yet...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt; &quot;It is possible that two JVMs will attempt to lock the same Directory, one w/ Native and the other w/ Simple. If we won&apos;t check in obtain() whether the file exists, it might obtain a native lock, while the Directory is actually locked by another JVM using Simple&quot;. Uwe also mentioned Native was fixed to use the same lock file name in 2.9 because of that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Lock factories do not have to work with all other lock factories...you need to use the same lock factory across all process&apos;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Another thing why we cannot leave the lock file behind is because if you e.g. switch from Native to Simple you won&apos;t be able to obtain a lock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not true - there is no reason both simple and native need to use the same lock file - or even that the native lock feel needs to be in the same dir (eg it could be in a tmp dir)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And personally I prefer that if the Directory is not locked then the file won&apos;t be there &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You cannot guarantee this in any case. If they cannot be deleted, it cannot be deleted - but cleanliness is no reason to throw an exception in an event that is not actually a failure situation.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;even if just for clarity, or because how we&apos;ve all become used to treat the existence of the lock file by now.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t find that persuasive myself...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And I&apos;d also hate to add another line to bw section&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;but its not a back compat break ...&lt;/p&gt;</comment>
                    <comment id="12862973" author="shaie" created="Sat, 1 May 2010 05:54:05 +0100"  >&lt;blockquote&gt;&lt;p&gt;Lock factories do not have to work with all other lock factories...you need to use the same lock factory across all process&apos;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, but I&apos;ve grown accustomed here that we try to protect users from their own mistakes. I.e., if the factory is a parameter to the application, this can certainly happen, w/o any of the application owners even realize that ... so it just seems dangerous to me, and I think that the alternative of keeping the file there and failing elsewhere is not good.&lt;/p&gt;

&lt;p&gt;Another scenario - one application opens the index on a local file system (which is shared) and uses Native, while the other, for safety reason, opens the index using Simple lock because it reads the index from a remote share ... does not make a lot of sense - but possible.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;or even that the native lock feel needs to be in the same dir (eg it could be in a tmp dir)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point - but it&apos;s irrelevant to that issue - one can already shoot himself in the leg today by doing that. That&apos;s something I don&apos;t think we can protect from ... but allowing two lock files in the same directory - that just seems like a bug. Still, one could impl MyOwnNativeFSLock and create &quot;my.lock.file&quot; ... but we cannot protect from that either. So at least, and that&apos;s my own opinion, the core factories that are provided w/ Lucene should behave well.&lt;/p&gt;

&lt;p&gt;So Mark - I agreed w/ you before on that, until Uwe brought up the reason why NativeFSLock was fixed in 2.9 to use the same lock file as Simple ... it seems like a good catch to me, and I think if it was fixed once already, do we really want to break that fix? That will certainly be a bw break, because now NativeFSLock could obtain a lock if a lock file is there (I&apos;m not sure if we have tests that cover that scenario, but I have a feeling some will fail if we change that).&lt;/p&gt;

&lt;p&gt;If the result of that discussion is that we should not fail if the lock file cannot be deleted, then I think we should rename it too, so that Native and Simple use different files and it is clear that you&apos;re using two different LFs, which is not supported?&lt;/p&gt;</comment>
                    <comment id="12862994" author="thetaphi" created="Sat, 1 May 2010 08:29:15 +0100"  >&lt;blockquote&gt;&lt;p&gt;The file created included the @ character, which is valid on Windows (and also verified on Linux). But I&apos;m still not sure about using it, because if a system returns a character that is not a valid file character, we may not get the same file name we think ... so maybe if we still want to use it, we should move it to the end of the string, so that the name includes the random number for sure ... what do you think?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I suggested on IRC to take the output of getName() and do a regexp replace and replace all non ACSII-digit chars:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ManagementFactory.getRuntimeMXBean().getName().replaceAll(&lt;span class=&quot;code-quote&quot;&gt;&quot;[^a..zA..Z0..9]+&quot;&lt;/span&gt;,&quot;&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Or alternatively simply use the hashCode of that String (but that is less unique).&lt;/p&gt;</comment>
                    <comment id="12863011" author="markrmiller@gmail.com" created="Sat, 1 May 2010 13:08:16 +0100"  >&lt;p&gt;I&apos;m still confused on the native/simple working together thing - I don&apos;t see where native will respect simple&apos;s lock? Am I missing something?&lt;/p&gt;

&lt;p&gt;Also, its almost more confusing that simple will respect the native lock file, when that file is not even native&apos;s actual lock - just its medium for a lock. If they could really work together, why even have a native lock?&lt;/p&gt;</comment>
                    <comment id="12863099" author="shaie" created="Sun, 2 May 2010 08:44:47 +0100"  >&lt;p&gt;You&apos;re right Mark ! I did not do a thorough check on NativeFSLock.obtain(). In the beginning of the method, it calls lockExists() and I assumed it checks for the existence of the file. But it actually checks whether the FileLock is not null. So that means:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If one obtains a Native lock and later a Simple lock obtain is attempted - it will fail.&lt;/li&gt;
	&lt;li&gt;If one obtains a Simple lock and later a Native lock obtain is attempted - it will succeed.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I wrote the following code to demonstrate that:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SimpleFSLockFactory simple = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleFSLockFactory(dir);
NativeFSLockFactory nativel = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NativeFSLockFactory(dir);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(nativel.makeLock(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;).obtain());
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(simple.makeLock(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;).obtain());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This prints &quot;true&quot; and &quot;false&quot; while if you move the simple.makeLock line above the native, it prints &quot;true&quot; twice.&lt;/p&gt;

&lt;p&gt;I don&apos;t know if that&apos;s a problem or not because it all boils down to whether we want to be nice if the user has made a mistake and used two lock factories in two different places of the code.&lt;/p&gt;

&lt;p&gt;Given that, if we are ok to declare this is unsupported in the sense that the code won&apos;t play nice, then I&apos;m ok w/ not failing if the lock file deletion fails, for both the regular and test lock. I think it makes sense to decide the code doesn&apos;t play nice, because someone can anyway extend LF and do such silly mistakes ...&lt;/p&gt;</comment>
                    <comment id="12863281" author="shaie" created="Mon, 3 May 2010 10:33:10 +0100"  >&lt;p&gt;Patch includes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Not throwing exception if the delete() fails&lt;/li&gt;
	&lt;li&gt;Added test case to TestLockFactory&lt;/li&gt;
	&lt;li&gt;Record in Runtime Behavior in CHANGES&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12863284" author="mikemccand" created="Mon, 3 May 2010 10:41:42 +0100"  >&lt;p&gt;Hmm so if failure to delete is no longer a serious issue (ie we are not going to throw an exception), do we really need to sleep for a long time &amp;amp; retry the deletion any more?&lt;/p&gt;

&lt;p&gt;This is all based on a hypothetical situation right (&quot;we may fail to delete the test file we just created, and it still exists&quot;)?  Maybe we should wait until this is really an issue (ie, a user actually hits it), before implementing this workaround code?&lt;/p&gt;</comment>
                    <comment id="12863288" author="shaie" created="Mon, 3 May 2010 10:51:56 +0100"  >&lt;p&gt;That&apos;s just so that we &quot;behave nicely&quot; with the application and not leave behind the lock file. I&apos;m thinking that if you see a write.lock file in the directory, it makes you wonder why it&apos;s there, and if the index was closed properly or not etc. The existence of the file does not tell you anything about which LF is used (Native or Simple) and so you cannot know for sure what went wrong. Going the extra mile, even if it&apos;s only in rare cases, seems harmless, no?&lt;/p&gt;

&lt;p&gt;I don&apos;t think it&apos;s critical, but I also don&apos;t think the code complicates matters?&lt;/p&gt;</comment>
                    <comment id="12863299" author="mikemccand" created="Mon, 3 May 2010 11:22:31 +0100"  >&lt;p&gt;Well sleeping for so long isn&apos;t necessarily harmless &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;And it&apos;s code to fix a problem that&apos;s only theoretical at this point &amp;#8211; we&apos;ve never seen this actually happen &amp;#8211; so this violates &apos;design for today&apos;.  Why fix something that may not even be an actual problem...&lt;/p&gt;

&lt;p&gt;Also the lock file name has &quot;-test&quot; in it, which is a strong hint to the future hypothetical user that hits this.&lt;/p&gt;</comment>
                    <comment id="12863310" author="shaie" created="Mon, 3 May 2010 12:22:07 +0100"  >&lt;p&gt;Ok, I&apos;m convinced - let&apos;s design for today. Removed the &quot;last chance&quot; code.&lt;/p&gt;</comment>
                    <comment id="12863316" author="thetaphi" created="Mon, 3 May 2010 12:42:34 +0100"  >&lt;p&gt;Looks good!&lt;/p&gt;</comment>
                    <comment id="12863323" author="mikemccand" created="Mon, 3 May 2010 13:32:31 +0100"  >&lt;p&gt;Thanks Shai &amp;#8211; this looks great!&lt;/p&gt;</comment>
                    <comment id="12863672" author="shaie" created="Tue, 4 May 2010 06:29:13 +0100"  >&lt;p&gt;Committed revision 940730.&lt;/p&gt;</comment>
                    <comment id="12864369" author="shaie" created="Wed, 5 May 2010 16:42:12 +0100"  >&lt;p&gt;Back-port to 3.1 as well&lt;/p&gt;</comment>
                    <comment id="12864383" author="shaie" created="Wed, 5 May 2010 17:09:54 +0100"  >&lt;p&gt;Committed revision 941361 (backport to 3x).&lt;/p&gt;</comment>
                    <comment id="12873436" author="mikemccand" created="Sun, 30 May 2010 15:35:24 +0100"  >&lt;p&gt;backport&lt;/p&gt;</comment>
                    <comment id="12886259" author="shaie" created="Thu, 8 Jul 2010 07:42:09 +0100"  >&lt;p&gt;Reopening to handle clearLock. Patch will be posted soon.&lt;/p&gt;</comment>
                    <comment id="12886264" author="shaie" created="Thu, 8 Jul 2010 08:10:13 +0100"  >&lt;p&gt;Patch fixes clearLock to first release the lock and then delete it. If the release fails, it means another process is holding the lock and therefore we shouldn&apos;t fail. If the delete fails, it ignores it.&lt;/p&gt;

&lt;p&gt;I plan to commit shortly.&lt;/p&gt;</comment>
                    <comment id="12886279" author="shaie" created="Thu, 8 Jul 2010 09:03:32 +0100"  >&lt;p&gt;Fixed on 3x and trunk&lt;/p&gt;</comment>
                    <comment id="12918019" author="mikemccand" created="Tue, 5 Oct 2010 16:16:18 +0100"  >&lt;p&gt;So, I&apos;m confused on how/why the &lt;b&gt;test&lt;/b&gt; lock name would get a conflict&lt;br/&gt;
with multiple JREs running our unit tests.&lt;/p&gt;

&lt;p&gt;Ie, each JRE runs tests in certain index directories.  And the test&lt;br/&gt;
lock is acquired in the index directory.  So, if tests running in&lt;br/&gt;
different JREs are sharing the same index directory, then more serious&lt;br/&gt;
problems will ensue.&lt;/p&gt;

&lt;p&gt;I think it must have only been the test output formatter&lt;br/&gt;
(LuceneJUnitResultFormatter) that was conflicting on the test lock&lt;br/&gt;
name.  Because this is the only locking usage that&apos;d be sharing the&lt;br/&gt;
same lock dir across JREs...&lt;/p&gt;</comment>
                    <comment id="12918020" author="shaie" created="Tue, 5 Oct 2010 16:21:31 +0100"  >&lt;p&gt;From what I remember, it was due to LuceneJUnitResultFormatter, yes.&lt;/p&gt;

&lt;p&gt;I don&apos;t mind if we stop using j.l.management and move to either:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Seed the Random w/ System.nanoTime() or&lt;/li&gt;
	&lt;li&gt;Don&apos;t acquire a test lock.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I don&apos;t remember if I ever tried the first approach. Your comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2688&quot; title=&quot;NativeFSLockFactory throws an exception on Android 2.2 platform as java.lang.management package is not available on android.&quot;&gt;&lt;del&gt;LUCENE-2688&lt;/del&gt;&lt;/a&gt; about not acquiring the test lock makes sense to me, but some testing would be required to confirm that I guess.&lt;/p&gt;</comment>
                    <comment id="12918030" author="mikemccand" created="Tue, 5 Oct 2010 16:39:07 +0100"  >&lt;p&gt;I&apos;ll open a new issue, to remove acquireTestLock... all tests pass with it removed.&lt;/p&gt;</comment>
                    <comment id="13013473" author="gsingers" created="Wed, 30 Mar 2011 16:50:25 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12448958" name="LUCENE-2421-2.patch" size="1220" author="shaie" created="Thu, 8 Jul 2010 08:10:13 +0100" />
                    <attachment id="12443457" name="LUCENE-2421.patch" size="4502" author="shaie" created="Mon, 3 May 2010 12:22:06 +0100" />
                    <attachment id="12443444" name="LUCENE-2421.patch" size="5330" author="shaie" created="Mon, 3 May 2010 10:33:10 +0100" />
                    <attachment id="12443361" name="LUCENE-2421.patch" size="3225" author="shaie" created="Sat, 1 May 2010 05:26:41 +0100" />
                    <attachment id="12443288" name="LUCENE-2421.patch" size="2903" author="shaie" created="Fri, 30 Apr 2010 13:55:36 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 30 Apr 2010 15:11:06 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11383</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25271</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>