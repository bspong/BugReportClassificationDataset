<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:15:16 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2897/LUCENE-2897.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2897] apply delete-by-Term and docID immediately to newly flushed segments</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2897</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Spinoff from &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2324&quot; title=&quot;Per thread DocumentsWriters that write their own private segments&quot;&gt;&lt;del&gt;LUCENE-2324&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When we flush deletes today, we keep them as buffered Term/Query/docIDs that need to be deleted.  But, for a newly flushed segment (ie fresh out of the DWPT), this is silly, because during flush we visit all terms and we know their docIDs.  So it&apos;s more efficient to apply the deletes (for this one segment) at that time.&lt;/p&gt;

&lt;p&gt;We still must buffer deletes for all prior segments, but these deletes don&apos;t need to map to a docIDUpto anymore; ie we just need a Set.&lt;/p&gt;

&lt;p&gt;This issue should wait until &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1076&quot; title=&quot;Allow MergePolicy to select non-contiguous merges&quot;&gt;&lt;del&gt;LUCENE-1076&lt;/del&gt;&lt;/a&gt; is in since that issue cuts over buffered deletes to a transactional stream.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12497133">LUCENE-2897</key>
            <summary>apply delete-by-Term and docID immediately to newly flushed segments</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Sat, 29 Jan 2011 14:37:21 +0000</created>
                <updated>Fri, 3 Jun 2011 17:37:12 +0100</updated>
                    <resolved>Thu, 5 May 2011 15:52:37 +0100</resolved>
                                            <fixVersion>3.2</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12988471" author="mikemccand" created="Sat, 29 Jan 2011 16:16:34 +0000"  >&lt;p&gt;Initial patch.&lt;/p&gt;

&lt;p&gt;The approach is nice and simple &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  All tests pass, but I put a bunch of nocommits in there, and I stopped short of the stuff I&apos;ll have to redo after committing ooo merges.&lt;/p&gt;</comment>
                    <comment id="12988472" author="mikemccand" created="Sat, 29 Jan 2011 16:19:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;I had to read this a few times, yes it&apos;s very elegant as we&apos;re skipping the postings that otherwise would be deleted immediately after flush, and we&apos;re reusing the terms map already in DWPT.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well... I think we can&apos;t &lt;span class=&quot;error&quot;&gt;&amp;#91;easily&amp;#93;&lt;/span&gt; skip writing the postings, because could result in non-deterministic behavior (I put a comment on this in the patch).&lt;/p&gt;

&lt;p&gt;If we did the flush w/ 2 passes (first pass to mark all del docs and 2nd to flush) then we could skip writing postings of docs that were deleted.  But I suspect that&apos;s too much cost on flush.&lt;/p&gt;

&lt;p&gt;With a single pass, we&apos;d end up writing some postings for the doc, but not all, depending on the order in which its terms arrived vs its deleted terms.&lt;/p&gt;

&lt;p&gt;I mean, in practice, an app is gonna delete against ID field (typically) so if we &quot;knew&quot; that down deep here in Luceneland we could do the first pass only against that one field...&lt;/p&gt;

&lt;p&gt;Also, merge is still going to have to apply del docs, since eg stored fields have written the deleted docs.&lt;/p&gt;</comment>
                    <comment id="12988473" author="jasonrutherglen" created="Sat, 29 Jan 2011 16:33:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;Well... I think we can&apos;t &lt;span class=&quot;error&quot;&gt;&amp;#91;easily&amp;#93;&lt;/span&gt; skip writing the postings, because could result in non-deterministic behavior (I put a comment on this in the patch).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Instead we&apos;re building the deleted docs BV as we&apos;re flushing.&lt;/p&gt;</comment>
                    <comment id="12988474" author="michaelbusch" created="Sat, 29 Jan 2011 16:40:47 +0000"  >&lt;p&gt;Yeah this is nice.  I was thinking we&apos;d switch to live deletes with RT, because then we can also handle delete-by-query like this.&lt;/p&gt;

&lt;p&gt;So the deleted queries we still have to buffer per DWPT, but this solves the updateDocument() problem.&lt;/p&gt;</comment>
                    <comment id="12988481" author="mikemccand" created="Sat, 29 Jan 2011 17:17:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Instead we&apos;re building the deleted docs BV as we&apos;re flushing.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, that&apos;s what the patch does.  Seems to work great &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I was thinking we&apos;d switch to live deletes with RT, because then we can also handle delete-by-query like this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, though for RT we need to apply the delete immediately (vs this patch which applies on flush).&lt;/p&gt;

&lt;p&gt;And delete-by-Query is still buffered...&lt;/p&gt;</comment>
                    <comment id="12988524" author="mikemccand" created="Sun, 30 Jan 2011 00:26:22 +0000"  >&lt;p&gt;Patch &amp;#8211; I think it&apos;s ready to commit!&lt;/p&gt;</comment>
                    <comment id="12990129" author="mikemccand" created="Thu, 3 Feb 2011 15:26:01 +0000"  >&lt;p&gt;I think we can do this for 3.1.&lt;/p&gt;</comment>
                    <comment id="12990540" author="mikemccand" created="Fri, 4 Feb 2011 12:05:25 +0000"  >&lt;p&gt;I changed my mind!  Pushing this to 3.2 now.&lt;/p&gt;</comment>
                    <comment id="13043476" author="rcmuir" created="Fri, 3 Jun 2011 17:37:12 +0100"  >&lt;p&gt;Bulk closing for 3.2&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12469758" name="LUCENE-2897.patch" size="37224" author="mikemccand" created="Sun, 30 Jan 2011 00:26:22 +0000" />
                    <attachment id="12469747" name="LUCENE-2897.patch" size="12492" author="mikemccand" created="Sat, 29 Jan 2011 16:16:34 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 29 Jan 2011 16:33:28 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10971</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24795</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>