<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:01:04 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1453/LUCENE-1453.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1453] When reopen returns a new IndexReader, both IndexReaders may now control the lifecycle of the underlying Directory which is managed by reference counting</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1453</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Rough summary. Basically, FSDirectory tracks references to FSDirectory and when IndexReader.reopen shares a Directory with a created IndexReader and closeDirectory is true, FSDirectory&apos;s ref management will see two decrements for one increment. You can end up getting an AlreadyClosed exception on the Directory when the IndexReader is open.&lt;/p&gt;

&lt;p&gt;I have a test I&apos;ll put up. A solution seems fairly straightforward (at least in what needs to be accomplished).&lt;/p&gt;</description>
                <environment></environment>
            <key id="12408582">LUCENE-1453</key>
            <summary>When reopen returns a new IndexReader, both IndexReaders may now control the lifecycle of the underlying Directory which is managed by reference counting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="markrmiller@gmail.com">Mark Miller</reporter>
                        <labels>
                    </labels>
                <created>Sat, 15 Nov 2008 21:01:58 +0000</created>
                <updated>Wed, 10 Jun 2009 13:48:29 +0100</updated>
                    <resolved>Wed, 10 Jun 2009 13:26:37 +0100</resolved>
                            <version>2.4</version>
                                <fixVersion>2.4.1</fixVersion>
                <fixVersion>2.9</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12647901" author="markrmiller@gmail.com" created="Sat, 15 Nov 2008 21:33:03 +0000"  >&lt;p&gt;Test exposing the problem and one possible fix for it.&lt;/p&gt;</comment>
                    <comment id="12648141" author="markrmiller@gmail.com" created="Mon, 17 Nov 2008 11:31:41 +0000"  >&lt;p&gt;So this is a bit of an ugly way to do this. Whats the best way? Some kind of clone support on Directory?&lt;/p&gt;</comment>
                    <comment id="12648144" author="mikemccand" created="Mon, 17 Nov 2008 11:45:24 +0000"  >&lt;p&gt;Hmm good catch Mark!  With &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1451&quot; title=&quot;Can&amp;#39;t create NIOFSDirectory w/o setting a system property&quot;&gt;&lt;del&gt;LUCENE-1451&lt;/del&gt;&lt;/a&gt; we are moving away from sharing instances of FSDir, which will fix this problem in 3.0.  But in the meantime I think this approach is good.  Though, maybe conditionalize it on whether closeDirectory is true?  We should add a comment explaining why are re-getting the FSDir in that case, also explaining that this logic can be removed in 3.0.&lt;/p&gt;

&lt;p&gt;I&apos;ll make those changes &amp;amp; commit.&lt;/p&gt;</comment>
                    <comment id="12648147" author="mikemccand" created="Mon, 17 Nov 2008 11:56:14 +0000"  >&lt;p&gt;New patch attached.  If this looks OK to you Mark, I&apos;ll commit.  Thanks!&lt;/p&gt;</comment>
                    <comment id="12648154" author="markrmiller@gmail.com" created="Mon, 17 Nov 2008 12:40:05 +0000"  >&lt;p&gt;Looks great to me. The only nitpick thing I&apos;d change (its a left over from my first patch) is dropping mabyeCopy in SegmentReader into the else clause. Don&apos;t think its necessary, but I want to OCD it down.&lt;/p&gt;</comment>
                    <comment id="12648164" author="mikemccand" created="Mon, 17 Nov 2008 13:51:21 +0000"  >&lt;p&gt;Hmm actually it&apos;s not so simple, because we also need the directory to be cloned if you reopen the segment or get a whole new SegmentReader.  Also, the case that &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1430&quot; title=&quot;IndexReader.open(String|File) may incorrectly throw AlreadyClosedException&quot;&gt;&lt;del&gt;LUCENE-1430&lt;/del&gt;&lt;/a&gt; fixed (in IndexReader.open) also must be guarded against in reopen.  I&apos;ll work out a new patch...&lt;/p&gt;</comment>
                    <comment id="12648167" author="markrmiller@gmail.com" created="Mon, 17 Nov 2008 14:06:30 +0000"  >&lt;p&gt;Ahh, I see. The newReader variable name should have tipped me off &amp;lt;g&amp;gt; I had it in my mind that there could be more but obviously didn&apos;t retain the idea (that test actually only breaks on one of the two originals).&lt;/p&gt;</comment>
                    <comment id="12648187" author="markrmiller@gmail.com" created="Mon, 17 Nov 2008 16:23:27 +0000"  >&lt;p&gt;Goes deeper than I would have guessed (not that I know reopen at all). Still have a test failing...&lt;/p&gt;</comment>
                    <comment id="12648223" author="mikemccand" created="Mon, 17 Nov 2008 18:23:10 +0000"  >&lt;p&gt;Attached another iteration...&lt;/p&gt;

&lt;p&gt;I moved the logic into DirectoryIndexReader&apos;s reopen method, and fixed the case where an exception his hit during reopen (eg if a writer is committing, that&apos;s expected) to not incorrectly close the directory.&lt;/p&gt;

&lt;p&gt;I also strengthened the test cases to verify we are not over-incRef&apos;ing the FSDir.&lt;/p&gt;</comment>
                    <comment id="12648446" author="markrmiller@gmail.com" created="Tue, 18 Nov 2008 01:12:16 +0000"  >&lt;p&gt;Hmm...I&apos;ve still got a test that fails. I&apos;ll post it tonight or in the morning after a triple check. &lt;/p&gt;

&lt;p&gt;...trying to check my shoot from the hip modus operandi for a moment &amp;lt;g&amp;gt;...&lt;/p&gt;

&lt;p&gt;&lt;b&gt;edit&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Ah, was optimizing without changing so getting back the same indexreader. Bad test. Patch holding up good so far...&lt;/p&gt;</comment>
                    <comment id="12648472" author="markrmiller@gmail.com" created="Tue, 18 Nov 2008 03:20:21 +0000"  >&lt;p&gt;Okay, I&apos;ve banged on it and I can&apos;t break it. Thats a brilliant way to do it by the way - not nearly as ugly (and is much shorter and actually works, so thats nice).&lt;/p&gt;</comment>
                    <comment id="12648501" author="michaelbusch" created="Tue, 18 Nov 2008 05:06:54 +0000"  >&lt;p&gt;Patch looks good... I guess this was my bug, so thanks for finding and fixing it Mark and Mike!&lt;/p&gt;</comment>
                    <comment id="12648552" author="mikemccand" created="Tue, 18 Nov 2008 09:46:55 +0000"  >&lt;p&gt;OK thanks for the review guys!   I&apos;ll commit soon.&lt;/p&gt;</comment>
                    <comment id="12648555" author="mikemccand" created="Tue, 18 Nov 2008 09:58:12 +0000"  >&lt;p&gt;Committed revision 718540.  Thanks Mark!&lt;/p&gt;</comment>
                    <comment id="12650800" author="markrmiller@gmail.com" created="Tue, 25 Nov 2008 23:49:24 +0000"  >&lt;p&gt;I think this bug should be called out in changes. Disagree? I&apos;ve seen 2 to 3 people that have seen it, and it seems we should document that its fixed in this version. I&apos;ll add it before the next release if nobody disagrees.&lt;/p&gt;</comment>
                    <comment id="12650914" author="mikemccand" created="Wed, 26 Nov 2008 10:07:19 +0000"  >&lt;p&gt;I agree &amp;#8211; I just committed an entry to CHANGES.txt.&lt;/p&gt;</comment>
                    <comment id="12674855" author="mikemccand" created="Thu, 19 Feb 2009 01:37:22 +0000"  >&lt;p&gt;Reopening for backport to 2.4.1.&lt;/p&gt;</comment>
                    <comment id="12674941" author="mikemccand" created="Thu, 19 Feb 2009 09:54:58 +0000"  >&lt;p&gt;Committed revision 745797 on 2.4 branch.&lt;/p&gt;</comment>
                    <comment id="12714786" author="thetaphi" created="Sat, 30 May 2009 23:23:07 +0100"  >&lt;p&gt;Is this patch obsolete, if &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1658&quot; title=&quot;Absorb NIOFSDirectory into FSDirectory&quot;&gt;&lt;del&gt;LUCENE-1658&lt;/del&gt;&lt;/a&gt; is correctly resolved and the whole caching from FSDir is removed?&lt;/p&gt;</comment>
                    <comment id="12714821" author="thetaphi" created="Sun, 31 May 2009 08:26:11 +0100"  >&lt;p&gt;It was too late in the night yesterday: I think this is not really related to &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1658&quot; title=&quot;Absorb NIOFSDirectory into FSDirectory&quot;&gt;&lt;del&gt;LUCENE-1658&lt;/del&gt;&lt;/a&gt;, but this case showed possibly a problem in my code.&lt;br/&gt;
As this issue is only interesting for IndexReaders opened without &quot;Directory&quot; but witch FS path, it was a problem with incomplete removal of the reference counting of FSDirs in an early test.&lt;br/&gt;
If the problem occurs again, I will reopen this issue.&lt;/p&gt;</comment>
                    <comment id="12717105" author="thetaphi" created="Sun, 7 Jun 2009 23:27:01 +0100"  >&lt;p&gt;After some testing, I found out, that this issue is not fixed. The test &quot;TestIndexReaderReopen&quot; fails very often, if all occurences of FSDirectory.getDirectory() are replaced by FSDirectory.open() in IndexReader/IndexWriter and DirectoryReader.&lt;br/&gt;
open() returns non refcounting single-use directorys that can be closed only one time. If readers on top of this (using the now-deprecated File/String IndexReader.open()) are reopened the directories are sometimes closed false.&lt;br/&gt;
I was hoping, &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1651&quot; title=&quot;Make IndexReader.open() always return MSR to simplify (re-)opens.&quot;&gt;&lt;del&gt;LUCENE-1651&lt;/del&gt;&lt;/a&gt; fixes this, but this is not so.&lt;/p&gt;

&lt;p&gt;There are two possibilities to fix this:&lt;br/&gt;
For both, the first step is to remove the whole closeDir stuff from all IndexReaders and do not close it from within indexReader.&lt;br/&gt;
Then there are two solutions:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;As FSDir.open() only returns subclasses of FSDir that have a no-op close() method, no closing is required. So we can just leave them open&lt;/li&gt;
	&lt;li&gt;Another possibility is to wrap all readers opened by IR.open() with File/String param by an (deprecated, package private) FilterIndexReader that handles closing the directory in close() and reopen() in a proper way. This is much simplier than doing it inside the DirectoryReader reopen stuff. The small overhead in passing through FilterIndexReader only affects people using the deprecated File/String open() methods. Users, directly using FSDir &amp;amp; Co. have no slowdown.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12717106" author="thetaphi" created="Sun, 7 Jun 2009 23:30:38 +0100"  >&lt;p&gt;Attached is the patch, that replaces all occurences of FSDir.openDirectory() by open(). The test &quot;TestIndexReaderReopen&quot; fails almost every time with an AlreadyClosedException.&lt;/p&gt;</comment>
                    <comment id="12717107" author="earwin" created="Sun, 7 Jun 2009 23:44:25 +0100"  >&lt;blockquote&gt;&lt;p&gt;There are two possibilities to fix this:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Vote for &quot;leave them open&quot;. Yes, it breaches the contract, but the breach is controlled (and thus harmless) and we get rid of some weird code (=possible point of failure) without introducing new.&lt;br/&gt;
There is a way to notice change in DirectoryReader behaviour, but it is too unrealistic:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
IndexReader r = IndexReader.open(&lt;span class=&quot;code-quote&quot;&gt;&quot;/path/to/index&quot;&lt;/span&gt;);
.....
Directory d = r.directory(); &lt;span class=&quot;code-comment&quot;&gt;// you have to get directory reference as you&apos;re not the one who created it
&lt;/span&gt;.....
r.close();
.....
d.doSomething(); &lt;span class=&quot;code-comment&quot;&gt;// and EXPECT &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; call to fail with exception&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12717231" author="mikemccand" created="Mon, 8 Jun 2009 12:33:24 +0100"  >&lt;p&gt;Since we&apos;ve deprecated all methods that are using FSDirectory.getDirectory under-the-hood, why do we even need to fix this?  Ie why replace all these with the new FSDir.open, now, when we&apos;re just going to remove them in 3.0 anyway?&lt;/p&gt;</comment>
                    <comment id="12717242" author="thetaphi" created="Mon, 8 Jun 2009 13:21:02 +0100"  >&lt;p&gt;Because the error sometimes also occurs with the refcounting directories, but more seldom (because of the refcounting helps to keep the directory open, even when it is closed one time too much).&lt;br/&gt;
And our problem: we want to really remove this ugly closeDir stuff from IndexReaders, the code is sometimes unreadable and its hard to find out whats going on.&lt;/p&gt;</comment>
                    <comment id="12717244" author="mikemccand" created="Mon, 8 Jun 2009 13:48:03 +0100"  >&lt;p&gt;But the refcounting is also deprecated?  And, IndexReader will no longer track closeDir in 3.0, since that&apos;s only set to true in the deprecated methods?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Because the error sometimes also occurs with the refcounting directories,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oh, you mean there is an intermittent failure on the current trunk?  (Ie, when using FSDir.getDirectory under the hood).&lt;/p&gt;</comment>
                    <comment id="12717430" author="thetaphi" created="Mon, 8 Jun 2009 22:28:41 +0100"  >&lt;p&gt;This is the solution using the FilterIndexReader, all tests now pass (with refcounting deprectated dirs as well as FSDir.open-dirs, see next Patch).&lt;br/&gt;
The solution consists of two parts:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;All closeDirectory stuff is removed from DirectoryIndexReader (even the ugly FSDir cloning) and from ReadOnlyDirectoryIndexReader; the code is now simplier to understand. It is now on the status for 3.0, no deprecated helper stuff anymore in these internal classes. So they can be used in 3.0 without modifications.&lt;/li&gt;
	&lt;li&gt;As the DirectoryIndexReader is not closing the directory anymore, the deprectated IndexReader.open methods taking String/File would not work anymore correctly (because they miss to close the dir on closing). To fix this easily, a deprectated private class extends FIlterIndexReader was added, that wraps around the DirectoryIndexReader, when File/String opens are used. This class keeps a refcounter that is incremented on reopen/clone and decremented on doClose(). The last doClose, closes the directory. In 3.0 this class can be removed easily with all File/String open() methods. I could remove this class from IndexReader.java and put in a separate package-private file, if you like.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I would like to have this in 2.9, to get rid of these ugly closeDirectory hacks! All tests pass (I retried TestIndexReaderReopen about hundred times and no variant fails anymore). It also works, when replacing the refcounting FSDir.getDirectory by FSDir.open() calls (see next patch).&lt;/p&gt;</comment>
                    <comment id="12717432" author="thetaphi" created="Mon, 8 Jun 2009 22:30:10 +0100"  >&lt;p&gt;This is a variant for testing the same with FSDir.open(). As you see, the reopening now also works correctly here and the underlying directory is not closed too often.&lt;/p&gt;

&lt;p&gt;This patch is for demonstration only.&lt;/p&gt;</comment>
                    <comment id="12717654" author="thetaphi" created="Tue, 9 Jun 2009 12:50:44 +0100"  >&lt;p&gt;I forgot to mention:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Oh, you mean there is an intermittent failure on the current trunk? (Ie, when using FSDir.getDirectory under the hood).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, for example, if you clone() and index that owns a directory. In this case the directory was not cloned using the ugly hack currently in trunk (see patches before, which is also removed again by my patch) and was then not correctly refcounted. During reopen(), sometimes DirectoryReader uses clone() to create a new instance, when the readonly flag changed, but the index was not modified. The testcase leads sometimes to exactly this behaviour and fails then.&lt;/p&gt;

&lt;p&gt;My patch now also handles clone correctly, so it fixes all these problems by just factoring out the deprecated Directory management to a FilterIndexReader. DirectoryReader just sees the directory and will never try to close it.&lt;/p&gt;</comment>
                    <comment id="12717657" author="earwin" created="Tue, 9 Jun 2009 13:00:51 +0100"  >&lt;p&gt;Patch looks fine. I read the last one, &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1453&quot; title=&quot;When reopen returns a new IndexReader, both IndexReaders may now control the lifecycle of the underlying Directory which is managed by reference counting&quot;&gt;&lt;del&gt;LUCENE-1453&lt;/del&gt;&lt;/a&gt;-with-FSDir-open.patch.&lt;/p&gt;</comment>
                    <comment id="12717660" author="thetaphi" created="Tue, 9 Jun 2009 13:11:33 +0100"  >&lt;p&gt;Both patches are the same, the second one is just using FSDir.open() instead of FSDir.getDirectory. For committing, I would use getDirectory(), the first patch. FSDir.open() would change behaviour for uses relying on the System property to specify the directory impl.&lt;/p&gt;</comment>
                    <comment id="12717709" author="mikemccand" created="Tue, 9 Jun 2009 16:31:46 +0100"  >&lt;p&gt;OK patch looks good Uwe!  This is much cleaner, and it&apos;s great to be able to get the scary closeDirectory logic entirely out of DirectoryReader.&lt;/p&gt;</comment>
                    <comment id="12717761" author="thetaphi" created="Tue, 9 Jun 2009 18:30:49 +0100"  >&lt;p&gt;Only two discussion points (the first one came up during an IRC chat with Earwin):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If DirectoryReader.close() throws an Exception, should the directory still be closed for cleanup? This is implemented exactly that way using a try...finally block in DirectoryOwningIndexReader.doClose(). The old DirectoryReader was different, with all its bugs.&lt;/li&gt;
	&lt;li&gt;Should I factor out DirectoryOwningIndexReader (any better name?) into a separate java file to not overload the already very big IndexReader.java? With 3.0, we could simply remove this class file (because already deprecated)  together with String/File open() .&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12717766" author="mikemccand" created="Tue, 9 Jun 2009 18:48:21 +0100"  >&lt;blockquote&gt;&lt;p&gt;If DirectoryReader.close() throws an Exception, should the directory still be closed for cleanup? This is implemented exactly that way using a try...finally block in DirectoryOwningIndexReader.doClose(). &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it should (be closed in a finally clause).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Should I factor out DirectoryOwningIndexReader (any better name?) into a separate java file to not overload the already very big IndexReader.java?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That sounds good.&lt;/p&gt;</comment>
                    <comment id="12717769" author="earwin" created="Tue, 9 Jun 2009 19:02:51 +0100"  >&lt;blockquote&gt;&lt;p&gt;I think it should (be closed in a finally clause).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Then there&apos;s the next question of the same sort, but probably belonging in a separate issue. If we close a DR and one of SR throws an exception - should we close the others (currently we don&apos;t)? What is the right way, in general, of handling IOExceptions on IR close? Can we retry the close? What does this exception mean?&lt;/p&gt;</comment>
                    <comment id="12717781" author="mikemccand" created="Tue, 9 Jun 2009 19:41:09 +0100"  >&lt;p&gt;Good question &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Exceptions in close are tricky...&lt;/p&gt;

&lt;p&gt;In some places we try hard to keep closing stuff, and then throw the&lt;br/&gt;
first exception we hit.  Probably that should be our preferred&lt;br/&gt;
approach, in general, for readers?  (My guess is most apps simply&lt;br/&gt;
catch &amp;amp; log the IOException, so, we should try hard to close all that&lt;br/&gt;
we can on the first go.)&lt;/p&gt;

&lt;p&gt;In other places (SR, DR) we don&apos;t.&lt;/p&gt;

&lt;p&gt;In general you can retry a close &amp;#8211; calling close more than once on&lt;br/&gt;
Lucene classes is allowed (or, we aim for that, but likely not all&lt;br/&gt;
classes achieve it).&lt;/p&gt;

&lt;p&gt;For writers (IndexWriter, and DR with pending changes) we try hard not&lt;br/&gt;
to lose state on hitting an exception during close.  Meaning, on&lt;br/&gt;
hitting an exception in close, either 1) your state already made it&lt;br/&gt;
into the index, or 2) if you fix the root cause (free up disk space,&lt;br/&gt;
fix permisisions, whatever, which of course hardly any app is going to&lt;br/&gt;
be doing) and retry the close, it would succeed, and your index would&lt;br/&gt;
be fine and your changes are committed.&lt;/p&gt;</comment>
                    <comment id="12717828" author="thetaphi" created="Tue, 9 Jun 2009 22:36:24 +0100"  >&lt;p&gt;Here is an updated patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Factored out the FilterIndexReader&lt;/li&gt;
	&lt;li&gt;Rewrite doClose() in both readers to record the first exception, but still try to close cleanup everything.&lt;/li&gt;
	&lt;li&gt;Some more code cleanup, CHANGES.txt&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It is ready to commit. Mike will you do this, or should I assign myself to this issue?&lt;/p&gt;</comment>
                    <comment id="12717830" author="thetaphi" created="Tue, 9 Jun 2009 22:40:26 +0100"  >&lt;p&gt;Do we need to backport to 2.4.2? It&apos;s not so easy, because DirectoryReader does not yet exist there (so you cannot simply apply the patch)...&lt;br/&gt;
Without backporting, clone() would not work correctly with shared FSDir IndexReaders.&lt;/p&gt;

&lt;p&gt;And: Backporting would hurt performance, because 2.4 does not use per-segment search, so each call from the searcher is passed through the FilterIndexReader...&lt;/p&gt;</comment>
                    <comment id="12717866" author="earwin" created="Wed, 10 Jun 2009 00:37:59 +0100"  >&lt;p&gt;Two suggestions:&lt;/p&gt;

&lt;p&gt;Factor out RefCount class and use it everywhere through Lucene. I see at least one identical to yours in SegmentReader. Would be easier to replace all these uses with AtomicInteger later.&lt;/p&gt;

&lt;p&gt;Looking at the new unsightly loop in doClose(), what if we change all Lucene closeable classes to implement java.io.Closeable and create a static utility method(-s) that receives a bunch of Closeables (an array, iterable, vararg in 1.5) and tries to close them all?&lt;br/&gt;
The method should be nullsafe (so you can skip != null checks) and will handle/rethrow exceptions. The most proper way to handle exceptions is probably this - rethrow original exception if it is the only one (be it Runtime or IO), if there&apos;s more - gather all exceptions and wrap them into a special IOException subclass that concatenates their messages and keeps them around, so they are inspectable at debug-time or if you implement special treatment for that exception in your code.&lt;br/&gt;
This method can be reused in a heap of places later, SR.doClose() comes first to mind.&lt;/p&gt;

&lt;p&gt;I can do the latter one in a separate patch to close this issue faster.&lt;/p&gt;</comment>
                    <comment id="12718004" author="thetaphi" created="Wed, 10 Jun 2009 10:39:19 +0100"  >&lt;p&gt;Hi Earwin,&lt;br/&gt;
attached is a patch, that simply reuses SegmentReader.Ref. Factoring it out to o.a.l.util would be harder to do at the moment (some test-cases rely on this class). And SegmentReader seems to be the only class, that uses such a Ref construct. Other classes have their refCounter as Field.&lt;br/&gt;
As the Filter is just a deprecated wrapper, that is removed in 3.0, I think reusing SegmentReader.Ref for that is ok.&lt;/p&gt;

&lt;p&gt;This patch also contains a new test for clone(), that does the same like the reopen test (checking the refcounts).&lt;/p&gt;

&lt;p&gt;Closeable is a Java 1.5 interface only, so this refactoring must wait until 3.0, but the idea is good!&lt;/p&gt;</comment>
                    <comment id="12718008" author="mikemccand" created="Wed, 10 Jun 2009 10:47:32 +0100"  >&lt;blockquote&gt;&lt;p&gt;Mike will you do this, or should I assign myself to this issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Go ahead &amp;amp; assign to yourself!&lt;/p&gt;</comment>
                    <comment id="12718009" author="earwin" created="Wed, 10 Jun 2009 10:48:24 +0100"  >&lt;blockquote&gt;&lt;p&gt;As the Filter is just a deprecated wrapper, that is removed in 3.0, I think reusing SegmentReader.Ref for that is ok. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ok. Maybe you are right.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Closeable is a Java 1.5 interface only, so this refactoring must wait until 3.0, but the idea is good!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We can introduce our own Closeable, and replace it with java native in 3.0, thank gods the interface is simple &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12718013" author="thetaphi" created="Wed, 10 Jun 2009 11:01:04 +0100"  >&lt;p&gt;Mike: OK, I commit the latest patch soon!&lt;/p&gt;

&lt;p&gt;Earwin:&lt;/p&gt;
&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Closeable is a Java 1.5 interface only, so this refactoring must wait until 3.0, but the idea is good!&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We can introduce our own Closeable, and replace it with java native in 3.0, thank gods the interface is simple &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think you should open an issue about that. But the own closeable should be declared as deprecated from the beginning with the note &quot;will be replaced by java.io.Closeable&quot; in 3.0.&lt;/p&gt;</comment>
                    <comment id="12718015" author="thetaphi" created="Wed, 10 Jun 2009 11:11:10 +0100"  >&lt;p&gt;Committed revision 783280.&lt;/p&gt;

&lt;p&gt;2.4 branch is untouched, if backporting is needed (because somebody has problems with reopen/clone), reopen this issue!&lt;/p&gt;</comment>
                    <comment id="12718027" author="mikemccand" created="Wed, 10 Jun 2009 11:54:28 +0100"  >&lt;p&gt;I&apos;m seeing a failure in back-compat tests (&quot;and test-tag -Dtestcase=TestIndexReader&quot;):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    [junit] Testcase: testFalseDirectoryAlreadyClosed(org.apache.lucene.index.TestIndexReader):	FAILED
    [junit] did not hit expected exception
    [junit] junit.framework.AssertionFailedError: did not hit expected exception
    [junit] 	at org.apache.lucene.index.TestIndexReader.testFalseDirectoryAlreadyClosed(TestIndexReader.java:1514)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(I assume, but I&apos;m not certain, it&apos;s from this fix...).&lt;/p&gt;</comment>
                    <comment id="12718041" author="thetaphi" created="Wed, 10 Jun 2009 12:45:40 +0100"  >&lt;p&gt;Thanks Mike,&lt;br/&gt;
it is from this fix. The test should normally also fail with trunk, but it doesn&apos;t because we are using FSDir.open() in the trunk test. This is another test that relies on the refcounting of FSDir.getDirectory.&lt;/p&gt;

&lt;p&gt;The problem:&lt;br/&gt;
If you do IndexReader.open() on a invalid index and IndexReader.open fails with an Exception, the Directory keeps open (because the wrapper has no chance to close it). I&apos;ll fix this and also enable FSDir.getDirectory for this test in trunk.&lt;/p&gt;</comment>
                    <comment id="12718044" author="thetaphi" created="Wed, 10 Jun 2009 13:00:29 +0100"  >&lt;p&gt;This fixes this special case and the test on trunk to also hit this, I commit soon!&lt;/p&gt;</comment>
                    <comment id="12718047" author="thetaphi" created="Wed, 10 Jun 2009 13:26:37 +0100"  >&lt;p&gt;Committed revision 783314. Thanks Mike! Next time I will also test-tag, sorry.&lt;/p&gt;

&lt;p&gt;I will go through all other tests using FSDir.open() in trunk now and check, if there are more cases, that rely on refcounting. They can be found easily, because they catch AlreadyClosedException.&lt;/p&gt;</comment>
                    <comment id="12718055" author="mikemccand" created="Wed, 10 Jun 2009 13:48:29 +0100"  >&lt;p&gt;OK thanks Uwe!&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310010">
                <name>Incorporates</name>
                                                <inwardlinks description="is part of">
                            <issuelink>
            <issuekey id="12426822">LUCENE-1672</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                        <issuelinktype id="10030">
                <name>Reference</name>
                                                <inwardlinks description="is related to">
                            <issuelink>
            <issuekey id="12426251">LUCENE-1658</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12410094" name="Failing-testcase-LUCENE-1453.patch" size="9265" author="thetaphi" created="Sun, 7 Jun 2009 23:30:38 +0100" />
                    <attachment id="12410307" name="LUCENE-1453-fix-TestIndexReader.patch" size="3330" author="thetaphi" created="Wed, 10 Jun 2009 13:00:29 +0100" />
                    <attachment id="12410298" name="LUCENE-1453.patch" size="23004" author="thetaphi" created="Wed, 10 Jun 2009 10:39:19 +0100" />
                    <attachment id="12410258" name="LUCENE-1453.patch" size="21167" author="thetaphi" created="Tue, 9 Jun 2009 22:36:24 +0100" />
                    <attachment id="12410175" name="LUCENE-1453.patch" size="17807" author="thetaphi" created="Mon, 8 Jun 2009 22:28:41 +0100" />
                    <attachment id="12394077" name="LUCENE-1453.patch" size="5668" author="mikemccand" created="Mon, 17 Nov 2008 18:23:10 +0000" />
                    <attachment id="12394062" name="LUCENE-1453.patch" size="5066" author="mikemccand" created="Mon, 17 Nov 2008 11:56:14 +0000" />
                    <attachment id="12393994" name="LUCENE-1453.patch" size="4185" author="markrmiller@gmail.com" created="Sat, 15 Nov 2008 21:33:03 +0000" />
                    <attachment id="12410176" name="LUCENE-1453-with-FSDir-open.patch" size="23996" author="thetaphi" created="Mon, 8 Jun 2009 22:30:10 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>9.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 17 Nov 2008 11:45:24 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12298</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26274</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>