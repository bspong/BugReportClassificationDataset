<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:06:53 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2516/LUCENE-2516.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2516] More clarification, improvements and correct behaviour of backwards tests</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2516</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Backwards tests are used since 2.9 to assert, that the new Lucene version supports drop-in-replacement over the previous version. For this all tests from the previous version are compiled against the old version but then run against the new JAR file.&lt;/p&gt;

&lt;p&gt;At the beginning the test suite was checking out another branch and doing this, but this was replaced in 3.1 by directly embedding the previous source tree and the previous tests into the backwards/ subdirectory of the SVN source. The whole idea has several problems:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tests not only check &lt;b&gt;public&lt;/b&gt; APIs, they also check internals and sometimes even fields or package-private methods. This is allowed to change in later versions, so we must be able to change the tests, to support this behaviour. This can be done by modifying the backwards tests to pass, but still use the public API unchanged. Sometimes we simply comment out tests, that test internals and not public APIs. For those tests, I would like to propose a Java Annotation for trunk tests like @LuceneInternalTest - so we can tell the tests runner for backwards (when this test is moved as backwards layer, e.g in 4.1, that it runs all tests &lt;b&gt;but&lt;/b&gt; not this marked one. This can be done easily with Junit3/4 in LuceneTestCase(J4). This is not part of this issue, but a good idea.&lt;/li&gt;
	&lt;li&gt;Sometimes we break backwards compatibility. Currently we do our best to change the tests to reflect this, but this is unneeded and stupi, as it brings two problems. The backwards tests should be compiled against the old version of Lucene. If we change this old Version in the backwards folder, its suddenly becomes nonsense. At least the JAR artifacts of the previous version should stay &lt;b&gt;unchanged&lt;/b&gt; in all cases! If we break backwards, the correct way to do this, is to simply disable coresponding tests! There is no need to make them work again, as we broke backwards, wy test plugin? The trunk tests already check the functionality, backwards tests only check API. If we fix the break in backwards, we do the contra of what they are for.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So I propose the following and have implemented in a patch for 3.x branch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Only include the &lt;b&gt;tests&lt;/b&gt; and nothing else into the backwards branch, no source files of previous Lucene Core.&lt;/li&gt;
	&lt;li&gt;Add the latest released JAR artifact of lucene-core.jar into backwards/lib, optimally with checksum (md5/sh1). This enforces that it is not changed and exactly do what they are for: To compile the previous tests against. This is the only reason for this JAR file.&lt;/li&gt;
	&lt;li&gt;If we break backwards, simply &lt;b&gt;disable&lt;/b&gt; the tests by commenting out, ideally with a short note and the JIRA issue that shows the break.&lt;/li&gt;
	&lt;li&gt;If we change inner behaviour of classes, that are not public, dont fix, disable tests. Its simple: backwards tests are only for API compatibility testsing of public APIs. If a test uses internals it should not be run. For that we should use a new annotation in trunk (see above).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This has several good things:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we can package backwards tests in src ZIP. Its not a full distrib, only the core tests and the JAR file. This enables people that doenloaded the src ZIP files to also run backwrads tests&lt;/li&gt;
	&lt;li&gt;Your SVN checkout is not so big and backwards tests run faster!&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There are some problems, with one example in the attached patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If we have mock classes in the tests (e.g. MockRAMDirectory) that extend Lucene classes and have access to their internal APIs, a change in these APIs will make them fail to work unchanged. The above example (MockRAMDir) is used in lots of tests and uses a internal RAMDir field that changed type in 3.1. But we cannot disable all tests using this dir (no tests will survive). As we cannot change the previous versions JAR to reflect this, you have to use some trick in this interbal test class. In this case I removed static linking of this field and replaced by reflection. This enables compilation against old JAR, but supports running in new version. This is really a special case, but works good here.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Any comments?&lt;/p&gt;</description>
                <environment></environment>
            <key id="12467995">LUCENE-2516</key>
            <summary>More clarification, improvements and correct behaviour of backwards tests</summary>
                <type id="6" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/requirement.png">Test</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="thetaphi">Uwe Schindler</assignee>
                                <reporter username="thetaphi">Uwe Schindler</reporter>
                        <labels>
                    </labels>
                <created>Sun, 27 Jun 2010 19:26:28 +0100</created>
                <updated>Wed, 30 Mar 2011 16:50:18 +0100</updated>
                    <resolved>Mon, 5 Jul 2010 10:00:00 +0100</resolved>
                            <version>3.1</version>
                                <fixVersion>3.1</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12882973" author="thetaphi" created="Sun, 27 Jun 2010 19:30:44 +0100"  >&lt;p&gt;Here is the patch.&lt;/p&gt;

&lt;p&gt;before apply, remove all subdirs in backwards/src except backwards/src/test. Also add a subfolder backwards/lib and add the lucene-core-3.0.2.jar from the previous release.&lt;/p&gt;

&lt;p&gt;With this patch test-backwards runs without problems. Most work were the changes that Shai did in core classes (against the above proopsal - the core classes must not change!!!). I simply disabled the tests (it was the MergePolicy stuff, &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2320&quot; title=&quot;Add MergePolicy to IndexWriterConfig&quot;&gt;&lt;del&gt;LUCENE-2320&lt;/del&gt;&lt;/a&gt;). Interestingly at lots of places, setting the merge policy in IW had no effect on the test at all. They also ran with the default policy &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;In my opinion, this change (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2320&quot; title=&quot;Add MergePolicy to IndexWriterConfig&quot;&gt;&lt;del&gt;LUCENE-2320&lt;/del&gt;&lt;/a&gt;) is to heavy for a 3.1 release, we should revert this change and only support in 4.0 - any comments? We can reenable all those tests then.&lt;/p&gt;

&lt;p&gt;This patch also implements the MockRAMDirectory hack with reflection to enable compilation against old JAR without disableing almost all tests.&lt;/p&gt;</comment>
                    <comment id="12882978" author="rcmuir" created="Sun, 27 Jun 2010 20:01:28 +0100"  >&lt;p&gt;I like this idea, I think it will simplify backwards tests.&lt;/p&gt;

&lt;p&gt;also, now that we have 4.0 (trunk) and 3.x, maybe we should review all the breaks still in 3.x and consider if some should be reverted to only be in trunk... then 3.1 would be more stable and keep more backwards compatibility, but trunk gets to still keep moving forward.&lt;/p&gt;

&lt;p&gt;such &apos;breaks&apos; could then be listed in the migration guide for trunk, as they are really just changes that could not be done easily in a backwards-compatible way.&lt;/p&gt;</comment>
                    <comment id="12883020" author="shaie" created="Mon, 28 Jun 2010 05:10:09 +0100"  >&lt;p&gt;I don&apos;t think that &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2320&quot; title=&quot;Add MergePolicy to IndexWriterConfig&quot;&gt;&lt;del&gt;LUCENE-2320&lt;/del&gt;&lt;/a&gt; was such a big break. It&apos;s changes resulted in many tests changes, but most users are not affected by it at all. And it allows us to consolidate MP setting in IWC ...&lt;/p&gt;

&lt;p&gt;I agree it&apos;s annoying to have to fix the backwards/src folder, but I&apos;m not sure we can avoid it. Consider a change to a package private class like SegmentMerger, and a test which references that API. The test may be testing other things and use piblic APIs as well - we cannot just remove it ...&lt;/p&gt;</comment>
                    <comment id="12883071" author="thetaphi" created="Mon, 28 Jun 2010 09:54:10 +0100"  >&lt;blockquote&gt;&lt;p&gt;I agree it&apos;s annoying to have to fix the backwards/src folder, but I&apos;m not sure we can avoid it. Consider a change to a package private class like SegmentMerger, and a test which references that API. The test may be testing other things and use piblic APIs as well - we cannot just remove it ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is exactly what I listed in the last section of my proposal. There are different ways to solve it:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;If the test is also testing global APIs, maybe its enough to disable the &quot;private&quot; part - like i did: Most IndexWriter tests did not rely on a specific MergePolicy, so I changed to use the default. If the test itsself relys on the private API to succeed, then its better to disable it completely. There is always another test, accessing the public API - and I just repeat: we are not really testing functionality in the backwards tests, we test API compatibility. In most cases, access to private fields is only done in asserts, that can be easily disabled.&lt;/li&gt;
	&lt;li&gt;If the private API is used in many tests (like my example with the MockRAMDir, you can always add a hack - but mark this hack as such and explain in the comment why. Only this way, we can be sure that one can understand why a test was modified / disabled.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the future we should really write tests that do separate testing for public APIs and internal behaviour (e.g. by asserting package-protected fields and so on). By adding a Java Annotation to those tests (see above) we can automatically disable those tests in backwards (the test runner does this for us). I will open another issue, that proposes that for trunk tests, where we have no backwards at the moment, so when 4.1 development gehts started we can simply enable the backwards tests and all &quot;internals teststing&quot; is automatically disabled.&lt;/p&gt;</comment>
                    <comment id="12885021" author="mikemccand" created="Sun, 4 Jul 2010 12:45:45 +0100"  >&lt;p&gt;This looks great!&lt;/p&gt;

&lt;p&gt;It&apos;s compelling to have only a JAR (not its sources) representing the&lt;br/&gt;
past release.&lt;/p&gt;

&lt;p&gt;But I don&apos;t think we should necessarily judge the&lt;br/&gt;
back-compat-break-cost of an issue by how many tests it affects.  EG,&lt;br/&gt;
I think it&apos;s fine for &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2320&quot; title=&quot;Add MergePolicy to IndexWriterConfig&quot;&gt;&lt;del&gt;LUCENE-2320&lt;/del&gt;&lt;/a&gt; to be in 3.x (few users change the&lt;br/&gt;
merge policy, and those that do are very much &quot;expert&quot; already, and&lt;br/&gt;
merge policy setting really does belong on IWC).  It&apos;s also good that&lt;br/&gt;
it&apos;s in 3.x because it gives a deprecation path forward, making app&lt;br/&gt;
migration easier (vs, in 4.0 only, where you have to read MIGRATE.txt&lt;br/&gt;
to figure out how to fix your code).&lt;/p&gt;

&lt;p&gt;In fact, for that issue we did not have to change the tests, right?&lt;br/&gt;
(The old API is still there, deprecated).  It&apos;s just that Shai was&lt;br/&gt;
fixing tests to not use deprecated APIs...&lt;/p&gt;

&lt;p&gt;The patch is surprisingly small!  (Not many &quot;real&quot; breaks).&lt;/p&gt;

&lt;p&gt;I agree we can handle package-private situations in the ways you&lt;br/&gt;
propose...&lt;/p&gt;

&lt;p&gt;Looks good!&lt;/p&gt;</comment>
                    <comment id="12885148" author="thetaphi" created="Mon, 5 Jul 2010 10:00:00 +0100"  >&lt;p&gt;Committed 3x revision: 960490&lt;/p&gt;

&lt;p&gt;I will now try in a second step to do a clean checkout of 3.0 tests again to minimize changes made in backwards tests.&lt;/p&gt;</comment>
                    <comment id="13013431" author="gsingers" created="Wed, 30 Mar 2011 16:50:18 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12448164" name="LUCENE-2516.patch" size="30127" author="thetaphi" created="Sun, 27 Jun 2010 19:30:44 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 27 Jun 2010 19:01:28 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11308</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25176</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>