<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:48 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2095/LUCENE-2095.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2095] Document not guaranteed to be found after write and commit</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2095</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;after same email on developer list:&lt;br/&gt;
&quot;I developed a stress test to assert that a new document containing a&lt;br/&gt;
specific term &quot;X&quot; is always found after a commit on the IndexWriter.&lt;br/&gt;
This works most of the time, but it fails under load in rare occasions.&lt;/p&gt;

&lt;p&gt;I&apos;m testing with 40 Threads, both with a SerialMergeScheduler and a&lt;br/&gt;
ConcurrentMergeScheduler, all sharing a common IndexWriter.&lt;br/&gt;
Attached testcase is using a RAMDirectory only, but I verified a&lt;br/&gt;
FSDirectory behaves in the same way so I don&apos;t believe it&apos;s the&lt;br/&gt;
Directory implementation or the MergeScheduler.&lt;br/&gt;
This test is slow, so I don&apos;t consider it a functional or unit test.&lt;br/&gt;
It might give false positives: it doesn&apos;t always fail, sorry I&lt;br/&gt;
couldn&apos;t find out how to make it more likely to happen, besides&lt;br/&gt;
scheduling it to run for a longer time.&quot;&lt;/p&gt;

&lt;p&gt;I tested this to affect versions 2.4.1 and 2.9.1;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux 64bit&lt;/p&gt;</environment>
            <key id="12441709">LUCENE-2095</key>
            <summary>Document not guaranteed to be found after write and commit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="sanne">Sanne Grinovero</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Nov 2009 21:19:51 +0000</created>
                <updated>Thu, 26 Aug 2010 12:49:40 +0100</updated>
                    <resolved>Wed, 2 Dec 2009 19:43:51 +0000</resolved>
                            <version>2.4.1</version>
                <version>2.9.1</version>
                                <fixVersion>2.9.2</fixVersion>
                <fixVersion>3.0.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12782625" author="sanne" created="Wed, 25 Nov 2009 21:21:32 +0000"  >&lt;p&gt;attaching the testcase, apply to version 2.9.1.&lt;br/&gt;
It&apos;s slow, please be patient.&lt;/p&gt;</comment>
                    <comment id="12782644" author="mikemccand" created="Wed, 25 Nov 2009 21:59:54 +0000"  >&lt;p&gt;I can get this to fail fairly quickly, using 2 threads.&lt;/p&gt;

&lt;p&gt;It&apos;s a thread safety issue of commit itself.  If you only allow 1 thread into commit at a time I believe the issue won&apos;t happen.&lt;/p&gt;

&lt;p&gt;It has to do with what thread #2 does when it enters commit and thread #1 is already in the process of committing.  In this case thread #2 basically waits for thread #1 to finish and then returns, whereas it should start its own new commit.&lt;/p&gt;</comment>
                    <comment id="12782659" author="jasonrutherglen" created="Wed, 25 Nov 2009 22:39:27 +0000"  >&lt;p&gt;Why do we allow un-synchronized commit if doFlush is&lt;br/&gt;
synchronized? The main cost of commit is most likely in the&lt;br/&gt;
flush as it doesn&apos;t wait for merges? There&apos;s a todo above&lt;br/&gt;
doFlush indicating we may want to make it un-synchronized in the&lt;br/&gt;
future to not block merges, how tenable is this?&lt;/p&gt;</comment>
                    <comment id="12782715" author="mikemccand" created="Thu, 26 Nov 2009 01:38:42 +0000"  >&lt;p&gt;I think the main cost is often fsync&apos;ing the new files.&lt;/p&gt;

&lt;p&gt;But I agree we should simply lock so only one thread can be in commit&lt;br/&gt;
at once.  Concurrency inside commit (when fscyning) seems silly (it&lt;br/&gt;
used to be slightly more interesting when we had autoCommit=true).&lt;/p&gt;

&lt;p&gt;We shouldn&apos;t use IW&apos;s lock.  First, it&apos;s overkill (doing so would&lt;br/&gt;
unnecessarily block other sync&apos;d ops from running).  Second, it leads&lt;br/&gt;
to deadlock, at least in CMS (if it waits because too many merges are&lt;br/&gt;
running).  I&apos;ll use a separate lock.&lt;/p&gt;

&lt;p&gt;I&apos;m not adding locking around the separate calls to prepareCommit then&lt;br/&gt;
commit.  An app must ensure these two calls are always balanced.&lt;/p&gt;

&lt;p&gt;Making flush unsynchronized would be great but I think wouldn&apos;t be&lt;br/&gt;
that big a gain in practice, unless we could make it truly unsync&apos;d&lt;br/&gt;
even with adding new docs.  Ie, if while we are flushing the last&lt;br/&gt;
segment, we can accept adding/deleting docs into a new ram buffer in&lt;br/&gt;
DW, that&apos;d be quite interesting.  But that&apos;s a big change!&lt;/p&gt;</comment>
                    <comment id="12783221" author="mikemccand" created="Sat, 28 Nov 2009 09:09:47 +0000"  >&lt;p&gt;Patch attached.  I think it&apos;s ready to commit:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Added a simple monitor lock during commit() to serialize threads.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Boiled down the test case to a new test case in TestIndexWriter.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Found &amp;amp; fixed the &lt;span class=&quot;error&quot;&gt;&amp;#91;unrelated&amp;#93;&lt;/span&gt; deadlock in TestCrash, and cutover&lt;br/&gt;
    RAMDir&apos;s tracking of sizeInBytes to an AtomicLong, as discussed on&lt;br/&gt;
    java-dev.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12783222" author="thetaphi" created="Sat, 28 Nov 2009 09:34:35 +0000"  >&lt;p&gt;Your patch only works for trunk and 3.0. If you want to fix it in 2.9 you must remove the j.u.concurrent* class usage.&lt;/p&gt;</comment>
                    <comment id="12783223" author="mikemccand" created="Sat, 28 Nov 2009 09:38:58 +0000"  >&lt;p&gt;Thanks for reminding me &amp;#8211; I&apos;ll remove it on backport.&lt;/p&gt;</comment>
                    <comment id="12784974" author="mikemccand" created="Wed, 2 Dec 2009 19:44:01 +0000"  >&lt;p&gt;Thanks Sanne!&lt;/p&gt;</comment>
                    <comment id="12785943" author="sanne" created="Fri, 4 Dec 2009 14:27:23 +0000"  >&lt;p&gt;Thanks a lot Michael, this makes my distributed testing reliable again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I see you didn&apos;t apply my testcase, do you think it&apos;s not needed to have such a test?&lt;br/&gt;
If you need I could change it as you wish.&lt;/p&gt;</comment>
                    <comment id="12785965" author="mikemccand" created="Fri, 4 Dec 2009 15:34:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Thanks a lot Michael, &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thank you!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;this makes my distributed testing reliable again&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m glad to hear it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Thanks for bringing closure...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I see you didn&apos;t apply my testcase&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually, I did: I boiled your testcase down and added it, in TestIndexWriter.java (testCommitThreadSafety).  The more tests the better!&lt;/p&gt;</comment>
                    <comment id="12902371" author="gvkraj23" created="Wed, 25 Aug 2010 11:37:04 +0100"  >&lt;p&gt;I am currently using LUCENE Net 2.9.2 version. We have upgraded from v1.9.0 to 2.9.2. Basically we want to use threading concept now. But i am strucked with a lock. How to over come with these locks. Can any one provide .net code sample. Thank you in advance. &lt;/p&gt;</comment>
                    <comment id="12902410" author="gvkraj23" created="Wed, 25 Aug 2010 13:39:08 +0100"  >&lt;p&gt;Please help me. Slowly all my trails are getting dried out. failing to resolve multi threading with Lucene. It is getting deadlog. Always I am seeing some Write.Lock file inside Index folder.&lt;/p&gt;</comment>
                    <comment id="12902498" author="simonw" created="Wed, 25 Aug 2010 17:24:17 +0100"  >&lt;p&gt;Hey man, you should really ask you question on a Lucene .NET mailing list and NOT on a Lucene Java JIRA issues which is completely unrelated.&lt;br/&gt;
Please make sure you are asking your questions on the appropriate list - those folks will be happy to help and answer your question.&lt;/p&gt;

&lt;p&gt;simon&lt;/p&gt;</comment>
                    <comment id="12902829" author="gvkraj23" created="Thu, 26 Aug 2010 12:49:40 +0100"  >&lt;p&gt;Thank you for guiding me correctly. will do that.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12426318" name="LUCENE-2095.patch" size="10524" author="mikemccand" created="Sat, 28 Nov 2009 09:09:47 +0000" />
                    <attachment id="12426146" name="lucene-stresstest.patch" size="12928" author="sanne" created="Wed, 25 Nov 2009 21:21:32 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 25 Nov 2009 21:59:54 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11684</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25630</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>