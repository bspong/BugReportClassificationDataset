<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:29:58 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2576/LUCENE-2576.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2576] Intermittent failure in TestIndexWriter.testCommitThreadSafety</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2576</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Mark&apos;s while(1) hudson box found this failure (and I can repro it too):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error Message

MockRAMDirectory: cannot close: there are still open files: {_1m.cfs=1,
_1k.cfs=1, _14.cfs=1, _1g.cfs=1, _1h.cfs=1, _1f.cfs=1, _1n.cfs=1,
_1i.cfs=1, _1j.cfs=1, _1l.cfs=1}

Stacktrace

java.lang.RuntimeException: MockRAMDirectory: cannot close: there are
still open files: {_1m.cfs=1, _1k.cfs=1, _14.cfs=1, _1g.cfs=1,
_1h.cfs=1, _1f.cfs=1, _1n.cfs=1, _1i.cfs=1, _1j.cfs=1, _1l.cfs=1}
       at
org.apache.lucene.store.MockRAMDirectory.close(MockRAMDirectory.java:282)
       at
org.apache.lucene.index.TestIndexWriter.testCommitThreadSafety(TestIndexWriter.java:4616)
       at org.apache.lucene.util.LuceneTestCase.runBare(LuceneTestCase.java:328)

Standard Output

NOTE: random codec of testcase &apos;testCommitThreadSafety&apos; was: Sep

Standard Error

The following exceptions were thrown by threads:
*** Thread: Thread-1784 ***
java.lang.RuntimeException: junit.framework.AssertionFailedError: null
       at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4606)
Caused by: junit.framework.AssertionFailedError: null
       at junit.framework.Assert.fail(Assert.java:47)
       at junit.framework.Assert.assertTrue(Assert.java:20)
       at junit.framework.Assert.assertTrue(Assert.java:27)
       at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4597)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
            <key id="12470430">LUCENE-2576</key>
            <summary>Intermittent failure in TestIndexWriter.testCommitThreadSafety</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Jul 2010 11:13:21 +0100</created>
                <updated>Fri, 3 Jun 2011 17:37:15 +0100</updated>
                    <resolved>Sun, 23 Jan 2011 13:33:44 +0000</resolved>
                                            <fixVersion>3.2</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12893572" author="mikemccand" created="Thu, 29 Jul 2010 11:14:52 +0100"  >&lt;p&gt;Gak &amp;#8211; I really hate editing a JIRA entry (it generates horribly unreadable email notification), but I forgot to put the noformat markup here...&lt;/p&gt;</comment>
                    <comment id="12897069" author="mikemccand" created="Tue, 10 Aug 2010 23:29:06 +0100"  >&lt;p&gt;Here&apos;s a patch to simplify the scary IW.startCommit method &amp;#8211; that method need not be so hairy anymore because only 1 thread is in there at once.&lt;/p&gt;</comment>
                    <comment id="12917233" author="rcmuir" created="Sat, 2 Oct 2010 19:17:33 +0100"  >&lt;p&gt;I just hit a similar issue myself.. but i can&apos;t reproduce it easily.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testsuite: org.apache.lucene.index.TestIndexWriter
    [junit] Testcase: testCommitThreadSafety(org.apache.lucene.index.TestIndexWriter):  Caused an ERROR
    [junit] MockDirectoryWrapper: cannot close: there are still open files: {_2g.tis=1}
    [junit] java.lang.RuntimeException: MockDirectoryWrapper: cannot close: there are still open files: {_2g.tis=1}
    [junit]     at org.apache.lucene.store.MockDirectoryWrapper.close(MockDirectoryWrapper.java:343)
    [junit]     at org.apache.lucene.index.TestIndexWriter.testCommitThreadSafety(TestIndexWriter.java:4701)
    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:795)
    [junit]     at org.apache.lucene.util.LuceneTestCase$LuceneTestCaseRunner.runChild(LuceneTestCase.java:768)
    [junit] Caused by: java.lang.RuntimeException: unclosed IndexInput
    [junit]     at org.apache.lucene.store.MockDirectoryWrapper.openInput(MockDirectoryWrapper.java:300)
    [junit]     at org.apache.lucene.store.Directory.openInput(Directory.java:138)
    [junit]     at org.apache.lucene.index.codecs.preflex.TermInfosReader.&amp;lt;init&amp;gt;(TermInfosReader.java:106)
    [junit]     at org.apache.lucene.index.codecs.preflex.PreFlexFields.&amp;lt;init&amp;gt;(PreFlexFields.java:78)
    [junit]     at org.apache.lucene.index.codecs.preflexrw.PreFlexRWCodec$1.&amp;lt;init&amp;gt;(PreFlexRWCodec.java:54)
    [junit]     at org.apache.lucene.index.codecs.preflexrw.PreFlexRWCodec.fieldsProducer(PreFlexRWCodec.java:54)
    [junit]     at org.apache.lucene.index.SegmentReader$CoreReaders.&amp;lt;init&amp;gt;(SegmentReader.java:136)
    [junit]     at org.apache.lucene.index.SegmentReader.get(SegmentReader.java:536)
    [junit]     at org.apache.lucene.index.SegmentReader.get(SegmentReader.java:509)
    [junit]     at org.apache.lucene.index.DirectoryReader.&amp;lt;init&amp;gt;(DirectoryReader.java:245)
    [junit]     at org.apache.lucene.index.DirectoryReader.doReopen(DirectoryReader.java:503)
    [junit]     at org.apache.lucene.index.DirectoryReader.access$000(DirectoryReader.java:48)
    [junit]     at org.apache.lucene.index.DirectoryReader$2.doBody(DirectoryReader.java:496)
    [junit]     at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:630)
    [junit]     at org.apache.lucene.index.DirectoryReader.doReopenNoWriter(DirectoryReader.java:491)
    [junit]     at org.apache.lucene.index.DirectoryReader.doReopen(DirectoryReader.java:449)
    [junit]     at org.apache.lucene.index.DirectoryReader.reopen(DirectoryReader.java:409)
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4680)
    [junit]
    [junit]
    [junit] Tests run: 116, Failures: 0, Errors: 1, Time elapsed: 28.646 sec
    [junit]
    [junit] ------------- Standard Output ---------------
    [junit] NOTE: reproduce with: ant test -Dtestcase=TestIndexWriter -Dtestmethod=testCommitThreadSafety -Dtests.seed=-8057983090429434268:7680346069737615565
    [junit] NOTE: test params are: codec=PreFlex, locale=mk_MK, timezone=America/Fortaleza
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12923949" author="yseeley@gmail.com" created="Fri, 22 Oct 2010 19:06:38 +0100"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] NOTE: reproduce with: ant test -Dtestcase=TestIndexWriter -Dtestmethod=testCommitThreadSafety -Dtests.seed=6167627923175702792:-1637309306537989375
    [junit] NOTE: test params are: codec=MockVariableIntBlock(baseBlockSize=84), locale=es_CL, timezone=Antarctica/South_Pole
    [junit] ------------- ---------------- ---------------
    [junit] ------------- Standard Error -----------------
    [junit] The following exceptions were thrown by threads:
    [junit] *** Thread: Thread-1148 ***
    [junit] java.lang.RuntimeException: java.lang.AssertionError: term=f:2_37; r=DirectoryReader(_3c:C106 ) expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4690)
    [junit] Caused by: java.lang.AssertionError: term=f:2_37; r=DirectoryReader(_3c:C106 ) expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.junit.Assert.fail(Assert.java:91)
    [junit]     at org.junit.Assert.failNotEquals(Assert.java:645)
    [junit]     at org.junit.Assert.assertEquals(Assert.java:126)
    [junit]     at org.junit.Assert.assertEquals(Assert.java:470)
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4684)
    [junit] *** Thread: Thread-1149 ***
    [junit] java.lang.RuntimeException: java.lang.AssertionError: term=f:3_3; r=DirectoryReader(_3c:C106 ) expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4690)
    [junit] Caused by: java.lang.AssertionError: term=f:3_3; r=DirectoryReader(_3c:C106 ) expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.junit.Assert.fail(Assert.java:91)
    [junit]     at org.junit.Assert.failNotEquals(Assert.java:645)
    [junit]     at org.junit.Assert.assertEquals(Assert.java:126)
    [junit]     at org.junit.Assert.assertEquals(Assert.java:470)
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4684)
    [junit] *** Thread: Thread-1147 ***
    [junit] java.lang.RuntimeException: java.lang.AssertionError: term=f:1_4; r=DirectoryReader(_3c:C106 ) expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4690)
    [junit] Caused by: java.lang.AssertionError: term=f:1_4; r=DirectoryReader(_3c:C106 ) expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.junit.Assert.fail(Assert.java:91)
    [junit]     at org.junit.Assert.failNotEquals(Assert.java:645)
    [junit]     at org.junit.Assert.assertEquals(Assert.java:126)
    [junit]     at org.junit.Assert.assertEquals(Assert.java:470)
    [junit]     at org.apache.lucene.index.TestIndexWriter$9.run(TestIndexWriter.java:4684)
    [junit] NOTE: all tests run in this JVM:
    [junit] [TestMergeSchedulerExternal, TestSimpleAttributeImpls, TestAddIndexes, TestCrash, TestFlex, TestIndexWriter]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12930987" author="mikemccand" created="Thu, 11 Nov 2010 11:24:09 +0000"  >&lt;p&gt;OK I found the cause of the &quot;expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;&quot; failures; it&apos;s&lt;br/&gt;
because SegmentInfos is failing to actually find the latest segments_N&lt;br/&gt;
file.&lt;/p&gt;

&lt;p&gt;The test commits frequently and reopens readers frequently w/ multiple&lt;br/&gt;
threads.  Because our MockDirWrapper &quot;acts like windows&quot;, we prevent&lt;br/&gt;
deleting segments_N files that are being read and so when a given&lt;br/&gt;
thread goes to reopen, the fallback logic in SegmentInfos can easily&lt;br/&gt;
open a too-old commit point.&lt;/p&gt;

&lt;p&gt;To fix this I changed the retry order in which SegmentInfos tries to&lt;br/&gt;
find the segments file.  Previously, upon failing to load segments_N&lt;br/&gt;
we would immediately attempt to load segments_(N-1).  I&apos;ve changed&lt;br/&gt;
that now to instead first try re-checking (re-list the dir and re-open&lt;br/&gt;
the segments.gen file), and only if re-checking produced the same &quot;N&quot;&lt;br/&gt;
do we then fallback to N-1.&lt;/p&gt;

&lt;p&gt;I think this is actually an important change... back when this logic&lt;br/&gt;
was first created we did not have deletion policies and so a if the&lt;br/&gt;
segments_(N-1) existed it really did mean a commit to segments_N was&lt;br/&gt;
still in process.  But today, w/ del policy, it could easily mean that&lt;br/&gt;
segments_(N-1) was just not deleted.  So I think it&apos;s important to&lt;br/&gt;
re-list before trying segments_(N-1).&lt;/p&gt;

&lt;p&gt;This fixes another failure case for this test, but, I still sometimes&lt;br/&gt;
see the &quot;IndexFileDeleter does not know about XXX&quot; (that other tests&lt;br/&gt;
have also hit), so I&apos;ll leave this open for now...&lt;/p&gt;</comment>
                    <comment id="12985267" author="shaie" created="Sun, 23 Jan 2011 07:42:38 +0000"  >&lt;p&gt;Changing to 3.2, if we&apos;re gonna keep this open for a while. Unless, Mike, you think it&apos;s safe to close it.&lt;/p&gt;</comment>
                    <comment id="12985319" author="mikemccand" created="Sun, 23 Jan 2011 13:33:44 +0000"  >&lt;p&gt;Actually I believe this is now fixed.&lt;/p&gt;</comment>
                    <comment id="13043495" author="rcmuir" created="Fri, 3 Jun 2011 17:37:15 +0100"  >&lt;p&gt;Bulk closing for 3.2&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12459339" name="LUCENE-2576.patch" size="5986" author="mikemccand" created="Thu, 11 Nov 2010 11:24:09 +0000" />
                    <attachment id="12451721" name="LUCENE-2576.patch" size="6326" author="mikemccand" created="Tue, 10 Aug 2010 23:29:06 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>2.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 2 Oct 2010 18:17:33 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11257</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25116</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>