<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:04:27 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3501/LUCENE-3501.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3501] random sampler is not random (and so facet SamplingWrapperTest occasionally fails)</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3501</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;RandomSample is not random at all:&lt;br/&gt;
It does not even import java.util.Random, and its behavior is deterministic.&lt;/p&gt;

&lt;p&gt;in addition, the test testCountUsingSamping() never retries as it was supposed to (for taking care of the hoped-for randomness).&lt;/p&gt;</description>
                <environment></environment>
            <key id="12526373">LUCENE-3501</key>
            <summary>random sampler is not random (and so facet SamplingWrapperTest occasionally fails)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png">Resolved</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="doronc">Doron Cohen</assignee>
                                <reporter username="doronc">Doron Cohen</reporter>
                        <labels>
                    </labels>
                <created>Sun, 9 Oct 2011 13:46:02 +0100</created>
                <updated>Mon, 24 Oct 2011 13:51:47 +0100</updated>
                    <resolved>Mon, 24 Oct 2011 13:51:46 +0100</resolved>
                                                            <component>modules/facet</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13123703" author="doronc" created="Sun, 9 Oct 2011 16:20:13 +0100"  >&lt;p&gt;The error (from Jenkins) was:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit.framework.AssertionFailedError: Results are not the same!
	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:149)
	at org.apache.lucene.util.LuceneTestCaseRunner.runChild(LuceneTestCaseRunner.java:51)
	at org.apache.lucene.facet.FacetTestBase.assertSameResults(FacetTestBase.java:316)
	at org.apache.lucene.facet.search.sampling.BaseSampleTestTopK.assertSampling(BaseSampleTestTopK.java:93)
	at org.apache.lucene.facet.search.sampling.BaseSampleTestTopK.testCountUsingSamping(BaseSampleTestTopK.java:76)
	at org.apache.lucene.util.LuceneTestCase$2$1.evaluate(LuceneTestCase.java:610)

reproduce with: ant test -Dtestcase=SamplingWrapperTest -Dtestmethod=testCountUsingSamping -Dtests.seed=39c6b88dcada2192:-cf936a4278714b1:-770b2814b4a6acd7
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="13123710" author="doronc" created="Sun, 9 Oct 2011 16:40:26 +0100"  >&lt;p&gt;Before applying this patch should do:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;svn mv modules/facet/src/java/org/apache/lucene/facet/util/RandomSample.java modules/facet/src/java/org/apache/lucene/facet/search/sampling/RepeatableSampler.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I looked at this, and also discussed with Gilad, and it seems that:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The test is broken as it claims to do N trials in case of failure but it does not, because its try/catch does not catch AssertionError, and so only one trial is attempted. (Few trials make sense because with sampling, there is always a possibility that the selected sample set of docs would not contain the &quot;correct&quot; best facets even with a high over sampling ratio (over sampling means that for the selected set of docs more best facets are collected).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Even after fixing the test to actually try more than once, it still fails, because there is no randomness in RandomSample...  surprising but true.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In this patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Sampler made an abstract class.&lt;/li&gt;
	&lt;li&gt;RandomSample renamed to RepeatableSampler which extends Sampler.&lt;/li&gt;
	&lt;li&gt;RandomSampler was added - it too extends Sampler - this is a simple &lt;b&gt;random&lt;/b&gt; implementation, which is now the default (used by default in SamplingWrapperAccumulator).&lt;/li&gt;
	&lt;li&gt;The test randomly selects between the two sampler implementations. If you want to see the behavior that created the bug, remove that latter randomness by setting to false the variable &lt;b&gt;useRandomSampler&lt;/b&gt; of &lt;b&gt;BaseSampleTestTopK.testCountUsingSamping()&lt;/b&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think this is ready to commit. &lt;br/&gt;
Wasn&apos;t sure though, where should the Changes entry go?&lt;/p&gt;</comment>
                    <comment id="13123717" author="shaie" created="Sun, 9 Oct 2011 17:12:33 +0100"  >&lt;p&gt;I briefly went through the patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In the test, I prefer to still catch Exception, or if you want to be on the safe side, Throwable. And have assertSameResult throw RuntimeException. Calling fail() from there, forcing you to handle Errors, seem too low-level to me ...&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In AdaptiveFacetsAccumulator you have this line: //private Sampler sampler = new RepeatableSampler();. Is it a leftover?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Maybe add a line or two to RandomSample.createSample() (internal comments), such as:
	&lt;ul&gt;
		&lt;li&gt;&quot;Skip over &apos;step&apos; documents&quot; before the for-loop&lt;/li&gt;
		&lt;li&gt;&quot;Add all leftover documents to the sampled set&quot; before last &apos;while&apos;.&lt;br/&gt;
(Please also confirm my understanding) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;CHANGES - in this case you only need a CHANGES entry for 3x (since the change is applied to there as well), and it is under contrib.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Otherwise, it looks very good !&lt;/p&gt;</comment>
                    <comment id="13123744" author="doronc" created="Sun, 9 Oct 2011 19:06:15 +0100"  >&lt;p&gt;Thanks for reviewing Shai!&lt;br/&gt;
I&apos;ll change as you propose (confirming your understanding) and commit tomorrow.&lt;/p&gt;</comment>
                    <comment id="13124997" author="doronc" created="Tue, 11 Oct 2011 14:00:44 +0100"  >&lt;p&gt;Fixed in trunk: r1181760&lt;/p&gt;

&lt;p&gt;Shai&apos;s comment on catching AssertionError made me search for other cases of catching this error in Lucene. Few such cases exist, and they all seem wrong, as they call fail when failing fail &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; due to assert not enabled but fail to detect that failure since they then silently ignore AssertionError thrown by fail(). Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-3506&quot; title=&quot;tests for verifying that assertions are enabled do nothing since they ignore AssertionError&quot;&gt;&lt;del&gt;LUCENE-3506&lt;/del&gt;&lt;/a&gt; for this.&lt;/p&gt;</comment>
                    <comment id="13134033" author="doronc" created="Mon, 24 Oct 2011 13:51:47 +0100"  >&lt;p&gt;Fix merged to 3x: 1188129.&lt;br/&gt;
Thanks Gilad and Shai for helping to fix this.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12498356" name="LUCENE-3501.patch" size="55895" author="doronc" created="Sun, 9 Oct 2011 16:40:26 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sun, 9 Oct 2011 16:12:33 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>50940</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24196</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>