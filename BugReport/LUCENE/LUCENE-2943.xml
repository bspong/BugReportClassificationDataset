<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:06:22 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2943/LUCENE-2943.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2943] ICU collator thread-safety issues</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2943</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;The ICU Collators (unlike the JDK ones) aren&apos;t thread safe: &lt;a href=&quot;http://userguide.icu-project.org/collation/architecture&quot; class=&quot;external-link&quot;&gt;http://userguide.icu-project.org/collation/architecture&lt;/a&gt; , a little non-obvious since its not mentioned&lt;br/&gt;
in the javadocs, and its not clear if the docs apply to only the C code, but i looked&lt;br/&gt;
at the source and there is all kinds of internal state.&lt;/p&gt;

&lt;p&gt;So in my opinion, we should clone the icu collators (which are passed in from the outside) &lt;br/&gt;
when creating a new TokenStream/AttributeImpl to prevent problems. This shouldn&apos;t be a big&lt;br/&gt;
deal since everything uses reusableTokenStream anyway.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12499969">LUCENE-2943</key>
            <summary>ICU collator thread-safety issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="-1">Unassigned</assignee>
                                <reporter username="rcmuir">Robert Muir</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Feb 2011 20:43:18 +0000</created>
                <updated>Wed, 30 Mar 2011 16:50:12 +0100</updated>
                    <resolved>Tue, 1 Mar 2011 20:49:39 +0000</resolved>
                                            <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>modules/analysis</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13000506" author="rcmuir" created="Mon, 28 Feb 2011 20:45:05 +0000"  >&lt;p&gt;Here&apos;s a patch for trunk (including fix to the deprecated 3.x filter).&lt;/p&gt;

&lt;p&gt;We should fix this bug in 3.x too.&lt;/p&gt;</comment>
                    <comment id="13000508" author="thetaphi" created="Mon, 28 Feb 2011 20:57:54 +0000"  >&lt;p&gt;Patch looks fine!&lt;/p&gt;

&lt;p&gt;Just one question: is the clone() method itsself thread-safe? if not, it must be synchronized somehow.&lt;/p&gt;</comment>
                    <comment id="13000511" author="thetaphi" created="Mon, 28 Feb 2011 21:05:08 +0000"  >&lt;p&gt;I changed my mind a little bit:&lt;/p&gt;

&lt;p&gt;The cloning of the Collator should be done in the Analyzer not in the Filter. The same applies to the AttributeImpl, the cloning should not be done in the ctor. The problem is not that the TokenStream or the Attribute instance may reuse the attribute in different threads, the problem is that the factory class (the Analyzer) does reuse the Collator in different threads when it produces multiple tokenstreams or the AF multiple attributes.&lt;/p&gt;

&lt;p&gt;This is a slight difference, because the following code is always safe:&lt;br/&gt;
new CollationFilter(Collator.newInstance(lang)), cloning would be wrong.&lt;/p&gt;

&lt;p&gt;The reason for the whole thing: TokenStream and Attribute instances itsself are single-threaded only, but not the factory or the analyzer.&lt;/p&gt;</comment>
                    <comment id="13000514" author="rcmuir" created="Mon, 28 Feb 2011 21:10:45 +0000"  >&lt;p&gt;Uwe, that is one alternative.&lt;/p&gt;

&lt;p&gt;The only reason i did it this way, is because I felt it was a bit of a trap (to any users using the Filter directly). This is because JDK collators are in fact thread safe.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This is a slight difference, because the following code is always safe:&lt;br/&gt;
new CollationFilter(Collator.newInstance(lang)), cloning would be wrong.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think this is really a reasonable example, usually in the search engine you would never use code like this: the sort keys will be way too large for no reason. For example usually its the case you will set something more reasonable like primary strength (case-insensitive).&lt;/p&gt;

&lt;p&gt;Because the clone is cheap, and this is a trap to users, I&apos;m still going to fight for my original patch. This way the ICU and JDK functionality behave consistently from a user perspective.&lt;/p&gt;</comment>
                    <comment id="13000534" author="thetaphi" created="Mon, 28 Feb 2011 21:38:04 +0000"  >&lt;p&gt;I would be fine with both solutions, for me it just looks wrong that way, but for safety reasons its fine.&lt;/p&gt;</comment>
                    <comment id="13000539" author="rcmuir" created="Mon, 28 Feb 2011 21:44:28 +0000"  >&lt;p&gt;Uwe, i can agree it looks a little wrong, but it makes the &apos;reusable&apos; case easier.&lt;/p&gt;

&lt;p&gt;the example you gave is the slow non-reusable case... honestly i&apos;m not very worried about making this slower... its already slow.&lt;/p&gt;

&lt;p&gt;if we are to put responsibility on the user to pass Collator clones to each TokenFilter, it will make reusing more difficult (e.g. custom analyzers). &lt;/p&gt;

&lt;p&gt;Again, the big trap is that usually you see &quot;WARNING THIS CLASS IS NOT THREAD SAFE&quot; but the icu javadoc doesn&apos;t really say that, you have to instead read this general architecture document... so I think by pushing the responsibility to the user, there would be lots of bugs (if anyone makes a custom analyzer/factory/etc).&lt;/p&gt;</comment>
                    <comment id="13000578" author="rcmuir" created="Mon, 28 Feb 2011 22:32:58 +0000"  >&lt;p&gt;Updated patch: I clone the JDK ones too.&lt;/p&gt;

&lt;p&gt;Its not really the case that these are &quot;thread-safe&quot;, instead really what happens is their methods are synced (if they are correct). So its good to clone to reduce contention.&lt;/p&gt;

&lt;p&gt;Also i took a look at harmony, which simply wraps the ICU impl and doesn&apos;t sync, which means its not thread safe (but should be).&lt;/p&gt;

&lt;p&gt;For these reasons I think we should just clone the JDK one for safety too.&lt;/p&gt;</comment>
                    <comment id="13000684" author="rcmuir" created="Tue, 1 Mar 2011 03:32:37 +0000"  >&lt;p&gt;i added a testThreadSafe for this issue (which fails without the fix)&lt;/p&gt;</comment>
                    <comment id="13001108" author="rcmuir" created="Tue, 1 Mar 2011 20:49:39 +0000"  >&lt;p&gt;Committed revisions 1075850, 1076017 (branch_3x)&lt;/p&gt;</comment>
                    <comment id="13013400" author="gsingers" created="Wed, 30 Mar 2011 16:50:12 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12472271" name="LUCENE-2943.patch" size="9004" author="rcmuir" created="Tue, 1 Mar 2011 03:32:37 +0000" />
                    <attachment id="12472244" name="LUCENE-2943.patch" size="3120" author="rcmuir" created="Mon, 28 Feb 2011 22:32:58 +0000" />
                    <attachment id="12472224" name="LUCENE-2943.patch" size="1660" author="rcmuir" created="Mon, 28 Feb 2011 20:45:05 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Mon, 28 Feb 2011 20:57:54 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10930</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24749</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>