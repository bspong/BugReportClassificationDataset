<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:06:58 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2213/LUCENE-2213.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2213] Small improvements to ArrayUtil.getNextSize</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2213</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Spinoff from java-dev thread &quot;Dynamic array reallocation algorithms&quot; started on Jan 12, 2010.&lt;/p&gt;

&lt;p&gt;Here&apos;s what I did:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Keep the +3 for small sizes&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Added 2nd arg = number of bytes per element.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Round up to 4 or 8 byte boundary (if it&apos;s 32 or 64 bit JRE respectively)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Still grow by 1/8th&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;If 0 is passed in, return 0 back&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also had to remove some asserts in tests that were checking the actual values returned by this method &amp;#8211; I don&apos;t think we should test that (it&apos;s an impl. detail).&lt;/p&gt;</description>
                <environment></environment>
            <key id="12445644">LUCENE-2213</key>
            <summary>Small improvements to ArrayUtil.getNextSize</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Jan 2010 17:11:32 +0000</created>
                <updated>Fri, 10 May 2013 11:43:46 +0100</updated>
                    <resolved>Thu, 21 Jan 2010 11:57:09 +0000</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12800828" author="creamyg" created="Fri, 15 Jan 2010 18:46:26 +0000"  >&lt;p&gt;Algorithm looks good.  The addition of the mandatory second argument works&lt;br/&gt;
well. Nice work.&lt;/p&gt;

&lt;p&gt;Looks like there&apos;s a typo in the currently unused constant &quot;NUM_BYTES_DOUBLT&quot;.&lt;/p&gt;

&lt;p&gt;As for the tests... Testing that optimizations like these are working properly&lt;br/&gt;
is a pain, so I understand why you zapped &apos;em.  Sometimes inequality or&lt;br/&gt;
proportional testing can work in these situations:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  assertTrue(t.termBuffer().length &amp;gt; t.termLength());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That assertion wouldn&apos;t always hold true for this object, because sometimes&lt;br/&gt;
the term will fill the whole array.  And in a perfect world, you&apos;d want to test that &lt;br/&gt;
each and every array growth happens as expected &amp;#8211; but that&apos;s not practical.  &lt;br/&gt;
Still, in my opinion, a fragile, imperfect test in this situation is OK.&lt;/p&gt;</comment>
                    <comment id="12800901" author="mikemccand" created="Fri, 15 Jan 2010 20:43:12 +0000"  >&lt;p&gt;Thanks Marvin, I fixed the typo.&lt;/p&gt;

&lt;p&gt;I don&apos;t really like that test, since conceivably (though, unlikely) it could fail with a false positive.&lt;/p&gt;

&lt;p&gt;So I made a new test case (TestArrayUtil), which in fact uncovered serious problems with my first patch, due to overflowing int!  Sigh.  I&apos;ve fixed those problems and the test now passes.  The test measures the amortized copying cost over a series of reallocations, and then &lt;span class=&quot;error&quot;&gt;&amp;#91;somewhat arbitrarily&amp;#93;&lt;/span&gt; asserts that the cost per element is less than 10.0 through all reallocations up to size Integer.MAX_INT.&lt;/p&gt;

&lt;p&gt;Also I found one more place where we were assuming ArrayUtil.grow(X) returned the same value regardless of type, which is no longer true.  Amazing how tricky such a low-level utility function is....&lt;/p&gt;</comment>
                    <comment id="12801160" author="dawidweiss" created="Sat, 16 Jan 2010 13:01:02 +0000"  >&lt;p&gt;Not to be picky, Michael, but is long promotion required here? Would it be easier to see if you overflow into negative integers and if so, set to MAX_VALUE?&lt;/p&gt;

&lt;p&gt;Another thing &amp;#8211; given the fact that the parameter is an int, you&apos;ll never be able to grow beyond Integer.MAX_VALUE (because no int value exists). I&apos;d change the contract to reflect this fact &amp;#8211; if the signature takes two parameters (int currentSize, int expectedAdditions) then it&apos;s easy to throw an unchecked exception if you simply can&apos;t meet the contract:&lt;/p&gt;

&lt;p&gt;if (currentSize + expectedAdditions &amp;lt; 0)&lt;br/&gt;
  throw new RuntimeException(&quot;Cannot allocate array larger than: &quot; + Integer.MAX_VALUE);&lt;/p&gt;

&lt;p&gt;When reallocating, you can call it with grow(currentSize, 1), just to make sure the array will be at least one element larger than previously; the method can then make its best effort in estimating the growth ratio, but have a cap on MAX_SIZE before overflowing into negative integers (and avoid looping endlessly when Integer.MAX_VALUE is passed as an input argument).&lt;/p&gt;

&lt;p&gt;These are just thoughts of course &amp;#8211; I&apos;ve just finished implementing something like this for another project...&lt;/p&gt;</comment>
                    <comment id="12801257" author="mikemccand" created="Sat, 16 Jan 2010 19:05:46 +0000"  >&lt;p&gt;Yeah... it&apos;s not great promoting to long.  It&apos;s because of the intermediate computation, to do the byte alignment.  I could instead do that computation back in the &quot;num elements&quot; space... let me try that.  Then I can check for negative ints to catch the overflow.&lt;/p&gt;

&lt;p&gt;Note that the args are different from above &amp;#8211; first arg is &quot;min target size&quot;, ie, this method must return a size &amp;gt;= that requested size.  2nd arg is the element size.  Like calloc.&lt;/p&gt;</comment>
                    <comment id="12801261" author="yseeley@gmail.com" created="Sat, 16 Jan 2010 19:39:47 +0000"  >&lt;p&gt;Instead of masking with 7fff... you can mask with ffff... and let it naturally overflow to a negative.  No need to check the return value, it should then fail immediately when the value is used.&lt;/p&gt;</comment>
                    <comment id="12801278" author="dawidweiss" created="Sat, 16 Jan 2010 21:39:16 +0000"  >&lt;p&gt;What Yonik suggested is yet another alternative, just return negative size and an exception will be thrown elsewhere.&lt;/p&gt;</comment>
                    <comment id="12801368" author="mikemccand" created="Sun, 17 Jan 2010 10:32:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;Instead of masking with 7fff... you can mask with ffff... and let it naturally overflow to a negative&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The thing is, if we blindly add the extra allocation &amp;amp; return, we&apos;ll lose up to 1/8th of the usable size of the array?  Ie we&apos;ll return a negative number when in fact we could have returned MAX_INT and allowed the caller to use the full allowed extent for arrays in java.&lt;/p&gt;</comment>
                    <comment id="12801371" author="dawidweiss" created="Sun, 17 Jan 2010 11:05:00 +0000"  >&lt;p&gt;How about if you assert that minTargetSize is not negative first, then check if minTargetSize + extra is negative, if so, round to the largest possible value that fits within the positive range?&lt;/p&gt;</comment>
                    <comment id="12801375" author="mikemccand" created="Sun, 17 Jan 2010 11:18:19 +0000"  >&lt;p&gt;New rev.  No longer promotes to long (does the rounding in &quot;element&quot; space instead of &quot;bytes&quot; space), uses wraparound on ints (to negative numbers) to detect overflow &amp;amp; return Integer.MAX_VALUE.&lt;/p&gt;</comment>
                    <comment id="12801376" author="mikemccand" created="Sun, 17 Jan 2010 11:19:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;How about if you assert that minTargetSize is not negative first, then check if minTargetSize + extra is negative, if so, round to the largest possible value that fits within the positive range?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s the approach I took in the last patch.&lt;/p&gt;</comment>
                    <comment id="12801394" author="paul.elschot@xs4all.nl" created="Sun, 17 Jan 2010 13:24:52 +0000"  >&lt;p&gt;Perhaps the getNextSize method could be renamed to overAllocate or overAllocateSize.&lt;/p&gt;</comment>
                    <comment id="12801400" author="mikemccand" created="Sun, 17 Jan 2010 13:45:32 +0000"  >&lt;p&gt;I don&apos;t really like overAllocate/overAllocateSize, since this method isn&apos;t actually doing any allocation.  getNextAllocation?  getOverAllocation?  getOverAllocationSize (too verbose?)   Actually I sort of like grow/growth better &amp;#8211; getGrowth?  getNextGrowth?&lt;/p&gt;</comment>
                    <comment id="12801418" author="paul.elschot@xs4all.nl" created="Sun, 17 Jan 2010 15:15:21 +0000"  >&lt;p&gt;Translating from Dutch &apos;groeischeut&apos;:  how about getShootGrowth(fromSize) ?&lt;/p&gt;
</comment>
                    <comment id="12801429" author="yseeley@gmail.com" created="Sun, 17 Jan 2010 16:07:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;The thing is, if we blindly add the extra allocation &amp;amp; return, we&apos;ll lose up to 1/8th of the usable size of the array?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep - depends on what this is being used for.  Some thing you know will never go that high, something you don&apos;t.&lt;br/&gt;
All this generification is super-lightweight for arrays of any kind of size... but if it starts getting used very often for very small arrays, the overhead will start to matter.&lt;/p&gt;</comment>
                    <comment id="12801432" author="creamyg" created="Sun, 17 Jan 2010 16:25:12 +0000"  >&lt;p&gt;Seems like the one permutation of &quot;over&quot; &quot;allocation&quot; and &quot;size&quot; you&apos;ve omitted&lt;br/&gt;
is oversize(minimum, width). (It&apos;s a style thing, but I try to use get* for accessors &lt;br/&gt;
and avoid it elsewhere.)&lt;/p&gt;</comment>
                    <comment id="12801433" author="creamyg" created="Sun, 17 Jan 2010 16:34:35 +0000"  >&lt;p&gt;&amp;gt; if it starts getting used very often for very small arrays, the overhead&lt;br/&gt;
&amp;gt; will start to matter&lt;/p&gt;

&lt;p&gt;I think in most cases usage will only occur after an inequality test, when&lt;br/&gt;
it&apos;s known that reallocation will be occurring.  In my experience, the&lt;br/&gt;
overhead of allocation will tend to swamp this kind of calculation.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (needed &amp;gt; capacity) {
   &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; amount = ArrayUtil.oversize(needed, RamUsageEstimator.NUM_BYTES_CHAR);
   buffer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt;[amount];
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12801434" author="mikemccand" created="Sun, 17 Jan 2010 16:34:38 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Seems like the one permutation of &quot;over&quot; &quot;allocation&quot; and &quot;size&quot; you&apos;ve omitted&lt;br/&gt;
is oversize(minimum, width). (It&apos;s a style thing, but I try to use get* for accessors &lt;br/&gt;
and avoid it elsewhere.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually I like oversize(minimum, width)!&lt;/p&gt;</comment>
                    <comment id="12802331" author="mikemccand" created="Tue, 19 Jan 2010 16:55:54 +0000"  >&lt;p&gt;New patch, just renaming to ArrayUtil.oversize.&lt;/p&gt;</comment>
                    <comment id="12803373" author="thetaphi" created="Thu, 21 Jan 2010 17:26:46 +0000"  >&lt;p&gt;Here a patch that merges the duplicate test class.&lt;/p&gt;</comment>
                    <comment id="12803398" author="mikemccand" created="Thu, 21 Jan 2010 18:11:51 +0000"  >&lt;p&gt;Patch looks good &amp;#8211; I&apos;ll commit.  Thanks Uwe!&lt;/p&gt;</comment>
                    <comment id="12887715" author="shaie" created="Tue, 13 Jul 2010 12:12:57 +0100"  >&lt;p&gt;This somehow found its way to 3x (I believe it was before the branch). And now we have a case where a code is compiled against 3.0.1 and does not run when 3.1 (dev version) is used. I don&apos;t this change on 3.0.2, so perhaps we should just rename it back on the 3x branch?&lt;/p&gt;</comment>
                    <comment id="12887774" author="shaie" created="Tue, 13 Jul 2010 15:30:19 +0100"  >&lt;p&gt;I just noticed it&apos;s lucene.internal so I guess the rename is justified. There is however a deprecated public ctor, which is silly because the class contains nothing but static methods. So why would anyone instantiate it? And why do we go overboard preventing it, by declaring a private ctor ... I think we can just remove the ctor. Any objections?&lt;/p&gt;</comment>
                    <comment id="12887783" author="cmale" created="Tue, 13 Jul 2010 15:52:14 +0100"  >&lt;p&gt;Having a private constructor is a nice way of indicating that the class just contains static methods and will only ever contain static methods.&lt;/p&gt;</comment>
                    <comment id="12887791" author="shaie" created="Tue, 13 Jul 2010 16:06:22 +0100"  >&lt;p&gt;That&apos;s more the methodology w/ the singleton pattern. If we want to achieve what you mention, we can make the class abstract. But really - how stupid do we think our users are? It&apos;s a *Util class w/ static methods - why would they ever instantiate it?&lt;/p&gt;</comment>
                    <comment id="12887795" author="cmale" created="Tue, 13 Jul 2010 16:12:09 +0100"  >&lt;p&gt;Then make it abstract.  My suggestion has nothing to do with user level, but stems from a pattern I see very regularly in code.  But since you seem so vehemently against it, I&apos;ll happily support removing it.&lt;/p&gt;</comment>
                    <comment id="12887801" author="shaie" created="Tue, 13 Jul 2010 16:26:44 +0100"  >&lt;p&gt;I&apos;m not vehemently against anything &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. It&apos;s just that in the rest of our classes (or at least UnicodeUtil, which I was reading few minutes ago) we didn&apos;t follow that behavior, so why with this one?&lt;/p&gt;</comment>
                    <comment id="12887802" author="cmale" created="Tue, 13 Jul 2010 16:29:59 +0100"  >&lt;p&gt;Thats a good question.  Its definitely best to be consistent so if its just this in this class then lets remove it.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12431046" name="LUCENE-2213-mergetest.patch" size="4560" author="thetaphi" created="Thu, 21 Jan 2010 17:26:46 +0000" />
                    <attachment id="12430770" name="LUCENE-2213.patch" size="33101" author="mikemccand" created="Tue, 19 Jan 2010 16:55:54 +0000" />
                    <attachment id="12430545" name="LUCENE-2213.patch" size="33194" author="mikemccand" created="Sun, 17 Jan 2010 11:18:19 +0000" />
                    <attachment id="12430434" name="LUCENE-2213.patch" size="31840" author="mikemccand" created="Fri, 15 Jan 2010 20:43:27 +0000" />
                    <attachment id="12430411" name="LUCENE-2213.patch" size="33462" author="mikemccand" created="Fri, 15 Jan 2010 17:12:18 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 15 Jan 2010 18:46:26 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11574</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25512</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>