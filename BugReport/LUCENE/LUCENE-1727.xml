<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:12:12 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1727/LUCENE-1727.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1727] Order of stored Fields not maintained</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1727</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;As noted in these threads...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.nabble.com/Order-of-fields-returned-by-Document.getFields%28%29-to21034652.html&quot; class=&quot;external-link&quot;&gt;http://www.nabble.com/Order-of-fields-returned-by-Document.getFields%28%29-to21034652.html&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://www.nabble.com/Order-of-fields-within-a-Document-in-Lucene-2.4%2B-to24210597.html&quot; class=&quot;external-link&quot;&gt;http://www.nabble.com/Order-of-fields-within-a-Document-in-Lucene-2.4%2B-to24210597.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;somewhere prior to Lucene 2.4.1 a change was introduced that prevents the Stored fields of a Document from being returned in same order that they were originally added in.  This can cause serious performance problems for people attempting to use LoadFirstFieldSelector or a custom FieldSelector with the LOAD_AND_BREAK, or the SIZE_AND_BREAK options (since the fields don&apos;t come back in the order they expect)&lt;/p&gt;

&lt;p&gt;Speculation in the email threads is that the origin of this bug is code introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1301&quot; title=&quot;Refactor DocumentsWriter&quot;&gt;&lt;del&gt;LUCENE-1301&lt;/del&gt;&lt;/a&gt; &amp;#8211; but the purpose of that issue was refactoring, so if it really is the cause of the change this would seem to be a bug, and not a side affect of a conscious implementation change.&lt;/p&gt;

&lt;p&gt;Someone who understands indexing internals should investigate this.  At a minimum, if it&apos;s decided that this is not actual a bug, then prior to resolving this bug the wiki docs and some of the FIeldSelector javadocs should be updated to make it clear what order Fields will be returned in.&lt;/p&gt;
</description>
                <environment></environment>
            <key id="12429248">LUCENE-1727</key>
            <summary>Order of stored Fields not maintained</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="hossman">Hoss Man</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Jul 2009 01:39:00 +0100</created>
                <updated>Fri, 25 Sep 2009 17:23:28 +0100</updated>
                    <resolved>Thu, 9 Jul 2009 13:54:10 +0100</resolved>
                            <version>2.4</version>
                <version>2.4.1</version>
                                <fixVersion>2.9</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12726098" author="yseeley@gmail.com" created="Wed, 1 Jul 2009 16:02:16 +0100"  >&lt;p&gt;If we start guaranteeing that fields get returned in the same order as they were added, what are the costs?  (I&apos;m not sure there ever was such a guarantee... just because someone added it to the FAQ doesn&apos;t make it so).&lt;/p&gt;

&lt;p&gt;AFAIK, sorting the fields is necessary to group multiple values for the same field, and it also ensured that segments with the same fields had the same field numbers, which enables faster segment merging?&lt;/p&gt;</comment>
                    <comment id="12726103" author="yseeley@gmail.com" created="Wed, 1 Jul 2009 16:14:18 +0100"  >&lt;blockquote&gt;&lt;p&gt;just because someone added it to the FAQ doesn&apos;t make it so&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Of course, I tried to find out when it was added, and it&apos;s been there since the original Apache version.... that&apos;s a long time.  I guess we do need to treat it like a guarantee at this point (which we could break in 3.0 if there is a benefit to doing so).&lt;/p&gt;

&lt;p&gt;It&apos;s a good reminder to avoid documenting how something works as a guarantee that it will always work that way.&lt;/p&gt;</comment>
                    <comment id="12726679" author="hossman" created="Thu, 2 Jul 2009 22:05:53 +0100"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s a good reminder to avoid documenting how something works as a guarantee that it will always work that way.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I remember it being pretty heavily advertised as a feature for as long as i can remember &amp;#8211; it was the entire basis for adding the FieldSelector API.&lt;/p&gt;

&lt;p&gt;Based on McCandless comments in email, it sounds like order was only ever maintained for fields that don&apos;t use term vectors &amp;#8211; in which case the documentation was only ever partially correct.  If it&apos;s possible to fix it to work at least as well as it use to that seems worth while considering how much FieldSelector depends on it.&lt;/p&gt;

&lt;p&gt;(I admit however: it&apos;s kind of scary that it&apos;s been such an implicit assumption but apparently never had a unit test)&lt;/p&gt;</comment>
                    <comment id="12726705" author="yseeley@gmail.com" created="Thu, 2 Jul 2009 23:01:33 +0100"  >&lt;blockquote&gt;&lt;p&gt;it was the entire basis for adding the FieldSelector API.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, something I&apos;m not particularly fond of.  IMO, speeding up loading certain fields should be left to Lucene.  For example, one can think of a simple way to improve the performance of loading only certain fields... instead of&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldnum&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldlength&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldvalue&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;fieldnum&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldlength&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldvalue&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;store it instead as&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldnum&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldlength&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldnum&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldlength&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;fieldvalue&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;fieldvalue&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                    <comment id="12727473" author="mikemccand" created="Mon, 6 Jul 2009 11:54:23 +0100"  >&lt;blockquote&gt;&lt;p&gt;If we start guaranteeing that fields get returned in the same order as they were added, what are the costs?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not yet sure, but I expect it to be a minor added cost; I&apos;ll know more as I dig in.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;AFAIK, sorting the fields is necessary to group multiple values for the same field, and it also ensured that segments with the same fields had the same field numbers, which enables faster segment merging?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually the mapping of field name -&amp;gt; number happens before the sort, so presently we rely on the docs having the same order of fields, to enable bulk merging of stored fields &amp;amp; term vectors.  Bulk merging is really a rather brittle optimization.  Actually we could improve it by only checking for matched name -&amp;gt; numbers for fields that are stored or have term vectors enabled (right now we check that all fields match), and by pre-sorting the field names when doing the mapping to number.&lt;/p&gt;

&lt;p&gt;I plan to just move the stored fields writer up in the indexing chain, so that it receives the in-order list of fields, not the coalesced &amp;amp; sorted list.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Based on McCandless comments in email, it sounds like order was only ever maintained for fields that don&apos;t use term vectors - in which case the documentation was only ever partially correct.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually, order was correctly maintained prior to 2.3.  In 2.3, it was maintained only if you had no term vectors fields (ie, we only sorted when there was at least 1 field w/ term vectors enabled).  In 2.4 we always sort and order was never maintained.  For 2.9 I think we should fix it again so that order is fully maintained.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;For example, one can think of a simple way to improve the performance of loading only certain fields&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that&apos;d be a good improvement to how fields are stored!&lt;/p&gt;</comment>
                    <comment id="12727820" author="mikemccand" created="Mon, 6 Jul 2009 23:37:03 +0100"  >&lt;p&gt;Attached patch.&lt;/p&gt;

&lt;p&gt;I moved StoredFieldsWriter up in the chain, by calling it directly&lt;br/&gt;
from DocFieldProcessor/PerThread, and added a test case showing the&lt;br/&gt;
problem &amp;amp; showing the fix.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12412662" name="LUCENE-1727.patch" size="15672" author="mikemccand" created="Mon, 6 Jul 2009 23:37:03 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>1.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 1 Jul 2009 15:02:16 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12032</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25999</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>