<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:09:54 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2386/LUCENE-2386.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2386] IndexWriter commits unnecessarily on fresh Directory</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2386</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;I&apos;ve noticed IndexWriter&apos;s ctor commits a first commit (empty one) if a fresh Directory is passed, w/ OpenMode.CREATE or CREATE_OR_APPEND. This seems unnecessarily, and kind of brings back an autoCommit mode, in a strange way ... why do we need that commit? Do we really expect people to open an IndexReader on an empty Directory which they just passed to an IW w/ create=true? If they want, they can simply call commit() right away on the IW they created.&lt;/p&gt;

&lt;p&gt;I ran into this when writing a test which committed N times, then compared the number of commits (via IndexReader.listCommits) and was surprised to see N+1 commits.&lt;/p&gt;

&lt;p&gt;Tried to change doCommit to false in IW ctor, but it got IndexFileDeleter jumping on me .. so the change might not be that simple. But I think it&apos;s manageable, so I&apos;ll try to attack it (and IFD specifically !) back &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12461579">LUCENE-2386</key>
            <summary>IndexWriter commits unnecessarily on fresh Directory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.png">Major</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="shaie">Shai Erera</assignee>
                                <reporter username="shaie">Shai Erera</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Apr 2010 20:47:18 +0100</created>
                <updated>Wed, 30 Mar 2011 16:49:57 +0100</updated>
                    <resolved>Thu, 6 May 2010 09:21:34 +0100</resolved>
                                            <fixVersion>3.1</fixVersion>
                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12855131" author="shaie" created="Thu, 8 Apr 2010 21:28:36 +0100"  >&lt;p&gt;Took a look at IndexFileDeleter, and located to offending code segment which is responsible for the IndexCorruptException:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentCommitPoint == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      &lt;span class=&quot;code-comment&quot;&gt;// We did not in fact see the segments_N file
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// corresponding to the segmentInfos that was passed
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// in.  Yet, it must exist, because our caller holds
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// the write lock.  This can happen when the directory
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// listing was stale (eg when index accessed via NFS
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// client with stale directory listing cache).  So we
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; now to explicitly open &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; commit point:
&lt;/span&gt;      SegmentInfos sis = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SegmentInfos();
      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        sis.read(directory, segmentInfos.getCurrentSegmentFileName(), codecs);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CorruptIndexException(&lt;span class=&quot;code-quote&quot;&gt;&quot;failed to locate current segments_N file&quot;&lt;/span&gt;);
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looks like this code protects against a real problem, which was raised on the list a couple of times already - stale NFS cache. So I&apos;m reluctant to remove that check ... thought I still think we should differentiate between a newly created index on a fresh Directory, to a stale NFS problem. Maybe we can pass a boolean isNew or something like that to the ctor, and if it&apos;s a new index and the last commit point is missing, IFD will not throw the exception, but silently ignore that? So the code would become something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (currentCommitPoint == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !isNew) {
       ....
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does this make sense, or am I missing something?&lt;/p&gt;</comment>
                    <comment id="12855135" author="mikemccand" created="Thu, 8 Apr 2010 21:39:06 +0100"  >&lt;p&gt;I agree: IW really should not commit the first segments_1, for CREATE when Dir has no index already.  App should immediately .commit() if it really wants to.&lt;/p&gt;

&lt;p&gt;We should fix IFD to know if it&apos;s dealing with a &quot;known new&quot; index and bypass that check that works around stale NFS dir listing (boolean arg sounds good).&lt;/p&gt;</comment>
                    <comment id="12855148" author="shaie" created="Thu, 8 Apr 2010 22:00:46 +0100"  >&lt;p&gt;Looking at IFD again, I think a boolean ctor arg is not required. What I can do is check if any Lucene file has been seen (in the for-loop iteration on the Directory files), and if not, then deduce it&apos;s a new Directory, and skip that &apos;if&apos; check. I&apos;ll give it a shot.&lt;/p&gt;</comment>
                    <comment id="12855184" author="shaie" created="Thu, 8 Apr 2010 23:08:10 +0100"  >&lt;p&gt;First stab at this. Patch still missing CHANGES entry, and I haven&apos;t run all the tests, just TestIndexWriter. With those changes it passes. One thing that I think should be fixed is testImmediateDiskFull - if I don&apos;t add writer.commit(), the test fails, because dir.getRecomputeActualSizeInBytes returns 0 (no RAMFiles yet), and then the test succeeds at adding one document. So maybe just change the test to set maxSizeInBytes to &apos;1&apos;, always?&lt;/p&gt;

&lt;p&gt;TestNoDeletionPolicy is not covered by this patch (should be fixed as well, because now the number of commits is exactly N and not N+1). Will fix it tomorrow.&lt;/p&gt;

&lt;p&gt;Anyway, it&apos;s really late now, so hopefully some fresh eyes will look at it while I&apos;m away, and comment on the proposed changes. I hope I got all the changes to the tests right.&lt;/p&gt;</comment>
                    <comment id="12855215" author="mikemccand" created="Fri, 9 Apr 2010 01:01:00 +0100"  >&lt;p&gt;I think the patch is good Shai.  I&apos;d be curious what other tests rely on an immediate commit on creating an index....&lt;/p&gt;

&lt;p&gt;Maybe change testImmediateDiskFull to set max allowed size to max(1, current-usage)?  In case we change IW to write other stuff in the future on create...&lt;/p&gt;</comment>
                    <comment id="12855265" author="shaie" created="Fri, 9 Apr 2010 04:49:20 +0100"  >&lt;blockquote&gt;&lt;p&gt;Maybe change testImmediateDiskFull to set max allowed size to max(1, current-usage)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good idea ! Did it and it works.&lt;/p&gt;

&lt;p&gt;Now ... one thing I haven&apos;t mentioned is the bw break. This is a behavioral bw break, which specifically I&apos;m not so sure we should care about, because I wonder how many apps out there rely on being able to open a reader before they ever commited on a fresh new index. So what do you think - do this change anyway, OR ... utilize Version to our aid? I.e., if the Version that was passed to IWC is before LUCENE_31, we keep the initial commit, otherwise we don&apos;t do it? Pros is that I won&apos;t need to change many of the tests because they still use the LUCENE_30 version (but that is not a strong argument), so it&apos;s a weak Pro. Cons is that IW will keep having that doCommit handling in its ctor, only now w/ added comments on why this is being kept around etc.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                    <comment id="12855277" author="shaie" created="Fri, 9 Apr 2010 06:31:43 +0100"  >&lt;p&gt;Apparently, there are more tests that fail ... lost count but easy fixing. I tried writing the following test:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testNoCommits() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
    &lt;span class=&quot;code-comment&quot;&gt;// Tests that &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we don&apos;t call commit(), the directory has 0 commits. This has
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// changed since LUCENE-2386, where before IW would always commit on a fresh
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; index.
&lt;/span&gt;    Directory dir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RAMDirectory();
    IndexWriter writer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriter(dir, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IndexWriterConfig(TEST_VERSION_CURRENT, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WhitespaceAnalyzer(TEST_VERSION_CURRENT)));
    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;expected 0 commits!&quot;&lt;/span&gt;, 0, IndexReader.listCommits(dir).size());
    &lt;span class=&quot;code-comment&quot;&gt;// No changes still should generate a commit, because it&apos;s a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; index.
&lt;/span&gt;    writer.close();
    assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;expected 1 commits!&quot;&lt;/span&gt;, 0, IndexReader.listCommits(dir).size());
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Simple test - validates that no commits are present following a freshly new index creation, w/o closing or committing. However, IndexReader.listCommits fails w/ the following exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.io.FileNotFoundException: no segments* file found in org.apache.lucene.store.RAMDirectory@2d262d26: files: []
	at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:652)
	at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:535)
	at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:323)
	at org.apache.lucene.index.DirectoryReader.listCommits(DirectoryReader.java:1033)
	at org.apache.lucene.index.DirectoryReader.listCommits(DirectoryReader.java:1023)
	at org.apache.lucene.index.IndexReader.listCommits(IndexReader.java:1341)
	at org.apache.lucene.index.TestIndexWriter.testNoCommits(TestIndexWriter.java:4966)
       ....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The failure occurs when SegmentInfos attempts to find segments.gen and fails. So I wonder if I should fix DirectoryReader to catch that exception and simply return an empty Collection .. or I should fix SegmentInfos at this point &amp;#8211; notice the &quot;files: []&quot; at the end - I think that by adding a check to the following code (SegmentInfos, line 652) which validates that there were any files before throwing the exception, it&apos;ll still work properly and safely (i.e. to detect a problematic Directory). Will need probably to break away from the while loop and I guess fix some other things in upper layers ... therefore I&apos;m not sure if I should not simply catch that exception in DirectoryReader.listCommits w/ proper documentation and be done w/ it. After all, it&apos;s not supposed to be called ... ever? or hardly ever?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (gen == -1) {
            &lt;span class=&quot;code-comment&quot;&gt;// Neither approach found a generation
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileNotFoundException(&lt;span class=&quot;code-quote&quot;&gt;&quot;no segments* file found in &quot;&lt;/span&gt; + directory + &lt;span class=&quot;code-quote&quot;&gt;&quot;: files: &quot;&lt;/span&gt; + Arrays.toString(files));
          }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12855333" author="mikemccand" created="Fri, 9 Apr 2010 11:07:39 +0100"  >&lt;blockquote&gt;&lt;p&gt;This is a behavioral bw break, which specifically I&apos;m not so sure we should care about, because I wonder how many apps out there rely on being able to open a reader before they ever commited on a fresh new index.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m inclined to just break it (w/o a version switch) &amp;#8211; really this is almost a bug, in that autoCommit is false and so IW should make no commits to the index unless you ask it to.&lt;/p&gt;

&lt;p&gt;We should try to contain the amount of switching we do based on Version.XXX, only using it to match behavior in cases where it can do alot of harm (eg the change alters what&apos;s indexed).  This change doesn&apos;t fit that, ie, all the app has to do (if it really cares) is call IW.commit() immediately on creating the index.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;However, IndexReader.listCommits fails w/ the following exception&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should catch the exception in DirReader.listCommits (where it tries to load latest) and simply return empty collection?&lt;/p&gt;</comment>
                    <comment id="12855344" author="shaie" created="Fri, 9 Apr 2010 11:53:16 +0100"  >&lt;p&gt;Ok I&apos;ve added the following to DirReader:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      latest.read(dir, codecs);
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (FileNotFoundException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e.getMessage().startsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;no segments* file found in&quot;&lt;/span&gt;)) {
        &lt;span class=&quot;code-comment&quot;&gt;// Might be that the Directory is empty, in which &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; just &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; an
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// empty collection.
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.emptyList();
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And now that test passes.&lt;/p&gt;

&lt;p&gt;I&apos;ll continue discovering tests that fail ... probably backwards will have its share too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                    <comment id="12855360" author="earwin" created="Fri, 9 Apr 2010 13:04:02 +0100"  >&lt;p&gt;I&apos;m at loss for words. No, seriously, basing your logic on the content of user-targeted error message?&lt;/p&gt;

&lt;p&gt;Btw, opening DirectoryReader on an empty directory fails with exception too. That&apos;s why some people might do this before opening - &quot;new IW().close()&quot;, like I did.&lt;br/&gt;
While trivial to fix, this has to be fixed, or an app breaks when started with an empty index directory.&lt;/p&gt;</comment>
                    <comment id="12855364" author="mikemccand" created="Fri, 9 Apr 2010 13:14:29 +0100"  >&lt;p&gt;How about we subclass FNFE?  Eg &quot;NoSegmentsFileException&quot; or something, thrown by SegmentInfos.read and caught in IR.listCommits?&lt;/p&gt;</comment>
                    <comment id="12855369" author="shaie" created="Fri, 9 Apr 2010 13:31:51 +0100"  >&lt;p&gt;I already did that ... just didn&apos;t post back. Created SegmentsFileNotFoundException.&lt;/p&gt;</comment>
                    <comment id="12855390" author="shaie" created="Fri, 9 Apr 2010 14:40:48 +0100"  >&lt;p&gt;Patch fixes all tests as well as changes to IndexWriter, IndexFileDeleter, DirectoryReader and SegmentInfos.&lt;/p&gt;

&lt;p&gt;I&apos;d like to commit this shortly, before all the files get changed by a malicious other commit &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. (kidding of course)&lt;/p&gt;</comment>
                    <comment id="12855421" author="mikemccand" created="Fri, 9 Apr 2010 15:55:14 +0100"  >&lt;p&gt;Patch looks good!&lt;/p&gt;

&lt;p&gt;Hmm... maybe we should rename SegmentsFileNotFoundException to IndexNotFoundException?  Ie make it more consumable to outside apps (who should know nothing about what a segments file is).  And, move it to its own source file?&lt;/p&gt;</comment>
                    <comment id="12855457" author="shaie" created="Fri, 9 Apr 2010 17:23:54 +0100"  >&lt;p&gt;Ok sounds good. Is there a preferred package for exceptions? Or is o.a.l.index ok?&lt;/p&gt;</comment>
                    <comment id="12855470" author="mikemccand" created="Fri, 9 Apr 2010 17:50:57 +0100"  >&lt;p&gt;I think oal.index is good.&lt;/p&gt;</comment>
                    <comment id="12855676" author="shaie" created="Sun, 11 Apr 2010 05:28:30 +0100"  >&lt;p&gt;Patch updated to latest rev. + the proposed name change &amp;#8211; IndexNotFoundException. All tests pass. I plan to commit this later today.&lt;/p&gt;</comment>
                    <comment id="12855708" author="shaie" created="Sun, 11 Apr 2010 12:27:21 +0100"  >&lt;p&gt;Committed revision 932868.&lt;/p&gt;</comment>
                    <comment id="12855726" author="shaie" created="Sun, 11 Apr 2010 15:24:43 +0100"  >&lt;p&gt;As I indicated in an email, Solr tests failed (sorry for not running them before). After some investigation (thanks Robert !), that&apos;s the problem: before this change, IW always committed first on an empty directory. It called SegmentInfos.commit(dir), which by a chain of calls ensured the directory exists (in FSDir) by calling file.mkdirs().&lt;/p&gt;

&lt;p&gt;After this change, that chain of calls did not happen ... yet somehow tests we still passing for Lucene. Some investigation shows that the Solr tests that failed used SingleInstanceLockFactory, or NoLockFactory. By default, FSDir uses either SimpleFSLF or NativeFSLF. The IW.ctor calls LF.makeLock and obtain, which for these two LFs meant that calling file.mkdirs ... and thus the problem was hidden. SingleInstanceLF and NoLF don&apos;t do that !&lt;/p&gt;

&lt;p&gt;So first, a test which uses FSDir and one of these LFs need to be created, so we catch that problem in Lucene code (this is not related to Solr &amp;#8211; just a missing test in Lucene). Second we need to fix IW ctor, or Dir or whatever.&lt;/p&gt;

&lt;p&gt;I&apos;ve added that code to IW.ctor, as a sanity check to make sure it works - and indeed all Solr tests pass. So that&apos;s one option, even though a bit messy.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
  directory.createOutput(&lt;span class=&quot;code-quote&quot;&gt;&quot;temp&quot;&lt;/span&gt;).close();
} &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
  directory.deleteFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;temp&quot;&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another option is to add to Directory a prepareForWrite() or simply prepare() which will be called by IW. A default empty impl on Directory, and file.mkdirs on FSDirectory should be enough.&lt;/p&gt;

&lt;p&gt;A third option is to define clear semantics for dir.listAll(), to throw a NoSuchDirectoryException and then change IndexFileDeleter to ignore that exception if OpenMode of IW is CREATE*. It kind of makes sense - if the directory is empty, why bother looking for any index files. Lucene code today already expects that exception to be thrown in SegmentInfos.getCurrentSegmentGeneration &amp;#8211; so we kind of say &apos;either you use RAMDirectory, or a sub-class of FSDirectory, and then that&apos;s what we expect&apos;. So it&apos;s not so much of a backwards change ...&lt;/p&gt;

&lt;p&gt;While dir.prepare() or prepareForWrite() is very explicit ... it&apos;s not protective enough - one can still call listAll w/o calling prepareForWrite (why would you call it if you just want to list files) so I&apos;m not sure which is the best option ... Maybe the last option is the best as at least the caller should not assume anything about the state of the directory. Just prepare to handle the NoSuchDirectoryException, vs. &apos;there is a directory but it&apos;s empty&apos; case.&lt;/p&gt;

&lt;p&gt;I&apos;ll revert my commit until this is resolved.&lt;/p&gt;</comment>
                    <comment id="12855727" author="shaie" created="Sun, 11 Apr 2010 15:35:46 +0100"  >&lt;p&gt;Committed revision 932917 for the revert.&lt;/p&gt;</comment>
                    <comment id="12855732" author="markrmiller@gmail.com" created="Sun, 11 Apr 2010 15:55:29 +0100"  >&lt;p&gt;Is this change worth it with all of its repercussions? What are the upsides? There do appear to be downsides...&lt;/p&gt;</comment>
                    <comment id="12855735" author="shaie" created="Sun, 11 Apr 2010 16:00:58 +0100"  >&lt;p&gt;Fixes IndexFileDeleter, adds a proper test to TestIndexWriter. Haven&apos;t run all the tests yet though, but the added test passes now with the fix.&lt;/p&gt;</comment>
                    <comment id="12855738" author="mikemccand" created="Sun, 11 Apr 2010 16:06:19 +0100"  >&lt;p&gt;I like the fix (catching the NoSuchDirectoryException in IFD), but, can you shrink wrap that try/catch?  Ie just have the try/catch around the Dir.listAll call.&lt;/p&gt;

&lt;p&gt;I do think this is a good change &amp;#8211; IW was previously inconsistent, first that it would even make a commit when we no longer have an &quot;autoCommit=true&quot;, and, second, that it would not make the commit for a directory that already had an index (we fixed this case a while back).  So I like that this fix makes IW&apos;s init behavior more consistent / simpler.&lt;/p&gt;</comment>
                    <comment id="12855739" author="thetaphi" created="Sun, 11 Apr 2010 16:08:08 +0100"  >&lt;p&gt;I dont understand the whole issue, too.&lt;/p&gt;

&lt;p&gt;For me it is perfectly fine, if I open an IndexWriter with create=true, that the index is created empty first. This has the big advantage, that IndexReaders can open it and will not fail with not found. OK this can be done by a commit directly after creating, but for such code like &quot;create indexwriter with create=true if not exist else append&quot;, this is more work to do.&lt;/p&gt;

&lt;p&gt;The question is also, what happens if you call IndexWriter.getReader() without the initial commit? Does this work with your patch?&lt;/p&gt;

&lt;p&gt;For me this patch is to heavy for the small improvement, and its a behaviour change and no real bug.&lt;/p&gt;</comment>
                    <comment id="12855740" author="markrmiller@gmail.com" created="Sun, 11 Apr 2010 16:09:09 +0100"  >&lt;blockquote&gt;&lt;p&gt;I do think this is a good change - IW was previously inconsistent, first that it would even make a commit when we no longer have an &quot;autoCommit=true&quot;, and, second, that it would not make the commit for a directory that already had an index (we fixed this case a while back). So I like that this fix makes IW&apos;s init behavior more consistent / simpler.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thats not a very strong argument for a back compat break on a minor release though...&lt;/p&gt;</comment>
                    <comment id="12855747" author="mikemccand" created="Sun, 11 Apr 2010 17:33:22 +0100"  >&lt;p&gt;Actually I consider this a bug in IW&apos;s ACID transactional semantics...&lt;/p&gt;

&lt;p&gt;The &quot;I&quot; in ACID is &quot;isolation&quot;, meaning, a reader shouldn&apos;t ever see&lt;br/&gt;
uncommitted changes from a writer.&lt;/p&gt;

&lt;p&gt;This bug breaks &quot;isolation&quot;, ie, if you open with CREATE, today, IW&lt;br/&gt;
may or may not slip in a commit on you, depending (rather&lt;br/&gt;
unexpectedly, and likely the opposite of what you&apos;d guess) on whether&lt;br/&gt;
a prior index is already there.&lt;/p&gt;

&lt;p&gt;So IW sometimes will break ACID transactions, and sometimes not, if&lt;br/&gt;
you use CREATE.&lt;/p&gt;

&lt;p&gt;Further, IW really shouldn&apos;t ever write a commit &quot;automatically&quot; &amp;#8211; it&lt;br/&gt;
used to do this (with autoCommit=true), but we stopped doing so&lt;br/&gt;
(except for this bug), now that autoCommit is false.&lt;/p&gt;

&lt;p&gt;With this fix, IW will never sneak in a commit.  Your app fully&lt;br/&gt;
controls when the transaction (including CREATE, which in Lucene,&lt;br/&gt;
unlike most RDMBSs, is part of the transaction) becomes visible.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Thats not a very strong argument for a back compat break on a minor release though...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmmm... I think the back compat break is very minor.  Also, IW&apos;s&lt;br/&gt;
now-gone autoCommit never &quot;promised&quot; when commits would be made, so&lt;br/&gt;
this was really undocumented behavior.&lt;/p&gt;

&lt;p&gt;Solr&apos;s test failures were not due to this break; they we actually due&lt;br/&gt;
to a sneaky bug that otherwise (had we not had Solr&apos;s tests) would&lt;br/&gt;
likely have remained undiscovered for quite some time.&lt;/p&gt;

&lt;p&gt;And, much of the &quot;noise&quot; in the patch is from tests relying on exact&lt;br/&gt;
file names, commit counts, etc.  Plus some of the usual Shai-cleanups &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I guess if we really care to, we can emulate the &quot;not quite ACID&quot; bug&lt;br/&gt;
when Version &amp;lt;= 3.1?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The question is also, what happens if you call IndexWriter.getReader() without the initial commit? Does this work with your patch?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This should be perfectly fine &amp;#8211; you&apos;ll get a reader searching 0 docs.&lt;/p&gt;

&lt;p&gt;Shai can you add a test case confirming this?&lt;/p&gt;

&lt;p&gt;Shai a couple other things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Please shrink-wrap the try/except in IFD&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In Directory.listCommits, instead of catching&lt;br/&gt;
    IndexNotFoundException and returning empty list, I think we should&lt;br/&gt;
    throw it?  You get this exception today, right?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12855748" author="markrmiller@gmail.com" created="Sun, 11 Apr 2010 17:37:58 +0100"  >&lt;blockquote&gt;&lt;p&gt;Hmmm... I think the back compat break is very minor&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes - it is - but so was the argument for it IMO.&lt;/p&gt;

&lt;p&gt;Your extended argument is more compelling though.&lt;/p&gt;</comment>
                    <comment id="12855750" author="mikemccand" created="Sun, 11 Apr 2010 17:50:57 +0100"  >&lt;p&gt;Shai I think you should also check Solr&apos;s spellchecker index to make sure it won&apos;t be affected by this not-ACID bug?  (And add an IW.commit to fix it, if so...).&lt;/p&gt;</comment>
                    <comment id="12855752" author="yseeley@gmail.com" created="Sun, 11 Apr 2010 17:57:12 +0100"  >&lt;p&gt;I think Solr&apos;s spellchecker should be OK.&lt;br/&gt;
It builds the index in one go, so there shouldn&apos;t be open IndexWriters hanging around.&lt;/p&gt;

&lt;p&gt;If the spellchecker does manage to break, I imagine it would be a bug in the spellchecker (concurrency related... like what happens when one thread is building the spellcheck index and another thread comes along and tries to do a spellcheck request, etc)&lt;/p&gt;</comment>
                    <comment id="12855767" author="shaie" created="Sun, 11 Apr 2010 20:20:18 +0100"  >&lt;p&gt;About IndexReader.listCommits ... the javadocs state this &quot;There must be at least one commit in the Directory, else this method throws java.io.IOException.&quot;. So I&apos;ll change it to reflect the right exception type is thrown (IndexNotFoundException) and revert the change to DirReader.listCommits which returns an empty list.&lt;/p&gt;</comment>
                    <comment id="12855769" author="shaie" created="Sun, 11 Apr 2010 20:51:54 +0100"  >&lt;p&gt;Patch w/ proposed fixes. All tests pass, including Solr&apos;s &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                    <comment id="12855786" author="mikemccand" created="Sun, 11 Apr 2010 23:12:19 +0100"  >&lt;p&gt;Patch looks good... thanks Shai.&lt;/p&gt;

&lt;p&gt;I think the only open question is whether we should emulate the &quot;not quite ACID&quot; bug if Version &amp;lt; LUCENE_31?&lt;/p&gt;

&lt;p&gt;I don&apos;t think it&apos;s necessary (but we should advertise this in back-compat breaks in CHANGES).... anyone else?&lt;/p&gt;</comment>
                    <comment id="12855791" author="earwin" created="Mon, 12 Apr 2010 00:16:33 +0100"  >&lt;p&gt;I don&apos;t see why this should be &quot;fixed&quot;.&lt;br/&gt;
If IndexWriter slips in a commit on an empty directory for you, that&apos;s not a commit per ce, it&apos;s an initialization of directory to be recognized as a valid index (exactly what you are asking with Mode.CREATE parameter).&lt;/p&gt;

&lt;p&gt;What is now a correct way of opening IndexReader on a directory that may, or may not be there?&lt;br/&gt;
With current behaviour I create an IW in CREATE_OR_APPEND mode, and it guarantees that consequent IR.open() will get something it recognizes as the index.&lt;/p&gt;</comment>
                    <comment id="12855792" author="thetaphi" created="Mon, 12 Apr 2010 00:29:58 +0100"  >&lt;p&gt;Thanks Earwin, thats exactly my opinion, too. For me the whole behaviour is defined and correct. The create param in the ctor is just an initialization of the directory to be a defined index (empty at the beginning).&lt;/p&gt;

&lt;p&gt;Maybe we should remove the create param from IndexWriter ctor/config at all, and just define a static utility method in IW, that &quot;initializes&quot; an empty directory. The standard ctors in IW then should thow IndexNotFound if the directory is not yet initialized. This way, we dont need those strange create params.&lt;/p&gt;</comment>
                    <comment id="12855793" author="earwin" created="Mon, 12 Apr 2010 00:36:36 +0100"  >&lt;p&gt;The mode in ctor is perfectly fine. Remove it, and everyone&apos;s gonna end up writing the very code you remove, in seven different ways, five of them broken somehow.&lt;/p&gt;</comment>
                    <comment id="12855870" author="shaie" created="Mon, 12 Apr 2010 08:19:46 +0100"  >&lt;p&gt;I&apos;m not sure if we&apos;re arguing about the same thing here ... why when I open an IW on empty Directory I need an empty segment that&apos;s created, and from now on never changed, populated or even read? That just seems wrong to me ... when I fixed the tests to not rely on the buggy behavior, I noticed several which count the list of commits (especially the IDP ones) w/ a documentation like &quot;1 for opening + N for committing&quot; ...&lt;/p&gt;

&lt;p&gt;It just looks weird that when you open IW a commit happens, a set of empty files are created, but from now on they are never modified, until IDP kicks in, after the second commit ... it&apos;s nothing like initing the Directory to be able to receive input ..&lt;/p&gt;

&lt;p&gt;And I don&apos;t know what&apos;s the benefit of doing &quot;new IW()&quot; following by &quot;IR.open()&quot; ... that IR will always see 0 documents, until you call reopen (if commit happened in between). So what&apos;s the convenience here? that your code can call IR.open once, and from that point forward just &apos;reopen()&apos;? That seems low advantage to me, really. Maybe what we should do is fix IR.open to return a null IR in case the directory hasn&apos;t been populated w/ anything yet. Then you can check easily if you should call open() (==null) or reopen (otherwise). Or create a blank stub of IR which emulates an empty Dir, and when reopen is called works well (if the Directory is not empty now) ...&lt;/p&gt;

&lt;p&gt;BTW, FWIW, Solr&apos;s code did not break from this change at all ... it was the combination of FSDir and NoLF/SingleInstanceLF that broke some tests that used it ... I don&apos;t know how many apps out there are using that combination, but I&apos;d bet it&apos;s small? I use that combination, however in my case an IR is opened only after a commit signal/event is raised (so I don&apos;t check isCurrent often or attempt to reopen()). What I&apos;m trying to say is that this combination is dangerous, and the application needs to ensure that only one IW is open at any given time, and I&apos;m sure such apps are more sophisticated then opening IW and then IR just for the convenience of it.&lt;/p&gt;</comment>
                    <comment id="12855889" author="earwin" created="Mon, 12 Apr 2010 09:55:16 +0100"  >&lt;p&gt;Meh, that all is just a matter of perspective.&lt;/p&gt;

&lt;p&gt;It doesn&apos;t look weird for me that an empty commit happens. Go, create some SVN repository - it has initial #0 commit inside. I bet all version control systems and all databases have the concept of null initial commit.&lt;br/&gt;
This empty commit is what discerns empty existing directory from empty lucene index. If you create some docs, index them, then delete and commit, you&apos;re going to get just the same picture - a directory with a single segments* file (only generation number will differ).&lt;/p&gt;

&lt;p&gt;And references to &quot;but from now on they are never modified&quot; are just weird - it&apos;s a Lucene index dammit, no files are ever modified here.&lt;/p&gt;

&lt;p&gt;But, what looks &lt;b&gt;really&lt;/b&gt; weird to me is suggestions like&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Then you can check easily if you should call open() (==null) or reopen (otherwise). Or create a blank stub of IR which emulates an empty Dir, and when reopen is called works well (if the Directory is not empty now) ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;adding complexity and workarounds to plug a hole that didn&apos;t exist before the &quot;fix&quot; that does essentially nothing of value.&lt;/p&gt;

&lt;p&gt;My question is still unanswered - what is the proper way (after this fix) to open an IR over possibly-empty directory? My app, for example, opens an IR and does scheduled reopens. The time interval is small, a reopen over unmodified index is a noop, so this is all beautifully simple and just as effective as waiting for a commit event (like I did in the past, just like you). It opens an IndexWriter with CREATE_OR_APPEND mode before opening the first reader, and is thus guaranteed to have a good index directory regardless of the situation.&lt;br/&gt;
Immediate fix I see is to check whether the directory is empty and do a first empty commit myself - UGLY.&lt;/p&gt;</comment>
                    <comment id="12855890" author="earwin" created="Mon, 12 Apr 2010 09:56:00 +0100"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m sure such apps are more sophisticated then opening IW and then IR just for the convenience of it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sophistication is a sin &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="12855892" author="shaie" created="Mon, 12 Apr 2010 10:08:10 +0100"  >&lt;blockquote&gt;&lt;p&gt;what is the proper way (after this fix) to open an IR over possibly-empty directory? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You can simply call commit() immediately after you open IW. If that&apos;s what you need then it will work for you.&lt;/p&gt;

&lt;p&gt;You&apos;re right that if I add docs, deletes and them commits, I&apos;ll get an empty segment. So is if you do &quot;new IW()&quot; and then &quot;iw.close()&quot; w/ no addDocument in between. The point here was that we should not create a commit unless the user has specifically asked for it. Calling close() means asking for a commit, per close semantics and contract. But if the app called new IW, add docs and crashed in the middle, the Directory will still remain empty ... which is sort of what, IMO, should happen.&lt;/p&gt;

&lt;p&gt;I agree it&apos;s a matter of perspective. I think that when autoCommit was removed, so should have been this code. I don&apos;t know if it was left behind for a good reason, or simply because when someone tried to do it, he found out it&apos;s not that simple (like I have &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                    <comment id="12855899" author="earwin" created="Mon, 12 Apr 2010 10:19:49 +0100"  >&lt;blockquote&gt;&lt;p&gt;The point here was that we should not create a commit unless the user has specifically asked for it.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Isn&apos;t opening IW with CREATE* mode called &quot;specifically asking for&quot;?&lt;br/&gt;
If he doesn&apos;t need this functionality, he uses another mode, that simple.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But if the app called new IW, add docs and crashed in the middle, the Directory will still remain empty ... which is sort of what, IMO, should happen.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Why so? Please, read my reference to version control systems and databases - they all leave behind an initialized database if the first commit fails.&lt;/p&gt;

&lt;p&gt;My point is that the feature is immediately usable and saves people from writing (possibly buggy) emptiness-detection-then-commit code over and over again.&lt;/p&gt;</comment>
                    <comment id="12855924" author="shaie" created="Mon, 12 Apr 2010 12:26:25 +0100"  >&lt;p&gt;I don&apos;t think that people need to write that &quot;emptiness-detection-then-commit&quot; code ... if they care, they can simply immediately call commit() after they open IW.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Isn&apos;t opening IW with CREATE* mode called &quot;specifically asking for&quot;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It depends on how you interpret the mode ... for example, you cannot pass OpenMode.APPEND for an empty Directory, because IW throws an exception. The modes are just meant to tell IW how to behave:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;APPEND - I know there is an index in the Directory, and I&apos;d like to append to it.&lt;/li&gt;
	&lt;li&gt;CREATE - I don&apos;t care if there is an index in the Directory &amp;#8211; create a new one, zeroing out all segments.&lt;/li&gt;
	&lt;li&gt;CREATE_OR_APPEND - If there is an index, open it, otherwise create a new one.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So if you pass CREATE on an already populated index, IW doesn&apos;t do the implicit commit, until you call commit() yourself. But if you pass CREATE on an empty index, IW suddenly calls commit()? That&apos;s just an inconsistency that&apos;s meant to allow you to open an IR immediately after &quot;new IW()&quot; call, irregardless of what was there? And if you open that IR, then if the index was populated you see the previous set of documents, but if it wasn&apos;t you see nothing, even though you meant to say &quot;override what&apos;s there&quot;?&lt;/p&gt;

&lt;p&gt;I&apos;ve checked what FileOutputStream does, using the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
File file = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(&lt;span class=&quot;code-quote&quot;&gt;&quot;d:/temp/tmpfile&quot;&lt;/span&gt;);
FileOutputStream fos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(file);
fos.write(3);
fos.close();
	  
fos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileOutputStream(file);
FileInputStream fis = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FileInputStream(file);
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(fis.read());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;Second line creates an empty file immediately, not waiting for close() or flush() &amp;#8211; which resembles the behavior that you&apos;re suggesting we should take w/ IW (which is the &apos;today&apos;s behavior&apos;)&lt;/li&gt;
	&lt;li&gt;Forth line closes the file, flushing and writing the content.&lt;/li&gt;
	&lt;li&gt;Fifth line &lt;b&gt;recreates&lt;/b&gt; the file, empty, again, w/o calling close. So it zeros out the file content immediately, even before you wrote a single piece of byte to it.&lt;/li&gt;
	&lt;li&gt;Sixth+Seventh line proves it by attempting to read from the file, and the output printed is -1.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve wrapped the FOS w/ a BufferedOS and the behavior is still the same. So I&apos;m trying to show is that we don&apos;t fully adhere to the CREATE mode, and rightfully if you ask me - we shouldn&apos;t zero out the segments until the application called commit(). But we choose to adhere differently to the CREATE* mode if the index is already populated. That&apos;s an inconsistent behavior, at least in my perspective. It&apos;s also harder to explain and document, e.g. &quot;you should call commit() if you used CREATE, in case you want to zero out everything immediately, and the Directory is not empty, but you don&apos;t need to call commit() if the directory was empty, Lucene will do it for you.&quot; &amp;#8211; so now how will the app know if it should call commit()? It will need to write a sort of &quot;emptiness-detection-then-commit&quot;?&lt;/p&gt;

&lt;p&gt;I am willing to consider the following semantics:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;APPEND - assumes an index exists and open it.&lt;/li&gt;
	&lt;li&gt;CREATE - zeros out everything that&apos;s in the directory &lt;b&gt;immediately&lt;/b&gt;, and also prepares an empty directory.&lt;/li&gt;
	&lt;li&gt;CREATE_OR_APPEND - either loads an existing index, or is able to work on the empty directory. No implicit commit is happening by IW if the index does not exist.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But I think CREATE is too dangerous, and so I prefer to stick w/ the proposed change to the patch so far &amp;#8211; if you open an index in CREATE*, you should call commit before you can read it. That will adhere to the semantics of what the application wanted, whether it meant to zero out an existing Directory, or create a new one from scratch.&lt;/p&gt;</comment>
                    <comment id="12855937" author="earwin" created="Mon, 12 Apr 2010 13:04:18 +0100"  >&lt;blockquote&gt;&lt;p&gt;So if you pass CREATE on an already populated index, IW doesn&apos;t do the implicit commit, until you call commit() yourself. But if you pass CREATE on an empty index, IW suddenly calls commit()? &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Empty directory &lt;b&gt;is not&lt;/b&gt; an empty index. It is just an empty directory. That first commit initializes empty directory to an empty index. Seems this is the core of our misagreement.&lt;/p&gt;</comment>
                    <comment id="12855961" author="earwin" created="Mon, 12 Apr 2010 14:36:31 +0100"  >&lt;p&gt;I&apos;m surrendering the issue, any outcome doesn&apos;t warrant the time spent discussing it.&lt;br/&gt;
My conclusions are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I see no profit in this change. That may be different for others.&lt;/li&gt;
	&lt;li&gt;I see some harm done, but it is limited. new IW().close() approach used by many people continues to work. People who open both IR and IW upfront and keep them during app lifetime (like me) have to add a single line to their code. Being an avid enemy of backwards compatibility, I don&apos;t care &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;The core of misagreement behind the issue rests on whether to treat &quot;create index&quot; as a transaction or not. It can go both ways.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12856022" author="mikemccand" created="Mon, 12 Apr 2010 16:30:25 +0100"  >&lt;p&gt;Shai, can you also test CREATE on an empty index and then&lt;br/&gt;
IW.rollback()?  IW should remove all files it created, never having&lt;br/&gt;
made anything visible to an outside reader.&lt;/p&gt;</comment>
                    <comment id="12856063" author="shaie" created="Mon, 12 Apr 2010 17:51:53 +0100"  >&lt;p&gt;So just call &quot;new IW()&quot;, then rollback and ensure dir.listAll() returns an empty list? Or also index stuff, making sure a flush occurs and then rollback? I&apos;m not sure that the latter is related to that issue ...&lt;/p&gt;</comment>
                    <comment id="12856065" author="mikemccand" created="Mon, 12 Apr 2010 17:58:05 +0100"  >&lt;p&gt;Yeah I think new IW(), set maxBufferedDocs to 2, index 2 docs so a flush happens, then rollback, then confirm dir is empty?&lt;/p&gt;</comment>
                    <comment id="12856103" author="shaie" created="Mon, 12 Apr 2010 19:20:59 +0100"  >&lt;p&gt;Patch includes the proposed test in TestIndexWriter. I think this is ready for commit, if there are no more objections.&lt;/p&gt;</comment>
                    <comment id="12856357" author="mikemccand" created="Tue, 13 Apr 2010 10:14:20 +0100"  >&lt;p&gt;Patch looks good Shai!&lt;/p&gt;</comment>
                    <comment id="12856430" author="shaie" created="Tue, 13 Apr 2010 15:07:48 +0100"  >&lt;p&gt;Committed revision 933613. (take #2)&lt;/p&gt;</comment>
                    <comment id="12864449" author="shaie" created="Wed, 5 May 2010 20:03:52 +0100"  >&lt;p&gt;Backport to 3.1&lt;/p&gt;</comment>
                    <comment id="12864696" author="shaie" created="Thu, 6 May 2010 09:21:34 +0100"  >&lt;p&gt;Committed revision 941607.&lt;/p&gt;</comment>
                    <comment id="13013317" author="gsingers" created="Wed, 30 Mar 2011 16:49:57 +0100"  >&lt;p&gt;Bulk close for 3.1&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12441528" name="ASF.LICENSE.NOT.GRANTED--LUCENE-2386.patch" size="61859" author="shaie" created="Mon, 12 Apr 2010 19:20:59 +0100" />
                    <attachment id="12441417" name="ASF.LICENSE.NOT.GRANTED--LUCENE-2386.patch" size="60216" author="shaie" created="Sun, 11 Apr 2010 20:51:54 +0100" />
                    <attachment id="12441391" name="ASF.LICENSE.NOT.GRANTED--LUCENE-2386.patch" size="62870" author="shaie" created="Sun, 11 Apr 2010 16:00:58 +0100" />
                    <attachment id="12441377" name="ASF.LICENSE.NOT.GRANTED--LUCENE-2386.patch" size="56457" author="shaie" created="Sun, 11 Apr 2010 05:28:30 +0100" />
                    <attachment id="12441294" name="LUCENE-2386.patch" size="57516" author="shaie" created="Fri, 9 Apr 2010 14:40:48 +0100" />
                    <attachment id="12441214" name="LUCENE-2386.patch" size="6838" author="shaie" created="Thu, 8 Apr 2010 23:08:10 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 8 Apr 2010 20:39:06 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11415</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25305</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>