<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:20:31 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-2217/LUCENE-2217.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-2217] Remaining reallocation should use ArrayUtil.getNextSize()</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-2217</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;See recent discussion on ArrayUtils.getNextSize().&lt;/p&gt;</description>
                <environment></environment>
            <key id="12445733">LUCENE-2217</key>
            <summary>Remaining reallocation should use ArrayUtil.getNextSize()</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="paul.elschot@xs4all.nl">Paul Elschot</reporter>
                        <labels>
                    </labels>
                <created>Sat, 16 Jan 2010 13:45:57 +0000</created>
                <updated>Fri, 10 May 2013 11:43:06 +0100</updated>
                    <resolved>Thu, 28 Jan 2010 11:40:31 +0000</resolved>
                                            <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/other</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12801253" author="mikemccand" created="Sat, 16 Jan 2010 18:38:56 +0000"  >&lt;p&gt;Makes sense!&lt;/p&gt;</comment>
                    <comment id="12801254" author="mikemccand" created="Sat, 16 Jan 2010 18:47:59 +0000"  >&lt;p&gt;Actually the patch isn&apos;t quite right, I think?  First, it just calls ArrayUtil.getNextSize w/o passing that to resizeBytes?&lt;/p&gt;

&lt;p&gt;Second, it needs to pass lastBytePos + MAX_BYTES_PER_INT as the arg to ArrayUtil.getNextSize (ie, that&apos;s the &quot;min target size&quot;)?&lt;/p&gt;</comment>
                    <comment id="12801295" author="paul.elschot@xs4all.nl" created="Sat, 16 Jan 2010 23:17:53 +0000"  >&lt;p&gt;Indeed, the patch isn&apos;t quite right. I&apos;ll fix that and provide another patch. All test cases pass though, so I&apos;ll also try and&lt;br/&gt;
add a test case that fails when an allocation larger than the current initial size is needed.&lt;/p&gt;

&lt;p&gt;The MAX_BYTE_PER_INT has disappeared into an added comment that states a minimum initial size.&lt;br/&gt;
The underlying problem is that ArrayUtils.getNextSize() does not have an argument for a minimum increase.&lt;br/&gt;
Would it make sense to add that, too? The code there has some strange constants  (3, 6 and 9) that could&lt;br/&gt;
perhaps be dropped when an extra argument for a minimum increase is added.&lt;br/&gt;
Looking at the comment there for the growth pattern, shouldn&apos;t the second number (after 0) be 3 instead of 4?&lt;/p&gt;</comment>
                    <comment id="12801356" author="mikemccand" created="Sun, 17 Jan 2010 09:57:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ll also try and add a test case that fails when an allocation larger than the current initial size is needed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be much appreciated &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  (I hit that too!).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The underlying problem is that ArrayUtils.getNextSize() does not have an argument for a minimum increase.  Would it make sense to add that, too?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well... the arg to getNextSize is already the minimum size that must be returned, so, can&apos;t you just pass in lastBytePos + MAX_BYTES_PER_INT?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;The code there has some strange constants (3, 6 and 9) that could&lt;br/&gt;
perhaps be dropped when an extra argument for a minimum increase is added.&lt;br/&gt;
Looking at the comment there for the growth pattern, shouldn&apos;t the second number (after 0) be 3 instead of 4?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We&apos;re working on cleaning up this method, under &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2213&quot; title=&quot;Small improvements to ArrayUtil.getNextSize&quot;&gt;&lt;del&gt;LUCENE-2213&lt;/del&gt;&lt;/a&gt;.  The growth pattern in the comment is in fact correct, if you were to call getNextSize on 1+ the current size, ie this progression:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
getNextSize(1+getNextSize(1+getNextSize(1+....getNextSize(1+0)))))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12801500" author="paul.elschot@xs4all.nl" created="Sun, 17 Jan 2010 20:48:53 +0000"  >&lt;p&gt;Fixed the reallocation to be actually done and added a test case that fails the previous patch because of the missing reallocation.&lt;/p&gt;</comment>
                    <comment id="12802449" author="paul.elschot@xs4all.nl" created="Tue, 19 Jan 2010 20:12:58 +0000"  >&lt;p&gt;Btw. shouldn&apos;t IndexInput.bytes also be reallocated using ArrayUtils.getNextSize() ?&lt;br/&gt;
The growth factor there is a hardcoded 1.25 .&lt;/p&gt;</comment>
                    <comment id="12802456" author="mikemccand" created="Tue, 19 Jan 2010 20:26:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Btw. shouldn&apos;t IndexInput.bytes also be reallocated using ArrayUtils.getNextSize()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1  Wanna fold it into this patch?  (And any others you find..?).&lt;/p&gt;</comment>
                    <comment id="12802510" author="paul.elschot@xs4all.nl" created="Tue, 19 Jan 2010 22:32:25 +0000"  >&lt;p&gt;Well, it&apos;s not that I&apos;m searching, but I&apos;ll provide another patch that includes IndexInput for this.&lt;/p&gt;

&lt;p&gt;Would you have any idea about testcases for that?&lt;br/&gt;
&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                    <comment id="12802798" author="paul.elschot@xs4all.nl" created="Wed, 20 Jan 2010 11:45:33 +0000"  >&lt;p&gt;Patch of 20 Jan also includes use of ArrayUtil.getNextSize() for allocation in IndexInput.&lt;/p&gt;</comment>
                    <comment id="12802830" author="mikemccand" created="Wed, 20 Jan 2010 13:33:54 +0000"  >&lt;p&gt;Small tweaks on the last patch, also adding ArrayUtil.getNextSize when allocating the char[] in IndexInput.&lt;/p&gt;</comment>
                    <comment id="12802850" author="paul.elschot@xs4all.nl" created="Wed, 20 Jan 2010 14:38:21 +0000"  >&lt;p&gt;Since I missed the second one in IndexInput I used this regex to search the java files in trunk/src/java: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; new .*\[.*\] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and found that these are still suspicious:&lt;/p&gt;

&lt;p&gt;PorterStemmer 85, 485&lt;br/&gt;
StandardTokenizerImpl  447&lt;br/&gt;
ByteBlockPool 86&lt;br/&gt;
CharBlockPool 45&lt;br/&gt;
MultipleTermPositions 86&lt;br/&gt;
TermInfosWriter 210&lt;br/&gt;
TermsHashPerField 527 (maybe)&lt;br/&gt;
TermVectorsReader 463, 472&lt;br/&gt;
FastCharStream 58&lt;br/&gt;
BufferedIndexInput 61, 157&lt;br/&gt;
UnicodeUtil, 7 times or more.&lt;/p&gt;

</comment>
                    <comment id="12803263" author="mikemccand" created="Thu, 21 Jan 2010 11:35:08 +0000"  >&lt;p&gt;I agree we should cutover these additional places &amp;#8211; wanna work into the patch?&lt;/p&gt;</comment>
                    <comment id="12803266" author="mikemccand" created="Thu, 21 Jan 2010 11:58:06 +0000"  >&lt;p&gt;Paul, I just committed &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2213&quot; title=&quot;Small improvements to ArrayUtil.getNextSize&quot;&gt;&lt;del&gt;LUCENE-2213&lt;/del&gt;&lt;/a&gt;, which changes name &amp;amp; signature of ArrayUtil.getNextSize.... so be sure to update &amp;amp; merge before taking the patch further!&lt;/p&gt;</comment>
                    <comment id="12803380" author="paul.elschot@xs4all.nl" created="Thu, 21 Jan 2010 17:31:08 +0000"  >&lt;p&gt;That was expected.&lt;/p&gt;

&lt;p&gt;The next patch will be about 5 times bigger, so I&apos;ll need some more time.&lt;/p&gt;</comment>
                    <comment id="12803523" author="paul.elschot@xs4all.nl" created="Thu, 21 Jan 2010 22:54:48 +0000"  >&lt;p&gt;Patch of 21 Jan is as anticipated, except for the following:&lt;/p&gt;

&lt;p&gt;UnicodeUtil.java last reallocation at line 332 unchanged.&lt;/p&gt;

&lt;p&gt;FastCharStream.java change might affect speed, not included in patch.&lt;/p&gt;

&lt;p&gt;TermsHashPerField unchanged.&lt;/p&gt;

&lt;p&gt;BufferedIndexInput unchanged, only used by clone() in MultiLevelSkipListReader.&lt;/p&gt;</comment>
                    <comment id="12804573" author="mikemccand" created="Mon, 25 Jan 2010 15:57:05 +0000"  >&lt;p&gt;New iteration of patch attached:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Recovered the fixes in my first patch&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Cutover some ArrayUtil.oversize -&amp;gt; ArrayUtil.grow&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;We can&apos;t change StandardTokenizerImpl.java &amp;#8211; it&apos;s autogen&apos;d from&lt;br/&gt;
    JFlex&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12804691" author="paul.elschot@xs4all.nl" created="Mon, 25 Jan 2010 20:27:02 +0000"  >&lt;p&gt;Patch looks good, all tests pass. Thanks for simplifying the added testcase.&lt;br/&gt;
After this I&apos;ll post a clean patch at &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-2232&quot; title=&quot;Use VShort to encode positions&quot;&gt;&lt;del&gt;LUCENE-2232&lt;/del&gt;&lt;/a&gt; .&lt;/p&gt;</comment>
                    <comment id="12805877" author="mikemccand" created="Thu, 28 Jan 2010 11:40:31 +0000"  >&lt;p&gt;Thanks Paul!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12431315" name="LUCENE-2217.patch" size="15059" author="mikemccand" created="Mon, 25 Jan 2010 15:57:05 +0000" />
                    <attachment id="12431076" name="LUCENE-2217.patch" size="14026" author="paul.elschot@xs4all.nl" created="Thu, 21 Jan 2010 22:54:48 +0000" />
                    <attachment id="12430880" name="LUCENE-2217.patch" size="3328" author="mikemccand" created="Wed, 20 Jan 2010 13:33:54 +0000" />
                    <attachment id="12430872" name="LUCENE-2217.patch" size="3338" author="paul.elschot@xs4all.nl" created="Wed, 20 Jan 2010 11:45:32 +0000" />
                    <attachment id="12430577" name="LUCENE-2217.patch" size="1386" author="paul.elschot@xs4all.nl" created="Sun, 17 Jan 2010 20:48:53 +0000" />
                    <attachment id="12430507" name="LUCENE-2217.patch" size="765" author="paul.elschot@xs4all.nl" created="Sat, 16 Jan 2010 13:49:02 +0000" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Sat, 16 Jan 2010 18:38:56 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>11571</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>25508</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>