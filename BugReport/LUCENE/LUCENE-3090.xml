<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:32:04 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-3090/LUCENE-3090.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-3090] DWFlushControl does not take active DWPT out of the loop on fullFlush</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-3090</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;We have seen several OOM on TestNRTThreads and all of them are caused by DWFlushControl missing DWPT that are set as flushPending but can&apos;t full due to a full flush going on. Yet that means that those DWPT are filling up in the background while they should actually be checked out and blocked until the full flush finishes. Even further we currently stall on the maxNumThreadStates while we should stall on the num of active thread states. I will attach a patch tomorrow.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12507015">LUCENE-3090</key>
            <summary>DWFlushControl does not take active DWPT out of the loop on fullFlush</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/bug.png">Bug</type>
                                <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.png">Critical</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="simonw">Simon Willnauer</assignee>
                                <reporter username="simonw">Simon Willnauer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 May 2011 17:55:30 +0100</created>
                <updated>Fri, 10 May 2013 11:43:22 +0100</updated>
                    <resolved>Tue, 17 May 2011 07:58:56 +0100</resolved>
                            <version>4.0-ALPHA</version>
                                <fixVersion>4.0-ALPHA</fixVersion>
                                <component>core/index</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="13032943" author="simonw" created="Fri, 13 May 2011 11:23:25 +0100"  >&lt;p&gt;here is a patch. I fixed DWFlushControl to block flushes while a fullflush is happening and make them available once the fullflush is done. I also ensure that incoming threads help out flushing if there are DWPT about to flush but not taken yet before indexing their document. All tests pass (I run them lots of times &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13032964" author="simonw" created="Fri, 13 May 2011 12:02:53 +0100"  >&lt;p&gt;new patch - removed leftover assertion from debugging&lt;/p&gt;</comment>
                    <comment id="13032986" author="mikemccand" created="Fri, 13 May 2011 13:28:44 +0100"  >&lt;p&gt;I like the Healthiness -&amp;gt; StallControl renaming &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Could we add an assert that net flushPending + active RAM never exceeds some multiplier (2X?) of the configured max RAM?&lt;/p&gt;</comment>
                    <comment id="13033024" author="simonw" created="Fri, 13 May 2011 14:07:02 +0100"  >&lt;blockquote&gt;&lt;p&gt;Could we add an assert that net flushPending + active RAM never exceeds some multiplier (2X?) of the configured max RAM?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;net flush pending means? we only differ between flushing ram and active ram so flushing ram can easily get above such a limit if IO is slow...&lt;/p&gt;</comment>
                    <comment id="13033043" author="rcmuir" created="Fri, 13 May 2011 14:59:53 +0100"  >&lt;blockquote&gt;&lt;p&gt;net flush pending means? we only differ between flushing ram and active ram so flushing ram can easily get above such a limit if IO is slow...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I/O or just &quot;O&quot;? Should we add a ThrottledIndexInput too? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    <comment id="13033073" author="mikemccand" created="Fri, 13 May 2011 16:17:59 +0100"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Could we add an assert that net flushPending + active RAM never exceeds some multiplier (2X?) of the configured max RAM?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;net flush pending means? we only differ between flushing ram and active ram so flushing ram can easily get above such a limit if IO is slow...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But shouldn&apos;t stallControl kick in in that case?  Ie, we stall all indexing if the number of flush-pending DWPTs is &amp;gt;= the number of active DWPTs, I think?&lt;/p&gt;</comment>
                    <comment id="13033080" author="simonw" created="Fri, 13 May 2011 16:29:06 +0100"  >&lt;blockquote&gt;&lt;p&gt;But shouldn&apos;t stallControl kick in in that case? Ie, we stall all indexing if the number of flush-pending DWPTs is &amp;gt;= the number of active DWPTs, I think?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right so lets say we have two active thread states:&lt;br/&gt;
1. thread 1 starts indexing (max ram is 16M) it indexes n docs and has 15.9 MB ram used. Now n+1 doc comes in has 5MB (active mem= 20.9M flush Mem: 0M)&lt;/p&gt;

&lt;p&gt;2. take it out for flush (active mem=0M flush Mem: 20.9M)&lt;/p&gt;

&lt;p&gt;3. thread 2 starts indexing and fills ram quickly ending up with 18M memory (active mem=18M flush Mem: 20.9M)&lt;br/&gt;
4. take thread 2 out for flush (active mem=0M flush Mem: 38.9M)&lt;br/&gt;
5. thread 3 has already started indexing and reaches the RAM threshold (16M) so we have: (active mem=16M flush Mem: 38.9M)&lt;br/&gt;
6. take it out for flushing (now we stall currently) (active mem=0M flush Mem: 54.9M) - this is more than 3x max ram buffer.&lt;/p&gt;

&lt;p&gt;we currently stall at  flush-pending DWPTs is &amp;gt; (num active DWPT + 1) we can reduce that though but maybe we should swap back to ram based stalling?&lt;/p&gt;

</comment>
                    <comment id="13033909" author="simonw" created="Mon, 16 May 2011 09:09:14 +0100"  >&lt;p&gt;next iteration. This patch changes the stalling mechanism from using num DWPT flushing to netBytes and stalls at 2 x maxRamBuffer if we flush on num bytes. Stalling on memory consumption allows to add an assert / upper bound to the netMemory which is nice but it doesn&apos;t help if we are not flushing on RAM usage.&lt;/p&gt;

&lt;p&gt;I think what we need to do (sep. issue) is to allow people to add a maxTotalUsedRam which defaults to 2x maxRamBuffer if set or Runtime#maxMemory() / 2 if flushing by docCount to allow us to stall indexing threads iff we cross that border and there is at least one DWPT flushing or pending. &lt;/p&gt;</comment>
                    <comment id="13034053" author="simonw" created="Mon, 16 May 2011 16:15:00 +0100"  >&lt;p&gt;I did 150 runs for all Lucene Tests incl. contrib - no failure so far. Seems to be good to go.&lt;/p&gt;</comment>
                    <comment id="13034095" author="mikemccand" created="Mon, 16 May 2011 17:50:24 +0100"  >&lt;p&gt;Patch looks good but hairy Simon!&lt;/p&gt;

&lt;p&gt;I ran 144 iters of all (Solr+lucene+lucene-contrib) tests.  I hit three fails (one in Solr&apos;s TestJoin.testRandomJoin, and two in Solr&apos;s HighlighterTest) but I don&apos;t think these are related to this patch.&lt;/p&gt;</comment>
                    <comment id="13034103" author="simonw" created="Mon, 16 May 2011 18:11:13 +0100"  >&lt;p&gt;Thanks mike for review and testing!! It makes me feel better with those asserts in there now... I will commit tomorrow.&lt;/p&gt;</comment>
                    <comment id="13034604" author="simonw" created="Tue, 17 May 2011 07:58:56 +0100"  >&lt;p&gt;Committed in revision 1104026.&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12479297" name="LUCENE-3090.patch" size="29314" author="simonw" created="Mon, 16 May 2011 09:09:14 +0100" />
                    <attachment id="12479089" name="LUCENE-3090.patch" size="26643" author="simonw" created="Fri, 13 May 2011 12:02:53 +0100" />
                    <attachment id="12479077" name="LUCENE-3090.patch" size="26476" author="simonw" created="Fri, 13 May 2011 11:23:25 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>3.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Fri, 13 May 2011 12:28:44 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>10834</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>24603</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>