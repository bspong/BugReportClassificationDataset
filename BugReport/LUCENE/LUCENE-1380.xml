<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:25:11 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1380/LUCENE-1380.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1380] Patch for ShingleFilter.enablePositions (or PositionFilter)</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1380</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;Make it possible for &lt;b&gt;all&lt;/b&gt; words and shingles to be placed at the same position, that is for &lt;em&gt;all&lt;/em&gt; shingles (and unigrams if included) to be treated as synonyms of each other.&lt;/p&gt;

&lt;p&gt;Today the shingles generated are synonyms only to the first term in the shingle.&lt;br/&gt;
For example the query &quot;abcd efgh ijkl&quot; results in:&lt;br/&gt;
   (&quot;abcd&quot; &quot;abcd efgh&quot; &quot;abcd efgh ijkl&quot;) (&quot;efgh&quot; efgh ijkl&quot;) (&quot;ijkl&quot;)&lt;/p&gt;

&lt;p&gt;where &quot;abcd efgh&quot; and &quot;abcd efgh ijkl&quot; are synonyms of &quot;abcd&quot;, and &quot;efgh ijkl&quot; is a synonym of &quot;efgh&quot;.&lt;/p&gt;

&lt;p&gt;There exists no way today to alter which token a particular shingle is a synonym for.&lt;br/&gt;
This patch takes the first step in making it possible to make all shingles (and unigrams if included) synonyms of each other.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;http://comments.gmane.org/gmane.comp.jakarta.lucene.user/34746&quot; class=&quot;external-link&quot;&gt;http://comments.gmane.org/gmane.comp.jakarta.lucene.user/34746&lt;/a&gt; for mailing list thread.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12404066">LUCENE-1380</key>
            <summary>Patch for ShingleFilter.enablePositions (or PositionFilter)</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.png">Trivial</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="gsingers">Grant Ingersoll</assignee>
                                <reporter username="michaelsembwever">Mck SembWever</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Sep 2008 11:57:03 +0100</created>
                <updated>Mon, 16 May 2011 19:15:30 +0100</updated>
                    <resolved>Thu, 11 Dec 2008 14:20:43 +0000</resolved>
                                            <fixVersion>2.9</fixVersion>
                                <component>modules/analysis</component>
                        <due></due>
                    <votes>14</votes>
                        <watches>1</watches>
                                                    <comments>
                    <comment id="12629761" author="michaelsembwever" created="Wed, 10 Sep 2008 12:00:22 +0100"  >&lt;p&gt;Addition to ShingleFilter for property coterminalPositionIncrement.&lt;br/&gt;
New corresponding test in ShingleFilterTest.&lt;/p&gt;</comment>
                    <comment id="12629827" author="steve_rowe" created="Wed, 10 Sep 2008 16:07:26 +0100"  >&lt;p&gt;As I said in the thread on java-user that spawned this issue: &amp;lt;&lt;a href=&quot;http://www.nabble.com/Replacing-FAST-functionality-at-sesam.no---ShingleFilter%2B-exact-matching-td19396291.html&quot; class=&quot;external-link&quot;&gt;http://www.nabble.com/Replacing-FAST-functionality-at-sesam.no---ShingleFilter%2B-exact-matching-td19396291.html&lt;/a&gt;&amp;gt; (emphasis added):&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It works because you&apos;ve set all of the shingles to be at the same position - probably better to change the one instance of .setPositionIncrement(0) to .setPositionIncrement(1) - that way, MultiPhraseQuery will not be invoked, and the standard disjunction thing should happen.&lt;/p&gt;

&lt;p&gt;&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;W&amp;#93;&lt;/span&gt;ould a patch to ShingleFilter that offers an option&lt;br/&gt;
&amp;gt; &quot;unigramPositionIncrement&quot; (that defaults to 1) likely be&lt;br/&gt;
&amp;gt; accepted into trunk?&lt;/p&gt;

&lt;p&gt;The issue is not directly related to whether a unigram is involved, but rather whether or not &lt;em&gt;&lt;b&gt;tokens that begin at the same word&lt;/b&gt;&lt;/em&gt; are given the same position.  The option thus should be named something like &quot;coterminalPositionIncrement&quot;.  This seems like a reasonable addition, and a patch likely would be accepted, if it included unit tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You have used the option name I suggested, but have implemented it in a form that doesn&apos;t follow the name &amp;#8211; in your implementation, &lt;b&gt;all&lt;/b&gt; tokens are placed at the same position, not just those that start at the same word &amp;#8211; and I think this form is inappropriate for the general user.&lt;/p&gt;

&lt;p&gt;I&apos;m -1 on the patch in its current form.  If rewritten to modify the position increment only for those shingles that begin at the same word, I&apos;d be +1 (assuming it works and is tested appropriately).&lt;/p&gt;</comment>
                    <comment id="12629846" author="michaelsembwever" created="Wed, 10 Sep 2008 17:17:04 +0100"  >&lt;p&gt;i suspected such re the option name, but &quot;coterminal&quot; is a word i haven&apos;t used since high school.&lt;/p&gt;

&lt;p&gt;&amp;gt; I&apos;m -1 on the patch in its current form. If rewritten to modify the position increment only for those shingles that begin at the same word, I&apos;d be +1 (assuming it works and is tested appropriately).&lt;/p&gt;

&lt;p&gt;As i said in thread your suggestion does not work.&lt;br/&gt;
Setting each shingle to have a positionIncrement=1 so to avoid using the MultiPhraseQuery in favour of the plain PhraseQuery makes sense, but does not work. And not phrasing the query doesn&apos;t invoke the ShingleFilter properly.&lt;/p&gt;

&lt;p&gt;&amp;gt; The ShingleFilter appears to only work, at least for me, on phrases.&lt;br/&gt;
&amp;gt; I would think this correct as each shingle is in fact a sub-phrase to the larger original phrase.&lt;/p&gt;

&lt;p&gt;If this is the case, ie ShingleFilter works on phrases as a whole entity, and that shingles from each term in the phrase do have a relationship as they all come from the one phrase, then does it not make sense to have the possibility to position them altogether.&lt;/p&gt;

&lt;p&gt;For example in the current implementation, in the phrase &quot;abcd efgh ijkl&quot; it is the first term &quot;abcd&quot; that is responsible for generating the shingles &quot;abcd efgh ijkl&quot; and &quot;abcd efgh&quot;. &lt;br/&gt;
What  says that these shingles couldn&apos;t be generated from the &quot;efgh&quot; (or &quot;ijkl&quot; for the former shingle) term in an alternative implementation?&lt;br/&gt;
Why the presumption that it&apos;s in the user&apos;s interest to force this separation between where this implementation chooses to put its shingles?&lt;/p&gt;

&lt;p&gt;If this isn&apos;t lost-in-the-bush-logic, have you a suggestion for a more appropriate option name for the current solution?&lt;/p&gt;</comment>
                    <comment id="12630176" author="michaelsembwever" created="Thu, 11 Sep 2008 13:51:33 +0100"  >&lt;p&gt;New version with option named enablePositions&lt;/p&gt;</comment>
                    <comment id="12630571" author="karl.wettin" created="Fri, 12 Sep 2008 15:09:41 +0100"  >&lt;p&gt;Renamed field to usingPositionIncrement to avoid confusion, and added a bunch of javadocs compiled from the issue comments:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
   * If &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; each original token (unigram) or the first related shingle from it
   * will get a {@link org.apache.lucene.analysis.Token#getPositionIncrement() positionIncrement} of 1,
   * &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; all shingle tokens will get a {@link org.apache.lucene.analysis.Token#getPositionIncrement() positionIncrement} of 0.
   * &amp;lt;p&amp;gt;
   * Default value is &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;.
   * &amp;lt;p&amp;gt;
   * This attribute is typically set &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; in conjunction with use of the QueryParser that
   * when set &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; will create a MultiPhraseQuery where at least one word/shingle must be
   * matched from each word/token, not desired in all situations. Setting &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
   * will instead create a PhraseQuery.
   *
   * @param usingPositionIncrement the coterminal token positionIncrement setting.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setUsingPositionIncrement(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; usingPositionIncrement){
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.usingPositionIncrement = usingPositionIncrement;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Did I get that right?&lt;/p&gt;

&lt;p&gt;Steve, are you still -1? I don&apos;t see any harm in this patch.&lt;/p&gt;</comment>
                    <comment id="12630700" author="karl.wettin" created="Fri, 12 Sep 2008 23:50:05 +0100"  >&lt;p&gt;One could argue that what you should do rather than using this patch is to add a TokenFilter that sets all positionIncrement to 0.&lt;/p&gt;</comment>
                    <comment id="12630762" author="michaelsembwever" created="Sat, 13 Sep 2008 13:37:07 +0100"  >&lt;p&gt;&amp;gt; One could argue that what you should do rather than using this patch is to add a TokenFilter that sets all positionIncrement to 0. &lt;/p&gt;

&lt;p&gt;Really? You&apos;ll have to excuse me - i am very new to Lucene.&lt;br/&gt;
How would i go about that? Such a TokenFilter exists already?&lt;/p&gt;

&lt;p&gt;&amp;gt; Setting this to false will instead create a PhraseQuery.&lt;/p&gt;

&lt;p&gt;This isn&apos;t correct. PhraseQuery is used when every token has a non-zero positionIncrement, ie when severalTokensAtSamePosition == false.&lt;br/&gt;
What does happen is that the MultiPhraseQuery that is constructed is limited to one-dimension.&lt;/p&gt;</comment>
                    <comment id="12630768" author="karl.wettin" created="Sat, 13 Sep 2008 14:57:41 +0100"  >&lt;p&gt;&amp;gt;&amp;gt; One could argue that what you should do rather than using this patch is to add a TokenFilter that sets all positionIncrement to 0.&lt;br/&gt;
&amp;gt;Really? You&apos;ll have to excuse me - i am very new to Lucene.&lt;br/&gt;
&amp;gt;How would i go about that? Such a TokenFilter exists already?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TokenFilter(input) {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Token next(Token reusableToken) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    reusableToken = input.next(reusableToken);
    reusableToken.setPositionIncrement(0);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; reusableToken;
  }
};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12630772" author="michaelsembwever" created="Sat, 13 Sep 2008 15:38:43 +0100"  >&lt;p&gt;Ok. So there&apos;s no way to do it through configuration only.&lt;br/&gt;
Would a patch with such a TokenFilter be useful for anybody else other than ShingleFilter users? Again i&apos;m a newbie here but i suspect there&apos;s no other filter (yet) which works &lt;em&gt;across&lt;/em&gt; the tokens (and hence breaks down the importance of positionIncrement) within a query in the way ShingleFilter does. for example from the mailing list from steve:&lt;br/&gt;
&amp;gt; On the other hand, I&apos;m not sure how useful position information is for shingles in the general case: they already have relative position info &lt;br/&gt;
&amp;gt; embedded within them.  And how likely is it that one would want to perform a phrase/span query over shingles?  Pretty unlikely, ...&lt;/p&gt;</comment>
                    <comment id="12630884" author="karl.wettin" created="Sun, 14 Sep 2008 13:47:56 +0100"  >&lt;blockquote&gt;&lt;p&gt;Ok. So there&apos;s no way to do it through configuration only.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In Solr? Well, I don&apos;t really do Solr but I&apos;m pretty sure all you have to do is to create the filter as a new class, add it to the class path and add it as a filter to the query analyzer in your configuration.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Would a patch with such a TokenFilter be useful for anybody else other than ShingleFilter users? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;d say no, that it only seems to make sense for shingles at query parsing time.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Again i&apos;m a newbie here but i suspect there&apos;s no other filter (yet) which works across the tokens (and hence breaks down the importance of positionIncrement) within a query in the way ShingleFilter does.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t understand what you say here. All this patch does is to set all position increment of the tokens produced by the ShingleFilter to 0, right? &lt;/p&gt;

&lt;p&gt;I&apos;m going to remove this for 2.4 fix and recommend you to use the filter strategy mentioned. I&apos;ll leave the issue open for discussion though.&lt;/p&gt;</comment>
                    <comment id="12630885" author="michaelsembwever" created="Sun, 14 Sep 2008 13:57:14 +0100"  >&lt;p&gt;&amp;gt; All this patch does is to set all position increment of the tokens produced by the ShingleFilter to 0, right? &lt;br/&gt;
&amp;gt; I&apos;m going to remove this for 2.4 fix and recommend you to use the filter strategy mentioned. &lt;/p&gt;

&lt;p&gt;The patch to add the new TokenFilter isn&apos;t easy-as-abc as lucene needs to have the filter class added to classpath, and Solr needs the TokenFilterFactory added to be able to read it from the configuration files. A lot of work when we&apos;re (almost) agreed that removing positional information from all tokens makes sense when using the ShingleFilter.&lt;/p&gt;

&lt;p&gt;If it were just the one installation i wouldn&apos;t have a problem with adding the custom TokenFilter, but because our use-case is an open sourced and documented system ( read &lt;a href=&quot;http://sesat.no/howto-solr-query-evaluation.html&quot; class=&quot;external-link&quot;&gt;http://sesat.no/howto-solr-query-evaluation.html&lt;/a&gt; ) i&apos;d like to make it as easy as possible for third parties.&lt;/p&gt;

&lt;p&gt;I would also think that because this is a way to replace commercial and competing technology from FAST that the community would be behind such an enhancement...&lt;/p&gt;</comment>
                    <comment id="12630991" author="michaelsembwever" created="Mon, 15 Sep 2008 12:16:16 +0100"  >&lt;p&gt;Updated description to include a more layman&apos;s explanation.&lt;br/&gt;
Maybe the option should be called &quot;commonSynonyms&quot; or the like...&lt;/p&gt;</comment>
                    <comment id="12631000" author="michaelsembwever" created="Mon, 15 Sep 2008 12:36:12 +0100"  >&lt;p&gt;typo is editing description.&lt;/p&gt;</comment>
                    <comment id="12631738" author="michaelsembwever" created="Wed, 17 Sep 2008 12:30:18 +0100"  >&lt;p&gt;Updated version that ensures first token always has positionIncrement=1&lt;/p&gt;

&lt;p&gt;(Karl&apos;s changes from his patch are in this patch).&lt;/p&gt;</comment>
                    <comment id="12633290" author="karl.wettin" created="Mon, 22 Sep 2008 16:15:11 +0100"  >&lt;p&gt;I&apos;m unassigning myself from this issue as there are so many votes and I consider it a hack to add a change whos soul purpose is to change the behavior of a query parser and I don&apos;t think such a thing should be committed. I think the focus should be on the query parser and I understand that is a lot more work than modifying the shingle filter. If you really want to do this change is this layer I suggest that you seperate out this feature to a new filter that modify the position increment.&lt;/p&gt;</comment>
                    <comment id="12633352" author="michaelsembwever" created="Mon, 22 Sep 2008 16:43:19 +0100"  >&lt;p&gt;&amp;gt; separate out this feature to a new filter that modify the position increment. &lt;/p&gt;

&lt;p&gt;As Chris explained in the list this approach would clobber all terms into one big synonym group. There may be other terms in the query outside of the quotes which should not be treated as synonyms to the shingles. And it was also mentioned that there were known bugs when the first token had positionIncrement=0 (or all tokens lay at position zero instead of at position one).&lt;br/&gt;
i imagine that this rules out such a position increment TokenFilter.&lt;/p&gt;</comment>
                    <comment id="12633355" author="steve_rowe" created="Mon, 22 Sep 2008 16:51:18 +0100"  >&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;separate out this feature to a new filter that modify the position increment. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There may be other terms in the query outside of the quotes which should not be treated as synonyms to the shingles.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;but they won&apos;t be in the same field, right?  Solr has per-field analysis facilities.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And it was also mentioned that there were known bugs when the first token had positionIncrement=0 (or all tokens lay at position zero instead of at position one).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You can tell the filter to set posincr=1 for the first token.&lt;/p&gt;

&lt;p&gt;When it receives null from its predecessor in the filter chain, it can reset its &quot;at the beginning&quot; flag, and the next time it&apos;s used, it&apos;ll give posincr=1 for the first token again.&lt;/p&gt;</comment>
                    <comment id="12633748" author="michaelsembwever" created="Tue, 23 Sep 2008 15:34:07 +0100"  >&lt;p&gt;&amp;gt; If you really want to do this change is this layer I suggest that you seperate out this feature to a new filter that modify &lt;br/&gt;
&amp;gt; the position increment.&lt;/p&gt;

&lt;p&gt;Attaching alternative patch as suggested for PositionFilter and its test.&lt;br/&gt;
The first token always maintains its original positionIncrement, but subsequent tokens in the TokenStream has their positionIncrement set to match the value of PositionFilter.positionIncrement&lt;/p&gt;

&lt;p&gt;I still fail to understand why Karl and Steve would rather see this logic in the QueryParser. The best explanation so far was from Steve:&lt;br/&gt;
&amp;gt; IMO, the correct layer to solve this is in Solr&apos;s QParser - &lt;br/&gt;
&amp;gt; I think there should be a way to tell the parser not to parse, but rather to send the whole query to be analyzed.&lt;/p&gt;

&lt;p&gt;but i wouldn&apos;t be surprised if this goes against the grain of how Solr works.&lt;/p&gt;</comment>
                    <comment id="12633756" author="steve_rowe" created="Tue, 23 Sep 2008 15:54:40 +0100"  >&lt;p&gt;A couple of comments on the PositionFilter patch:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The javadocs should be more explicit, e.g. about the fact that positionIncrement defaults to zero&lt;/li&gt;
	&lt;li&gt;I think there ought to be a constructor that takes in a positionIncrement, perhaps instead of the setter.&lt;/li&gt;
	&lt;li&gt;You don&apos;t handle the case where the filter is used for more than one document; there should be an else clause that resets firstTokenPositioned to false after this block:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != reusableToken){
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(firstTokenPositioned){
    reusableToken.setPositionIncrement(positionIncrement);
  }&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;{
    firstTokenPositioned = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;You should provide a standalone test for the PositionFilter, in addition to the ShingleFilterTest tests.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                    <comment id="12634080" author="michaelsembwever" created="Wed, 24 Sep 2008 10:40:52 +0100"  >&lt;p&gt;Re-attached the PositionFilter patch addressing Steve&apos;s moderation comments. &lt;/p&gt;</comment>
                    <comment id="12634191" author="steve_rowe" created="Wed, 24 Sep 2008 17:20:43 +0100"  >&lt;p&gt;When I wrote:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;4.  You should provide a standalone test for the PositionFilter, in addition to the ShingleFilterTest tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I meant that testing of PositionFilter should be separate from testing its functionality with ShingleFilter.  Your PositionFilter tests looks at offsets, which PositionFilter doesn&apos;t affect at all.  It is possible that PositionFilter will be used for other things than ShingleFilter.  Hence, there should be basic test(s) that evaluate PositionFilter without ShingleFilter.&lt;/p&gt;

&lt;p&gt;I also think a test to make sure a single instance of PositionFilter will work with multiple documents should be added.&lt;/p&gt;

&lt;p&gt;BTW, you don&apos;t need to delete JIRA attachments if you want to upload a new version - when you upload a same-named file, the most recent version of the file will be colored black, and older versions will be colored gray.  This is the conventional way Lucene uses JIRA.  It allows people to follow the JIRA comments in the progressive versions of the patch(es).&lt;/p&gt;

&lt;p&gt;A typo on line 66 of PositionFilterTest: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-comment&quot;&gt;// end of stream so reset firstTokePositioned&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    <comment id="12634247" author="michaelsembwever" created="Wed, 24 Sep 2008 19:36:53 +0100"  >&lt;p&gt;Re-attached the PositionFilter patch addressing Steve&apos;s moderation comments. (2)&lt;br/&gt;
Steve,  can you look at the reset versus null token in stream difference. Are both approaches valid to test? (I&apos;d not overridden TokenStream.reset() in the previous patch).&lt;/p&gt;</comment>
                    <comment id="12634318" author="steve_rowe" created="Wed, 24 Sep 2008 23:07:23 +0100"  >&lt;p&gt;Mck, I was wrong about Filter testing over multiple docs - each instance of a Filter is defined only over a single doc, so this doesn&apos;t make sense.&lt;/p&gt;

&lt;p&gt;However, you are completely on the right track with the reset() operation, since PositionFilter is sensitive to whether it&apos;s at the beginning of a stream, and it should respond as you have written it.&lt;/p&gt;

&lt;p&gt;So, since I was wrong about PositionFilter needing to handle usage with multiple documents, the else clause that I said should go in (upon receiving null from the input stream) should come back out.  In fact, the proper response from a filter in the analysis chain upon encountering null is to stop processing, since it means end-of-stream, so I&apos;ve removed your tests with null embedded in this revised patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Steve, can you look at the reset versus null token in stream difference. Are both approaches valid to test? (I&apos;d not overridden TokenStream.reset() in the previous patch).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I removed the void-return filterTest(), since it wasn&apos;t called from anywhere, and it only used ShingleFilter, and no PositionFilter.  In its place I&apos;ve added another test named testReset().&lt;/p&gt;

&lt;p&gt;I added a test that checks for non-default positionIncrement: testNonZeroPositionIncrement().&lt;/p&gt;

&lt;p&gt;I removed PositionFilter.setPositionIncrement(), because using it one could potentially change the position increment in mid-stream, which makes little sense.  The alternate constructor provides a way to set it.&lt;/p&gt;

&lt;p&gt;In the patch, I have modified the formatting a little to conform to Lucene convention, which is outlined on the &lt;a href=&quot;http://wiki.apache.org/lucene-java/HowToContribute#head-59ae13df098fbdcc46abdf980aa8ee76d3ee2e3b&quot; class=&quot;external-link&quot;&gt;HowToContribute wiki page&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;Code should be formatted according to &lt;a href=&quot;http://java.sun.com/docs/codeconv/&quot; class=&quot;external-link&quot;&gt;Sun&apos;s conventions&lt;/a&gt; with one exception:
	&lt;ul&gt;
		&lt;li&gt;indent two spaces per level, not four.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;I ran &quot;svn diff&quot; under the trunk/ directory, instead of in trunk/contrib/analyzers/ (where you based your patches) - it&apos;s simpler for people who look at a lot of these things to have them always be based from trunk/.&lt;/p&gt;

&lt;p&gt;Take a look and make sure things are as they should be - the tests pass for me, and I think it&apos;s doing what it should do.&lt;/p&gt;

&lt;p&gt;If you agree, then hopefully we can get Karl (or another committer, which I&apos;m not) to take a look and see if they think it can be committed.&lt;/p&gt;</comment>
                    <comment id="12634408" author="michaelsembwever" created="Thu, 25 Sep 2008 09:30:36 +0100"  >&lt;p&gt;&amp;gt; Take a look and make sure things are as they should be - the tests pass for me, and I think it&apos;s doing what it should do.&lt;/p&gt;

&lt;p&gt;Tests run, and code works in my usecase. Thanks Steve.&lt;/p&gt;</comment>
                    <comment id="12654410" author="michaelsembwever" created="Mon, 8 Dec 2008 13:34:52 +0000"  >&lt;p&gt;ping. are there any committors willing to commit these changes?&lt;/p&gt;</comment>
                    <comment id="12655633" author="gsingers" created="Thu, 11 Dec 2008 13:26:14 +0000"  >&lt;p&gt;Just to be clear, Mck, what changes are you asking about?  The position filter one or the broader Shingle one?&lt;/p&gt;

&lt;p&gt;If I&apos;m reading the thread correctly, I think everyone settled on just going w/ the position filter changes, right?&lt;/p&gt;</comment>
                    <comment id="12655637" author="michaelsembwever" created="Thu, 11 Dec 2008 13:40:28 +0000"  >&lt;p&gt;Yes we agreed with the PositionFilter approach. &lt;br/&gt;
It works well (and is in production at &lt;a href=&quot;http://sesam.no&quot; class=&quot;external-link&quot;&gt;http://sesam.no&lt;/a&gt;) &lt;br/&gt;
and steers clear of having to decide whether ShingleFilter, solely by itself, was intended to be used in such a manner and hence if such positioning functionality should be encapsulated there.&lt;/p&gt;</comment>
                    <comment id="12655657" author="gsingers" created="Thu, 11 Dec 2008 14:20:43 +0000"  >&lt;p&gt;Committed revision 725691.&lt;/p&gt;</comment>
                </comments>
                <issuelinks>
                        <issuelinktype id="12310010">
                <name>Incorporates</name>
                                                <inwardlinks description="is part of">
                            <issuelink>
            <issuekey id="12404068">SOLR-763</issuekey>
        </issuelink>
                    </inwardlinks>
                            </issuelinktype>
                    </issuelinks>
                <attachments>
                    <attachment id="12390261" name="LUCENE-1380.patch" size="6088" author="michaelsembwever" created="Wed, 17 Sep 2008 12:30:17 +0100" />
                    <attachment id="12390007" name="LUCENE-1380.patch" size="5864" author="karl.wettin" created="Fri, 12 Sep 2008 15:09:41 +0100" />
                    <attachment id="12390874" name="LUCENE-1380-PositionFilter.patch" size="9571" author="steve_rowe" created="Wed, 24 Sep 2008 23:07:23 +0100" />
                    <attachment id="12390861" name="LUCENE-1380-PositionFilter.patch" size="10833" author="michaelsembwever" created="Wed, 24 Sep 2008 19:36:52 +0100" />
                    <attachment id="12390821" name="LUCENE-1380-PositionFilter.patch" size="9409" author="michaelsembwever" created="Wed, 24 Sep 2008 10:40:52 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>5.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Wed, 10 Sep 2008 15:07:26 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12371</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    <customfieldvalue key="10120"><![CDATA[Patch Available]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26351</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>