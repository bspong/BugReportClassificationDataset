<!-- 
RSS generated by JIRA (5.2.8#851-sha1:3262fdc28b4bc8b23784e13eadc26a22399f5d88) at Tue Jul 16 13:23:13 UTC 2013

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary add field=key&field=summary to the URL of your request.
For example:
https://issues.apache.org/jira/si/jira.issueviews:issue-xml/LUCENE-1644/LUCENE-1644.xml?field=key&field=summary
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>5.2.8</version>
        <build-number>851</build-number>
        <build-date>26-02-2013</build-date>
    </build-info>

<item>
            <title>[LUCENE-1644] Enable MultiTermQuery&apos;s constant score mode to also use BooleanQuery under the hood</title>
                <link>https://issues.apache.org/jira/browse/LUCENE-1644</link>
                <project id="12310110" key="LUCENE">Lucene - Core</project>
                        <description>&lt;p&gt;When MultiTermQuery is used (via one of its subclasses, eg&lt;br/&gt;
WildcardQuery, PrefixQuery, FuzzyQuery, etc.), you can ask it to use&lt;br/&gt;
&quot;constant score mode&quot;, which pre-builds a filter and then wraps that&lt;br/&gt;
filter as a ConstantScoreQuery.&lt;/p&gt;

&lt;p&gt;If you don&apos;t set that, it instead builds a &lt;span class=&quot;error&quot;&gt;&amp;#91;potentially massive&amp;#93;&lt;/span&gt;&lt;br/&gt;
BooleanQuery with one SHOULD clause per term.&lt;/p&gt;

&lt;p&gt;There are some limitations of this approach:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The scores returned by the BooleanQuery are often quite&lt;br/&gt;
    meaningless to the app, so, one should be able to use a&lt;br/&gt;
    BooleanQuery yet get constant scores back.  (Though I vaguely&lt;br/&gt;
    remember at least one example someone raised where the scores were&lt;br/&gt;
    useful...).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The resulting BooleanQuery can easily have too many clauses,&lt;br/&gt;
    throwing an extremely confusing exception to newish users.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It&apos;d be better to have the freedom to pick &quot;build filter up front&quot;&lt;br/&gt;
    vs &quot;build massive BooleanQuery&quot;, when constant scoring is enabled,&lt;br/&gt;
    because they have different performance tradeoffs.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In constant score mode, an OpenBitSet is always used, yet for&lt;br/&gt;
    sparse bit sets this does not give good performance.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think we could address these issues by giving BooleanQuery a&lt;br/&gt;
constant score mode, then empower MultiTermQuery (when in constant&lt;br/&gt;
score mode) to pick &amp;amp; choose whether to use BooleanQuery vs up-front&lt;br/&gt;
filter, and finally empower MultiTermQuery to pick the best (sparse vs&lt;br/&gt;
dense) bit set impl.&lt;/p&gt;</description>
                <environment></environment>
            <key id="12425818">LUCENE-1644</key>
            <summary>Enable MultiTermQuery&apos;s constant score mode to also use BooleanQuery under the hood</summary>
                <type id="4" iconUrl="https://issues.apache.org/jira/images/icons/issuetypes/improvement.png">Improvement</type>
                                <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.png">Minor</priority>
                    <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png">Closed</status>
                    <resolution id="1">Fixed</resolution>
                                <assignee username="mikemccand">Michael McCandless</assignee>
                                <reporter username="mikemccand">Michael McCandless</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 May 2009 14:03:01 +0100</created>
                <updated>Fri, 25 Sep 2009 17:23:24 +0100</updated>
                    <resolved>Sat, 25 Jul 2009 01:03:58 +0100</resolved>
                                            <fixVersion>2.9</fixVersion>
                                <component>core/search</component>
                        <due></due>
                    <votes>0</votes>
                        <watches>0</watches>
                                                    <comments>
                    <comment id="12718279" author="markrmiller@gmail.com" created="Thu, 11 Jun 2009 03:21:29 +0100"  >&lt;p&gt;I&apos;m inclined to think we push to 3.0?&lt;/p&gt;</comment>
                    <comment id="12718424" author="mikemccand" created="Thu, 11 Jun 2009 13:29:56 +0100"  >&lt;p&gt;I agree... moving out.&lt;/p&gt;</comment>
                    <comment id="12733310" author="mikemccand" created="Mon, 20 Jul 2009 19:27:24 +0100"  >&lt;p&gt;I&apos;d really like to get this one in for 2.9.  The API is still&lt;br/&gt;
malleable because the constant-score rewrite mode of MultiTermQuery&lt;br/&gt;
hasn&apos;t been released yet.&lt;/p&gt;

&lt;p&gt;Attached patch, that adds a MultiTermQuery.RewriteMethod parameter,&lt;br/&gt;
with current values FILTER, SCORING_BOOLEAN_QUERY and&lt;br/&gt;
CONSTANT_BOOLEAN_QUERY.  This replaces the&lt;br/&gt;
setConstantScoreRewrite(boolean) method.&lt;/p&gt;

&lt;p&gt;I also added javadocs noting that the two remaining multi-term queries&lt;br/&gt;
that have not yet switched over to FILTER rewrite method&lt;br/&gt;
(WildcardQuery and PrefixQuery) will switch over in 3.0.  (&lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1557&quot; title=&quot;Make constant-score rewrite the default for multi-term queries&quot;&gt;&lt;del&gt;LUCENE-1557&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
is already open to make that switch.)&lt;/p&gt;</comment>
                    <comment id="12733445" author="rcmuir" created="Tue, 21 Jul 2009 03:43:16 +0100"  >&lt;p&gt;Mike, one question: couldn&apos;t you consider FILTER versus CONSTANT_BOOLEAN_QUERY an implementation detail? could lucene pick / switch over to the best one?&lt;/p&gt;

&lt;p&gt;I guess in my opinion, there was nothing wrong with the setConstantScoreRewrite() from an API perspective, but behind the scenes maybe lucene could be a bit smarter about how it actually accomplishes that?&lt;/p&gt;</comment>
                    <comment id="12733458" author="markrmiller@gmail.com" created="Tue, 21 Jul 2009 04:31:14 +0100"  >&lt;p&gt;Thats originally what I thought this issue was - the correct method would be chosen under the covers using a heuristic. Progress not perfection deal?&lt;/p&gt;</comment>
                    <comment id="12733563" author="mikemccand" created="Tue, 21 Jul 2009 11:08:17 +0100"  >&lt;blockquote&gt;&lt;p&gt;couldn&apos;t you consider FILTER versus CONSTANT_BOOLEAN_QUERY an implementation detail? could lucene pick / switch over to the best one?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah I struggled with this.  I completely agree it&apos;s an impl detail &amp;#8211; the user should just have to say &quot;I want constant scoring&quot; and Lucene finds the most performant way to achieve it.&lt;/p&gt;

&lt;p&gt;But then I realized it&apos;s not obvious when one impl should be chosen over another.  Often FILTER is faster than CONSTANT_BOOLEAN_QUERY, but at some point once the index becomes large enough the underlying O(maxDoc) cost (w/ small constant in front) of FILTER will dominate, or if the number of terms/docs that match is small then CONSTANT_BOOLEAN_QUERY will win, etc.  If number of terms exceeds BooleanQuery&apos;s maxClauseCount, you must use FILTER.&lt;/p&gt;

&lt;p&gt;And my intuitions weren&apos;t right (I had thought NumericRangeQuery, since in general it doesn&apos;t produce too many terms, would perform well with BOOLEAN_QUERY, but from Uwe&apos;s numbers that&apos;s not the case; though we should re-test now that, with this patch, no CPU is spent on scoring).&lt;/p&gt;

&lt;p&gt;So, I was uncomfortable trying to make Lucene too smart under the hood, at least for this first go at it.&lt;/p&gt;

&lt;p&gt;Maybe we could add an AUTO option, that would make try to decide what&apos;s best?  This way if we mess up its smarts, the user can still fallback and force one method over another.&lt;/p&gt;

&lt;p&gt;(Though, since the maxClauseCount is so clearly a dead-end, maybe even in CONSTANT_BOOLEAN_QUERY mode we should forcefully fallback to FILTER on hitting too many terms).&lt;/p&gt;</comment>
                    <comment id="12733578" author="rcmuir" created="Tue, 21 Jul 2009 11:31:48 +0100"  >&lt;p&gt;Mike, I see your point, I believe two things are involved, but I could be wrong on this!&lt;/p&gt;

&lt;p&gt;In the tests I have run, for &quot;uncached&quot; queries that match only a few docs, query is faster.&lt;br/&gt;
FILTER is faster if things are cached or if the query matches many documents, even for a huge index.&lt;/p&gt;

&lt;p&gt;I don&apos;t think this disagrees with Uwe&apos;s numbers really, I just think the OS cache etc plays a big part, at least thats what I thought I was seeing on my end...&lt;/p&gt;</comment>
                    <comment id="12733582" author="mikemccand" created="Tue, 21 Jul 2009 11:51:03 +0100"  >&lt;p&gt;Your results seem to agree w/ Uwe&apos;s (once things are &quot;hot&quot; then FILTER is even faster, even on a rather large index).  Uwe&apos;s results were on a 5M doc index.  How large is your index?&lt;/p&gt;

&lt;p&gt;OK so how about I add an CONSTANT_AUTO mode that tries to pick?  I can add &lt;span class=&quot;error&quot;&gt;&amp;#91;expert&amp;#93;&lt;/span&gt; setters that you can use to set the cutoffs.  Then in the javadocs, strongly encourage CONSTANT_AUTO, and state that in 3.0 it&apos;ll be the default?&lt;/p&gt;</comment>
                    <comment id="12733593" author="rcmuir" created="Tue, 21 Jul 2009 12:19:29 +0100"  >&lt;p&gt;Mike: &amp;gt; 100M docs. it does not fit in os cache &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I really should rerun tests since its been quite some time.&lt;/p&gt;

&lt;p&gt;What do you think about CONSTANT_AUTO doing your maxClauseCount trick?&lt;/p&gt;</comment>
                    <comment id="12733598" author="mikemccand" created="Tue, 21 Jul 2009 12:34:40 +0100"  >&lt;blockquote&gt;&lt;p&gt;Mike: &amp;gt; 100M docs. it does not fit in os cache&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Heh &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  OK.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What do you think about CONSTANT_AUTO doing your maxClauseCount trick?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m thinking there&apos;d be a cutoff on the number of terms.  EG maybe it defaults to 25 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.gif&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  So, if more than 25 terms are encountered, we&apos;ll use FILTER; else we use BOOLEAN_QUERY.  And, then, at all times I&apos;d cutover to FILTER if that threshold exceeds the maxClauseCount.&lt;/p&gt;</comment>
                    <comment id="12733637" author="mikemccand" created="Tue, 21 Jul 2009 15:21:29 +0100"  >&lt;p&gt;Maybe, we simply go back to the boolean (constant scoring or not), and then add this term count cutoff to control when a filter is used vs BooleanQuery?&lt;/p&gt;</comment>
                    <comment id="12733676" author="rcmuir" created="Tue, 21 Jul 2009 17:07:45 +0100"  >&lt;p&gt;Mike, I am afraid that might hurt some people&apos;s performance.&lt;br/&gt;
I&apos;m a bit concerned my index/queries are maybe abnormal and don&apos;t want to break the general case.&lt;/p&gt;

&lt;p&gt;I&apos;m not too familiar with trie &lt;span class=&quot;error&quot;&gt;&amp;#91;what it would do with a really general range query&amp;#93;&lt;/span&gt;, but a simpler example would be no stopwords, wildcard query of &quot;th?&quot; (matching &quot;the&quot;)&lt;br/&gt;
maybe it only matches one term, but that term is very common / dense bitset and probably &quot;hot&quot;.&lt;/p&gt;

&lt;p&gt;In this case the filter would be better, even though its 1 term.&lt;/p&gt;</comment>
                    <comment id="12733769" author="mikemccand" created="Tue, 21 Jul 2009 19:19:39 +0100"  >&lt;blockquote&gt;&lt;p&gt;In this case the filter would be better, even though its 1 term.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right.  So... maybe we could also take the net doc count into account?  Loading the TermInfo shouldn&apos;t be costly, since it&apos;s loaded anyway when the query/filter runs (and, it&apos;s cached).  We&apos;d then sum it up as we&apos;re checking, and if it crosses the threshold (default maybe 10% of maxDoc()?) we&apos;d cut out to FILTER?&lt;/p&gt;

&lt;p&gt;Though, if we go this route, we should probably do it under a new CONSTANT_AUTO method (instead of falling back to the clean single boolean constantScoreRewrite), ie, it&apos;s getting a little too smart to just always do w/ no way to fallback and force it to just rewrite one way or another.&lt;/p&gt;

&lt;p&gt;Or we can punt on any smarts altogether for now (this being the &quot;eve&quot; of 2.9) and simply start with the three explicit rewrite methods.&lt;/p&gt;</comment>
                    <comment id="12733775" author="rcmuir" created="Tue, 21 Jul 2009 19:43:49 +0100"  >&lt;p&gt;Mike, that heuristic sounds really promising to me.&lt;/p&gt;

&lt;p&gt;at the same time, starting to think your .setMultiTermRewriteMethod really is the right way to go (regardless of whether it immediately has AUTO)...&lt;/p&gt;

&lt;p&gt;the thing i never really liked about .setConstantScoreRewrite is that its kinda misleading, since it really does more than just toggle scoring...&lt;/p&gt;</comment>
                    <comment id="12733781" author="markrmiller@gmail.com" created="Tue, 21 Jul 2009 19:55:01 +0100"  >&lt;blockquote&gt;&lt;p&gt;Or we can punt on any smarts altogether for now (this being the &quot;eve&quot; of 2.9) and simply start with the three explicit rewrite methods.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 - unless you just want to pump it out, we want to make the current change anyway I think, so lets leave it at that and add an auto later.&lt;/p&gt;

&lt;p&gt;We should get 2.9 out sooner rather than later I think.&lt;/p&gt;</comment>
                    <comment id="12733786" author="rcmuir" created="Tue, 21 Jul 2009 20:08:24 +0100"  >&lt;p&gt;Mike, sorry to flip back and forth on this since last night. &lt;/p&gt;

&lt;p&gt;The patch you have here does make things less confusing and I think that after talking things thru, the &quot;big boolean option&quot; with heuristics might actually make things more confusing, even if its seems convenient at first.&lt;/p&gt;

&lt;p&gt;in the future the AUTO would be a good feature I think, best of both worlds.&lt;/p&gt;</comment>
                    <comment id="12733836" author="mikemccand" created="Tue, 21 Jul 2009 22:22:42 +0100"  >&lt;p&gt;Attached rough patch &amp;#8211; javadocs are missing/not&lt;br/&gt;
updated, need to add new tests, need to fix QueryParser.jj, etc., but&lt;br/&gt;
all tests pass.&lt;/p&gt;

&lt;p&gt;Here&apos;s what I did:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Changed the MTQ.RewriteMethod class from a simple Parameter to its&lt;br/&gt;
    own abstract base class w/ a single method, rewrite, which&lt;br/&gt;
    MultiTermQuery.rewrite delegates to.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Switched over CONSTANT_SCORE_FILTER_REWRITE,&lt;br/&gt;
    SCORING_BOOLEAN_QUERY_REWRITE and&lt;br/&gt;
    CONSTANT_SCORE_BOOLEAN_QUERY_REWRITE.  These classes are private&lt;br/&gt;
    (they have no configuration), and I created final static singleton&lt;br/&gt;
    instances for them.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Created ConstantScoreAutoRewrite (and the default&lt;br/&gt;
    CONSTANT_SCORE_AUTO_REWRITE instance) that you can configure based&lt;br/&gt;
    on term count &amp;amp; doc count, as to when it cuts over to&lt;br/&gt;
    CONSTANT_SCORE_FILTER_REWRITE.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This approach also has the benefit of allowing customization entirely,&lt;br/&gt;
if needed, of the &quot;rewrite strategy&quot;, if none of the 4 choices work&lt;br/&gt;
for you.&lt;/p&gt;
</comment>
                    <comment id="12734067" author="thetaphi" created="Wed, 22 Jul 2009 11:37:07 +0100"  >&lt;p&gt;Sorry that I came back too late to this issue, I am in holidays at the moment.&lt;/p&gt;

&lt;p&gt;In my opinion, the Parameter instead of boolean is a good idea. The latest patch is also a good idea, I only hve some small problems with it:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Why did you make so many internal things public? The additional ctor to MultiTermQueryrapperFilter should be package-private or protected (the class is not abstract, but should be used like abstract, so it ,must have only protected ctors). Only the public instances TermRangeFilter should have public ctors.&lt;/li&gt;
	&lt;li&gt;getFilter()/getEnum should stay protected.&lt;/li&gt;
	&lt;li&gt;I do not like the wired caching of Terms. A more cleaner API would be a new class CachingFilteredTermEnum, that can turn on caching for e.g. the first 20 terms and then reset. In this case, the API would stay clear and the filter code does not need to be changed at all (it just harvests the TermEnum, if it is cached or not). I would propose something like: new CachingFilteredTermEnum(originalEnum), use it normally, then termEnum.reset() to consume again and termEnum.purgeCache() if caching no longer needed and to be switched off (after the first 25 terms or so). The problem with MultiTermQueryWrapper filter is, that the filter is normally stateless (no reader or termenum). So normally the method getDocIdSet() should get the termenum or wrapper in addition to the indexreader. This is not very good (it took me some time, to understand, what you are doing).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    <comment id="12734070" author="thetaphi" created="Wed, 22 Jul 2009 11:48:06 +0100"  >&lt;p&gt;The biggest problem is, that this caching gets completely wired with multi-segment indexes:&lt;br/&gt;
The rewriting is done on the top-level reader. In this case the boolean query would be built and the terms cached. If there are too many terms, it creates a filter instance with the cached terms.&lt;br/&gt;
The rewritten query is then executed against all sub-readers using the cached terms and a fixed term enum. Normally this would create a docidset for the current index reader, the rewrite did it for the top-level index reader -&amp;gt; the wron doc ids are returned and so on. So you cannot reuse the collected terms from the rewrite operation in the getDocIdSet calls.&lt;/p&gt;

&lt;p&gt;So please turn of this caching at all! As noted before, the important thing is, that the returned filter by rewrite is stateless and should not know anythis about index readers. The idex reader is passed in getDocIdSet any is different for non-optimized indexes.&lt;/p&gt;

&lt;p&gt;You have seen no tests fail, because all RangeQuery tests use optimized indexes.&lt;/p&gt;</comment>
                    <comment id="12734096" author="mikemccand" created="Wed, 22 Jul 2009 13:41:26 +0100"  >&lt;blockquote&gt;&lt;p&gt;The biggest problem is, that this caching gets completely wired with multi-segment indexes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, I caught this as well (there is one test that fails when I forcefully swap in constant-boolean-query as the constant score method), and I&apos;m now turning off the caching.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed it locally &amp;#8211; will post a new rev soon.&lt;/p&gt;</comment>
                    <comment id="12734188" author="mikemccand" created="Wed, 22 Jul 2009 17:47:31 +0100"  >&lt;p&gt;Attached patch: fixed some bugs in the last rev, updated test cases,&lt;br/&gt;
javadocs, CHANGES.  I also optimized MultiTermQueryWrapperFilter to&lt;br/&gt;
use the bulk-read API from termDocs.&lt;/p&gt;

&lt;p&gt;I confirmed all tests pass if I temporarily switch&lt;br/&gt;
CONSTANT_SCORE_FILTER_REWRITE to CONSTANT_SCORE_AUTO_REWRITE_DEFAULT.&lt;/p&gt;

&lt;p&gt;I changed QueryParser to use CONSTANT_SCORE_AUTO for rewrite (it was&lt;br/&gt;
previously CONSTANT_FILTER).&lt;/p&gt;

&lt;p&gt;I still need to run some perf tests to get a rough sense of decent&lt;br/&gt;
defaults for CONSTANT_SCORE_AUTO cutover thresholds.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;getFilter()/getEnum should stay protected.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK I made getEnum protected again.&lt;/p&gt;

&lt;p&gt;I had tentatively made it public so that one could create their own&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;external&amp;#93;&lt;/span&gt; rewrite methods.  But I think (if we leave it protected),&lt;br/&gt;
one could still make an inner/nested class that can access getEnum().&lt;/p&gt;

&lt;p&gt;Do we even need getFilter()?  I removed it in the patch.&lt;/p&gt;</comment>
                    <comment id="12734301" author="thetaphi" created="Wed, 22 Jul 2009 21:36:16 +0100"  >&lt;p&gt;Hi Mike,&lt;/p&gt;

&lt;p&gt;patch looks good. I was a little bit confused about the high term number cut off, but it is using Math.max to limit it to the current BooleanQuery max clause count.&lt;/p&gt;

&lt;p&gt;Some small things:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;OK I made getEnum protected again.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;...but only in MultiTermQuery itsself. Everywhere else (even in the backwards compatibility override test &lt;span class=&quot;error&quot;&gt;&amp;#91;JustCompile&amp;#93;&lt;/span&gt; it is public). And the same should be for the incNumberOfTerms (also protected). I think the rewrite method is internal to MultiTermQuery and always implemented ina subclass of MTQ as inner class.&lt;/p&gt;

&lt;p&gt;Also the current singletons are not really singletons, because queries that are unserialized will contain instances that are not the &quot;singleton&quot; instances &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - and will therefore fail to produce correct hashcode/equals tests. The problem behind: The singletons are serializable but do not return itsself in readResolve() (not implemented). All singletons that are serializable must implement readResolve and return the singleton instance (see Parameter base class or the parser singletons in FieldCache).&lt;/p&gt;

&lt;p&gt;The instance in the default Auto RewriteMethod is still modifiable. Is this correct? So one could modify the defaults by setting properties in this instance. Is this correct?&lt;/p&gt;</comment>
                    <comment id="12734411" author="mikemccand" created="Thu, 23 Jul 2009 01:36:28 +0100"  >&lt;blockquote&gt;&lt;p&gt;I was a little bit confused about the high term number cut off,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry I still need to do some perf testing to pick an appropriate&lt;br/&gt;
default here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Everywhere else (even in the backwards compatibility override test &lt;span class=&quot;error&quot;&gt;&amp;#91;JustCompile&amp;#93;&lt;/span&gt; it is public).  And the same should be for the incNumberOfTerms (also protected).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Woops &amp;#8211; I&apos;ll fix.  Thanks for catching even though you&apos;re on&lt;br/&gt;
&quot;vacation&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also the current singletons are not really singletons, because queries that are unserialized will contain instances that are not the &quot;singleton&quot; instances&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sigh.  I&apos;ll do what FieldCache&apos;s parser singletons do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The instance in the default Auto RewriteMethod is still modifiable. Is this correct?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I was thinking this was OK, ie, you could set the default cutoffs for&lt;br/&gt;
anything that used the AUTO_DEFAULT.  But it is static (global), so&lt;br/&gt;
that&apos;s not great.  I guess I&apos;ll make it an anonymous subclass of&lt;br/&gt;
ConstantScoreAutoRewrite that disallows changes.&lt;/p&gt;</comment>
                    <comment id="12734413" author="mikemccand" created="Thu, 23 Jul 2009 01:46:03 +0100"  >&lt;p&gt;New patch attached w/ above fixes plus some javadoc fixes.  It has&lt;br/&gt;
some nocommits which I&apos;ll clean up before committing.&lt;/p&gt;</comment>
                    <comment id="12734561" author="mikemccand" created="Thu, 23 Jul 2009 12:39:59 +0100"  >&lt;p&gt;New patch attached.  I think it&apos;s ready to commit!&lt;/p&gt;

&lt;p&gt;I ran a series of simple tests, using a 20.0 million doc Wikipedia&lt;br/&gt;
index. I tested w/ PrefixQuery, using different prefixes to tickle the&lt;br/&gt;
different number of matching terms vs matching docs.&lt;/p&gt;

&lt;p&gt;I first pursued the &quot;matches many terms but few docs&quot; case, and found&lt;br/&gt;
at around 350 terms the filter method becomes faster.&lt;/p&gt;

&lt;p&gt;Then, I fixed the number of terms at 350 (modified PrefixQuery to&lt;br/&gt;
pretend the enum stopped there) and tested different number of &quot;doc&lt;br/&gt;
visit counts&quot; (sum of docFreq of each term) and found ~ 0.1% (1/1000)&lt;br/&gt;
of the maxDoc() was the cutover.&lt;/p&gt;

&lt;p&gt;I also switched NumericRange* to use CONSTANT_SCORE_AUTO by default.&lt;/p&gt;</comment>
                    <comment id="12734570" author="thetaphi" created="Thu, 23 Jul 2009 13:01:16 +0100"  >&lt;p&gt;Looks good, Mike.&lt;/p&gt;

&lt;p&gt;I think NumericRangeQuery should also be swiched to auto mode, you are right. My perf test was a little bit unfair, because it used a 5 Mio index with random integers. The queries were also random and the sum of docs/index size was about 1/3 (because of the random query). So most quries hit abou one third of all docs. In this case, always the filter is faster. For very small ranges with few terms, it may be really good to use &lt;/p&gt;

&lt;p&gt;A good thing would also be to set the mode to filter automatically, if precisionStep &amp;gt;6 for longs (valSize=64) and precStep &amp;gt; 8 for ints (valSize=32), because here the number of terms is often too big.&lt;/p&gt;

&lt;p&gt;One bug in ConstantScoreRangeQuery: You set the default to AUTO, the method to prevent changing this is wrong:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   /** Changes of mode are not supported by &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; class (fixed to constant score rewrite mode) */
-  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setConstantScoreRewrite(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; constantScoreRewrite) {
-    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!constantScoreRewrite)
-      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsupportedOperationException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Use TermRangeQuery instead to enable &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; query rewrite.&quot;&lt;/span&gt;);
+  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void setRewriteMethod(RewriteMethod method) {
+    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (method != CONSTANT_SCORE_FILTER_REWRITE) {
+      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsupportedOperationException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Use TermRangeQuery instead to change the rewrite method.&quot;&lt;/span&gt;);
+    }
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I would change this to simply always throw UOE on any change in ConstantScoreRangeQuery.&lt;/p&gt;</comment>
                    <comment id="12734571" author="thetaphi" created="Thu, 23 Jul 2009 13:03:30 +0100"  >&lt;p&gt;Another question: Maybe it would be good to change the FieldCache to also use the buffered TermDocs variant in the Uninverter code?&lt;br/&gt;
Has done anybody perf tests here. It would be easy to change this.&lt;/p&gt;</comment>
                    <comment id="12734583" author="mikemccand" created="Thu, 23 Jul 2009 13:47:34 +0100"  >&lt;blockquote&gt;&lt;p&gt;I would change this to simply always throw UOE on any change in ConstantScoreRangeQuery.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;OK will do.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A good thing would also be to set the mode to filter automatically, if precisionStep &amp;gt;6 for longs (valSize=64) and precStep &amp;gt; 8 for ints (valSize=32), because here the number of terms is often too big.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Will do.&lt;/p&gt;

&lt;p&gt;Hmm &amp;#8211; my last patch hit this test failure, after I had switched to CONSTANT_SCORE_AUTO for NumericRangeQuery:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    [junit] NOTE: random seed of testcase &apos;testRandomTrieAndClassicRangeQuery_NoTrie&apos; was: -2919237198484373178
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: testRandomTrieAndClassicRangeQuery_NoTrie(org.apache.lucene.search.TestNumericRangeQuery32):	FAILED
    [junit] Total number of terms should be equal &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unlimited precStep expected:&amp;lt;668552&amp;gt; but was:&amp;lt;668584&amp;gt;
    [junit] junit.framework.AssertionFailedError: Total number of terms should be equal &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unlimited precStep expected:&amp;lt;668552&amp;gt; but was:&amp;lt;668584&amp;gt;
    [junit] 	at org.apache.lucene.search.TestNumericRangeQuery32.testRandomTrieAndClassicRangeQuery(TestNumericRangeQuery32.java:266)
    [junit] 	at org.apache.lucene.search.TestNumericRangeQuery32.testRandomTrieAndClassicRangeQuery_NoTrie(TestNumericRangeQuery32.java:287)
    [junit] 	at org.apache.lucene.util.LuceneTestCase.runTest(LuceneTestCase.java:88)
    [junit] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I haven&apos;t dug into it yet...&lt;/p&gt;</comment>
                    <comment id="12734590" author="mikemccand" created="Thu, 23 Jul 2009 14:15:17 +0100"  >&lt;blockquote&gt;&lt;p&gt;Hmm - my last patch hit this test failure, after I had switched to CONSTANT_SCORE_AUTO for NumericRangeQuery:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Heh &amp;#8211; so I tried to repeat the failure, and couldn&apos;t.  The I remembered that nice random seed that was printed out, so I went to the test and wired that seed and BOOM the failure happened.  Thank you Hoss &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.gif&quot; height=&quot;20&quot; width=&quot;20&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I found the failure &amp;#8211; I was just failing to incr the term count in the &quot;auto uses BooleanQuery&quot; case.  New patch soon...&lt;/p&gt;</comment>
                    <comment id="12734591" author="mikemccand" created="Thu, 23 Jul 2009 14:17:47 +0100"  >&lt;p&gt;New patch.  I&apos;ll commit in a day or two, though I&apos;ll wait first for &lt;a href=&quot;https://issues.apache.org/jira/browse/LUCENE-1693&quot; title=&quot;AttributeSource/TokenStream API improvements&quot;&gt;&lt;del&gt;LUCENE-1693&lt;/del&gt;&lt;/a&gt; to go in (it&apos;ll conflict on QueryParser.jj/java).&lt;/p&gt;</comment>
                    <comment id="12734592" author="thetaphi" created="Thu, 23 Jul 2009 14:24:33 +0100"  >&lt;p&gt;You were faster. The problem was the missing update of term count. I first thought, that you maybe counting the terms two times (one time at the beginning and then again in the filter, if the auto mode switches). But you are now only updating the term count at the end when you build the boolean query.&lt;/p&gt;

&lt;p&gt;By the way: How about initializing the ArrayList not with the default size, but maybe termCount cutoff/2 or something like that?&lt;/p&gt;</comment>
                    <comment id="12734603" author="mikemccand" created="Thu, 23 Jul 2009 15:32:28 +0100"  >&lt;blockquote&gt;&lt;p&gt;How about initializing the ArrayList not with the default size, but maybe termCount cutoff/2 or something like that?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That makes me a bit nervous, eg if someone sets these limits to something immense?&lt;/p&gt;</comment>
                    <comment id="12735211" author="mikemccand" created="Sat, 25 Jul 2009 01:03:58 +0100"  >&lt;p&gt;Thanks Uwe!&lt;/p&gt;</comment>
                </comments>
                    <attachments>
                    <attachment id="12414342" name="LUCENE-1644.patch" size="65342" author="mikemccand" created="Thu, 23 Jul 2009 14:17:47 +0100" />
                    <attachment id="12414339" name="LUCENE-1644.patch" size="64054" author="mikemccand" created="Thu, 23 Jul 2009 12:39:58 +0100" />
                    <attachment id="12414291" name="LUCENE-1644.patch" size="63957" author="mikemccand" created="Thu, 23 Jul 2009 01:46:03 +0100" />
                    <attachment id="12414223" name="LUCENE-1644.patch" size="61646" author="mikemccand" created="Wed, 22 Jul 2009 17:47:31 +0100" />
                    <attachment id="12414147" name="LUCENE-1644.patch" size="58482" author="mikemccand" created="Tue, 21 Jul 2009 22:22:42 +0100" />
                    <attachment id="12414025" name="LUCENE-1644.patch" size="46961" author="mikemccand" created="Mon, 20 Jul 2009 19:27:24 +0100" />
                </attachments>
            <subtasks>
        </subtasks>
                <customfields>
                                <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                <customfieldname>Attachment count</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>6.0</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                <customfield id="customfield_12310220" key="com.atlassian.jira.ext.charting:firstresponsedate">
                <customfieldname>Date of First Response</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>Thu, 11 Jun 2009 02:21:29 +0000</customfieldvalue>

                </customfieldvalues>
            </customfield>
                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Global Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>12114</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310120" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                <customfieldname>Lucene Fields</customfieldname>
                <customfieldvalues>
                        <customfieldvalue key="10121"><![CDATA[New]]></customfieldvalue>
    
                </customfieldvalues>
            </customfield>
                                            <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                <customfieldname>Rank</customfieldname>
                <customfieldvalues>
                    <customfieldvalue>26083</customfieldvalue>
                </customfieldvalues>
            </customfield>
                                                                                    <customfield id="customfield_12310222" key="com.atlassian.jira.ext.charting:timeinstatus">
                <customfieldname>Time in Status</customfieldname>
                <customfieldvalues>
                    
                </customfieldvalues>
            </customfield>
                            </customfields>
    </item>
</channel>
</rss>